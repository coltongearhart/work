<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>3&nbsp; R â€“ Work</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./sql.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./r.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Work</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./macros.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Macros (Excel VBA)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">SQL</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#stillwater" id="toc-stillwater" class="nav-link active" data-scroll-target="#stillwater"><span class="header-section-number">3.1</span> Stillwater</a>
  <ul>
<li><a href="#tiering-analysis---claims" id="toc-tiering-analysis---claims" class="nav-link" data-scroll-target="#tiering-analysis---claims"><span class="header-section-number">3.1.1</span> Tiering analysis - Claims</a></li>
  <li><a href="#tiering-analysis---exposure" id="toc-tiering-analysis---exposure" class="nav-link" data-scroll-target="#tiering-analysis---exposure"><span class="header-section-number">3.1.2</span> Tiering analysis - Exposure</a></li>
  <li><a href="#tiering-analysis---combined" id="toc-tiering-analysis---combined" class="nav-link" data-scroll-target="#tiering-analysis---combined"><span class="header-section-number">3.1.3</span> Tiering analysis - Combined</a></li>
  <li><a href="#analysis-projects" id="toc-analysis-projects" class="nav-link" data-scroll-target="#analysis-projects"><span class="header-section-number">3.1.4</span> Analysis projects</a></li>
  <li><a href="#large-risks-analysis" id="toc-large-risks-analysis" class="nav-link" data-scroll-target="#large-risks-analysis"><span class="header-section-number">3.1.5</span> Large risks analysis</a></li>
  <li><a href="#long-tail-analyses" id="toc-long-tail-analyses" class="nav-link" data-scroll-target="#long-tail-analyses"><span class="header-section-number">3.1.6</span> Long tail analyses</a></li>
  <li><a href="#policy-life-analysis" id="toc-policy-life-analysis" class="nav-link" data-scroll-target="#policy-life-analysis"><span class="header-section-number">3.1.7</span> Policy life analysis</a></li>
  <li><a href="#random-loss-analysis" id="toc-random-loss-analysis" class="nav-link" data-scroll-target="#random-loss-analysis"><span class="header-section-number">3.1.8</span> Random loss analysis</a></li>
  <li><a href="#restuarant-audits-analysis" id="toc-restuarant-audits-analysis" class="nav-link" data-scroll-target="#restuarant-audits-analysis"><span class="header-section-number">3.1.9</span> Restuarant audits analysis</a></li>
  <li><a href="#indications" id="toc-indications" class="nav-link" data-scroll-target="#indications"><span class="header-section-number">3.1.10</span> Indications</a></li>
  <li><a href="#indications---app" id="toc-indications---app" class="nav-link" data-scroll-target="#indications---app"><span class="header-section-number">3.1.11</span> Indications - app</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><section id="stillwater" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="stillwater">
<span class="header-section-number">3.1</span> Stillwater</h2>
<section id="tiering-analysis---claims" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="tiering-analysis---claims">
<span class="header-section-number">3.1.1</span> Tiering analysis - Claims</h3>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages and define functions ---- </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define function to set close information to latest transaction where running case reserve is zero</span></span>
<span><span class="va">set_claim_close_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>flag_nonzero_case_res_rsum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">case_res_rsum</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">flag_nonzero_case_res_rsum</span>,</span>
<span>           row_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flag_nonzero_case_res_rsum</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">flag_nonzero_case_res_rsum</span><span class="op">)</span>,</span>
<span>           <span class="va">row_id</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>claim_close <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           close_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strptime.html">as.character.POSIXt</a></span><span class="op">(</span><span class="va">transaction_date</span><span class="op">)</span>,</span>
<span>           .keep <span class="op">=</span> <span class="st">"unused"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># just doesn't add rows if no data returned from previous step ==&gt; claim_close = NA</span></span>
<span>    <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">tmp</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"transaction"</span><span class="op">)</span>, <span class="va">claim_close</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">transaction_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>claim_close <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">claim_close</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">claim_close</span><span class="op">)</span>,</span>
<span>           close_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/is_empty.html">is_empty</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">close_date</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">tmp</span><span class="op">$</span><span class="va">close_date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">transaction_date</span>, <span class="va">transaction_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">transaction_id</span>, .before <span class="op">=</span> <span class="va">transaction_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">close_date</span>, .after<span class="op">=</span> <span class="va">loss_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">claim_close</span>, .after <span class="op">=</span> <span class="va">transaction_date</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### ---- Load data: SQL ----</span></span>
<span></span>
<span><span class="co"># establish connection</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">odbc</span><span class="fu">::</span><span class="fu">odbc</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                      Driver <span class="op">=</span> <span class="st">"SQL Server"</span>,</span>
<span>                      Server <span class="op">=</span> <span class="st">"XXXXXXXXX\\XXXXXXX"</span>,</span>
<span>                      trusted_connection <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run queries to get raw data from AS400</span></span>
<span><span class="co"># -&gt; MTD claims data</span></span>
<span><span class="va">data_claims_mtd_raw</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from pricing.CLT.tiering_analysis_BPCLM_raw"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_pull_date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">data_pull_date</span><span class="op">)</span>,</span>
<span>         peril_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op">(</span><span class="va">peril_code</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; transactional claims data</span></span>
<span><span class="va">data_claims_tr_raw</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from pricing.CLT.tiering_analysis_BPCLMTR_raw"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_pull_date <span class="op">=</span> <span class="va">data_pull_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># close connection</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Modify transactional claims data ----</span></span>
<span></span>
<span><span class="co"># modify transactional claims data</span></span>
<span><span class="co"># -&gt; calculate running sums (used to calculate indicators)</span></span>
<span><span class="co"># -&gt; calculate closing information</span></span>
<span><span class="co"># -&gt; summarize by claim</span></span>
<span><span class="va">data_claims_tr</span> <span class="op">&lt;-</span> <span class="va">data_claims_tr_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_pull_date</span>, <span class="va">policy_number</span>, <span class="va">claim_no</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paid_loss</span>, <span class="va">salv</span>, <span class="va">subr</span>, <span class="va">case_res</span>, <span class="va">alae_paid</span>, <span class="va">alae_rec</span>, <span class="va">alae_res</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>                .names <span class="op">=</span> <span class="st">"{.col}_rsum"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">data_pull_date</span>, <span class="va">policy_number</span>, <span class="va">claim_no</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">set_claim_close_info</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>claim_cwp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">claim_close</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">paid_loss_rsum</span> <span class="op">-</span> <span class="va">salv_rsum</span> <span class="op">-</span> <span class="va">subr_rsum</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>         claim_cwop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">claim_close</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">paid_loss_rsum</span> <span class="op">-</span> <span class="va">salv_rsum</span> <span class="op">-</span> <span class="va">subr_rsum</span> <span class="op">&lt;=</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_pull_date</span>, <span class="va">policy_number</span>, <span class="va">company</span>, <span class="va">state</span>, <span class="va">claim_no</span>, <span class="va">iso_code</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="op">-</span><span class="va">transaction_date</span><span class="op">)</span>, <span class="va">max</span><span class="op">)</span>,</span>
<span>            last_transaction_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">transaction_date</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">claim_close</span>, <span class="va">claim_cwp</span>, <span class="va">claim_cwop</span>, <span class="va">paid_loss</span>, <span class="va">salv</span>, <span class="va">subr</span>, <span class="va">case_res</span>, <span class="va">alae_paid</span>, <span class="va">alae_rec</span>, <span class="va">alae_res</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Join data ----</span></span>
<span></span>
<span><span class="co"># join claims datasets</span></span>
<span><span class="co"># -&gt; data checks passed (only recent claim activity was different in terms of the financials)</span></span>
<span><span class="co"># --&gt; so only keeping financial data from one source (OPEU123/6 rather than Majesco) and for non-close dates</span></span>
<span><span class="co"># --&gt; but using Majesco as primary source for claim count data</span></span>
<span><span class="va">data_claims</span> <span class="op">&lt;-</span> <span class="va">data_claims_mtd_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">data_claims_tr</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">pol_num</span> <span class="op">==</span> <span class="va">policy_number</span>, <span class="va">claim_num</span> <span class="op">==</span> <span class="va">claim_no</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># mutate(check_paid_loss = paid_loss - mtd_paid_loss,</span></span>
<span>  <span class="co">#        check_salv = salv - mtd_salv,</span></span>
<span>  <span class="co">#        check_subr = subr - mtd_subr,</span></span>
<span>  <span class="co">#        check_case_res = case_res - mtd_case_res,</span></span>
<span>  <span class="co">#        check_alae_paid = alae_paid - mtd_alae_paid,</span></span>
<span>  <span class="co">#        check_alae_res = alae_res - mtd_alae_res,</span></span>
<span>  <span class="co">#        check_inc_loss = round(mtd_paid_loss - mtd_salv - mtd_subr + mtd_case_res - mtd_inc_loss, 5),</span></span>
<span>  <span class="co">#        check_loss_date = loss_date - ymd(as.Date(acc_date)),</span></span>
<span>  <span class="co">#        check_rep_date = ymd(as.Date(rep_date)) - reported_date)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pol_state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">pol_state</span><span class="op">)</span>, <span class="va">pol_state</span>, <span class="va">state</span><span class="op">)</span>,</span>
<span>         company <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">company.x</span><span class="op">)</span>, <span class="va">company.x</span>, <span class="va">company.y</span><span class="op">)</span>,</span>
<span>         term_eff_date <span class="op">=</span> <span class="va">term_eff_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         acc_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">acc_date</span><span class="op">)</span>, <span class="va">acc_date</span>, <span class="va">loss_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         rep_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">rep_date</span><span class="op">)</span>, <span class="va">rep_date</span>, <span class="va">reported_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         close_date <span class="op">=</span> <span class="va">close_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         last_transaction_date <span class="op">=</span> <span class="va">last_transaction_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         claim_close <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">claim_close</span><span class="op">)</span>, <span class="va">claim_close</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mtd_case_res</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         paid_loss_mtd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mtd_paid_loss</span><span class="op">)</span>, <span class="va">mtd_paid_loss</span>, <span class="va">paid_loss</span><span class="op">)</span>,</span>
<span>         salv_mtd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mtd_salv</span><span class="op">)</span>, <span class="va">mtd_salv</span>, <span class="va">salv</span><span class="op">)</span>,</span>
<span>         subr_mtd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mtd_subr</span><span class="op">)</span>, <span class="va">mtd_subr</span>, <span class="va">subr</span><span class="op">)</span>,</span>
<span>         case_res_mtd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mtd_case_res</span><span class="op">)</span>, <span class="va">mtd_case_res</span>, <span class="va">case_res</span><span class="op">)</span>,</span>
<span>         alae_paid_mtd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mtd_alae_paid</span><span class="op">)</span>, <span class="va">mtd_alae_paid</span>, <span class="va">alae_paid</span><span class="op">)</span>,</span>
<span>         alae_res_mtd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mtd_alae_res</span><span class="op">)</span>, <span class="va">mtd_alae_res</span>, <span class="va">alae_res</span><span class="op">)</span>,</span>
<span>         claim_cwp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">claim_cwp</span><span class="op">)</span>, <span class="va">claim_cwp</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">claim_close</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">paid_loss_mtd</span> <span class="op">-</span> <span class="va">salv_mtd</span> <span class="op">-</span> <span class="va">subr_mtd</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         claim_cwop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">claim_cwop</span><span class="op">)</span>, <span class="va">claim_cwop</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">claim_close</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">paid_loss_mtd</span> <span class="op">-</span> <span class="va">salv_mtd</span> <span class="op">-</span> <span class="va">subr_mtd</span> <span class="op">&lt;=</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">claim_num</span>, <span class="va">company</span>, <span class="va">pol_state</span>, <span class="va">term_eff_date</span>, <span class="va">acc_date</span>, <span class="va">rep_date</span>, <span class="va">close_date</span>, <span class="va">last_transaction_date</span>, <span class="va">iso_code</span>, <span class="va">peril_code</span>, <span class="va">claim_close</span>, <span class="va">claim_cwp</span>, <span class="va">claim_cwop</span>, orig_loss_res_mtd <span class="op">=</span> <span class="va">mtd_orig_loss_res</span>, <span class="va">paid_loss_mtd</span>, <span class="va">salv_mtd</span>, <span class="va">subr_mtd</span>, <span class="va">case_res_mtd</span>, <span class="va">alae_paid_mtd</span>, alae_rec_mtd <span class="op">=</span> <span class="va">alae_rec</span>, <span class="va">alae_res_mtd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_pull_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_claims_mtd_raw</span><span class="op">$</span><span class="va">data_pull_date</span><span class="op">)</span>, <span class="co"># not sure why pulling the date from either data source isn't working, just assuming both pulled same day</span></span>
<span>         peril_code <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">peril_code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HAIL"</span>, <span class="st">"LIGHTNING"</span>, <span class="st">"WIND"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"WIND"</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">peril_code</span><span class="op">)</span> <span class="op">~</span> <span class="st">"NOT_RECORDED"</span>,</span>
<span>           <span class="va">peril_code</span> <span class="op">==</span> <span class="st">""</span> <span class="op">~</span> <span class="st">"NOT_RECORDED"</span>,</span>
<span>           .default <span class="op">=</span> <span class="va">peril_code</span></span>
<span>         <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">last_transaction_date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2015</span><span class="op">)</span> <span class="co"># last 10 years of data</span></span>
<span></span>
<span><span class="co"># save and write results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_claims</span>, file <span class="op">=</span> <span class="st">"RData\\data_claims.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># write to csv so can upload flat file into sql</span></span>
<span><span class="co"># -&gt; just file and save as .xlsx into 'Colton Analyses' folder for David</span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">data_claims</span>, file <span class="op">=</span> <span class="st">"Excel data\\data_claims.csv"</span>, na <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Actuarially modify claims data ----</span></span>
<span></span>
<span><span class="co"># load data with calculated term IDs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_claims.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remove missing data claims</span></span>
<span><span class="va">data_claims</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">paid_loss_mtd</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># look at CAT claims</span></span>
<span><span class="va">data_claims_cat</span> <span class="op">&lt;-</span> <span class="va">data_claims</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">iso_code</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remove CATs</span></span>
<span><span class="va">data_claims_non_cats</span> <span class="op">&lt;-</span> <span class="va">data_claims</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">iso_code</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read in LDFs</span></span>
<span><span class="co"># -&gt; source: in 'Indications q4 2024 eval q1 2025.xlsx'</span></span>
<span><span class="co"># -&gt; NOTE: these are non-CAT LDFs</span></span>
<span><span class="va">data_ldfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data_ldfs</span><span class="op">$</span><span class="va">incurred_loss</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"LDFs.xlsx"</span>,</span>
<span>                                             sheet <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span></span>
<span><span class="va">data_ldfs</span><span class="op">$</span><span class="va">incurred_claim_count</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"LDFs.xlsx"</span>,</span>
<span>                                                    sheet <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; reformat</span></span>
<span><span class="va">data_ldfs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"age_to_age"</span>, values_to <span class="op">=</span> <span class="st">"ldf"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_to_age <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">age_to_age</span>, start <span class="op">=</span> <span class="fl">5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"_to_"</span>, <span class="st">":"</span><span class="op">)</span>,</span>
<span>             row_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cdf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="va">ldf</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="va">age_to_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_locate.html">str_locate</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">":"</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">row_id</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># develop claims to ultimate individually</span></span>
<span><span class="co"># -&gt; calculate age (rounded to the nearest 3 month period (i.e. quarter))</span></span>
<span><span class="co"># -&gt; as-of-date is the start of the future policy period (described below)</span></span>
<span><span class="va">as_of_date_age</span> <span class="op">&lt;-</span> <span class="st">"2025-11-03"</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"1"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span></span>
<span><span class="va">data_claims_non_cats_ult</span> <span class="op">&lt;-</span> <span class="va">data_claims_non_cats</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">acc_date</span>, <span class="va">as_of_date_age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ceiling</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_join <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">age</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_ldfs</span><span class="op">$</span><span class="va">incurred_loss</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ldfs</span><span class="op">$</span><span class="va">incurred_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, cdf_incurred_loss <span class="op">=</span> <span class="va">cdf</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">age_join</span> <span class="op">==</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ldfs</span><span class="op">$</span><span class="va">incurred_claim_count</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, cdf_incurred_claim_count <span class="op">=</span> <span class="va">cdf</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">age_join</span> <span class="op">==</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">age_join</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>incurred_loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">paid_loss_mtd</span>, <span class="va">case_res_mtd</span>, <span class="va">alae_paid_mtd</span>, <span class="va">alae_res_mtd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">salv_mtd</span>, <span class="va">subr_mtd</span>, <span class="va">alae_rec_mtd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         incurred_claim_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">claim_close</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">claim_close</span><span class="op">)</span>, <span class="co"># add close and open claim counts ==&gt; results in 1 for every record cause we have data at claim level</span></span>
<span>         ult_incurred_loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">incurred_loss</span> <span class="op">*</span> <span class="va">cdf_incurred_loss</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>         ult_claim_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">incurred_claim_count</span> <span class="op">*</span> <span class="va">cdf_incurred_claim_count</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">ungroup</span></span>
<span></span>
<span><span class="co"># trend claims individually</span></span>
<span><span class="co"># -&gt; trend selects pulled from 'Indications q4 2024 eval q1 2025.xlsx' for MA</span></span>
<span><span class="co"># -&gt; future policy period = 12/01/2025 - 12/01/2026 ==&gt; avg accident date = 12/01/2026</span></span>
<span><span class="va">trend_freq</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.01868</span></span>
<span><span class="va">trend_sev</span> <span class="op">&lt;-</span> <span class="fl">0.08833</span></span>
<span><span class="va">avg_acc_date_trend</span> <span class="op">&lt;-</span> <span class="va">as_of_date_age</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_claims_non_cats_ult_trended</span> <span class="op">&lt;-</span> <span class="va">data_claims_non_cats_ult</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>loss_trend_factor <span class="op">=</span> <span class="va">trend_freq</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">trend_sev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">acc_date</span>, <span class="va">avg_acc_date_trend</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         trended_ult_incurred_loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">ult_incurred_loss</span> <span class="op">*</span> <span class="va">loss_trend_factor</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># cap large losses</span></span>
<span><span class="va">data_claims_non_cats_ult_trended_capped</span> <span class="op">&lt;-</span> <span class="va">data_claims_non_cats_ult_trended</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trended_ult_incurred_loss_capped <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">trended_ult_incurred_loss</span> <span class="op">&gt;</span> <span class="fl">100000</span>, <span class="fl">100000</span>, <span class="va">trended_ult_incurred_loss</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># reformat trended ult loss as by-peril</span></span>
<span><span class="co"># -&gt; calculate capped losses (still keeping original losses though)</span></span>
<span><span class="co"># -&gt; first aggregate over term effective date (i.e. policy period)</span></span>
<span><span class="va">data_claims_non_cats_ult_trended_capped_by_peril</span> <span class="op">&lt;-</span> <span class="va">data_claims_non_cats_ult_trended_capped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_pull_date</span>, <span class="va">pol_num</span>, <span class="va">company</span>, <span class="va">pol_state</span>, <span class="va">term_eff_date</span>, <span class="va">peril_code</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"trended_ult_incurred_loss"</span><span class="op">)</span>, <span class="va">incurred_claim_count</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">peril_code</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">incurred_claim_count</span>, <span class="va">trended_ult_incurred_loss</span>, <span class="va">trended_ult_incurred_loss_capped</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>incurred_claim_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`incurred_claim_count_OTHER`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_LIABILITY`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_WATERNONWEATHER`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_THEFT`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_WIND`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_WATERWEATHER`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_NOT_RECORDED`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_FIRE`</span>,</span>
<span>                                    <span class="va">`incurred_claim_count_HURRICANE`</span>,</span>
<span>                                    na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         .after <span class="op">=</span> <span class="va">term_eff_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"trended_ult_incurred_loss_"</span>, <span class="st">"peril_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"trended_ult_incurred_loss_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_claims_non_cats_ult_trended_capped_by_peril</span>, file <span class="op">=</span> <span class="st">"RData\\data_claims_non_cats_ult_trended_capped_by_peril.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Load actuarially modified data: RData ----</span></span>
<span></span>
<span><span class="co"># load data with calculated term IDs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_claims_non_cats_ult_trended_capped_by_peril.RData"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="tiering-analysis---exposure" class="level3" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="tiering-analysis---exposure">
<span class="header-section-number">3.1.2</span> Tiering analysis - Exposure</h3>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages and define functions ---- </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define function to modify exposure data</span></span>
<span><span class="va">modify_exposure_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_policy</span>, <span class="va">df_expos</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># split policy data based on if / when renewed with lapse</span></span>
<span>  <span class="va">df_policy_split</span> <span class="op">=</span> <span class="va">df_policy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span>term_eff_month <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span>, term_eff_day <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># duplicate exposure data</span></span>
<span>  <span class="co"># -&gt; add term_num_id and corresponding term_eff_date</span></span>
<span>  <span class="co"># -&gt; calculate modified exposures</span></span>
<span>  <span class="va">df_expos_dup_mod</span> <span class="op">=</span> <span class="va">df_policy_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">df_expos</span><span class="op">)</span>, \<span class="op">(</span><span class="va">df_p</span>, <span class="va">df_expos</span>, <span class="va">last_month_exposure_data</span><span class="op">)</span> <span class="fu">duplicate_rows</span><span class="op">(</span><span class="va">df_p</span>, <span class="va">df_expos</span>, last_month_expos_data <span class="op">=</span> <span class="va">last_month_expos_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">calc_term_num_id</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_policy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">term_eff_date</span>, <span class="va">cancel_date</span>, <span class="va">term_num_id</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">term_num_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">calc_modified_expos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_eff_month</span>, <span class="va">term_eff_day</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">term_num_id</span>, .before <span class="op">=</span> <span class="va">term_month_id</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add check for when modified exposure</span></span>
<span>  <span class="va">df_expos_dup_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_expos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">calyr</span>, <span class="va">calmth</span>, <span class="va">exposyr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>exposyr_orig <span class="op">=</span> <span class="va">exposyr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">calyr</span>, <span class="va">calmth</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>check <span class="op">=</span> <span class="va">exposyr</span> <span class="op">==</span> <span class="va">exposyr_orig</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># correct exposures for cancel in first month of renewal term</span></span>
<span>  <span class="va">last_row</span> <span class="op">=</span> <span class="va">df_expos_dup_mod</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">nrows</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_expos_dup_mod</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">nrows</span> <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">last_row</span><span class="op">$</span><span class="va">term_month_id</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">last_row</span><span class="op">$</span><span class="va">cancel_date</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">last_row</span><span class="op">$</span><span class="va">cancel_date</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">last_row</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># get exposure info</span></span>
<span>    <span class="co"># -&gt; first have to reset exposyr to its original value (was portioned out wrong)</span></span>
<span>    <span class="co"># -&gt; modify total days based on cancellation date </span></span>
<span>    <span class="va">expos_info</span> <span class="op">=</span> <span class="va">last_row</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exposyr <span class="op">=</span> <span class="va">exposyr_orig</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">extract_expos_info</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">expos_info</span><span class="op">$</span><span class="va">total_days</span> <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">df_expos_dup_mod</span><span class="op">[</span><span class="va">nrows</span>,<span class="st">"cancel_date"</span><span class="op">]</span><span class="op">$</span><span class="va">cancel_date</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    </span>
<span>    <span class="co"># portion out the 13 term_month_id (if it gets there)</span></span>
<span>    <span class="va">df_expos_dup_mod</span><span class="op">[</span><span class="va">nrows</span><span class="op">-</span><span class="fl">1</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># portion out the 1 term_month_id</span></span>
<span>    <span class="va">df_expos_dup_mod</span><span class="op">[</span><span class="va">nrows</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">-</span> <span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span><span class="op">)</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_expos_dup_mod</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define second function to correctly duplicate rows</span></span>
<span><span class="va">duplicate_rows</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_p</span>, <span class="va">df_expos</span>, <span class="va">last_month_expos_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># define endpoints of time interval</span></span>
<span>  <span class="va">begin_year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">year</span></span>
<span>  <span class="va">begin_month</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">month</span></span>
<span>  <span class="va">end_year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_exp_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">year</span></span>
<span>  <span class="va">end_month</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_exp_date</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_exp_date</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">month</span>,  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_exp_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">month</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># get exposure data within interval of interest</span></span>
<span>  <span class="co"># -&gt; also add common variables for next step</span></span>
<span>  <span class="va">df_e</span> <span class="op">=</span> <span class="va">df_expos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_id_total <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>           nrows_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">row_id_total</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">calyr</span>, <span class="va">begin_year</span>, <span class="va">end_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>keep <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">calyr</span> <span class="op">==</span> <span class="va">begin_year</span> <span class="op">&amp;</span> <span class="va">calmth</span> <span class="op">&lt;</span> <span class="va">begin_month</span> <span class="op">~</span> <span class="cn">FALSE</span>,</span>
<span>      <span class="va">calyr</span> <span class="op">==</span> <span class="va">begin_year</span> <span class="op">&amp;</span> <span class="va">calmth</span> <span class="op">&gt;=</span> <span class="va">begin_month</span> <span class="op">~</span> <span class="cn">TRUE</span>,</span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">calyr</span>, <span class="va">begin_year</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">end_year</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="cn">TRUE</span>,</span>
<span>      <span class="va">calyr</span> <span class="op">==</span> <span class="va">end_year</span> <span class="op">&amp;</span> <span class="va">calmth</span> <span class="op">&lt;=</span> <span class="va">end_month</span> <span class="op">~</span> <span class="cn">TRUE</span>,</span>
<span>      <span class="va">calyr</span> <span class="op">==</span> <span class="va">end_year</span> <span class="op">&amp;</span> <span class="va">calmth</span> <span class="op">&gt;</span> <span class="va">end_month</span> <span class="op">~</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">keep</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">keep</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>orig_eff_year <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           last_eff_year <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           term_eff_month <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           term_eff_day <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           row_id_subset <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>           nrows_subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">row_id_subset</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_p</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># conditionally duplicate partial months</span></span>
<span>    <span class="co"># -&gt; then reassign subset assign row ID and nrows_subset</span></span>
<span>    <span class="va">df_e_dup</span> <span class="op">=</span> <span class="va">df_e</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">tmp</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">calmth</span> <span class="op">==</span> <span class="va">term_eff_month</span>, <span class="va">term_eff_day</span> <span class="op">!=</span> <span class="fl">1</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">row_id_subset</span>, <span class="fl">2</span>, <span class="va">nrows_subset</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># -&gt; duplicate records for "interim" ending partial months of the subset of rows</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">calmth</span> <span class="op">==</span> <span class="va">term_eff_month</span>, <span class="va">term_eff_day</span> <span class="op">!=</span> <span class="fl">1</span>, <span class="va">nrows_total</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="va">row_id_total</span> <span class="op">==</span> <span class="va">nrows_total</span>, <span class="va">last_eff_year</span> <span class="op">==</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">pmaccndte</span><span class="op">)</span>, <span class="va">term_eff_month</span> <span class="op">==</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">pmaccndte</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># -&gt; duplicate records for cancel first month of renewal term (but not cancel first month of original term)</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">last_eff_year</span> <span class="op">==</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="va">term_eff_month</span> <span class="op">==</span> <span class="va">last_month_expos_data</span>, <span class="va">term_eff_day</span> <span class="op">!=</span> <span class="fl">1</span>, <span class="va">row_id_total</span> <span class="op">==</span> <span class="va">nrows_total</span>, <span class="va">nrows_total</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># -&gt; duplicate  for renew in last month of exposure data</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">calyr</span>, <span class="va">calmth</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_id_subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">orig_eff_year</span> <span class="op">&gt;=</span> <span class="fl">2013</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term_eff_month</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">13</span> <span class="op">-</span> <span class="va">term_eff_month</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">13</span> <span class="op">-</span> <span class="va">term_eff_month</span><span class="op">)</span><span class="op">)</span>, <span class="co"># correct for policies that are mid-term when 2013-01-01 gets here</span></span>
<span>             nrows_subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">row_id_subset</span><span class="op">)</span>,</span>
<span>             term_month_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>               <span class="fu"><a href="https://lubridate.tidyverse.org/reference/leap_year.html">leap_year</a></span><span class="op">(</span><span class="va">orig_eff_year</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">term_eff_month</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">term_eff_day</span> <span class="op">==</span> <span class="fl">29</span> <span class="op">&amp;</span> <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">13</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">13</span>,</span>
<span>               <span class="fu"><a href="https://lubridate.tidyverse.org/reference/leap_year.html">leap_year</a></span><span class="op">(</span><span class="va">orig_eff_year</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">term_eff_month</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">term_eff_day</span> <span class="op">==</span> <span class="fl">29</span> <span class="op">&amp;</span> <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">13</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">13</span>,</span>
<span>               <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">13</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">13</span>,</span>
<span>               <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">13</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">13</span></span>
<span>             <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># don't need to duplicate any rows</span></span>
<span>    <span class="co"># -&gt; reassign subset row ID</span></span>
<span>    <span class="va">df_e_dup</span> <span class="op">=</span> <span class="va">df_e</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_id_subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">orig_eff_year</span> <span class="op">&gt;=</span> <span class="fl">2013</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">term_eff_month</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">13</span> <span class="op">-</span> <span class="va">term_eff_month</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">13</span> <span class="op">-</span> <span class="va">term_eff_month</span><span class="op">)</span><span class="op">)</span>, <span class="co"># correct for policies that are mid-term when 2013-01-01 gets here</span></span>
<span>             nrows_subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">row_id_subset</span><span class="op">)</span>,</span>
<span>             term_month_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>               <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">12</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">12</span>,</span>
<span>               <span class="va">row_id_subset</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">12</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">12</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># combine results</span></span>
<span>  <span class="va">df_e_dup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"row_id_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"nrows_"</span><span class="op">)</span>, <span class="va">orig_eff_year</span>, <span class="va">last_eff_year</span>, <span class="va">term_eff_month</span>, <span class="va">term_eff_day</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define function to calculate term_num_id</span></span>
<span><span class="va">calc_term_num_id</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_expos_dup</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># initialize</span></span>
<span>  <span class="va">term_num_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">term_num_id_counter</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_expos_dup</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># increase counter when term restarts</span></span>
<span>    <span class="va">term_num_id_counter</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df_expos_dup</span><span class="op">[</span><span class="va">i</span>,<span class="st">"term_month_id"</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">term_num_id_counter</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">term_num_id_counter</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># set new term number</span></span>
<span>    <span class="va">term_num_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">term_num_id_counter</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># add term_num_id</span></span>
<span>  <span class="va">df_expos_dup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span>term_num_id <span class="op">=</span> <span class="va">term_num_id</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_expos_dup</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define function to extract needed exposure information for a record</span></span>
<span><span class="va">extract_expos_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_e_dup_i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># calculate needed values</span></span>
<span>  <span class="va">begin_of_month</span> <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/make_datetime.html">make_date</a></span><span class="op">(</span><span class="va">df_e_dup_i</span><span class="op">$</span><span class="va">calyr</span>, <span class="va">df_e_dup_i</span><span class="op">$</span><span class="va">calmth</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">begin_of_next_month</span> <span class="op">=</span> <span class="va">begin_of_month</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create named list</span></span>
<span>  <span class="co"># -&gt; endpoints, calculated number of days in the month of interest, set original exposure</span></span>
<span>  <span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"begin_of_month"</span> <span class="op">=</span> <span class="va">begin_of_month</span>,</span>
<span>                 <span class="st">"begin_of_next_month"</span> <span class="op">=</span> <span class="va">begin_of_next_month</span>,</span>
<span>                 <span class="st">"total_days"</span> <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">begin_of_month</span>, <span class="va">begin_of_next_month</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                 <span class="st">"original_exposyr"</span> <span class="op">=</span> <span class="va">df_e_dup_i</span><span class="op">$</span><span class="va">exposyr</span>,</span>
<span>                 <span class="st">"days_of_coverage"</span> <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">df_e_dup_i</span><span class="op">$</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define function to calculate modified exposures</span></span>
<span><span class="co"># -&gt; input needs to have term_num_id added already</span></span>
<span><span class="va">calc_modified_expos</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_expos_dup</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># conditionally portion out exposures</span></span>
<span>  <span class="va">df_expos_dup_mod</span> <span class="op">=</span> <span class="va">df_expos_dup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">term_num_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, .y <span class="op">=</span> <span class="va">term_num_id</span>, <span class="kw">function</span><span class="op">(</span><span class="va">df_e_dup</span>, <span class="va">term_num_id</span>, <span class="va">num_terms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">term_num_id</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">term_num_id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span> <span class="co"># first_term_num_id</span></span>
<span>        </span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"pmoeffdte"</span><span class="op">]</span><span class="op">$</span><span class="va">pmoeffdte</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2015</span><span class="op">)</span> <span class="op">{</span></span>
<span>          </span>
<span>          <span class="co"># conditionally portion out the 1 term_month_id for older policies</span></span>
<span>          <span class="co"># -&gt; back out starting exposures from prior terms that aren't in the policy data</span></span>
<span>          <span class="va">expos_info</span> <span class="op">=</span> <span class="fu">extract_expos_info</span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span>          <span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">-</span> <span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span><span class="op">)</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>          </span>
<span>        <span class="op">}</span></span>
<span>        </span>
<span>        <span class="co"># only portion out if it gets there and if there are multiple terms</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">)</span> <span class="op">==</span> <span class="fl">13</span> <span class="op">&amp;</span> <span class="va">num_terms</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>          </span>
<span>          <span class="co"># portion out the 13 term_month_id</span></span>
<span>          <span class="va">expos_info</span> <span class="op">=</span> <span class="fu">extract_expos_info</span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">[</span><span class="fl">13</span>,<span class="op">]</span><span class="op">)</span></span>
<span>          <span class="va">df_e_dup</span><span class="op">[</span><span class="fl">13</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>          </span>
<span>        <span class="op">}</span></span>
<span>        </span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">term_num_id</span>, <span class="fl">2</span>, <span class="va">num_terms</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># middle term_num_ids</span></span>
<span>        </span>
<span>        <span class="co"># portion out the 1 term_month_id</span></span>
<span>        <span class="va">expos_info</span> <span class="op">=</span> <span class="fu">extract_expos_info</span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">-</span> <span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span><span class="op">)</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>        </span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">)</span> <span class="op">==</span> <span class="fl">13</span><span class="op">)</span> <span class="op">{</span></span>
<span>          </span>
<span>          <span class="co"># portion out the 13 term_month_id (if it gets there)</span></span>
<span>          <span class="va">expos_info</span> <span class="op">=</span> <span class="fu">extract_expos_info</span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">[</span><span class="fl">13</span>,<span class="op">]</span><span class="op">)</span></span>
<span>          <span class="va">df_e_dup</span><span class="op">[</span><span class="fl">13</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>          </span>
<span>        <span class="op">}</span>    </span>
<span>        </span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co"># last term_num_id</span></span>
<span>        </span>
<span>        <span class="co"># portion out the 1 term_month_id</span></span>
<span>        <span class="va">expos_info</span> <span class="op">=</span> <span class="fu">extract_expos_info</span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">df_e_dup</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"exposyr"</span><span class="op">]</span> <span class="op">=</span> <span class="va">expos_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">-</span> <span class="va">.</span><span class="op">$</span><span class="va">days_of_coverage</span><span class="op">)</span> <span class="op">/</span> <span class="va">.</span><span class="op">$</span><span class="va">total_days</span> <span class="op">*</span> <span class="va">.</span><span class="op">$</span><span class="va">original_exposyr</span>, <span class="fl">5</span><span class="op">)</span><span class="op">}</span></span>
<span>        </span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_e_dup</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">ungroup</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_expos_dup_mod</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### ---- Load data: SQL ----</span></span>
<span></span>
<span><span class="co"># establish connection</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">odbc</span><span class="fu">::</span><span class="fu">odbc</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                      Driver <span class="op">=</span> <span class="st">"SQL Server"</span>,</span>
<span>                      Server <span class="op">=</span> <span class="st">"sql22-jax\\pricing"</span>,</span>
<span>                      trusted_connection <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run query for policy data</span></span>
<span><span class="co"># -&gt; already worked with and finalized data in SSMS</span></span>
<span><span class="va">data_policy</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from pricing.CLT.tiering_analysis_BPPOL"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_pull_date <span class="op">=</span> <span class="va">data_pull_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_num_id</span>, <span class="va">term_premium</span>, <span class="va">term_fees</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"loi"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"ded"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"lmiit"</span><span class="op">)</span>, <span class="va">payroll</span>, <span class="va">adv_qt_days</span>, <span class="va">num_sw_pols</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="op">-</span><span class="va">data_pull_date</span><span class="op">)</span>, <span class="va">mdy</span><span class="op">)</span>,</span>
<span>         data_pull_date <span class="op">=</span> <span class="va">data_pull_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>policy_data_pull_date <span class="op">=</span> <span class="va">data_pull_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2015</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># last 10 years of data</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">pol_num</span>,</span>
<span>         term_num_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># reassign term_num_id for better match to exposure data (i.e. starting anew at 2015/01/01)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_num_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># close connection</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Load data: Databricks ----</span></span>
<span></span>
<span><span class="co"># establish connection</span></span>
<span><span class="co"># --&gt; !!! NEED TO HAVE .Renviron setup</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">odbc</span><span class="fu">::</span><span class="fu">databricks</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  httpPath <span class="op">=</span> <span class="st">"/sql/1.0/warehouses/XXXXXXXXXXXXXXXX"</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run query</span></span>
<span><span class="va">data_expos_raw</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>,</span>
<span>                                  <span class="st">"select * </span></span>
<span><span class="st">                        from database.calmonth_exposure -- exposure file</span></span>
<span><span class="st">                        where left(PMPRFX,2) in ('BC','BP','CM','CZ','XC','ZC', 'ZP')</span></span>
<span><span class="st">                        order by POLNO, CALYR, CALMTH</span></span>
<span><span class="st">                        --limit 100</span></span>
<span><span class="st">                    "</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pmprfx</span>, <span class="va">pmplnr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pmaccndte <span class="op">=</span> <span class="va">pmaccndte</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.character.POSIXt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.Date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span>,</span>
<span>         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">calyr</span>, <span class="va">calmth</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># removes cancels dates of 01/01/0001</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_pull_date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">pmteffdte</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2015</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># last 10 years of data</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">pmoeffdte</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">pmteffdte</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># filter out renew with lapse in different month (too difficult and nest_by() messes up the order for Dec to Jan policies)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/leap_year.html">leap_year</a></span><span class="op">(</span><span class="va">pmoeffdte</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">pmoeffdte</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">pmoeffdte</span><span class="op">)</span> <span class="op">==</span> <span class="fl">29</span><span class="op">)</span><span class="op">)</span> <span class="co"># filter out policies written on leap day (nest_by() messes up the order)</span></span>
<span></span>
<span><span class="co"># close connection</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save raw data so don't have to rerun in new month</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_expos_raw</span>, file <span class="op">=</span> <span class="st">"RData\\data_expos_raw.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Modify exposure data ----</span></span>
<span></span>
<span><span class="co"># load raw exposure data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_expos_raw.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create combined nested dataset of policy and exposure information</span></span>
<span><span class="co"># -&gt; only want policies with exposure data</span></span>
<span><span class="va">last_month_expos_data</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data_policy_expos</span> <span class="op">&lt;-</span> <span class="va">data_policy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">pol_num</span>, .keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>data_policy <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">data_expos_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">polno</span>, .keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>data_expos <span class="op">=</span> <span class="va">data</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">pol_num</span> <span class="op">==</span> <span class="va">polno</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_expos <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data_policy</span><span class="op">)</span>, .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data_expos</span><span class="op">)</span>, \<span class="op">(</span><span class="va">df_policy</span>, <span class="va">df_expos</span><span class="op">)</span> <span class="fu">modify_exposure_data</span><span class="op">(</span><span class="va">df_policy</span>, <span class="va">df_expos</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_policy_expos</span>, file <span class="op">=</span> <span class="st">"RData\\data_policy_expos.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Create final datsets ----</span></span>
<span></span>
<span><span class="co"># load combined nested dataset of policy and exposure information </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_policy_expos.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get modified exposure data</span></span>
<span><span class="va">data_expos</span> <span class="op">&lt;-</span> <span class="va">data_policy_expos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">data_policy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">data_expos</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">data_pull_date</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">polno</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_expos</span>, file <span class="op">=</span> <span class="st">"RData\\data_expos.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get policy data that matches the exposure data</span></span>
<span><span class="va">data_policy_matched</span> <span class="op">&lt;-</span> <span class="va">data_policy_expos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">data_expos</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_policy <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data_policy</span><span class="op">)</span>, \<span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">df</span>, <span class="op">-</span><span class="va">pol_num</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">data_policy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">policy_data_pull_date</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_policy_matched</span>, file <span class="op">=</span> <span class="st">"RData\\data_policy_matched.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Load data: RData ----</span></span>
<span></span>
<span><span class="co"># load combined nested dataset of policy and exposure information </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_policy_expos.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load modified exposure data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_expos.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load matched policy data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_policy_matched.RData"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="tiering-analysis---combined" class="level3" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="tiering-analysis---combined">
<span class="header-section-number">3.1.3</span> Tiering analysis - Combined</h3>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages and define functions ---- </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define function to summarize exposures by grouping variables univariately</span></span>
<span><span class="va">summarize_exposures</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">tmp</span> <span class="op">=</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="va">exposyr</span>, <span class="va">earned_premium_with_fees_trended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                exposyr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">exposyr</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                earned_premium_with_fees_trended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">earned_premium_with_fees_trended</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">exposyr</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">results</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">exposyr</span>, <span class="va">earned_premium_with_fees_trended</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### ---- Load data: RData ----</span></span>
<span></span>
<span><span class="co"># load matched policy data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_policy_matched.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load trended, ult summarized claim data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_claims_non_cats_ult_trended_capped_by_peril.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load modified exposure data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_expos.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Recode premium data ----</span></span>
<span></span>
<span><span class="co"># recode data to levels of tiering variables</span></span>
<span><span class="va">data_policy_matched_lvls</span> <span class="op">&lt;-</span> <span class="va">data_policy_matched</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"claim_type_"</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>                  <span class="va">.x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RIOT"</span>,<span class="st">"HAIL"</span>,<span class="st">"LIGHT"</span>,<span class="st">"VMM"</span>,<span class="st">"WEATH"</span>,<span class="st">"WIND"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>                  .default <span class="op">=</span> <span class="fl">2</span></span>
<span>                <span class="op">)</span><span class="op">)</span>,</span>
<span>         credit_range <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">credit_score</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"No Score"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">582</span> <span class="op">~</span> <span class="st">"582 or Less"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">596</span> <span class="op">~</span> <span class="st">"583 - 596"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">609</span> <span class="op">~</span> <span class="st">"597 - 609"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">622</span> <span class="op">~</span> <span class="st">"610 - 622"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">635</span> <span class="op">~</span> <span class="st">"623 - 635"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">645</span> <span class="op">~</span> <span class="st">"636 - 645"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">654</span> <span class="op">~</span> <span class="st">"646 - 654"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">663</span> <span class="op">~</span> <span class="st">"655 - 663"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">672</span> <span class="op">~</span> <span class="st">"664 - 672"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">681</span> <span class="op">~</span> <span class="st">"673 - 681"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">689</span> <span class="op">~</span> <span class="st">"682 - 689"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">696</span> <span class="op">~</span> <span class="st">"690 - 696"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">704</span> <span class="op">~</span> <span class="st">"697 - 704"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">711</span> <span class="op">~</span> <span class="st">"705 - 711"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">717</span> <span class="op">~</span> <span class="st">"712 - 717"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">722</span> <span class="op">~</span> <span class="st">"718 - 722"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">728</span> <span class="op">~</span> <span class="st">"723 - 728"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">734</span> <span class="op">~</span> <span class="st">"729 - 734"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">740</span> <span class="op">~</span> <span class="st">"735 - 740"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">745</span> <span class="op">~</span> <span class="st">"741 - 745"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">750</span> <span class="op">~</span> <span class="st">"746 - 750"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">758</span> <span class="op">~</span> <span class="st">"751 - 758"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">764</span> <span class="op">~</span> <span class="st">"759 - 764"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">771</span> <span class="op">~</span> <span class="st">"765 - 771"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">777</span> <span class="op">~</span> <span class="st">"772 - 777"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">786</span> <span class="op">~</span> <span class="st">"778 - 786"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">794</span> <span class="op">~</span> <span class="st">"787 - 794"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">802</span> <span class="op">~</span> <span class="st">"795 - 802"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">810</span> <span class="op">~</span> <span class="st">"803 - 810"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">828</span> <span class="op">~</span> <span class="st">"811 - 828"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">845</span> <span class="op">~</span> <span class="st">"829 - 845"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">862</span> <span class="op">~</span> <span class="st">"846 - 862"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&lt;=</span> <span class="fl">879</span> <span class="op">~</span> <span class="st">"863 - 879"</span>,</span>
<span>           <span class="va">credit_score</span> <span class="op">&gt;=</span> <span class="fl">880</span> <span class="op">~</span> <span class="st">"880 or More"</span>,</span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"582 or Less"</span>,<span class="st">"583 - 596"</span>,<span class="st">"597 - 609"</span>,<span class="st">"610 - 622"</span>,<span class="st">"623 - 635"</span>,<span class="st">"636 - 645"</span>,<span class="st">"646 - 654"</span>,</span>
<span>                                 <span class="st">"655 - 663"</span>,<span class="st">"664 - 672"</span>,<span class="st">"673 - 681"</span>,<span class="st">"682 - 689"</span>,<span class="st">"690 - 696"</span>,<span class="st">"697 - 704"</span>,<span class="st">"705 - 711"</span>,</span>
<span>                                 <span class="st">"712 - 717"</span>,<span class="st">"718 - 722"</span>,<span class="st">"723 - 728"</span>,<span class="st">"729 - 734"</span>,<span class="st">"735 - 740"</span>,<span class="st">"741 - 745"</span>,<span class="st">"746 - 750"</span>,</span>
<span>                                 <span class="st">"751 - 758"</span>,<span class="st">"759 - 764"</span>,<span class="st">"765 - 771"</span>,<span class="st">"772 - 777"</span>,<span class="st">"778 - 786"</span>,<span class="st">"787 - 794"</span>,<span class="st">"795 - 802"</span>,</span>
<span>                                 <span class="st">"803 - 810"</span>,<span class="st">"811 - 828"</span>,<span class="st">"829 - 845"</span>,<span class="st">"846 - 862"</span>,<span class="st">"863 - 879"</span>,<span class="st">"880 or More"</span>, <span class="st">"No Score"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         credit_range2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"582 or Less"</span>,<span class="st">"583 - 596"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"596 or Less"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"597 - 609"</span>,<span class="st">"610 - 622"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"597 - 622"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"623 - 635"</span>,<span class="st">"636 - 645"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"623 - 645"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"646 - 654"</span>,<span class="st">"655 - 663"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"646 - 663"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"664 - 672"</span>,<span class="st">"673 - 681"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"664 - 681"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"682 - 689"</span>,<span class="st">"690 - 696"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"682 - 696"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"697 - 704"</span>,<span class="st">"705 - 711"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"697 - 711"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"712 - 717"</span>,<span class="st">"718 - 722"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"712 - 722"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"723 - 728"</span>,<span class="st">"729 - 734"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"723 - 734"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"735 - 740"</span>,<span class="st">"741 - 745"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"735 - 745"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"746 - 750"</span>,<span class="st">"751 - 758"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"746 - 758"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"759 - 764"</span>,<span class="st">"765 - 771"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"759 - 771"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"772 - 777"</span>,<span class="st">"778 - 786"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"772 - 786"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"787 - 794"</span>,<span class="st">"795 - 802"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"787 - 802"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"803 - 810"</span>,<span class="st">"811 - 828"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"803 - 828"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"829 - 845"</span>,<span class="st">"846 - 862"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"829 - 862"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"863 - 879"</span>,<span class="st">"880 or More"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"863 or More"</span>,</span>
<span>           <span class="va">credit_range</span> <span class="op">==</span> <span class="st">"No Score"</span> <span class="op">~</span> <span class="st">"No Score"</span>,</span>
<span>           .default <span class="op">=</span> <span class="va">credit_range</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"596 or Less"</span>,<span class="st">"597 - 622"</span>,<span class="st">"623 - 645"</span>,<span class="st">"646 - 663"</span>,<span class="st">"664 - 681"</span>,<span class="st">"682 - 696"</span>,<span class="st">"697 - 711"</span>,</span>
<span>                                 <span class="st">"712 - 722"</span>,<span class="st">"723 - 734"</span>,<span class="st">"735 - 745"</span>,<span class="st">"746 - 758"</span>,<span class="st">"759 - 771"</span>,<span class="st">"772 - 786"</span>,<span class="st">"787 - 802"</span>,</span>
<span>                                 <span class="st">"803 - 828"</span>,<span class="st">"829 - 862"</span>,<span class="st">"863 or More"</span>,<span class="st">"No Score"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         years_in_business <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">year_bus_start</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_bus_start</span> <span class="op">&lt;=</span> <span class="fl">9</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_bus_start</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_bus_start</span> <span class="op">&gt;=</span> <span class="fl">10</span> <span class="op">~</span> <span class="st">"10 or More"</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>, <span class="st">"10 or More"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         age_of_building <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">year_built</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Unknown"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"0-2"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">10</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">12</span> <span class="op">~</span> <span class="st">"11-12"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">15</span> <span class="op">~</span> <span class="st">"13-15"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">17</span> <span class="op">~</span> <span class="st">"16-17"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">20</span> <span class="op">~</span> <span class="st">"18-20"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">24</span> <span class="op">~</span> <span class="st">"21-24"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">29</span> <span class="op">~</span> <span class="st">"25-29"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">33</span> <span class="op">~</span> <span class="st">"30-33"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">44</span> <span class="op">~</span> <span class="st">"34-44"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">49</span> <span class="op">~</span> <span class="st">"45-49"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">59</span> <span class="op">~</span> <span class="st">"50-59"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">74</span> <span class="op">~</span> <span class="st">"60-74"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&lt;=</span> <span class="fl">99</span> <span class="op">~</span> <span class="st">"75-99"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_built</span> <span class="op">&gt;=</span> <span class="fl">100</span> <span class="op">~</span> <span class="st">"100 or More"</span>,</span>
<span>           .default <span class="op">=</span> <span class="st">"Unknown"</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0-2"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,<span class="st">"11-12"</span>,<span class="st">"13-15"</span>,<span class="st">"16-17"</span>,<span class="st">"18-20"</span>,<span class="st">"21-24"</span>,<span class="st">"25-29"</span>,<span class="st">"30-33"</span>,</span>
<span>                                 <span class="st">"34-44"</span>,<span class="st">"45-49"</span>,<span class="st">"50-59"</span>,<span class="st">"60-74"</span>,<span class="st">"75-99"</span>,<span class="st">"100 or More"</span>,<span class="st">"Unknown"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         age_of_roof <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">roof_year</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Unknown"</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">roof_year</span> <span class="op">&lt;=</span> <span class="fl">39</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">roof_year</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">term_eff_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">roof_year</span> <span class="op">&gt;=</span> <span class="fl">40</span> <span class="op">~</span> <span class="st">"40 or More"</span>,</span>
<span>           .default <span class="op">=</span> <span class="st">"Unknown"</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">39</span><span class="op">)</span>,<span class="st">"40 or More"</span>,<span class="st">"Unknown"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         roof_type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"asphault shingle"</span>,<span class="st">"as"</span>,<span class="st">"shingle"</span>,<span class="st">"asphalt comp roll"</span>,<span class="st">"comp roll"</span>,<span class="st">"comp"</span>,<span class="st">"comp toll"</span>,<span class="st">"composition"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"asphalt shingle"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tile, slate, stone"</span>,<span class="st">"tile"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"tile"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rubber"</span>,<span class="st">"rubber membrane"</span>,<span class="st">"membrane"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"synthetic"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tar, tar and gravel"</span>,<span class="st">"tar &amp; gravel"</span>,<span class="st">"t&amp;g"</span>,<span class="st">"t &amp; g"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"tar and gravel"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"thermo-plastic membrane"</span>,<span class="st">"thermo plastic"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"TPO"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op">==</span> <span class="st">"plastic membrane"</span> <span class="op">~</span> <span class="st">"EPDM"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op">==</span> <span class="st">"concrete"</span> <span class="op">~</span> <span class="st">"other"</span>,</span>
<span>           <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>,<span class="st">"flat"</span>,<span class="st">"gable"</span>,<span class="st">""</span><span class="op">)</span> <span class="op">~</span> <span class="st">"unknown"</span>,</span>
<span>           .default <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span></span>
<span>         <span class="op">)</span>,</span>
<span>         num_empl <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">num_empl</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Missing"</span>,</span>
<span>           <span class="va">num_empl</span> <span class="op">&lt;=</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"1-3"</span>,</span>
<span>           <span class="va">num_empl</span> <span class="op">&lt;=</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"4-6"</span>,</span>
<span>           <span class="va">num_empl</span> <span class="op">&lt;=</span> <span class="fl">12</span> <span class="op">~</span> <span class="st">"7-12"</span>,</span>
<span>           <span class="va">num_empl</span> <span class="op">&gt;=</span> <span class="fl">13</span> <span class="op">~</span> <span class="st">"13 or More"</span>,</span>
<span>           .default <span class="op">=</span> <span class="st">"Missing"</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Missing"</span>,<span class="st">"1-3"</span>,<span class="st">"4-6"</span>,<span class="st">"7-12"</span>,<span class="st">"13 or More"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         num_sw_pols <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">num_sw_pols</span> <span class="op">&lt;=</span> <span class="fl">3</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">num_sw_pols</span><span class="op">)</span>,</span>
<span>           <span class="va">num_sw_pols</span> <span class="op">&gt;=</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"4 or More"</span>,</span>
<span>           .default <span class="op">=</span> <span class="cn">NA</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,<span class="st">"4 or More"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         adv_qt_days <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">adv_qt_days</span> <span class="op">&lt;=</span> <span class="fl">14</span> <span class="op">~</span> <span class="st">"0-14"</span>,</span>
<span>           <span class="va">adv_qt_days</span> <span class="op">&lt;=</span> <span class="fl">30</span> <span class="op">~</span> <span class="st">"15-30"</span>,</span>
<span>           <span class="va">adv_qt_days</span> <span class="op">&gt;=</span> <span class="fl">31</span> <span class="op">~</span> <span class="st">"31 or More"</span>,</span>
<span>           .default <span class="op">=</span> <span class="st">"Missing"</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Missing"</span>,<span class="st">"0-14"</span>,<span class="st">"15-30"</span>,<span class="st">"31 or More"</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior_loss_history_points <span class="op">=</span> <span class="va">claim_type_1</span> <span class="op">+</span> <span class="va">claim_type_2</span> <span class="op">+</span> <span class="va">claim_type_3</span> <span class="op">+</span> <span class="va">claim_type_4</span> <span class="op">+</span> <span class="va">claim_type_5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Combine data ----</span></span>
<span></span>
<span><span class="co"># combine policy and claim data</span></span>
<span><span class="co"># -&gt; don't need the tiering info now, will join back on after aggregating</span></span>
<span><span class="va">data_combined</span> <span class="op">&lt;-</span> <span class="va">data_policy_matched_lvls</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_data_pull_date</span>, <span class="va">pol_num</span>, <span class="va">trans_type</span>, <span class="va">term_num_id</span>, <span class="va">pol_state</span>, <span class="va">orig_eff_date</span>, <span class="va">term_eff_date</span>, <span class="va">term_exp_date</span>, <span class="va">cancel_date</span>, <span class="va">pol_status</span>, <span class="va">expos_base</span>, <span class="va">bdg_loi</span>, <span class="va">bpp_loi</span>, <span class="va">sales</span>, <span class="va">payroll</span>, <span class="va">term_premium</span>, <span class="va">term_fees</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_claims_non_cats_ult_trended_capped_by_peril</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">company</span>, <span class="va">pol_state</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>claims_data_pull_date <span class="op">=</span> <span class="va">data_pull_date</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">pol_num</span> <span class="op">==</span> <span class="va">pol_num</span>, <span class="va">term_eff_date</span> <span class="op">==</span> <span class="va">term_eff_date</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine policy and exposure data</span></span>
<span><span class="co"># -&gt; zero out repeated premium and claim amounts</span></span>
<span><span class="va">data_combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term_eff_date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2025-11-01"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># don't have exposure data for the current month</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_expos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>expos_data_pull_date <span class="op">=</span> <span class="va">data_pull_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_eff_date</span>, <span class="va">cancel_date</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">pol_num</span> <span class="op">==</span> <span class="va">pol_num</span>, <span class="va">term_num_id</span> <span class="op">==</span> <span class="va">term_num_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_data_pull_date</span>, <span class="va">expos_data_pull_date</span>, <span class="va">pol_num</span>, <span class="va">pol_state</span>, <span class="va">company</span>, <span class="va">poltyp</span>, <span class="va">trans_type</span>, <span class="va">term_num_id</span>, <span class="va">term_month_id</span>, <span class="va">orig_eff_date</span>, <span class="va">term_eff_date</span>, <span class="va">term_exp_date</span>, <span class="va">cancel_date</span>, <span class="va">pol_status</span>, <span class="va">calyr</span>, <span class="va">calmth</span>, </span>
<span>         <span class="va">term_premium</span>, <span class="va">term_fees</span>, <span class="va">exposyr</span>, <span class="va">exposyr_orig</span>, <span class="va">check</span>, <span class="va">expos_base</span>, <span class="va">bdg_loi</span>, <span class="va">bpp_loi</span>, <span class="va">sales</span>, <span class="va">payroll</span>,</span>
<span>         <span class="va">claims_data_pull_date</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_num_id</span><span class="op">)</span>,</span>
<span>         row_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_premium</span>, <span class="va">term_fees</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>                  <span class="va">row_id</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">.x</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>                  .default <span class="op">=</span> <span class="fl">0</span></span>
<span>                <span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">row_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">exposyr</span><span class="op">)</span><span class="op">)</span> <span class="co"># real tiny amount of exposure data missing, not my fault</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_combined</span>, file <span class="op">=</span> <span class="st">"RData\\data_combined.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># write to csv for Karen to check trending</span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">data_combined</span>, <span class="st">"Excel data\\data_combined.csv"</span>, na <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Aggregate all data and trend premium data ----</span></span>
<span></span>
<span><span class="co"># load combined data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_combined.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># aggregate data by policy number / term</span></span>
<span><span class="co"># -&gt; rolling up over pol_num and term_num_id</span></span>
<span><span class="co"># -&gt; !!!! ASSUMING this correction / data error (I'm done...)</span></span>
<span><span class="co"># ---&gt; missing beginning policy term ==&gt; inflated first term exposyr</span></span>
<span><span class="co"># ---&gt; full last month of exposure when it shouldn't be</span></span>
<span><span class="co"># -&gt; calculate EP and add fees, and both written and earned exposures for property and liability</span></span>
<span><span class="co"># --&lt; !!! had approx 7800 policy terms with 0 exposure base (commercial landloards with no BPP), see notes below</span></span>
<span><span class="va">data_combined_agg</span> <span class="op">&lt;-</span> <span class="va">data_combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pol_num</span>,</span>
<span>                    <span class="va">term_num_id</span>,</span>
<span>                    <span class="va">term_eff_date</span>,</span>
<span>                    <span class="va">expos_base</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_premium</span>, <span class="va">term_fees</span>, <span class="va">exposyr</span>, <span class="va">bdg_loi</span>, <span class="va">bpp_loi</span>, <span class="va">sales</span>, <span class="va">payroll</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exposyr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">exposyr</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="va">exposyr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>earned_premium_with_fees <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">term_premium</span> <span class="op">+</span> <span class="va">term_fees</span><span class="op">)</span> <span class="op">*</span> <span class="va">exposyr</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>         term_premium_with_fees <span class="op">=</span> <span class="va">term_premium</span> <span class="op">+</span> <span class="va">term_fees</span>,</span>
<span>         written_expos_property <span class="op">=</span> <span class="op">(</span><span class="va">bdg_loi</span> <span class="op">+</span> <span class="va">bpp_loi</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span>,</span>
<span>         written_expos_liability <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">expos_base</span> <span class="op">==</span> <span class="st">"LOI"</span> <span class="op">&amp;</span> <span class="va">bpp_loi</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">bpp_loi</span> <span class="op">/</span> <span class="fl">100</span>,</span>
<span>           <span class="va">expos_base</span> <span class="op">==</span> <span class="st">"LOI"</span> <span class="op">&amp;</span> <span class="va">bpp_loi</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">sales</span> <span class="op">/</span> <span class="fl">1000</span>, <span class="co"># executive decision, correcting for $0 exposure base data errors by using a different exposure base</span></span>
<span>           <span class="va">expos_base</span> <span class="op">==</span> <span class="st">"SALES"</span> <span class="op">&amp;</span> <span class="va">sales</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">sales</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>           <span class="va">expos_base</span> <span class="op">==</span> <span class="st">"SALES"</span> <span class="op">&amp;</span> <span class="va">sales</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">bpp_loi</span> <span class="op">/</span> <span class="fl">100</span>, <span class="co"># correcting ... </span></span>
<span>           <span class="va">expos_base</span> <span class="op">==</span> <span class="st">"PAY"</span> <span class="op">&amp;</span> <span class="va">payroll</span> <span class="op">&gt;=</span> <span class="fl">1000</span> <span class="op">~</span> <span class="va">payroll</span> <span class="op">/</span> <span class="fl">1000</span>, <span class="co"># another executive decision, if less than 1000 of payroll, then set to missing</span></span>
<span>           <span class="va">expos_base</span> <span class="op">==</span> <span class="st">"PAY"</span> <span class="op">&amp;</span> <span class="va">payroll</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">sales</span> <span class="op">/</span> <span class="fl">1000</span> <span class="co"># correcting ...</span></span>
<span>         <span class="op">)</span>,</span>
<span>         earned_expos_property <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">written_expos_property</span> <span class="op">*</span> <span class="va">exposyr</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>         earned_expos_liability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">written_expos_liability</span> <span class="op">*</span> <span class="va">exposyr</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_eff_date</span>, <span class="va">term_num_id</span>, <span class="va">term_premium_with_fees</span>, <span class="va">earned_premium_with_fees</span>, <span class="va">exposyr</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"_expos_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check</span></span>
<span><span class="co"># (before simplifying assumption)</span></span>
<span><span class="va">data_check</span> <span class="op">&lt;-</span> <span class="va">data_combined_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">exposyr</span> <span class="op">&gt;</span> <span class="fl">1.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># trend premiums individually</span></span>
<span><span class="co"># -&gt; trend select pulled from 'Indications q4 2024 eval q1 2025.xlsx' for MA</span></span>
<span><span class="co"># -&gt; as-of-date is the start of the future policy period (described below)</span></span>
<span><span class="co"># -&gt; future policy period = 12/01/2025 - 12/01/2026 ==&gt; avg written date = 06/01/2026 and avg earned date = 12/01/2026</span></span>
<span><span class="co"># --&gt; written premium trend period length and earned premium trend period length should be the same (just minor differences due to timing of year)</span></span>
<span><span class="va">as_of_date_age</span> <span class="op">&lt;-</span> <span class="st">"2025-11-03"</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="st">"1"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">ymd</span></span>
<span><span class="va">trend_premium</span> <span class="op">&lt;-</span> <span class="fl">0.04259</span></span>
<span><span class="va">avg_written_date_trend</span> <span class="op">&lt;-</span> <span class="va">as_of_date_age</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">avg_earned_date_trend</span> <span class="op">&lt;-</span> <span class="va">as_of_date_age</span>  <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_combined_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>written_premium_trend_factor <span class="op">=</span> <span class="va">trend_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">term_eff_date</span>, <span class="va">avg_written_date_trend</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         earned_premium_trend_factor <span class="op">=</span> <span class="va">trend_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">term_eff_date</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>, <span class="va">avg_earned_date_trend</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         term_premium_with_fees_trended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">term_premium_with_fees</span> <span class="op">*</span> <span class="va">written_premium_trend_factor</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>         earned_premium_with_fees_trended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">earned_premium_with_fees</span> <span class="op">*</span> <span class="va">earned_premium_trend_factor</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_eff_date</span>, <span class="va">term_num_id</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"term_premium_with"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"earned_premium_with"</span><span class="op">)</span>, <span class="va">written_premium_trend_factor</span>, <span class="va">earned_premium_trend_factor</span>, <span class="va">exposyr</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"_expos_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># aggregate data by tiering variables</span></span>
<span><span class="co"># -&gt; calculate last tiering variable</span></span>
<span><span class="co"># -&gt; need one record for each combination of tiering variables</span></span>
<span><span class="co"># -&gt; in CA BOP UWG word doc, 6. Number of locations ==&gt; this is always 1 (never built this in), so skipping</span></span>
<span><span class="va">data_combined_agg_agg</span> <span class="op">&lt;-</span> <span class="va">data_combined_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_policy_matched_lvls</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_num_id</span>, <span class="va">credit_range</span>, <span class="va">prior_loss_history_points</span>, <span class="va">years_in_business</span>, <span class="va">age_of_building</span>, <span class="va">age_of_roof</span>, <span class="va">roof_type</span>, <span class="va">num_empl</span>, <span class="va">num_sw_pols</span>, <span class="va">num_renewals</span>, <span class="va">adv_qt_days</span>, <span class="va">entity_type</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_num_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num_renewals <span class="op">=</span> <span class="va">term_num_id</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">credit_range</span>,</span>
<span>                    <span class="va">prior_loss_history_points</span>,</span>
<span>                    <span class="va">years_in_business</span>,</span>
<span>                    <span class="va">age_of_building</span>,</span>
<span>                    <span class="va">age_of_roof</span>,</span>
<span>                    <span class="va">roof_type</span>,</span>
<span>                    <span class="va">num_empl</span>,</span>
<span>                    <span class="va">num_sw_pols</span>,</span>
<span>                    <span class="va">num_renewals</span>,</span>
<span>                    <span class="va">adv_qt_days</span>,</span>
<span>                    <span class="va">entity_type</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_premium_with_fees_trended</span>, <span class="va">earned_premium_with_fees_trended</span>, <span class="va">exposyr</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"_expos_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># repeat for credit_range2</span></span>
<span><span class="va">data_combined_agg_agg2</span> <span class="op">&lt;-</span> <span class="va">data_combined_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_policy_matched_lvls</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_num_id</span>, <span class="va">credit_range2</span>, <span class="va">prior_loss_history_points</span>, <span class="va">years_in_business</span>, <span class="va">age_of_building</span>, <span class="va">age_of_roof</span>, <span class="va">roof_type</span>, <span class="va">num_empl</span>, <span class="va">num_sw_pols</span>, <span class="va">num_renewals</span>, <span class="va">adv_qt_days</span>, <span class="va">entity_type</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">pol_num</span>, <span class="va">term_num_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num_renewals <span class="op">=</span> <span class="va">term_num_id</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">credit_range2</span>,</span>
<span>                    <span class="va">prior_loss_history_points</span>,</span>
<span>                    <span class="va">years_in_business</span>,</span>
<span>                    <span class="va">age_of_building</span>,</span>
<span>                    <span class="va">age_of_roof</span>,</span>
<span>                    <span class="va">roof_type</span>,</span>
<span>                    <span class="va">num_empl</span>,</span>
<span>                    <span class="va">num_sw_pols</span>,</span>
<span>                    <span class="va">num_renewals</span>,</span>
<span>                    <span class="va">adv_qt_days</span>,</span>
<span>                    <span class="va">entity_type</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">term_premium_with_fees_trended</span>, <span class="va">earned_premium_with_fees_trended</span>, <span class="va">exposyr</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"_expos_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred_claim_count_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"peril_"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># !!! some combinations have zero written liability exposure, don't think there's anything we can</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_combined_agg_agg</span>, file <span class="op">=</span> <span class="st">"RData\\data_combined_agg_agg.RData"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_combined_agg_agg2</span>, file <span class="op">=</span> <span class="st">"RData\\data_combined_agg_agg2.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate univariate exposure and earned premium by tiering variable</span></span>
<span><span class="va">summ_expos</span> <span class="op">&lt;-</span> <span class="va">data_combined_agg_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">credit_range</span>, <span class="va">prior_loss_history_points</span>, <span class="va">years_in_business</span>, <span class="va">age_of_building</span>, <span class="va">age_of_roof</span>, <span class="va">roof_type</span>, <span class="va">num_empl</span>, <span class="va">num_sw_pols</span>, <span class="va">num_renewals</span>, <span class="va">adv_qt_days</span>, <span class="va">entity_type</span>, <span class="va">exposyr</span>, <span class="va">earned_premium_with_fees_trended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">summarize_exposures</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html">%T&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">-&gt;&gt;</span> <span class="va">nms</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, .y <span class="op">=</span> <span class="va">.</span>, <span class="kw">function</span><span class="op">(</span><span class="va">nm</span>, <span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">total</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"total"</span>,</span>
<span>             .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">nm</span> <span class="op">:=</span> <span class="va">var</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">summ_expos</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nms</span></span>
<span></span>
<span><span class="co"># &lt; write to temporary csv and combine into single file, tiering-levels-exposure-premium.xlsx &gt;</span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">summ_expos</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"temp.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Load and write final data: RData ----</span></span>
<span></span>
<span><span class="co"># load interim data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_combined.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load final data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_combined_agg_agg.RData"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"RData\\data_combined_agg_agg2.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># write to xlsx (to avoid formatting errors) so can upload flat file into sql</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_combined_agg_agg</span>, file <span class="op">=</span> <span class="st">"Excel data\\data_combined_agg_agg.xlsx"</span>, na.strings <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_combined_agg_agg2</span>, file <span class="op">=</span> <span class="st">"Excel data\\data_combined_agg_agg2.xlsx"</span>, na.strings <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="analysis-projects" class="level3" data-number="3.1.4"><h3 data-number="3.1.4" class="anchored" data-anchor-id="analysis-projects">
<span class="header-section-number">3.1.4</span> Analysis projects</h3>
<p><img src="files/analysis-projects.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages ---- </span></span>
<span></span>
<span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jthomasmock/gtExtras">gtExtras</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Read in and organize data ---- </span></span>
<span></span>
<span><span class="co"># old inforce data</span></span>
<span><span class="va">data_inforce_old</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"InForce_20240430.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2024-04-30"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># new inforce data</span></span>
<span><span class="va">data_inforce_new</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"InForce_20250502.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2025-05-02"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine datsets</span></span>
<span><span class="va">data_inforce_all</span> <span class="op">&lt;-</span> <span class="va">data_inforce_old</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_inforce_new</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># export for excel version of analysis</span></span>
<span><span class="co"># data_inforce_all %&gt;% </span></span>
<span><span class="co">#   openxlsx2::write_xlsx(file = "InForce_all.xlsx", na.strings = "")</span></span>
<span></span>
<span><span class="co"># set highlight cutoff</span></span>
<span><span class="va">hl_cutoff</span> <span class="op">&lt;-</span> <span class="fl">0.10</span></span>
<span></span>
<span><span class="co"># define shortcut for conditional highlighting</span></span>
<span><span class="va">format_tbl_conditional_hl_changes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cell_fill.html">cell_fill</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="va">change</span>,</span>
<span>        rows <span class="op">=</span> <span class="va">percent_change</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="va">hl_cutoff</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="va">percent_change</span>,</span>
<span>        rows <span class="op">=</span>  <span class="va">percent_change</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="va">hl_cutoff</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cell_fill.html">cell_fill</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"green"</span>, alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="va">change</span>,</span>
<span>        rows <span class="op">=</span> <span class="va">percent_change</span> <span class="op">&gt;</span> <span class="va">hl_cutoff</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="va">percent_change</span>,</span>
<span>        rows <span class="op">=</span>  <span class="va">percent_change</span> <span class="op">&gt;</span> <span class="va">hl_cutoff</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### ---- Nail salons ----</span></span>
<span></span>
<span><span class="co"># define function</span></span>
<span><span class="va">format_liability_limits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">1e3</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>      <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">1e6</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">1e3</span><span class="op">)</span>, <span class="st">"K"</span><span class="op">)</span>,</span>
<span>      <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">1e9</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">1e6</span><span class="op">)</span>, <span class="st">"M"</span><span class="op">)</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"To be implemented..."</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># save sub datasets</span></span>
<span><span class="va">data_nails</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stillwater_class_description</span> <span class="op">==</span> <span class="st">"Nail Salon"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">occur_limit</span>, <span class="va">aggregate_limit</span>, <span class="va">premises_comp_ops_limit</span><span class="op">)</span>, <span class="va">format_liability_limits</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a) How many PIF compared to same time last year?</span></span>
<span><span class="co"># d) Average Premium change</span></span>
<span><span class="va">data_nails</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            mean_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">term_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">statistic</span> <span class="op">==</span> <span class="st">"mean_premium"</span>, <span class="st">"avg premium"</span>, <span class="va">statistic</span><span class="op">)</span>,</span>
<span>         change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nail salons - PIF and average premium"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">""</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span>, columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">2</span>, columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span>, columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">2</span>, columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">2</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># b) How many have the ISO Professional Liability coverage compared to last year?</span></span>
<span><span class="va">data_nails</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">pls_cov</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nail salons - PLS cov"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>pls_cov <span class="op">=</span> <span class="st">"PLS cov"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># c) Distribution of limits compared to last year?</span></span>
<span></span>
<span><span class="co"># i) Liability Limits</span></span>
<span><span class="va">data_nails</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>liability_limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">occur_limit</span>, <span class="va">aggregate_limit</span>, <span class="va">premises_comp_ops_limit</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">liability_limits</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nail salons - Liability limits"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>liability_limits <span class="op">=</span> <span class="st">"Liability limits"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ii)   BPP limits</span></span>
<span><span class="va">breaks_pls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">25000</span>,<span class="fl">50000</span>,<span class="fl">100000</span>,<span class="fl">1000000</span><span class="op">)</span></span>
<span><span class="va">data_nails</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bpp_loi_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">bpp_loi</span>, breaks <span class="op">=</span> <span class="va">breaks_pls</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span>,<span class="st">"(0,25k]"</span>,<span class="st">"(25k,50k]"</span>,<span class="st">"(50k,100k]"</span>,<span class="st">"&gt;100k"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">bpp_loi_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nail salons - BPP LOI"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>bpp_loi_group <span class="op">=</span> <span class="st">"BPP LOI"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Restaurants ----</span></span>
<span></span>
<span><span class="co"># save sub datasets</span></span>
<span><span class="co"># -&gt; modified raw data for class descriptions to make part b easier</span></span>
<span><span class="va">data_restaurants</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hierarchy_1</span> <span class="op">==</span> <span class="st">"Restaurants, Eating and Drinking Places"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stillwater_class_description_corrected_grouped <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">stillwater_class_description_corrected</span>, <span class="st">".*(?=\\ -)"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a) How many PIF compared to same time last year?</span></span>
<span><span class="co"># e) Average Premium change</span></span>
<span><span class="va">data_restaurants</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            mean_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">term_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">statistic</span> <span class="op">==</span> <span class="st">"mean_premium"</span>, <span class="st">"avg premium"</span>, <span class="va">statistic</span><span class="op">)</span>,</span>
<span>         change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Restaurants - PIF"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span>, columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">2</span>, columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span>, columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">2</span>, columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">2</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># b) Distribution among main restaurant classes?</span></span>
<span></span>
<span><span class="co"># i) Asian, Pizza, Buffet, etc. </span></span>
<span></span>
<span><span class="co"># find counts for all classes</span></span>
<span><span class="va">data_restaurants_regrouped</span> <span class="op">&lt;-</span> <span class="va">data_restaurants</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">stillwater_class_description_corrected_grouped</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            mean_sales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span>,</span>
<span>            mean_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">term_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>         .after <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stillwater_class_description_corrected_grouped <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">n</span> <span class="op">&lt;</span> <span class="fl">50</span> <span class="op">~</span> <span class="st">"Other"</span>,</span>
<span>             .default <span class="op">=</span> <span class="va">stillwater_class_description_corrected_grouped</span></span>
<span>           <span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co"># create counts for summary other row</span></span>
<span><span class="va">data_restaurants_regrouped_other</span> <span class="op">&lt;-</span> <span class="va">data_restaurants_regrouped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stillwater_class_description_corrected_grouped</span> <span class="op">==</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>temp1 <span class="op">=</span> <span class="va">n</span> <span class="op">*</span> <span class="va">mean_sales</span>,</span>
<span>         temp2 <span class="op">=</span> <span class="va">n</span><span class="op">*</span> <span class="va">mean_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">stillwater_class_description_corrected_grouped</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>            percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">percent</span><span class="op">)</span>,</span>
<span>            mean_sales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">temp1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>            mean_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">temp2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define helper function</span></span>
<span><span class="va">grouped_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">*</span><span class="va">n</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># create final table</span></span>
<span><span class="va">data_restaurants_regrouped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stillwater_class_description_corrected_grouped</span> <span class="op">!=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_restaurants_regrouped_other</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span>groupname_col <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Restaurants - PIF, sales and premium by class"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>stillwater_class_description_corrected_grouped <span class="op">=</span> <span class="st">"class description"</span>,</span>
<span>             mean_sales <span class="op">=</span> <span class="st">"avg sales"</span>,</span>
<span>             mean_premium <span class="op">=</span> <span class="st">"avg premium"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html">summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html">summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html">summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">mean_sales</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">mean_sales</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html">summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">mean_premium</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">mean_premium</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mean_sales</span>, <span class="va">mean_premium</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ii) Alcohol percent distributions - Percent of policies with LQL</span></span>
<span><span class="va">data_restaurants</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">lql_cov</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Restaurants - LQL cov"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>lql_cov <span class="op">=</span> <span class="st">"LQL cov"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># c) Percent with Building coverage</span></span>
<span><span class="va">data_restaurants</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">bdg_cov</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Restaurants - BDG cov"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>bdg_cov <span class="op">=</span> <span class="st">"BDG cov"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># d) Annual Sales averages / distributions compared to last year</span></span>
<span><span class="va">data_restaurants</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">sales</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span>, median <span class="op">=</span> <span class="va">median</span>, min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span>,</span>
<span>            q1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">sales</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            q3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">sales</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">min</span>, <span class="va">q1</span>, <span class="va">median</span>, <span class="va">mean</span>, <span class="va">q3</span>, <span class="va">max</span>, <span class="va">sd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">date</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Restaurants - Annual sales"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">""</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># i) By class</span></span>
<span><span class="co"># see part b) i)) above</span></span>
<span></span>
<span><span class="co"># e) Average Premium change</span></span>
<span><span class="co"># see above part a)</span></span>
<span></span>
<span><span class="co"># i) By Class</span></span>
<span><span class="co"># see part b) i)) above</span></span>
<span></span>
<span><span class="co">### ---- Lessorâ€™s risks / commercial landlords ----</span></span>
<span></span>
<span><span class="co"># save sub datasets</span></span>
<span><span class="va">data_lessors</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">lessor</span> <span class="op">==</span> <span class="st">"Yes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hierarchy_1_grouped <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">hierarchy_1</span> <span class="op">==</span> <span class="st">"Landlord (aka Lessor)"</span> <span class="op">~</span> <span class="va">hierarchy_1</span>,</span>
<span>             .default <span class="op">=</span> <span class="st">"Other"</span></span>
<span>           <span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co"># a) PIF compared to last year</span></span>
<span><span class="va">data_lessors</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">occupy</span>, <span class="va">hierarchy_1_grouped</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Lessor's risks / commercial landlords - PIF"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>hierarchy_1_grouped <span class="op">=</span> <span class="st">"hierarchy 1"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># b) Distribution of Building Limits â€“ how has it changed in last year?</span></span>
<span><span class="va">data_lessors</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>            date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">bdg_loi</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span>, median <span class="op">=</span> <span class="va">median</span>, min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span>,</span>
<span>            q1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">bdg_loi</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            q3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">bdg_loi</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">min</span>, <span class="va">q1</span>, <span class="va">median</span>, <span class="va">mean</span>, <span class="va">q3</span>, <span class="va">max</span>, <span class="va">sd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Lessor's risks / commercial landlords - BDG LOI"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">""</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># c) Deductible distributions</span></span>
<span></span>
<span><span class="co"># â€“&gt; all perils</span></span>
<span><span class="va">data_lessors</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">aop_deduct</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Lessor's risks / commercial landlords - All other perils deductibles"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>aop_deduct <span class="op">=</span> <span class="st">"AOP ded"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, <span class="va">aop_deduct</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; wind/hail</span></span>
<span><span class="va">data_lessors</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">wh_percent_deduct</span>, <span class="va">wh_dollar_deduct</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Lessor's risks / commercial landlords - Wind / Hail deductibles"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>wh_percent_deduct <span class="op">=</span> <span class="st">"W/H % ded"</span>,</span>
<span>             wh_dollar_deduct <span class="op">=</span> <span class="st">"W/H $ ded"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"dollar"</span><span class="op">)</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># d) Age of building distribution and compared to last year</span></span>
<span><span class="va">data_lessors</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>building_age <span class="op">=</span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">year</span>, <span class="va">year_built</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>            date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">building_age</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span>, median <span class="op">=</span> <span class="va">median</span>, min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span>,</span>
<span>            q1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">building_age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            q3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">building_age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">min</span>, <span class="va">q1</span>, <span class="va">median</span>, <span class="va">mean</span>, <span class="va">q3</span>, <span class="va">max</span>, <span class="va">sd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Lessor's risks / commercial landlords - Age of building"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">""</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Roofs ----</span></span>
<span></span>
<span><span class="co"># split data</span></span>
<span><span class="va">data_bdg</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>building <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">building_owned</span> <span class="op">==</span> <span class="st">"Yes"</span> <span class="op">|</span> <span class="va">bdg_cov</span> <span class="op">==</span> <span class="st">"Y"</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_roofs</span> <span class="op">&lt;-</span> <span class="va">data_bdg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">building</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 0) look at own buildings</span></span>
<span><span class="va">data_bdg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">building_owned</span>, <span class="va">bdg_cov</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Own building / building coverage"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>building_owned <span class="op">=</span> <span class="st">"Own building?"</span>,</span>
<span>             bdg_cov <span class="op">=</span> <span class="st">"BDG cov?"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"dollar"</span><span class="op">)</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># a) Distribution of roof types</span></span>
<span><span class="va">data_roofs</span><span class="op">[[</span><span class="st">"FALSE"</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Roofs - No BDG cov - Type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>roof_type <span class="op">=</span> <span class="st">"Type"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_roofs</span><span class="op">[[</span><span class="st">"TRUE"</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Roofs - BDG cov - Type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>roof_type <span class="op">=</span> <span class="st">"Type"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># b) Age of roof distributions</span></span>
<span><span class="va">data_roofs</span><span class="op">[[</span><span class="st">"FALSE"</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>roof_age <span class="op">=</span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">year</span>, <span class="va">roof_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>            date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">roof_age</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span>, median <span class="op">=</span> <span class="va">median</span>, min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span>,</span>
<span>            q1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">roof_age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            q3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">roof_age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">min</span>, <span class="va">q1</span>, <span class="va">median</span>, <span class="va">mean</span>, <span class="va">q3</span>, <span class="va">max</span>, <span class="va">sd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Roofs - No BDG cov - Age"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">""</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_roofs</span><span class="op">[[</span><span class="st">"TRUE"</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>roof_age <span class="op">=</span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">year</span>, <span class="va">roof_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>            date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">roof_age</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span>, median <span class="op">=</span> <span class="va">median</span>, min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span>,</span>
<span>            q1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">roof_age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            q3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">roof_age</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">min</span>, <span class="va">q1</span>, <span class="va">median</span>, <span class="va">mean</span>, <span class="va">q3</span>, <span class="va">max</span>, <span class="va">sd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Roofs - BDG cov - Age"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">""</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Classes ----</span></span>
<span></span>
<span><span class="co"># a) How has our overall policy count by classes and Program changed over the past year?</span></span>
<span></span>
<span><span class="co"># find counts for all classes</span></span>
<span><span class="va">data_classes_regrouped</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">stillwater_class_description_corrected</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>         .after <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stillwater_class_description_corrected <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">n</span> <span class="op">&lt;</span> <span class="fl">50</span> <span class="op">~</span> <span class="st">"Other"</span>,</span>
<span>             .default <span class="op">=</span> <span class="va">stillwater_class_description_corrected</span></span>
<span>            <span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co"># create counts for summary other row</span></span>
<span><span class="va">data_classes_regrouped_other</span> <span class="op">&lt;-</span> <span class="va">data_classes_regrouped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stillwater_class_description_corrected</span> <span class="op">==</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">stillwater_class_description_corrected</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>            percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">percent</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create final table</span></span>
<span><span class="va">data_classes_regrouped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stillwater_class_description_corrected</span> <span class="op">!=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_classes_regrouped_other</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span>groupname_col <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Classes - PIF"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>stillwater_class_description_corrected <span class="op">=</span> <span class="st">"class description"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html">summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html">summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- States ----</span></span>
<span></span>
<span><span class="co"># a) Which states are growing and shrinking? By how much?</span></span>
<span><span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">policy_state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            mean_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">term_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">mean_premium</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_change <span class="op">=</span> <span class="va">`n_2025-05-02`</span> <span class="op">-</span> <span class="va">`n_2024-04-30`</span>,</span>
<span>         n_percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">n_change</span> <span class="op">/</span> <span class="va">`n_2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">n_change</span> <span class="op">/</span> <span class="va">`n_2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">n_change</span> <span class="op">/</span> <span class="va">`n_2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">n_change</span> <span class="op">/</span> <span class="va">`n_2024-04-30`</span><span class="op">)</span>,</span>
<span>         mean_premium_change <span class="op">=</span> <span class="va">`mean_premium_2025-05-02`</span> <span class="op">-</span> <span class="va">`mean_premium_2024-04-30`</span>,</span>
<span>         mean_premium_percent_change <span class="op">=</span> <span class="va">mean_premium_change</span> <span class="op">/</span> <span class="va">`mean_premium_2024-04-30`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">`n_2024-04-30`</span>, <span class="va">`n_2025-05-02`</span>, <span class="va">n_change</span>, <span class="va">n_percent_change</span>, <span class="va">`mean_premium_2024-04-30`</span>, <span class="va">`mean_premium_2025-05-02`</span>, <span class="va">mean_premium_change</span>, <span class="va">mean_premium_percent_change</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"States - PIF"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`n_2024-04-30`</span>, <span class="va">`n_2025-05-02`</span>, <span class="va">n_change</span>, <span class="va">n_percent_change</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`mean_premium_2024-04-30`</span>, <span class="va">`mean_premium_2025-05-02`</span>, <span class="va">mean_premium_change</span>, <span class="va">mean_premium_percent_change</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"mean premium"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>policy_state <span class="op">=</span> <span class="st">"State"</span>,</span>
<span>             `n_2024-04-30` <span class="op">=</span> <span class="st">"2024-04-30"</span>,</span>
<span>             `n_2025-05-02` <span class="op">=</span> <span class="st">"2025-05-02"</span>,</span>
<span>             `mean_premium_2024-04-30` <span class="op">=</span> <span class="st">"2024-04-30"</span>,</span>
<span>             `mean_premium_2025-05-02` <span class="op">=</span> <span class="st">"2025-05-02"</span>,</span>
<span>             n_change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             n_percent_change <span class="op">=</span> <span class="st">"% change"</span>,</span>
<span>             mean_premium_change <span class="op">=</span> <span class="st">"$ change"</span>,</span>
<span>             mean_premium_percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`n_2024-04-30`</span>, <span class="va">`n_2025-05-02`</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`mean_premium_2024-04-30`</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">.x</span>, <span class="va">`n_2024-04-30`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`mean_premium_2025-05-02`</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">.x</span>, <span class="va">`n_2025-05-02`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns  <span class="op">=</span> <span class="va">n_change</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`mean_premium_change`</span>,</span>
<span>                     fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">`mean_premium_2025-05-02`</span>, <span class="va">`n_2025-05-02`</span><span class="op">)</span> <span class="op">-</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">`mean_premium_2024-04-30`</span>, <span class="va">`n_2024-04-30`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n_percent_change</span>,</span>
<span>                     fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`n_2025-05-02`</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`n_2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`n_2024-04-30`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">mean_premium_percent_change</span>,</span>
<span>                     fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="op">(</span><span class="fu">grouped_mean</span><span class="op">(</span><span class="va">`mean_premium_2025-05-02`</span>, <span class="va">`n_2025-05-02`</span><span class="op">)</span> <span class="op">-</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">`mean_premium_2024-04-30`</span>, <span class="va">`n_2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu">grouped_mean</span><span class="op">(</span><span class="va">`mean_premium_2024-04-30`</span>, <span class="va">`n_2024-04-30`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`n_2024-04-30`</span>, <span class="va">`n_2025-05-02`</span>, <span class="va">n_change</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`mean_premium_2024-04-30`</span>, <span class="va">`mean_premium_2025-05-02`</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">mean_premium_change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"percent_change"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n_percent_change</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># follow-up -&gt; look into negative average premium changes</span></span>
<span><span class="co"># split data</span></span>
<span><span class="va">data_split_premium</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine data again and create status variable</span></span>
<span><span class="va">data_states</span> <span class="op">&lt;-</span> <span class="va">data_split_premium</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">policy_number</span>, <span class="va">term_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">data_split_premium</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">policy_number</span>, <span class="va">term_premium</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_old"</span>, <span class="st">"_new"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">term_premium_new</span> <span class="op">-</span> <span class="va">term_premium_old</span>,</span>
<span>         status <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">term_premium_old</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">term_premium_new</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>           <span class="va">term_premium_old</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">term_premium_new</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>           .default <span class="op">=</span> <span class="fl">1</span></span>
<span>         <span class="op">)</span>,</span>
<span>         policy_state <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">status</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="va">policy_state_new</span>,</span>
<span>           <span class="va">status</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="va">policy_state_old</span>,</span>
<span>           .default <span class="op">=</span> <span class="va">policy_state_old</span></span>
<span>         <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">policy_number</span>, <span class="va">status</span>, <span class="va">term_premium_old</span>, <span class="va">term_premium_new</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">status</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"premium"</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create overall summary rows</span></span>
<span><span class="va">data_summ1</span> <span class="op">&lt;-</span> <span class="va">data_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">status</span>, <span class="va">n</span>, <span class="va">term_premium_old</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">term_premium_old</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"premium"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">.x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fl">4</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_summ2</span> <span class="op">&lt;-</span> <span class="va">data_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">status</span>, <span class="va">n</span>, <span class="va">term_premium_new</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">term_premium_new</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"premium"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">.x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fl">4</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create final table</span></span>
<span><span class="va">data_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_summ1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_summ2</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">status</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">status</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">status</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"renew"</span>,</span>
<span>    <span class="va">status</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"non-renew"</span>,</span>
<span>    <span class="va">status</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"new business"</span>,</span>
<span>    <span class="va">status</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"overall"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  mean_premium_change <span class="op">=</span> <span class="va">term_premium_new</span> <span class="op">-</span> <span class="va">term_premium_old</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"States - Average premium changes by status"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>term_premium_old <span class="op">=</span> <span class="st">"2024-04-30"</span>,</span>
<span>             term_premium_new <span class="op">=</span> <span class="st">"2025-05-02"</span>,</span>
<span>             mean_premium_change <span class="op">=</span> <span class="st">"mean change in premium"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"term"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_currency.html">fmt_currency</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">mean_premium_change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># b) Any particular classes growing quickly in specific states?</span></span>
<span><span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">policy_state</span>, <span class="va">stillwater_class_description_corrected</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">policy_state</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>change <span class="op">=</span> <span class="va">`2025-05-02`</span> <span class="op">-</span> <span class="va">`2024-04-30`</span>,</span>
<span>         percent_change <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.infinite</a></span><span class="op">(</span><span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">change</span> <span class="op">/</span> <span class="va">`2024-04-30`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">`2024-04-30`</span> <span class="op">&gt;</span> <span class="fl">50</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">percent_change</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">hl_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"States - Large PIF changes by class"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>policy_state <span class="op">=</span> <span class="st">"State"</span>,</span>
<span>             stillwater_class_description_corrected <span class="op">=</span> <span class="st">"class description"</span>,</span>
<span>             change <span class="op">=</span> <span class="st">"change"</span>,</span>
<span>             percent_change <span class="op">=</span> <span class="st">"% change"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">change</span>, decimals <span class="op">=</span> <span class="fl">0</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">percent_change</span>, decimals <span class="op">=</span> <span class="fl">1</span>, force_sign <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">format_tbl_conditional_hl_changes</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_add_divider.html">gt_add_divider</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">`2025-05-02`</span>, color <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- New business versus renewals ----</span></span>
<span></span>
<span><span class="co"># add new variable and save dataset</span></span>
<span><span class="va">data_new_business</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_business <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">policy_effective_date</span> <span class="op">==</span> <span class="va">inception_date</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 0) New business rate</span></span>
<span><span class="va">data_new_business</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>            policy_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            new_business_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">new_business</span><span class="op">)</span>,</span>
<span>            percent_new_business <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">new_business</span><span class="op">)</span>,</span>
<span>            percent_renewal <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">new_business</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"New business rates"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>policy_count <span class="op">=</span> <span class="st">"Total policies"</span>,</span>
<span>             new_business_count <span class="op">=</span> <span class="st">"Count NB"</span>,</span>
<span>             percent_new_business <span class="op">=</span> <span class="st">"Percent NB"</span>,</span>
<span>             percent_renewal <span class="op">=</span> <span class="st">"Percent Ren"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"count"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a) Retention rate</span></span>
<span></span>
<span><span class="co"># read in old old inforce data</span></span>
<span><span class="va">data_inforce_old_old</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"InForce_20230430.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2023-04-30"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert datasets to list</span></span>
<span><span class="va">data_split_retention_1</span> <span class="op">&lt;-</span> <span class="va">data_inforce_old_old</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_inforce_old</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate retention rate</span></span>
<span><span class="va">data_retention</span> <span class="op">&lt;-</span> <span class="va">data_split_retention_1</span><span class="op">$</span><span class="va">`2023-04-30`</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_split_retention_1</span><span class="op">$</span><span class="va">`2024-04-30`</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">policy_number</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_old_old"</span>, <span class="st">"_old"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>retained <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_old</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>starting_policies <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            retained_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">retained</span><span class="op">)</span>,</span>
<span>            retained_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">retained</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>timeframe <span class="op">=</span> <span class="st">"2023 to 2024"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert datasets to list</span></span>
<span><span class="va">data_split_retention2</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate retention rate</span></span>
<span><span class="va">data_split_retention2</span><span class="op">$</span><span class="va">`2024-04-30`</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_split_retention2</span><span class="op">$</span><span class="va">`2025-05-02`</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">policy_number</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_old"</span>, <span class="st">"_new"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>retained <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_new</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>starting_policies <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            retained_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">retained</span><span class="op">)</span>,</span>
<span>            retained_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">retained</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>timeframe <span class="op">=</span> <span class="st">"2024 to 2025"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_retention</span>, <span class="va">.</span><span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Retention rates"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>timeframe <span class="op">=</span> <span class="st">"Timeframe"</span>,</span>
<span>             starting_policies <span class="op">=</span> <span class="st">"Starting policies"</span>,</span>
<span>             retained_count <span class="op">=</span> <span class="st">"Count retained"</span>,</span>
<span>             retained_percent <span class="op">=</span> <span class="st">"Percent retained"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">starting_policies</span>, <span class="va">retained_count</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">retained_percent</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a) Can we determine how the distribution of our new business (last two months?) has changed from the overall in-force book? Iâ€™m looking to see how our changes in rules and processes may have changed what is coming through the door as new business.</span></span>
<span><span class="va">data_recent</span> <span class="op">&lt;-</span> <span class="va">data_new_business</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>recent_new_business <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">new_business</span> <span class="op">&amp;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">policy_effective_date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2025-03-01"</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># what specifically to look at??? Is there a list of recent actions taken?</span></span>
<span><span class="co"># -&gt; lets start with hierarchy 1 / classes</span></span>
<span><span class="va">data_recent</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">recent_new_business</span>, <span class="va">hierarchy_1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">recent_new_business</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">recent_new_business</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"FALSE"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"TRUE"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Recent new business (written &lt; 2 months ago) - Classes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"FALSE"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"No"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"TRUE"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"Yes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>hierarchy_1 <span class="op">=</span> <span class="st">"Hierarchy 1"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># look into types of restaurants</span></span>
<span><span class="va">data_recent_restaurants</span> <span class="op">&lt;-</span> <span class="va">data_recent</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hierarchy_1</span> <span class="op">==</span> <span class="st">"Restaurants, Eating and Drinking Places"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stillwater_class_description_corrected_grouped <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">stillwater_class_description_corrected</span>, <span class="st">".*(?=\\ -)"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_recent_restaurants</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">recent_new_business</span>, <span class="va">stillwater_class_description_corrected_grouped</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">recent_new_business</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">recent_new_business</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">recent_new_business</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"FALSE"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"TRUE"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Recent new business (written &lt; 2 months ago) - Restaurant types"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"FALSE"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"No"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"TRUE"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"Yes"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>stillwater_class_description_corrected_grouped <span class="op">=</span> <span class="st">"Class"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Tennessee ----</span></span>
<span></span>
<span><span class="co"># look into reduction of PIF in TN</span></span>
<span><span class="va">data_tn</span> <span class="op">&lt;-</span> <span class="va">data_inforce_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">policy_state</span> <span class="op">==</span> <span class="st">"TN"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># type of policy</span></span>
<span><span class="va">data_tn</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">bdg_cov</span>, <span class="va">bpp_cov</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"TN - Type of policy"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>bdg_cov <span class="op">=</span> <span class="st">"BDG"</span>,</span>
<span>             bpp_cov <span class="op">=</span> <span class="st">"BPP"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># location</span></span>
<span><span class="va">data_tn</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>location_city <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2024-04-30"</span><span class="op">)</span>, <span class="va">mailing_city</span>, <span class="va">location_city</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">location_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">date</span>,</span>
<span>         percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">percent</span><span class="op">)</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"TN - Locations"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2024-04-30"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"2025-05-02"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>location_city <span class="op">=</span> <span class="st">"Location city"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"percent"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"percent"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># business class</span></span>
<span><span class="va">data_tn</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">stillwater_class_description_corrected</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"TN - Business class"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>stillwater_class_description_corrected <span class="op">=</span> <span class="st">"class"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># agents</span></span>
<span><span class="va">data_tn</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">agency</span>, <span class="va">sub_agent</span>, <span class="va">agent</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">date</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2024"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"2025"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"TN - Agents"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>sub_agent <span class="op">=</span> <span class="st">"sub agent"</span>,</span>
<span>             <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/grand_summary_rows.html">grand_summary_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"-"</span><span class="op">)</span>,</span>
<span>               fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Total"</span>, fn <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>               fmt <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span><span class="va">.</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"n"</span><span class="op">)</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="large-risks-analysis" class="level3" data-number="3.1.5"><h3 data-number="3.1.5" class="anchored" data-anchor-id="large-risks-analysis">
<span class="header-section-number">3.1.5</span> Large risks analysis</h3>
<p><img src="files/large-risks-analysis.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/">leaflet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read in inforce file from excel</span></span>
<span><span class="va">data_inforce_raw</span> <span class="op">&lt;-</span> <span class="fu">readxlsb</span><span class="fu">::</span><span class="fu">read_xlsb</span><span class="op">(</span><span class="st">"InForce_20241001.xlsb"</span>, sheet <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rename variables</span></span>
<span><span class="co"># -&gt; select only needed columns</span></span>
<span><span class="co"># -&gt; combine address information</span></span>
<span><span class="va">data_inforce</span> <span class="op">&lt;-</span> <span class="va">data_inforce_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_number</span>, <span class="va">policy_effective_date</span>, <span class="va">policy_expiration_date</span>, <span class="va">policy_status</span>, <span class="va">named_insured</span>, <span class="va">location_address</span>, <span class="va">location_city</span>, <span class="va">location_state</span>, <span class="va">location_zip_code</span>, <span class="va">policy_state</span>, <span class="va">longitude</span>, <span class="va">latitude</span>, <span class="va">stillwater_class_description</span>, <span class="va">hierarchy_1</span>, <span class="va">bdg_loi</span>, <span class="va">bpp_loi</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>location_address <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">location_address</span>, <span class="st">", "</span>, <span class="va">location_city</span>, <span class="st">" "</span>, <span class="va">location_zip_code</span>, <span class="st">" "</span>, <span class="va">location_state</span><span class="op">)</span>, .before <span class="op">=</span> <span class="va">policy_state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">location_city</span>, <span class="va">location_state</span>, <span class="va">location_zip_code</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>combined_loi <span class="op">=</span> <span class="va">bdg_loi</span> <span class="op">+</span> <span class="va">bpp_loi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save as .RData file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_inforce</span>, file <span class="op">=</span> <span class="st">"data-inforce.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read in cleaned inforce file from RData file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data-inforce.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define function to determine large risks</span></span>
<span><span class="co"># criteria: within radius and individually less than limit</span></span>
<span><span class="co"># -&gt; radius of 0.282 gives a quarter-mile in area; limit of $1.5M needs to be looked at</span></span>
<span><span class="co"># -&gt; if above limit, it has already been looked at closely; so focusing on aggregate risks</span></span>
<span><span class="va">find_large_risks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">df</span>, <span class="va">radius</span> <span class="op">=</span> <span class="fl">0.282</span>, <span class="va">limit</span> <span class="op">=</span> <span class="fl">1500000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># tracking purposes</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">100</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># single out row for comparison</span></span>
<span>  <span class="va">data_i</span> <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>distance_from_i <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create dataframe of all other rows</span></span>
<span>  <span class="va">data_other</span> <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="op">-</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># calculate distance to all other policies</span></span>
<span>  <span class="co"># -&gt; filter to all within a mile (after converting to miles)</span></span>
<span>  <span class="va">data_close</span> <span class="op">=</span> <span class="va">data_other</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>distance_from_i <span class="op">=</span> <span class="fu">geosphere</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distm.html">distm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data_i</span><span class="op">$</span><span class="va">longitude</span>, <span class="va">data_i</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span>,</span>
<span>                                              y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>, fun <span class="op">=</span> <span class="fu">geosphere</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/geosphere/man/distHaversine.html">distHaversine</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">0.00062137</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_i</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">distance_from_i</span> <span class="op">&lt;=</span> <span class="va">radius</span>, <span class="va">combined_loi</span> <span class="op">&lt;=</span> <span class="va">limit</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate combined LOI for close policies and determine if over limit</span></span>
<span>  <span class="va">combined_risk</span> <span class="op">=</span> <span class="va">data_close</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">combined_loi</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">large_risk_flag</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">combined_risk</span> <span class="op">&gt;</span> <span class="va">limit</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># return results</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">large_risk_flag</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data_close</span><span class="op">$</span><span class="va">policy_number</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="va">return</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># setup plan</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># find all large risks (within a 1/4 mile of each of the reference policy (first one in list))</span></span>
<span><span class="co"># -&gt; exclude policies with no lat/long</span></span>
<span><span class="va">data_groups</span> <span class="op">&lt;-</span> <span class="va">data_inforce</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">longitude</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="va">latitude</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://furrr.futureverse.org/reference/future_map.html">future_map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu">find_large_risks</span><span class="op">(</span><span class="va">i</span>, df <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">data_groups</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">data_groups</span>, <span class="va">is.null</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># save results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">data_groups</span>, file <span class="op">=</span> <span class="st">"data-groups.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data-groups.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># pull corresponding info from inforce data</span></span>
<span><span class="va">data_large_risks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="va">data_groups</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data_groups</span><span class="op">)</span>,</span>
<span>                         <span class="kw">function</span><span class="op">(</span><span class="va">policy_nums</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>                           <span class="va">data_inforce</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">policy_number</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">policy_nums</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">i</span>,</span>
<span>                                    group_loi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">combined_loi</span><span class="op">)</span>,</span>
<span>                                    .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>                         <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="va">bind_rows</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">group_loi</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># making assumption that all groups with same group_loi are actually the same group, just different reference policy</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># remove repeat records</span></span>
<span>    <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span>.keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="va">bind_rows</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">group_loi</span>, group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">cur_group_id</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output results</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_large_risks</span>, <span class="st">"large-risks-analysis.xlsx"</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load states shape file</span></span>
<span><span class="va">data_states</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">states</span><span class="op">(</span>cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu">st_transform</span><span class="op">(</span><span class="st">'+proj=longlat +datum=WGS84'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define function to set the color of the icon</span></span>
<span><span class="va">get_color_icon</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">reinsurance</span>, <span class="kw">function</span><span class="op">(</span><span class="va">reinsurance</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">reinsurance</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="st">"green"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="st">"black"</span></span>
<span>  <span class="op">}</span> <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define function to set the color of the marker</span></span>
<span><span class="va">get_color_marker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">group_loi</span>, <span class="kw">function</span><span class="op">(</span><span class="va">group_loi</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">group_loi</span> <span class="op">/</span> <span class="fl">1000000</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="st">"blue"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">group_loi</span> <span class="op">/</span> <span class="fl">1000000</span> <span class="op">&lt;=</span> <span class="fl">4</span><span class="op">)</span>  <span class="op">{</span></span>
<span>    <span class="st">"orange"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="st">"red"</span></span>
<span>  <span class="op">}</span> <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calculate reinsurance flag</span></span>
<span><span class="co"># -&gt; determine if named_insured is the same within groups</span></span>
<span><span class="va">data_large_risks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># check count of named insured and join calculation back onto original df</span></span>
<span>    <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">named_insured</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>reinsurance <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">named_insured</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">18</span>, <span class="fl">3</span><span class="op">)</span> <span class="co"># manually reorder </span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="va">bind_rows</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create icons</span></span>
<span><span class="va">icons</span> <span class="op">&lt;-</span> <span class="fu">awesomeIcons</span><span class="op">(</span></span>
<span>  icon <span class="op">=</span> <span class="st">"ios-close"</span>,</span>
<span>  iconColor <span class="op">=</span> <span class="fu">get_color_icon</span><span class="op">(</span><span class="va">data_large_risks</span><span class="op">)</span>,</span>
<span>  library <span class="op">=</span> <span class="st">"ion"</span>,</span>
<span>  markerColor <span class="op">=</span> <span class="fu">get_color_marker</span><span class="op">(</span><span class="va">data_large_risks</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create map</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">leaflet</span><span class="op">(</span><span class="va">data_states</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">setView</span><span class="op">(</span><span class="op">-</span><span class="fl">96</span>, <span class="fl">37.8</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addAwesomeMarkers</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_large_risks</span>,</span>
<span>                    lng <span class="op">=</span> <span class="op">~</span><span class="va">longitude</span>,</span>
<span>                    lat <span class="op">=</span> <span class="op">~</span><span class="va">latitude</span>,</span>
<span>                    icon <span class="op">=</span> <span class="va">icons</span>,</span>
<span>                    label<span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">combined_loi</span> <span class="op">/</span> <span class="fl">1000</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"K; "</span>, <span class="va">named_insured</span>, <span class="st">"; "</span>, <span class="va">policy_number</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># (actually a quarto chunk with the following options)</span></span>
<span></span>
<span><span class="co">##| column: screen-inset-right</span></span>
<span><span class="co">##| out-width: 100%</span></span>
<span><span class="co">##| out-height: 1000px</span></span>
<span></span>
<span><span class="co"># view plot</span></span>
<span><span class="co"># -&gt; in separate chunk so when rendered the progress bars don't show up</span></span>
<span><span class="va">m</span></span>
<span></span>
<span><span class="co"># **How to read plot**:</span></span>
<span></span>
<span><span class="co"># -&gt; Marker for every individual policy</span></span>
<span></span>
<span><span class="co"># -&gt; Hover over to display the combined LOI, named insured and policy number</span></span>
<span></span>
<span><span class="co"># -&gt; Markers are colored by aggregate LOI of nearby policies:</span></span>
<span></span>
<span><span class="co">#    - [$1.5M &lt;= Aggregate LOI &lt;= $2M]{style="color:blue;"}</span></span>
<span>    </span>
<span><span class="co">#    - [$2M &lt; Aggregate LOI &lt;= $4M]{style="color:orange;"}</span></span>
<span>    </span>
<span><span class="co">#    - [Aggregate LOI &gt; $4M]{style="color:red;"}</span></span>
<span></span>
<span><span class="co">#- &gt; [Green X]{style="color:green;"} on marker indicates that this is a policy that has matching named insured as other policies; so, there is potential for reinsurance</span></span>
<span></span>
<span><span class="co"># **How data was created**:</span></span>
<span></span>
<span><span class="co"># -&gt; For every policy in the inforce file as of 10/1/2024:</span></span>
<span></span>
<span><span class="co">#1) Calculate the distance to all other policies</span></span>
<span></span>
<span><span class="co">#2) Find policies within a 0.25 square-mile area circle around the reference policy location</span></span>
<span></span>
<span><span class="co">#3) For the nearby policies, calculate the aggregate LOI and flag if over $1.5M</span></span>
<span></span>
<span><span class="co"># get potential reinsurance policies</span></span>
<span><span class="va">data_reinsurance</span> <span class="op">&lt;-</span> <span class="va">data_large_risks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">reinsurance</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">policy_number</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"group"</span><span class="op">)</span>, <span class="va">reinsurance</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">named_insured</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output results</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_reinsurance</span>, <span class="st">"data-reinsurance.xlsx"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="long-tail-analyses" class="level3" data-number="3.1.6"><h3 data-number="3.1.6" class="anchored" data-anchor-id="long-tail-analyses">
<span class="header-section-number">3.1.6</span> Long tail analyses</h3>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages ---- </span></span>
<span></span>
<span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Read in data ---- </span></span>
<span></span>
<span><span class="co"># claims data</span></span>
<span><span class="va">data_claims_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"claims-commercial-detail.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">7</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">11</span>, <span class="fl">17</span><span class="op">:</span><span class="fl">18</span>, <span class="fl">31</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">policy_type</span> <span class="op">==</span> <span class="st">"BP"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_incurred <span class="op">=</span> <span class="va">incurred_loss</span> <span class="op">+</span> <span class="va">incurred_lae</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># policy life data</span></span>
<span><span class="co"># -&gt; some odd duplicate policy numbers, just removing them</span></span>
<span><span class="va">data_policy_life_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"policy-life-analysis.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">policy_number</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Modify data ---- </span></span>
<span></span>
<span><span class="co"># calculate new fields and attach policy life analysis data</span></span>
<span><span class="va">data_long_tail</span> <span class="op">&lt;-</span> <span class="va">data_claims_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date_lag <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">loss_date</span>, <span class="va">report_date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">claim</span>, <span class="va">policy</span>, <span class="va">state</span>, <span class="va">loss_date</span>, <span class="va">report_date</span>, <span class="va">business_description</span>, <span class="va">date_lag</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"incurred"</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>long_date_lag_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">date_lag</span> <span class="op">&gt;</span> <span class="fl">365</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span>,</span>
<span>         large_loss_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">total_incurred</span> <span class="op">&gt;</span> <span class="fl">100000</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_policy_life_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">policy_state</span>, <span class="va">policy_type</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy</span> <span class="op">==</span> <span class="va">policy_number</span><span class="op">)</span>, relationship <span class="op">=</span> <span class="st">"many-to-one"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output raw data to add to workbook so can build pivots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">data_long_tail</span>, <span class="st">"output/raw-data.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Load updated data ---- </span></span>
<span></span>
<span><span class="co"># load manually edited data</span></span>
<span><span class="co"># -&gt; David added missing hierarchy1 information, just uploading this</span></span>
<span><span class="co"># claims data</span></span>
<span><span class="va">data_long_tail</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"modified-edited-data.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Recreating business class analysis ---- </span></span>
<span></span>
<span><span class="co"># summarize by business description</span></span>
<span><span class="co"># -&gt; recreating David's pivot table with added requested features</span></span>
<span><span class="va">data_pivot</span> <span class="op">&lt;-</span> <span class="va">data_long_tail</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">business_description</span>,</span>
<span>            claim_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            total_incurred_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_incurred</span><span class="op">)</span>,</span>
<span>            total_incurred_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total_incurred</span><span class="op">)</span>,</span>
<span>            large_loss_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">large_loss_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>            date_lag_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">date_lag</span><span class="op">)</span>,</span>
<span>            date_lag_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">date_lag</span><span class="op">)</span>,</span>
<span>            long_date_lag_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">long_date_lag_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">date_lag_med</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">total_incurred_sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">long_date_lag_flag</span>, <span class="va">date_lag_avg</span>, <span class="va">date_lag_med</span>, .after <span class="op">=</span> <span class="va">claim_count</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">data_pivot</span>, <span class="st">"output/test.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Hierarchy analysis ---- </span></span>
<span></span>
<span><span class="co"># new analysis by different grouping variable</span></span>
<span><span class="co"># -&gt; what is the distribution of losses by hierarchy1</span></span>
<span><span class="va">data_pivot2</span> <span class="op">&lt;-</span> <span class="va">data_long_tail</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">hierarchy_1</span>,</span>
<span>            claim_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            total_incurred_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_incurred</span><span class="op">)</span>,</span>
<span>            total_incurred_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total_incurred</span><span class="op">)</span>,</span>
<span>            large_loss_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">large_loss_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>            date_lag_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">date_lag</span><span class="op">)</span>,</span>
<span>            date_lag_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">date_lag</span><span class="op">)</span>,</span>
<span>            <span class="co">#percent_long_date_flag = mean(long_date_lag_flag == "Y"),</span></span>
<span>            long_date_lag_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">long_date_lag_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">date_lag_med</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">total_incurred_avg</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">long_date_lag_flag</span>, <span class="va">date_lag_avg</span>, <span class="va">date_lag_med</span>, .after <span class="op">=</span> <span class="va">claim_count</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output and copy paste into workbook</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">data_pivot2</span>, <span class="st">"output/hierarchy-analysis.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Long tail losses analysis ---- </span></span>
<span></span>
<span><span class="co"># another analysis</span></span>
<span><span class="co"># -&gt; attempting to answer: of the long date lag losses, what is the breakdown by grouping variable?</span></span>
<span><span class="va">data_table</span> <span class="op">&lt;-</span> <span class="va">data_long_tail</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">long_date_lag_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">business_description</span>,</span>
<span>            n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            large_loss_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">large_loss_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>         <span class="co">#percent_large_loss_flag = large_loss_flag / n) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">percent</span>, .after <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">data_table</span>, <span class="st">"output/long-tail-losses1.csv"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">data_table2</span> <span class="op">&lt;-</span> <span class="va">data_long_tail</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">long_date_lag_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">hierarchy_1</span>,</span>
<span>            n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            large_loss_flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">large_loss_flag</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>         <span class="co">#percent_large_loss_flag = large_loss_flag / n) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">percent</span>, .after <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">data_table2</span>, <span class="st">"output/long-tail-losses2.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="policy-life-analysis" class="level3" data-number="3.1.7"><h3 data-number="3.1.7" class="anchored" data-anchor-id="policy-life-analysis">
<span class="header-section-number">3.1.7</span> Policy life analysis</h3>
<p><img src="files/policy-life-analysis.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Query data ----</span></span>
<span></span>
<span><span class="co"># Steps</span></span>
<span></span>
<span><span class="co"># 1. Run `policy-life-analysis.sql` query. (don't have code here...)</span></span>
<span></span>
<span><span class="co"># 2. Copy and paste all data into `policy-life-analysis.csv`.</span></span>
<span></span>
<span><span class="co">### ---- Load data ----</span></span>
<span></span>
<span><span class="co"># function to compare two objects</span></span>
<span><span class="co"># -&gt; using it to compare results of same thing from different methods</span></span>
<span><span class="co"># -&gt; works for all data types (numeric vectors, character / factor vectors, dataframes with same dimensions, lists of anything)</span></span>
<span><span class="co"># default options -&gt; return original items (for easy visual comparison in same output), tolerance in numeric comparison is 1 x 10^-5 (out to 5 decimals, 0.00001), check.names = FALSE to only check values and NOT the names of elements</span></span>
<span><span class="co"># return values -&gt; list of 1) summary of comparison, 2 and 3) original items if desired</span></span>
<span><span class="co"># -&gt; 1) includes logical of overall comparison and if NOT EQUAL description of differences + element-wise comparison of vectors or columns of dataframe</span></span>
<span><span class="va">compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">item_1</span>, <span class="va">item_2</span>, <span class="va">return_items</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">tolerance</span> <span class="op">=</span> <span class="fl">0.00001</span>, <span class="va">check.names</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># initialize a list with helpful names for the results and original items being compared</span></span>
<span>  <span class="co"># -&gt; the extra functions for the names just return the name / call of the original arguments passed to item_1 and item_2</span></span>
<span>  <span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"comparison"</span>, <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span><span class="op">(</span><span class="va">item_2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># check equality with all.equal()</span></span>
<span>  <span class="co"># -&gt; returns TRUE when TRUE and a character string describing the difference when FALSE</span></span>
<span>  <span class="co"># -&gt; allows for a tolerance in numeric comparisons, which is ideal to account for rounding</span></span>
<span>  <span class="co"># --&gt; AND includes option to ignore names (so just focus comparison on values of elements)</span></span>
<span>  <span class="va">comparison</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">item_1</span>, <span class="va">item_2</span>, tolerance <span class="op">=</span> <span class="va">tolerance</span>, check.names <span class="op">=</span> <span class="va">check.names</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># check class of item 1 (assuming item 2 is the same)</span></span>
<span>  <span class="co"># check if numeric </span></span>
<span>  </span>
<span>  <span class="co"># if equal (with tolerance), returns TRUE comparison</span></span>
<span>  <span class="co">#-&gt; by default, it is only looking at the values and NOT the names</span></span>
<span>  <span class="co"># -&gt; check by seeing if comparison is TRUE, if so return TRUE</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">comparison</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">comparison</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># if not equal, return a list with items describing comparison </span></span>
<span>  <span class="kw">else</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># fill results with elements for:</span></span>
<span>    <span class="co"># -&gt; overall comparison result = FALSE</span></span>
<span>    <span class="co"># -&gt; description of inequalities = output of all.equal when not TRUE</span></span>
<span>    <span class="co"># -&gt; conditionally return vector of element wise comparison (with names removed) based on class of items</span></span>
<span>    <span class="co"># --&gt; throws warning message when lengths differ, but still does comparison</span></span>
<span>    <span class="va">results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"result"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">comparison</span>, <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      <span class="st">"description"</span> <span class="op">=</span> <span class="va">comparison</span>,</span>
<span>      <span class="st">"element-wise"</span> <span class="op">=</span> </span>
<span>        </span>
<span>        <span class="co"># if numeric, compare items after rounding</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span>, <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          </span>
<span>          <span class="co"># calculate number of decimals to round to before element-wise comparison as a function of the tolerance, </span></span>
<span>          <span class="co"># -&gt; e.g) tolerance = 0.00001 --&gt; abs(log10(tolerance)) = 5</span></span>
<span>          <span class="co"># -&gt; ceiling() accounts for non base 10 tolerances so still have a whole number of digits for rounding</span></span>
<span>          <span class="va">decimals</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">tolerance</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span>, <span class="va">decimals</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">item_2</span><span class="op">)</span>, <span class="va">decimals</span><span class="op">)</span></span>
<span>          </span>
<span>          </span>
<span>        <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># first if character or factor, simply compare</span></span>
<span>      <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span>, <span class="st">"character"</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span>, <span class="st">"factor"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="co"># convert to character to take into account factors</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">item_2</span><span class="op">)</span></span>
<span>        </span>
<span>        </span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># if dataframe, correctly compare columns after checking column data type</span></span>
<span>      <span class="co"># different comparison to also capture tibbles</span></span>
<span>      <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"data.frame"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="co"># convert to dataframes so element-wise comparisons work as desired</span></span>
<span>        <span class="va">tmp_item_1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span></span>
<span>        <span class="va">tmp_item_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">item_2</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">decimals</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">tolerance</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">tmp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">tmp_item_1</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>          </span>
<span>          <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">tmp_item_1</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            </span>
<span>            <span class="co"># compare numerics after rounding</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">tmp_item_1</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="va">decimals</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">tmp_item_2</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="va">decimals</span><span class="op">)</span></span>
<span>            </span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            </span>
<span>            <span class="co"># compare factors or characters</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">tmp_item_1</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">tmp_item_2</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>            </span>
<span>          <span class="op">}</span></span>
<span>          </span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># give result names of first item</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">item_1</span><span class="op">)</span></span>
<span>        <span class="va">tmp</span></span>
<span>        </span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># if other data type, do not do element-wise comparison</span></span>
<span>      <span class="kw">else</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="cn">NULL</span></span>
<span>        </span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># add the original items being compared to the results for display</span></span>
<span>  <span class="va">results</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">item_1</span></span>
<span>  <span class="va">results</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">item_2</span></span>
<span>  </span>
<span>  <span class="co"># return results with conditional elements</span></span>
<span>  <span class="co"># return comparison and original items</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">return_items</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># just return the comparison by dropping original items</span></span>
<span>  <span class="kw">else</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># read and format data</span></span>
<span><span class="va">data_life_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"policy-life-analysis.csv"</span>,</span>
<span>                      col_types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cccccccccccc"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># preview data</span></span>
<span><span class="va">data_life_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">head</span></span>
<span></span>
<span><span class="co">### ---- Clean data and calculate variables ----</span></span>
<span></span>
<span><span class="co"># **NOTE: Currently backdated to match ending of reference triangles data**</span></span>
<span></span>
<span><span class="co"># clean data and calculate variables</span></span>
<span><span class="co"># -&gt; convert to dates</span></span>
<span><span class="co"># -&gt; calculate new variables</span></span>
<span><span class="co"># --&gt; determine active or inactive</span></span>
<span><span class="co"># --&gt; calculate time interval between now (or end / cancel date) and when policy started</span></span>
<span><span class="co"># --&gt; calculate time difference in different units</span></span>
<span><span class="co"># --&gt; make policy period</span></span>
<span><span class="co">#date_ref &lt;- ymd("2024-05-31")</span></span>
<span><span class="va">date_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data_life</span> <span class="op">&lt;-</span> <span class="va">data_life_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="va">mdy</span><span class="op">)</span>,</span>
<span>         active_policy <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">original_effective_date</span> <span class="op">&gt;</span> <span class="va">date_ref</span> <span class="op">~</span> <span class="st">"Future"</span>,</span>
<span>           <span class="va">term_expiration_date</span> <span class="op">&gt;=</span> <span class="va">date_ref</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cancellation_date</span><span class="op">)</span> <span class="op">|</span> <span class="va">cancellation_date</span> <span class="op">&gt;=</span> <span class="va">date_ref</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Yes"</span>,</span>
<span>           .default <span class="op">=</span> <span class="st">"No"</span></span>
<span>         <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># need rowwise() so can use min() looking across and not down</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time_interval <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">active_policy</span> <span class="op">==</span> <span class="st">"Future"</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>    <span class="va">active_policy</span> <span class="op">==</span> <span class="st">"Yes"</span> <span class="op">~</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">original_effective_date</span>, <span class="va">date_ref</span><span class="op">)</span>,</span>
<span>    .default <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">original_effective_date</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">term_expiration_date</span>, <span class="va">cancellation_date</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>life_of_policy_in_days <span class="op">=</span> <span class="va">time_interval</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         life_of_policy_in_months <span class="op">=</span> <span class="va">time_interval</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         life_of_policy_in_years <span class="op">=</span> <span class="va">time_interval</span> <span class="op">/</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         policy_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">original_effective_date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%02d"</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">original_effective_date</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># preview data</span></span>
<span><span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">head</span></span>
<span></span>
<span><span class="co">### ---- Clean data and calculate variables ----</span></span>
<span></span>
<span><span class="co"># Matches as best as possible :) to the reference survival pivot table (counts, cancels and percentages)</span></span>
<span></span>
<span><span class="co"># See !!! comments below</span></span>
<span></span>
<span><span class="co"># define function to calculate indicator variables for if the policy survived past threshold</span></span>
<span><span class="co"># -&gt; !!! pivot results take into account nonrenewals by doing the following:</span></span>
<span><span class="co"># --&gt; records 363 day indicator and a 12 month indicator (which could be different values); this is done for every cutoff period</span></span>
<span><span class="co"># -&gt; to replicate this, I have to use &gt; in the indicators comparison, not &gt;= (so need to survive past 12 months to be included in the 12 month indicator)</span></span>
<span><span class="co"># -&gt; NOTE that still there are probably unaccounted things and/or slightly different policy counts throw percentages off a tiny bit</span></span>
<span><span class="va">calc_indicators</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">col</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># setup holding dataframe for indicator variables</span></span>
<span>  <span class="va">indicators</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">12</span>, to <span class="op">=</span> <span class="fl">60</span>, by <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="va">data_survival</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">indicators</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data_survival</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">indicators</span>, <span class="st">"_months"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># loop over rows</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_survival</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># loop over columns</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">indicators</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="co"># assign indicator based on survival months and the cutoff</span></span>
<span>      <span class="va">data_survival</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">data_survival</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span>string <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data_survival</span><span class="op">[</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                                                 start <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                                                 end <span class="op">=</span> <span class="op">-</span><span class="fl">8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span><span class="op">)</span>,</span>
<span>                                   <span class="fl">1</span>,</span>
<span>                                   <span class="fl">0</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>    </span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">data_survival</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calculate survival triangle</span></span>
<span><span class="co"># -&gt; zeros are included in the survival percentages in the reference table</span></span>
<span><span class="co"># !!! the purpose of this is to confirm that I am calculating survival days / months correctly</span></span>
<span><span class="co"># -&gt; only had the % indicators to match up to, so had to work with this</span></span>
<span><span class="co"># -&gt; now am confident everything is being calculated correctly</span></span>
<span><span class="co"># -&gt; loss % indicators are just off because of the problem described in the calc_indicators function</span></span>
<span><span class="va">data_triangle</span> <span class="op">&lt;-</span> <span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">calc_indicators</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"life_of_policy_in_months"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_check</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># stage where can then calculate counts to compare to reference data, have to comment out filtering to non-zeros</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">policy_period</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"^\\d.*"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">policy_period</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">head</span></span>
<span></span>
<span><span class="co"># !!! if wanted to, could increase this analysis by taking into account renewals and separating out by business class</span></span>
<span></span>
<span><span class="co"># DATA QUALITY CHECKS</span></span>
<span></span>
<span><span class="co"># organized smaller dataset to check calculations from above</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="va">data_check</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">life_of_policy_in_months</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="va">time_interval</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"life"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"months"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compare counts and flat cancel rates to reference survival triangles</span></span>
<span><span class="co"># -&gt; also compare triangle percentages</span></span>
<span><span class="va">data_compare</span> <span class="op">&lt;-</span> <span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>zero_life <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">policy_period</span>, <span class="va">zero_life</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">zero_life</span>,</span>
<span>              values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>              names_prefix <span class="op">=</span> <span class="st">"zero_life_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="va">zero_life_No</span> <span class="op">+</span> <span class="va">zero_life_Yes</span>,</span>
<span>         zero_prop <span class="op">=</span> <span class="va">zero_life_Yes</span> <span class="op">/</span> <span class="va">total</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">zero_life_No</span>, <span class="va">zero_life_Yes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_triangle</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># confirm results from reference pivot</span></span>
<span><span class="co"># -&gt; copy and paste into comparison-check.xlsx</span></span>
<span><span class="co"># -&gt; work in this document now</span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">data_compare</span>, <span class="st">"comparison.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASSED CHECK!</span></span>
<span></span>
<span><span class="co">### ---- Average policy life analysis ----</span></span>
<span></span>
<span><span class="co"># DATA QUALITY NOTE: Had to change  `,` to `-` for restaurants in the raw data to have them grouped together</span></span>
<span></span>
<span><span class="co"># calculate average policy life excluding those with life less than or equal to 60 days (i.e. underwriting cancel and/or flat cancels (zero life))</span></span>
<span><span class="va">avg_policy_life</span> <span class="op">&lt;-</span> <span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">life_of_policy_in_years</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">as.numeric</span></span>
<span></span>
<span><span class="co"># create comparative boxplots (with means), ordered by number of policies</span></span>
<span><span class="co"># -&gt; add overall average line with annotation</span></span>
<span><span class="co"># -&gt; add policy count annotations</span></span>
<span><span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">hierarchy_1</span>,</span>
<span>         n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hierarchy_1 <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="va">hierarchy_1</span>, .x <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">life_of_policy_in_years</span>,</span>
<span>                   y <span class="op">=</span> <span class="va">hierarchy_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">life_of_policy_in_years</span>,</span>
<span>                   y <span class="op">=</span> <span class="va">hierarchy_1</span><span class="op">)</span>,</span>
<span>               fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>               geom <span class="op">=</span> <span class="st">"point"</span>,</span>
<span>               shape <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">avg_policy_life</span>,</span>
<span>             col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>,</span>
<span>           x <span class="op">=</span> <span class="va">avg_policy_life</span> <span class="op">+</span> <span class="fl">4</span>,</span>
<span>           y <span class="op">=</span> <span class="st">"Retail"</span>,</span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"overall avg = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">avg_policy_life</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">" years"</span><span class="op">)</span>,</span>
<span>           color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>                y <span class="op">=</span> <span class="va">hierarchy_1</span>,</span>
<span>                label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n</span>, <span class="st">" policies"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">hierarchy_1</span><span class="op">)</span>,</span>
<span>            hjust <span class="op">=</span> <span class="fl">2</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"darkorange1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>                y <span class="op">=</span> <span class="va">hierarchy_1</span>,</span>
<span>                label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n</span>, <span class="st">" active"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">hierarchy_1</span>, <span class="va">active_policy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">active_policy</span> <span class="op">==</span> <span class="st">"Yes"</span><span class="op">)</span>,</span>
<span>            hjust <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Policy life analysis"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Specs: includes expired and active policies; excludes policies with life &lt;= 60 days"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Life of policy in years"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Hierarchy 1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_life</span><span class="op">$</span><span class="va">life_of_policy_in_years</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create table summarizing average life of policy by business class (via proxy of hierarchy 1)</span></span>
<span><span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_life_non_uw_cancel</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">hierarchy_1</span>,</span>
<span>            mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">life_of_policy_in_years</span><span class="op">)</span>,</span>
<span>            sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">life_of_policy_in_years</span><span class="op">)</span>,</span>
<span>            n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">data_life_non_uw_cancel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">life_of_policy_in_years</span><span class="op">)</span>,</span>
<span>                sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">life_of_policy_in_years</span><span class="op">)</span>,</span>
<span>                n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>hierarchy_1 <span class="op">=</span> <span class="st">"Overall"</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Policy life analysis**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="st">"(in years)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_footnote.html">tab_footnote</a></span><span class="op">(</span><span class="st">"Specs: includes expired and active policies; excludes policies with life &lt;= 60 days"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>hierarchy_1 <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Hierarchy 1**"</span><span class="op">)</span>,</span>
<span>             mean <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Mean**"</span><span class="op">)</span>,</span>
<span>             sd <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Sd**"</span><span class="op">)</span>,</span>
<span>             n <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**n**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">gtExtras</span><span class="fu">::</span><span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_highlight_rows.html">gt_highlight_rows</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="va">mean</span> <span class="op">&lt;</span> <span class="va">avg_policy_life</span>,</span>
<span>                              fill <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                              font_weight <span class="op">=</span> <span class="st">"normal"</span>,</span>
<span>                              alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">gtExtras</span><span class="fu">::</span><span class="fu"><a href="https://jthomasmock.github.io/gtExtras/reference/gt_highlight_rows.html">gt_highlight_rows</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="va">mean</span> <span class="op">&gt;</span> <span class="va">avg_policy_life</span>,</span>
<span>                              fill <span class="op">=</span> <span class="st">"green"</span>,</span>
<span>                              font_weight <span class="op">=</span> <span class="st">"normal"</span>,</span>
<span>                              alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">n</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Underwriting (or other) cancel analysis ----</span></span>
<span></span>
<span><span class="co"># create table summarizing policies underwriting (or other) by business class (via proxy of hierarchy 1)</span></span>
<span><span class="va">data_life</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>uw_cancel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">life_of_policy_in_days</span> <span class="op">&lt;=</span> <span class="fl">60</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hierarchy_1</span>, <span class="va">uw_cancel</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">uw_cancel</span>,</span>
<span>              values_from <span class="op">=</span> <span class="va">n</span>,</span>
<span>              names_prefix <span class="op">=</span> <span class="st">"uw_cancel_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="va">uw_cancel_No</span> <span class="op">+</span> <span class="va">uw_cancel_Yes</span>,</span>
<span>         uw_cancel_prop <span class="op">=</span> <span class="va">uw_cancel_Yes</span> <span class="op">/</span> <span class="va">total</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">uw_cancel_No</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">uw_cancel_prop</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">uw_cancel_wide</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">uw_cancel_wide</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>hierarchy_1 <span class="op">=</span> <span class="st">"Overall"</span>,</span>
<span>                        uw_cancel_Yes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">uw_cancel_Yes</span><span class="op">)</span>,</span>
<span>                        total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span>,</span>
<span>                        uw_cancel_prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">uw_cancel_Yes</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Underwriting (or other) cancel analysis**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>hierarchy_1 <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Hierarchy 1**"</span><span class="op">)</span>,</span>
<span>             uw_cancel_Yes <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Cancelled policies**"</span><span class="op">)</span>,</span>
<span>             total <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Total policies**"</span><span class="op">)</span>,</span>
<span>             uw_cancel_prop <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Proportion**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>            locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                   rows <span class="op">=</span> <span class="va">hierarchy_1</span> <span class="op">==</span> <span class="st">"Overall"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_auto.html">fmt_auto</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="random-loss-analysis" class="level3" data-number="3.1.8"><h3 data-number="3.1.8" class="anchored" data-anchor-id="random-loss-analysis">
<span class="header-section-number">3.1.8</span> Random loss analysis</h3>
<p><img src="files/random-loss-analysis.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages and define functions ----</span></span>
<span></span>
<span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">`%!in%`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span><span class="op">(</span><span class="st">"%in%"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Read in data ----</span></span>
<span></span>
<span><span class="co"># policy and loss data</span></span>
<span><span class="va">data_premium_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"random-loss-analysis.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_loss_and_lae <span class="op">=</span> <span class="va">incurred_loss_lae</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>roof_type <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># claim data</span></span>
<span><span class="va">data_claims_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span><span class="st">"claims commercial detail.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>incurred_loss_and_lae <span class="op">=</span> <span class="va">incurred_loss</span> <span class="op">+</span> <span class="va">incurred_lae</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Roof type analysis ----</span></span>
<span></span>
<span><span class="co">### Clean premium data</span></span>
<span></span>
<span><span class="co"># data cleaning</span></span>
<span><span class="co"># NOTE: could have also read in roof_types.xlsx (a more organized version of it) and did a left join to get the corrected roof types</span></span>
<span><span class="va">data_premium</span> <span class="op">&lt;-</span> <span class="va">data_premium_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>roof_type <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">roof_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"Unknown"</span>, <span class="st">"Flat"</span>, <span class="st">"Gable"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Other"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Comp"</span>, <span class="st">"Comp Toll"</span>, <span class="st">"Composition"</span>,  <span class="st">"Comp Roll"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Asphalt Comp Roll"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"As"</span>, <span class="st">"Shingle"</span>, <span class="st">"Asphault Shingle"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Asphalt Shingle"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tar, Tar And Gravel"</span>, <span class="st">"T &amp; G"</span>, <span class="st">"T&amp;G"</span>, <span class="st">"Tar &amp; Gravel"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Tar and Gravel"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op">==</span> <span class="st">"Membrane"</span> <span class="op">~</span> <span class="st">"Plastic Membrane"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plastic Membrane"</span>, <span class="st">"Thermo Plastic"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Thermo-Plastic Membrane"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op">==</span> <span class="st">"Rubber Membrane"</span> <span class="op">~</span> <span class="st">"Rubber"</span>,</span>
<span>             <span class="va">roof_type</span> <span class="op">==</span> <span class="st">"Tile"</span> <span class="op">~</span> <span class="st">"Tile, Slate, Stone"</span>,</span>
<span>             .default <span class="op">=</span> <span class="va">roof_type</span></span>
<span>           <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># export slightly modified data (save as premium data in workbook)</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_premium</span>, <span class="st">"output/data-premium.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Modify claims data ----</span></span>
<span></span>
<span><span class="co"># find duplicate policy number - roof type combos</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">data_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">policy_number</span>, <span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add roof type to claim data</span></span>
<span><span class="va">data_claims</span> <span class="op">&lt;-</span> <span class="va">data_claims_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">policy_number</span>, <span class="va">roof_type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">policy_number</span> <span class="op">%!in%</span> <span class="va">x</span><span class="op">$</span><span class="va">policy_number</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy</span> <span class="op">==</span> <span class="va">policy_number</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># export slightly modified data (save as claim data in workbook)</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_claims</span>, <span class="st">"output/data-claims.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Summarize ----</span></span>
<span></span>
<span><span class="co"># summarize premium data by roof type</span></span>
<span><span class="va">data_pivot_premium</span> <span class="op">&lt;-</span> <span class="va">data_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">policy_number</span> <span class="op">!=</span> <span class="st">"XXXXXXXXX"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">roof_type</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">earned_premium</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>            policy_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">policy_count</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize claim data by roof type</span></span>
<span><span class="va">data_pivot_claims</span> <span class="op">&lt;-</span> <span class="va">data_claims</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">coverage</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BDA"</span>, <span class="st">"BPA"</span>, <span class="st">"BDH"</span>, <span class="st">"BPH"</span>, <span class="st">"BDW"</span>, <span class="st">"BPW"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">roof_type</span>,</span>
<span>            claim_count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="va">claim</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">incurred_loss_and_lae</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>            <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine tables</span></span>
<span><span class="va">data_pivot</span> <span class="op">&lt;-</span> <span class="va">data_pivot_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_pivot_claims</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>loss_ratio <span class="op">=</span> <span class="va">incurred_loss_and_lae</span> <span class="op">/</span> <span class="va">earned_premium</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># export slightly modified data (save as claim data in workbook)</span></span>
<span><span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span><span class="va">data_pivot</span>, <span class="st">"output/data-pivot.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Fancy output ----</span></span>
<span></span>
<span><span class="co"># summarize data by roof type</span></span>
<span><span class="co"># -&gt; note that the policy counts are slightly off between here and tableau because tableau isn't counting duplicate policy numbers (although the loss data is correct)</span></span>
<span><span class="co"># NOTE: recreating this with pivot -&gt; everything matches!</span></span>
<span><span class="va">data_premium</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">#filter(policy_number != "XXXXXXXXX") %&gt;% </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">roof_type</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">earned_premium</span>, <span class="va">claim_count</span>, <span class="va">incurred_loss_and_lae</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>            n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">n</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>loss_ratio <span class="op">=</span> <span class="va">incurred_loss_and_lae</span> <span class="op">/</span> <span class="va">earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">loss_ratio</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Inception-to-date roof type LRs"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>             <span class="co">#subtitle = "excluding Medford, OR loss") %&gt;% </span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>roof_type <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Roof type**"</span><span class="op">)</span>,</span>
<span>             n <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Policy count**"</span><span class="op">)</span>,</span>
<span>             earned_premium <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**EP**"</span><span class="op">)</span>,</span>
<span>             claim_count <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Claim count**"</span><span class="op">)</span>,</span>
<span>             incurred_loss_and_lae <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Incurred loss + LAE**"</span><span class="op">)</span>,</span>
<span>             loss_ratio <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**LR**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">earned_premium</span>, <span class="va">incurred_loss_and_lae</span><span class="op">)</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">loss_ratio</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Unknowns ---- </span></span>
<span></span>
<span><span class="co"># policy life data</span></span>
<span><span class="co"># -&gt; some odd duplicate policy numbers, just removing them</span></span>
<span><span class="va">data_policy_life_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"policy-life-analysis.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">policy_number</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># look into unknown roof types</span></span>
<span><span class="va">data_unknown</span> <span class="op">&lt;-</span> <span class="va">data_premium_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">roof_type</span><span class="op">)</span> <span class="op">|</span> <span class="va">roof_type</span> <span class="op">==</span> <span class="st">"Unknown"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>policy_prefix <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">policy_number</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_policy_life_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_number</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># quick output to email screenshot</span></span>
<span><span class="va">data_unknown</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">roof_type</span>, <span class="va">policy_prefix</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>count <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data-unknown-summarized.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output policy numbers to send to David</span></span>
<span><span class="va">data_unknown</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"output/unknown-roof-policy-numbers.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="restuarant-audits-analysis" class="level3" data-number="3.1.9"><h3 data-number="3.1.9" class="anchored" data-anchor-id="restuarant-audits-analysis">
<span class="header-section-number">3.1.9</span> Restuarant audits analysis</h3>
<p><img src="files/restaurant-audit-analysis.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages and define functions ---- </span></span>
<span></span>
<span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define functions</span></span>
<span><span class="va">`%!in%`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span><span class="op">(</span><span class="st">"%in%"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Read in and clean data ----</span></span>
<span></span>
<span><span class="co"># read in restaurant audit data</span></span>
<span><span class="co"># -&gt; recalculate calculated fields from spreadsheet</span></span>
<span><span class="va">data_audits_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"Audit Review Spreadsheet with DTB Analysis 2025 05 16.xlsx"</span>, sheet <span class="op">=</span> <span class="fl">1</span>, skip <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_audit <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">notes_short</span> <span class="op">%!in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Cancelled Pre Audit"</span>, <span class="st">"NR due to LQL sales"</span>, <span class="st">"NR pre audit"</span>, <span class="st">"NR Sales &gt; 6M"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_chg_in_sales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">audited_sales</span> <span class="op">/</span> <span class="va">current_sales</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>         increase_or_decrease <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>           <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Dec"</span>,</span>
<span>           <span class="va">pct_chg_in_sales</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"No change"</span>,</span>
<span>           <span class="va">pct_chg_in_sales</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Inc"</span>,</span>
<span>           .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>         audited_alcohol_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">audited_alcohol_sales</span> <span class="op">/</span> <span class="va">audited_sales</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>         pct_chg_in_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">revised_premium</span> <span class="op">/</span> <span class="va">current_premium</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read in inforce file</span></span>
<span><span class="va">data_inforce</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"InForce_20250602.xlsx"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2025-06-02"</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Calculate new variables ----</span></span>
<span></span>
<span><span class="co"># check ranges of variables</span></span>
<span><span class="va">data_audits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"pct_chg_in"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add retention information to audit data and create bins for variables of interest</span></span>
<span><span class="va">data_audits</span> <span class="op">&lt;-</span> <span class="va">data_audits_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_inforce</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">policy_number</span>, <span class="va">policy_effective_date</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">policy_number</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">policy_effective_date</span>, .after <span class="op">=</span> <span class="va">exp_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>renewed <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">policy_effective_date</span> <span class="op">&gt;=</span> <span class="va">exp_date</span> <span class="op">~</span> <span class="st">"Yes"</span>,</span>
<span>      <span class="va">policy_effective_date</span> <span class="op">&lt;</span> <span class="va">exp_date</span> <span class="op">~</span> <span class="st">"TBD"</span>,</span>
<span>      .default <span class="op">=</span> <span class="st">"No"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    pct_chg_in_sales_group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">audited_sales</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.8</span> <span class="op">~</span> <span class="st">"&lt;-80%"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.6</span> <span class="op">~</span> <span class="st">"[-80%,-60%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.4</span> <span class="op">~</span> <span class="st">"[-60%,-40%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span> <span class="op">~</span> <span class="st">"[-40%,-20%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"[-20%,0%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"0%"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">0.2</span> <span class="op">~</span> <span class="st">"(0%,20%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">==</span> <span class="fl">0.2</span> <span class="op">~</span> <span class="st">"20%"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">0.4</span> <span class="op">~</span> <span class="st">"(20%,40%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">0.6</span> <span class="op">~</span> <span class="st">"[40%,60%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">0.8</span> <span class="op">~</span> <span class="st">"[60%,80%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">1.0</span> <span class="op">~</span> <span class="st">"[80%,100%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&lt;</span> <span class="fl">2.0</span> <span class="op">~</span> <span class="st">"[100%,200%)"</span>,</span>
<span>      <span class="va">pct_chg_in_sales</span> <span class="op">&gt;=</span> <span class="fl">2.0</span> <span class="op">~</span> <span class="st">"&gt;=200%"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;-80%"</span>,<span class="st">"[-80%,-60%)"</span>,<span class="st">"[-60%,-40%)"</span>,<span class="st">"[-40%,-20%)"</span>,<span class="st">"[-20%,0%)"</span>,<span class="st">"0%"</span>,<span class="st">"(0%,20%)"</span>,<span class="st">"20%"</span>,<span class="st">"(20%,40%)"</span>,<span class="st">"[40%,60%)"</span>,<span class="st">"[60%,80%)"</span>,<span class="st">"[80%,100%)"</span>,<span class="st">"[100%,200%)"</span>,<span class="st">"&gt;=200%"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    pct_chg_in_premium_group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">revised_premium</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.8</span> <span class="op">~</span> <span class="st">"&lt;-80%"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.6</span> <span class="op">~</span> <span class="st">"[-80%,-60%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.4</span> <span class="op">~</span> <span class="st">"[-60%,-40%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span> <span class="op">~</span> <span class="st">"[-40%,-20%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"[-20%,0%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"0%"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">0.2</span> <span class="op">~</span> <span class="st">"(0%,20%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">0.4</span> <span class="op">~</span> <span class="st">"[20%,40%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">0.6</span> <span class="op">~</span> <span class="st">"[40%,60%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">0.8</span> <span class="op">~</span> <span class="st">"[60%,80%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">1.0</span> <span class="op">~</span> <span class="st">"[80%,100%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&lt;</span> <span class="fl">2.0</span> <span class="op">~</span> <span class="st">"[100%,200%)"</span>,</span>
<span>      <span class="va">pct_chg_in_premium</span> <span class="op">&gt;=</span> <span class="fl">2.0</span> <span class="op">~</span> <span class="st">"&gt;=200%"</span>,</span>
<span>      .default <span class="op">=</span> <span class="cn">NA</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;-80%"</span>,<span class="st">"[-80%,-60%)"</span>,<span class="st">"[-60%,-40%)"</span>,<span class="st">"[-40%,-20%)"</span>,<span class="st">"[-20%,0%)"</span>,<span class="st">"0%"</span>,<span class="st">"(0%,20%)"</span>,<span class="st">"[20%,40%)"</span>,<span class="st">"[40%,60%)"</span>,<span class="st">"[60%,80%)"</span>,<span class="st">"[80%,100%)"</span>,<span class="st">"[100%,200%)"</span>,<span class="st">"&gt;=200%"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">renewed</span>, .after <span class="op">=</span> <span class="va">policy_number</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">pct_chg_in_sales_group</span>, .after <span class="op">=</span> <span class="va">pct_chg_in_sales</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">pct_chg_in_premium_group</span>, .after <span class="op">=</span> <span class="va">pct_chg_in_premium</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">### ---- Analyze ----</span></span>
<span></span>
<span><span class="co"># create exhibit tables</span></span>
<span><span class="va">data_audits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">pct_chg_in_sales_group</span>, <span class="va">renewed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">renewed</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>No_percent <span class="op">=</span> <span class="va">No</span> <span class="op">/</span> <span class="op">(</span><span class="va">No</span> <span class="op">+</span> <span class="va">Yes</span> <span class="op">+</span> <span class="va">TBD</span><span class="op">)</span>,</span>
<span>         Yes_percent <span class="op">=</span> <span class="va">Yes</span> <span class="op">/</span> <span class="op">(</span><span class="va">No</span> <span class="op">+</span> <span class="va">Yes</span> <span class="op">+</span> <span class="va">TBD</span><span class="op">)</span>,</span>
<span>         TBD_percent <span class="op">=</span> <span class="va">TBD</span> <span class="op">/</span> <span class="op">(</span><span class="va">No</span> <span class="op">+</span> <span class="va">Yes</span> <span class="op">+</span> <span class="va">TBD</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pct_chg_in_sales_group</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"No"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"Yes"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"TBD"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_audits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">pct_chg_in_premium_group</span>, <span class="va">renewed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">renewed</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">rowwise</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>No_percent <span class="op">=</span> <span class="va">No</span> <span class="op">/</span> <span class="op">(</span><span class="va">No</span> <span class="op">+</span> <span class="va">Yes</span> <span class="op">+</span> <span class="va">TBD</span><span class="op">)</span>,</span>
<span>         Yes_percent <span class="op">=</span> <span class="va">Yes</span> <span class="op">/</span> <span class="op">(</span><span class="va">No</span> <span class="op">+</span> <span class="va">Yes</span> <span class="op">+</span> <span class="va">TBD</span><span class="op">)</span>,</span>
<span>         TBD_percent <span class="op">=</span> <span class="va">TBD</span> <span class="op">/</span> <span class="op">(</span><span class="va">No</span> <span class="op">+</span> <span class="va">Yes</span> <span class="op">+</span> <span class="va">TBD</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pct_chg_in_premium_group</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"No"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"Yes"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"TBD"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="indications" class="level3" data-number="3.1.10"><h3 data-number="3.1.10" class="anchored" data-anchor-id="indications">
<span class="header-section-number">3.1.10</span> Indications</h3>
<p><img src="files/indication.png" class="img-fluid"></p>
<p><img src="files/indication-2.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages and define functions ----</span></span>
<span></span>
<span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">`%!in%`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span><span class="op">(</span><span class="st">"%in%"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># function to format long data as triangle</span></span>
<span><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span><span class="co"># -&gt; n_periods = 28 --&gt; 7 years of data for triangle</span></span>
<span><span class="va">format_bases_as_triangle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_agg_age</span>, <span class="va">var</span>, <span class="va">ult_age</span> <span class="op">=</span> <span class="fl">63</span>, <span class="va">n_periods</span> <span class="op">=</span> <span class="fl">28</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">var</span> <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span> </span>
<span>  <span class="va">df_agg_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&lt;=</span> <span class="va">ult_age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">age</span>,</span>
<span>                values_from <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="st">"-Q"</span>, <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">accident_quarter</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">3</span>, to <span class="op">=</span> <span class="va">ult_age</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_periods</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to calculate development factors</span></span>
<span><span class="va">calculate_dev_factors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_agg_age</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">var</span> <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># reduce input data to only needed columns</span></span>
<span>  <span class="va">df_agg_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># setup output dataframe</span></span>
<span>  <span class="va">df_dev</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,                  </span>
<span>                  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_agg_age</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># taking ratios, so one row less</span></span>
<span>    <span class="va">data.frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_dev</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loss_year"</span>,<span class="st">"loss_qtr"</span>, <span class="st">"left"</span>, <span class="st">"right"</span>, <span class="st">"dev_factor"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate development factors</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># set constants</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># set ratio column indicators</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># calculate factor</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                         <span class="cn">NA</span>,</span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># remove unwanted comparisons and format ratio indicator</span></span>
<span>  <span class="va">df_dev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">left</span> <span class="op">&gt;</span> <span class="va">right</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">left</span>, <span class="st">":"</span>, <span class="va">right</span><span class="op">)</span>,</span>
<span>           .after <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_dev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to format loss development factors as triangle</span></span>
<span><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span><span class="co"># -&gt; n_periods = 27 --&gt; 7 years of data for triangle</span></span>
<span><span class="va">format_dev_factors_as_triangle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_dev</span>, <span class="va">ult_age</span> <span class="op">=</span> <span class="fl">63</span>, <span class="va">n_periods</span> <span class="op">=</span> <span class="fl">27</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">df_dev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">left</span> <span class="op">&lt;=</span> <span class="va">ult_age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">age_age</span>,</span>
<span>                values_from <span class="op">=</span> <span class="va">dev_factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="st">"-Q"</span>, <span class="va">loss_qtr</span><span class="op">)</span>,</span>
<span>           <span class="st">"Ult:{{ult_age}}"</span> <span class="op">:=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">accident_quarter</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">6</span>, to <span class="op">=</span> <span class="va">ult_age</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,<span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">3</span>, to <span class="op">=</span> <span class="va">ult_age</span><span class="op">-</span><span class="fl">3</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Ult:"</span>, <span class="va">ult_age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_periods</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to calculate weighted development factors</span></span>
<span><span class="va">calculate_weighted_dev_factors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_loss_tri</span>, <span class="va">selects</span>, <span class="va">ult_age</span> <span class="op">=</span> <span class="fl">63</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># setup output dataframe</span></span>
<span>  <span class="va">df_weights</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df_loss_tri</span><span class="op">)</span>,                  </span>
<span>                      nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">data.frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">6</span>, to <span class="op">=</span> <span class="va">ult_age</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,<span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">3</span>, to <span class="op">=</span> <span class="va">ult_age</span><span class="op">-</span><span class="fl">3</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Ult:"</span>, <span class="va">ult_age</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># set constants</span></span>
<span>  <span class="va">df_weights</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">8</span>, to <span class="op">=</span> <span class="fl">16</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="st">" pts wtd"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># calculated weighted development factors</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># set number of periods to look back (i.e. weight)</span></span>
<span>    <span class="va">weight</span> <span class="op">=</span> <span class="va">df_weights</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">1</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_locate.html">str_locate</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">" pts"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span></span>
<span>    </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="co"># figure out number of periods with data in triangle for the larger age</span></span>
<span>      <span class="va">data_count</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_loss_tri</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">df_loss_tri</span><span class="op">[</span>,<span class="va">j</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># calculate X-pts weighted ratio</span></span>
<span>      <span class="va">df_weights</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_loss_tri</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">data_count</span> <span class="op">-</span> <span class="va">weight</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">data_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">j</span>, <span class="va">j</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>col_j <span class="op">=</span> <span class="fl">2</span>, col_j_minus_1 <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">col_j_minus_1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">col_j</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># create dataframe of selects for each age:age</span></span>
<span>  <span class="co"># -&gt; need to organize so can correctly calculate in next step</span></span>
<span>  <span class="va">df_selects</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>age_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, selected <span class="op">=</span> <span class="va">selects</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">row_num</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate cumulative selects "backwards"</span></span>
<span>  <span class="va">selects_cumulative</span> <span class="op">=</span> <span class="va">df_selects</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">cumprod</span></span>
<span>  </span>
<span>  <span class="co"># append calculated factors and reorganize</span></span>
<span>  <span class="va">df_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span>selects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cumulative <span class="op">=</span> <span class="va">selects_cumulative</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_selects</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># combine dataframes</span></span>
<span>  <span class="va">df_weights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">df_selects</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_weights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to calculate ultimate incurred</span></span>
<span><span class="va">calculate_ultimate_incurred</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_agg</span>, <span class="va">df_selects</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># extract cumulative select factors</span></span>
<span>  <span class="va">cumlative_selects</span> <span class="op">=</span> <span class="va">df_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="st">"cumulative"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                 names_to <span class="op">=</span> <span class="st">"age_age"</span>,</span>
<span>                 values_to <span class="op">=</span> <span class="st">"cumulative_factor"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># reorganize summary table for appending cumulative selects</span></span>
<span>  <span class="va">df_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">loss_year</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># append cumulative selects, organize data, and calculate new column</span></span>
<span>  <span class="co"># -&gt; fill rest of values with NA</span></span>
<span>  <span class="va">df_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cumlative_selects</span><span class="op">$</span><span class="va">cumulative_factor</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">cumlative_selects</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">return</span></span>
<span>        </span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">factor</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="st">"-Q"</span>, <span class="va">loss_qtr</span><span class="op">)</span>,</span>
<span>           ult_incurred <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">*</span> <span class="va">factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">accident_quarter</span>, incurred <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, <span class="va">factor</span>, <span class="va">ult_incurred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># summarize data by fiscal year</span></span>
<span><span class="va">summarize_by_fiscal_year</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="fl">3</span>, factor <span class="op">=</span> <span class="fl">4</span>, var2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># standardize names</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="co"># drop most recent period, calculate rolling sum by fiscal year, calculate factor, and organize</span></span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>var1_cumulative <span class="op">=</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">var1</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 var2_cumulative <span class="op">=</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">var2</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">var1_cumulative</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">var2_cumulative</span> <span class="op">/</span> <span class="va">var1_cumulative</span><span class="op">)</span>,</span>
<span>                 quarter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">accident_quarter</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>          </span>
<span>        <span class="co"># get most recent quarter to work from</span></span>
<span>        <span class="va">ref_qtr</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">quarter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="va">as.numeric</span></span>
<span>        </span>
<span>        <span class="co"># keep only relevant periods</span></span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">quarter</span> <span class="op">==</span> <span class="va">ref_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>fiscal_year_ended <span class="op">=</span> <span class="va">accident_quarter</span>, <span class="va">var1_cumulative</span>, <span class="va">factor</span>, <span class="va">var2_cumulative</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="va">return</span></span>
<span>      </span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># set NAs to Countrywide values</span></span>
<span>  <span class="va">df_cw</span> <span class="op">=</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, <span class="va">factor</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># use Countrywide values if NA for state factors and organize data</span></span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span>, <span class="va">df_cw</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_cw</span>,</span>
<span>                    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span><span class="op">)</span>,</span>
<span>                    suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_st"</span>, <span class="st">"_cw"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">factor_st</span><span class="op">)</span>, <span class="va">factor_cw</span>, <span class="va">factor_st</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, <span class="va">var1_cumulative</span>, <span class="va">factor</span>, <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="op">}</span>,</span>
<span>      <span class="va">df_cw</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to calculate the final step of the trending (x is a vector of two fits)</span></span>
<span><span class="va">calculate_final_fit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function calculated weighted fits</span></span>
<span><span class="va">calculate_weighted_fits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_calendar</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># initialize needed items</span></span>
<span>  <span class="va">pts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">8</span>, to <span class="op">=</span> <span class="fl">24</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">j</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># loop through different weights (fits)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">pts</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># reassign full dataset</span></span>
<span>    <span class="va">df_temp</span> <span class="op">=</span> <span class="va">df_calendar</span></span>
<span>    </span>
<span>    <span class="co"># limit dataset and calculate fit</span></span>
<span>    <span class="va">df_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">24</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># skip periods where cumulative sum isn't full</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># set Xs</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">df_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_temp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># if no data, stop don't calculate anything</span></span>
<span>      </span>
<span>      <span class="va">fits</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">fits</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">" ~ i"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.formula</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">calculate_final_fit</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">j</span> <span class="op">=</span> <span class="va">j</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># reorganize</span></span>
<span>  <span class="va">fits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">fits</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">8</span>, to <span class="op">=</span> <span class="fl">24</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="st">" pt"</span><span class="op">)</span></span>
<span>  <span class="va">fits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to output indication summary table</span></span>
<span><span class="va">format_as_indication_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ind</span>, <span class="va">sel_state</span>, <span class="va">sel_data_ended</span>, <span class="va">sel_eval_date</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">data_ind</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">sel_state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>,<span class="va">current_level_earned_premium</span>, <span class="va">premium_trend_factors</span>, <span class="va">trended_current_level_earned_premium</span>, <span class="va">incurred_loss</span>, <span class="va">implied_incurred_age_to_ult</span>, <span class="va">ult_incurred_loss</span>, <span class="va">loss_trend_factors</span>, <span class="va">trended_ult_incurred_loss</span>, <span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="va">ay_weights</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"**"</span>, <span class="va">sel_state</span>, <span class="st">" indications**"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"**Calendar / accident year data ended "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">sel_data_ended</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, abbr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">" "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">sel_data_ended</span><span class="op">)</span>, <span class="st">", "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">sel_data_ended</span><span class="op">)</span>, <span class="st">" as of "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">sel_eval_date</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, abbr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">" "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">sel_eval_date</span><span class="op">)</span>, <span class="st">", "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">sel_eval_date</span><span class="op">)</span>, <span class="st">"**"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>fiscal_year_ended <span class="op">=</span> <span class="st">"Year ended"</span>,</span>
<span>               current_level_earned_premium <span class="op">=</span> <span class="st">"Current level earned premium"</span>,</span>
<span>               premium_trend_factors <span class="op">=</span> <span class="st">"Premium trend factors"</span>,</span>
<span>               trended_current_level_earned_premium <span class="op">=</span> <span class="st">"Trended current level earned poremium"</span>,</span>
<span>               incurred_loss <span class="op">=</span> <span class="st">"Non-cat incurred loss + LAE"</span>,</span>
<span>               implied_incurred_age_to_ult <span class="op">=</span> <span class="st">"Loss development factors"</span>,</span>
<span>               ult_incurred_loss <span class="op">=</span> <span class="st">"Ultimate non-cat incurred loss + LAE"</span>,</span>
<span>               loss_trend_factors <span class="op">=</span> <span class="st">"Loss trend factors"</span>,</span>
<span>               trended_ult_incurred_loss <span class="op">=</span> <span class="st">"Trended ultimate non-cat incurred loss + lae"</span>,</span>
<span>               trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="st">"Trended ultimate non-cat incurred parial loss + LAE ratio"</span>,</span>
<span>               ay_weights <span class="op">=</span> <span class="st">"Accident year weights"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">current_level_earned_premium</span>, <span class="va">trended_current_level_earned_premium</span>, <span class="va">incurred_loss</span>, <span class="va">ult_incurred_loss</span>, <span class="va">trended_ult_incurred_loss</span><span class="op">)</span>,</span>
<span>               decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">premium_trend_factors</span>, <span class="va">implied_incurred_age_to_ult</span>, <span class="va">loss_trend_factors</span><span class="op">)</span>,</span>
<span>               decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="va">ay_weights</span><span class="op">)</span>,</span>
<span>                decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to output indication calculations table</span></span>
<span><span class="va">format_as_indication_calculations</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ind3_long</span>, <span class="va">sel_state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">data_ind3_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">sel_state</span>,</span>
<span>           <span class="va">variable</span> <span class="op">%!in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">variable_display</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op">(</span>column_labels.hidden <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">variable_display</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span></span>
<span>      style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">variable_display</span>, <span class="va">value</span><span class="op">)</span>,</span>
<span>        rows <span class="op">=</span> <span class="va">variable_display</span> <span class="op">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span></span>
<span>      style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://gt.rstudio.com/reference/cell_fill.html">cell_fill</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"yellow"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="va">value</span>,</span>
<span>        rows <span class="op">=</span> <span class="va">variable_display</span> <span class="op">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to output supporting table of indication calculations</span></span>
<span><span class="va">format_as_indication_calculations_support</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ind3_long</span>, <span class="va">sel_state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">data_ind3_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">sel_state</span>,</span>
<span>           <span class="va">variable</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">variable_display</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op">(</span>column_labels.hidden <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">variable_display</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### ---- Raw data ----</span></span>
<span></span>
<span><span class="co"># read in data from access process</span></span>
<span></span>
<span><span class="co"># -&gt; premium data</span></span>
<span><span class="va">data_premium_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"PremiumData"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>qtr <span class="op">=</span> <span class="va">quarter</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; loss data</span></span>
<span><span class="va">data_loss_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"LossData"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"qtr"</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; reported frequency data</span></span>
<span><span class="va">data_rept_freq_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ReptFreqData"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"qtr"</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; closed by closed evaluation data</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span>  <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ClsdByClsdEvalDt"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eval_qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; closed by evaluation data</span></span>
<span><span class="va">data_clsd_by_eval_date_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ClsdByEvalDt"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eval_qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; RMS modeled loss</span></span>
<span><span class="va">data_rms_modeled_loss</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"RMSModLoss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; TS modeled loss</span></span>
<span><span class="va">data_ts_modeled_loss</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"TSModLoss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># single out vectors</span></span>
<span><span class="va">vec_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_premium_raw</span><span class="op">$</span><span class="va">state</span><span class="op">)</span> <span class="co"># use premium data to capture all states</span></span>
<span><span class="va">vec_loss_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">loss_year</span><span class="op">)</span></span>
<span><span class="va">vec_loss_qtrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">loss_qtr</span><span class="op">)</span></span>
<span><span class="va">vec_eval_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">eval_year</span><span class="op">)</span></span>
<span><span class="va">vec_eval_qtrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">eval_qtr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create dataset of all possible combos, then add the needed combos for the most recent year</span></span>
<span><span class="co"># -&gt; this is so that later in the process, data has rows of zero rather than no row if no losses were in that particular period</span></span>
<span><span class="va">data_all_combos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">vec_states</span>, <span class="va">vec_loss_years</span>, <span class="va">vec_loss_qtrs</span>, <span class="va">vec_eval_years</span>, <span class="va">vec_eval_qtrs</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data_all_combos</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"loss_year"</span>, <span class="st">"loss_qtr"</span>, <span class="st">"eval_year"</span>, <span class="st">"eval_qtr"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># keep only valid periods</span></span>
<span><span class="co"># -&gt; set current eval quarter</span></span>
<span><span class="va">cur_eval_qtr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">loss_year</span> <span class="op">&lt;=</span> <span class="va">eval_year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>keep <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">loss_year</span> <span class="op">==</span> <span class="va">eval_year</span> <span class="op">&amp;</span> <span class="va">loss_qtr</span> <span class="op">&gt;</span> <span class="va">eval_qtr</span> <span class="op">~</span> <span class="fl">0</span>, <span class="co"># illogical periods</span></span>
<span>             <span class="va">loss_year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">loss_year</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">loss_qtr</span> <span class="op">&gt;</span> <span class="va">cur_eval_qtr</span> <span class="op">~</span> <span class="fl">0</span>, <span class="co"># future periods</span></span>
<span>             <span class="va">eval_year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">eval_year</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">eval_qtr</span> <span class="op">&gt;</span> <span class="va">cur_eval_qtr</span> <span class="op">~</span> <span class="fl">0</span>, <span class="co"># future periods</span></span>
<span>             .default <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">keep</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">keep</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Premium data</span></span>
<span></span>
<span><span class="co"># add placeholder rows to premium data</span></span>
<span><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span><span class="va">data_premium_agg</span> <span class="op">&lt;-</span> <span class="va">data_premium_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span>, <span class="va">qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Loss data</span></span>
<span></span>
<span><span class="co"># add placeholder rows to loss data</span></span>
<span><span class="va">data_loss_raw2</span> <span class="op">&lt;-</span> <span class="va">data_loss_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create age variable</span></span>
<span><span class="va">data_loss</span> <span class="op">&lt;-</span> <span class="va">data_loss_raw2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="op">(</span><span class="va">eval_year</span> <span class="op">-</span> <span class="va">loss_year</span><span class="op">)</span> <span class="op">*</span> <span class="fl">12</span> <span class="op">+</span> <span class="op">(</span><span class="va">eval_qtr</span> <span class="op">-</span> <span class="va">loss_qtr</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">3</span>, <span class="co"># evaluating in same quarter as loss counts as 3 months of development</span></span>
<span>         paid_loss_plus_lae <span class="op">=</span> <span class="va">paid_loss</span> <span class="op">+</span> <span class="va">paid_lae</span> <span class="op">+</span> <span class="op">-</span><span class="va">subrogation_salvage</span>,</span>
<span>         incurred_loss <span class="op">=</span> <span class="va">paid_loss_plus_lae</span> <span class="op">+</span> <span class="va">case_reserve</span> <span class="op">+</span> <span class="va">expense_reserve</span>,</span>
<span>         incurred_claim_count <span class="op">=</span> <span class="va">cwp_count</span> <span class="op">+</span> <span class="va">open_count</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co"># create summarized loss data by state and overall (cw)</span></span>
<span><span class="va">data_loss_agg_age_cw</span> <span class="op">&lt;-</span> <span class="va">data_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">age</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paid_loss_plus_lae</span>, <span class="va">incurred_loss</span>, <span class="va">incurred_claim_count</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_loss_agg_age_st</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">age</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paid_loss_plus_lae</span>, <span class="va">incurred_loss</span>, <span class="va">incurred_claim_count</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assumption of number of months to ultimate loss</span></span>
<span><span class="va">ult_age</span> <span class="op">&lt;-</span> <span class="fl">63</span></span>
<span></span>
<span><span class="co">### Reported frequency data</span></span>
<span></span>
<span><span class="co"># add placeholder rows to loss data</span></span>
<span><span class="va">data_rept_freq_raw2</span> <span class="op">&lt;-</span> <span class="va">data_rept_freq_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">rept_qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span>, <span class="va">rept_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Closed by closed evaluation date</span></span>
<span></span>
<span><span class="co"># add placeholder rows to premium data</span></span>
<span><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_clsd_eval_date_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">eval_qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Closed by evaluation date</span></span>
<span></span>
<span><span class="co"># add placeholder rows to premium data</span></span>
<span><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span><span class="va">data_clsd_by_eval_date_agg</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_eval_date_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">eval_qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Premium trend ----</span></span>
<span></span>
<span><span class="co"># create summarized premium data overall (cw) and then combine</span></span>
<span><span class="va">data_premium_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_premium_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize all columns by calendar year</span></span>
<span><span class="va">data_premium_trend_calendar</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span>, <span class="va">qtr</span>, <span class="va">on_level_earned_premium</span>, <span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">27</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>calendar_quarter_ended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>,<span class="st">"-Q"</span>, <span class="va">qtr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">on_level_earned_premium</span>, <span class="va">earned_exposure</span><span class="op">)</span>, \<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">col</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               average_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">earned_exposure</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">on_level_earned_premium</span> <span class="op">/</span> <span class="va">earned_exposure</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate weighted fits</span></span>
<span><span class="va">data_prem_trend_fits</span> <span class="op">&lt;-</span> <span class="va">data_premium_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"average_premium"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"average_premium"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate Countrywide selections</span></span>
<span><span class="va">data_premium_trend_selected_cw</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">0.035</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">1084</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         selected <span class="op">=</span> <span class="fl">0.075</span>,</span>
<span>         credibility_comp <span class="op">=</span> <span class="fl">0.016</span>,</span>
<span>         z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate state selections and add back in Countrywide</span></span>
<span><span class="va">data_premium_trend_selected</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>,</span>
<span>            credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">0.035</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">1084</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>         credibility_comp <span class="op">=</span> <span class="va">data_premium_trend_selected_cw</span><span class="op">$</span><span class="va">z_wtd_selected</span>,</span>
<span>         z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_premium_trend_selected_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Current level earned premium ----</span></span>
<span></span>
<span><span class="co"># calculate current level factor</span></span>
<span><span class="va">data_premium_current_level</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-Q"</span>, <span class="va">qtr</span><span class="op">)</span>,</span>
<span>         current_level_factor <span class="op">=</span> <span class="va">earned_premium</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">on_level_earned_premium</span> <span class="op">/</span> <span class="va">earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">accident_quarter</span>, <span class="va">earned_premium</span>, <span class="va">current_level_factor</span>, <span class="va">on_level_earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">21</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="co"># 5 years of data + 1 quarter</span></span>
<span></span>
<span><span class="co"># summarize data by fiscal year</span></span>
<span><span class="va">data_premium_current_level_fiscal</span> <span class="op">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span><span class="op">(</span>df <span class="op">=</span> <span class="va">data_premium_current_level</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>earned_premium <span class="op">=</span> <span class="va">var1_cumulative</span>, current_level_factor <span class="op">=</span> <span class="va">factor</span>, current_level_earned_premium <span class="op">=</span> <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Paid loss ----</span></span>
<span></span>
<span><span class="co">### Loss triangle</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_paid_loss_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_bases_as_triangle</span><span class="op">(</span>df_agg_age <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"paid_loss_plus_lae"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output triangle</span></span>
<span><span class="va">data_paid_loss_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Non-catastrophe paid loss + LAE**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Evaluation months"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="st">"Accident\nQuarter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Development factors</span></span>
<span></span>
<span><span class="co"># calculate development factors</span></span>
<span><span class="va">data_paid_loss_dev</span> <span class="op">&lt;-</span> <span class="fu">calculate_dev_factors</span><span class="op">(</span>df_agg_age <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"paid_loss_plus_lae"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_paid_loss_dev_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span><span class="op">(</span>df_dev <span class="op">=</span> <span class="va">data_paid_loss_dev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output triangle</span></span>
<span><span class="va">data_paid_loss_dev_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Development factors**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Age : Age"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="st">"Accident\nQuarter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Selections</span></span>
<span></span>
<span><span class="co"># hardcoding selections</span></span>
<span><span class="va">selects_paid_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.000</span>,<span class="fl">1.230</span>,<span class="fl">1.200</span>,<span class="fl">1.180</span>,<span class="fl">1.030</span>,<span class="fl">1.040</span>,<span class="fl">1.060</span>,<span class="fl">1.025</span>,<span class="fl">1.050</span>,<span class="fl">1.040</span>,<span class="fl">1.025</span>,<span class="fl">1.050</span>,<span class="fl">1.080</span>,<span class="fl">1.050</span>,<span class="fl">1.040</span>,<span class="fl">1.010</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.040</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># weighted development factors</span></span>
<span><span class="va">data_paid_loss_selects</span> <span class="op">&lt;-</span> <span class="fu">calculate_weighted_dev_factors</span><span class="op">(</span>df_loss_tri <span class="op">=</span> <span class="va">data_paid_loss_triangle</span>, selects <span class="op">=</span> <span class="va">selects_paid_loss</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output table</span></span>
<span><span class="va">data_paid_loss_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**X-weighted development factors**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Age : Age"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Weight"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Incurred loss ----</span></span>
<span></span>
<span><span class="co">### Loss triangle</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_loss_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_bases_as_triangle</span><span class="op">(</span>df_agg_age <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output triangle</span></span>
<span><span class="va">data_incurred_loss_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Non-catastrophe incurred loss + LAE**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Evaluation months"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="st">"Accident\nQuarter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Development factors</span></span>
<span></span>
<span><span class="co"># calculate development factors</span></span>
<span><span class="va">data_incurred_loss_dev</span> <span class="op">&lt;-</span> <span class="fu">calculate_dev_factors</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_loss_dev_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span><span class="op">(</span>df_dev <span class="op">=</span> <span class="va">data_incurred_loss_dev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output triangle</span></span>
<span><span class="va">data_incurred_loss_dev_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Development factors**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Age : Age"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="st">"Accident\nQuarter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Selections</span></span>
<span></span>
<span><span class="co"># hardcoding selections</span></span>
<span><span class="va">selects_incurred_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.230</span>,<span class="fl">1.050</span>,<span class="fl">1.020</span>,<span class="fl">1.030</span>,<span class="fl">1.000</span>,<span class="fl">1.020</span>,<span class="fl">1.020</span>,<span class="fl">1.020</span>,<span class="fl">1.050</span>,<span class="fl">1.080</span>,<span class="fl">1.030</span>,<span class="fl">1.080</span>,<span class="fl">1.080</span>,<span class="fl">1.030</span>,<span class="fl">1.020</span>,<span class="fl">1.010</span>,<span class="fl">1.010</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># weighted development factors</span></span>
<span><span class="va">data_incurred_loss_selects</span> <span class="op">&lt;-</span> <span class="fu">calculate_weighted_dev_factors</span><span class="op">(</span>df_loss_tri <span class="op">=</span> <span class="va">data_incurred_loss_triangle</span> ,selects <span class="op">=</span> <span class="va">selects_incurred_loss</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output table</span></span>
<span><span class="va">data_incurred_loss_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**X-weighted development factors**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Age : Age"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Weight"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Incurred claim count ----</span></span>
<span></span>
<span><span class="co">### Claim count triangle</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_claim_count_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_bases_as_triangle</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output triangle</span></span>
<span><span class="va">data_incurred_claim_count_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Non-catastrophe incurred claim count**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Evaluation months"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="st">"Accident\nQuarter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Development factors</span></span>
<span></span>
<span><span class="co"># calculate development factors</span></span>
<span><span class="va">data_incurred_claim_count_dev</span> <span class="op">&lt;-</span> <span class="fu">calculate_dev_factors</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_claim_count_dev_triangle</span> <span class="op">&lt;-</span>  <span class="fu">format_dev_factors_as_triangle</span><span class="op">(</span>df_dev <span class="op">=</span> <span class="va">data_incurred_claim_count_dev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output triangle</span></span>
<span><span class="va">data_incurred_claim_count_dev_triangle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**Development factors**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Age : Age"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="st">"Accident\nQuarter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Selections</span></span>
<span></span>
<span><span class="co"># hardcoding selections</span></span>
<span><span class="va">selects_incurred_claim_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.015</span>,<span class="fl">1.000</span>,<span class="fl">0.990</span>,<span class="fl">1.000</span>,<span class="fl">0.990</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.000</span>, <span class="fl">16</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># weighted development factors</span></span>
<span><span class="va">data_incurred_claim_count_selects</span> <span class="op">&lt;-</span> <span class="fu">calculate_weighted_dev_factors</span><span class="op">(</span>df_loss_tri <span class="op">=</span> <span class="va">data_incurred_claim_count_triangle</span>, selects <span class="op">=</span> <span class="va">selects_incurred_claim_count</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output table</span></span>
<span><span class="va">data_incurred_claim_count_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**X-weighted development factors**"</span><span class="op">)</span>,</span>
<span>             subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_spanner.html">tab_spanner</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Age : Age"</span>,</span>
<span>              columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"Weight"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/sub_missing.html">sub_missing</a></span><span class="op">(</span>missing_text <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Ultimate ----</span></span>
<span></span>
<span><span class="co">### Summarize data</span></span>
<span></span>
<span><span class="co"># create summarized loss data (accident quarter) by state, then overall (cw), and then combine</span></span>
<span><span class="va">data_loss_agg</span> <span class="op">&lt;-</span> <span class="va">data_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">eval_year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">eval_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># only use rows in most recent evaluation period</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">eval_qtr</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># -&gt; this makes it accident quarter</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred"</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span></span>
<span><span class="va">data_loss_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_loss_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred"</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_loss_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_loss_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Loss</span></span>
<span></span>
<span><span class="co"># append age to ultimate factors and calculate ultimate losses </span></span>
<span><span class="va">data_ult_loss</span> <span class="op">&lt;-</span> <span class="fu">calculate_ultimate_incurred</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg</span>, df_selects <span class="op">=</span> <span class="va">data_incurred_loss_selects</span>, var <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_loss <span class="op">=</span> <span class="va">incurred</span>, incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_loss <span class="op">=</span> <span class="va">ult_incurred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize data by fiscal year</span></span>
<span><span class="va">data_ult_loss_fiscal</span> <span class="op">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span><span class="op">(</span>df <span class="op">=</span> <span class="va">data_ult_loss</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_loss <span class="op">=</span> <span class="va">var1_cumulative</span>, implied_incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_loss <span class="op">=</span> <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Claim count</span></span>
<span></span>
<span><span class="co"># append age to ultimate factors and calculate ultimate claim count</span></span>
<span><span class="va">data_ult_claim_count</span> <span class="op">&lt;-</span> <span class="fu">calculate_ultimate_incurred</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg</span>, df_selects <span class="op">=</span> <span class="va">data_incurred_claim_count_selects</span>, var <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_claim_count <span class="op">=</span> <span class="va">incurred</span>, implied_incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_claim_count <span class="op">=</span> <span class="va">ult_incurred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize data by fiscal year</span></span>
<span><span class="va">data_ult_claim_count_fiscal</span> <span class="op">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span><span class="op">(</span>df <span class="op">=</span> <span class="va">data_ult_claim_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_claim_count <span class="op">=</span> <span class="va">var1_cumulative</span>, implied_incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_claim_count <span class="op">=</span> <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Frequency trend ----</span></span>
<span></span>
<span><span class="co"># create summarized loss data (calendar quarter) by state, then overall (cw), and then combine</span></span>
<span><span class="co"># -&gt; data is already only using the most recent evaluation period</span></span>
<span><span class="va">data_rept_freq_agg</span> <span class="op">&lt;-</span> <span class="va">data_rept_freq_raw2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span>, <span class="va">rept_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>reported_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reported_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span></span>
<span><span class="va">data_rept_freq_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_rept_freq_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">rept_year</span>, <span class="va">rept_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>reported_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reported_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_rept_freq_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_rept_freq_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create summarized closed by closed evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_clsd_by_clsd_eval_date_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize all columns by calendar year</span></span>
<span><span class="va">data_freq_trend_calendar</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span>, <span class="va">qtr</span>, <span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_rept_freq_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span>, <span class="va">rept_qtr</span>, <span class="va">reported_count</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span> <span class="op">==</span> <span class="va">rept_year</span>, <span class="va">qtr</span> <span class="op">==</span> <span class="va">rept_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span>, <span class="va">closed_w_pay_count</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span> <span class="op">==</span> <span class="va">eval_year</span>, <span class="va">qtr</span> <span class="op">==</span> <span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">27</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_freq_trend_agg</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>calendar_quarter_ended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-Q"</span>, <span class="va">qtr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">earned_exposure</span>, <span class="va">reported_count</span>, <span class="va">closed_w_pay_count</span><span class="op">)</span>, \<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">col</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               reported_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">earned_exposure</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">reported_count</span> <span class="op">/</span> <span class="va">earned_exposure</span><span class="op">)</span>,</span>
<span>               closed_w_pay_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">earned_exposure</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">closed_w_pay_count</span> <span class="op">/</span> <span class="va">earned_exposure</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, <span class="va">earned_exposure</span>, <span class="va">reported_count</span>, <span class="va">reported_freq</span>, <span class="va">closed_w_pay_count</span>, <span class="va">closed_w_pay_freq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span><span class="co"># -&gt; reported frequency</span></span>
<span><span class="va">data_freq_trend_fits_a</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"reported_freq"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"reported_freq"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; closed with pay frequency</span></span>
<span><span class="va">data_freq_trend_fits_b</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"closed_w_pay_freq"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"closed_w_pay_freq"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; combine</span></span>
<span><span class="va">data_freq_trend_fits</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_fits_a</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_freq_trend_fits_b</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate Countrywide selections</span></span>
<span><span class="va">data_freq_trend_selected_cw</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         selected <span class="op">=</span> <span class="fl">0.04</span>,</span>
<span>         credibility_comp <span class="op">=</span> <span class="fl">0</span>,</span>
<span>         z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate state selections and add back in Countrywide</span></span>
<span><span class="va">data_freq_trend_selected</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>,</span>
<span>            credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="fl">0.04</span>,</span>
<span>         credibility_comp <span class="op">=</span> <span class="va">data_freq_trend_selected_cw</span><span class="op">$</span><span class="va">z_wtd_selected</span>,</span>
<span>         z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_freq_trend_selected_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Severity trend ----</span></span>
<span></span>
<span><span class="co"># create summarized closed by evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span><span class="va">data_clsd_by_eval_date_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_clsd_by_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_clsd_by_eval_date_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize all columns by calendar year</span></span>
<span><span class="va">data_sev_trend_calendar</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span>, <span class="va">closed_w_pay_count</span>, <span class="va">total_paid_loss_lae_net_of_s_s</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_clsd_by_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span>, <span class="va">total_paid_loss_lae_net_of_s_s</span>, <span class="va">post_closure_total_paid_loss_lae_net_of_s_s</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_clsdbyclsd"</span>, <span class="st">"_clsd"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>paid_loss <span class="op">=</span> <span class="va">total_paid_loss_lae_net_of_s_s_clsd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>paid_on_closed_loss <span class="op">=</span> <span class="va">total_paid_loss_lae_net_of_s_s_clsdbyclsd</span> <span class="op">+</span> <span class="va">post_closure_total_paid_loss_lae_net_of_s_s</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">post_closure_total_paid_loss_lae_net_of_s_s</span>, <span class="va">total_paid_loss_lae_net_of_s_s_clsdbyclsd</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">27</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_sev_trend_agg</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>calendar_quarter_ended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">eval_year</span>, <span class="st">"-Q"</span>, <span class="va">eval_qtr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span>, <span class="va">paid_loss</span>, <span class="va">paid_on_closed_loss</span><span class="op">)</span>, \<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">col</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               paid_sev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">paid_loss</span> <span class="op">/</span> <span class="va">closed_w_pay_count</span><span class="op">)</span>,</span>
<span>               paid_on_closed_sev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">paid_on_closed_loss</span> <span class="op">/</span> <span class="va">closed_w_pay_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, <span class="va">closed_w_pay_count</span>, <span class="va">paid_loss</span>, <span class="va">paid_sev</span>, <span class="va">paid_on_closed_loss</span>, <span class="va">paid_on_closed_sev</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span><span class="co"># -&gt; paid severity</span></span>
<span><span class="va">data_sev_trend_fits_a</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"paid_sev"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"paid_sev"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; paid on closed severity</span></span>
<span><span class="va">data_sev_trend_fits_b</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"paid_on_closed_sev"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"paid_on_closed_sev"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; combine</span></span>
<span><span class="va">data_sev_trend_fits</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_fits_a</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_sev_trend_fits_b</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate Countrywide selections</span></span>
<span><span class="va">data_sev_trend_selected_cw</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         selected <span class="op">=</span> <span class="fl">0.14</span>,</span>
<span>         credibility_comp <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>         z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate state selections and add back in Countrywide</span></span>
<span><span class="va">data_sev_trend_selected</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>,</span>
<span>            credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="fl">0.14</span>,</span>
<span>         credibility_comp <span class="op">=</span> <span class="va">data_sev_trend_selected_cw</span><span class="op">$</span><span class="va">z_wtd_selected</span>,</span>
<span>         z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_sev_trend_selected_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Indication ----</span></span>
<span></span>
<span><span class="co">### Calculations</span></span>
<span></span>
<span><span class="co"># initialize needed items</span></span>
<span><span class="va">selection_state</span> <span class="op">&lt;-</span> <span class="st">"California"</span></span>
<span><span class="va">selection_data_ended</span> <span class="op">&lt;-</span> <span class="st">"2024-06-30"</span></span>
<span><span class="va">selection_effective_date</span> <span class="op">&lt;-</span> <span class="st">"2025-02-04"</span></span>
<span><span class="va">selection_lcm</span> <span class="op">&lt;-</span> <span class="fl">1.669</span></span>
<span><span class="va">selection_underlying_plr</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">selection_lcm</span></span>
<span><span class="va">selection_ay_weights</span> <span class="op">&lt;-</span> <span class="va">data_ult_loss_fiscal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ay_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0.15</span>,<span class="fl">0.40</span>,<span class="fl">0.45</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">selection_ay_weights_cw</span> <span class="op">&lt;-</span> <span class="va">data_ult_loss_fiscal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ay_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.10</span>,<span class="fl">0.15</span>,<span class="fl">0.20</span>,<span class="fl">0.25</span>,<span class="fl">0.30</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; shiny quark, can't use assign pipe</span></span>
<span><span class="va">selection_ay_weights2</span> <span class="op">&lt;-</span> <span class="va">selection_ay_weights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">selection_ay_weights_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate indication table</span></span>
<span><span class="va">data_indication</span> <span class="op">&lt;-</span> <span class="va">data_premium_current_level_fiscal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span>, <span class="va">current_level_earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trend_time_premium <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">12</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">24</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">36</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="fl">48</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="fl">60</span></span>
<span>           <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_premium_trend_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, prem_trend_z_wtd_selected <span class="op">=</span> <span class="va">z_wtd_selected</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>premium_trend_factors <span class="op">=</span> <span class="va">prem_trend_z_wtd_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="co"># raise_to_power(interval(ymd(selection_data_ended) %m-% years(5),</span></span>
<span>           <span class="co">#                         ymd(selection_effective_date) %m+% months(6)) %&gt;% </span></span>
<span>           <span class="co">#                  divide_by(years(1))) %&gt;% # more accurate way</span></span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_effective_date</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>,</span>
<span>                                   <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="va">trend_time_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                            <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">365</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span><span class="op">)</span>, <span class="co"># equivalent to excel</span></span>
<span>         trended_current_level_earned_premium <span class="op">=</span> <span class="va">current_level_earned_premium</span> <span class="op">*</span> <span class="va">premium_trend_factors</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ult_loss_fiscal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span>, <span class="va">incurred_loss</span>, <span class="va">implied_incurred_age_to_ult</span>, <span class="va">ult_incurred_loss</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_freq_trend_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, freq_trend_z_wtd_selected <span class="op">=</span> <span class="va">z_wtd_selected</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_sev_trend_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, sev_trend_z_wtd_selected <span class="op">=</span> <span class="va">z_wtd_selected</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trend_time_loss <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">6</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">18</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">30</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="fl">42</span>,</span>
<span>             <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="fl">54</span></span>
<span>           <span class="op">)</span>,</span>
<span>         loss_trend_factors <span class="op">=</span> <span class="va">freq_trend_z_wtd_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">sev_trend_z_wtd_selected</span> </span>
<span>                       <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_effective_date</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>                                   <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="va">trend_time_loss</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                            <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">365</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span><span class="op">)</span>,</span>
<span>         trended_ult_incurred_loss <span class="op">=</span> <span class="va">ult_incurred_loss</span> <span class="op">*</span> <span class="va">loss_trend_factors</span>,</span>
<span>         trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">trended_current_level_earned_premium</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">trended_ult_incurred_loss</span> <span class="op">/</span> <span class="va">trended_current_level_earned_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">selection_ay_weights2</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate catastrophe ratios</span></span>
<span><span class="co"># -&gt; statewide</span></span>
<span><span class="va">data_cat</span> <span class="op">&lt;-</span> <span class="va">data_rms_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>modeled_hurricane_ratio <span class="op">=</span> <span class="va">rms_hurricane_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>         .keep <span class="op">=</span> <span class="st">"unused"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ts_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>modeled_fire_following_earthquake_ratio <span class="op">=</span> <span class="va">touchstone_eq_fire_following_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>                     modeled_severe_convective_storm_ratio <span class="op">=</span> <span class="va">touchstone_severe_convective_storm_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>                     modeled_wildfire_ratio <span class="op">=</span> <span class="va">touchstone_wildfire_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>                     .keep <span class="op">=</span> <span class="st">"unused"</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># -&gt; Countrywide</span></span>
<span><span class="va">data_cat_cw</span> <span class="op">&lt;-</span> <span class="va">data_rms_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>modeled_hurricane_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rms_hurricane_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ts_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>modeled_fire_following_earthquake_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchstone_eq_fire_following_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span>,</span>
<span>                     modeled_severe_convective_storm_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchstone_severe_convective_storm_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span>,</span>
<span>                     modeled_wildfire_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchstone_wildfire_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>                     .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># -&gt; combine</span></span>
<span><span class="va">data_cat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_cat_cw</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># final indication calculations</span></span>
<span><span class="va">data_indication2</span> <span class="op">&lt;-</span> <span class="va">data_indication</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>     </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html">%$%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="va">ay_weights</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>       </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ult_claim_count_fiscal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>, ult_incurred_claim_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ult_incurred_claim_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="va">ult_incurred_claim_count</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">1084</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">credibility</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_cat</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_modeled_peril_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">modeled_hurricane_ratio</span>, <span class="va">modeled_fire_following_earthquake_ratio</span>, <span class="va">modeled_severe_convective_storm_ratio</span>, <span class="va">modeled_wildfire_ratio</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.15</span>,</span>
<span>  trended_underlying_plr_less_modeled_perils <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="va">selection_underlying_plr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">total_modeled_peril_partial_loss_ratio</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">data_freq_trend_selected_cw</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                    <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">data_sev_trend_selected_cw</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                    <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="va">data_premium_trend_selected_cw</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                  <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    credibility_weighted_trended_ult_incurred_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="va">ay_weighted_trended_ult_incurred_partial_loss_ratio</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="va">trended_underlying_plr_less_modeled_perils</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                            <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># set constant</span></span>
<span><span class="va">credibility_weighted_trended_ult_incurred_loss_ratio_cw</span> <span class="op">&lt;-</span> <span class="va">data_indication2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">as.numeric</span></span>
<span></span>
<span><span class="co"># continue final indication calculations</span></span>
<span><span class="co"># -&gt; shiny quark again</span></span>
<span><span class="va">data_indication3</span> <span class="op">&lt;-</span> <span class="va">data_indication2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cw_ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio_cw</span>,</span>
<span>    .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    credibility_weighted_trended_ult_incurred_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="va">ay_weighted_trended_ult_incurred_partial_loss_ratio</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="va">cw_ay_weighted_trended_ult_incurred_partial_loss_ratio</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                            <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span></span>
<span>    <span class="op">)</span>,</span>
<span>    margin_for_reinsurance <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    total_prospective_loss_ratio <span class="op">=</span> <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span> <span class="op">+</span> <span class="va">total_modeled_peril_partial_loss_ratio</span> <span class="op">+</span> <span class="va">margin_for_reinsurance</span>,</span>
<span>    permissable_loss_ratio <span class="op">=</span> <span class="fl">0.601</span>,</span>
<span>    indicated_rate_level_needed <span class="op">=</span> <span class="va">total_prospective_loss_ratio</span> <span class="op">/</span> <span class="va">permissable_loss_ratio</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">### Display</span></span>
<span></span>
<span><span class="va">selection_eval_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">selection_data_ended</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output summary table</span></span>
<span><span class="fu">format_as_indication_summary</span><span class="op">(</span>data_ind <span class="op">=</span> <span class="va">data_indication</span>, sel_state <span class="op">=</span> <span class="st">"Countrywide"</span>, sel_data_ended <span class="op">=</span> <span class="va">selection_data_ended</span>, sel_eval_date <span class="op">=</span> <span class="va">selection_eval_date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># organize, convert to long data, and reformat variable names for displaying</span></span>
<span><span class="va">data_indication3_long</span> <span class="op">&lt;-</span> <span class="va">data_indication3</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">ay_weighted_trended_ult_incurred_partial_loss_ratio</span>, <span class="va">credibility</span>, <span class="va">trended_underlying_plr_less_modeled_perils</span>, <span class="va">cw_ay_weighted_trended_ult_incurred_partial_loss_ratio</span>, <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"modeled"</span><span class="op">)</span>, <span class="va">total_modeled_peril_partial_loss_ratio</span>, <span class="va">margin_for_reinsurance</span>, <span class="va">total_prospective_loss_ratio</span>, <span class="va">permissable_loss_ratio</span>, <span class="va">indicated_rate_level_needed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"variable"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>variable_display <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="op">~</span> <span class="st">"Accident year weighted trended ultimate incurred partial loss ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"credibility"</span> <span class="op">~</span> <span class="st">"Credibility (ultimate claims using 1,084 standard):"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"trended_underlying_plr_less_modeled_perils"</span> <span class="op">~</span> <span class="st">"Trended, underlying permissible loss ratio less modeled perils:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"cw_ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="op">~</span> <span class="st">"Countrywide accident year weighted trended ultimate ncurred partial loss + LAE ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"credibility_weighted_trended_ult_incurred_loss_ratio"</span> <span class="op">~</span> <span class="st">"Credibility weighted trended ultimate incurred loss + LAE ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_hurricane_ratio"</span> <span class="op">~</span> <span class="st">"Modeled hurricane ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_fire_following_earthquake_ratio"</span> <span class="op">~</span> <span class="st">"Modeled fire following earthquake ratio:"</span>, </span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_severe_convective_storm_ratio"</span> <span class="op">~</span> <span class="st">"Modeled severe convective storm ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_wildfire_ratio"</span> <span class="op">~</span> <span class="st">"Modeled wildfire ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"total_modeled_peril_partial_loss_ratio"</span> <span class="op">~</span> <span class="st">"Total modeled peril partial loss + LAE ratio (modeled ratios x 1.15 LAE factor):"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"margin_for_reinsurance"</span> <span class="op">~</span> <span class="st">"Margin for reinsurance:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"total_prospective_loss_ratio"</span> <span class="op">~</span> <span class="st">"Total prospective loss + LAE ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"permissable_loss_ratio"</span> <span class="op">~</span> <span class="st">"Permissable loss + LAE ratio:"</span>,</span>
<span>             <span class="va">variable</span> <span class="op">==</span> <span class="st">"indicated_rate_level_needed"</span> <span class="op">~</span> <span class="st">"Indicated rate level needed:"</span></span>
<span>           <span class="op">)</span>,</span>
<span>         .after <span class="op">=</span> <span class="va">variable</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># output indication calculations table</span></span>
<span><span class="fu">format_as_indication_calculations</span><span class="op">(</span>data_ind3_long <span class="op">=</span> <span class="va">data_indication3_long</span>, sel_state <span class="op">=</span> <span class="st">"Countrywide"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output indication calculations supporting table</span></span>
<span><span class="fu">format_as_indication_calculations_support</span><span class="op">(</span>data_ind3_long <span class="op">=</span> <span class="va">data_indication3_long</span>, sel_state <span class="op">=</span> <span class="st">"Countrywide"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Data checks ----</span></span>
<span></span>
<span><span class="co"># -&gt; paid loss triangle</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="va">data_paid_loss_triangle</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">y</span>, <span class="st">"test.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="indications---app" class="level3" data-number="3.1.11"><h3 data-number="3.1.11" class="anchored" data-anchor-id="indications---app">
<span class="header-section-number">3.1.11</span> Indications - app</h3>
<p><img src="files/indication-app.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### ---- Load packages ----</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridlayout</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/bslib/">bslib</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT">DT</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Functions ----</span></span>
<span></span>
<span><span class="va">`%!in%`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span><span class="op">(</span><span class="st">"%in%"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># function to format long data as triangle</span></span>
<span><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span><span class="co"># -&gt; n_periods = 28 --&gt; 7 years of data for triangle</span></span>
<span><span class="va">format_bases_as_triangle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_agg_age</span>, <span class="va">var</span>, <span class="va">ult_age</span> <span class="op">=</span> <span class="fl">63</span>, <span class="va">n_periods</span> <span class="op">=</span> <span class="fl">28</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">var</span> <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_agg_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&lt;=</span> <span class="va">ult_age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">age</span>,</span>
<span>                values_from <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="st">"-Q"</span>, <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">accident_quarter</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">3</span>, to <span class="op">=</span> <span class="va">ult_age</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_periods</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define function to calculate development factors</span></span>
<span><span class="va">calculate_dev_factors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_agg_age</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">var</span> <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># reduce input data to only needed columns</span></span>
<span>  <span class="va">df_agg_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># setup output dataframe</span></span>
<span>  <span class="va">df_dev</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,                  </span>
<span>                  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_agg_age</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># taking ratios, so one row less</span></span>
<span>    <span class="va">data.frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_dev</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loss_year"</span>,<span class="st">"loss_qtr"</span>, <span class="st">"left"</span>, <span class="st">"right"</span>, <span class="st">"dev_factor"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate development factors</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># set constants</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># set ratio column indicators</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># calculate factor</span></span>
<span>    <span class="va">df_dev</span><span class="op">[</span><span class="va">i</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                         <span class="cn">NA</span>,</span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">df_agg_age</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># remove unwanted comparisons and format ratio indicator</span></span>
<span>  <span class="va">df_dev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">left</span> <span class="op">&gt;</span> <span class="va">right</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">left</span>, <span class="st">":"</span>, <span class="va">right</span><span class="op">)</span>,</span>
<span>           .after <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_dev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># format loss development factors as triangle</span></span>
<span><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span><span class="co"># -&gt; n_periods = 27 --&gt; 7 years of data for triangle</span></span>
<span><span class="va">format_dev_factors_as_triangle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_dev</span>, <span class="va">ult_age</span> <span class="op">=</span> <span class="fl">63</span>, <span class="va">n_periods</span> <span class="op">=</span> <span class="fl">27</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">df_dev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">left</span> <span class="op">&lt;=</span> <span class="va">ult_age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">age_age</span>,</span>
<span>                values_from <span class="op">=</span> <span class="va">dev_factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="st">"-Q"</span>, <span class="va">loss_qtr</span><span class="op">)</span>,</span>
<span>           <span class="st">"Ult:{{ult_age}}"</span> <span class="op">:=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">accident_quarter</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">6</span>, to <span class="op">=</span> <span class="va">ult_age</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,<span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">3</span>, to <span class="op">=</span> <span class="va">ult_age</span><span class="op">-</span><span class="fl">3</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Ult:"</span>, <span class="va">ult_age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_periods</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># define function to calculate weighted development factors</span></span>
<span><span class="va">calculate_weighted_dev_factors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_loss_tri</span>, <span class="va">selects</span>, <span class="va">ult_age</span> <span class="op">=</span> <span class="fl">63</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># setup output dataframe</span></span>
<span>  <span class="va">df_weights</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df_loss_tri</span><span class="op">)</span>,                  </span>
<span>                      nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">data.frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">6</span>, to <span class="op">=</span> <span class="va">ult_age</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,<span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">3</span>, to <span class="op">=</span> <span class="va">ult_age</span><span class="op">-</span><span class="fl">3</span>, by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Ult:"</span>, <span class="va">ult_age</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># set constants</span></span>
<span>  <span class="va">df_weights</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">8</span>, to <span class="op">=</span> <span class="fl">16</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="st">" pts wtd"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculated weighted development factors</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># set number of periods to look back (i.e. weight)</span></span>
<span>    <span class="va">weight</span> <span class="op">=</span> <span class="va">df_weights</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">1</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_locate.html">str_locate</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">" pts"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span></span>
<span>    </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="co"># figure out number of periods with data in triangle for the larger age</span></span>
<span>      <span class="va">data_count</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_loss_tri</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">df_loss_tri</span><span class="op">[</span>,<span class="va">j</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># calculate X-pts weighted ratio</span></span>
<span>      <span class="va">df_weights</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_loss_tri</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">data_count</span> <span class="op">-</span> <span class="va">weight</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">data_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">j</span>, <span class="va">j</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>col_j <span class="op">=</span> <span class="fl">2</span>, col_j_minus_1 <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">col_j_minus_1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">col_j</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># create dataframe of selects for each age:age</span></span>
<span>  <span class="co"># -&gt; need to organize so can correctly calculate in next step</span></span>
<span>  <span class="va">df_selects</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>age_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, selected <span class="op">=</span> <span class="va">selects</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>row_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">row_num</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate cumulative selects "backwards"</span></span>
<span>  <span class="va">selects_cumulative</span> <span class="op">=</span> <span class="va">df_selects</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">cumprod</span></span>
<span>  </span>
<span>  <span class="co"># append calculated factors and reorganize</span></span>
<span>  <span class="va">df_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span>selects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cumulative <span class="op">=</span> <span class="va">selects_cumulative</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">row_num</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_selects</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df_weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># combine dataframes</span></span>
<span>  <span class="va">df_weights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">df_selects</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_weights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to calculate ultimate incurred</span></span>
<span><span class="va">calculate_ultimate_incurred</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_agg</span>, <span class="va">df_selects</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># extract cumulative select factors</span></span>
<span>  <span class="va">cumlative_selects</span> <span class="op">=</span> <span class="va">df_selects</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="st">"cumulative"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                 names_to <span class="op">=</span> <span class="st">"age_age"</span>,</span>
<span>                 values_to <span class="op">=</span> <span class="st">"cumulative_factor"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># reorganize summary table for appending cumulative selects</span></span>
<span>  <span class="va">df_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">loss_year</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># append cumulative selects, organize data, and calculate new column</span></span>
<span>  <span class="co"># -&gt; fill rest of values with NA</span></span>
<span>  <span class="va">df_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="va">data</span><span class="op">$</span><span class="va">factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cumlative_selects</span><span class="op">$</span><span class="va">cumulative_factor</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">cumlative_selects</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">return</span></span>
<span>        </span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">factor</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="st">"-Q"</span>, <span class="va">loss_qtr</span><span class="op">)</span>,</span>
<span>           ult_incurred <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">*</span> <span class="va">factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">accident_quarter</span>, incurred <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, <span class="va">factor</span>, <span class="va">ult_incurred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># summarize data by fiscal year</span></span>
<span><span class="va">summarize_by_fiscal_year</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="fl">3</span>, factor <span class="op">=</span> <span class="fl">4</span>, var2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># standardize names</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="co"># drop most recent period, calculate rolling sum by fiscal year, calculate factor, and organize</span></span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>var1_cumulative <span class="op">=</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">var1</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 var2_cumulative <span class="op">=</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">var2</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">var1_cumulative</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">var2_cumulative</span> <span class="op">/</span> <span class="va">var1_cumulative</span><span class="op">)</span>,</span>
<span>                 quarter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">accident_quarter</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># get most recent quarter to work from</span></span>
<span>        <span class="va">ref_qtr</span> <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">quarter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="va">as.numeric</span></span>
<span>        </span>
<span>        <span class="co"># keep only relevant periods</span></span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">quarter</span> <span class="op">==</span> <span class="va">ref_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>fiscal_year_ended <span class="op">=</span> <span class="va">accident_quarter</span>, <span class="va">var1_cumulative</span>, <span class="va">factor</span>, <span class="va">var2_cumulative</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="va">return</span></span>
<span>        </span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># set NAs to Countrywide values</span></span>
<span>  <span class="va">df_cw</span> <span class="op">=</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, <span class="va">factor</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># use Countrywide values if NA for state factors and organize data</span></span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span>, <span class="va">df_cw</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_cw</span>,</span>
<span>                    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span><span class="op">)</span>,</span>
<span>                    suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_st"</span>, <span class="st">"_cw"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">factor_st</span><span class="op">)</span>, <span class="va">factor_cw</span>, <span class="va">factor_st</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, <span class="va">var1_cumulative</span>, <span class="va">factor</span>, <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="op">}</span>,</span>
<span>      <span class="va">df_cw</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to calculate the final step of the trending (x is a vector of two fits)</span></span>
<span><span class="va">calculate_final_fit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function calculated weighted fits</span></span>
<span><span class="va">calculate_weighted_fits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_calendar</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># initialize needed items</span></span>
<span>  <span class="va">pts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">8</span>, to <span class="op">=</span> <span class="fl">24</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">j</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># loop through different weights (fits)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">pts</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># reassign full dataset</span></span>
<span>    <span class="va">df_temp</span> <span class="op">=</span> <span class="va">df_calendar</span></span>
<span>    </span>
<span>    <span class="co"># limit dataset and calculate fit</span></span>
<span>    <span class="va">df_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">24</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># skip periods where cumulative sum isn't full</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># set Xs</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">df_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_temp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># if no data, stop don't calculate anything</span></span>
<span>      </span>
<span>      <span class="va">fits</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">fits</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">df_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">" ~ i"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.formula</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">calculate_final_fit</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">j</span> <span class="op">=</span> <span class="va">j</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># reorganize</span></span>
<span>  <span class="va">fits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">data.frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">fits</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">8</span>, to <span class="op">=</span> <span class="fl">24</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="st">" pt"</span><span class="op">)</span></span>
<span>  <span class="va">fits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.nan</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">return</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to output indication summary table</span></span>
<span><span class="va">format_as_indication_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ind</span>, <span class="va">sel_state</span>, <span class="va">sel_data_ended</span>, <span class="va">sel_eval_date</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">data_ind</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">sel_state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>,<span class="va">current_level_earned_premium</span>, <span class="va">premium_trend_factors</span>, <span class="va">trended_current_level_earned_premium</span>, <span class="va">incurred_loss</span>, <span class="va">implied_incurred_age_to_ult</span>, <span class="va">ult_incurred_loss</span>, <span class="va">loss_trend_factors</span>, <span class="va">trended_ult_incurred_loss</span>, <span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="va">ay_weights</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/opt_stylize.html">opt_stylize</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"**"</span>, <span class="va">sel_state</span>, <span class="st">" indications**"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               subtitle <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/md.html">md</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"**Calendar / accident year data ended "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">sel_data_ended</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, abbr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">" "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">sel_data_ended</span><span class="op">)</span>, <span class="st">", "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">sel_data_ended</span><span class="op">)</span>, <span class="st">" as of "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">sel_eval_date</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, abbr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">" "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">sel_eval_date</span><span class="op">)</span>, <span class="st">", "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">sel_eval_date</span><span class="op">)</span>, <span class="st">"**"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_label.html">cols_label</a></span><span class="op">(</span>fiscal_year_ended <span class="op">=</span> <span class="st">"Year ended"</span>,</span>
<span>               current_level_earned_premium <span class="op">=</span> <span class="st">"Current level earned premium"</span>,</span>
<span>               premium_trend_factors <span class="op">=</span> <span class="st">"Premium trend factors"</span>,</span>
<span>               trended_current_level_earned_premium <span class="op">=</span> <span class="st">"Trended current level earned poremium"</span>,</span>
<span>               incurred_loss <span class="op">=</span> <span class="st">"Non-cat incurred loss + LAE"</span>,</span>
<span>               implied_incurred_age_to_ult <span class="op">=</span> <span class="st">"Loss development factors"</span>,</span>
<span>               ult_incurred_loss <span class="op">=</span> <span class="st">"Ultimate non-cat incurred loss + LAE"</span>,</span>
<span>               loss_trend_factors <span class="op">=</span> <span class="st">"Loss trend factors"</span>,</span>
<span>               trended_ult_incurred_loss <span class="op">=</span> <span class="st">"Trended ultimate non-cat incurred loss + lae"</span>,</span>
<span>               trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="st">"Trended ultimate non-cat incurred parial loss + LAE ratio"</span>,</span>
<span>               ay_weights <span class="op">=</span> <span class="st">"Accident year weights"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">current_level_earned_premium</span>, <span class="va">trended_current_level_earned_premium</span>, <span class="va">incurred_loss</span>, <span class="va">ult_incurred_loss</span>, <span class="va">trended_ult_incurred_loss</span><span class="op">)</span>,</span>
<span>               decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_number.html">fmt_number</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">premium_trend_factors</span>, <span class="va">implied_incurred_age_to_ult</span>, <span class="va">loss_trend_factors</span><span class="op">)</span>,</span>
<span>               decimals <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="va">ay_weights</span><span class="op">)</span>,</span>
<span>                decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to output indication calculations table</span></span>
<span><span class="va">format_as_indication_calculations</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ind3_long</span>, <span class="va">sel_state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">data_ind3_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">sel_state</span>,</span>
<span>           <span class="va">variable</span> <span class="op">%!in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">variable_display</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op">(</span>column_labels.hidden <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">variable_display</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span></span>
<span>      style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://gt.rstudio.com/reference/cell_text.html">cell_text</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">variable_display</span>, <span class="va">value</span><span class="op">)</span>,</span>
<span>        rows <span class="op">=</span> <span class="va">variable_display</span> <span class="op">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html">tab_style</a></span><span class="op">(</span></span>
<span>      style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://gt.rstudio.com/reference/cell_fill.html">cell_fill</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_body.html">cells_body</a></span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="va">value</span>,</span>
<span>        rows <span class="op">=</span> <span class="va">variable_display</span> <span class="op">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function to output supporting table of indication calculations</span></span>
<span><span class="va">format_as_indication_calculations_support</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ind3_long</span>, <span class="va">sel_state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">data_ind3_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">sel_state</span>,</span>
<span>           <span class="va">variable</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">variable_display</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">gt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op">(</span>column_labels.hidden <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">variable_display</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/cols_align.html">cols_align</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://gt.rstudio.com/reference/fmt_percent.html">fmt_percent</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="va">value</span>, decimals <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### ---- Read in and create data ----</span></span>
<span></span>
<span><span class="co"># read in data from access process</span></span>
<span></span>
<span><span class="co"># -&gt; premium data</span></span>
<span><span class="va">data_premium_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"PremiumData"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>qtr <span class="op">=</span> <span class="va">quarter</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; loss data</span></span>
<span><span class="va">data_loss_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"LossData"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"qtr"</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; reported frequency data</span></span>
<span><span class="va">data_rept_freq_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ReptFreqData"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"qtr"</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; closed by closed evaluation data</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span>  <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ClsdByClsdEvalDt"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eval_qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; closed by evaluation data</span></span>
<span><span class="va">data_clsd_by_eval_date_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ClsdByEvalDt"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eval_qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; RMS modeled loss</span></span>
<span><span class="va">data_rms_modeled_loss</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"RMSModLoss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -&gt; TS modeled loss</span></span>
<span><span class="va">data_ts_modeled_loss</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"TSModLoss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># single out vectors</span></span>
<span><span class="va">vec_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_premium_raw</span><span class="op">$</span><span class="va">state</span><span class="op">)</span> <span class="co"># use premium data to capture all states</span></span>
<span><span class="va">vec_loss_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">loss_year</span><span class="op">)</span></span>
<span><span class="va">vec_loss_qtrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">loss_qtr</span><span class="op">)</span></span>
<span><span class="va">vec_eval_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">eval_year</span><span class="op">)</span></span>
<span><span class="va">vec_eval_qtrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_loss_raw</span><span class="op">$</span><span class="va">eval_qtr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create dataset of all possible combos, then add the needed combos for the most recent year</span></span>
<span><span class="co"># -&gt; this is so that later in the process, data has rows of zero rather than no row if no losses were in that particular period</span></span>
<span><span class="va">data_all_combos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">vec_states</span>, <span class="va">vec_loss_years</span>, <span class="va">vec_loss_qtrs</span>, <span class="va">vec_eval_years</span>, <span class="va">vec_eval_qtrs</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data_all_combos</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"loss_year"</span>, <span class="st">"loss_qtr"</span>, <span class="st">"eval_year"</span>, <span class="st">"eval_qtr"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># keep only valid periods</span></span>
<span><span class="co"># -&gt; set current eval quarter</span></span>
<span><span class="va">cur_eval_qtr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">loss_year</span> <span class="op">&lt;=</span> <span class="va">eval_year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>keep <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>             <span class="va">loss_year</span> <span class="op">==</span> <span class="va">eval_year</span> <span class="op">&amp;</span> <span class="va">loss_qtr</span> <span class="op">&gt;</span> <span class="va">eval_qtr</span> <span class="op">~</span> <span class="fl">0</span>, <span class="co"># illogical periods</span></span>
<span>             <span class="va">loss_year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">loss_year</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">loss_qtr</span> <span class="op">&gt;</span> <span class="va">cur_eval_qtr</span> <span class="op">~</span> <span class="fl">0</span>, <span class="co"># future periods</span></span>
<span>             <span class="va">eval_year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">eval_year</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">eval_qtr</span> <span class="op">&gt;</span> <span class="va">cur_eval_qtr</span> <span class="op">~</span> <span class="fl">0</span>, <span class="co"># future periods</span></span>
<span>             .default <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">keep</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">keep</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Modify data ----</span></span>
<span></span>
<span><span class="co"># premium data</span></span>
<span><span class="co"># add placeholder rows to premium data</span></span>
<span><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span><span class="va">data_premium_agg</span> <span class="op">&lt;-</span> <span class="va">data_premium_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span>, <span class="va">qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># loss data</span></span>
<span><span class="co"># add placeholder rows to loss data</span></span>
<span><span class="va">data_loss_raw2</span> <span class="op">&lt;-</span> <span class="va">data_loss_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create age variable</span></span>
<span><span class="va">data_loss</span> <span class="op">&lt;-</span> <span class="va">data_loss_raw2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="op">(</span><span class="va">eval_year</span> <span class="op">-</span> <span class="va">loss_year</span><span class="op">)</span> <span class="op">*</span> <span class="fl">12</span> <span class="op">+</span> <span class="op">(</span><span class="va">eval_qtr</span> <span class="op">-</span> <span class="va">loss_qtr</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">3</span>, <span class="co"># evaluating in same quarter as loss counts as 3 months of development</span></span>
<span>         paid_loss_plus_lae <span class="op">=</span> <span class="va">paid_loss</span> <span class="op">+</span> <span class="va">paid_lae</span> <span class="op">+</span> <span class="op">-</span><span class="va">subrogation_salvage</span>,</span>
<span>         incurred_loss <span class="op">=</span> <span class="va">paid_loss_plus_lae</span> <span class="op">+</span> <span class="va">case_reserve</span> <span class="op">+</span> <span class="va">expense_reserve</span>,</span>
<span>         incurred_claim_count <span class="op">=</span> <span class="va">cwp_count</span> <span class="op">+</span> <span class="va">open_count</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># create summarized loss data by state and overall (cw)</span></span>
<span><span class="va">data_loss_agg_age_cw</span> <span class="op">&lt;-</span> <span class="va">data_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">age</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paid_loss_plus_lae</span>, <span class="va">incurred_loss</span>, <span class="va">incurred_claim_count</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_loss_agg_age_st</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="va">loss_qtr</span>, <span class="va">age</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paid_loss_plus_lae</span>, <span class="va">incurred_loss</span>, <span class="va">incurred_claim_count</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assumption of number of months to ultimate loss</span></span>
<span><span class="va">ult_age</span> <span class="op">&lt;-</span> <span class="fl">63</span></span>
<span></span>
<span><span class="co"># reported frequency data</span></span>
<span><span class="co"># add placeholder rows to loss data</span></span>
<span><span class="va">data_rept_freq_raw2</span> <span class="op">&lt;-</span> <span class="va">data_rept_freq_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">rept_qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span>, <span class="va">rept_qtr</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># closed by closed evaluation date data</span></span>
<span><span class="co"># add placeholder rows to premium data</span></span>
<span><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_clsd_eval_date_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">eval_qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># closed by evaluation date data</span></span>
<span><span class="co"># add placeholder rows to premium data</span></span>
<span><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span><span class="va">data_clsd_by_eval_date_agg</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_eval_date_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">data_all_combos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span> <span class="op">==</span> <span class="va">loss_year</span>, <span class="va">eval_qtr</span> <span class="op">==</span> <span class="va">loss_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Premium trend ----</span></span>
<span></span>
<span><span class="co"># create summarized premium data overall (cw) and then combine</span></span>
<span><span class="va">data_premium_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_premium_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize all columns by calendar year</span></span>
<span><span class="va">data_premium_trend_calendar</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span>, <span class="va">qtr</span>, <span class="va">on_level_earned_premium</span>, <span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">27</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>calendar_quarter_ended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>,<span class="st">"-Q"</span>, <span class="va">qtr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">on_level_earned_premium</span>, <span class="va">earned_exposure</span><span class="op">)</span>, \<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">col</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               average_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">earned_exposure</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">on_level_earned_premium</span> <span class="op">/</span> <span class="va">earned_exposure</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate weighted fits</span></span>
<span><span class="va">data_prem_trend_fits</span> <span class="op">&lt;-</span> <span class="va">data_premium_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"average_premium"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"average_premium"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Current level earned premium ----</span></span>
<span></span>
<span><span class="co"># calculate current level factor</span></span>
<span><span class="va">data_premium_current_level</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>accident_quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-Q"</span>, <span class="va">qtr</span><span class="op">)</span>,</span>
<span>         current_level_factor <span class="op">=</span> <span class="va">earned_premium</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">on_level_earned_premium</span> <span class="op">/</span> <span class="va">earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">accident_quarter</span>, <span class="va">earned_premium</span>, <span class="va">current_level_factor</span>, <span class="va">on_level_earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">21</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="co"># 5 years of data + 1 quarter</span></span>
<span></span>
<span><span class="co"># summarize data by fiscal year</span></span>
<span><span class="va">data_premium_current_level_fiscal</span> <span class="op">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span><span class="op">(</span>df <span class="op">=</span> <span class="va">data_premium_current_level</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>earned_premium <span class="op">=</span> <span class="va">var1_cumulative</span>, current_level_factor <span class="op">=</span> <span class="va">factor</span>, current_level_earned_premium <span class="op">=</span> <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Paid loss ----</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_paid_loss_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_bases_as_triangle</span><span class="op">(</span>df_agg_age <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"paid_loss_plus_lae"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate development factors</span></span>
<span><span class="va">data_paid_loss_dev</span> <span class="op">&lt;-</span> <span class="fu">calculate_dev_factors</span><span class="op">(</span>df_agg_age <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"paid_loss_plus_lae"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_paid_loss_dev_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span><span class="op">(</span>df_dev <span class="op">=</span> <span class="va">data_paid_loss_dev</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Incurred loss ----</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_loss_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_bases_as_triangle</span><span class="op">(</span>df_agg_age <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate development factors</span></span>
<span><span class="va">data_incurred_loss_dev</span> <span class="op">&lt;-</span> <span class="fu">calculate_dev_factors</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_loss_dev_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span><span class="op">(</span>df_dev <span class="op">=</span> <span class="va">data_incurred_loss_dev</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Incurred claim count ----</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_claim_count_triangle</span> <span class="op">&lt;-</span> <span class="fu">format_bases_as_triangle</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate development factors</span></span>
<span><span class="va">data_incurred_claim_count_dev</span> <span class="op">&lt;-</span> <span class="fu">calculate_dev_factors</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg_age_cw</span>, var <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format as triangle</span></span>
<span><span class="va">data_incurred_claim_count_dev_triangle</span> <span class="op">&lt;-</span>  <span class="fu">format_dev_factors_as_triangle</span><span class="op">(</span>df_dev <span class="op">=</span> <span class="va">data_incurred_claim_count_dev</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Ultimate ----</span></span>
<span></span>
<span><span class="co"># summarize data</span></span>
<span><span class="co"># -&gt; create summarized loss data (accident quarter) by state, then overall (cw), and then combine</span></span>
<span><span class="va">data_loss_agg</span> <span class="op">&lt;-</span> <span class="va">data_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">eval_year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">eval_year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># only use rows in most recent evaluation period</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">eval_qtr</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># -&gt; this makes it accident quarter</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred"</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span></span>
<span><span class="va">data_loss_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_loss_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">loss_year</span>, <span class="va">loss_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"incurred"</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_loss_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_loss_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Frequency trend ----</span></span>
<span></span>
<span><span class="co"># create summarized loss data (calendar quarter) by state, then overall (cw), and then combine</span></span>
<span><span class="co"># -&gt; data is already only using the most recent evaluation period</span></span>
<span><span class="va">data_rept_freq_agg</span> <span class="op">&lt;-</span> <span class="va">data_rept_freq_raw2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span>, <span class="va">rept_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>reported_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reported_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span></span>
<span><span class="va">data_rept_freq_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_rept_freq_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">rept_year</span>, <span class="va">rept_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>reported_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reported_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_rept_freq_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_rept_freq_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create summarized closed by closed evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_clsd_by_clsd_eval_date_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize all columns by calendar year</span></span>
<span><span class="va">data_freq_trend_calendar</span> <span class="op">&lt;-</span> <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span>, <span class="va">qtr</span>, <span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_rept_freq_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">rept_year</span>, <span class="va">rept_qtr</span>, <span class="va">reported_count</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span> <span class="op">==</span> <span class="va">rept_year</span>, <span class="va">qtr</span> <span class="op">==</span> <span class="va">rept_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span>, <span class="va">closed_w_pay_count</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year</span> <span class="op">==</span> <span class="va">eval_year</span>, <span class="va">qtr</span> <span class="op">==</span> <span class="va">eval_qtr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">27</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_freq_trend_agg</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>calendar_quarter_ended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-Q"</span>, <span class="va">qtr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">earned_exposure</span>, <span class="va">reported_count</span>, <span class="va">closed_w_pay_count</span><span class="op">)</span>, \<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">col</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               reported_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">earned_exposure</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">reported_count</span> <span class="op">/</span> <span class="va">earned_exposure</span><span class="op">)</span>,</span>
<span>               closed_w_pay_freq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">earned_exposure</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">closed_w_pay_count</span> <span class="op">/</span> <span class="va">earned_exposure</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, <span class="va">earned_exposure</span>, <span class="va">reported_count</span>, <span class="va">reported_freq</span>, <span class="va">closed_w_pay_count</span>, <span class="va">closed_w_pay_freq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span><span class="co"># -&gt; reported frequency</span></span>
<span><span class="va">data_freq_trend_fits_a</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"reported_freq"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"reported_freq"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; closed with pay frequency</span></span>
<span><span class="va">data_freq_trend_fits_b</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"closed_w_pay_freq"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"closed_w_pay_freq"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; combine</span></span>
<span><span class="va">data_freq_trend_fits</span> <span class="op">&lt;-</span> <span class="va">data_freq_trend_fits_a</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_freq_trend_fits_b</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Severity trend ----</span></span>
<span></span>
<span><span class="co"># create summarized closed by evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span><span class="va">data_clsd_by_eval_date_agg_cw</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_clsd_by_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_clsd_by_eval_date_agg_cw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize all columns by calendar year</span></span>
<span><span class="va">data_sev_trend_calendar</span> <span class="op">&lt;-</span> <span class="va">data_clsd_by_clsd_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span>, <span class="va">closed_w_pay_count</span>, <span class="va">total_paid_loss_lae_net_of_s_s</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_clsd_by_eval_date_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span>, <span class="va">total_paid_loss_lae_net_of_s_s</span>, <span class="va">post_closure_total_paid_loss_lae_net_of_s_s</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">eval_year</span>, <span class="va">eval_qtr</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_clsdbyclsd"</span>, <span class="st">"_clsd"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>paid_loss <span class="op">=</span> <span class="va">total_paid_loss_lae_net_of_s_s_clsd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>paid_on_closed_loss <span class="op">=</span> <span class="va">total_paid_loss_lae_net_of_s_s_clsdbyclsd</span> <span class="op">+</span> <span class="va">post_closure_total_paid_loss_lae_net_of_s_s</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">post_closure_total_paid_loss_lae_net_of_s_s</span>, <span class="va">total_paid_loss_lae_net_of_s_s_clsdbyclsd</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">27</span>, by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span>  <span class="op">{</span><span class="va">.</span> <span class="op">-&gt;&gt;</span> <span class="va">data_sev_trend_agg</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>calendar_quarter_ended <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">eval_year</span>, <span class="st">"-Q"</span>, <span class="va">eval_qtr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span>, <span class="va">paid_loss</span>, <span class="va">paid_on_closed_loss</span><span class="op">)</span>, \<span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu">roll</span><span class="fu">::</span><span class="fu">roll_sum</span><span class="op">(</span><span class="va">col</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               paid_sev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">paid_loss</span> <span class="op">/</span> <span class="va">closed_w_pay_count</span><span class="op">)</span>,</span>
<span>               paid_on_closed_sev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">paid_on_closed_loss</span> <span class="op">/</span> <span class="va">closed_w_pay_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, <span class="va">closed_w_pay_count</span>, <span class="va">paid_loss</span>, <span class="va">paid_sev</span>, <span class="va">paid_on_closed_loss</span>, <span class="va">paid_on_closed_sev</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="va">return</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">calendar_quarter_ended</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span><span class="co"># -&gt; paid severity</span></span>
<span><span class="va">data_sev_trend_fits_a</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"paid_sev"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"paid_sev"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; paid on closed severity</span></span>
<span><span class="va">data_sev_trend_fits_b</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_calendar</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="fu">calculate_weighted_fits</span><span class="op">(</span>df_calendar <span class="op">=</span> <span class="va">data</span>, var <span class="op">=</span> <span class="st">"paid_on_closed_sev"</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"pt"</span>, values_to <span class="op">=</span> <span class="st">"paid_on_closed_sev"</span><span class="op">)</span></span>
<span><span class="co"># -&gt; combine</span></span>
<span><span class="va">data_sev_trend_fits</span> <span class="op">&lt;-</span> <span class="va">data_sev_trend_fits_a</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_sev_trend_fits_b</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ---- Indication ----</span></span>
<span></span>
<span><span class="co"># calculate catastrophe ratios</span></span>
<span><span class="co"># -&gt; statewide</span></span>
<span><span class="va">data_cat</span> <span class="op">&lt;-</span> <span class="va">data_rms_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>modeled_hurricane_ratio <span class="op">=</span> <span class="va">rms_hurricane_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>         .keep <span class="op">=</span> <span class="st">"unused"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ts_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>modeled_fire_following_earthquake_ratio <span class="op">=</span> <span class="va">touchstone_eq_fire_following_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>                     modeled_severe_convective_storm_ratio <span class="op">=</span> <span class="va">touchstone_severe_convective_storm_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>                     modeled_wildfire_ratio <span class="op">=</span> <span class="va">touchstone_wildfire_gross_aal</span> <span class="op">/</span> <span class="va">in_force_premium</span>,</span>
<span>                     .keep <span class="op">=</span> <span class="st">"unused"</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># -&gt; Countrywide</span></span>
<span><span class="va">data_cat_cw</span> <span class="op">&lt;-</span> <span class="va">data_rms_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>modeled_hurricane_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rms_hurricane_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>         .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_ts_modeled_loss</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>modeled_fire_following_earthquake_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchstone_eq_fire_following_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span>,</span>
<span>                        modeled_severe_convective_storm_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchstone_severe_convective_storm_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span>,</span>
<span>                        modeled_wildfire_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchstone_wildfire_gross_aal</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in_force_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>                     .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># -&gt; combine</span></span>
<span><span class="va">data_cat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_cat_cw</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">### ---- Define UI ----</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">grid_page</span><span class="op">(</span></span>
<span>  layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"header  results"</span>,</span>
<span>    <span class="st">"sidebar results  "</span></span>
<span>  <span class="op">)</span>,</span>
<span>  row_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"100px"</span>,</span>
<span>    <span class="st">"1fr"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  col_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"400px"</span>,</span>
<span>    <span class="st">"1fr"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  gap_size <span class="op">=</span> <span class="st">"1rem"</span>,</span>
<span>  <span class="fu">grid_card_text</span><span class="op">(</span></span>
<span>    area <span class="op">=</span> <span class="st">"header"</span>,</span>
<span>    content <span class="op">=</span> <span class="st">"Quarterly indications"</span>,</span>
<span>    alignment <span class="op">=</span> <span class="st">"start"</span>,</span>
<span>    is_title <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">grid_card</span><span class="op">(</span></span>
<span>    area <span class="op">=</span> <span class="st">"sidebar"</span>,</span>
<span>    <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html">uiOutput</a></span><span class="op">(</span>outputId <span class="op">=</span> <span class="st">"indicated_rates"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span></span>
<span>        inputId <span class="op">=</span> <span class="st">"selection_state"</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Select state"</span>,</span>
<span>        choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_premium_raw</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>,</span>
<span>        selected <span class="op">=</span> <span class="st">"California"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span></span>
<span>        inputId <span class="op">=</span> <span class="st">"selection_Countrywide"</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Select Countrywide"</span>,</span>
<span>        choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"Countrywide"</span> <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>          <span class="st">"Countrywide excluding California"</span> <span class="op">=</span> <span class="st">"Countrywide x california"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        selected <span class="op">=</span> <span class="st">"Countrywide"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/dateInput.html">dateInput</a></span><span class="op">(</span>inputId <span class="op">=</span> <span class="st">"selection_data_ended"</span>,</span>
<span>                            label <span class="op">=</span> <span class="st">"Data ended"</span>,</span>
<span>                            value <span class="op">=</span> <span class="st">"2024-06-30"</span>,</span>
<span>                            format <span class="op">=</span> <span class="st">"mm/dd/yyyy"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/dateInput.html">dateInput</a></span><span class="op">(</span>inputId <span class="op">=</span> <span class="st">"selection_effective_date"</span>,</span>
<span>                            label <span class="op">=</span> <span class="st">"Proposed effective date"</span>,</span>
<span>                            format <span class="op">=</span> <span class="st">"mm/dd/yyyy"</span><span class="op">)</span>,</span>
<span>      <span class="fu">grid_container</span><span class="op">(</span></span>
<span>        layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"selection_lcm selection_underlying_plr"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        row_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"110px"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        col_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"1fr"</span>,</span>
<span>          <span class="st">"1fr"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        gap_size <span class="op">=</span> <span class="st">"10px"</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"selection_lcm"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"selection_lcm"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"Select LCM"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">1.669</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.01</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"selection_underlying_plr"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput</a></span><span class="op">(</span>outputId <span class="op">=</span> <span class="st">"selection_underlying_plr"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu">grid_container</span><span class="op">(</span></span>
<span>        layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"premium_trend_cw premium_trend_sw"</span>,</span>
<span>          <span class="st">"freq_trend_cw    freq_trend_sw   "</span>,</span>
<span>          <span class="st">"sev_trend_cw     sev_trend_sw    "</span></span>
<span>        <span class="op">)</span>,</span>
<span>        row_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"110px"</span>,</span>
<span>          <span class="st">"110px"</span>,</span>
<span>          <span class="st">"110px"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        col_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"1.15fr"</span>,</span>
<span>          <span class="st">"0.85fr"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        gap_size <span class="op">=</span> <span class="st">"10px"</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"premium_trend_cw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"premium_trend_cw"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"Premium trend: CW"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">0.075</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              max <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.005</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"freq_trend_cw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"freq_trend_cw"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"Frequency trend: CW"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">0.04</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              max <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.005</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"sev_trend_cw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"sev_trend_cw"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"Severity trend: CW"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">0.14</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              max <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.005</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"premium_trend_sw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"premium_trend_sw"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"SW"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              max <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.005</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"freq_trend_sw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"freq_trend_sw"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"SW"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">0.04</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              max <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.005</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"sev_trend_sw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span></span>
<span>              inputId <span class="op">=</span> <span class="st">"sev_trend_sw"</span>,</span>
<span>              label <span class="op">=</span> <span class="st">"SW"</span>,</span>
<span>              value <span class="op">=</span> <span class="fl">0.14</span>,</span>
<span>              min <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              max <span class="op">=</span> <span class="fl">2</span>,</span>
<span>              step <span class="op">=</span> <span class="fl">0.005</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span></span>
<span>        inputId <span class="op">=</span> <span class="st">"other_inputs"</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Reload other inputs"</span>,</span>
<span>        width <span class="op">=</span> <span class="st">"100%"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/tabsetPanel.html">tabsetPanel</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/nav-items.html">nav_panel</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"CW indication"</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"indication_cw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu">grid_container</span><span class="op">(</span></span>
<span>              layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"indication_summary_cw              indication_summary_cw     "</span>,</span>
<span>                <span class="st">"indication_calculations_support_cw indication_calculations_cw"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              gap_size <span class="op">=</span> <span class="st">"10px"</span>,</span>
<span>              col_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"1fr"</span>,</span>
<span>                <span class="st">"1fr"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              row_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"1fr"</span>,</span>
<span>                <span class="st">"1fr"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              <span class="fu">grid_card</span><span class="op">(</span></span>
<span>                area <span class="op">=</span> <span class="st">"indication_summary_cw"</span>,</span>
<span>                <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>                  <span class="fu"><a href="https://gt.rstudio.com/reference/gt_output.html">gt_output</a></span><span class="op">(</span></span>
<span>                                                        outputId <span class="op">=</span> <span class="st">"indication_summary_cw"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>              <span class="op">)</span>,</span>
<span>              <span class="fu">grid_card</span><span class="op">(</span></span>
<span>                area <span class="op">=</span> <span class="st">"indication_calculations_cw"</span>,</span>
<span>                <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>                  <span class="fu"><a href="https://gt.rstudio.com/reference/gt_output.html">gt_output</a></span><span class="op">(</span></span>
<span>                                                        outputId <span class="op">=</span> <span class="st">"indication_calculations_cw"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>              <span class="op">)</span>,</span>
<span>              <span class="fu">grid_card</span><span class="op">(</span></span>
<span>                area <span class="op">=</span> <span class="st">"indication_calculations_support_cw"</span>,</span>
<span>                <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>                  <span class="fu"><a href="https://gt.rstudio.com/reference/gt_output.html">gt_output</a></span><span class="op">(</span></span>
<span>                                                        outputId <span class="op">=</span> <span class="st">"indication_calculations_support_cw"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>              <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/nav-items.html">nav_panel</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"SW indication"</span>,</span>
<span>        <span class="fu">grid_card</span><span class="op">(</span></span>
<span>          area <span class="op">=</span> <span class="st">"indication_sw"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu">grid_container</span><span class="op">(</span></span>
<span>              layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"indication_summary_sw              indication_summary_sw     "</span>,</span>
<span>                <span class="st">"indication_calculations_support_sw indication_calculations_sw"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              row_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"1fr"</span>,</span>
<span>                <span class="st">"1fr"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              col_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"1fr"</span>,</span>
<span>                <span class="st">"1fr"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              gap_size <span class="op">=</span> <span class="st">"10px"</span>,</span>
<span>              <span class="fu">grid_card</span><span class="op">(</span></span>
<span>                area <span class="op">=</span> <span class="st">"indication_summary_sw"</span>,</span>
<span>                <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>                  <span class="fu"><a href="https://gt.rstudio.com/reference/gt_output.html">gt_output</a></span><span class="op">(</span></span>
<span>                                                        outputId <span class="op">=</span> <span class="st">"indication_summary_sw"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>              <span class="op">)</span>,</span>
<span>              <span class="fu">grid_card</span><span class="op">(</span></span>
<span>                area <span class="op">=</span> <span class="st">"indication_calculations_sw"</span>,</span>
<span>                <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>                  <span class="fu"><a href="https://gt.rstudio.com/reference/gt_output.html">gt_output</a></span><span class="op">(</span></span>
<span>                                                        outputId <span class="op">=</span> <span class="st">"indication_calculations_sw"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>              <span class="op">)</span>,</span>
<span>              <span class="fu">grid_card</span><span class="op">(</span></span>
<span>                area <span class="op">=</span> <span class="st">"indication_calculations_support_sw"</span>,</span>
<span>                <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html">card_body</a></span><span class="op">(</span></span>
<span>                  <span class="fu"><a href="https://gt.rstudio.com/reference/gt_output.html">gt_output</a></span><span class="op">(</span></span>
<span>                                                        outputId <span class="op">=</span> <span class="st">"indication_calculations_support_sw"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>              <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">### ---- Define server ----</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">### Recalculate things based on selections / inputs</span></span>
<span>  </span>
<span>  <span class="co"># calculate selected underlying PLR</span></span>
<span>  <span class="va">selection_underlying_plr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fl">1</span> <span class="op">/</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_lcm</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/bindEvent.html">bindEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_lcm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate evaluation date</span></span>
<span>  <span class="va">selection_eval_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/bindEvent.html">bindEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># display underlying PLR</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">selection_underlying_plr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Underlying PLR: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">selection_underlying_plr</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># input selections / input data after clicking action button</span></span>
<span>  <span class="co"># -&gt; loss development factors</span></span>
<span>  <span class="va">data_other_inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"app-inputs.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"long"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/bindEvent.html">bindEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">other_inputs</span>,</span>
<span>              ignoreNULL <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># value box</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indicated_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html">renderUI</a></span><span class="op">(</span></span>
<span>      </span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;h3 style = 'color: orange'&gt;Countrywide = "</span>, <span class="fu">data_indication3</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">indicated_rate_level_needed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"%&lt;/h3&gt;"</span>,</span>
<span>                  <span class="st">"&lt;h3 style = 'color: orange'&gt;"</span>, <span class="va">input</span><span class="op">$</span><span class="va">selection_state</span>, <span class="st">" = "</span>, <span class="fu">data_indication3</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">indicated_rate_level_needed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"%&lt;/h3&gt;"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Recalculate datasets now based on inputs</span></span>
<span>  </span>
<span>  <span class="co"># premium trend</span></span>
<span>  <span class="co"># -&gt; calculate Countrywide selections</span></span>
<span>  <span class="va">data_premium_trend_selected_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">0.035</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">1084</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>             selected <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">premium_trend_cw</span>,</span>
<span>             credibility_comp <span class="op">=</span> <span class="fl">0.016</span>,</span>
<span>             z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># premium trend</span></span>
<span>  <span class="co"># -&gt; calculate state selections and add back in Countrywide</span></span>
<span>  <span class="va">data_premium_trend_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_premium_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                 by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>,</span>
<span>                credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">earned_exposure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">0.035</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">1084</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">premium_trend_sw</span>,</span>
<span>             credibility_comp <span class="op">=</span> <span class="fu">data_premium_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">z_wtd_selected</span>,</span>
<span>             z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">data_premium_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># paid loss</span></span>
<span>  <span class="co"># -&gt; weighted development factors</span></span>
<span>  <span class="va">data_paid_loss_selects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">calculate_weighted_dev_factors</span><span class="op">(</span>df_loss_tri <span class="op">=</span> <span class="va">data_paid_loss_triangle</span>, selects <span class="op">=</span> <span class="fu">data_other_inputs</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">table</span> <span class="op">==</span> <span class="st">"loss development factors"</span>, <span class="va">key2</span> <span class="op">==</span> <span class="st">"Paid loss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># incurred loss</span></span>
<span>  <span class="co"># -&gt; weighted development factors</span></span>
<span>  <span class="va">data_incurred_loss_selects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">calculate_weighted_dev_factors</span><span class="op">(</span>df_loss_tri <span class="op">=</span> <span class="va">data_incurred_loss_triangle</span>, selects <span class="op">=</span> <span class="fu">data_other_inputs</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">table</span> <span class="op">==</span> <span class="st">"loss development factors"</span>, <span class="va">key2</span> <span class="op">==</span> <span class="st">"Incurred loss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># incurred claim count</span></span>
<span>  <span class="co"># -&gt; weighted development factors</span></span>
<span>  <span class="va">data_incurred_claim_count_selects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">calculate_weighted_dev_factors</span><span class="op">(</span>df_loss_tri <span class="op">=</span> <span class="va">data_incurred_claim_count_triangle</span>, selects <span class="op">=</span> <span class="fu">data_other_inputs</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">table</span> <span class="op">==</span> <span class="st">"loss development factors"</span>, <span class="va">key2</span> <span class="op">==</span> <span class="st">"Incurred claim count"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ultimate loss</span></span>
<span>  <span class="co"># -&gt; append age to ultimate factors and calculate ultimate losses </span></span>
<span>  <span class="va">data_ult_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">calculate_ultimate_incurred</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg</span>, df_selects <span class="op">=</span> <span class="fu">data_incurred_loss_selects</span><span class="op">(</span><span class="op">)</span>, var <span class="op">=</span> <span class="st">"incurred_loss"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_loss <span class="op">=</span> <span class="va">incurred</span>, incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_loss <span class="op">=</span> <span class="va">ult_incurred</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; summarize data by fiscal year</span></span>
<span>  <span class="va">data_ult_loss_fiscal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">summarize_by_fiscal_year</span><span class="op">(</span>df <span class="op">=</span> <span class="fu">data_ult_loss</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_loss <span class="op">=</span> <span class="va">var1_cumulative</span>, implied_incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_loss <span class="op">=</span> <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># claim count</span></span>
<span>  <span class="co"># -&gt; append age to ultimate factors and calculate ultimate claim count</span></span>
<span>  <span class="va">data_ult_claim_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">calculate_ultimate_incurred</span><span class="op">(</span>df_agg <span class="op">=</span> <span class="va">data_loss_agg</span>, df_selects <span class="op">=</span> <span class="fu">data_incurred_claim_count_selects</span><span class="op">(</span><span class="op">)</span>, var <span class="op">=</span> <span class="st">"incurred_claim_count"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_claim_count <span class="op">=</span> <span class="va">incurred</span>, implied_incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_claim_count <span class="op">=</span> <span class="va">ult_incurred</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; summarize data by fiscal year</span></span>
<span>  <span class="va">data_ult_claim_count_fiscal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">summarize_by_fiscal_year</span><span class="op">(</span>df <span class="op">=</span> <span class="fu">data_ult_claim_count</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>incurred_claim_count <span class="op">=</span> <span class="va">var1_cumulative</span>, implied_incurred_age_to_ult <span class="op">=</span> <span class="va">factor</span>, ult_incurred_claim_count <span class="op">=</span> <span class="va">var2_cumulative</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># frequency trend</span></span>
<span>  <span class="co"># -&gt; calculate Countrywide selections</span></span>
<span>  <span class="va">data_freq_trend_selected_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_freq_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>             selected <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">freq_trend_cw</span>,</span>
<span>             credibility_comp <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; calculate state selections and add back in Countrywide</span></span>
<span>  <span class="va">data_freq_trend_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_freq_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                 by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>,</span>
<span>                credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">freq_trend_sw</span>,</span>
<span>             credibility_comp <span class="op">=</span> <span class="fu">data_freq_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">z_wtd_selected</span>,</span>
<span>             z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">data_freq_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># severity trend</span></span>
<span>  <span class="co"># -&gt; calculate Countrywide selections</span></span>
<span>  <span class="va">data_sev_trend_selected_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_sev_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span>,</span>
<span>             selected <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">sev_trend_cw</span>,</span>
<span>             credibility_comp <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>             z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; calculate state selections and add back in Countrywide</span></span>
<span>  <span class="va">data_sev_trend_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_sev_trend_agg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                 by <span class="op">=</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>,</span>
<span>                credibility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">closed_w_pay_count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>selected <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">sev_trend_sw</span>,</span>
<span>             credibility_comp <span class="op">=</span> <span class="fu">data_sev_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">z_wtd_selected</span>,</span>
<span>             z_wtd_selected <span class="op">=</span> <span class="va">selected</span> <span class="op">*</span> <span class="va">credibility</span> <span class="op">+</span> <span class="va">credibility_comp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">credibility</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">data_sev_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># input selections / input data after clicking action button (again...)</span></span>
<span>  <span class="co"># -&gt; accident year weights</span></span>
<span>  <span class="va">selection_ay_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">data_ult_loss_fiscal</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ay_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu">data_other_inputs</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                                              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">table</span> <span class="op">==</span> <span class="st">"accident year weights"</span>, <span class="va">key1</span> <span class="op">==</span> <span class="st">"Statewide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                                              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">selection_ay_weights_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">data_ult_loss_fiscal</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ay_weights <span class="op">=</span> <span class="fu">data_other_inputs</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">table</span> <span class="op">==</span> <span class="st">"accident year weights"</span>, <span class="va">key1</span> <span class="op">==</span> <span class="st">"Complement"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Countrywide"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">selection_ay_weights2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">selection_ay_weights</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">selection_ay_weights_cw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># indication</span></span>
<span>  <span class="co"># -&gt; calculate indication table</span></span>
<span>  <span class="va">data_indication</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">data_premium_current_level_fiscal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span>, <span class="va">current_level_earned_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trend_time_premium <span class="op">=</span></span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">12</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">24</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">36</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="fl">48</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="fl">60</span></span>
<span>               <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">data_premium_trend_selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, prem_trend_z_wtd_selected <span class="op">=</span> <span class="va">z_wtd_selected</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>premium_trend_factors <span class="op">=</span> <span class="va">prem_trend_z_wtd_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="co"># raise_to_power(interval(ymd(selection_data_ended) %m-% years(5),</span></span>
<span>               <span class="co">#                         ymd(selection_effective_date) %m+% months(6)) %&gt;%</span></span>
<span>               <span class="co">#                  divide_by(years(1))) %&gt;% # more accurate way</span></span>
<span>               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_effective_date</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>,</span>
<span>                                       <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="va">trend_time_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                                <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">365</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span><span class="op">)</span>, <span class="co"># equivalent to excel</span></span>
<span>             trended_current_level_earned_premium <span class="op">=</span> <span class="va">current_level_earned_premium</span> <span class="op">*</span> <span class="va">premium_trend_factors</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">data_ult_loss_fiscal</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span>, <span class="va">incurred_loss</span>, <span class="va">implied_incurred_age_to_ult</span>, <span class="va">ult_incurred_loss</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">data_freq_trend_selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, freq_trend_z_wtd_selected <span class="op">=</span> <span class="va">z_wtd_selected</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">data_sev_trend_selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, sev_trend_z_wtd_selected <span class="op">=</span> <span class="va">z_wtd_selected</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trend_time_loss <span class="op">=</span></span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">6</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">18</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">30</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="fl">42</span>,</span>
<span>                 <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">fiscal_year_ended</span>, start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="fl">54</span></span>
<span>               <span class="op">)</span>,</span>
<span>             loss_trend_factors <span class="op">=</span> <span class="va">freq_trend_z_wtd_selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">sev_trend_z_wtd_selected</span></span>
<span>                           <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_effective_date</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>                                       <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span><span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="va">trend_time_loss</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                                <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">365</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span><span class="op">)</span>,</span>
<span>             trended_ult_incurred_loss <span class="op">=</span> <span class="va">ult_incurred_loss</span> <span class="op">*</span> <span class="va">loss_trend_factors</span>,</span>
<span>             trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">trended_current_level_earned_premium</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">trended_ult_incurred_loss</span> <span class="op">/</span> <span class="va">trended_current_level_earned_premium</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">selection_ay_weights2</span><span class="op">(</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">fiscal_year_ended</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; final indication calculations</span></span>
<span>  <span class="va">data_indication2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">data_indication</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>        .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>        .f <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>          </span>
<span>          <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html">%$%</a></span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">trended_ult_incurred_partial_loss_ratio</span>, <span class="va">ay_weights</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="va">return</span></span>
<span>          </span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html">reframe</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">data_ult_claim_count_fiscal</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">state</span>, ult_incurred_claim_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ult_incurred_claim_count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>credibility <span class="op">=</span> <span class="va">ult_incurred_claim_count</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fl">1084</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">credibility</span><span class="op">)</span>,</span>
<span>                by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">data_cat</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_modeled_peril_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">modeled_hurricane_ratio</span>, <span class="va">modeled_fire_following_earthquake_ratio</span>, <span class="va">modeled_severe_convective_storm_ratio</span>, <span class="va">modeled_wildfire_ratio</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.15</span>,</span>
<span>             trended_underlying_plr_less_modeled_perils <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>               <span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="fu">selection_underlying_plr</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                 <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">total_modeled_peril_partial_loss_ratio</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                 <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fu">data_freq_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                 <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fu">data_sev_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                               <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                 <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="fu">data_premium_trend_selected_cw</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                             <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>             credibility_weighted_trended_ult_incurred_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>               <span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="va">ay_weighted_trended_ult_incurred_partial_loss_ratio</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                 <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                 <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="va">trended_underlying_plr_less_modeled_perils</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                       <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                                     <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; set constant</span></span>
<span>  <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">data_indication2</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Countrywide"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="va">as.numeric</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; continue final indication calculations</span></span>
<span>  <span class="va">data_indication3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">data_indication2</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cw_ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="fu">credibility_weighted_trended_ult_incurred_loss_ratio_cw</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        .default <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>        credibility_weighted_trended_ult_incurred_loss_ratio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>          <span class="va">state</span> <span class="op">!=</span> <span class="st">"Countrywide"</span> <span class="op">~</span> <span class="va">ay_weighted_trended_ult_incurred_partial_loss_ratio</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="va">cw_ay_weighted_trended_ult_incurred_partial_loss_ratio</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                  <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                                <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">subtract</a></span><span class="op">(</span><span class="va">credibility</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          .default <span class="op">=</span> <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span></span>
<span>        <span class="op">)</span>,</span>
<span>        margin_for_reinsurance <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        total_prospective_loss_ratio <span class="op">=</span> <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span> <span class="op">+</span> <span class="va">total_modeled_peril_partial_loss_ratio</span> <span class="op">+</span> <span class="va">margin_for_reinsurance</span>,</span>
<span>        permissable_loss_ratio <span class="op">=</span> <span class="fl">0.601</span>,</span>
<span>        indicated_rate_level_needed <span class="op">=</span> <span class="va">total_prospective_loss_ratio</span> <span class="op">/</span> <span class="va">permissable_loss_ratio</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># -&gt; organize, convert to long data, and reformat variable names for displaying</span></span>
<span>  <span class="va">data_indication3_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">data_indication3</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">ay_weighted_trended_ult_incurred_partial_loss_ratio</span>, <span class="va">credibility</span>, <span class="va">trended_underlying_plr_less_modeled_perils</span>, <span class="va">cw_ay_weighted_trended_ult_incurred_partial_loss_ratio</span>, <span class="va">credibility_weighted_trended_ult_incurred_loss_ratio</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"modeled"</span><span class="op">)</span>, <span class="va">total_modeled_peril_partial_loss_ratio</span>, <span class="va">margin_for_reinsurance</span>, <span class="va">total_prospective_loss_ratio</span>, <span class="va">permissable_loss_ratio</span>, <span class="va">indicated_rate_level_needed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                   names_to <span class="op">=</span> <span class="st">"variable"</span>,</span>
<span>                   values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>variable_display <span class="op">=</span> </span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="op">~</span> <span class="st">"Accident year weighted trended ultimate incurred partial loss ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"credibility"</span> <span class="op">~</span> <span class="st">"Credibility (ultimate claims using 1,084 standard):"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"trended_underlying_plr_less_modeled_perils"</span> <span class="op">~</span> <span class="st">"Trended, underlying permissible loss ratio less modeled perils:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"cw_ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="op">~</span> <span class="st">"Countrywide accident year weighted trended ultimate ncurred partial loss + LAE ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"credibility_weighted_trended_ult_incurred_loss_ratio"</span> <span class="op">~</span> <span class="st">"Credibility weighted trended ultimate incurred loss + LAE ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_hurricane_ratio"</span> <span class="op">~</span> <span class="st">"Modeled hurricane ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_fire_following_earthquake_ratio"</span> <span class="op">~</span> <span class="st">"Modeled fire following earthquake ratio:"</span>, </span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_severe_convective_storm_ratio"</span> <span class="op">~</span> <span class="st">"Modeled severe convective storm ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"modeled_wildfire_ratio"</span> <span class="op">~</span> <span class="st">"Modeled wildfire ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"total_modeled_peril_partial_loss_ratio"</span> <span class="op">~</span> <span class="st">"Total modeled peril partial loss + LAE ratio (modeled ratios x 1.15 LAE factor):"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"margin_for_reinsurance"</span> <span class="op">~</span> <span class="st">"Margin for reinsurance:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"total_prospective_loss_ratio"</span> <span class="op">~</span> <span class="st">"Total prospective loss + LAE ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"permissable_loss_ratio"</span> <span class="op">~</span> <span class="st">"Permissable loss + LAE ratio:"</span>,</span>
<span>                 <span class="va">variable</span> <span class="op">==</span> <span class="st">"indicated_rate_level_needed"</span> <span class="op">~</span> <span class="st">"Indicated rate level needed:"</span></span>
<span>               <span class="op">)</span>,</span>
<span>             .after <span class="op">=</span> <span class="va">variable</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Display results</span></span>
<span>  </span>
<span>  <span class="co"># countrywide indication summary table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indication_summary_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gt.rstudio.com/reference/render_gt.html">render_gt</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="fu">format_as_indication_summary</span><span class="op">(</span>data_ind <span class="op">=</span> <span class="fu">data_indication</span><span class="op">(</span><span class="op">)</span>, sel_state <span class="op">=</span> <span class="st">"Countrywide"</span>, sel_data_ended <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span>, sel_eval_date <span class="op">=</span> <span class="fu">selection_eval_date</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># countrywide indication calculations table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indication_calculations_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gt.rstudio.com/reference/render_gt.html">render_gt</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="fu">format_as_indication_calculations</span><span class="op">(</span>data_ind3_long <span class="op">=</span> <span class="fu">data_indication3_long</span><span class="op">(</span><span class="op">)</span>, sel_state <span class="op">=</span> <span class="st">"Countrywide"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># countrywide indication calculations supporting table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indication_calculations_support_cw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gt.rstudio.com/reference/render_gt.html">render_gt</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="fu">format_as_indication_calculations_support</span><span class="op">(</span>data_ind3_long <span class="op">=</span> <span class="fu">data_indication3_long</span><span class="op">(</span><span class="op">)</span>, sel_state <span class="op">=</span> <span class="st">"Countrywide"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># statewide indication summary table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indication_summary_sw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gt.rstudio.com/reference/render_gt.html">render_gt</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="fu">format_as_indication_summary</span><span class="op">(</span>data_ind <span class="op">=</span> <span class="fu">data_indication</span><span class="op">(</span><span class="op">)</span>, sel_state <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_state</span>, sel_data_ended <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_data_ended</span>, sel_eval_date <span class="op">=</span> <span class="fu">selection_eval_date</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># statewide indication calculations table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indication_calculations_sw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gt.rstudio.com/reference/render_gt.html">render_gt</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="fu">format_as_indication_calculations</span><span class="op">(</span>data_ind3_long <span class="op">=</span> <span class="fu">data_indication3_long</span><span class="op">(</span><span class="op">)</span>, sel_state <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_state</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># statewide indication calculations supporting table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indication_calculations_support_sw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://gt.rstudio.com/reference/render_gt.html">render_gt</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="fu">format_as_indication_calculations_support</span><span class="op">(</span>data_ind3_long <span class="op">=</span> <span class="fu">data_indication3_long</span><span class="op">(</span><span class="op">)</span>, sel_state <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">selection_state</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./sql.html" class="pagination-link" aria-label="SQL">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">SQL</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># R</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stillwater </span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tiering analysis - Claims</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages and define functions ---- </span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to set close information to latest transaction where running case reserve is zero</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>set_claim_close_info <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">flag_nonzero_case_res_rsum =</span> <span class="fu">cumsum</span>(case_res_rsum <span class="sc">!=</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">.by =</span> flag_nonzero_case_res_rsum,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">row_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(flag_nonzero_case_res_rsum <span class="sc">==</span> <span class="fu">max</span>(flag_nonzero_case_res_rsum),</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>           row_id <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">claim_close =</span> <span class="dv">1</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">close_date =</span> <span class="fu">as.character.POSIXt</span>(transaction_date),</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">.keep =</span> <span class="st">"unused"</span>) <span class="sc">%&gt;%</span> <span class="co"># just doesn't add rows if no data returned from previous step ==&gt; claim_close = NA</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    {. <span class="ot">-&gt;&gt;</span> tmp} <span class="sc">%&gt;%</span> </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"transaction"</span>), claim_close) <span class="sc">%&gt;%</span> </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">right_join</span>(df, <span class="at">by =</span> <span class="fu">join_by</span>(transaction_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">claim_close =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(claim_close), <span class="dv">0</span>, claim_close),</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">close_date =</span> <span class="fu">ifelse</span>(<span class="fu">is_empty</span>(tmp<span class="sc">$</span>close_date), <span class="cn">NA</span>, tmp<span class="sc">$</span>close_date)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(transaction_date, transaction_id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(transaction_id, <span class="at">.before =</span> transaction_date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(close_date, <span class="at">.after=</span> loss_date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(claim_close, <span class="at">.after =</span> transaction_date)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load data: SQL ----</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="co"># establish connection</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(),</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Driver =</span> <span class="st">"SQL Server"</span>,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Server =</span> <span class="st">"XXXXXXXXX</span><span class="sc">\\</span><span class="st">XXXXXXX"</span>,</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>                      <span class="at">trusted_connection =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="co"># run queries to get raw data from AS400</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; MTD claims data</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>data_claims_mtd_raw <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="st">"select * from pricing.CLT.tiering_analysis_BPCLM_raw"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_pull_date =</span> <span class="fu">ymd</span>(data_pull_date),</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">peril_code =</span> <span class="fu">trimws</span>(peril_code))</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; transactional claims data</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>data_claims_tr_raw <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="st">"select * from pricing.CLT.tiering_analysis_BPCLMTR_raw"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_pull_date =</span> data_pull_date <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="co"># close connection</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Modify transactional claims data ----</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="co"># modify transactional claims data</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate running sums (used to calculate indicators)</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate closing information</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; summarize by claim</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>data_claims_tr <span class="ot">&lt;-</span> data_claims_tr_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> <span class="fu">c</span>(data_pull_date, policy_number, claim_no),</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(paid_loss, salv, subr, case_res, alae_paid, alae_rec, alae_res),</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">cumsum</span>(.x), <span class="dv">5</span>),</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>                <span class="at">.names =</span> <span class="st">"{.col}_rsum"</span>)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(data_pull_date, policy_number, claim_no) <span class="sc">%&gt;%</span> </span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">set_claim_close_info</span>(.x)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">claim_cwp =</span> <span class="fu">ifelse</span>(claim_close <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> paid_loss_rsum <span class="sc">-</span> salv_rsum <span class="sc">-</span> subr_rsum <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>         <span class="at">claim_cwop =</span> <span class="fu">ifelse</span>(claim_close <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> paid_loss_rsum <span class="sc">-</span> salv_rsum <span class="sc">-</span> subr_rsum <span class="sc">&lt;=</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(data_pull_date, policy_number, company, state, claim_no, iso_code),</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(<span class="fu">ends_with</span>(<span class="st">"date"</span>), <span class="sc">-</span>transaction_date), max),</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>            <span class="at">last_transaction_date =</span> <span class="fu">max</span>(transaction_date),</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(claim_close, claim_cwp, claim_cwop, paid_loss, salv, subr, case_res, alae_paid, alae_rec, alae_res), <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">sum</span>(.x), <span class="dv">5</span>)))</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Join data ----</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a><span class="co"># join claims datasets</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; data checks passed (only recent claim activity was different in terms of the financials)</span></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; so only keeping financial data from one source (OPEU123/6 rather than Majesco) and for non-close dates</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; but using Majesco as primary source for claim count data</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>data_claims <span class="ot">&lt;-</span> data_claims_mtd_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(data_claims_tr, <span class="at">by =</span> <span class="fu">join_by</span>(pol_num <span class="sc">==</span> policy_number, claim_num <span class="sc">==</span> claim_no)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate(check_paid_loss = paid_loss - mtd_paid_loss,</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_salv = salv - mtd_salv,</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_subr = subr - mtd_subr,</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_case_res = case_res - mtd_case_res,</span></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_alae_paid = alae_paid - mtd_alae_paid,</span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_alae_res = alae_res - mtd_alae_res,</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_inc_loss = round(mtd_paid_loss - mtd_salv - mtd_subr + mtd_case_res - mtd_inc_loss, 5),</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_loss_date = loss_date - ymd(as.Date(acc_date)),</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        check_rep_date = ymd(as.Date(rep_date)) - reported_date)</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pol_state =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(pol_state), pol_state, state),</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>         <span class="at">company =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(company.x), company.x, company.y),</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>         <span class="at">term_eff_date =</span> term_eff_date <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>         <span class="at">acc_date =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(acc_date), acc_date, loss_date) <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>         <span class="at">rep_date =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(rep_date), rep_date, reported_date) <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>         <span class="at">close_date =</span> close_date <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>         <span class="at">last_transaction_date =</span> last_transaction_date <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>         <span class="at">claim_close =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(claim_close), claim_close, <span class="fu">ifelse</span>(mtd_case_res <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)),</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>         <span class="at">paid_loss_mtd =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(mtd_paid_loss), mtd_paid_loss, paid_loss),</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>         <span class="at">salv_mtd =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(mtd_salv), mtd_salv, salv),</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>         <span class="at">subr_mtd =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(mtd_subr), mtd_subr, subr),</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>         <span class="at">case_res_mtd =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(mtd_case_res), mtd_case_res, case_res),</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>         <span class="at">alae_paid_mtd =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(mtd_alae_paid), mtd_alae_paid, alae_paid),</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>         <span class="at">alae_res_mtd =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(mtd_alae_res), mtd_alae_res, alae_res),</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>         <span class="at">claim_cwp =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(claim_cwp), claim_cwp, <span class="fu">ifelse</span>(claim_close <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> paid_loss_mtd <span class="sc">-</span> salv_mtd <span class="sc">-</span> subr_mtd <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>         <span class="at">claim_cwop =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(claim_cwop), claim_cwop, <span class="fu">ifelse</span>(claim_close <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> paid_loss_mtd <span class="sc">-</span> salv_mtd <span class="sc">-</span> subr_mtd <span class="sc">&lt;=</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pol_num, claim_num, company, pol_state, term_eff_date, acc_date, rep_date, close_date, last_transaction_date, iso_code, peril_code, claim_close, claim_cwp, claim_cwop, <span class="at">orig_loss_res_mtd =</span> mtd_orig_loss_res, paid_loss_mtd, salv_mtd, subr_mtd, case_res_mtd, alae_paid_mtd, <span class="at">alae_rec_mtd =</span> alae_rec, alae_res_mtd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_pull_date =</span> <span class="fu">unique</span>(data_claims_mtd_raw<span class="sc">$</span>data_pull_date), <span class="co"># not sure why pulling the date from either data source isn't working, just assuming both pulled same day</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>         <span class="at">peril_code =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>           peril_code <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"HAIL"</span>, <span class="st">"LIGHTNING"</span>, <span class="st">"WIND"</span>) <span class="sc">~</span> <span class="st">"WIND"</span>,</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>           <span class="fu">is.na</span>(peril_code) <span class="sc">~</span> <span class="st">"NOT_RECORDED"</span>,</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>           peril_code <span class="sc">==</span> <span class="st">""</span> <span class="sc">~</span> <span class="st">"NOT_RECORDED"</span>,</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> peril_code</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>         )) <span class="sc">%&gt;%</span> </span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(last_transaction_date) <span class="sc">&gt;=</span> <span class="dv">2015</span>) <span class="co"># last 10 years of data</span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="co"># save and write results</span></span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_claims, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_claims.RData"</span>)</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="co"># write to csv so can upload flat file into sql</span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; just file and save as .xlsx into 'Colton Analyses' folder for David</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(data_claims, <span class="at">file =</span> <span class="st">"Excel data</span><span class="sc">\\</span><span class="st">data_claims.csv"</span>, <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Actuarially modify claims data ----</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a><span class="co"># load data with calculated term IDs</span></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_claims.RData"</span>)</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a><span class="co"># remove missing data claims</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>data_claims <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(paid_loss_mtd))</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a><span class="co"># look at CAT claims</span></span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>data_claims_cat <span class="ot">&lt;-</span> data_claims <span class="sc">%&gt;%</span> </span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(iso_code))</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a><span class="co"># remove CATs</span></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>data_claims_non_cats <span class="ot">&lt;-</span> data_claims <span class="sc">%&gt;%</span> </span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(iso_code))</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="co"># read in LDFs</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; source: in 'Indications q4 2024 eval q1 2025.xlsx'</span></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; </span><span class="al">NOTE</span><span class="co">: these are non-CAT LDFs</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>data_ldfs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>data_ldfs<span class="sc">$</span>incurred_loss <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"LDFs.xlsx"</span>,</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">sheet =</span> <span class="st">"incurred_loss"</span>)</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>data_ldfs<span class="sc">$</span>incurred_claim_count <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"LDFs.xlsx"</span>,</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">sheet =</span> <span class="st">"incurred_claim_count"</span>)</span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; reformat</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>data_ldfs <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="cf">function</span>(df) {</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span> </span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"age_to_age"</span>, <span class="at">values_to =</span> <span class="st">"ldf"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">age_to_age =</span> <span class="fu">str_sub</span>(age_to_age, <span class="at">start =</span> <span class="dv">5</span>, <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">str_replace</span>(., <span class="st">"_to_"</span>, <span class="st">":"</span>),</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>             <span class="at">row_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(<span class="fu">desc</span>(row_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">cdf =</span> <span class="fu">cumprod</span>(ldf)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">age =</span> age_to_age <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="dv">1</span>, <span class="fu">str_locate</span>(., <span class="st">":"</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> .[<span class="dv">1</span>] <span class="sc">%&gt;%</span> as.numeric) <span class="sc">%&gt;%</span> </span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a>      ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(row_id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>row_id)</span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="co"># develop claims to ultimate individually</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate age (rounded to the nearest 3 month period (i.e. quarter))</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; as-of-date is the start of the future policy period (described below)</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>as_of_date_age <span class="ot">&lt;-</span> <span class="st">"2025-11-03"</span> <span class="sc">%&gt;%</span> ymd <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="fu">months</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> {<span class="fu">paste</span>(<span class="fu">year</span>(.), <span class="fu">month</span>(.), <span class="st">"1"</span>, <span class="at">sep =</span> <span class="st">"-"</span>)} <span class="sc">%&gt;%</span> ymd</span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>data_claims_non_cats_ult <span class="ot">&lt;-</span> data_claims_non_cats <span class="sc">%&gt;%</span> </span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">interval</span>(acc_date, as_of_date_age) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="fu">months</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> as.numeric <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> ceiling <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>  rowwise <span class="sc">%&gt;%</span> </span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_join =</span> <span class="fu">min</span>(age, <span class="fu">max</span>(data_ldfs<span class="sc">$</span>incurred_loss<span class="sc">$</span>age))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ldfs<span class="sc">$</span>incurred_loss <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, <span class="at">cdf_incurred_loss =</span> cdf), <span class="at">by =</span> <span class="fu">join_by</span>(age_join <span class="sc">==</span> age)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ldfs<span class="sc">$</span>incurred_claim_count <span class="sc">%&gt;%</span> <span class="fu">select</span>(age, <span class="at">cdf_incurred_claim_count =</span> cdf), <span class="at">by =</span> <span class="fu">join_by</span>(age_join <span class="sc">==</span> age)) <span class="sc">%&gt;%</span></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>age_join) <span class="sc">%&gt;%</span> </span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>  rowwise <span class="sc">%&gt;%</span> </span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incurred_loss =</span> <span class="fu">sum</span>(paid_loss_mtd, case_res_mtd, alae_paid_mtd, alae_res_mtd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">sum</span>(salv_mtd, subr_mtd, alae_rec_mtd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>         <span class="at">incurred_claim_count =</span> <span class="fu">sum</span>(claim_close, <span class="dv">1</span> <span class="sc">-</span> claim_close), <span class="co"># add close and open claim counts ==&gt; results in 1 for every record cause we have data at claim level</span></span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>         <span class="at">ult_incurred_loss =</span> <span class="fu">round</span>(incurred_loss <span class="sc">*</span> cdf_incurred_loss, <span class="dv">2</span>),</span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>         <span class="at">ult_claim_count =</span> <span class="fu">round</span>(incurred_claim_count <span class="sc">*</span> cdf_incurred_claim_count, <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>  ungroup</span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a><span class="co"># trend claims individually</span></span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; trend selects pulled from 'Indications q4 2024 eval q1 2025.xlsx' for MA</span></span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; future policy period = 12/01/2025 - 12/01/2026 ==&gt; avg accident date = 12/01/2026</span></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>trend_freq <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.01868</span></span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a>trend_sev <span class="ot">&lt;-</span> <span class="fl">0.08833</span></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>avg_acc_date_trend <span class="ot">&lt;-</span> as_of_date_age <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>)</span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>data_claims_non_cats_ult_trended <span class="ot">&lt;-</span> data_claims_non_cats_ult <span class="sc">%&gt;%</span> </span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">loss_trend_factor =</span> trend_freq <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>           <span class="fu">multiply_by</span>(trend_sev <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>           <span class="fu">raise_to_power</span>(<span class="fu">interval</span>(acc_date, avg_acc_date_trend) <span class="sc">/</span> <span class="fu">years</span>(<span class="dv">1</span>)),</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>         <span class="at">trended_ult_incurred_loss =</span> <span class="fu">round</span>(ult_incurred_loss <span class="sc">*</span> loss_trend_factor, <span class="dv">2</span>))</span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a><span class="co"># cap large losses</span></span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>data_claims_non_cats_ult_trended_capped <span class="ot">&lt;-</span> data_claims_non_cats_ult_trended <span class="sc">%&gt;%</span> </span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trended_ult_incurred_loss_capped =</span> <span class="fu">ifelse</span>(trended_ult_incurred_loss <span class="sc">&gt;</span> <span class="dv">100000</span>, <span class="dv">100000</span>, trended_ult_incurred_loss))</span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a><span class="co"># reformat trended ult loss as by-peril</span></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate capped losses (still keeping original losses though)</span></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; first aggregate over term effective date (i.e. policy period)</span></span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>data_claims_non_cats_ult_trended_capped_by_peril <span class="ot">&lt;-</span> data_claims_non_cats_ult_trended_capped <span class="sc">%&gt;%</span> </span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(data_pull_date, pol_num, company, pol_state, term_eff_date, peril_code),</span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"trended_ult_incurred_loss"</span>), incurred_claim_count), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> peril_code, <span class="at">values_from =</span> <span class="fu">c</span>(incurred_claim_count, trended_ult_incurred_loss, trended_ult_incurred_loss_capped)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a>  rowwise <span class="sc">%&gt;%</span> </span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incurred_claim_count =</span> <span class="fu">sum</span>(<span class="st">`</span><span class="at">incurred_claim_count_OTHER</span><span class="st">`</span>,</span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_LIABILITY</span><span class="st">`</span>,</span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_WATERNONWEATHER</span><span class="st">`</span>,</span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_THEFT</span><span class="st">`</span>,</span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_WIND</span><span class="st">`</span>,</span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_WATERWEATHER</span><span class="st">`</span>,</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_NOT_RECORDED</span><span class="st">`</span>,</span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_FIRE</span><span class="st">`</span>,</span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">`</span><span class="at">incurred_claim_count_HURRICANE</span><span class="st">`</span>,</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>         <span class="at">.after =</span> term_eff_date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"trended_ult_incurred_loss_"</span>, <span class="st">"peril_"</span>), <span class="fu">starts_with</span>(<span class="st">"trended_ult_incurred_loss_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_to_lower</span>(.x), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>))</span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_claims_non_cats_ult_trended_capped_by_peril, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_claims_non_cats_ult_trended_capped_by_peril.RData"</span>)</span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load actuarially modified data: RData ----</span></span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a><span class="co"># load data with calculated term IDs</span></span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_claims_non_cats_ult_trended_capped_by_peril.RData"</span>)</span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tiering analysis - Exposure</span></span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages and define functions ---- </span></span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to modify exposure data</span></span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a>modify_exposure_data <span class="ot">&lt;-</span> <span class="cf">function</span>(df_policy, df_expos) {</span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a>  <span class="co"># split policy data based on if / when renewed with lapse</span></span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a>  df_policy_split <span class="ot">=</span> df_policy <span class="sc">%&gt;%</span> </span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest_by</span>(<span class="at">term_eff_month =</span> <span class="fu">month</span>(term_eff_date), <span class="at">term_eff_day =</span> <span class="fu">day</span>(term_eff_date))</span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-266"><a href="#cb12-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># duplicate exposure data</span></span>
<span id="cb12-267"><a href="#cb12-267" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; add term_num_id and corresponding term_eff_date</span></span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate modified exposures</span></span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a>  df_expos_dup_mod <span class="ot">=</span> df_policy_split <span class="sc">%&gt;%</span> </span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2</span>(<span class="at">.x =</span> <span class="fu">list</span>(data), <span class="at">.y =</span> <span class="fu">list</span>(df_expos), \(df_p, df_expos, last_month_exposure_data) <span class="fu">duplicate_rows</span>(df_p, df_expos, <span class="at">last_month_expos_data =</span> last_month_expos_data))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a>    ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a>    calc_term_num_id <span class="sc">%&gt;%</span> </span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(df_policy <span class="sc">%&gt;%</span> <span class="fu">select</span>(term_eff_date, cancel_date, term_num_id), <span class="at">by =</span> <span class="fu">join_by</span>(term_num_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a>    calc_modified_expos <span class="sc">%&gt;%</span> </span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(term_eff_month, term_eff_day)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(term_num_id, <span class="at">.before =</span> term_month_id)</span>
<span id="cb12-278"><a href="#cb12-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-279"><a href="#cb12-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add check for when modified exposure</span></span>
<span id="cb12-280"><a href="#cb12-280" aria-hidden="true" tabindex="-1"></a>  df_expos_dup_mod <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-281"><a href="#cb12-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(df_expos <span class="sc">%&gt;%</span> <span class="fu">select</span>(calyr, calmth, exposyr) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">exposyr_orig =</span> exposyr), <span class="at">by =</span> <span class="fu">join_by</span>(calyr, calmth)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-282"><a href="#cb12-282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">check =</span> exposyr <span class="sc">==</span> exposyr_orig)</span>
<span id="cb12-283"><a href="#cb12-283" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-284"><a href="#cb12-284" aria-hidden="true" tabindex="-1"></a>  <span class="co"># correct exposures for cancel in first month of renewal term</span></span>
<span id="cb12-285"><a href="#cb12-285" aria-hidden="true" tabindex="-1"></a>  last_row <span class="ot">=</span> df_expos_dup_mod <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb12-286"><a href="#cb12-286" aria-hidden="true" tabindex="-1"></a>  nrows <span class="ot">=</span> <span class="fu">nrow</span>(df_expos_dup_mod)</span>
<span id="cb12-287"><a href="#cb12-287" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nrows <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> last_row<span class="sc">$</span>term_month_id <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(last_row<span class="sc">$</span>cancel_date) <span class="sc">&amp;</span> <span class="fu">month</span>(last_row<span class="sc">$</span>cancel_date) <span class="sc">==</span> <span class="fu">month</span>(last_row<span class="sc">$</span>term_eff_date)) {</span>
<span id="cb12-288"><a href="#cb12-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-289"><a href="#cb12-289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get exposure info</span></span>
<span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; first have to reset exposyr to its original value (was portioned out wrong)</span></span>
<span id="cb12-291"><a href="#cb12-291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; modify total days based on cancellation date </span></span>
<span id="cb12-292"><a href="#cb12-292" aria-hidden="true" tabindex="-1"></a>    expos_info <span class="ot">=</span> last_row <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">exposyr =</span> exposyr_orig) <span class="sc">%&gt;%</span> <span class="fu">extract_expos_info</span>()</span>
<span id="cb12-293"><a href="#cb12-293" aria-hidden="true" tabindex="-1"></a>    expos_info<span class="sc">$</span>total_days <span class="ot">=</span> <span class="fu">day</span>(df_expos_dup_mod[nrows,<span class="st">"cancel_date"</span>]<span class="sc">$</span>cancel_date) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-294"><a href="#cb12-294" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-295"><a href="#cb12-295" aria-hidden="true" tabindex="-1"></a>    <span class="co"># portion out the 13 term_month_id (if it gets there)</span></span>
<span id="cb12-296"><a href="#cb12-296" aria-hidden="true" tabindex="-1"></a>    df_expos_dup_mod[nrows<span class="dv">-1</span>,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>(.<span class="sc">$</span>days_of_coverage <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-297"><a href="#cb12-297" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-298"><a href="#cb12-298" aria-hidden="true" tabindex="-1"></a>    <span class="co"># portion out the 1 term_month_id</span></span>
<span id="cb12-299"><a href="#cb12-299" aria-hidden="true" tabindex="-1"></a>    df_expos_dup_mod[nrows,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>((.<span class="sc">$</span>total_days <span class="sc">-</span> .<span class="sc">$</span>days_of_coverage) <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-300"><a href="#cb12-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-301"><a href="#cb12-301" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-302"><a href="#cb12-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-303"><a href="#cb12-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_expos_dup_mod)</span>
<span id="cb12-304"><a href="#cb12-304" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-306"><a href="#cb12-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-307"><a href="#cb12-307" aria-hidden="true" tabindex="-1"></a><span class="co"># define second function to correctly duplicate rows</span></span>
<span id="cb12-308"><a href="#cb12-308" aria-hidden="true" tabindex="-1"></a>duplicate_rows <span class="ot">&lt;-</span> <span class="cf">function</span>(df_p, df_expos, last_month_expos_data) {</span>
<span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-310"><a href="#cb12-310" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define endpoints of time interval</span></span>
<span id="cb12-311"><a href="#cb12-311" aria-hidden="true" tabindex="-1"></a>  begin_year <span class="ot">=</span> <span class="fu">min</span>(df_p<span class="sc">$</span>term_eff_date) <span class="sc">%&gt;%</span> year</span>
<span id="cb12-312"><a href="#cb12-312" aria-hidden="true" tabindex="-1"></a>  begin_month <span class="ot">=</span> <span class="fu">min</span>(df_p<span class="sc">$</span>term_eff_date) <span class="sc">%&gt;%</span> month</span>
<span id="cb12-313"><a href="#cb12-313" aria-hidden="true" tabindex="-1"></a>  end_year <span class="ot">=</span> <span class="fu">max</span>(df_p<span class="sc">$</span>term_exp_date) <span class="sc">%&gt;%</span> year</span>
<span id="cb12-314"><a href="#cb12-314" aria-hidden="true" tabindex="-1"></a>  end_month <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">day</span>(<span class="fu">max</span>(df_p<span class="sc">$</span>term_exp_date)) <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">max</span>(df_p<span class="sc">$</span>term_exp_date) <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> month,  <span class="fu">max</span>(df_p<span class="sc">$</span>term_exp_date) <span class="sc">%&gt;%</span> month)</span>
<span id="cb12-315"><a href="#cb12-315" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-316"><a href="#cb12-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get exposure data within interval of interest</span></span>
<span id="cb12-317"><a href="#cb12-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; also add common variables for next step</span></span>
<span id="cb12-318"><a href="#cb12-318" aria-hidden="true" tabindex="-1"></a>  df_e <span class="ot">=</span> df_expos <span class="sc">%&gt;%</span> </span>
<span id="cb12-319"><a href="#cb12-319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_id_total =</span> <span class="fu">row_number</span>(),</span>
<span id="cb12-320"><a href="#cb12-320" aria-hidden="true" tabindex="-1"></a>           <span class="at">nrows_total =</span> <span class="fu">max</span>(row_id_total)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-321"><a href="#cb12-321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">between</span>(calyr, begin_year, end_year)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-322"><a href="#cb12-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">keep =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-323"><a href="#cb12-323" aria-hidden="true" tabindex="-1"></a>      calyr <span class="sc">==</span> begin_year <span class="sc">&amp;</span> calmth <span class="sc">&lt;</span> begin_month <span class="sc">~</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-324"><a href="#cb12-324" aria-hidden="true" tabindex="-1"></a>      calyr <span class="sc">==</span> begin_year <span class="sc">&amp;</span> calmth <span class="sc">&gt;=</span> begin_month <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-325"><a href="#cb12-325" aria-hidden="true" tabindex="-1"></a>      <span class="fu">between</span>(calyr, begin_year <span class="sc">+</span> <span class="dv">1</span>, end_year <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-326"><a href="#cb12-326" aria-hidden="true" tabindex="-1"></a>      calyr <span class="sc">==</span> end_year <span class="sc">&amp;</span> calmth <span class="sc">&lt;=</span> end_month <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-327"><a href="#cb12-327" aria-hidden="true" tabindex="-1"></a>      calyr <span class="sc">==</span> end_year <span class="sc">&amp;</span> calmth <span class="sc">&gt;</span> end_month <span class="sc">~</span> <span class="cn">FALSE</span></span>
<span id="cb12-328"><a href="#cb12-328" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb12-329"><a href="#cb12-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(keep) <span class="sc">%&gt;%</span> </span>
<span id="cb12-330"><a href="#cb12-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>keep) <span class="sc">%&gt;%</span> </span>
<span id="cb12-331"><a href="#cb12-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">orig_eff_year =</span> <span class="fu">year</span>(<span class="fu">min</span>(df_p<span class="sc">$</span>term_eff_date)),</span>
<span id="cb12-332"><a href="#cb12-332" aria-hidden="true" tabindex="-1"></a>           <span class="at">last_eff_year =</span> <span class="fu">year</span>(<span class="fu">max</span>(df_p<span class="sc">$</span>term_eff_date)),</span>
<span id="cb12-333"><a href="#cb12-333" aria-hidden="true" tabindex="-1"></a>           <span class="at">term_eff_month =</span> <span class="fu">month</span>(<span class="fu">min</span>(df_p<span class="sc">$</span>term_eff_date)),</span>
<span id="cb12-334"><a href="#cb12-334" aria-hidden="true" tabindex="-1"></a>           <span class="at">term_eff_day =</span> <span class="fu">day</span>(<span class="fu">min</span>(df_p<span class="sc">$</span>term_eff_date)),</span>
<span id="cb12-335"><a href="#cb12-335" aria-hidden="true" tabindex="-1"></a>           <span class="at">row_id_subset =</span> <span class="fu">row_number</span>(),</span>
<span id="cb12-336"><a href="#cb12-336" aria-hidden="true" tabindex="-1"></a>           <span class="at">nrows_subset =</span> <span class="fu">max</span>(row_id_subset))</span>
<span id="cb12-337"><a href="#cb12-337" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-338"><a href="#cb12-338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">day</span>(<span class="fu">min</span>(df_p<span class="sc">$</span>term_eff_date)) <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb12-339"><a href="#cb12-339" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-340"><a href="#cb12-340" aria-hidden="true" tabindex="-1"></a>    <span class="co"># conditionally duplicate partial months</span></span>
<span id="cb12-341"><a href="#cb12-341" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; then reassign subset assign row ID and nrows_subset</span></span>
<span id="cb12-342"><a href="#cb12-342" aria-hidden="true" tabindex="-1"></a>    df_e_dup <span class="ot">=</span> df_e <span class="sc">%&gt;%</span> </span>
<span id="cb12-343"><a href="#cb12-343" aria-hidden="true" tabindex="-1"></a>      {. <span class="ot">-&gt;&gt;</span> tmp} <span class="sc">%&gt;%</span> </span>
<span id="cb12-344"><a href="#cb12-344" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(tmp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(calmth <span class="sc">==</span> term_eff_month, term_eff_day <span class="sc">!=</span> <span class="dv">1</span>, <span class="fu">between</span>(row_id_subset, <span class="dv">2</span>, nrows_subset<span class="dv">-1</span>))) <span class="sc">%&gt;%</span> <span class="co"># -&gt; duplicate records for "interim" ending partial months of the subset of rows</span></span>
<span id="cb12-345"><a href="#cb12-345" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(tmp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(calmth <span class="sc">==</span> term_eff_month, term_eff_day <span class="sc">!=</span> <span class="dv">1</span>, nrows_total <span class="sc">&gt;</span> <span class="dv">1</span>, row_id_total <span class="sc">==</span> nrows_total, last_eff_year <span class="sc">==</span> <span class="fu">year</span>(pmaccndte), term_eff_month <span class="sc">==</span> <span class="fu">month</span>(pmaccndte))) <span class="sc">%&gt;%</span> <span class="co"># -&gt; duplicate records for cancel first month of renewal term (but not cancel first month of original term)</span></span>
<span id="cb12-346"><a href="#cb12-346" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(tmp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(last_eff_year <span class="sc">==</span> <span class="fu">year</span>(<span class="fu">Sys.Date</span>()), term_eff_month <span class="sc">==</span> last_month_expos_data, term_eff_day <span class="sc">!=</span> <span class="dv">1</span>, row_id_total <span class="sc">==</span> nrows_total, nrows_total <span class="sc">!=</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="co"># -&gt; duplicate  for renew in last month of exposure data</span></span>
<span id="cb12-347"><a href="#cb12-347" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(calyr, calmth) <span class="sc">%&gt;%</span> </span>
<span id="cb12-348"><a href="#cb12-348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">row_id_subset =</span> <span class="fu">ifelse</span>(orig_eff_year <span class="sc">&gt;=</span> <span class="dv">2013</span>, <span class="fu">row_number</span>(), <span class="fu">ifelse</span>(term_eff_month <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">row_number</span>() <span class="sc">+</span> <span class="dv">13</span> <span class="sc">-</span> term_eff_month <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">row_number</span>() <span class="sc">+</span> <span class="dv">13</span> <span class="sc">-</span> term_eff_month)), <span class="co"># correct for policies that are mid-term when 2013-01-01 gets here</span></span>
<span id="cb12-349"><a href="#cb12-349" aria-hidden="true" tabindex="-1"></a>             <span class="at">nrows_subset =</span> <span class="fu">max</span>(row_id_subset),</span>
<span id="cb12-350"><a href="#cb12-350" aria-hidden="true" tabindex="-1"></a>             <span class="at">term_month_id =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-351"><a href="#cb12-351" aria-hidden="true" tabindex="-1"></a>               <span class="fu">leap_year</span>(orig_eff_year) <span class="sc">&amp;</span> term_eff_month <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> term_eff_day <span class="sc">==</span> <span class="dv">29</span> <span class="sc">&amp;</span> row_id_subset <span class="sc">%%</span> <span class="dv">13</span> <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">~</span> row_id_subset <span class="sc">%%</span> <span class="dv">13</span>,</span>
<span id="cb12-352"><a href="#cb12-352" aria-hidden="true" tabindex="-1"></a>               <span class="fu">leap_year</span>(orig_eff_year) <span class="sc">&amp;</span> term_eff_month <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> term_eff_day <span class="sc">==</span> <span class="dv">29</span> <span class="sc">&amp;</span> row_id_subset <span class="sc">%%</span> <span class="dv">13</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">13</span>,</span>
<span id="cb12-353"><a href="#cb12-353" aria-hidden="true" tabindex="-1"></a>               row_id_subset <span class="sc">%%</span> <span class="dv">13</span> <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">~</span> row_id_subset <span class="sc">%%</span> <span class="dv">13</span>,</span>
<span id="cb12-354"><a href="#cb12-354" aria-hidden="true" tabindex="-1"></a>               row_id_subset <span class="sc">%%</span> <span class="dv">13</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">13</span></span>
<span id="cb12-355"><a href="#cb12-355" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb12-356"><a href="#cb12-356" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-357"><a href="#cb12-357" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-358"><a href="#cb12-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-359"><a href="#cb12-359" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-360"><a href="#cb12-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-361"><a href="#cb12-361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># don't need to duplicate any rows</span></span>
<span id="cb12-362"><a href="#cb12-362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; reassign subset row ID</span></span>
<span id="cb12-363"><a href="#cb12-363" aria-hidden="true" tabindex="-1"></a>    df_e_dup <span class="ot">=</span> df_e <span class="sc">%&gt;%</span> </span>
<span id="cb12-364"><a href="#cb12-364" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">row_id_subset =</span> <span class="fu">ifelse</span>(orig_eff_year <span class="sc">&gt;=</span> <span class="dv">2013</span>, <span class="fu">row_number</span>(), <span class="fu">ifelse</span>(term_eff_month <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">row_number</span>() <span class="sc">+</span> <span class="dv">13</span> <span class="sc">-</span> term_eff_month <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">row_number</span>() <span class="sc">+</span> <span class="dv">13</span> <span class="sc">-</span> term_eff_month)), <span class="co"># correct for policies that are mid-term when 2013-01-01 gets here</span></span>
<span id="cb12-365"><a href="#cb12-365" aria-hidden="true" tabindex="-1"></a>             <span class="at">nrows_subset =</span> <span class="fu">max</span>(row_id_subset),</span>
<span id="cb12-366"><a href="#cb12-366" aria-hidden="true" tabindex="-1"></a>             <span class="at">term_month_id =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-367"><a href="#cb12-367" aria-hidden="true" tabindex="-1"></a>               row_id_subset <span class="sc">%%</span> <span class="dv">12</span> <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">~</span> row_id_subset <span class="sc">%%</span> <span class="dv">12</span>,</span>
<span id="cb12-368"><a href="#cb12-368" aria-hidden="true" tabindex="-1"></a>               row_id_subset <span class="sc">%%</span> <span class="dv">12</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">12</span>)</span>
<span id="cb12-369"><a href="#cb12-369" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-370"><a href="#cb12-370" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-371"><a href="#cb12-371" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-372"><a href="#cb12-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-373"><a href="#cb12-373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine results</span></span>
<span id="cb12-374"><a href="#cb12-374" aria-hidden="true" tabindex="-1"></a>  df_e_dup <span class="sc">%&lt;&gt;%</span>  </span>
<span id="cb12-375"><a href="#cb12-375" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"row_id_"</span>), <span class="fu">starts_with</span>(<span class="st">"nrows_"</span>), orig_eff_year, last_eff_year, term_eff_month, term_eff_day))</span>
<span id="cb12-376"><a href="#cb12-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-377"><a href="#cb12-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_e_dup)</span>
<span id="cb12-378"><a href="#cb12-378" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-379"><a href="#cb12-379" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-380"><a href="#cb12-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-381"><a href="#cb12-381" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to calculate term_num_id</span></span>
<span id="cb12-382"><a href="#cb12-382" aria-hidden="true" tabindex="-1"></a>calc_term_num_id <span class="ot">&lt;-</span> <span class="cf">function</span>(df_expos_dup) {</span>
<span id="cb12-383"><a href="#cb12-383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-384"><a href="#cb12-384" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize</span></span>
<span id="cb12-385"><a href="#cb12-385" aria-hidden="true" tabindex="-1"></a>  term_num_id <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb12-386"><a href="#cb12-386" aria-hidden="true" tabindex="-1"></a>  term_num_id_counter <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb12-387"><a href="#cb12-387" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-388"><a href="#cb12-388" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_expos_dup)) {</span>
<span id="cb12-389"><a href="#cb12-389" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-390"><a href="#cb12-390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># increase counter when term restarts</span></span>
<span id="cb12-391"><a href="#cb12-391" aria-hidden="true" tabindex="-1"></a>    term_num_id_counter <span class="ot">=</span> <span class="fu">ifelse</span>(df_expos_dup[i,<span class="st">"term_month_id"</span>] <span class="sc">==</span> <span class="dv">1</span>, term_num_id_counter <span class="sc">+</span> <span class="dv">1</span>, term_num_id_counter)</span>
<span id="cb12-392"><a href="#cb12-392" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-393"><a href="#cb12-393" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set new term number</span></span>
<span id="cb12-394"><a href="#cb12-394" aria-hidden="true" tabindex="-1"></a>    term_num_id[i] <span class="ot">=</span> term_num_id_counter</span>
<span id="cb12-395"><a href="#cb12-395" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-396"><a href="#cb12-396" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-397"><a href="#cb12-397" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-398"><a href="#cb12-398" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add term_num_id</span></span>
<span id="cb12-399"><a href="#cb12-399" aria-hidden="true" tabindex="-1"></a>  df_expos_dup <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-400"><a href="#cb12-400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">term_num_id =</span> term_num_id)</span>
<span id="cb12-401"><a href="#cb12-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-402"><a href="#cb12-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_expos_dup)</span>
<span id="cb12-403"><a href="#cb12-403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-404"><a href="#cb12-404" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-405"><a href="#cb12-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-406"><a href="#cb12-406" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to extract needed exposure information for a record</span></span>
<span id="cb12-407"><a href="#cb12-407" aria-hidden="true" tabindex="-1"></a>extract_expos_info <span class="ot">&lt;-</span> <span class="cf">function</span>(df_e_dup_i) {</span>
<span id="cb12-408"><a href="#cb12-408" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-409"><a href="#cb12-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate needed values</span></span>
<span id="cb12-410"><a href="#cb12-410" aria-hidden="true" tabindex="-1"></a>  begin_of_month <span class="ot">=</span> <span class="fu">make_date</span>(df_e_dup_i<span class="sc">$</span>calyr, df_e_dup_i<span class="sc">$</span>calmth, <span class="dv">1</span>)</span>
<span id="cb12-411"><a href="#cb12-411" aria-hidden="true" tabindex="-1"></a>  begin_of_next_month <span class="ot">=</span> begin_of_month <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span>
<span id="cb12-412"><a href="#cb12-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-413"><a href="#cb12-413" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create named list</span></span>
<span id="cb12-414"><a href="#cb12-414" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; endpoints, calculated number of days in the month of interest, set original exposure</span></span>
<span id="cb12-415"><a href="#cb12-415" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"begin_of_month"</span> <span class="ot">=</span> begin_of_month,</span>
<span id="cb12-416"><a href="#cb12-416" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"begin_of_next_month"</span> <span class="ot">=</span> begin_of_next_month,</span>
<span id="cb12-417"><a href="#cb12-417" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"total_days"</span> <span class="ot">=</span> <span class="fu">interval</span>(begin_of_month, begin_of_next_month) <span class="sc">/</span> <span class="fu">days</span>(<span class="dv">1</span>),</span>
<span id="cb12-418"><a href="#cb12-418" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"original_exposyr"</span> <span class="ot">=</span> df_e_dup_i<span class="sc">$</span>exposyr,</span>
<span id="cb12-419"><a href="#cb12-419" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"days_of_coverage"</span> <span class="ot">=</span> <span class="fu">day</span>(df_e_dup_i<span class="sc">$</span>term_eff_date) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb12-420"><a href="#cb12-420" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-421"><a href="#cb12-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb12-422"><a href="#cb12-422" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-423"><a href="#cb12-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-424"><a href="#cb12-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-425"><a href="#cb12-425" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to calculate modified exposures</span></span>
<span id="cb12-426"><a href="#cb12-426" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; input needs to have term_num_id added already</span></span>
<span id="cb12-427"><a href="#cb12-427" aria-hidden="true" tabindex="-1"></a>calc_modified_expos <span class="ot">&lt;-</span> <span class="cf">function</span>(df_expos_dup) {</span>
<span id="cb12-428"><a href="#cb12-428" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-429"><a href="#cb12-429" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conditionally portion out exposures</span></span>
<span id="cb12-430"><a href="#cb12-430" aria-hidden="true" tabindex="-1"></a>  df_expos_dup_mod <span class="ot">=</span> df_expos_dup <span class="sc">%&gt;%</span> </span>
<span id="cb12-431"><a href="#cb12-431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest_by</span>(term_num_id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-432"><a href="#cb12-432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map2</span>(<span class="at">.x =</span> <span class="fu">list</span>(data), <span class="at">.y =</span> term_num_id, <span class="cf">function</span>(df_e_dup, term_num_id, <span class="at">num_terms =</span> <span class="fu">max</span>(.<span class="sc">$</span>term_num_id)) {</span>
<span id="cb12-433"><a href="#cb12-433" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-434"><a href="#cb12-434" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (term_num_id <span class="sc">==</span> <span class="dv">1</span>) { <span class="co"># first_term_num_id</span></span>
<span id="cb12-435"><a href="#cb12-435" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-436"><a href="#cb12-436" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">year</span>(df_e_dup[<span class="dv">1</span>,<span class="st">"pmoeffdte"</span>]<span class="sc">$</span>pmoeffdte) <span class="sc">&lt;</span> <span class="dv">2015</span>) {</span>
<span id="cb12-437"><a href="#cb12-437" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-438"><a href="#cb12-438" aria-hidden="true" tabindex="-1"></a>          <span class="co"># conditionally portion out the 1 term_month_id for older policies</span></span>
<span id="cb12-439"><a href="#cb12-439" aria-hidden="true" tabindex="-1"></a>          <span class="co"># -&gt; back out starting exposures from prior terms that aren't in the policy data</span></span>
<span id="cb12-440"><a href="#cb12-440" aria-hidden="true" tabindex="-1"></a>          expos_info <span class="ot">=</span> <span class="fu">extract_expos_info</span>(df_e_dup[<span class="dv">1</span>,])</span>
<span id="cb12-441"><a href="#cb12-441" aria-hidden="true" tabindex="-1"></a>          df_e_dup[<span class="dv">1</span>,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>((.<span class="sc">$</span>total_days <span class="sc">-</span> .<span class="sc">$</span>days_of_coverage) <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-442"><a href="#cb12-442" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-443"><a href="#cb12-443" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-444"><a href="#cb12-444" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-445"><a href="#cb12-445" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only portion out if it gets there and if there are multiple terms</span></span>
<span id="cb12-446"><a href="#cb12-446" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(df_e_dup) <span class="sc">==</span> <span class="dv">13</span> <span class="sc">&amp;</span> num_terms <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb12-447"><a href="#cb12-447" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-448"><a href="#cb12-448" aria-hidden="true" tabindex="-1"></a>          <span class="co"># portion out the 13 term_month_id</span></span>
<span id="cb12-449"><a href="#cb12-449" aria-hidden="true" tabindex="-1"></a>          expos_info <span class="ot">=</span> <span class="fu">extract_expos_info</span>(df_e_dup[<span class="dv">13</span>,])</span>
<span id="cb12-450"><a href="#cb12-450" aria-hidden="true" tabindex="-1"></a>          df_e_dup[<span class="dv">13</span>,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>(.<span class="sc">$</span>days_of_coverage <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-451"><a href="#cb12-451" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-452"><a href="#cb12-452" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-453"><a href="#cb12-453" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-454"><a href="#cb12-454" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">between</span>(term_num_id, <span class="dv">2</span>, num_terms <span class="sc">-</span> <span class="dv">1</span>)) { <span class="co"># middle term_num_ids</span></span>
<span id="cb12-455"><a href="#cb12-455" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-456"><a href="#cb12-456" aria-hidden="true" tabindex="-1"></a>        <span class="co"># portion out the 1 term_month_id</span></span>
<span id="cb12-457"><a href="#cb12-457" aria-hidden="true" tabindex="-1"></a>        expos_info <span class="ot">=</span> <span class="fu">extract_expos_info</span>(df_e_dup[<span class="dv">1</span>,])</span>
<span id="cb12-458"><a href="#cb12-458" aria-hidden="true" tabindex="-1"></a>        df_e_dup[<span class="dv">1</span>,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>((.<span class="sc">$</span>total_days <span class="sc">-</span> .<span class="sc">$</span>days_of_coverage) <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-459"><a href="#cb12-459" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-460"><a href="#cb12-460" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(df_e_dup) <span class="sc">==</span> <span class="dv">13</span>) {</span>
<span id="cb12-461"><a href="#cb12-461" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-462"><a href="#cb12-462" aria-hidden="true" tabindex="-1"></a>          <span class="co"># portion out the 13 term_month_id (if it gets there)</span></span>
<span id="cb12-463"><a href="#cb12-463" aria-hidden="true" tabindex="-1"></a>          expos_info <span class="ot">=</span> <span class="fu">extract_expos_info</span>(df_e_dup[<span class="dv">13</span>,])</span>
<span id="cb12-464"><a href="#cb12-464" aria-hidden="true" tabindex="-1"></a>          df_e_dup[<span class="dv">13</span>,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>(.<span class="sc">$</span>days_of_coverage <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-465"><a href="#cb12-465" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-466"><a href="#cb12-466" aria-hidden="true" tabindex="-1"></a>        }    </span>
<span id="cb12-467"><a href="#cb12-467" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-468"><a href="#cb12-468" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> { <span class="co"># last term_num_id</span></span>
<span id="cb12-469"><a href="#cb12-469" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-470"><a href="#cb12-470" aria-hidden="true" tabindex="-1"></a>        <span class="co"># portion out the 1 term_month_id</span></span>
<span id="cb12-471"><a href="#cb12-471" aria-hidden="true" tabindex="-1"></a>        expos_info <span class="ot">=</span> <span class="fu">extract_expos_info</span>(df_e_dup[<span class="dv">1</span>,])</span>
<span id="cb12-472"><a href="#cb12-472" aria-hidden="true" tabindex="-1"></a>        df_e_dup[<span class="dv">1</span>,<span class="st">"exposyr"</span>] <span class="ot">=</span> expos_info <span class="sc">%&gt;%</span> {<span class="fu">round</span>((.<span class="sc">$</span>total_days <span class="sc">-</span> .<span class="sc">$</span>days_of_coverage) <span class="sc">/</span> .<span class="sc">$</span>total_days <span class="sc">*</span> .<span class="sc">$</span>original_exposyr, <span class="dv">5</span>)}</span>
<span id="cb12-473"><a href="#cb12-473" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-474"><a href="#cb12-474" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-475"><a href="#cb12-475" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-476"><a href="#cb12-476" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(df_e_dup)</span>
<span id="cb12-477"><a href="#cb12-477" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-478"><a href="#cb12-478" aria-hidden="true" tabindex="-1"></a>    })) <span class="sc">%&gt;%</span> </span>
<span id="cb12-479"><a href="#cb12-479" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-480"><a href="#cb12-480" aria-hidden="true" tabindex="-1"></a>    ungroup</span>
<span id="cb12-481"><a href="#cb12-481" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-482"><a href="#cb12-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_expos_dup_mod)</span>
<span id="cb12-483"><a href="#cb12-483" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-484"><a href="#cb12-484" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-485"><a href="#cb12-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-486"><a href="#cb12-486" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load data: SQL ----</span></span>
<span id="cb12-487"><a href="#cb12-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-488"><a href="#cb12-488" aria-hidden="true" tabindex="-1"></a><span class="co"># establish connection</span></span>
<span id="cb12-489"><a href="#cb12-489" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(),</span>
<span id="cb12-490"><a href="#cb12-490" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Driver =</span> <span class="st">"SQL Server"</span>,</span>
<span id="cb12-491"><a href="#cb12-491" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Server =</span> <span class="st">"sql22-jax</span><span class="sc">\\</span><span class="st">pricing"</span>,</span>
<span id="cb12-492"><a href="#cb12-492" aria-hidden="true" tabindex="-1"></a>                      <span class="at">trusted_connection =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-493"><a href="#cb12-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-494"><a href="#cb12-494" aria-hidden="true" tabindex="-1"></a><span class="co"># run query for policy data</span></span>
<span id="cb12-495"><a href="#cb12-495" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; already worked with and finalized data in SSMS</span></span>
<span id="cb12-496"><a href="#cb12-496" aria-hidden="true" tabindex="-1"></a>data_policy <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="st">"select * from pricing.CLT.tiering_analysis_BPPOL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-497"><a href="#cb12-497" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-498"><a href="#cb12-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_pull_date =</span> data_pull_date <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-499"><a href="#cb12-499" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(term_num_id, term_premium, term_fees, <span class="fu">ends_with</span>(<span class="st">"loi"</span>), <span class="fu">ends_with</span>(<span class="st">"ded"</span>), <span class="fu">ends_with</span>(<span class="st">"lmiit"</span>), payroll, adv_qt_days, num_sw_pols), as.numeric),</span>
<span id="cb12-500"><a href="#cb12-500" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(<span class="fu">ends_with</span>(<span class="st">"date"</span>), <span class="sc">-</span>data_pull_date), mdy),</span>
<span id="cb12-501"><a href="#cb12-501" aria-hidden="true" tabindex="-1"></a>         <span class="at">data_pull_date =</span> data_pull_date <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-502"><a href="#cb12-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">policy_data_pull_date =</span> data_pull_date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-503"><a href="#cb12-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(term_eff_date) <span class="sc">&gt;=</span> <span class="dv">2015</span>) <span class="sc">%&gt;%</span> <span class="co"># last 10 years of data</span></span>
<span id="cb12-504"><a href="#cb12-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> pol_num,</span>
<span id="cb12-505"><a href="#cb12-505" aria-hidden="true" tabindex="-1"></a>         <span class="at">term_num_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> <span class="co"># reassign term_num_id for better match to exposure data (i.e. starting anew at 2015/01/01)</span></span>
<span id="cb12-506"><a href="#cb12-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(pol_num, term_num_id)</span>
<span id="cb12-507"><a href="#cb12-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-508"><a href="#cb12-508" aria-hidden="true" tabindex="-1"></a><span class="co"># close connection</span></span>
<span id="cb12-509"><a href="#cb12-509" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb12-510"><a href="#cb12-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-511"><a href="#cb12-511" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load data: Databricks ----</span></span>
<span id="cb12-512"><a href="#cb12-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-513"><a href="#cb12-513" aria-hidden="true" tabindex="-1"></a><span class="co"># establish connection</span></span>
<span id="cb12-514"><a href="#cb12-514" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; !!! NEED TO HAVE .Renviron setup</span></span>
<span id="cb12-515"><a href="#cb12-515" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb12-516"><a href="#cb12-516" aria-hidden="true" tabindex="-1"></a>  odbc<span class="sc">::</span><span class="fu">databricks</span>(),</span>
<span id="cb12-517"><a href="#cb12-517" aria-hidden="true" tabindex="-1"></a>  <span class="at">httpPath =</span> <span class="st">"/sql/1.0/warehouses/XXXXXXXXXXXXXXXX"</span>,</span>
<span id="cb12-518"><a href="#cb12-518" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-519"><a href="#cb12-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-520"><a href="#cb12-520" aria-hidden="true" tabindex="-1"></a><span class="co"># run query</span></span>
<span id="cb12-521"><a href="#cb12-521" aria-hidden="true" tabindex="-1"></a>data_expos_raw <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb12-522"><a href="#cb12-522" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"select * </span></span>
<span id="cb12-523"><a href="#cb12-523" aria-hidden="true" tabindex="-1"></a><span class="st">                        from database.calmonth_exposure -- exposure file</span></span>
<span id="cb12-524"><a href="#cb12-524" aria-hidden="true" tabindex="-1"></a><span class="st">                        where left(PMPRFX,2) in ('BC','BP','CM','CZ','XC','ZC', 'ZP')</span></span>
<span id="cb12-525"><a href="#cb12-525" aria-hidden="true" tabindex="-1"></a><span class="st">                        order by POLNO, CALYR, CALMTH</span></span>
<span id="cb12-526"><a href="#cb12-526" aria-hidden="true" tabindex="-1"></a><span class="st">                        --limit 100</span></span>
<span id="cb12-527"><a href="#cb12-527" aria-hidden="true" tabindex="-1"></a><span class="st">                    "</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-528"><a href="#cb12-528" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-529"><a href="#cb12-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(pmprfx, pmplnr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-530"><a href="#cb12-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pmaccndte =</span> pmaccndte <span class="sc">%&gt;%</span> as.character.POSIXt <span class="sc">%&gt;%</span> as.Date <span class="sc">%&gt;%</span> ymd,</span>
<span id="cb12-531"><a href="#cb12-531" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(calyr, calmth), as.numeric)) <span class="sc">%&gt;%</span>  <span class="co"># removes cancels dates of 01/01/0001</span></span>
<span id="cb12-532"><a href="#cb12-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_pull_date =</span> <span class="fu">ymd</span>(<span class="fu">Sys.Date</span>()), <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-533"><a href="#cb12-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(pmteffdte) <span class="sc">&gt;=</span> <span class="dv">2015</span>) <span class="sc">%&gt;%</span> <span class="co"># last 10 years of data</span></span>
<span id="cb12-534"><a href="#cb12-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(pmoeffdte) <span class="sc">==</span> <span class="fu">month</span>(pmteffdte)) <span class="sc">%&gt;%</span> <span class="co"># filter out renew with lapse in different month (too difficult and nest_by() messes up the order for Dec to Jan policies)</span></span>
<span id="cb12-535"><a href="#cb12-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(<span class="fu">leap_year</span>(pmoeffdte) <span class="sc">&amp;</span> <span class="fu">month</span>(pmoeffdte) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">day</span>(pmoeffdte) <span class="sc">==</span> <span class="dv">29</span>)) <span class="co"># filter out policies written on leap day (nest_by() messes up the order)</span></span>
<span id="cb12-536"><a href="#cb12-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-537"><a href="#cb12-537" aria-hidden="true" tabindex="-1"></a><span class="co"># close connection</span></span>
<span id="cb12-538"><a href="#cb12-538" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb12-539"><a href="#cb12-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-540"><a href="#cb12-540" aria-hidden="true" tabindex="-1"></a><span class="co"># save raw data so don't have to rerun in new month</span></span>
<span id="cb12-541"><a href="#cb12-541" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_expos_raw, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_expos_raw.RData"</span>)</span>
<span id="cb12-542"><a href="#cb12-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-543"><a href="#cb12-543" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Modify exposure data ----</span></span>
<span id="cb12-544"><a href="#cb12-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-545"><a href="#cb12-545" aria-hidden="true" tabindex="-1"></a><span class="co"># load raw exposure data</span></span>
<span id="cb12-546"><a href="#cb12-546" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_expos_raw.RData"</span>)</span>
<span id="cb12-547"><a href="#cb12-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-548"><a href="#cb12-548" aria-hidden="true" tabindex="-1"></a><span class="co"># create combined nested dataset of policy and exposure information</span></span>
<span id="cb12-549"><a href="#cb12-549" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; only want policies with exposure data</span></span>
<span id="cb12-550"><a href="#cb12-550" aria-hidden="true" tabindex="-1"></a>last_month_expos_data <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb12-551"><a href="#cb12-551" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb12-552"><a href="#cb12-552" aria-hidden="true" tabindex="-1"></a>data_policy_expos <span class="ot">&lt;-</span> data_policy <span class="sc">%&gt;%</span> </span>
<span id="cb12-553"><a href="#cb12-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(pol_num, <span class="at">.keep =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-554"><a href="#cb12-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">data_policy =</span> data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-555"><a href="#cb12-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(data_expos_raw <span class="sc">%&gt;%</span> <span class="fu">nest_by</span>(polno, <span class="at">.keep =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">data_expos =</span> data), <span class="at">by =</span> <span class="fu">join_by</span>(pol_num <span class="sc">==</span> polno)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-556"><a href="#cb12-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_expos =</span> <span class="fu">map2</span>(<span class="at">.x =</span> <span class="fu">list</span>(data_policy), <span class="at">.y =</span> <span class="fu">list</span>(data_expos), \(df_policy, df_expos) <span class="fu">modify_exposure_data</span>(df_policy, df_expos)))</span>
<span id="cb12-557"><a href="#cb12-557" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span>
<span id="cb12-558"><a href="#cb12-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-559"><a href="#cb12-559" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-560"><a href="#cb12-560" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_policy_expos, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_policy_expos.RData"</span>)</span>
<span id="cb12-561"><a href="#cb12-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-562"><a href="#cb12-562" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Create final datsets ----</span></span>
<span id="cb12-563"><a href="#cb12-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-564"><a href="#cb12-564" aria-hidden="true" tabindex="-1"></a><span class="co"># load combined nested dataset of policy and exposure information </span></span>
<span id="cb12-565"><a href="#cb12-565" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_policy_expos.RData"</span>)</span>
<span id="cb12-566"><a href="#cb12-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-567"><a href="#cb12-567" aria-hidden="true" tabindex="-1"></a><span class="co"># get modified exposure data</span></span>
<span id="cb12-568"><a href="#cb12-568" aria-hidden="true" tabindex="-1"></a>data_expos <span class="ot">&lt;-</span> data_policy_expos <span class="sc">%&gt;%</span> </span>
<span id="cb12-569"><a href="#cb12-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>data_policy) <span class="sc">%&gt;%</span> </span>
<span id="cb12-570"><a href="#cb12-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data_expos) <span class="sc">%&gt;%</span> </span>
<span id="cb12-571"><a href="#cb12-571" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-572"><a href="#cb12-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(data_pull_date, <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-573"><a href="#cb12-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>polno)</span>
<span id="cb12-574"><a href="#cb12-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-575"><a href="#cb12-575" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-576"><a href="#cb12-576" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_expos, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_expos.RData"</span>)</span>
<span id="cb12-577"><a href="#cb12-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-578"><a href="#cb12-578" aria-hidden="true" tabindex="-1"></a><span class="co"># get policy data that matches the exposure data</span></span>
<span id="cb12-579"><a href="#cb12-579" aria-hidden="true" tabindex="-1"></a>data_policy_matched <span class="ot">&lt;-</span> data_policy_expos <span class="sc">%&gt;%</span> </span>
<span id="cb12-580"><a href="#cb12-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>data_expos) <span class="sc">%&gt;%</span> </span>
<span id="cb12-581"><a href="#cb12-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data_policy =</span> <span class="fu">map</span>(<span class="at">.x =</span> <span class="fu">list</span>(data_policy), \(df) <span class="fu">select</span>(df, <span class="sc">-</span>pol_num))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-582"><a href="#cb12-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data_policy) <span class="sc">%&gt;%</span> </span>
<span id="cb12-583"><a href="#cb12-583" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-584"><a href="#cb12-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(policy_data_pull_date, <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-585"><a href="#cb12-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-586"><a href="#cb12-586" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-587"><a href="#cb12-587" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_policy_matched, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_policy_matched.RData"</span>)</span>
<span id="cb12-588"><a href="#cb12-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-589"><a href="#cb12-589" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load data: RData ----</span></span>
<span id="cb12-590"><a href="#cb12-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-591"><a href="#cb12-591" aria-hidden="true" tabindex="-1"></a><span class="co"># load combined nested dataset of policy and exposure information </span></span>
<span id="cb12-592"><a href="#cb12-592" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_policy_expos.RData"</span>)</span>
<span id="cb12-593"><a href="#cb12-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-594"><a href="#cb12-594" aria-hidden="true" tabindex="-1"></a><span class="co"># load modified exposure data</span></span>
<span id="cb12-595"><a href="#cb12-595" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_expos.RData"</span>)</span>
<span id="cb12-596"><a href="#cb12-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-597"><a href="#cb12-597" aria-hidden="true" tabindex="-1"></a><span class="co"># load matched policy data</span></span>
<span id="cb12-598"><a href="#cb12-598" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_policy_matched.RData"</span>)</span>
<span id="cb12-599"><a href="#cb12-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-600"><a href="#cb12-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-601"><a href="#cb12-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-602"><a href="#cb12-602" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tiering analysis - Combined</span></span>
<span id="cb12-603"><a href="#cb12-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-606"><a href="#cb12-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-607"><a href="#cb12-607" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages and define functions ---- </span></span>
<span id="cb12-608"><a href="#cb12-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-609"><a href="#cb12-609" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-610"><a href="#cb12-610" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-611"><a href="#cb12-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-612"><a href="#cb12-612" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to summarize exposures by grouping variables univariately</span></span>
<span id="cb12-613"><a href="#cb12-613" aria-hidden="true" tabindex="-1"></a>summarize_exposures <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb12-614"><a href="#cb12-614" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-615"><a href="#cb12-615" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb12-616"><a href="#cb12-616" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-617"><a href="#cb12-617" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">ncol</span>(df)<span class="sc">-</span><span class="dv">2</span>)) {</span>
<span id="cb12-618"><a href="#cb12-618" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-619"><a href="#cb12-619" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb12-620"><a href="#cb12-620" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">all_of</span>(i), exposyr, earned_premium_with_fees_trended) <span class="sc">%&gt;%</span> </span>
<span id="cb12-621"><a href="#cb12-621" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="dv">1</span>,</span>
<span id="cb12-622"><a href="#cb12-622" aria-hidden="true" tabindex="-1"></a>                <span class="at">exposyr =</span> <span class="fu">sum</span>(exposyr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-623"><a href="#cb12-623" aria-hidden="true" tabindex="-1"></a>                <span class="at">earned_premium_with_fees_trended =</span> <span class="fu">sum</span>(earned_premium_with_fees_trended, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-624"><a href="#cb12-624" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(<span class="fu">desc</span>(exposyr))</span>
<span id="cb12-625"><a href="#cb12-625" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-626"><a href="#cb12-626" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">=</span> tmp</span>
<span id="cb12-627"><a href="#cb12-627" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-628"><a href="#cb12-628" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-629"><a href="#cb12-629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-630"><a href="#cb12-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results) <span class="ot">=</span> <span class="fu">colnames</span>(df <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(exposyr, earned_premium_with_fees_trended)))</span>
<span id="cb12-631"><a href="#cb12-631" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-632"><a href="#cb12-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb12-633"><a href="#cb12-633" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-634"><a href="#cb12-634" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-635"><a href="#cb12-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-636"><a href="#cb12-636" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load data: RData ----</span></span>
<span id="cb12-637"><a href="#cb12-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-638"><a href="#cb12-638" aria-hidden="true" tabindex="-1"></a><span class="co"># load matched policy data</span></span>
<span id="cb12-639"><a href="#cb12-639" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_policy_matched.RData"</span>)</span>
<span id="cb12-640"><a href="#cb12-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-641"><a href="#cb12-641" aria-hidden="true" tabindex="-1"></a><span class="co"># load trended, ult summarized claim data</span></span>
<span id="cb12-642"><a href="#cb12-642" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_claims_non_cats_ult_trended_capped_by_peril.RData"</span>)</span>
<span id="cb12-643"><a href="#cb12-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-644"><a href="#cb12-644" aria-hidden="true" tabindex="-1"></a><span class="co"># load modified exposure data</span></span>
<span id="cb12-645"><a href="#cb12-645" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_expos.RData"</span>)</span>
<span id="cb12-646"><a href="#cb12-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-647"><a href="#cb12-647" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Recode premium data ----</span></span>
<span id="cb12-648"><a href="#cb12-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-649"><a href="#cb12-649" aria-hidden="true" tabindex="-1"></a><span class="co"># recode data to levels of tiering variables</span></span>
<span id="cb12-650"><a href="#cb12-650" aria-hidden="true" tabindex="-1"></a>data_policy_matched_lvls <span class="ot">&lt;-</span> data_policy_matched <span class="sc">%&gt;%</span> </span>
<span id="cb12-651"><a href="#cb12-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"claim_type_"</span>),</span>
<span id="cb12-652"><a href="#cb12-652" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">case_when</span>(</span>
<span id="cb12-653"><a href="#cb12-653" aria-hidden="true" tabindex="-1"></a>                  .x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"RIOT"</span>,<span class="st">"HAIL"</span>,<span class="st">"LIGHT"</span>,<span class="st">"VMM"</span>,<span class="st">"WEATH"</span>,<span class="st">"WIND"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb12-654"><a href="#cb12-654" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">is.na</span>(.x) <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb12-655"><a href="#cb12-655" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.default =</span> <span class="dv">2</span></span>
<span id="cb12-656"><a href="#cb12-656" aria-hidden="true" tabindex="-1"></a>                )),</span>
<span id="cb12-657"><a href="#cb12-657" aria-hidden="true" tabindex="-1"></a>         <span class="at">credit_range =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-658"><a href="#cb12-658" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"No Score"</span>,</span>
<span id="cb12-659"><a href="#cb12-659" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">582</span> <span class="sc">~</span> <span class="st">"582 or Less"</span>,</span>
<span id="cb12-660"><a href="#cb12-660" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">596</span> <span class="sc">~</span> <span class="st">"583 - 596"</span>,</span>
<span id="cb12-661"><a href="#cb12-661" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">609</span> <span class="sc">~</span> <span class="st">"597 - 609"</span>,</span>
<span id="cb12-662"><a href="#cb12-662" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">622</span> <span class="sc">~</span> <span class="st">"610 - 622"</span>,</span>
<span id="cb12-663"><a href="#cb12-663" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">635</span> <span class="sc">~</span> <span class="st">"623 - 635"</span>,</span>
<span id="cb12-664"><a href="#cb12-664" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">645</span> <span class="sc">~</span> <span class="st">"636 - 645"</span>,</span>
<span id="cb12-665"><a href="#cb12-665" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">654</span> <span class="sc">~</span> <span class="st">"646 - 654"</span>,</span>
<span id="cb12-666"><a href="#cb12-666" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">663</span> <span class="sc">~</span> <span class="st">"655 - 663"</span>,</span>
<span id="cb12-667"><a href="#cb12-667" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">672</span> <span class="sc">~</span> <span class="st">"664 - 672"</span>,</span>
<span id="cb12-668"><a href="#cb12-668" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">681</span> <span class="sc">~</span> <span class="st">"673 - 681"</span>,</span>
<span id="cb12-669"><a href="#cb12-669" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">689</span> <span class="sc">~</span> <span class="st">"682 - 689"</span>,</span>
<span id="cb12-670"><a href="#cb12-670" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">696</span> <span class="sc">~</span> <span class="st">"690 - 696"</span>,</span>
<span id="cb12-671"><a href="#cb12-671" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">704</span> <span class="sc">~</span> <span class="st">"697 - 704"</span>,</span>
<span id="cb12-672"><a href="#cb12-672" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">711</span> <span class="sc">~</span> <span class="st">"705 - 711"</span>,</span>
<span id="cb12-673"><a href="#cb12-673" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">717</span> <span class="sc">~</span> <span class="st">"712 - 717"</span>,</span>
<span id="cb12-674"><a href="#cb12-674" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">722</span> <span class="sc">~</span> <span class="st">"718 - 722"</span>,</span>
<span id="cb12-675"><a href="#cb12-675" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">728</span> <span class="sc">~</span> <span class="st">"723 - 728"</span>,</span>
<span id="cb12-676"><a href="#cb12-676" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">734</span> <span class="sc">~</span> <span class="st">"729 - 734"</span>,</span>
<span id="cb12-677"><a href="#cb12-677" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">740</span> <span class="sc">~</span> <span class="st">"735 - 740"</span>,</span>
<span id="cb12-678"><a href="#cb12-678" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">745</span> <span class="sc">~</span> <span class="st">"741 - 745"</span>,</span>
<span id="cb12-679"><a href="#cb12-679" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">750</span> <span class="sc">~</span> <span class="st">"746 - 750"</span>,</span>
<span id="cb12-680"><a href="#cb12-680" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">758</span> <span class="sc">~</span> <span class="st">"751 - 758"</span>,</span>
<span id="cb12-681"><a href="#cb12-681" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">764</span> <span class="sc">~</span> <span class="st">"759 - 764"</span>,</span>
<span id="cb12-682"><a href="#cb12-682" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">771</span> <span class="sc">~</span> <span class="st">"765 - 771"</span>,</span>
<span id="cb12-683"><a href="#cb12-683" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">777</span> <span class="sc">~</span> <span class="st">"772 - 777"</span>,</span>
<span id="cb12-684"><a href="#cb12-684" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">786</span> <span class="sc">~</span> <span class="st">"778 - 786"</span>,</span>
<span id="cb12-685"><a href="#cb12-685" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">794</span> <span class="sc">~</span> <span class="st">"787 - 794"</span>,</span>
<span id="cb12-686"><a href="#cb12-686" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">802</span> <span class="sc">~</span> <span class="st">"795 - 802"</span>,</span>
<span id="cb12-687"><a href="#cb12-687" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">810</span> <span class="sc">~</span> <span class="st">"803 - 810"</span>,</span>
<span id="cb12-688"><a href="#cb12-688" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">828</span> <span class="sc">~</span> <span class="st">"811 - 828"</span>,</span>
<span id="cb12-689"><a href="#cb12-689" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">845</span> <span class="sc">~</span> <span class="st">"829 - 845"</span>,</span>
<span id="cb12-690"><a href="#cb12-690" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">862</span> <span class="sc">~</span> <span class="st">"846 - 862"</span>,</span>
<span id="cb12-691"><a href="#cb12-691" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&lt;=</span> <span class="dv">879</span> <span class="sc">~</span> <span class="st">"863 - 879"</span>,</span>
<span id="cb12-692"><a href="#cb12-692" aria-hidden="true" tabindex="-1"></a>           credit_score <span class="sc">&gt;=</span> <span class="dv">880</span> <span class="sc">~</span> <span class="st">"880 or More"</span>,</span>
<span id="cb12-693"><a href="#cb12-693" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"582 or Less"</span>,<span class="st">"583 - 596"</span>,<span class="st">"597 - 609"</span>,<span class="st">"610 - 622"</span>,<span class="st">"623 - 635"</span>,<span class="st">"636 - 645"</span>,<span class="st">"646 - 654"</span>,</span>
<span id="cb12-694"><a href="#cb12-694" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"655 - 663"</span>,<span class="st">"664 - 672"</span>,<span class="st">"673 - 681"</span>,<span class="st">"682 - 689"</span>,<span class="st">"690 - 696"</span>,<span class="st">"697 - 704"</span>,<span class="st">"705 - 711"</span>,</span>
<span id="cb12-695"><a href="#cb12-695" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"712 - 717"</span>,<span class="st">"718 - 722"</span>,<span class="st">"723 - 728"</span>,<span class="st">"729 - 734"</span>,<span class="st">"735 - 740"</span>,<span class="st">"741 - 745"</span>,<span class="st">"746 - 750"</span>,</span>
<span id="cb12-696"><a href="#cb12-696" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"751 - 758"</span>,<span class="st">"759 - 764"</span>,<span class="st">"765 - 771"</span>,<span class="st">"772 - 777"</span>,<span class="st">"778 - 786"</span>,<span class="st">"787 - 794"</span>,<span class="st">"795 - 802"</span>,</span>
<span id="cb12-697"><a href="#cb12-697" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"803 - 810"</span>,<span class="st">"811 - 828"</span>,<span class="st">"829 - 845"</span>,<span class="st">"846 - 862"</span>,<span class="st">"863 - 879"</span>,<span class="st">"880 or More"</span>, <span class="st">"No Score"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-698"><a href="#cb12-698" aria-hidden="true" tabindex="-1"></a>         <span class="at">credit_range2 =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-699"><a href="#cb12-699" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"582 or Less"</span>,<span class="st">"583 - 596"</span>) <span class="sc">~</span> <span class="st">"596 or Less"</span>,</span>
<span id="cb12-700"><a href="#cb12-700" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"597 - 609"</span>,<span class="st">"610 - 622"</span>) <span class="sc">~</span> <span class="st">"597 - 622"</span>,</span>
<span id="cb12-701"><a href="#cb12-701" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"623 - 635"</span>,<span class="st">"636 - 645"</span>) <span class="sc">~</span> <span class="st">"623 - 645"</span>,</span>
<span id="cb12-702"><a href="#cb12-702" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"646 - 654"</span>,<span class="st">"655 - 663"</span>) <span class="sc">~</span> <span class="st">"646 - 663"</span>,</span>
<span id="cb12-703"><a href="#cb12-703" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"664 - 672"</span>,<span class="st">"673 - 681"</span>) <span class="sc">~</span> <span class="st">"664 - 681"</span>,</span>
<span id="cb12-704"><a href="#cb12-704" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"682 - 689"</span>,<span class="st">"690 - 696"</span>) <span class="sc">~</span> <span class="st">"682 - 696"</span>,</span>
<span id="cb12-705"><a href="#cb12-705" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"697 - 704"</span>,<span class="st">"705 - 711"</span>) <span class="sc">~</span> <span class="st">"697 - 711"</span>,</span>
<span id="cb12-706"><a href="#cb12-706" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"712 - 717"</span>,<span class="st">"718 - 722"</span>) <span class="sc">~</span> <span class="st">"712 - 722"</span>,</span>
<span id="cb12-707"><a href="#cb12-707" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"723 - 728"</span>,<span class="st">"729 - 734"</span>) <span class="sc">~</span> <span class="st">"723 - 734"</span>,</span>
<span id="cb12-708"><a href="#cb12-708" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"735 - 740"</span>,<span class="st">"741 - 745"</span>) <span class="sc">~</span> <span class="st">"735 - 745"</span>,</span>
<span id="cb12-709"><a href="#cb12-709" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"746 - 750"</span>,<span class="st">"751 - 758"</span>) <span class="sc">~</span> <span class="st">"746 - 758"</span>,</span>
<span id="cb12-710"><a href="#cb12-710" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"759 - 764"</span>,<span class="st">"765 - 771"</span>) <span class="sc">~</span> <span class="st">"759 - 771"</span>,</span>
<span id="cb12-711"><a href="#cb12-711" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"772 - 777"</span>,<span class="st">"778 - 786"</span>) <span class="sc">~</span> <span class="st">"772 - 786"</span>,</span>
<span id="cb12-712"><a href="#cb12-712" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"787 - 794"</span>,<span class="st">"795 - 802"</span>) <span class="sc">~</span> <span class="st">"787 - 802"</span>,</span>
<span id="cb12-713"><a href="#cb12-713" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"803 - 810"</span>,<span class="st">"811 - 828"</span>) <span class="sc">~</span> <span class="st">"803 - 828"</span>,</span>
<span id="cb12-714"><a href="#cb12-714" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"829 - 845"</span>,<span class="st">"846 - 862"</span>) <span class="sc">~</span> <span class="st">"829 - 862"</span>,</span>
<span id="cb12-715"><a href="#cb12-715" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">%in%</span>  <span class="fu">c</span>(<span class="st">"863 - 879"</span>,<span class="st">"880 or More"</span>) <span class="sc">~</span> <span class="st">"863 or More"</span>,</span>
<span id="cb12-716"><a href="#cb12-716" aria-hidden="true" tabindex="-1"></a>           credit_range <span class="sc">==</span> <span class="st">"No Score"</span> <span class="sc">~</span> <span class="st">"No Score"</span>,</span>
<span id="cb12-717"><a href="#cb12-717" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> credit_range</span>
<span id="cb12-718"><a href="#cb12-718" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"596 or Less"</span>,<span class="st">"597 - 622"</span>,<span class="st">"623 - 645"</span>,<span class="st">"646 - 663"</span>,<span class="st">"664 - 681"</span>,<span class="st">"682 - 696"</span>,<span class="st">"697 - 711"</span>,</span>
<span id="cb12-719"><a href="#cb12-719" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"712 - 722"</span>,<span class="st">"723 - 734"</span>,<span class="st">"735 - 745"</span>,<span class="st">"746 - 758"</span>,<span class="st">"759 - 771"</span>,<span class="st">"772 - 786"</span>,<span class="st">"787 - 802"</span>,</span>
<span id="cb12-720"><a href="#cb12-720" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"803 - 828"</span>,<span class="st">"829 - 862"</span>,<span class="st">"863 or More"</span>,<span class="st">"No Score"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-721"><a href="#cb12-721" aria-hidden="true" tabindex="-1"></a>         <span class="at">years_in_business =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-722"><a href="#cb12-722" aria-hidden="true" tabindex="-1"></a>           year_bus_start <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb12-723"><a href="#cb12-723" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_bus_start <span class="sc">&lt;=</span> <span class="dv">9</span> <span class="sc">~</span> <span class="fu">as.character</span>(<span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_bus_start),</span>
<span id="cb12-724"><a href="#cb12-724" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_bus_start <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"10 or More"</span></span>
<span id="cb12-725"><a href="#cb12-725" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>), <span class="st">"10 or More"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-726"><a href="#cb12-726" aria-hidden="true" tabindex="-1"></a>         <span class="at">age_of_building =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-727"><a href="#cb12-727" aria-hidden="true" tabindex="-1"></a>           year_built <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Unknown"</span>,</span>
<span id="cb12-728"><a href="#cb12-728" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"0-2"</span>,</span>
<span id="cb12-729"><a href="#cb12-729" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">10</span> <span class="sc">~</span> <span class="fu">as.character</span>(<span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built),</span>
<span id="cb12-730"><a href="#cb12-730" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">12</span> <span class="sc">~</span> <span class="st">"11-12"</span>,</span>
<span id="cb12-731"><a href="#cb12-731" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">15</span> <span class="sc">~</span> <span class="st">"13-15"</span>,</span>
<span id="cb12-732"><a href="#cb12-732" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">17</span> <span class="sc">~</span> <span class="st">"16-17"</span>,</span>
<span id="cb12-733"><a href="#cb12-733" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">20</span> <span class="sc">~</span> <span class="st">"18-20"</span>,</span>
<span id="cb12-734"><a href="#cb12-734" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">24</span> <span class="sc">~</span> <span class="st">"21-24"</span>,</span>
<span id="cb12-735"><a href="#cb12-735" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">29</span> <span class="sc">~</span> <span class="st">"25-29"</span>,</span>
<span id="cb12-736"><a href="#cb12-736" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">33</span> <span class="sc">~</span> <span class="st">"30-33"</span>,</span>
<span id="cb12-737"><a href="#cb12-737" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">44</span> <span class="sc">~</span> <span class="st">"34-44"</span>,</span>
<span id="cb12-738"><a href="#cb12-738" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">49</span> <span class="sc">~</span> <span class="st">"45-49"</span>,</span>
<span id="cb12-739"><a href="#cb12-739" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">59</span> <span class="sc">~</span> <span class="st">"50-59"</span>,</span>
<span id="cb12-740"><a href="#cb12-740" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">74</span> <span class="sc">~</span> <span class="st">"60-74"</span>,</span>
<span id="cb12-741"><a href="#cb12-741" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&lt;=</span> <span class="dv">99</span> <span class="sc">~</span> <span class="st">"75-99"</span>,</span>
<span id="cb12-742"><a href="#cb12-742" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> year_built <span class="sc">&gt;=</span> <span class="dv">100</span> <span class="sc">~</span> <span class="st">"100 or More"</span>,</span>
<span id="cb12-743"><a href="#cb12-743" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="st">"Unknown"</span></span>
<span id="cb12-744"><a href="#cb12-744" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"0-2"</span>,<span class="fu">paste</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">10</span>),<span class="st">"11-12"</span>,<span class="st">"13-15"</span>,<span class="st">"16-17"</span>,<span class="st">"18-20"</span>,<span class="st">"21-24"</span>,<span class="st">"25-29"</span>,<span class="st">"30-33"</span>,</span>
<span id="cb12-745"><a href="#cb12-745" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"34-44"</span>,<span class="st">"45-49"</span>,<span class="st">"50-59"</span>,<span class="st">"60-74"</span>,<span class="st">"75-99"</span>,<span class="st">"100 or More"</span>,<span class="st">"Unknown"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-746"><a href="#cb12-746" aria-hidden="true" tabindex="-1"></a>         <span class="at">age_of_roof =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-747"><a href="#cb12-747" aria-hidden="true" tabindex="-1"></a>           roof_year <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Unknown"</span>,</span>
<span id="cb12-748"><a href="#cb12-748" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> roof_year <span class="sc">&lt;=</span> <span class="dv">39</span> <span class="sc">~</span> <span class="fu">as.character</span>(<span class="fu">year</span>(term_eff_date) <span class="sc">-</span> roof_year),</span>
<span id="cb12-749"><a href="#cb12-749" aria-hidden="true" tabindex="-1"></a>           <span class="fu">year</span>(term_eff_date) <span class="sc">-</span> roof_year <span class="sc">&gt;=</span> <span class="dv">40</span> <span class="sc">~</span> <span class="st">"40 or More"</span>,</span>
<span id="cb12-750"><a href="#cb12-750" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="st">"Unknown"</span></span>
<span id="cb12-751"><a href="#cb12-751" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">39</span>),<span class="st">"40 or More"</span>,<span class="st">"Unknown"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-752"><a href="#cb12-752" aria-hidden="true" tabindex="-1"></a>         <span class="at">roof_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-753"><a href="#cb12-753" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"asphault shingle"</span>,<span class="st">"as"</span>,<span class="st">"shingle"</span>,<span class="st">"asphalt comp roll"</span>,<span class="st">"comp roll"</span>,<span class="st">"comp"</span>,<span class="st">"comp toll"</span>,<span class="st">"composition"</span>) <span class="sc">~</span> <span class="st">"asphalt shingle"</span>,</span>
<span id="cb12-754"><a href="#cb12-754" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tile, slate, stone"</span>,<span class="st">"tile"</span>) <span class="sc">~</span> <span class="st">"tile"</span>,</span>
<span id="cb12-755"><a href="#cb12-755" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"rubber"</span>,<span class="st">"rubber membrane"</span>,<span class="st">"membrane"</span>) <span class="sc">~</span> <span class="st">"synthetic"</span>,</span>
<span id="cb12-756"><a href="#cb12-756" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tar, tar and gravel"</span>,<span class="st">"tar &amp; gravel"</span>,<span class="st">"t&amp;g"</span>,<span class="st">"t &amp; g"</span>) <span class="sc">~</span> <span class="st">"tar and gravel"</span>,</span>
<span id="cb12-757"><a href="#cb12-757" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"thermo-plastic membrane"</span>,<span class="st">"thermo plastic"</span>) <span class="sc">~</span> <span class="st">"TPO"</span>,</span>
<span id="cb12-758"><a href="#cb12-758" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">==</span> <span class="st">"plastic membrane"</span> <span class="sc">~</span> <span class="st">"EPDM"</span>,</span>
<span id="cb12-759"><a href="#cb12-759" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">==</span> <span class="st">"concrete"</span> <span class="sc">~</span> <span class="st">"other"</span>,</span>
<span id="cb12-760"><a href="#cb12-760" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_lower</span>(roof_type) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>,<span class="st">"flat"</span>,<span class="st">"gable"</span>,<span class="st">""</span>) <span class="sc">~</span> <span class="st">"unknown"</span>,</span>
<span id="cb12-761"><a href="#cb12-761" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="fu">str_to_lower</span>(roof_type)</span>
<span id="cb12-762"><a href="#cb12-762" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb12-763"><a href="#cb12-763" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_empl =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-764"><a href="#cb12-764" aria-hidden="true" tabindex="-1"></a>           num_empl <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Missing"</span>,</span>
<span id="cb12-765"><a href="#cb12-765" aria-hidden="true" tabindex="-1"></a>           num_empl <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"1-3"</span>,</span>
<span id="cb12-766"><a href="#cb12-766" aria-hidden="true" tabindex="-1"></a>           num_empl <span class="sc">&lt;=</span> <span class="dv">6</span> <span class="sc">~</span> <span class="st">"4-6"</span>,</span>
<span id="cb12-767"><a href="#cb12-767" aria-hidden="true" tabindex="-1"></a>           num_empl <span class="sc">&lt;=</span> <span class="dv">12</span> <span class="sc">~</span> <span class="st">"7-12"</span>,</span>
<span id="cb12-768"><a href="#cb12-768" aria-hidden="true" tabindex="-1"></a>           num_empl <span class="sc">&gt;=</span> <span class="dv">13</span> <span class="sc">~</span> <span class="st">"13 or More"</span>,</span>
<span id="cb12-769"><a href="#cb12-769" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="st">"Missing"</span></span>
<span id="cb12-770"><a href="#cb12-770" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Missing"</span>,<span class="st">"1-3"</span>,<span class="st">"4-6"</span>,<span class="st">"7-12"</span>,<span class="st">"13 or More"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-771"><a href="#cb12-771" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_sw_pols =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-772"><a href="#cb12-772" aria-hidden="true" tabindex="-1"></a>           num_sw_pols <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="fu">as.character</span>(num_sw_pols),</span>
<span id="cb12-773"><a href="#cb12-773" aria-hidden="true" tabindex="-1"></a>           num_sw_pols <span class="sc">&gt;=</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"4 or More"</span>,</span>
<span id="cb12-774"><a href="#cb12-774" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb12-775"><a href="#cb12-775" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),<span class="st">"4 or More"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-776"><a href="#cb12-776" aria-hidden="true" tabindex="-1"></a>         <span class="at">adv_qt_days =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-777"><a href="#cb12-777" aria-hidden="true" tabindex="-1"></a>           adv_qt_days <span class="sc">&lt;=</span> <span class="dv">14</span> <span class="sc">~</span> <span class="st">"0-14"</span>,</span>
<span id="cb12-778"><a href="#cb12-778" aria-hidden="true" tabindex="-1"></a>           adv_qt_days <span class="sc">&lt;=</span> <span class="dv">30</span> <span class="sc">~</span> <span class="st">"15-30"</span>,</span>
<span id="cb12-779"><a href="#cb12-779" aria-hidden="true" tabindex="-1"></a>           adv_qt_days <span class="sc">&gt;=</span> <span class="dv">31</span> <span class="sc">~</span> <span class="st">"31 or More"</span>,</span>
<span id="cb12-780"><a href="#cb12-780" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="st">"Missing"</span></span>
<span id="cb12-781"><a href="#cb12-781" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Missing"</span>,<span class="st">"0-14"</span>,<span class="st">"15-30"</span>,<span class="st">"31 or More"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-782"><a href="#cb12-782" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-783"><a href="#cb12-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior_loss_history_points =</span> claim_type_1 <span class="sc">+</span> claim_type_2 <span class="sc">+</span> claim_type_3 <span class="sc">+</span> claim_type_4 <span class="sc">+</span> claim_type_5)</span>
<span id="cb12-784"><a href="#cb12-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-785"><a href="#cb12-785" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Combine data ----</span></span>
<span id="cb12-786"><a href="#cb12-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-787"><a href="#cb12-787" aria-hidden="true" tabindex="-1"></a><span class="co"># combine policy and claim data</span></span>
<span id="cb12-788"><a href="#cb12-788" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; don't need the tiering info now, will join back on after aggregating</span></span>
<span id="cb12-789"><a href="#cb12-789" aria-hidden="true" tabindex="-1"></a>data_combined <span class="ot">&lt;-</span> data_policy_matched_lvls <span class="sc">%&gt;%</span> </span>
<span id="cb12-790"><a href="#cb12-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_data_pull_date, pol_num, trans_type, term_num_id, pol_state, orig_eff_date, term_eff_date, term_exp_date, cancel_date, pol_status, expos_base, bdg_loi, bpp_loi, sales, payroll, term_premium, term_fees) <span class="sc">%&gt;%</span> </span>
<span id="cb12-791"><a href="#cb12-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_claims_non_cats_ult_trended_capped_by_peril <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(company, pol_state))<span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">claims_data_pull_date =</span> data_pull_date), <span class="at">by =</span> <span class="fu">join_by</span>(pol_num <span class="sc">==</span> pol_num, term_eff_date <span class="sc">==</span> term_eff_date))</span>
<span id="cb12-792"><a href="#cb12-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-793"><a href="#cb12-793" aria-hidden="true" tabindex="-1"></a><span class="co"># combine policy and exposure data</span></span>
<span id="cb12-794"><a href="#cb12-794" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; zero out repeated premium and claim amounts</span></span>
<span id="cb12-795"><a href="#cb12-795" aria-hidden="true" tabindex="-1"></a>data_combined <span class="sc">%&lt;&gt;%</span>  </span>
<span id="cb12-796"><a href="#cb12-796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term_eff_date <span class="sc">&lt;</span> <span class="fu">ymd</span>(<span class="st">"2025-11-01"</span>)) <span class="sc">%&gt;%</span> <span class="co"># don't have exposure data for the current month</span></span>
<span id="cb12-797"><a href="#cb12-797" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_expos <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">expos_data_pull_date =</span> data_pull_date) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(term_eff_date, cancel_date)), <span class="at">by =</span> <span class="fu">join_by</span>(pol_num <span class="sc">==</span> pol_num, term_num_id <span class="sc">==</span> term_num_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-798"><a href="#cb12-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_data_pull_date, expos_data_pull_date, pol_num, pol_state, company, poltyp, trans_type, term_num_id, term_month_id, orig_eff_date, term_eff_date, term_exp_date, cancel_date, pol_status, calyr, calmth, </span>
<span id="cb12-799"><a href="#cb12-799" aria-hidden="true" tabindex="-1"></a>         term_premium, term_fees, exposyr, exposyr_orig, check, expos_base, bdg_loi, bpp_loi, sales, payroll,</span>
<span id="cb12-800"><a href="#cb12-800" aria-hidden="true" tabindex="-1"></a>         claims_data_pull_date, <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-801"><a href="#cb12-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> <span class="fu">c</span>(pol_num, term_num_id),</span>
<span id="cb12-802"><a href="#cb12-802" aria-hidden="true" tabindex="-1"></a>         <span class="at">row_id =</span> <span class="fu">row_number</span>(),</span>
<span id="cb12-803"><a href="#cb12-803" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(term_premium, term_fees, <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>)),</span>
<span id="cb12-804"><a href="#cb12-804" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">case_when</span>(</span>
<span id="cb12-805"><a href="#cb12-805" aria-hidden="true" tabindex="-1"></a>                  row_id <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> .x,</span>
<span id="cb12-806"><a href="#cb12-806" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">is.na</span>(.x) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb12-807"><a href="#cb12-807" aria-hidden="true" tabindex="-1"></a>                  <span class="at">.default =</span> <span class="dv">0</span></span>
<span id="cb12-808"><a href="#cb12-808" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-809"><a href="#cb12-809" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb12-810"><a href="#cb12-810" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-811"><a href="#cb12-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>row_id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-812"><a href="#cb12-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(exposyr)) <span class="co"># real tiny amount of exposure data missing, not my fault</span></span>
<span id="cb12-813"><a href="#cb12-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-814"><a href="#cb12-814" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-815"><a href="#cb12-815" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_combined, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined.RData"</span>)</span>
<span id="cb12-816"><a href="#cb12-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-817"><a href="#cb12-817" aria-hidden="true" tabindex="-1"></a><span class="co"># write to csv for Karen to check trending</span></span>
<span id="cb12-818"><a href="#cb12-818" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(data_combined, <span class="st">"Excel data</span><span class="sc">\\</span><span class="st">data_combined.csv"</span>, <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb12-819"><a href="#cb12-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-820"><a href="#cb12-820" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Aggregate all data and trend premium data ----</span></span>
<span id="cb12-821"><a href="#cb12-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-822"><a href="#cb12-822" aria-hidden="true" tabindex="-1"></a><span class="co"># load combined data</span></span>
<span id="cb12-823"><a href="#cb12-823" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined.RData"</span>)</span>
<span id="cb12-824"><a href="#cb12-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-825"><a href="#cb12-825" aria-hidden="true" tabindex="-1"></a><span class="co"># aggregate data by policy number / term</span></span>
<span id="cb12-826"><a href="#cb12-826" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; rolling up over pol_num and term_num_id</span></span>
<span id="cb12-827"><a href="#cb12-827" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; !!!! ASSUMING this correction / data error (I'm done...)</span></span>
<span id="cb12-828"><a href="#cb12-828" aria-hidden="true" tabindex="-1"></a><span class="co"># ---&gt; missing beginning policy term ==&gt; inflated first term exposyr</span></span>
<span id="cb12-829"><a href="#cb12-829" aria-hidden="true" tabindex="-1"></a><span class="co"># ---&gt; full last month of exposure when it shouldn't be</span></span>
<span id="cb12-830"><a href="#cb12-830" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate EP and add fees, and both written and earned exposures for property and liability</span></span>
<span id="cb12-831"><a href="#cb12-831" aria-hidden="true" tabindex="-1"></a><span class="co"># --&lt; !!! had approx 7800 policy terms with 0 exposure base (commercial landloards with no BPP), see notes below</span></span>
<span id="cb12-832"><a href="#cb12-832" aria-hidden="true" tabindex="-1"></a>data_combined_agg <span class="ot">&lt;-</span> data_combined <span class="sc">%&gt;%</span> </span>
<span id="cb12-833"><a href="#cb12-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(pol_num,</span>
<span id="cb12-834"><a href="#cb12-834" aria-hidden="true" tabindex="-1"></a>                    term_num_id,</span>
<span id="cb12-835"><a href="#cb12-835" aria-hidden="true" tabindex="-1"></a>                    term_eff_date,</span>
<span id="cb12-836"><a href="#cb12-836" aria-hidden="true" tabindex="-1"></a>                    expos_base),</span>
<span id="cb12-837"><a href="#cb12-837" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(term_premium, term_fees, exposyr, bdg_loi, bpp_loi, sales, payroll, <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>)),</span>
<span id="cb12-838"><a href="#cb12-838" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-839"><a href="#cb12-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">exposyr =</span> <span class="fu">ifelse</span>(exposyr <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="dv">1</span>, exposyr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-840"><a href="#cb12-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">earned_premium_with_fees =</span> <span class="fu">round</span>((term_premium <span class="sc">+</span> term_fees) <span class="sc">*</span> exposyr, <span class="dv">2</span>),</span>
<span id="cb12-841"><a href="#cb12-841" aria-hidden="true" tabindex="-1"></a>         <span class="at">term_premium_with_fees =</span> term_premium <span class="sc">+</span> term_fees,</span>
<span id="cb12-842"><a href="#cb12-842" aria-hidden="true" tabindex="-1"></a>         <span class="at">written_expos_property =</span> (bdg_loi <span class="sc">+</span> bpp_loi) <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb12-843"><a href="#cb12-843" aria-hidden="true" tabindex="-1"></a>         <span class="at">written_expos_liability =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-844"><a href="#cb12-844" aria-hidden="true" tabindex="-1"></a>           expos_base <span class="sc">==</span> <span class="st">"LOI"</span> <span class="sc">&amp;</span> bpp_loi <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">~</span> bpp_loi <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb12-845"><a href="#cb12-845" aria-hidden="true" tabindex="-1"></a>           expos_base <span class="sc">==</span> <span class="st">"LOI"</span> <span class="sc">&amp;</span> bpp_loi <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> sales <span class="sc">/</span> <span class="dv">1000</span>, <span class="co"># executive decision, correcting for $0 exposure base data errors by using a different exposure base</span></span>
<span id="cb12-846"><a href="#cb12-846" aria-hidden="true" tabindex="-1"></a>           expos_base <span class="sc">==</span> <span class="st">"SALES"</span> <span class="sc">&amp;</span> sales <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">~</span> sales <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb12-847"><a href="#cb12-847" aria-hidden="true" tabindex="-1"></a>           expos_base <span class="sc">==</span> <span class="st">"SALES"</span> <span class="sc">&amp;</span> sales <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> bpp_loi <span class="sc">/</span> <span class="dv">100</span>, <span class="co"># correcting ... </span></span>
<span id="cb12-848"><a href="#cb12-848" aria-hidden="true" tabindex="-1"></a>           expos_base <span class="sc">==</span> <span class="st">"PAY"</span> <span class="sc">&amp;</span> payroll <span class="sc">&gt;=</span> <span class="dv">1000</span> <span class="sc">~</span> payroll <span class="sc">/</span> <span class="dv">1000</span>, <span class="co"># another executive decision, if less than 1000 of payroll, then set to missing</span></span>
<span id="cb12-849"><a href="#cb12-849" aria-hidden="true" tabindex="-1"></a>           expos_base <span class="sc">==</span> <span class="st">"PAY"</span> <span class="sc">&amp;</span> payroll <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> sales <span class="sc">/</span> <span class="dv">1000</span> <span class="co"># correcting ...</span></span>
<span id="cb12-850"><a href="#cb12-850" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb12-851"><a href="#cb12-851" aria-hidden="true" tabindex="-1"></a>         <span class="at">earned_expos_property =</span> <span class="fu">round</span>(written_expos_property <span class="sc">*</span> exposyr, <span class="dv">2</span>),</span>
<span id="cb12-852"><a href="#cb12-852" aria-hidden="true" tabindex="-1"></a>         <span class="at">earned_expos_liability =</span> <span class="fu">round</span>(written_expos_liability <span class="sc">*</span> exposyr, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-853"><a href="#cb12-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pol_num, term_eff_date, term_num_id, term_premium_with_fees, earned_premium_with_fees, exposyr, <span class="fu">contains</span>(<span class="st">"_expos_"</span>), <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>))</span>
<span id="cb12-854"><a href="#cb12-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-855"><a href="#cb12-855" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb12-856"><a href="#cb12-856" aria-hidden="true" tabindex="-1"></a><span class="co"># (before simplifying assumption)</span></span>
<span id="cb12-857"><a href="#cb12-857" aria-hidden="true" tabindex="-1"></a>data_check <span class="ot">&lt;-</span> data_combined_agg <span class="sc">%&gt;%</span> <span class="fu">filter</span>(exposyr <span class="sc">&gt;</span> <span class="fl">1.01</span>)</span>
<span id="cb12-858"><a href="#cb12-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-859"><a href="#cb12-859" aria-hidden="true" tabindex="-1"></a><span class="co"># trend premiums individually</span></span>
<span id="cb12-860"><a href="#cb12-860" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; trend select pulled from 'Indications q4 2024 eval q1 2025.xlsx' for MA</span></span>
<span id="cb12-861"><a href="#cb12-861" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; as-of-date is the start of the future policy period (described below)</span></span>
<span id="cb12-862"><a href="#cb12-862" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; future policy period = 12/01/2025 - 12/01/2026 ==&gt; avg written date = 06/01/2026 and avg earned date = 12/01/2026</span></span>
<span id="cb12-863"><a href="#cb12-863" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; written premium trend period length and earned premium trend period length should be the same (just minor differences due to timing of year)</span></span>
<span id="cb12-864"><a href="#cb12-864" aria-hidden="true" tabindex="-1"></a>as_of_date_age <span class="ot">&lt;-</span> <span class="st">"2025-11-03"</span> <span class="sc">%&gt;%</span> ymd <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="fu">months</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> {<span class="fu">paste</span>(<span class="fu">year</span>(.), <span class="fu">month</span>(.), <span class="st">"1"</span>, <span class="at">sep =</span> <span class="st">"-"</span>)} <span class="sc">%&gt;%</span> ymd</span>
<span id="cb12-865"><a href="#cb12-865" aria-hidden="true" tabindex="-1"></a>trend_premium <span class="ot">&lt;-</span> <span class="fl">0.04259</span></span>
<span id="cb12-866"><a href="#cb12-866" aria-hidden="true" tabindex="-1"></a>avg_written_date_trend <span class="ot">&lt;-</span> as_of_date_age <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">6</span>)</span>
<span id="cb12-867"><a href="#cb12-867" aria-hidden="true" tabindex="-1"></a>avg_earned_date_trend <span class="ot">&lt;-</span> as_of_date_age  <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span>)</span>
<span id="cb12-868"><a href="#cb12-868" aria-hidden="true" tabindex="-1"></a>data_combined_agg <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-869"><a href="#cb12-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">written_premium_trend_factor =</span> trend_premium <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-870"><a href="#cb12-870" aria-hidden="true" tabindex="-1"></a>           <span class="fu">raise_to_power</span>(<span class="fu">interval</span>(term_eff_date, avg_written_date_trend) <span class="sc">/</span> <span class="fu">years</span>(<span class="dv">1</span>)),</span>
<span id="cb12-871"><a href="#cb12-871" aria-hidden="true" tabindex="-1"></a>         <span class="at">earned_premium_trend_factor =</span> trend_premium <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-872"><a href="#cb12-872" aria-hidden="true" tabindex="-1"></a>           <span class="fu">raise_to_power</span>(<span class="fu">interval</span>(term_eff_date <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">6</span>), avg_earned_date_trend) <span class="sc">/</span> <span class="fu">years</span>(<span class="dv">1</span>)),</span>
<span id="cb12-873"><a href="#cb12-873" aria-hidden="true" tabindex="-1"></a>         <span class="at">term_premium_with_fees_trended =</span> <span class="fu">round</span>(term_premium_with_fees <span class="sc">*</span> written_premium_trend_factor, <span class="dv">2</span>),</span>
<span id="cb12-874"><a href="#cb12-874" aria-hidden="true" tabindex="-1"></a>         <span class="at">earned_premium_with_fees_trended =</span> <span class="fu">round</span>(earned_premium_with_fees <span class="sc">*</span> earned_premium_trend_factor, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-875"><a href="#cb12-875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pol_num, term_eff_date, term_num_id, <span class="fu">starts_with</span>(<span class="st">"term_premium_with"</span>), <span class="fu">starts_with</span>(<span class="st">"earned_premium_with"</span>), written_premium_trend_factor, earned_premium_trend_factor, exposyr, <span class="fu">contains</span>(<span class="st">"_expos_"</span>), <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>))</span>
<span id="cb12-876"><a href="#cb12-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-877"><a href="#cb12-877" aria-hidden="true" tabindex="-1"></a><span class="co"># aggregate data by tiering variables</span></span>
<span id="cb12-878"><a href="#cb12-878" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate last tiering variable</span></span>
<span id="cb12-879"><a href="#cb12-879" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; need one record for each combination of tiering variables</span></span>
<span id="cb12-880"><a href="#cb12-880" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; in CA BOP UWG word doc, 6. Number of locations ==&gt; this is always 1 (never built this in), so skipping</span></span>
<span id="cb12-881"><a href="#cb12-881" aria-hidden="true" tabindex="-1"></a>data_combined_agg_agg <span class="ot">&lt;-</span> data_combined_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-882"><a href="#cb12-882" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_policy_matched_lvls <span class="sc">%&gt;%</span> <span class="fu">select</span>(pol_num, term_num_id, credit_range, prior_loss_history_points, years_in_business, age_of_building, age_of_roof, roof_type, num_empl, num_sw_pols, num_renewals, adv_qt_days, entity_type),</span>
<span id="cb12-883"><a href="#cb12-883" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(pol_num, term_num_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-884"><a href="#cb12-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_renewals =</span> term_num_id <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-885"><a href="#cb12-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(credit_range,</span>
<span id="cb12-886"><a href="#cb12-886" aria-hidden="true" tabindex="-1"></a>                    prior_loss_history_points,</span>
<span id="cb12-887"><a href="#cb12-887" aria-hidden="true" tabindex="-1"></a>                    years_in_business,</span>
<span id="cb12-888"><a href="#cb12-888" aria-hidden="true" tabindex="-1"></a>                    age_of_building,</span>
<span id="cb12-889"><a href="#cb12-889" aria-hidden="true" tabindex="-1"></a>                    age_of_roof,</span>
<span id="cb12-890"><a href="#cb12-890" aria-hidden="true" tabindex="-1"></a>                    roof_type,</span>
<span id="cb12-891"><a href="#cb12-891" aria-hidden="true" tabindex="-1"></a>                    num_empl,</span>
<span id="cb12-892"><a href="#cb12-892" aria-hidden="true" tabindex="-1"></a>                    num_sw_pols,</span>
<span id="cb12-893"><a href="#cb12-893" aria-hidden="true" tabindex="-1"></a>                    num_renewals,</span>
<span id="cb12-894"><a href="#cb12-894" aria-hidden="true" tabindex="-1"></a>                    adv_qt_days,</span>
<span id="cb12-895"><a href="#cb12-895" aria-hidden="true" tabindex="-1"></a>                    entity_type),</span>
<span id="cb12-896"><a href="#cb12-896" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(term_premium_with_fees_trended, earned_premium_with_fees_trended, exposyr, <span class="fu">contains</span>(<span class="st">"_expos_"</span>), <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>)),</span>
<span id="cb12-897"><a href="#cb12-897" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span> <span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb12-898"><a href="#cb12-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-899"><a href="#cb12-899" aria-hidden="true" tabindex="-1"></a><span class="co"># repeat for credit_range2</span></span>
<span id="cb12-900"><a href="#cb12-900" aria-hidden="true" tabindex="-1"></a>data_combined_agg_agg2 <span class="ot">&lt;-</span> data_combined_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-901"><a href="#cb12-901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_policy_matched_lvls <span class="sc">%&gt;%</span> <span class="fu">select</span>(pol_num, term_num_id, credit_range2, prior_loss_history_points, years_in_business, age_of_building, age_of_roof, roof_type, num_empl, num_sw_pols, num_renewals, adv_qt_days, entity_type),</span>
<span id="cb12-902"><a href="#cb12-902" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(pol_num, term_num_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-903"><a href="#cb12-903" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_renewals =</span> term_num_id <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-904"><a href="#cb12-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(credit_range2,</span>
<span id="cb12-905"><a href="#cb12-905" aria-hidden="true" tabindex="-1"></a>                    prior_loss_history_points,</span>
<span id="cb12-906"><a href="#cb12-906" aria-hidden="true" tabindex="-1"></a>                    years_in_business,</span>
<span id="cb12-907"><a href="#cb12-907" aria-hidden="true" tabindex="-1"></a>                    age_of_building,</span>
<span id="cb12-908"><a href="#cb12-908" aria-hidden="true" tabindex="-1"></a>                    age_of_roof,</span>
<span id="cb12-909"><a href="#cb12-909" aria-hidden="true" tabindex="-1"></a>                    roof_type,</span>
<span id="cb12-910"><a href="#cb12-910" aria-hidden="true" tabindex="-1"></a>                    num_empl,</span>
<span id="cb12-911"><a href="#cb12-911" aria-hidden="true" tabindex="-1"></a>                    num_sw_pols,</span>
<span id="cb12-912"><a href="#cb12-912" aria-hidden="true" tabindex="-1"></a>                    num_renewals,</span>
<span id="cb12-913"><a href="#cb12-913" aria-hidden="true" tabindex="-1"></a>                    adv_qt_days,</span>
<span id="cb12-914"><a href="#cb12-914" aria-hidden="true" tabindex="-1"></a>                    entity_type),</span>
<span id="cb12-915"><a href="#cb12-915" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(term_premium_with_fees_trended, earned_premium_with_fees_trended, exposyr, <span class="fu">contains</span>(<span class="st">"_expos_"</span>), <span class="fu">starts_with</span>(<span class="st">"incurred_claim_count_"</span>), <span class="fu">starts_with</span>(<span class="st">"peril_"</span>)),</span>
<span id="cb12-916"><a href="#cb12-916" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span> <span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb12-917"><a href="#cb12-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-918"><a href="#cb12-918" aria-hidden="true" tabindex="-1"></a><span class="co"># !!! some combinations have zero written liability exposure, don't think there's anything we can</span></span>
<span id="cb12-919"><a href="#cb12-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-920"><a href="#cb12-920" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-921"><a href="#cb12-921" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_combined_agg_agg, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined_agg_agg.RData"</span>)</span>
<span id="cb12-922"><a href="#cb12-922" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_combined_agg_agg2, <span class="at">file =</span> <span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined_agg_agg2.RData"</span>)</span>
<span id="cb12-923"><a href="#cb12-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-924"><a href="#cb12-924" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate univariate exposure and earned premium by tiering variable</span></span>
<span id="cb12-925"><a href="#cb12-925" aria-hidden="true" tabindex="-1"></a>summ_expos <span class="ot">&lt;-</span> data_combined_agg_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-926"><a href="#cb12-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(credit_range, prior_loss_history_points, years_in_business, age_of_building, age_of_roof, roof_type, num_empl, num_sw_pols, num_renewals, adv_qt_days, entity_type, exposyr, earned_premium_with_fees_trended) <span class="sc">%&gt;%</span> </span>
<span id="cb12-927"><a href="#cb12-927" aria-hidden="true" tabindex="-1"></a>  summarize_exposures <span class="sc">%T&gt;%</span> </span>
<span id="cb12-928"><a href="#cb12-928" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">names</span>(.) <span class="ot">-&gt;&gt;</span> nms} <span class="sc">%&gt;%</span> </span>
<span id="cb12-929"><a href="#cb12-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map2</span>(<span class="at">.x =</span> <span class="fu">names</span>(.), <span class="at">.y =</span> ., <span class="cf">function</span>(nm, df) {</span>
<span id="cb12-930"><a href="#cb12-930" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-931"><a href="#cb12-931" aria-hidden="true" tabindex="-1"></a>    total <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb12-932"><a href="#cb12-932" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>), <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">sum</span>(.x, <span class="dv">2</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-933"><a href="#cb12-933" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">var =</span> <span class="st">"total"</span>,</span>
<span id="cb12-934"><a href="#cb12-934" aria-hidden="true" tabindex="-1"></a>             <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-935"><a href="#cb12-935" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="sc">!!</span><span class="at">nm :=</span> var)</span>
<span id="cb12-936"><a href="#cb12-936" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-937"><a href="#cb12-937" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-938"><a href="#cb12-938" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(<span class="dv">1</span>), as.character)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-939"><a href="#cb12-939" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(total)</span>
<span id="cb12-940"><a href="#cb12-940" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-941"><a href="#cb12-941" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb12-942"><a href="#cb12-942" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-943"><a href="#cb12-943" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-944"><a href="#cb12-944" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(summ_expos) <span class="ot">&lt;-</span> nms</span>
<span id="cb12-945"><a href="#cb12-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-946"><a href="#cb12-946" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt; write to temporary csv and combine into single file, tiering-levels-exposure-premium.xlsx &gt;</span></span>
<span id="cb12-947"><a href="#cb12-947" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(summ_expos[[<span class="dv">1</span>]], <span class="st">"temp.csv"</span>)</span>
<span id="cb12-948"><a href="#cb12-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-949"><a href="#cb12-949" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load and write final data: RData ----</span></span>
<span id="cb12-950"><a href="#cb12-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-951"><a href="#cb12-951" aria-hidden="true" tabindex="-1"></a><span class="co"># load interim data</span></span>
<span id="cb12-952"><a href="#cb12-952" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined.RData"</span>)</span>
<span id="cb12-953"><a href="#cb12-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-954"><a href="#cb12-954" aria-hidden="true" tabindex="-1"></a><span class="co"># load final data</span></span>
<span id="cb12-955"><a href="#cb12-955" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined_agg_agg.RData"</span>)</span>
<span id="cb12-956"><a href="#cb12-956" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData</span><span class="sc">\\</span><span class="st">data_combined_agg_agg2.RData"</span>)</span>
<span id="cb12-957"><a href="#cb12-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-958"><a href="#cb12-958" aria-hidden="true" tabindex="-1"></a><span class="co"># write to xlsx (to avoid formatting errors) so can upload flat file into sql</span></span>
<span id="cb12-959"><a href="#cb12-959" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_combined_agg_agg, <span class="at">file =</span> <span class="st">"Excel data</span><span class="sc">\\</span><span class="st">data_combined_agg_agg.xlsx"</span>, <span class="at">na.strings =</span> <span class="st">"NA"</span>)</span>
<span id="cb12-960"><a href="#cb12-960" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_combined_agg_agg2, <span class="at">file =</span> <span class="st">"Excel data</span><span class="sc">\\</span><span class="st">data_combined_agg_agg2.xlsx"</span>, <span class="at">na.strings =</span> <span class="st">"NA"</span>)</span>
<span id="cb12-961"><a href="#cb12-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-962"><a href="#cb12-962" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-963"><a href="#cb12-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-964"><a href="#cb12-964" aria-hidden="true" tabindex="-1"></a><span class="fu">### Analysis projects</span></span>
<span id="cb12-965"><a href="#cb12-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-966"><a href="#cb12-966" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/analysis-projects.png)</span></span>
<span id="cb12-967"><a href="#cb12-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-970"><a href="#cb12-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-971"><a href="#cb12-971" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages ---- </span></span>
<span id="cb12-972"><a href="#cb12-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-973"><a href="#cb12-973" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb12-974"><a href="#cb12-974" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-975"><a href="#cb12-975" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-976"><a href="#cb12-976" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb12-977"><a href="#cb12-977" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtExtras)</span>
<span id="cb12-978"><a href="#cb12-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-979"><a href="#cb12-979" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Read in and organize data ---- </span></span>
<span id="cb12-980"><a href="#cb12-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-981"><a href="#cb12-981" aria-hidden="true" tabindex="-1"></a><span class="co"># old inforce data</span></span>
<span id="cb12-982"><a href="#cb12-982" aria-hidden="true" tabindex="-1"></a>data_inforce_old <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"InForce_20240430.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-983"><a href="#cb12-983" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-984"><a href="#cb12-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="st">"2024-04-30"</span>), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-985"><a href="#cb12-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-986"><a href="#cb12-986" aria-hidden="true" tabindex="-1"></a><span class="co"># new inforce data</span></span>
<span id="cb12-987"><a href="#cb12-987" aria-hidden="true" tabindex="-1"></a>data_inforce_new <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"InForce_20250502.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-988"><a href="#cb12-988" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-989"><a href="#cb12-989" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="st">"2025-05-02"</span>), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-990"><a href="#cb12-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-991"><a href="#cb12-991" aria-hidden="true" tabindex="-1"></a><span class="co"># combine datsets</span></span>
<span id="cb12-992"><a href="#cb12-992" aria-hidden="true" tabindex="-1"></a>data_inforce_all <span class="ot">&lt;-</span> data_inforce_old <span class="sc">%&gt;%</span> </span>
<span id="cb12-993"><a href="#cb12-993" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_inforce_new)</span>
<span id="cb12-994"><a href="#cb12-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-995"><a href="#cb12-995" aria-hidden="true" tabindex="-1"></a><span class="co"># export for excel version of analysis</span></span>
<span id="cb12-996"><a href="#cb12-996" aria-hidden="true" tabindex="-1"></a><span class="co"># data_inforce_all %&gt;% </span></span>
<span id="cb12-997"><a href="#cb12-997" aria-hidden="true" tabindex="-1"></a><span class="co">#   openxlsx2::write_xlsx(file = "InForce_all.xlsx", na.strings = "")</span></span>
<span id="cb12-998"><a href="#cb12-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-999"><a href="#cb12-999" aria-hidden="true" tabindex="-1"></a><span class="co"># set highlight cutoff</span></span>
<span id="cb12-1000"><a href="#cb12-1000" aria-hidden="true" tabindex="-1"></a>hl_cutoff <span class="ot">&lt;-</span> <span class="fl">0.10</span></span>
<span id="cb12-1001"><a href="#cb12-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1002"><a href="#cb12-1002" aria-hidden="true" tabindex="-1"></a><span class="co"># define shortcut for conditional highlighting</span></span>
<span id="cb12-1003"><a href="#cb12-1003" aria-hidden="true" tabindex="-1"></a>format_tbl_conditional_hl_changes <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-1004"><a href="#cb12-1004" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1005"><a href="#cb12-1005" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span> </span>
<span id="cb12-1006"><a href="#cb12-1006" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb12-1007"><a href="#cb12-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>),</span>
<span id="cb12-1008"><a href="#cb12-1008" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">list</span>(</span>
<span id="cb12-1009"><a href="#cb12-1009" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_body</span>(</span>
<span id="cb12-1010"><a href="#cb12-1010" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> change,</span>
<span id="cb12-1011"><a href="#cb12-1011" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> percent_change <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> hl_cutoff</span>
<span id="cb12-1012"><a href="#cb12-1012" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-1013"><a href="#cb12-1013" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_body</span>(</span>
<span id="cb12-1014"><a href="#cb12-1014" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> percent_change,</span>
<span id="cb12-1015"><a href="#cb12-1015" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span>  percent_change <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> hl_cutoff</span>
<span id="cb12-1016"><a href="#cb12-1016" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb12-1017"><a href="#cb12-1017" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1018"><a href="#cb12-1018" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb12-1019"><a href="#cb12-1019" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"green"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>),</span>
<span id="cb12-1020"><a href="#cb12-1020" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">list</span>(</span>
<span id="cb12-1021"><a href="#cb12-1021" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_body</span>(</span>
<span id="cb12-1022"><a href="#cb12-1022" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> change,</span>
<span id="cb12-1023"><a href="#cb12-1023" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> percent_change <span class="sc">&gt;</span> hl_cutoff</span>
<span id="cb12-1024"><a href="#cb12-1024" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-1025"><a href="#cb12-1025" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cells_body</span>(</span>
<span id="cb12-1026"><a href="#cb12-1026" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> percent_change,</span>
<span id="cb12-1027"><a href="#cb12-1027" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span>  percent_change <span class="sc">&gt;</span> hl_cutoff</span>
<span id="cb12-1028"><a href="#cb12-1028" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb12-1029"><a href="#cb12-1029" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-1030"><a href="#cb12-1030" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1031"><a href="#cb12-1031" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1032"><a href="#cb12-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1033"><a href="#cb12-1033" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Nail salons ----</span></span>
<span id="cb12-1034"><a href="#cb12-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1035"><a href="#cb12-1035" aria-hidden="true" tabindex="-1"></a><span class="co"># define function</span></span>
<span id="cb12-1036"><a href="#cb12-1036" aria-hidden="true" tabindex="-1"></a>format_liability_limits <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-1037"><a href="#cb12-1037" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb12-1038"><a href="#cb12-1038" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">&lt;</span> <span class="fl">1e3</span> <span class="sc">~</span> <span class="fu">as.character</span>(x),</span>
<span id="cb12-1039"><a href="#cb12-1039" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">&lt;</span> <span class="fl">1e6</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">as.character</span>(x<span class="sc">/</span><span class="fl">1e3</span>), <span class="st">"K"</span>),</span>
<span id="cb12-1040"><a href="#cb12-1040" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">&lt;</span> <span class="fl">1e9</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">as.character</span>(x<span class="sc">/</span><span class="fl">1e6</span>), <span class="st">"M"</span>),</span>
<span id="cb12-1041"><a href="#cb12-1041" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"To be implemented..."</span></span>
<span id="cb12-1042"><a href="#cb12-1042" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-1043"><a href="#cb12-1043" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1044"><a href="#cb12-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1045"><a href="#cb12-1045" aria-hidden="true" tabindex="-1"></a><span class="co"># save sub datasets</span></span>
<span id="cb12-1046"><a href="#cb12-1046" aria-hidden="true" tabindex="-1"></a>data_nails <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1047"><a href="#cb12-1047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stillwater_class_description <span class="sc">==</span> <span class="st">"Nail Salon"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-1048"><a href="#cb12-1048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(occur_limit, aggregate_limit, premises_comp_ops_limit), format_liability_limits))</span>
<span id="cb12-1049"><a href="#cb12-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1050"><a href="#cb12-1050" aria-hidden="true" tabindex="-1"></a><span class="co"># a) How many PIF compared to same time last year?</span></span>
<span id="cb12-1051"><a href="#cb12-1051" aria-hidden="true" tabindex="-1"></a><span class="co"># d) Average Premium change</span></span>
<span id="cb12-1052"><a href="#cb12-1052" aria-hidden="true" tabindex="-1"></a>data_nails <span class="sc">%&gt;%</span> </span>
<span id="cb12-1053"><a href="#cb12-1053" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1054"><a href="#cb12-1054" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1055"><a href="#cb12-1055" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_premium =</span> <span class="fu">mean</span>(term_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1056"><a href="#cb12-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">names_to =</span> <span class="st">"statistic"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1057"><a href="#cb12-1057" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1058"><a href="#cb12-1058" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statistic =</span> <span class="fu">if_else</span>(statistic <span class="sc">==</span> <span class="st">"mean_premium"</span>, <span class="st">"avg premium"</span>, statistic),</span>
<span id="cb12-1059"><a href="#cb12-1059" aria-hidden="true" tabindex="-1"></a>         <span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1060"><a href="#cb12-1060" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1061"><a href="#cb12-1061" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1062"><a href="#cb12-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Nail salons - PIF and average premium"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1063"><a href="#cb12-1063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">statistic =</span> <span class="st">""</span>,</span>
<span id="cb12-1064"><a href="#cb12-1064" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1065"><a href="#cb12-1065" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1066"><a href="#cb12-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">rows =</span> <span class="dv">1</span>, <span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1067"><a href="#cb12-1067" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">rows =</span> <span class="dv">2</span>, <span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1068"><a href="#cb12-1068" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">rows =</span> <span class="dv">1</span>, <span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1069"><a href="#cb12-1069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">rows =</span> <span class="dv">2</span>, <span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">2</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1070"><a href="#cb12-1070" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1071"><a href="#cb12-1071" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1072"><a href="#cb12-1072" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1073"><a href="#cb12-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1074"><a href="#cb12-1074" aria-hidden="true" tabindex="-1"></a><span class="co"># b) How many have the ISO Professional Liability coverage compared to last year?</span></span>
<span id="cb12-1075"><a href="#cb12-1075" aria-hidden="true" tabindex="-1"></a>data_nails <span class="sc">%&gt;%</span> </span>
<span id="cb12-1076"><a href="#cb12-1076" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, pls_cov) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1077"><a href="#cb12-1077" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1078"><a href="#cb12-1078" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1079"><a href="#cb12-1079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1080"><a href="#cb12-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1081"><a href="#cb12-1081" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1082"><a href="#cb12-1082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Nail salons - PLS cov"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1083"><a href="#cb12-1083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1084"><a href="#cb12-1084" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1085"><a href="#cb12-1085" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1086"><a href="#cb12-1086" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1087"><a href="#cb12-1087" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">pls_cov =</span> <span class="st">"PLS cov"</span>,</span>
<span id="cb12-1088"><a href="#cb12-1088" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1089"><a href="#cb12-1089" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1090"><a href="#cb12-1090" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1091"><a href="#cb12-1091" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1092"><a href="#cb12-1092" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1093"><a href="#cb12-1093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1094"><a href="#cb12-1094" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1095"><a href="#cb12-1095" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1096"><a href="#cb12-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1097"><a href="#cb12-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1098"><a href="#cb12-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1099"><a href="#cb12-1099" aria-hidden="true" tabindex="-1"></a><span class="co"># c) Distribution of limits compared to last year?</span></span>
<span id="cb12-1100"><a href="#cb12-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1101"><a href="#cb12-1101" aria-hidden="true" tabindex="-1"></a><span class="co"># i) Liability Limits</span></span>
<span id="cb12-1102"><a href="#cb12-1102" aria-hidden="true" tabindex="-1"></a>data_nails <span class="sc">%&gt;%</span> </span>
<span id="cb12-1103"><a href="#cb12-1103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">liability_limits =</span> <span class="fu">paste</span>(occur_limit, aggregate_limit, premises_comp_ops_limit, <span class="at">sep =</span> <span class="st">"/"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1104"><a href="#cb12-1104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, liability_limits) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1105"><a href="#cb12-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,,</span>
<span id="cb12-1106"><a href="#cb12-1106" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1107"><a href="#cb12-1107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1108"><a href="#cb12-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1109"><a href="#cb12-1109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1110"><a href="#cb12-1110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Nail salons - Liability limits"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1111"><a href="#cb12-1111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1112"><a href="#cb12-1112" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1113"><a href="#cb12-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1114"><a href="#cb12-1114" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1115"><a href="#cb12-1115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">liability_limits =</span> <span class="st">"Liability limits"</span>,</span>
<span id="cb12-1116"><a href="#cb12-1116" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1117"><a href="#cb12-1117" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1118"><a href="#cb12-1118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1119"><a href="#cb12-1119" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1120"><a href="#cb12-1120" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1121"><a href="#cb12-1121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1122"><a href="#cb12-1122" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1123"><a href="#cb12-1123" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1124"><a href="#cb12-1124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1125"><a href="#cb12-1125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1126"><a href="#cb12-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1127"><a href="#cb12-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># ii)   BPP limits</span></span>
<span id="cb12-1128"><a href="#cb12-1128" aria-hidden="true" tabindex="-1"></a>breaks_pls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">25000</span>,<span class="dv">50000</span>,<span class="dv">100000</span>,<span class="dv">1000000</span>)</span>
<span id="cb12-1129"><a href="#cb12-1129" aria-hidden="true" tabindex="-1"></a>data_nails <span class="sc">%&gt;%</span> </span>
<span id="cb12-1130"><a href="#cb12-1130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bpp_loi_group =</span> <span class="fu">cut</span>(bpp_loi, <span class="at">breaks =</span> breaks_pls, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>,<span class="st">"(0,25k]"</span>,<span class="st">"(25k,50k]"</span>,<span class="st">"(50k,100k]"</span>,<span class="st">"&gt;100k"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1131"><a href="#cb12-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, bpp_loi_group) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1132"><a href="#cb12-1132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,,</span>
<span id="cb12-1133"><a href="#cb12-1133" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1134"><a href="#cb12-1134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1135"><a href="#cb12-1135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1136"><a href="#cb12-1136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1137"><a href="#cb12-1137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Nail salons - BPP LOI"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1138"><a href="#cb12-1138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1139"><a href="#cb12-1139" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1140"><a href="#cb12-1140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1141"><a href="#cb12-1141" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1142"><a href="#cb12-1142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">bpp_loi_group =</span> <span class="st">"BPP LOI"</span>,</span>
<span id="cb12-1143"><a href="#cb12-1143" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1144"><a href="#cb12-1144" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1145"><a href="#cb12-1145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1146"><a href="#cb12-1146" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1147"><a href="#cb12-1147" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1148"><a href="#cb12-1148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1149"><a href="#cb12-1149" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1150"><a href="#cb12-1150" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1151"><a href="#cb12-1151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1152"><a href="#cb12-1152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1153"><a href="#cb12-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1154"><a href="#cb12-1154" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Restaurants ----</span></span>
<span id="cb12-1155"><a href="#cb12-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1156"><a href="#cb12-1156" aria-hidden="true" tabindex="-1"></a><span class="co"># save sub datasets</span></span>
<span id="cb12-1157"><a href="#cb12-1157" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; modified raw data for class descriptions to make part b easier</span></span>
<span id="cb12-1158"><a href="#cb12-1158" aria-hidden="true" tabindex="-1"></a>data_restaurants <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1159"><a href="#cb12-1159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hierarchy_1 <span class="sc">==</span> <span class="st">"Restaurants, Eating and Drinking Places"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1160"><a href="#cb12-1160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stillwater_class_description_corrected_grouped =</span> <span class="fu">str_extract</span>(stillwater_class_description_corrected, <span class="st">".*(?=</span><span class="sc">\\</span><span class="st"> -)"</span>))</span>
<span id="cb12-1161"><a href="#cb12-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1162"><a href="#cb12-1162" aria-hidden="true" tabindex="-1"></a><span class="co"># a) How many PIF compared to same time last year?</span></span>
<span id="cb12-1163"><a href="#cb12-1163" aria-hidden="true" tabindex="-1"></a><span class="co"># e) Average Premium change</span></span>
<span id="cb12-1164"><a href="#cb12-1164" aria-hidden="true" tabindex="-1"></a>data_restaurants <span class="sc">%&gt;%</span> </span>
<span id="cb12-1165"><a href="#cb12-1165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1166"><a href="#cb12-1166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1167"><a href="#cb12-1167" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_premium =</span> <span class="fu">mean</span>(term_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1168"><a href="#cb12-1168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">names_to =</span> <span class="st">"statistic"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1169"><a href="#cb12-1169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1170"><a href="#cb12-1170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statistic =</span> <span class="fu">if_else</span>(statistic <span class="sc">==</span> <span class="st">"mean_premium"</span>, <span class="st">"avg premium"</span>, statistic),</span>
<span id="cb12-1171"><a href="#cb12-1171" aria-hidden="true" tabindex="-1"></a>         <span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1172"><a href="#cb12-1172" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1173"><a href="#cb12-1173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1174"><a href="#cb12-1174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Restaurants - PIF"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1175"><a href="#cb12-1175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1176"><a href="#cb12-1176" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1177"><a href="#cb12-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">rows =</span> <span class="dv">1</span>, <span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1178"><a href="#cb12-1178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">rows =</span> <span class="dv">2</span>, <span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1179"><a href="#cb12-1179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">rows =</span> <span class="dv">1</span>, <span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1180"><a href="#cb12-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">rows =</span> <span class="dv">2</span>, <span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">2</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1181"><a href="#cb12-1181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1182"><a href="#cb12-1182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1183"><a href="#cb12-1183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1184"><a href="#cb12-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1185"><a href="#cb12-1185" aria-hidden="true" tabindex="-1"></a><span class="co"># b) Distribution among main restaurant classes?</span></span>
<span id="cb12-1186"><a href="#cb12-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1187"><a href="#cb12-1187" aria-hidden="true" tabindex="-1"></a><span class="co"># i) Asian, Pizza, Buffet, etc. </span></span>
<span id="cb12-1188"><a href="#cb12-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1189"><a href="#cb12-1189" aria-hidden="true" tabindex="-1"></a><span class="co"># find counts for all classes</span></span>
<span id="cb12-1190"><a href="#cb12-1190" aria-hidden="true" tabindex="-1"></a>data_restaurants_regrouped <span class="ot">&lt;-</span> data_restaurants <span class="sc">%&gt;%</span></span>
<span id="cb12-1191"><a href="#cb12-1191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date, stillwater_class_description_corrected_grouped) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1192"><a href="#cb12-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1193"><a href="#cb12-1193" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_sales =</span> <span class="fu">mean</span>(sales),</span>
<span id="cb12-1194"><a href="#cb12-1194" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_premium =</span> <span class="fu">mean</span>(term_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1195"><a href="#cb12-1195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1196"><a href="#cb12-1196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1197"><a href="#cb12-1197" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb12-1198"><a href="#cb12-1198" aria-hidden="true" tabindex="-1"></a>         <span class="at">.after =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1199"><a href="#cb12-1199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1200"><a href="#cb12-1200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stillwater_class_description_corrected_grouped =</span> </span>
<span id="cb12-1201"><a href="#cb12-1201" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-1202"><a href="#cb12-1202" aria-hidden="true" tabindex="-1"></a>             n <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb12-1203"><a href="#cb12-1203" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> stillwater_class_description_corrected_grouped</span>
<span id="cb12-1204"><a href="#cb12-1204" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb12-1205"><a href="#cb12-1205" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb12-1206"><a href="#cb12-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1207"><a href="#cb12-1207" aria-hidden="true" tabindex="-1"></a><span class="co"># create counts for summary other row</span></span>
<span id="cb12-1208"><a href="#cb12-1208" aria-hidden="true" tabindex="-1"></a>data_restaurants_regrouped_other <span class="ot">&lt;-</span> data_restaurants_regrouped <span class="sc">%&gt;%</span> </span>
<span id="cb12-1209"><a href="#cb12-1209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stillwater_class_description_corrected_grouped <span class="sc">==</span> <span class="st">"Other"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1210"><a href="#cb12-1210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">temp1 =</span> n <span class="sc">*</span> mean_sales,</span>
<span id="cb12-1211"><a href="#cb12-1211" aria-hidden="true" tabindex="-1"></a>         <span class="at">temp2 =</span> n<span class="sc">*</span> mean_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1212"><a href="#cb12-1212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date, stillwater_class_description_corrected_grouped) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1213"><a href="#cb12-1213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">sum</span>(n),</span>
<span id="cb12-1214"><a href="#cb12-1214" aria-hidden="true" tabindex="-1"></a>            <span class="at">percent =</span> <span class="fu">sum</span>(percent),</span>
<span id="cb12-1215"><a href="#cb12-1215" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_sales =</span> <span class="fu">sum</span>(temp1) <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb12-1216"><a href="#cb12-1216" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_premium =</span> <span class="fu">sum</span>(temp2) <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb12-1217"><a href="#cb12-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1218"><a href="#cb12-1218" aria-hidden="true" tabindex="-1"></a><span class="co"># define helper function</span></span>
<span id="cb12-1219"><a href="#cb12-1219" aria-hidden="true" tabindex="-1"></a>grouped_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x, n) {</span>
<span id="cb12-1220"><a href="#cb12-1220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(x<span class="sc">*</span>n) <span class="sc">/</span> <span class="fu">sum</span>(n)</span>
<span id="cb12-1221"><a href="#cb12-1221" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-1222"><a href="#cb12-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1223"><a href="#cb12-1223" aria-hidden="true" tabindex="-1"></a><span class="co"># create final table</span></span>
<span id="cb12-1224"><a href="#cb12-1224" aria-hidden="true" tabindex="-1"></a>data_restaurants_regrouped <span class="sc">%&gt;%</span> </span>
<span id="cb12-1225"><a href="#cb12-1225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stillwater_class_description_corrected_grouped <span class="sc">!=</span> <span class="st">"Other"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1226"><a href="#cb12-1226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_restaurants_regrouped_other) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1227"><a href="#cb12-1227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>(<span class="at">groupname_col =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1228"><a href="#cb12-1228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Restaurants - PIF, sales and premium by class"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1229"><a href="#cb12-1229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">stillwater_class_description_corrected_grouped =</span> <span class="st">"class description"</span>,</span>
<span id="cb12-1230"><a href="#cb12-1230" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_sales =</span> <span class="st">"avg sales"</span>,</span>
<span id="cb12-1231"><a href="#cb12-1231" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_premium =</span> <span class="st">"avg premium"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1232"><a href="#cb12-1232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rows</span>(<span class="at">columns =</span> n,</span>
<span id="cb12-1233"><a href="#cb12-1233" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">sum</span>(.x)),</span>
<span id="cb12-1234"><a href="#cb12-1234" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1235"><a href="#cb12-1235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rows</span>(<span class="at">columns =</span> percent,</span>
<span id="cb12-1236"><a href="#cb12-1236" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">sum</span>(.x)),</span>
<span id="cb12-1237"><a href="#cb12-1237" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1238"><a href="#cb12-1238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rows</span>(<span class="at">columns =</span> mean_sales,</span>
<span id="cb12-1239"><a href="#cb12-1239" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">grouped_mean</span>(mean_sales, n)),</span>
<span id="cb12-1240"><a href="#cb12-1240" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_currency</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-1241"><a href="#cb12-1241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rows</span>(<span class="at">columns =</span> mean_premium,</span>
<span id="cb12-1242"><a href="#cb12-1242" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">grouped_mean</span>(mean_premium, n)),</span>
<span id="cb12-1243"><a href="#cb12-1243" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_currency</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1244"><a href="#cb12-1244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> n, <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1245"><a href="#cb12-1245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent, <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1246"><a href="#cb12-1246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> <span class="fu">c</span>(mean_sales, mean_premium), <span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb12-1247"><a href="#cb12-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1248"><a href="#cb12-1248" aria-hidden="true" tabindex="-1"></a><span class="co"># ii) Alcohol percent distributions - Percent of policies with LQL</span></span>
<span id="cb12-1249"><a href="#cb12-1249" aria-hidden="true" tabindex="-1"></a>data_restaurants <span class="sc">%&gt;%</span> </span>
<span id="cb12-1250"><a href="#cb12-1250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, lql_cov) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1251"><a href="#cb12-1251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1252"><a href="#cb12-1252" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1253"><a href="#cb12-1253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1254"><a href="#cb12-1254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1255"><a href="#cb12-1255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1256"><a href="#cb12-1256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Restaurants - LQL cov"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1257"><a href="#cb12-1257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1258"><a href="#cb12-1258" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1259"><a href="#cb12-1259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1260"><a href="#cb12-1260" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1261"><a href="#cb12-1261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">lql_cov =</span> <span class="st">"LQL cov"</span>,</span>
<span id="cb12-1262"><a href="#cb12-1262" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1263"><a href="#cb12-1263" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1264"><a href="#cb12-1264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1265"><a href="#cb12-1265" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1266"><a href="#cb12-1266" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1267"><a href="#cb12-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1268"><a href="#cb12-1268" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1269"><a href="#cb12-1269" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1270"><a href="#cb12-1270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1271"><a href="#cb12-1271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1272"><a href="#cb12-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1273"><a href="#cb12-1273" aria-hidden="true" tabindex="-1"></a><span class="co"># c) Percent with Building coverage</span></span>
<span id="cb12-1274"><a href="#cb12-1274" aria-hidden="true" tabindex="-1"></a>data_restaurants <span class="sc">%&gt;%</span> </span>
<span id="cb12-1275"><a href="#cb12-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, bdg_cov) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1276"><a href="#cb12-1276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1277"><a href="#cb12-1277" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1278"><a href="#cb12-1278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1279"><a href="#cb12-1279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1280"><a href="#cb12-1280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1281"><a href="#cb12-1281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Restaurants - BDG cov"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1282"><a href="#cb12-1282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1283"><a href="#cb12-1283" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1284"><a href="#cb12-1284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1285"><a href="#cb12-1285" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1286"><a href="#cb12-1286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">bdg_cov =</span> <span class="st">"BDG cov"</span>,</span>
<span id="cb12-1287"><a href="#cb12-1287" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1288"><a href="#cb12-1288" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1289"><a href="#cb12-1289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1290"><a href="#cb12-1290" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1291"><a href="#cb12-1291" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1292"><a href="#cb12-1292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1293"><a href="#cb12-1293" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1294"><a href="#cb12-1294" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1295"><a href="#cb12-1295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1296"><a href="#cb12-1296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1297"><a href="#cb12-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1298"><a href="#cb12-1298" aria-hidden="true" tabindex="-1"></a><span class="co"># d) Annual Sales averages / distributions compared to last year</span></span>
<span id="cb12-1299"><a href="#cb12-1299" aria-hidden="true" tabindex="-1"></a>data_restaurants <span class="sc">%&gt;%</span> </span>
<span id="cb12-1300"><a href="#cb12-1300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1301"><a href="#cb12-1301" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(sales, <span class="fu">c</span>(<span class="at">mean =</span> mean, <span class="at">sd =</span> sd, <span class="at">median =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max), <span class="at">.names =</span> <span class="st">"{.fn}"</span>),</span>
<span id="cb12-1302"><a href="#cb12-1302" aria-hidden="true" tabindex="-1"></a>            <span class="at">q1 =</span> <span class="fu">quantile</span>(sales, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>)),</span>
<span id="cb12-1303"><a href="#cb12-1303" aria-hidden="true" tabindex="-1"></a>            <span class="at">q3 =</span> <span class="fu">quantile</span>(sales, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.75</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1304"><a href="#cb12-1304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, min, q1, median, mean, q3, max, sd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1305"><a href="#cb12-1305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>date, <span class="at">names_to =</span> <span class="st">"statistic"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1306"><a href="#cb12-1306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1307"><a href="#cb12-1307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1308"><a href="#cb12-1308" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1309"><a href="#cb12-1309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1310"><a href="#cb12-1310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Restaurants - Annual sales"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1311"><a href="#cb12-1311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">statistic =</span> <span class="st">""</span>,</span>
<span id="cb12-1312"><a href="#cb12-1312" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1313"><a href="#cb12-1313" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1314"><a href="#cb12-1314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1315"><a href="#cb12-1315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1316"><a href="#cb12-1316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1317"><a href="#cb12-1317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1318"><a href="#cb12-1318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1319"><a href="#cb12-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1320"><a href="#cb12-1320" aria-hidden="true" tabindex="-1"></a><span class="co"># i) By class</span></span>
<span id="cb12-1321"><a href="#cb12-1321" aria-hidden="true" tabindex="-1"></a><span class="co"># see part b) i)) above</span></span>
<span id="cb12-1322"><a href="#cb12-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1323"><a href="#cb12-1323" aria-hidden="true" tabindex="-1"></a><span class="co"># e) Average Premium change</span></span>
<span id="cb12-1324"><a href="#cb12-1324" aria-hidden="true" tabindex="-1"></a><span class="co"># see above part a)</span></span>
<span id="cb12-1325"><a href="#cb12-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1326"><a href="#cb12-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># i) By Class</span></span>
<span id="cb12-1327"><a href="#cb12-1327" aria-hidden="true" tabindex="-1"></a><span class="co"># see part b) i)) above</span></span>
<span id="cb12-1328"><a href="#cb12-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1329"><a href="#cb12-1329" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Lessorâ€™s risks / commercial landlords ----</span></span>
<span id="cb12-1330"><a href="#cb12-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1331"><a href="#cb12-1331" aria-hidden="true" tabindex="-1"></a><span class="co"># save sub datasets</span></span>
<span id="cb12-1332"><a href="#cb12-1332" aria-hidden="true" tabindex="-1"></a>data_lessors <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1333"><a href="#cb12-1333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lessor <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1334"><a href="#cb12-1334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hierarchy_1_grouped =</span> </span>
<span id="cb12-1335"><a href="#cb12-1335" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-1336"><a href="#cb12-1336" aria-hidden="true" tabindex="-1"></a>             hierarchy_1 <span class="sc">==</span> <span class="st">"Landlord (aka Lessor)"</span> <span class="sc">~</span> hierarchy_1,</span>
<span id="cb12-1337"><a href="#cb12-1337" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> <span class="st">"Other"</span></span>
<span id="cb12-1338"><a href="#cb12-1338" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb12-1339"><a href="#cb12-1339" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb12-1340"><a href="#cb12-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1341"><a href="#cb12-1341" aria-hidden="true" tabindex="-1"></a><span class="co"># a) PIF compared to last year</span></span>
<span id="cb12-1342"><a href="#cb12-1342" aria-hidden="true" tabindex="-1"></a>data_lessors <span class="sc">%&gt;%</span> </span>
<span id="cb12-1343"><a href="#cb12-1343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, occupy, hierarchy_1_grouped) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1344"><a href="#cb12-1344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1345"><a href="#cb12-1345" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1346"><a href="#cb12-1346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1347"><a href="#cb12-1347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1348"><a href="#cb12-1348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1349"><a href="#cb12-1349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Lessor's risks / commercial landlords - PIF"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1350"><a href="#cb12-1350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1351"><a href="#cb12-1351" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1352"><a href="#cb12-1352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1353"><a href="#cb12-1353" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1354"><a href="#cb12-1354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">hierarchy_1_grouped =</span> <span class="st">"hierarchy 1"</span>,</span>
<span id="cb12-1355"><a href="#cb12-1355" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1356"><a href="#cb12-1356" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1357"><a href="#cb12-1357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1358"><a href="#cb12-1358" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1359"><a href="#cb12-1359" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1360"><a href="#cb12-1360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1361"><a href="#cb12-1361" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1362"><a href="#cb12-1362" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1363"><a href="#cb12-1363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1364"><a href="#cb12-1364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1365"><a href="#cb12-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1366"><a href="#cb12-1366" aria-hidden="true" tabindex="-1"></a><span class="co"># b) Distribution of Building Limits â€“ how has it changed in last year?</span></span>
<span id="cb12-1367"><a href="#cb12-1367" aria-hidden="true" tabindex="-1"></a>data_lessors <span class="sc">%&gt;%</span> </span>
<span id="cb12-1368"><a href="#cb12-1368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1369"><a href="#cb12-1369" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(date),</span>
<span id="cb12-1370"><a href="#cb12-1370" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(bdg_loi, <span class="fu">c</span>(<span class="at">mean =</span> mean, <span class="at">sd =</span> sd, <span class="at">median =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max), <span class="at">.names =</span> <span class="st">"{.fn}"</span>),</span>
<span id="cb12-1371"><a href="#cb12-1371" aria-hidden="true" tabindex="-1"></a>            <span class="at">q1 =</span> <span class="fu">quantile</span>(bdg_loi, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>)),</span>
<span id="cb12-1372"><a href="#cb12-1372" aria-hidden="true" tabindex="-1"></a>            <span class="at">q3 =</span> <span class="fu">quantile</span>(bdg_loi, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.75</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1373"><a href="#cb12-1373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, min, q1, median, mean, q3, max, sd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1374"><a href="#cb12-1374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"statistic"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1375"><a href="#cb12-1375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1376"><a href="#cb12-1376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1377"><a href="#cb12-1377" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1378"><a href="#cb12-1378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1379"><a href="#cb12-1379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Lessor's risks / commercial landlords - BDG LOI"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1380"><a href="#cb12-1380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">statistic =</span> <span class="st">""</span>,</span>
<span id="cb12-1381"><a href="#cb12-1381" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1382"><a href="#cb12-1382" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1383"><a href="#cb12-1383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1384"><a href="#cb12-1384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1385"><a href="#cb12-1385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1386"><a href="#cb12-1386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1387"><a href="#cb12-1387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1388"><a href="#cb12-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1389"><a href="#cb12-1389" aria-hidden="true" tabindex="-1"></a><span class="co"># c) Deductible distributions</span></span>
<span id="cb12-1390"><a href="#cb12-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1391"><a href="#cb12-1391" aria-hidden="true" tabindex="-1"></a><span class="co"># â€“&gt; all perils</span></span>
<span id="cb12-1392"><a href="#cb12-1392" aria-hidden="true" tabindex="-1"></a>data_lessors <span class="sc">%&gt;%</span> </span>
<span id="cb12-1393"><a href="#cb12-1393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, aop_deduct) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1394"><a href="#cb12-1394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1395"><a href="#cb12-1395" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1396"><a href="#cb12-1396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1397"><a href="#cb12-1397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1398"><a href="#cb12-1398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1399"><a href="#cb12-1399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Lessor's risks / commercial landlords - All other perils deductibles"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1400"><a href="#cb12-1400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1401"><a href="#cb12-1401" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1402"><a href="#cb12-1402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1403"><a href="#cb12-1403" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1404"><a href="#cb12-1404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">aop_deduct =</span> <span class="st">"AOP ded"</span>,</span>
<span id="cb12-1405"><a href="#cb12-1405" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1406"><a href="#cb12-1406" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1407"><a href="#cb12-1407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1408"><a href="#cb12-1408" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1409"><a href="#cb12-1409" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1410"><a href="#cb12-1410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1411"><a href="#cb12-1411" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1412"><a href="#cb12-1412" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1413"><a href="#cb12-1413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"n"</span>), aop_deduct), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1414"><a href="#cb12-1414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1415"><a href="#cb12-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1416"><a href="#cb12-1416" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; wind/hail</span></span>
<span id="cb12-1417"><a href="#cb12-1417" aria-hidden="true" tabindex="-1"></a>data_lessors <span class="sc">%&gt;%</span> </span>
<span id="cb12-1418"><a href="#cb12-1418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, wh_percent_deduct, wh_dollar_deduct) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1419"><a href="#cb12-1419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1420"><a href="#cb12-1420" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1421"><a href="#cb12-1421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1422"><a href="#cb12-1422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1423"><a href="#cb12-1423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1424"><a href="#cb12-1424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Lessor's risks / commercial landlords - Wind / Hail deductibles"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1425"><a href="#cb12-1425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1426"><a href="#cb12-1426" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1427"><a href="#cb12-1427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1428"><a href="#cb12-1428" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1429"><a href="#cb12-1429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">wh_percent_deduct =</span> <span class="st">"W/H % ded"</span>,</span>
<span id="cb12-1430"><a href="#cb12-1430" aria-hidden="true" tabindex="-1"></a>             <span class="at">wh_dollar_deduct =</span> <span class="st">"W/H $ ded"</span>,</span>
<span id="cb12-1431"><a href="#cb12-1431" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1432"><a href="#cb12-1432" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1433"><a href="#cb12-1433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1434"><a href="#cb12-1434" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1435"><a href="#cb12-1435" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1436"><a href="#cb12-1436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1437"><a href="#cb12-1437" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1438"><a href="#cb12-1438" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1439"><a href="#cb12-1439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="fu">contains</span>(<span class="st">"dollar"</span>)), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1440"><a href="#cb12-1440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1441"><a href="#cb12-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1442"><a href="#cb12-1442" aria-hidden="true" tabindex="-1"></a><span class="co"># d) Age of building distribution and compared to last year</span></span>
<span id="cb12-1443"><a href="#cb12-1443" aria-hidden="true" tabindex="-1"></a>data_lessors <span class="sc">%&gt;%</span> </span>
<span id="cb12-1444"><a href="#cb12-1444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">building_age =</span> <span class="fu">subtract</span>(date <span class="sc">%&gt;%</span> year, year_built)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1445"><a href="#cb12-1445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1446"><a href="#cb12-1446" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(date),</span>
<span id="cb12-1447"><a href="#cb12-1447" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(building_age, <span class="fu">c</span>(<span class="at">mean =</span> mean, <span class="at">sd =</span> sd, <span class="at">median =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max), <span class="at">.names =</span> <span class="st">"{.fn}"</span>),</span>
<span id="cb12-1448"><a href="#cb12-1448" aria-hidden="true" tabindex="-1"></a>            <span class="at">q1 =</span> <span class="fu">quantile</span>(building_age, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>)),</span>
<span id="cb12-1449"><a href="#cb12-1449" aria-hidden="true" tabindex="-1"></a>            <span class="at">q3 =</span> <span class="fu">quantile</span>(building_age, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.75</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1450"><a href="#cb12-1450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, min, q1, median, mean, q3, max, sd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1451"><a href="#cb12-1451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"statistic"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1452"><a href="#cb12-1452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1453"><a href="#cb12-1453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1454"><a href="#cb12-1454" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1455"><a href="#cb12-1455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1456"><a href="#cb12-1456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Lessor's risks / commercial landlords - Age of building"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1457"><a href="#cb12-1457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">statistic =</span> <span class="st">""</span>,</span>
<span id="cb12-1458"><a href="#cb12-1458" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1459"><a href="#cb12-1459" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1460"><a href="#cb12-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1461"><a href="#cb12-1461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1462"><a href="#cb12-1462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1463"><a href="#cb12-1463" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1464"><a href="#cb12-1464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1465"><a href="#cb12-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1466"><a href="#cb12-1466" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Roofs ----</span></span>
<span id="cb12-1467"><a href="#cb12-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1468"><a href="#cb12-1468" aria-hidden="true" tabindex="-1"></a><span class="co"># split data</span></span>
<span id="cb12-1469"><a href="#cb12-1469" aria-hidden="true" tabindex="-1"></a>data_bdg <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1470"><a href="#cb12-1470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">building =</span> <span class="fu">if_else</span>(building_owned <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">|</span> bdg_cov <span class="sc">==</span> <span class="st">"Y"</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>))</span>
<span id="cb12-1471"><a href="#cb12-1471" aria-hidden="true" tabindex="-1"></a>data_roofs <span class="ot">&lt;-</span> data_bdg <span class="sc">%&gt;%</span> </span>
<span id="cb12-1472"><a href="#cb12-1472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>building)</span>
<span id="cb12-1473"><a href="#cb12-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1474"><a href="#cb12-1474" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) look at own buildings</span></span>
<span id="cb12-1475"><a href="#cb12-1475" aria-hidden="true" tabindex="-1"></a>data_bdg <span class="sc">%&gt;%</span> </span>
<span id="cb12-1476"><a href="#cb12-1476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, building_owned, bdg_cov) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1477"><a href="#cb12-1477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1478"><a href="#cb12-1478" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1479"><a href="#cb12-1479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1480"><a href="#cb12-1480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1481"><a href="#cb12-1481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1482"><a href="#cb12-1482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Own building / building coverage"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1483"><a href="#cb12-1483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1484"><a href="#cb12-1484" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1485"><a href="#cb12-1485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1486"><a href="#cb12-1486" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1487"><a href="#cb12-1487" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">building_owned =</span> <span class="st">"Own building?"</span>,</span>
<span id="cb12-1488"><a href="#cb12-1488" aria-hidden="true" tabindex="-1"></a>             <span class="at">bdg_cov =</span> <span class="st">"BDG cov?"</span>,</span>
<span id="cb12-1489"><a href="#cb12-1489" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1490"><a href="#cb12-1490" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1491"><a href="#cb12-1491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1492"><a href="#cb12-1492" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1493"><a href="#cb12-1493" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1494"><a href="#cb12-1494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1495"><a href="#cb12-1495" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1496"><a href="#cb12-1496" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1497"><a href="#cb12-1497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="fu">contains</span>(<span class="st">"dollar"</span>)), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1498"><a href="#cb12-1498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1499"><a href="#cb12-1499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-1500"><a href="#cb12-1500" aria-hidden="true" tabindex="-1"></a><span class="co"># a) Distribution of roof types</span></span>
<span id="cb12-1501"><a href="#cb12-1501" aria-hidden="true" tabindex="-1"></a>data_roofs[[<span class="st">"FALSE"</span>]] <span class="sc">%&gt;%</span>  </span>
<span id="cb12-1502"><a href="#cb12-1502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, roof_type) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1503"><a href="#cb12-1503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1504"><a href="#cb12-1504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1505"><a href="#cb12-1505" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1506"><a href="#cb12-1506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1507"><a href="#cb12-1507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1508"><a href="#cb12-1508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1509"><a href="#cb12-1509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Roofs - No BDG cov - Type"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1510"><a href="#cb12-1510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1511"><a href="#cb12-1511" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1512"><a href="#cb12-1512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1513"><a href="#cb12-1513" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1514"><a href="#cb12-1514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">roof_type =</span> <span class="st">"Type"</span>,</span>
<span id="cb12-1515"><a href="#cb12-1515" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1516"><a href="#cb12-1516" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1517"><a href="#cb12-1517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1518"><a href="#cb12-1518" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1519"><a href="#cb12-1519" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1520"><a href="#cb12-1520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1521"><a href="#cb12-1521" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1522"><a href="#cb12-1522" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1523"><a href="#cb12-1523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1524"><a href="#cb12-1524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1525"><a href="#cb12-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1526"><a href="#cb12-1526" aria-hidden="true" tabindex="-1"></a>data_roofs[[<span class="st">"TRUE"</span>]] <span class="sc">%&gt;%</span>  </span>
<span id="cb12-1527"><a href="#cb12-1527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, roof_type) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1528"><a href="#cb12-1528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1529"><a href="#cb12-1529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1530"><a href="#cb12-1530" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1531"><a href="#cb12-1531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1532"><a href="#cb12-1532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1533"><a href="#cb12-1533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1534"><a href="#cb12-1534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Roofs - BDG cov - Type"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1535"><a href="#cb12-1535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1536"><a href="#cb12-1536" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1537"><a href="#cb12-1537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1538"><a href="#cb12-1538" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1539"><a href="#cb12-1539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">roof_type =</span> <span class="st">"Type"</span>,</span>
<span id="cb12-1540"><a href="#cb12-1540" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1541"><a href="#cb12-1541" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1542"><a href="#cb12-1542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1543"><a href="#cb12-1543" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1544"><a href="#cb12-1544" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1545"><a href="#cb12-1545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1546"><a href="#cb12-1546" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1547"><a href="#cb12-1547" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1548"><a href="#cb12-1548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1549"><a href="#cb12-1549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1550"><a href="#cb12-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1551"><a href="#cb12-1551" aria-hidden="true" tabindex="-1"></a><span class="co"># b) Age of roof distributions</span></span>
<span id="cb12-1552"><a href="#cb12-1552" aria-hidden="true" tabindex="-1"></a>data_roofs[[<span class="st">"FALSE"</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb12-1553"><a href="#cb12-1553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">roof_age =</span> <span class="fu">subtract</span>(date <span class="sc">%&gt;%</span> year, roof_year)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1554"><a href="#cb12-1554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1555"><a href="#cb12-1555" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(date),</span>
<span id="cb12-1556"><a href="#cb12-1556" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(roof_age, <span class="fu">c</span>(<span class="at">mean =</span> mean, <span class="at">sd =</span> sd, <span class="at">median =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max), <span class="at">.names =</span> <span class="st">"{.fn}"</span>),</span>
<span id="cb12-1557"><a href="#cb12-1557" aria-hidden="true" tabindex="-1"></a>            <span class="at">q1 =</span> <span class="fu">quantile</span>(roof_age, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-1558"><a href="#cb12-1558" aria-hidden="true" tabindex="-1"></a>            <span class="at">q3 =</span> <span class="fu">quantile</span>(roof_age, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.75</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1559"><a href="#cb12-1559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, min, q1, median, mean, q3, max, sd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1560"><a href="#cb12-1560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"statistic"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1561"><a href="#cb12-1561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1562"><a href="#cb12-1562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1563"><a href="#cb12-1563" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1564"><a href="#cb12-1564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1565"><a href="#cb12-1565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Roofs - No BDG cov - Age"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1566"><a href="#cb12-1566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">statistic =</span> <span class="st">""</span>,</span>
<span id="cb12-1567"><a href="#cb12-1567" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1568"><a href="#cb12-1568" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1569"><a href="#cb12-1569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1570"><a href="#cb12-1570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1571"><a href="#cb12-1571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1572"><a href="#cb12-1572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1573"><a href="#cb12-1573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1574"><a href="#cb12-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1575"><a href="#cb12-1575" aria-hidden="true" tabindex="-1"></a>data_roofs[[<span class="st">"TRUE"</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb12-1576"><a href="#cb12-1576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">roof_age =</span> <span class="fu">subtract</span>(date <span class="sc">%&gt;%</span> year, roof_year)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1577"><a href="#cb12-1577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1578"><a href="#cb12-1578" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(date),</span>
<span id="cb12-1579"><a href="#cb12-1579" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(roof_age, <span class="fu">c</span>(<span class="at">mean =</span> mean, <span class="at">sd =</span> sd, <span class="at">median =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max), <span class="at">.names =</span> <span class="st">"{.fn}"</span>),</span>
<span id="cb12-1580"><a href="#cb12-1580" aria-hidden="true" tabindex="-1"></a>            <span class="at">q1 =</span> <span class="fu">quantile</span>(roof_age, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-1581"><a href="#cb12-1581" aria-hidden="true" tabindex="-1"></a>            <span class="at">q3 =</span> <span class="fu">quantile</span>(roof_age, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.75</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1582"><a href="#cb12-1582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, min, q1, median, mean, q3, max, sd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1583"><a href="#cb12-1583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"statistic"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1584"><a href="#cb12-1584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1585"><a href="#cb12-1585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1586"><a href="#cb12-1586" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1587"><a href="#cb12-1587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1588"><a href="#cb12-1588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Roofs - BDG cov - Age"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1589"><a href="#cb12-1589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">statistic =</span> <span class="st">""</span>,</span>
<span id="cb12-1590"><a href="#cb12-1590" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1591"><a href="#cb12-1591" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1592"><a href="#cb12-1592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1593"><a href="#cb12-1593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1594"><a href="#cb12-1594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1595"><a href="#cb12-1595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1596"><a href="#cb12-1596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1597"><a href="#cb12-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1598"><a href="#cb12-1598" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Classes ----</span></span>
<span id="cb12-1599"><a href="#cb12-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1600"><a href="#cb12-1600" aria-hidden="true" tabindex="-1"></a><span class="co"># a) How has our overall policy count by classes and Program changed over the past year?</span></span>
<span id="cb12-1601"><a href="#cb12-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1602"><a href="#cb12-1602" aria-hidden="true" tabindex="-1"></a><span class="co"># find counts for all classes</span></span>
<span id="cb12-1603"><a href="#cb12-1603" aria-hidden="true" tabindex="-1"></a>data_classes_regrouped <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span></span>
<span id="cb12-1604"><a href="#cb12-1604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, stillwater_class_description_corrected) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1605"><a href="#cb12-1605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1606"><a href="#cb12-1606" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n),</span>
<span id="cb12-1607"><a href="#cb12-1607" aria-hidden="true" tabindex="-1"></a>         <span class="at">.after =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1608"><a href="#cb12-1608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1609"><a href="#cb12-1609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stillwater_class_description_corrected =</span> </span>
<span id="cb12-1610"><a href="#cb12-1610" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-1611"><a href="#cb12-1611" aria-hidden="true" tabindex="-1"></a>             n <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb12-1612"><a href="#cb12-1612" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> stillwater_class_description_corrected</span>
<span id="cb12-1613"><a href="#cb12-1613" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-1614"><a href="#cb12-1614" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb12-1615"><a href="#cb12-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1616"><a href="#cb12-1616" aria-hidden="true" tabindex="-1"></a><span class="co"># create counts for summary other row</span></span>
<span id="cb12-1617"><a href="#cb12-1617" aria-hidden="true" tabindex="-1"></a>data_classes_regrouped_other <span class="ot">&lt;-</span> data_classes_regrouped <span class="sc">%&gt;%</span> </span>
<span id="cb12-1618"><a href="#cb12-1618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stillwater_class_description_corrected <span class="sc">==</span> <span class="st">"Other"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1619"><a href="#cb12-1619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date, stillwater_class_description_corrected) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1620"><a href="#cb12-1620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">sum</span>(n),</span>
<span id="cb12-1621"><a href="#cb12-1621" aria-hidden="true" tabindex="-1"></a>            <span class="at">percent =</span> <span class="fu">sum</span>(percent))</span>
<span id="cb12-1622"><a href="#cb12-1622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1623"><a href="#cb12-1623" aria-hidden="true" tabindex="-1"></a><span class="co"># create final table</span></span>
<span id="cb12-1624"><a href="#cb12-1624" aria-hidden="true" tabindex="-1"></a>data_classes_regrouped <span class="sc">%&gt;%</span> </span>
<span id="cb12-1625"><a href="#cb12-1625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(stillwater_class_description_corrected <span class="sc">!=</span> <span class="st">"Other"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1626"><a href="#cb12-1626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_classes_regrouped_other) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1627"><a href="#cb12-1627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>(<span class="at">groupname_col =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1628"><a href="#cb12-1628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Classes - PIF"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1629"><a href="#cb12-1629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">stillwater_class_description_corrected =</span> <span class="st">"class description"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1630"><a href="#cb12-1630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rows</span>(<span class="at">columns =</span> n,</span>
<span id="cb12-1631"><a href="#cb12-1631" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">sum</span>(.x)),</span>
<span id="cb12-1632"><a href="#cb12-1632" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1633"><a href="#cb12-1633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rows</span>(<span class="at">columns =</span> percent,</span>
<span id="cb12-1634"><a href="#cb12-1634" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">sum</span>(.x)),</span>
<span id="cb12-1635"><a href="#cb12-1635" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1636"><a href="#cb12-1636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> n, <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1637"><a href="#cb12-1637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent, <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1638"><a href="#cb12-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1639"><a href="#cb12-1639" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- States ----</span></span>
<span id="cb12-1640"><a href="#cb12-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1641"><a href="#cb12-1641" aria-hidden="true" tabindex="-1"></a><span class="co"># a) Which states are growing and shrinking? By how much?</span></span>
<span id="cb12-1642"><a href="#cb12-1642" aria-hidden="true" tabindex="-1"></a>data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1643"><a href="#cb12-1643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date, policy_state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1644"><a href="#cb12-1644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1645"><a href="#cb12-1645" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_premium =</span> <span class="fu">mean</span>(term_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1646"><a href="#cb12-1646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1647"><a href="#cb12-1647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, mean_premium), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1648"><a href="#cb12-1648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_change =</span> <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1649"><a href="#cb12-1649" aria-hidden="true" tabindex="-1"></a>         <span class="at">n_percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(n_change <span class="sc">/</span> <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(n_change <span class="sc">/</span> <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(n_change <span class="sc">/</span> <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, n_change <span class="sc">/</span> <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>),</span>
<span id="cb12-1650"><a href="#cb12-1650" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean_premium_change =</span> <span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1651"><a href="#cb12-1651" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean_premium_percent_change =</span> mean_premium_change <span class="sc">/</span> <span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1652"><a href="#cb12-1652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_state, <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>, n_change, n_percent_change, <span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span>, mean_premium_change, mean_premium_percent_change) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1653"><a href="#cb12-1653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1654"><a href="#cb12-1654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"States - PIF"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1655"><a href="#cb12-1655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>, n_change, n_percent_change),</span>
<span id="cb12-1656"><a href="#cb12-1656" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1657"><a href="#cb12-1657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span>, mean_premium_change, mean_premium_percent_change),</span>
<span id="cb12-1658"><a href="#cb12-1658" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"mean premium"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1659"><a href="#cb12-1659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">policy_state =</span> <span class="st">"State"</span>,</span>
<span id="cb12-1660"><a href="#cb12-1660" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"2024-04-30"</span>,</span>
<span id="cb12-1661"><a href="#cb12-1661" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"2025-05-02"</span>,</span>
<span id="cb12-1662"><a href="#cb12-1662" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"2024-04-30"</span>,</span>
<span id="cb12-1663"><a href="#cb12-1663" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"2025-05-02"</span>,</span>
<span id="cb12-1664"><a href="#cb12-1664" aria-hidden="true" tabindex="-1"></a>             <span class="at">n_change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1665"><a href="#cb12-1665" aria-hidden="true" tabindex="-1"></a>             <span class="at">n_percent_change =</span> <span class="st">"% change"</span>,</span>
<span id="cb12-1666"><a href="#cb12-1666" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_premium_change =</span> <span class="st">"$ change"</span>,</span>
<span id="cb12-1667"><a href="#cb12-1667" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_premium_percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1668"><a href="#cb12-1668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>),</span>
<span id="cb12-1669"><a href="#cb12-1669" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1670"><a href="#cb12-1670" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1671"><a href="#cb12-1671" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1672"><a href="#cb12-1672" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">grouped_mean</span>(.x, <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>)),</span>
<span id="cb12-1673"><a href="#cb12-1673" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_currency</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1674"><a href="#cb12-1674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span>,</span>
<span id="cb12-1675"><a href="#cb12-1675" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">grouped_mean</span>(.x, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>)),</span>
<span id="cb12-1676"><a href="#cb12-1676" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_currency</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1677"><a href="#cb12-1677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns  =</span> n_change,</span>
<span id="cb12-1678"><a href="#cb12-1678" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1679"><a href="#cb12-1679" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1680"><a href="#cb12-1680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">mean_premium_change</span><span class="st">`</span>,</span>
<span id="cb12-1681"><a href="#cb12-1681" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> <span class="fu">grouped_mean</span>(<span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>) <span class="sc">-</span> <span class="fu">grouped_mean</span>(<span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>)),</span>
<span id="cb12-1682"><a href="#cb12-1682" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_currency</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1683"><a href="#cb12-1683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> n_percent_change,</span>
<span id="cb12-1684"><a href="#cb12-1684" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> (<span class="fu">sum</span>(<span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>) <span class="sc">-</span> <span class="fu">sum</span>(<span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>)) <span class="sc">/</span> <span class="fu">sum</span>(<span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>)),</span>
<span id="cb12-1685"><a href="#cb12-1685" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1686"><a href="#cb12-1686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> mean_premium_percent_change,</span>
<span id="cb12-1687"><a href="#cb12-1687" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="sc">~</span> (<span class="fu">grouped_mean</span>(<span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>) <span class="sc">-</span> <span class="fu">grouped_mean</span>(<span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>)) <span class="sc">/</span> <span class="fu">grouped_mean</span>(<span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>)),</span>
<span id="cb12-1688"><a href="#cb12-1688" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-1689"><a href="#cb12-1689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">n_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">n_2025-05-02</span><span class="st">`</span>, n_change), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1690"><a href="#cb12-1690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">mean_premium_2024-04-30</span><span class="st">`</span>, <span class="st">`</span><span class="at">mean_premium_2025-05-02</span><span class="st">`</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1691"><a href="#cb12-1691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> mean_premium_change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1692"><a href="#cb12-1692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"percent_change"</span>), <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1693"><a href="#cb12-1693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> n_percent_change, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1694"><a href="#cb12-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1695"><a href="#cb12-1695" aria-hidden="true" tabindex="-1"></a><span class="co"># follow-up -&gt; look into negative average premium changes</span></span>
<span id="cb12-1696"><a href="#cb12-1696" aria-hidden="true" tabindex="-1"></a><span class="co"># split data</span></span>
<span id="cb12-1697"><a href="#cb12-1697" aria-hidden="true" tabindex="-1"></a>data_split_premium <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1698"><a href="#cb12-1698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="at">f =</span> .<span class="sc">$</span>date)</span>
<span id="cb12-1699"><a href="#cb12-1699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1700"><a href="#cb12-1700" aria-hidden="true" tabindex="-1"></a><span class="co"># combine data again and create status variable</span></span>
<span id="cb12-1701"><a href="#cb12-1701" aria-hidden="true" tabindex="-1"></a>data_states <span class="ot">&lt;-</span> data_split_premium[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb12-1702"><a href="#cb12-1702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_state, policy_number, term_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1703"><a href="#cb12-1703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(data_split_premium[[<span class="dv">2</span>]] <span class="sc">%&gt;%</span> <span class="fu">select</span>(policy_state, policy_number, term_premium), <span class="at">by =</span> <span class="fu">join_by</span>(policy_number), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_old"</span>, <span class="st">"_new"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1704"><a href="#cb12-1704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> term_premium_new <span class="sc">-</span> term_premium_old,</span>
<span id="cb12-1705"><a href="#cb12-1705" aria-hidden="true" tabindex="-1"></a>         <span class="at">status =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-1706"><a href="#cb12-1706" aria-hidden="true" tabindex="-1"></a>           <span class="fu">is.na</span>(term_premium_old) <span class="sc">&amp;</span> term_premium_new <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb12-1707"><a href="#cb12-1707" aria-hidden="true" tabindex="-1"></a>           term_premium_old <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(term_premium_new) <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb12-1708"><a href="#cb12-1708" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="dv">1</span></span>
<span id="cb12-1709"><a href="#cb12-1709" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb12-1710"><a href="#cb12-1710" aria-hidden="true" tabindex="-1"></a>         <span class="at">policy_state =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-1711"><a href="#cb12-1711" aria-hidden="true" tabindex="-1"></a>           status <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> policy_state_new,</span>
<span id="cb12-1712"><a href="#cb12-1712" aria-hidden="true" tabindex="-1"></a>           status <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> policy_state_old,</span>
<span id="cb12-1713"><a href="#cb12-1713" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> policy_state_old</span>
<span id="cb12-1714"><a href="#cb12-1714" aria-hidden="true" tabindex="-1"></a>         )) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1715"><a href="#cb12-1715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_state, policy_number, status, term_premium_old, term_premium_new) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1716"><a href="#cb12-1716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(policy_state, status) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1717"><a href="#cb12-1717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1718"><a href="#cb12-1718" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"premium"</span>), mean))</span>
<span id="cb12-1719"><a href="#cb12-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1720"><a href="#cb12-1720" aria-hidden="true" tabindex="-1"></a><span class="co"># create overall summary rows</span></span>
<span id="cb12-1721"><a href="#cb12-1721" aria-hidden="true" tabindex="-1"></a>data_summ1 <span class="ot">&lt;-</span> data_states <span class="sc">%&gt;%</span> </span>
<span id="cb12-1722"><a href="#cb12-1722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_state, status, n, term_premium_old) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1723"><a href="#cb12-1723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(term_premium_old)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1724"><a href="#cb12-1724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"premium"</span>), <span class="sc">~</span> <span class="fu">sum</span>(n <span class="sc">*</span> .x) <span class="sc">/</span> <span class="fu">sum</span>(n))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1725"><a href="#cb12-1725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="dv">4</span>,</span>
<span id="cb12-1726"><a href="#cb12-1726" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-1727"><a href="#cb12-1727" aria-hidden="true" tabindex="-1"></a>data_summ2 <span class="ot">&lt;-</span> data_states <span class="sc">%&gt;%</span> </span>
<span id="cb12-1728"><a href="#cb12-1728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_state, status, n, term_premium_new) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1729"><a href="#cb12-1729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(term_premium_new)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1730"><a href="#cb12-1730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"premium"</span>), <span class="sc">~</span> <span class="fu">sum</span>(n <span class="sc">*</span> .x) <span class="sc">/</span> <span class="fu">sum</span>(n))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1731"><a href="#cb12-1731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="dv">4</span>,</span>
<span id="cb12-1732"><a href="#cb12-1732" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-1733"><a href="#cb12-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1734"><a href="#cb12-1734" aria-hidden="true" tabindex="-1"></a><span class="co"># create final table</span></span>
<span id="cb12-1735"><a href="#cb12-1735" aria-hidden="true" tabindex="-1"></a>data_states <span class="sc">%&gt;%</span> </span>
<span id="cb12-1736"><a href="#cb12-1736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_summ1 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(data_summ2, <span class="at">by =</span> <span class="fu">join_by</span>(policy_state, status))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1737"><a href="#cb12-1737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(policy_state, status) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1738"><a href="#cb12-1738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-1739"><a href="#cb12-1739" aria-hidden="true" tabindex="-1"></a>    status <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"renew"</span>,</span>
<span id="cb12-1740"><a href="#cb12-1740" aria-hidden="true" tabindex="-1"></a>    status <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"non-renew"</span>,</span>
<span id="cb12-1741"><a href="#cb12-1741" aria-hidden="true" tabindex="-1"></a>    status <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"new business"</span>,</span>
<span id="cb12-1742"><a href="#cb12-1742" aria-hidden="true" tabindex="-1"></a>    status <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"overall"</span></span>
<span id="cb12-1743"><a href="#cb12-1743" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-1744"><a href="#cb12-1744" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_premium_change =</span> term_premium_new <span class="sc">-</span> term_premium_old) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1745"><a href="#cb12-1745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1746"><a href="#cb12-1746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"States - Average premium changes by status"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1747"><a href="#cb12-1747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">term_premium_old =</span> <span class="st">"2024-04-30"</span>,</span>
<span id="cb12-1748"><a href="#cb12-1748" aria-hidden="true" tabindex="-1"></a>             <span class="at">term_premium_new =</span> <span class="st">"2025-05-02"</span>,</span>
<span id="cb12-1749"><a href="#cb12-1749" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_premium_change =</span> <span class="st">"mean change in premium"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1750"><a href="#cb12-1750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> n, <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1751"><a href="#cb12-1751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"term"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1752"><a href="#cb12-1752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_currency</span>(<span class="at">columns =</span> mean_premium_change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-1753"><a href="#cb12-1753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1754"><a href="#cb12-1754" aria-hidden="true" tabindex="-1"></a><span class="co"># b) Any particular classes growing quickly in specific states?</span></span>
<span id="cb12-1755"><a href="#cb12-1755" aria-hidden="true" tabindex="-1"></a>data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1756"><a href="#cb12-1756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, policy_state, stillwater_class_description_corrected) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1757"><a href="#cb12-1757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, policy_state, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1758"><a href="#cb12-1758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1759"><a href="#cb12-1759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">change =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>,</span>
<span id="cb12-1760"><a href="#cb12-1760" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent_change =</span> <span class="fu">if_else</span>(<span class="fu">is.nan</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.infinite</span>(change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>), <span class="cn">NA</span>, change <span class="sc">/</span> <span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1761"><a href="#cb12-1761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">50</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(percent_change) <span class="sc">&gt;</span> hl_cutoff) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1762"><a href="#cb12-1762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1763"><a href="#cb12-1763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"States - Large PIF changes by class"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1764"><a href="#cb12-1764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">policy_state =</span> <span class="st">"State"</span>,</span>
<span id="cb12-1765"><a href="#cb12-1765" aria-hidden="true" tabindex="-1"></a>             <span class="at">stillwater_class_description_corrected =</span> <span class="st">"class description"</span>,</span>
<span id="cb12-1766"><a href="#cb12-1766" aria-hidden="true" tabindex="-1"></a>             <span class="at">change =</span> <span class="st">"change"</span>,</span>
<span id="cb12-1767"><a href="#cb12-1767" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_change =</span> <span class="st">"% change"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1768"><a href="#cb12-1768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1769"><a href="#cb12-1769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> change, <span class="at">decimals =</span> <span class="dv">0</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1770"><a href="#cb12-1770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> percent_change, <span class="at">decimals =</span> <span class="dv">1</span>, <span class="at">force_sign =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1771"><a href="#cb12-1771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_tbl_conditional_hl_changes</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1772"><a href="#cb12-1772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt_add_divider</span>(<span class="at">columns =</span> <span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb12-1773"><a href="#cb12-1773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1774"><a href="#cb12-1774" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- New business versus renewals ----</span></span>
<span id="cb12-1775"><a href="#cb12-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1776"><a href="#cb12-1776" aria-hidden="true" tabindex="-1"></a><span class="co"># add new variable and save dataset</span></span>
<span id="cb12-1777"><a href="#cb12-1777" aria-hidden="true" tabindex="-1"></a>data_new_business <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1778"><a href="#cb12-1778" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_business =</span> <span class="fu">if_else</span>(policy_effective_date <span class="sc">==</span> inception_date, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="at">.before =</span> <span class="dv">3</span>)</span>
<span id="cb12-1779"><a href="#cb12-1779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1780"><a href="#cb12-1780" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) New business rate</span></span>
<span id="cb12-1781"><a href="#cb12-1781" aria-hidden="true" tabindex="-1"></a>data_new_business <span class="sc">%&gt;%</span> </span>
<span id="cb12-1782"><a href="#cb12-1782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1783"><a href="#cb12-1783" aria-hidden="true" tabindex="-1"></a>            <span class="at">policy_count =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1784"><a href="#cb12-1784" aria-hidden="true" tabindex="-1"></a>            <span class="at">new_business_count =</span> <span class="fu">sum</span>(new_business),</span>
<span id="cb12-1785"><a href="#cb12-1785" aria-hidden="true" tabindex="-1"></a>            <span class="at">percent_new_business =</span> <span class="fu">mean</span>(new_business),</span>
<span id="cb12-1786"><a href="#cb12-1786" aria-hidden="true" tabindex="-1"></a>            <span class="at">percent_renewal =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">mean</span>(new_business)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1787"><a href="#cb12-1787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1788"><a href="#cb12-1788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"New business rates"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1789"><a href="#cb12-1789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">policy_count =</span> <span class="st">"Total policies"</span>,</span>
<span id="cb12-1790"><a href="#cb12-1790" aria-hidden="true" tabindex="-1"></a>             <span class="at">new_business_count =</span> <span class="st">"Count NB"</span>,</span>
<span id="cb12-1791"><a href="#cb12-1791" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_new_business =</span> <span class="st">"Percent NB"</span>,</span>
<span id="cb12-1792"><a href="#cb12-1792" aria-hidden="true" tabindex="-1"></a>             <span class="at">percent_renewal =</span> <span class="st">"Percent Ren"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1793"><a href="#cb12-1793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"count"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1794"><a href="#cb12-1794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1795"><a href="#cb12-1795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1796"><a href="#cb12-1796" aria-hidden="true" tabindex="-1"></a><span class="co"># a) Retention rate</span></span>
<span id="cb12-1797"><a href="#cb12-1797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1798"><a href="#cb12-1798" aria-hidden="true" tabindex="-1"></a><span class="co"># read in old old inforce data</span></span>
<span id="cb12-1799"><a href="#cb12-1799" aria-hidden="true" tabindex="-1"></a>data_inforce_old_old <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"InForce_20230430.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1800"><a href="#cb12-1800" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1801"><a href="#cb12-1801" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="st">"2023-04-30"</span>), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-1802"><a href="#cb12-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1803"><a href="#cb12-1803" aria-hidden="true" tabindex="-1"></a><span class="co"># convert datasets to list</span></span>
<span id="cb12-1804"><a href="#cb12-1804" aria-hidden="true" tabindex="-1"></a>data_split_retention_1 <span class="ot">&lt;-</span> data_inforce_old_old <span class="sc">%&gt;%</span> </span>
<span id="cb12-1805"><a href="#cb12-1805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_inforce_old) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1806"><a href="#cb12-1806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>date)</span>
<span id="cb12-1807"><a href="#cb12-1807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1808"><a href="#cb12-1808" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate retention rate</span></span>
<span id="cb12-1809"><a href="#cb12-1809" aria-hidden="true" tabindex="-1"></a>data_retention <span class="ot">&lt;-</span> data_split_retention_1<span class="sc">$</span><span class="st">`</span><span class="at">2023-04-30</span><span class="st">`</span> <span class="sc">%&gt;%</span> </span>
<span id="cb12-1810"><a href="#cb12-1810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_split_retention_1<span class="sc">$</span><span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span> <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, policy_number), <span class="at">by =</span> <span class="fu">join_by</span>(policy_number), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_old_old"</span>, <span class="st">"_old"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1811"><a href="#cb12-1811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">retained =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(date_old), <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1812"><a href="#cb12-1812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">starting_policies =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1813"><a href="#cb12-1813" aria-hidden="true" tabindex="-1"></a>            <span class="at">retained_count =</span> <span class="fu">sum</span>(retained),</span>
<span id="cb12-1814"><a href="#cb12-1814" aria-hidden="true" tabindex="-1"></a>            <span class="at">retained_percent =</span> <span class="fu">mean</span>(retained)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1815"><a href="#cb12-1815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">timeframe =</span> <span class="st">"2023 to 2024"</span>,</span>
<span id="cb12-1816"><a href="#cb12-1816" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-1817"><a href="#cb12-1817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1818"><a href="#cb12-1818" aria-hidden="true" tabindex="-1"></a><span class="co"># convert datasets to list</span></span>
<span id="cb12-1819"><a href="#cb12-1819" aria-hidden="true" tabindex="-1"></a>data_split_retention2 <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1820"><a href="#cb12-1820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>date)</span>
<span id="cb12-1821"><a href="#cb12-1821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1822"><a href="#cb12-1822" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate retention rate</span></span>
<span id="cb12-1823"><a href="#cb12-1823" aria-hidden="true" tabindex="-1"></a>data_split_retention2<span class="sc">$</span><span class="st">`</span><span class="at">2024-04-30</span><span class="st">`</span> <span class="sc">%&gt;%</span> </span>
<span id="cb12-1824"><a href="#cb12-1824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_split_retention2<span class="sc">$</span><span class="st">`</span><span class="at">2025-05-02</span><span class="st">`</span> <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, policy_number), <span class="at">by =</span> <span class="fu">join_by</span>(policy_number), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_old"</span>, <span class="st">"_new"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1825"><a href="#cb12-1825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">retained =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(date_new), <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1826"><a href="#cb12-1826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">starting_policies =</span> <span class="fu">n</span>(),</span>
<span id="cb12-1827"><a href="#cb12-1827" aria-hidden="true" tabindex="-1"></a>            <span class="at">retained_count =</span> <span class="fu">sum</span>(retained),</span>
<span id="cb12-1828"><a href="#cb12-1828" aria-hidden="true" tabindex="-1"></a>            <span class="at">retained_percent =</span> <span class="fu">mean</span>(retained)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1829"><a href="#cb12-1829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">timeframe =</span> <span class="st">"2024 to 2025"</span>,</span>
<span id="cb12-1830"><a href="#cb12-1830" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1831"><a href="#cb12-1831" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">bind_rows</span>(data_retention, .)} <span class="sc">%&gt;%</span> </span>
<span id="cb12-1832"><a href="#cb12-1832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1833"><a href="#cb12-1833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Retention rates"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1834"><a href="#cb12-1834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">timeframe =</span> <span class="st">"Timeframe"</span>,</span>
<span id="cb12-1835"><a href="#cb12-1835" aria-hidden="true" tabindex="-1"></a>             <span class="at">starting_policies =</span> <span class="st">"Starting policies"</span>,</span>
<span id="cb12-1836"><a href="#cb12-1836" aria-hidden="true" tabindex="-1"></a>             <span class="at">retained_count =</span> <span class="st">"Count retained"</span>,</span>
<span id="cb12-1837"><a href="#cb12-1837" aria-hidden="true" tabindex="-1"></a>             <span class="at">retained_percent =</span> <span class="st">"Percent retained"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1838"><a href="#cb12-1838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(starting_policies, retained_count), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1839"><a href="#cb12-1839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> retained_percent, <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1840"><a href="#cb12-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1841"><a href="#cb12-1841" aria-hidden="true" tabindex="-1"></a><span class="co"># a) Can we determine how the distribution of our new business (last two months?) has changed from the overall in-force book? Iâ€™m looking to see how our changes in rules and processes may have changed what is coming through the door as new business.</span></span>
<span id="cb12-1842"><a href="#cb12-1842" aria-hidden="true" tabindex="-1"></a>data_recent <span class="ot">&lt;-</span> data_new_business <span class="sc">%&gt;%</span> </span>
<span id="cb12-1843"><a href="#cb12-1843" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">==</span> <span class="fu">max</span>(date)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1844"><a href="#cb12-1844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">recent_new_business =</span> <span class="fu">if_else</span>(new_business <span class="sc">&amp;</span> <span class="fu">ymd</span>(policy_effective_date) <span class="sc">&gt;=</span> <span class="fu">ymd</span>(<span class="st">"2025-03-01"</span>), <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb12-1845"><a href="#cb12-1845" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">4</span>)</span>
<span id="cb12-1846"><a href="#cb12-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1847"><a href="#cb12-1847" aria-hidden="true" tabindex="-1"></a><span class="co"># what specifically to look at??? Is there a list of recent actions taken?</span></span>
<span id="cb12-1848"><a href="#cb12-1848" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; lets start with hierarchy 1 / classes</span></span>
<span id="cb12-1849"><a href="#cb12-1849" aria-hidden="true" tabindex="-1"></a>data_recent <span class="sc">%&gt;%</span> </span>
<span id="cb12-1850"><a href="#cb12-1850" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(recent_new_business, hierarchy_1) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1851"><a href="#cb12-1851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> recent_new_business,</span>
<span id="cb12-1852"><a href="#cb12-1852" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1853"><a href="#cb12-1853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> recent_new_business, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1854"><a href="#cb12-1854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"FALSE"</span>), <span class="fu">contains</span>(<span class="st">"TRUE"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1855"><a href="#cb12-1855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1856"><a href="#cb12-1856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Recent new business (written &lt; 2 months ago) - Classes"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1857"><a href="#cb12-1857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"FALSE"</span>),</span>
<span id="cb12-1858"><a href="#cb12-1858" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"No"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1859"><a href="#cb12-1859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"TRUE"</span>),</span>
<span id="cb12-1860"><a href="#cb12-1860" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"Yes"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1861"><a href="#cb12-1861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">hierarchy_1 =</span> <span class="st">"Hierarchy 1"</span>,</span>
<span id="cb12-1862"><a href="#cb12-1862" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1863"><a href="#cb12-1863" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1864"><a href="#cb12-1864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1865"><a href="#cb12-1865" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1866"><a href="#cb12-1866" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1867"><a href="#cb12-1867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1868"><a href="#cb12-1868" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1869"><a href="#cb12-1869" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1870"><a href="#cb12-1870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1871"><a href="#cb12-1871" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1872"><a href="#cb12-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1873"><a href="#cb12-1873" aria-hidden="true" tabindex="-1"></a><span class="co"># look into types of restaurants</span></span>
<span id="cb12-1874"><a href="#cb12-1874" aria-hidden="true" tabindex="-1"></a>data_recent_restaurants <span class="ot">&lt;-</span> data_recent <span class="sc">%&gt;%</span> </span>
<span id="cb12-1875"><a href="#cb12-1875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hierarchy_1 <span class="sc">==</span> <span class="st">"Restaurants, Eating and Drinking Places"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1876"><a href="#cb12-1876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stillwater_class_description_corrected_grouped =</span> <span class="fu">str_extract</span>(stillwater_class_description_corrected, <span class="st">".*(?=</span><span class="sc">\\</span><span class="st"> -)"</span>))</span>
<span id="cb12-1877"><a href="#cb12-1877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1878"><a href="#cb12-1878" aria-hidden="true" tabindex="-1"></a>data_recent_restaurants <span class="sc">%&gt;%</span> </span>
<span id="cb12-1879"><a href="#cb12-1879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(recent_new_business, stillwater_class_description_corrected_grouped) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1880"><a href="#cb12-1880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> recent_new_business,</span>
<span id="cb12-1881"><a href="#cb12-1881" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1882"><a href="#cb12-1882" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(recent_new_business, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1883"><a href="#cb12-1883" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> recent_new_business, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1884"><a href="#cb12-1884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"FALSE"</span>), <span class="fu">contains</span>(<span class="st">"TRUE"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1885"><a href="#cb12-1885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1886"><a href="#cb12-1886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Recent new business (written &lt; 2 months ago) - Restaurant types"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1887"><a href="#cb12-1887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"FALSE"</span>),</span>
<span id="cb12-1888"><a href="#cb12-1888" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"No"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1889"><a href="#cb12-1889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"TRUE"</span>),</span>
<span id="cb12-1890"><a href="#cb12-1890" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"Yes"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1891"><a href="#cb12-1891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">stillwater_class_description_corrected_grouped =</span> <span class="st">"Class"</span>,</span>
<span id="cb12-1892"><a href="#cb12-1892" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1893"><a href="#cb12-1893" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1894"><a href="#cb12-1894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1895"><a href="#cb12-1895" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1896"><a href="#cb12-1896" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1897"><a href="#cb12-1897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1898"><a href="#cb12-1898" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1899"><a href="#cb12-1899" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1900"><a href="#cb12-1900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1901"><a href="#cb12-1901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1902"><a href="#cb12-1902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1903"><a href="#cb12-1903" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Tennessee ----</span></span>
<span id="cb12-1904"><a href="#cb12-1904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1905"><a href="#cb12-1905" aria-hidden="true" tabindex="-1"></a><span class="co"># look into reduction of PIF in TN</span></span>
<span id="cb12-1906"><a href="#cb12-1906" aria-hidden="true" tabindex="-1"></a>data_tn <span class="ot">&lt;-</span> data_inforce_all <span class="sc">%&gt;%</span> </span>
<span id="cb12-1907"><a href="#cb12-1907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(policy_state <span class="sc">==</span> <span class="st">"TN"</span>)</span>
<span id="cb12-1908"><a href="#cb12-1908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1909"><a href="#cb12-1909" aria-hidden="true" tabindex="-1"></a><span class="co"># type of policy</span></span>
<span id="cb12-1910"><a href="#cb12-1910" aria-hidden="true" tabindex="-1"></a>data_tn <span class="sc">%&gt;%</span> </span>
<span id="cb12-1911"><a href="#cb12-1911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, bdg_cov, bpp_cov) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1912"><a href="#cb12-1912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1913"><a href="#cb12-1913" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1914"><a href="#cb12-1914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1915"><a href="#cb12-1915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1916"><a href="#cb12-1916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1917"><a href="#cb12-1917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"TN - Type of policy"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1918"><a href="#cb12-1918" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1919"><a href="#cb12-1919" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1920"><a href="#cb12-1920" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1921"><a href="#cb12-1921" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1922"><a href="#cb12-1922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">bdg_cov =</span> <span class="st">"BDG"</span>,</span>
<span id="cb12-1923"><a href="#cb12-1923" aria-hidden="true" tabindex="-1"></a>             <span class="at">bpp_cov =</span> <span class="st">"BPP"</span>,</span>
<span id="cb12-1924"><a href="#cb12-1924" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1925"><a href="#cb12-1925" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1926"><a href="#cb12-1926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1927"><a href="#cb12-1927" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1928"><a href="#cb12-1928" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1929"><a href="#cb12-1929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1930"><a href="#cb12-1930" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1931"><a href="#cb12-1931" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1932"><a href="#cb12-1932" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1933"><a href="#cb12-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1934"><a href="#cb12-1934" aria-hidden="true" tabindex="-1"></a><span class="co"># location</span></span>
<span id="cb12-1935"><a href="#cb12-1935" aria-hidden="true" tabindex="-1"></a>data_tn <span class="sc">%&gt;%</span> </span>
<span id="cb12-1936"><a href="#cb12-1936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">location_city =</span> <span class="fu">if_else</span>(date <span class="sc">==</span> <span class="fu">ymd</span>(<span class="st">"2024-04-30"</span>), mailing_city, location_city)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1937"><a href="#cb12-1937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, location_city) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1938"><a href="#cb12-1938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1939"><a href="#cb12-1939" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> date,</span>
<span id="cb12-1940"><a href="#cb12-1940" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1941"><a href="#cb12-1941" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> <span class="fu">c</span>(n, percent), <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1942"><a href="#cb12-1942" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1943"><a href="#cb12-1943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1944"><a href="#cb12-1944" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"TN - Locations"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1945"><a href="#cb12-1945" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2024"</span>),</span>
<span id="cb12-1946"><a href="#cb12-1946" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2024-04-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1947"><a href="#cb12-1947" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"2025"</span>),</span>
<span id="cb12-1948"><a href="#cb12-1948" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"2025-05-02"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1949"><a href="#cb12-1949" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">location_city =</span> <span class="st">"Location city"</span>,</span>
<span id="cb12-1950"><a href="#cb12-1950" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>,</span>
<span id="cb12-1951"><a href="#cb12-1951" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"percent"</span>) <span class="sc">~</span> <span class="st">"percent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1952"><a href="#cb12-1952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>),</span>
<span id="cb12-1953"><a href="#cb12-1953" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1954"><a href="#cb12-1954" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1955"><a href="#cb12-1955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>),</span>
<span id="cb12-1956"><a href="#cb12-1956" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1957"><a href="#cb12-1957" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_percent</span>(., <span class="at">decimals =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1958"><a href="#cb12-1958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1959"><a href="#cb12-1959" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"percent"</span>), <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-1960"><a href="#cb12-1960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1961"><a href="#cb12-1961" aria-hidden="true" tabindex="-1"></a><span class="co"># business class</span></span>
<span id="cb12-1962"><a href="#cb12-1962" aria-hidden="true" tabindex="-1"></a>data_tn <span class="sc">%&gt;%</span> </span>
<span id="cb12-1963"><a href="#cb12-1963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, stillwater_class_description_corrected) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1964"><a href="#cb12-1964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1965"><a href="#cb12-1965" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1966"><a href="#cb12-1966" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1967"><a href="#cb12-1967" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1968"><a href="#cb12-1968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"TN - Business class"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1969"><a href="#cb12-1969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">stillwater_class_description_corrected =</span> <span class="st">"class"</span>,</span>
<span id="cb12-1970"><a href="#cb12-1970" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1971"><a href="#cb12-1971" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>),</span>
<span id="cb12-1972"><a href="#cb12-1972" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1973"><a href="#cb12-1973" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1974"><a href="#cb12-1974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb12-1975"><a href="#cb12-1975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1976"><a href="#cb12-1976" aria-hidden="true" tabindex="-1"></a><span class="co"># agents</span></span>
<span id="cb12-1977"><a href="#cb12-1977" aria-hidden="true" tabindex="-1"></a>data_tn <span class="sc">%&gt;%</span> </span>
<span id="cb12-1978"><a href="#cb12-1978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date, agency, sub_agent, agent) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1979"><a href="#cb12-1979" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1980"><a href="#cb12-1980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> date, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1981"><a href="#cb12-1981" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">contains</span>(<span class="st">"2024"</span>), <span class="fu">contains</span>(<span class="st">"2025"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1982"><a href="#cb12-1982" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-1983"><a href="#cb12-1983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"TN - Agents"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1984"><a href="#cb12-1984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">sub_agent =</span> <span class="st">"sub agent"</span>,</span>
<span id="cb12-1985"><a href="#cb12-1985" aria-hidden="true" tabindex="-1"></a>             <span class="fu">starts_with</span>(<span class="st">"n"</span>) <span class="sc">~</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1986"><a href="#cb12-1986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grand_summary_rows</span>(<span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"-"</span>),</span>
<span id="cb12-1987"><a href="#cb12-1987" aria-hidden="true" tabindex="-1"></a>               <span class="at">fns =</span> <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Total"</span>, <span class="at">fn =</span> <span class="st">"sum"</span>),</span>
<span id="cb12-1988"><a href="#cb12-1988" aria-hidden="true" tabindex="-1"></a>               <span class="at">fmt =</span> <span class="sc">~</span> <span class="fu">fmt_number</span>(., <span class="at">decimals =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-1989"><a href="#cb12-1989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">starts_with</span>(<span class="st">"n"</span>), <span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb12-1990"><a href="#cb12-1990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1991"><a href="#cb12-1991" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-1992"><a href="#cb12-1992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1993"><a href="#cb12-1993" aria-hidden="true" tabindex="-1"></a><span class="fu">### Large risks analysis</span></span>
<span id="cb12-1994"><a href="#cb12-1994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1995"><a href="#cb12-1995" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/large-risks-analysis.png)</span></span>
<span id="cb12-1996"><a href="#cb12-1996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-1999"><a href="#cb12-1999" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-2000"><a href="#cb12-2000" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb12-2001"><a href="#cb12-2001" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-2002"><a href="#cb12-2002" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-2003"><a href="#cb12-2003" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb12-2004"><a href="#cb12-2004" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb12-2005"><a href="#cb12-2005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2006"><a href="#cb12-2006" aria-hidden="true" tabindex="-1"></a><span class="co"># read in inforce file from excel</span></span>
<span id="cb12-2007"><a href="#cb12-2007" aria-hidden="true" tabindex="-1"></a>data_inforce_raw <span class="ot">&lt;-</span> readxlsb<span class="sc">::</span><span class="fu">read_xlsb</span>(<span class="st">"InForce_20241001.xlsb"</span>, <span class="at">sheet =</span> <span class="dv">1</span>)</span>
<span id="cb12-2008"><a href="#cb12-2008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2009"><a href="#cb12-2009" aria-hidden="true" tabindex="-1"></a><span class="co"># rename variables</span></span>
<span id="cb12-2010"><a href="#cb12-2010" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; select only needed columns</span></span>
<span id="cb12-2011"><a href="#cb12-2011" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine address information</span></span>
<span id="cb12-2012"><a href="#cb12-2012" aria-hidden="true" tabindex="-1"></a>data_inforce <span class="ot">&lt;-</span> data_inforce_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2013"><a href="#cb12-2013" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2014"><a href="#cb12-2014" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(policy_number, policy_effective_date, policy_expiration_date, policy_status, named_insured, location_address, location_city, location_state, location_zip_code, policy_state, longitude, latitude, stillwater_class_description, hierarchy_1, bdg_loi, bpp_loi) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2015"><a href="#cb12-2015" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">location_address =</span> <span class="fu">paste0</span>(location_address, <span class="st">", "</span>, location_city, <span class="st">" "</span>, location_zip_code, <span class="st">" "</span>, location_state), <span class="at">.before =</span> policy_state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2016"><a href="#cb12-2016" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">c</span>(location_city, location_state, location_zip_code)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2017"><a href="#cb12-2017" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">combined_loi =</span> bdg_loi <span class="sc">+</span> bpp_loi)</span>
<span id="cb12-2018"><a href="#cb12-2018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2019"><a href="#cb12-2019" aria-hidden="true" tabindex="-1"></a><span class="co"># save as .RData file</span></span>
<span id="cb12-2020"><a href="#cb12-2020" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_inforce, <span class="at">file =</span> <span class="st">"data-inforce.RData"</span>)</span>
<span id="cb12-2021"><a href="#cb12-2021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2022"><a href="#cb12-2022" aria-hidden="true" tabindex="-1"></a><span class="co"># read in cleaned inforce file from RData file</span></span>
<span id="cb12-2023"><a href="#cb12-2023" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data-inforce.RData"</span>)</span>
<span id="cb12-2024"><a href="#cb12-2024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2025"><a href="#cb12-2025" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to determine large risks</span></span>
<span id="cb12-2026"><a href="#cb12-2026" aria-hidden="true" tabindex="-1"></a><span class="co"># criteria: within radius and individually less than limit</span></span>
<span id="cb12-2027"><a href="#cb12-2027" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; radius of 0.282 gives a quarter-mile in area; limit of $1.5M needs to be looked at</span></span>
<span id="cb12-2028"><a href="#cb12-2028" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; if above limit, it has already been looked at closely; so focusing on aggregate risks</span></span>
<span id="cb12-2029"><a href="#cb12-2029" aria-hidden="true" tabindex="-1"></a>find_large_risks <span class="ot">&lt;-</span> <span class="cf">function</span>(i, df, <span class="at">radius =</span> <span class="fl">0.282</span>, <span class="at">limit =</span> <span class="dv">1500000</span>) {</span>
<span id="cb12-2030"><a href="#cb12-2030" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2031"><a href="#cb12-2031" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tracking purposes</span></span>
<span id="cb12-2032"><a href="#cb12-2032" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">100</span> <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb12-2033"><a href="#cb12-2033" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb12-2034"><a href="#cb12-2034" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2035"><a href="#cb12-2035" aria-hidden="true" tabindex="-1"></a>  <span class="co"># single out row for comparison</span></span>
<span id="cb12-2036"><a href="#cb12-2036" aria-hidden="true" tabindex="-1"></a>  data_i <span class="ot">=</span> df[i, ] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">distance_from_i =</span> <span class="dv">0</span>)</span>
<span id="cb12-2037"><a href="#cb12-2037" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2038"><a href="#cb12-2038" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create dataframe of all other rows</span></span>
<span id="cb12-2039"><a href="#cb12-2039" aria-hidden="true" tabindex="-1"></a>  data_other <span class="ot">=</span> df[<span class="sc">-</span>i,]</span>
<span id="cb12-2040"><a href="#cb12-2040" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2041"><a href="#cb12-2041" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate distance to all other policies</span></span>
<span id="cb12-2042"><a href="#cb12-2042" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; filter to all within a mile (after converting to miles)</span></span>
<span id="cb12-2043"><a href="#cb12-2043" aria-hidden="true" tabindex="-1"></a>  data_close <span class="ot">=</span> data_other <span class="sc">%&gt;%</span> </span>
<span id="cb12-2044"><a href="#cb12-2044" aria-hidden="true" tabindex="-1"></a>    rowwise <span class="sc">%&gt;%</span> </span>
<span id="cb12-2045"><a href="#cb12-2045" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">distance_from_i =</span> geosphere<span class="sc">::</span><span class="fu">distm</span>(<span class="at">x =</span> <span class="fu">c</span>(data_i<span class="sc">$</span>longitude, data_i<span class="sc">$</span>latitude),</span>
<span id="cb12-2046"><a href="#cb12-2046" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">y =</span> <span class="fu">c</span>(longitude, latitude), <span class="at">fun =</span> geosphere<span class="sc">::</span>distHaversine) <span class="sc">%&gt;%</span> as.numeric <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="fl">0.00062137</span>)</span>
<span id="cb12-2047"><a href="#cb12-2047" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2048"><a href="#cb12-2048" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2049"><a href="#cb12-2049" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(data_i, .) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2050"><a href="#cb12-2050" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(distance_from_i <span class="sc">&lt;=</span> radius, combined_loi <span class="sc">&lt;=</span> limit)</span>
<span id="cb12-2051"><a href="#cb12-2051" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2052"><a href="#cb12-2052" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate combined LOI for close policies and determine if over limit</span></span>
<span id="cb12-2053"><a href="#cb12-2053" aria-hidden="true" tabindex="-1"></a>  combined_risk <span class="ot">=</span> data_close <span class="sc">%&gt;%</span> </span>
<span id="cb12-2054"><a href="#cb12-2054" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="fu">sum</span>(combined_loi)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2055"><a href="#cb12-2055" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb12-2056"><a href="#cb12-2056" aria-hidden="true" tabindex="-1"></a>  large_risk_flag <span class="ot">=</span> <span class="fu">if_else</span>(combined_risk <span class="sc">&gt;</span> limit, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb12-2057"><a href="#cb12-2057" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2058"><a href="#cb12-2058" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return results</span></span>
<span id="cb12-2059"><a href="#cb12-2059" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(large_risk_flag <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb12-2060"><a href="#cb12-2060" aria-hidden="true" tabindex="-1"></a>    data_close<span class="sc">$</span>policy_number <span class="sc">%&gt;%</span> </span>
<span id="cb12-2061"><a href="#cb12-2061" aria-hidden="true" tabindex="-1"></a>      return</span>
<span id="cb12-2062"><a href="#cb12-2062" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-2063"><a href="#cb12-2063" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-2064"><a href="#cb12-2064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2065"><a href="#cb12-2065" aria-hidden="true" tabindex="-1"></a><span class="co"># setup plan</span></span>
<span id="cb12-2066"><a href="#cb12-2066" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="fu">availableCores</span>()<span class="sc">-</span><span class="dv">4</span>)</span>
<span id="cb12-2067"><a href="#cb12-2067" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb12-2068"><a href="#cb12-2068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2069"><a href="#cb12-2069" aria-hidden="true" tabindex="-1"></a><span class="co"># find all large risks (within a 1/4 mile of each of the reference policy (first one in list))</span></span>
<span id="cb12-2070"><a href="#cb12-2070" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; exclude policies with no lat/long</span></span>
<span id="cb12-2071"><a href="#cb12-2071" aria-hidden="true" tabindex="-1"></a>data_groups <span class="ot">&lt;-</span> data_inforce <span class="sc">%&gt;%</span> </span>
<span id="cb12-2072"><a href="#cb12-2072" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(longitude <span class="sc">!=</span> <span class="dv">0</span>, latitude <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2073"><a href="#cb12-2073" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">future_map</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.), <span class="cf">function</span>(i) <span class="fu">find_large_risks</span>(i, <span class="at">df =</span> .))}</span>
<span id="cb12-2074"><a href="#cb12-2074" aria-hidden="true" tabindex="-1"></a>data_groups[<span class="fu">sapply</span>(data_groups, is.null)] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-2075"><a href="#cb12-2075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2076"><a href="#cb12-2076" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb12-2077"><a href="#cb12-2077" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(data_groups, <span class="at">file =</span> <span class="st">"data-groups.RData"</span>)</span>
<span id="cb12-2078"><a href="#cb12-2078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2079"><a href="#cb12-2079" aria-hidden="true" tabindex="-1"></a><span class="co"># load results</span></span>
<span id="cb12-2080"><a href="#cb12-2080" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data-groups.RData"</span>)</span>
<span id="cb12-2081"><a href="#cb12-2081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2082"><a href="#cb12-2082" aria-hidden="true" tabindex="-1"></a><span class="co"># pull corresponding info from inforce data</span></span>
<span id="cb12-2083"><a href="#cb12-2083" aria-hidden="true" tabindex="-1"></a>data_large_risks <span class="ot">&lt;-</span> <span class="fu">map2</span>(data_groups, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(data_groups),</span>
<span id="cb12-2084"><a href="#cb12-2084" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">function</span>(policy_nums, i) {</span>
<span id="cb12-2085"><a href="#cb12-2085" aria-hidden="true" tabindex="-1"></a>                           data_inforce <span class="sc">%&gt;%</span> </span>
<span id="cb12-2086"><a href="#cb12-2086" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">filter</span>(policy_number <span class="sc">%in%</span> policy_nums) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2087"><a href="#cb12-2087" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">mutate</span>(<span class="at">group =</span> i,</span>
<span id="cb12-2088"><a href="#cb12-2088" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">group_loi =</span> <span class="fu">sum</span>(combined_loi),</span>
<span id="cb12-2089"><a href="#cb12-2089" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-2090"><a href="#cb12-2090" aria-hidden="true" tabindex="-1"></a>                         }) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2091"><a href="#cb12-2091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(bind_rows) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2092"><a href="#cb12-2092" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>group_loi) <span class="sc">%&gt;%</span> <span class="co"># making assumption that all groups with same group_loi are actually the same group, just different reference policy</span></span>
<span id="cb12-2093"><a href="#cb12-2093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="cf">function</span>(df) {</span>
<span id="cb12-2094"><a href="#cb12-2094" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2095"><a href="#cb12-2095" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove repeat records</span></span>
<span id="cb12-2096"><a href="#cb12-2096" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span> </span>
<span id="cb12-2097"><a href="#cb12-2097" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>group) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2098"><a href="#cb12-2098" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(<span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-2099"><a href="#cb12-2099" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2100"><a href="#cb12-2100" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2101"><a href="#cb12-2101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(bind_rows) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2102"><a href="#cb12-2102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> group_loi, <span class="at">group =</span> <span class="fu">cur_group_id</span>(), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-2103"><a href="#cb12-2103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2104"><a href="#cb12-2104" aria-hidden="true" tabindex="-1"></a><span class="co"># output results</span></span>
<span id="cb12-2105"><a href="#cb12-2105" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_large_risks, <span class="st">"large-risks-analysis.xlsx"</span>)</span>
<span id="cb12-2106"><a href="#cb12-2106" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span>
<span id="cb12-2107"><a href="#cb12-2107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2108"><a href="#cb12-2108" aria-hidden="true" tabindex="-1"></a><span class="co"># load states shape file</span></span>
<span id="cb12-2109"><a href="#cb12-2109" aria-hidden="true" tabindex="-1"></a>data_states <span class="ot">&lt;-</span> tigris<span class="sc">::</span><span class="fu">states</span>(<span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2110"><a href="#cb12-2110" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="st">'+proj=longlat +datum=WGS84'</span>)</span>
<span id="cb12-2111"><a href="#cb12-2111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2112"><a href="#cb12-2112" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to set the color of the icon</span></span>
<span id="cb12-2113"><a href="#cb12-2113" aria-hidden="true" tabindex="-1"></a>get_color_icon <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb12-2114"><a href="#cb12-2114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(df<span class="sc">$</span>reinsurance, <span class="cf">function</span>(reinsurance) {</span>
<span id="cb12-2115"><a href="#cb12-2115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(reinsurance <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb12-2116"><a href="#cb12-2116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"green"</span></span>
<span id="cb12-2117"><a href="#cb12-2117" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-2118"><a href="#cb12-2118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"black"</span></span>
<span id="cb12-2119"><a href="#cb12-2119" aria-hidden="true" tabindex="-1"></a>  } })</span>
<span id="cb12-2120"><a href="#cb12-2120" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-2121"><a href="#cb12-2121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2122"><a href="#cb12-2122" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to set the color of the marker</span></span>
<span id="cb12-2123"><a href="#cb12-2123" aria-hidden="true" tabindex="-1"></a>get_color_marker <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb12-2124"><a href="#cb12-2124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(df<span class="sc">$</span>group_loi, <span class="cf">function</span>(group_loi) {</span>
<span id="cb12-2125"><a href="#cb12-2125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(group_loi <span class="sc">/</span> <span class="dv">1000000</span> <span class="sc">&lt;=</span> <span class="dv">2</span>) {</span>
<span id="cb12-2126"><a href="#cb12-2126" aria-hidden="true" tabindex="-1"></a>    <span class="st">"blue"</span></span>
<span id="cb12-2127"><a href="#cb12-2127" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(group_loi <span class="sc">/</span> <span class="dv">1000000</span> <span class="sc">&lt;=</span> <span class="dv">4</span>)  {</span>
<span id="cb12-2128"><a href="#cb12-2128" aria-hidden="true" tabindex="-1"></a>    <span class="st">"orange"</span></span>
<span id="cb12-2129"><a href="#cb12-2129" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-2130"><a href="#cb12-2130" aria-hidden="true" tabindex="-1"></a>    <span class="st">"red"</span></span>
<span id="cb12-2131"><a href="#cb12-2131" aria-hidden="true" tabindex="-1"></a>  } })</span>
<span id="cb12-2132"><a href="#cb12-2132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-2133"><a href="#cb12-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2134"><a href="#cb12-2134" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate reinsurance flag</span></span>
<span id="cb12-2135"><a href="#cb12-2135" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; determine if named_insured is the same within groups</span></span>
<span id="cb12-2136"><a href="#cb12-2136" aria-hidden="true" tabindex="-1"></a>data_large_risks <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-2137"><a href="#cb12-2137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>group) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2138"><a href="#cb12-2138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="cf">function</span>(df) {</span>
<span id="cb12-2139"><a href="#cb12-2139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2140"><a href="#cb12-2140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check count of named insured and join calculation back onto original df</span></span>
<span id="cb12-2141"><a href="#cb12-2141" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span> </span>
<span id="cb12-2142"><a href="#cb12-2142" aria-hidden="true" tabindex="-1"></a>      <span class="fu">count</span>(named_insured) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2143"><a href="#cb12-2143" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">reinsurance =</span> <span class="fu">if_else</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2144"><a href="#cb12-2144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">right_join</span>(df, <span class="at">by =</span> <span class="fu">join_by</span>(named_insured)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2145"><a href="#cb12-2145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="dv">4</span><span class="sc">:</span><span class="dv">9</span>, <span class="dv">1</span>, <span class="dv">10</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">3</span>) <span class="co"># manually reorder </span></span>
<span id="cb12-2146"><a href="#cb12-2146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2147"><a href="#cb12-2147" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2148"><a href="#cb12-2148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(bind_rows)</span>
<span id="cb12-2149"><a href="#cb12-2149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2150"><a href="#cb12-2150" aria-hidden="true" tabindex="-1"></a><span class="co"># create icons</span></span>
<span id="cb12-2151"><a href="#cb12-2151" aria-hidden="true" tabindex="-1"></a>icons <span class="ot">&lt;-</span> <span class="fu">awesomeIcons</span>(</span>
<span id="cb12-2152"><a href="#cb12-2152" aria-hidden="true" tabindex="-1"></a>  <span class="at">icon =</span> <span class="st">"ios-close"</span>,</span>
<span id="cb12-2153"><a href="#cb12-2153" aria-hidden="true" tabindex="-1"></a>  <span class="at">iconColor =</span> <span class="fu">get_color_icon</span>(data_large_risks),</span>
<span id="cb12-2154"><a href="#cb12-2154" aria-hidden="true" tabindex="-1"></a>  <span class="at">library =</span> <span class="st">"ion"</span>,</span>
<span id="cb12-2155"><a href="#cb12-2155" aria-hidden="true" tabindex="-1"></a>  <span class="at">markerColor =</span> <span class="fu">get_color_marker</span>(data_large_risks)</span>
<span id="cb12-2156"><a href="#cb12-2156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-2157"><a href="#cb12-2157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2158"><a href="#cb12-2158" aria-hidden="true" tabindex="-1"></a><span class="co"># create map</span></span>
<span id="cb12-2159"><a href="#cb12-2159" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">leaflet</span>(data_states) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2160"><a href="#cb12-2160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setView</span>(<span class="sc">-</span><span class="dv">96</span>, <span class="fl">37.8</span>, <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2161"><a href="#cb12-2161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2162"><a href="#cb12-2162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addAwesomeMarkers</span>(<span class="at">data =</span> data_large_risks,</span>
<span id="cb12-2163"><a href="#cb12-2163" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lng =</span> <span class="sc">~</span>longitude,</span>
<span id="cb12-2164"><a href="#cb12-2164" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lat =</span> <span class="sc">~</span>latitude,</span>
<span id="cb12-2165"><a href="#cb12-2165" aria-hidden="true" tabindex="-1"></a>                    <span class="at">icon =</span> icons,</span>
<span id="cb12-2166"><a href="#cb12-2166" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label=</span> <span class="sc">~</span><span class="fu">paste0</span>(<span class="st">"$"</span>, <span class="fu">round</span>(combined_loi <span class="sc">/</span> <span class="dv">1000</span>, <span class="dv">0</span>), <span class="st">"K; "</span>, named_insured, <span class="st">"; "</span>, policy_number))</span>
<span id="cb12-2167"><a href="#cb12-2167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2168"><a href="#cb12-2168" aria-hidden="true" tabindex="-1"></a><span class="co"># (actually a quarto chunk with the following options)</span></span>
<span id="cb12-2169"><a href="#cb12-2169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2170"><a href="#cb12-2170" aria-hidden="true" tabindex="-1"></a><span class="do">##| column: screen-inset-right</span></span>
<span id="cb12-2171"><a href="#cb12-2171" aria-hidden="true" tabindex="-1"></a><span class="do">##| out-width: 100%</span></span>
<span id="cb12-2172"><a href="#cb12-2172" aria-hidden="true" tabindex="-1"></a><span class="do">##| out-height: 1000px</span></span>
<span id="cb12-2173"><a href="#cb12-2173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2174"><a href="#cb12-2174" aria-hidden="true" tabindex="-1"></a><span class="co"># view plot</span></span>
<span id="cb12-2175"><a href="#cb12-2175" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; in separate chunk so when rendered the progress bars don't show up</span></span>
<span id="cb12-2176"><a href="#cb12-2176" aria-hidden="true" tabindex="-1"></a>m</span>
<span id="cb12-2177"><a href="#cb12-2177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2178"><a href="#cb12-2178" aria-hidden="true" tabindex="-1"></a><span class="co"># **How to read plot**:</span></span>
<span id="cb12-2179"><a href="#cb12-2179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2180"><a href="#cb12-2180" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; Marker for every individual policy</span></span>
<span id="cb12-2181"><a href="#cb12-2181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2182"><a href="#cb12-2182" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; Hover over to display the combined LOI, named insured and policy number</span></span>
<span id="cb12-2183"><a href="#cb12-2183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2184"><a href="#cb12-2184" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; Markers are colored by aggregate LOI of nearby policies:</span></span>
<span id="cb12-2185"><a href="#cb12-2185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2186"><a href="#cb12-2186" aria-hidden="true" tabindex="-1"></a><span class="co">#    - [$1.5M &lt;= Aggregate LOI &lt;= $2M]{style="color:blue;"}</span></span>
<span id="cb12-2187"><a href="#cb12-2187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2188"><a href="#cb12-2188" aria-hidden="true" tabindex="-1"></a><span class="co">#    - [$2M &lt; Aggregate LOI &lt;= $4M]{style="color:orange;"}</span></span>
<span id="cb12-2189"><a href="#cb12-2189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2190"><a href="#cb12-2190" aria-hidden="true" tabindex="-1"></a><span class="co">#    - [Aggregate LOI &gt; $4M]{style="color:red;"}</span></span>
<span id="cb12-2191"><a href="#cb12-2191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2192"><a href="#cb12-2192" aria-hidden="true" tabindex="-1"></a><span class="co">#- &gt; [Green X]{style="color:green;"} on marker indicates that this is a policy that has matching named insured as other policies; so, there is potential for reinsurance</span></span>
<span id="cb12-2193"><a href="#cb12-2193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2194"><a href="#cb12-2194" aria-hidden="true" tabindex="-1"></a><span class="co"># **How data was created**:</span></span>
<span id="cb12-2195"><a href="#cb12-2195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2196"><a href="#cb12-2196" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; For every policy in the inforce file as of 10/1/2024:</span></span>
<span id="cb12-2197"><a href="#cb12-2197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2198"><a href="#cb12-2198" aria-hidden="true" tabindex="-1"></a><span class="co">#1) Calculate the distance to all other policies</span></span>
<span id="cb12-2199"><a href="#cb12-2199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2200"><a href="#cb12-2200" aria-hidden="true" tabindex="-1"></a><span class="co">#2) Find policies within a 0.25 square-mile area circle around the reference policy location</span></span>
<span id="cb12-2201"><a href="#cb12-2201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2202"><a href="#cb12-2202" aria-hidden="true" tabindex="-1"></a><span class="co">#3) For the nearby policies, calculate the aggregate LOI and flag if over $1.5M</span></span>
<span id="cb12-2203"><a href="#cb12-2203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2204"><a href="#cb12-2204" aria-hidden="true" tabindex="-1"></a><span class="co"># get potential reinsurance policies</span></span>
<span id="cb12-2205"><a href="#cb12-2205" aria-hidden="true" tabindex="-1"></a>data_reinsurance <span class="ot">&lt;-</span> data_large_risks <span class="sc">%&gt;%</span> </span>
<span id="cb12-2206"><a href="#cb12-2206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(reinsurance <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2207"><a href="#cb12-2207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(policy_number, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2208"><a href="#cb12-2208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"group"</span>), reinsurance)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2209"><a href="#cb12-2209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(policy_state, named_insured)</span>
<span id="cb12-2210"><a href="#cb12-2210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2211"><a href="#cb12-2211" aria-hidden="true" tabindex="-1"></a><span class="co"># output results</span></span>
<span id="cb12-2212"><a href="#cb12-2212" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_reinsurance, <span class="st">"data-reinsurance.xlsx"</span>)</span>
<span id="cb12-2213"><a href="#cb12-2213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2214"><a href="#cb12-2214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-2215"><a href="#cb12-2215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2216"><a href="#cb12-2216" aria-hidden="true" tabindex="-1"></a><span class="fu">### Long tail analyses</span></span>
<span id="cb12-2217"><a href="#cb12-2217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2220"><a href="#cb12-2220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-2221"><a href="#cb12-2221" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages ---- </span></span>
<span id="cb12-2222"><a href="#cb12-2222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2223"><a href="#cb12-2223" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb12-2224"><a href="#cb12-2224" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-2225"><a href="#cb12-2225" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-2226"><a href="#cb12-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2227"><a href="#cb12-2227" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Read in data ---- </span></span>
<span id="cb12-2228"><a href="#cb12-2228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2229"><a href="#cb12-2229" aria-hidden="true" tabindex="-1"></a><span class="co"># claims data</span></span>
<span id="cb12-2230"><a href="#cb12-2230" aria-hidden="true" tabindex="-1"></a>data_claims_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"claims-commercial-detail.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2231"><a href="#cb12-2231" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2232"><a href="#cb12-2232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span><span class="sc">:</span><span class="dv">11</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">31</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2233"><a href="#cb12-2233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(policy_type <span class="sc">==</span> <span class="st">"BP"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2234"><a href="#cb12-2234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_incurred =</span> incurred_loss <span class="sc">+</span> incurred_lae)</span>
<span id="cb12-2235"><a href="#cb12-2235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2236"><a href="#cb12-2236" aria-hidden="true" tabindex="-1"></a><span class="co"># policy life data</span></span>
<span id="cb12-2237"><a href="#cb12-2237" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; some odd duplicate policy numbers, just removing them</span></span>
<span id="cb12-2238"><a href="#cb12-2238" aria-hidden="true" tabindex="-1"></a>data_policy_life_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"policy-life-analysis.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-2239"><a href="#cb12-2239" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2240"><a href="#cb12-2240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(policy_number, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-2241"><a href="#cb12-2241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2242"><a href="#cb12-2242" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Modify data ---- </span></span>
<span id="cb12-2243"><a href="#cb12-2243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2244"><a href="#cb12-2244" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate new fields and attach policy life analysis data</span></span>
<span id="cb12-2245"><a href="#cb12-2245" aria-hidden="true" tabindex="-1"></a>data_long_tail <span class="ot">&lt;-</span> data_claims_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2246"><a href="#cb12-2246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_lag =</span> lubridate<span class="sc">::</span><span class="fu">interval</span>(loss_date, report_date) <span class="sc">%/%</span> <span class="fu">days</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2247"><a href="#cb12-2247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(claim, policy, state, loss_date, report_date, business_description, date_lag),</span>
<span id="cb12-2248"><a href="#cb12-2248" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"incurred"</span>), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2249"><a href="#cb12-2249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">long_date_lag_flag =</span> <span class="fu">ifelse</span>(date_lag <span class="sc">&gt;</span> <span class="dv">365</span>, <span class="st">"Y"</span>, <span class="st">"N"</span>),</span>
<span id="cb12-2250"><a href="#cb12-2250" aria-hidden="true" tabindex="-1"></a>         <span class="at">large_loss_flag =</span> <span class="fu">ifelse</span>(total_incurred <span class="sc">&gt;</span> <span class="dv">100000</span>, <span class="st">"Y"</span>, <span class="st">"N"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2251"><a href="#cb12-2251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_policy_life_raw <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(policy_state, policy_type)), <span class="at">by =</span> <span class="fu">join_by</span>(policy <span class="sc">==</span> policy_number), <span class="at">relationship =</span> <span class="st">"many-to-one"</span>)</span>
<span id="cb12-2252"><a href="#cb12-2252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2253"><a href="#cb12-2253" aria-hidden="true" tabindex="-1"></a><span class="co"># output raw data to add to workbook so can build pivots</span></span>
<span id="cb12-2254"><a href="#cb12-2254" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(data_long_tail, <span class="st">"output/raw-data.csv"</span>)</span>
<span id="cb12-2255"><a href="#cb12-2255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2256"><a href="#cb12-2256" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load updated data ---- </span></span>
<span id="cb12-2257"><a href="#cb12-2257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2258"><a href="#cb12-2258" aria-hidden="true" tabindex="-1"></a><span class="co"># load manually edited data</span></span>
<span id="cb12-2259"><a href="#cb12-2259" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; David added missing hierarchy1 information, just uploading this</span></span>
<span id="cb12-2260"><a href="#cb12-2260" aria-hidden="true" tabindex="-1"></a><span class="co"># claims data</span></span>
<span id="cb12-2261"><a href="#cb12-2261" aria-hidden="true" tabindex="-1"></a>data_long_tail <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"modified-edited-data.xlsx"</span>)</span>
<span id="cb12-2262"><a href="#cb12-2262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2263"><a href="#cb12-2263" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Recreating business class analysis ---- </span></span>
<span id="cb12-2264"><a href="#cb12-2264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2265"><a href="#cb12-2265" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize by business description</span></span>
<span id="cb12-2266"><a href="#cb12-2266" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; recreating David's pivot table with added requested features</span></span>
<span id="cb12-2267"><a href="#cb12-2267" aria-hidden="true" tabindex="-1"></a>data_pivot <span class="ot">&lt;-</span> data_long_tail <span class="sc">%&gt;%</span> </span>
<span id="cb12-2268"><a href="#cb12-2268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> business_description,</span>
<span id="cb12-2269"><a href="#cb12-2269" aria-hidden="true" tabindex="-1"></a>            <span class="at">claim_count =</span> <span class="fu">n</span>(),</span>
<span id="cb12-2270"><a href="#cb12-2270" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_incurred_sum =</span> <span class="fu">sum</span>(total_incurred),</span>
<span id="cb12-2271"><a href="#cb12-2271" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_incurred_avg =</span> <span class="fu">mean</span>(total_incurred),</span>
<span id="cb12-2272"><a href="#cb12-2272" aria-hidden="true" tabindex="-1"></a>            <span class="at">large_loss_flag =</span> <span class="fu">sum</span>(large_loss_flag <span class="sc">==</span> <span class="st">"Y"</span>),</span>
<span id="cb12-2273"><a href="#cb12-2273" aria-hidden="true" tabindex="-1"></a>            <span class="at">date_lag_avg =</span> <span class="fu">mean</span>(date_lag),</span>
<span id="cb12-2274"><a href="#cb12-2274" aria-hidden="true" tabindex="-1"></a>            <span class="at">date_lag_med =</span> <span class="fu">median</span>(date_lag),</span>
<span id="cb12-2275"><a href="#cb12-2275" aria-hidden="true" tabindex="-1"></a>            <span class="at">long_date_lag_flag =</span> <span class="fu">sum</span>(long_date_lag_flag <span class="sc">==</span> <span class="st">"Y"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2276"><a href="#cb12-2276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(date_lag_med), <span class="fu">desc</span>(total_incurred_sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2277"><a href="#cb12-2277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(long_date_lag_flag, date_lag_avg, date_lag_med, <span class="at">.after =</span> claim_count)</span>
<span id="cb12-2278"><a href="#cb12-2278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2279"><a href="#cb12-2279" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(data_pivot, <span class="st">"output/test.csv"</span>)</span>
<span id="cb12-2280"><a href="#cb12-2280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2281"><a href="#cb12-2281" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Hierarchy analysis ---- </span></span>
<span id="cb12-2282"><a href="#cb12-2282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2283"><a href="#cb12-2283" aria-hidden="true" tabindex="-1"></a><span class="co"># new analysis by different grouping variable</span></span>
<span id="cb12-2284"><a href="#cb12-2284" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; what is the distribution of losses by hierarchy1</span></span>
<span id="cb12-2285"><a href="#cb12-2285" aria-hidden="true" tabindex="-1"></a>data_pivot2 <span class="ot">&lt;-</span> data_long_tail <span class="sc">%&gt;%</span> </span>
<span id="cb12-2286"><a href="#cb12-2286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> hierarchy_1,</span>
<span id="cb12-2287"><a href="#cb12-2287" aria-hidden="true" tabindex="-1"></a>            <span class="at">claim_count =</span> <span class="fu">n</span>(),</span>
<span id="cb12-2288"><a href="#cb12-2288" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_incurred_sum =</span> <span class="fu">sum</span>(total_incurred),</span>
<span id="cb12-2289"><a href="#cb12-2289" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_incurred_avg =</span> <span class="fu">mean</span>(total_incurred),</span>
<span id="cb12-2290"><a href="#cb12-2290" aria-hidden="true" tabindex="-1"></a>            <span class="at">large_loss_flag =</span> <span class="fu">sum</span>(large_loss_flag <span class="sc">==</span> <span class="st">"Y"</span>),</span>
<span id="cb12-2291"><a href="#cb12-2291" aria-hidden="true" tabindex="-1"></a>            <span class="at">date_lag_avg =</span> <span class="fu">mean</span>(date_lag),</span>
<span id="cb12-2292"><a href="#cb12-2292" aria-hidden="true" tabindex="-1"></a>            <span class="at">date_lag_med =</span> <span class="fu">median</span>(date_lag),</span>
<span id="cb12-2293"><a href="#cb12-2293" aria-hidden="true" tabindex="-1"></a>            <span class="co">#percent_long_date_flag = mean(long_date_lag_flag == "Y"),</span></span>
<span id="cb12-2294"><a href="#cb12-2294" aria-hidden="true" tabindex="-1"></a>            <span class="at">long_date_lag_flag =</span> <span class="fu">sum</span>(long_date_lag_flag <span class="sc">==</span> <span class="st">"Y"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2295"><a href="#cb12-2295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(date_lag_med), <span class="fu">desc</span>(total_incurred_avg)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2296"><a href="#cb12-2296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(long_date_lag_flag, date_lag_avg, date_lag_med, <span class="at">.after =</span> claim_count)</span>
<span id="cb12-2297"><a href="#cb12-2297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2298"><a href="#cb12-2298" aria-hidden="true" tabindex="-1"></a><span class="co"># output and copy paste into workbook</span></span>
<span id="cb12-2299"><a href="#cb12-2299" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(data_pivot2, <span class="st">"output/hierarchy-analysis.csv"</span>)</span>
<span id="cb12-2300"><a href="#cb12-2300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2301"><a href="#cb12-2301" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Long tail losses analysis ---- </span></span>
<span id="cb12-2302"><a href="#cb12-2302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2303"><a href="#cb12-2303" aria-hidden="true" tabindex="-1"></a><span class="co"># another analysis</span></span>
<span id="cb12-2304"><a href="#cb12-2304" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; attempting to answer: of the long date lag losses, what is the breakdown by grouping variable?</span></span>
<span id="cb12-2305"><a href="#cb12-2305" aria-hidden="true" tabindex="-1"></a>data_table <span class="ot">&lt;-</span> data_long_tail <span class="sc">%&gt;%</span> </span>
<span id="cb12-2306"><a href="#cb12-2306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(long_date_lag_flag <span class="sc">==</span> <span class="st">"Y"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2307"><a href="#cb12-2307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> business_description,</span>
<span id="cb12-2308"><a href="#cb12-2308" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-2309"><a href="#cb12-2309" aria-hidden="true" tabindex="-1"></a>            <span class="at">large_loss_flag =</span> <span class="fu">sum</span>(large_loss_flag <span class="sc">==</span> <span class="st">"Y"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2310"><a href="#cb12-2310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2311"><a href="#cb12-2311" aria-hidden="true" tabindex="-1"></a>         <span class="co">#percent_large_loss_flag = large_loss_flag / n) %&gt;% </span></span>
<span id="cb12-2312"><a href="#cb12-2312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(percent, <span class="at">.after =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2313"><a href="#cb12-2313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb12-2314"><a href="#cb12-2314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2315"><a href="#cb12-2315" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(data_table, <span class="st">"output/long-tail-losses1.csv"</span>)</span>
<span id="cb12-2316"><a href="#cb12-2316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2317"><a href="#cb12-2317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2318"><a href="#cb12-2318" aria-hidden="true" tabindex="-1"></a>data_table2 <span class="ot">&lt;-</span> data_long_tail <span class="sc">%&gt;%</span> </span>
<span id="cb12-2319"><a href="#cb12-2319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(long_date_lag_flag <span class="sc">==</span> <span class="st">"Y"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2320"><a href="#cb12-2320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> hierarchy_1,</span>
<span id="cb12-2321"><a href="#cb12-2321" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-2322"><a href="#cb12-2322" aria-hidden="true" tabindex="-1"></a>            <span class="at">large_loss_flag =</span> <span class="fu">sum</span>(large_loss_flag <span class="sc">==</span> <span class="st">"Y"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2323"><a href="#cb12-2323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2324"><a href="#cb12-2324" aria-hidden="true" tabindex="-1"></a>         <span class="co">#percent_large_loss_flag = large_loss_flag / n) %&gt;% </span></span>
<span id="cb12-2325"><a href="#cb12-2325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(percent, <span class="at">.after =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2326"><a href="#cb12-2326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb12-2327"><a href="#cb12-2327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2328"><a href="#cb12-2328" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(data_table2, <span class="st">"output/long-tail-losses2.csv"</span>)</span>
<span id="cb12-2329"><a href="#cb12-2329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2330"><a href="#cb12-2330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-2331"><a href="#cb12-2331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2332"><a href="#cb12-2332" aria-hidden="true" tabindex="-1"></a><span class="fu">### Policy life analysis</span></span>
<span id="cb12-2333"><a href="#cb12-2333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2334"><a href="#cb12-2334" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/policy-life-analysis.png)</span></span>
<span id="cb12-2335"><a href="#cb12-2335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2338"><a href="#cb12-2338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-2339"><a href="#cb12-2339" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Query data ----</span></span>
<span id="cb12-2340"><a href="#cb12-2340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2341"><a href="#cb12-2341" aria-hidden="true" tabindex="-1"></a><span class="co"># Steps</span></span>
<span id="cb12-2342"><a href="#cb12-2342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2343"><a href="#cb12-2343" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Run `policy-life-analysis.sql` query. (don't have code here...)</span></span>
<span id="cb12-2344"><a href="#cb12-2344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2345"><a href="#cb12-2345" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Copy and paste all data into `policy-life-analysis.csv`.</span></span>
<span id="cb12-2346"><a href="#cb12-2346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2347"><a href="#cb12-2347" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load data ----</span></span>
<span id="cb12-2348"><a href="#cb12-2348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2349"><a href="#cb12-2349" aria-hidden="true" tabindex="-1"></a><span class="co"># function to compare two objects</span></span>
<span id="cb12-2350"><a href="#cb12-2350" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; using it to compare results of same thing from different methods</span></span>
<span id="cb12-2351"><a href="#cb12-2351" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; works for all data types (numeric vectors, character / factor vectors, dataframes with same dimensions, lists of anything)</span></span>
<span id="cb12-2352"><a href="#cb12-2352" aria-hidden="true" tabindex="-1"></a><span class="co"># default options -&gt; return original items (for easy visual comparison in same output), tolerance in numeric comparison is 1 x 10^-5 (out to 5 decimals, 0.00001), check.names = FALSE to only check values and NOT the names of elements</span></span>
<span id="cb12-2353"><a href="#cb12-2353" aria-hidden="true" tabindex="-1"></a><span class="co"># return values -&gt; list of 1) summary of comparison, 2 and 3) original items if desired</span></span>
<span id="cb12-2354"><a href="#cb12-2354" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; 1) includes logical of overall comparison and if NOT EQUAL description of differences + element-wise comparison of vectors or columns of dataframe</span></span>
<span id="cb12-2355"><a href="#cb12-2355" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> <span class="cf">function</span>(item_1, item_2, <span class="at">return_items =</span> <span class="cn">TRUE</span>, <span class="at">tolerance =</span> <span class="fl">0.00001</span>, <span class="at">check.names =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb12-2356"><a href="#cb12-2356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2357"><a href="#cb12-2357" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize a list with helpful names for the results and original items being compared</span></span>
<span id="cb12-2358"><a href="#cb12-2358" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; the extra functions for the names just return the name / call of the original arguments passed to item_1 and item_2</span></span>
<span id="cb12-2359"><a href="#cb12-2359" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="dv">3</span>)</span>
<span id="cb12-2360"><a href="#cb12-2360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"comparison"</span>, <span class="fu">deparse</span>(<span class="fu">substitute</span>(item_1)), <span class="fu">deparse</span>(<span class="fu">substitute</span>(item_2)))</span>
<span id="cb12-2361"><a href="#cb12-2361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2362"><a href="#cb12-2362" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check equality with all.equal()</span></span>
<span id="cb12-2363"><a href="#cb12-2363" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; returns TRUE when TRUE and a character string describing the difference when FALSE</span></span>
<span id="cb12-2364"><a href="#cb12-2364" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; allows for a tolerance in numeric comparisons, which is ideal to account for rounding</span></span>
<span id="cb12-2365"><a href="#cb12-2365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --&gt; AND includes option to ignore names (so just focus comparison on values of elements)</span></span>
<span id="cb12-2366"><a href="#cb12-2366" aria-hidden="true" tabindex="-1"></a>  comparison <span class="ot">=</span> <span class="fu">all.equal</span>(item_1, item_2, <span class="at">tolerance =</span> tolerance, <span class="at">check.names =</span> check.names)</span>
<span id="cb12-2367"><a href="#cb12-2367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2368"><a href="#cb12-2368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check class of item 1 (assuming item 2 is the same)</span></span>
<span id="cb12-2369"><a href="#cb12-2369" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check if numeric </span></span>
<span id="cb12-2370"><a href="#cb12-2370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2371"><a href="#cb12-2371" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if equal (with tolerance), returns TRUE comparison</span></span>
<span id="cb12-2372"><a href="#cb12-2372" aria-hidden="true" tabindex="-1"></a>  <span class="co">#-&gt; by default, it is only looking at the values and NOT the names</span></span>
<span id="cb12-2373"><a href="#cb12-2373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; check by seeing if comparison is TRUE, if so return TRUE</span></span>
<span id="cb12-2374"><a href="#cb12-2374" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(comparison, <span class="cn">TRUE</span>)) {</span>
<span id="cb12-2375"><a href="#cb12-2375" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2376"><a href="#cb12-2376" aria-hidden="true" tabindex="-1"></a>    results[[<span class="dv">1</span>]] <span class="ot">=</span> comparison</span>
<span id="cb12-2377"><a href="#cb12-2377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2378"><a href="#cb12-2378" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-2379"><a href="#cb12-2379" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2380"><a href="#cb12-2380" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if not equal, return a list with items describing comparison </span></span>
<span id="cb12-2381"><a href="#cb12-2381" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb12-2382"><a href="#cb12-2382" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2383"><a href="#cb12-2383" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fill results with elements for:</span></span>
<span id="cb12-2384"><a href="#cb12-2384" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; overall comparison result = FALSE</span></span>
<span id="cb12-2385"><a href="#cb12-2385" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; description of inequalities = output of all.equal when not TRUE</span></span>
<span id="cb12-2386"><a href="#cb12-2386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -&gt; conditionally return vector of element wise comparison (with names removed) based on class of items</span></span>
<span id="cb12-2387"><a href="#cb12-2387" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --&gt; throws warning message when lengths differ, but still does comparison</span></span>
<span id="cb12-2388"><a href="#cb12-2388" aria-hidden="true" tabindex="-1"></a>    results[[<span class="dv">1</span>]] <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb12-2389"><a href="#cb12-2389" aria-hidden="true" tabindex="-1"></a>      <span class="st">"result"</span> <span class="ot">=</span> <span class="fu">identical</span>(comparison, <span class="cn">TRUE</span>),</span>
<span id="cb12-2390"><a href="#cb12-2390" aria-hidden="true" tabindex="-1"></a>      <span class="st">"description"</span> <span class="ot">=</span> comparison,</span>
<span id="cb12-2391"><a href="#cb12-2391" aria-hidden="true" tabindex="-1"></a>      <span class="st">"element-wise"</span> <span class="ot">=</span> </span>
<span id="cb12-2392"><a href="#cb12-2392" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2393"><a href="#cb12-2393" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if numeric, compare items after rounding</span></span>
<span id="cb12-2394"><a href="#cb12-2394" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">identical</span>(<span class="fu">class</span>(item_1), <span class="st">"numeric"</span>)) {</span>
<span id="cb12-2395"><a href="#cb12-2395" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-2396"><a href="#cb12-2396" aria-hidden="true" tabindex="-1"></a>          <span class="co"># calculate number of decimals to round to before element-wise comparison as a function of the tolerance, </span></span>
<span id="cb12-2397"><a href="#cb12-2397" aria-hidden="true" tabindex="-1"></a>          <span class="co"># -&gt; e.g) tolerance = 0.00001 --&gt; abs(log10(tolerance)) = 5</span></span>
<span id="cb12-2398"><a href="#cb12-2398" aria-hidden="true" tabindex="-1"></a>          <span class="co"># -&gt; ceiling() accounts for non base 10 tolerances so still have a whole number of digits for rounding</span></span>
<span id="cb12-2399"><a href="#cb12-2399" aria-hidden="true" tabindex="-1"></a>          decimals <span class="ot">=</span> <span class="fu">ceiling</span>(<span class="fu">abs</span>(<span class="fu">log10</span>(tolerance)))</span>
<span id="cb12-2400"><a href="#cb12-2400" aria-hidden="true" tabindex="-1"></a>          <span class="fu">round</span>(<span class="fu">as.numeric</span>(item_1), decimals) <span class="sc">==</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(item_2), decimals)</span>
<span id="cb12-2401"><a href="#cb12-2401" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-2402"><a href="#cb12-2402" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-2403"><a href="#cb12-2403" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-2404"><a href="#cb12-2404" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-2405"><a href="#cb12-2405" aria-hidden="true" tabindex="-1"></a>      <span class="co"># first if character or factor, simply compare</span></span>
<span id="cb12-2406"><a href="#cb12-2406" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">identical</span>(<span class="fu">class</span>(item_1), <span class="st">"character"</span>) <span class="sc">|</span> <span class="fu">identical</span>(<span class="fu">class</span>(item_1), <span class="st">"factor"</span>)) {</span>
<span id="cb12-2407"><a href="#cb12-2407" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2408"><a href="#cb12-2408" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert to character to take into account factors</span></span>
<span id="cb12-2409"><a href="#cb12-2409" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>(item_1) <span class="sc">==</span> <span class="fu">as.character</span>(item_2)</span>
<span id="cb12-2410"><a href="#cb12-2410" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2411"><a href="#cb12-2411" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2412"><a href="#cb12-2412" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-2413"><a href="#cb12-2413" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-2414"><a href="#cb12-2414" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if dataframe, correctly compare columns after checking column data type</span></span>
<span id="cb12-2415"><a href="#cb12-2415" aria-hidden="true" tabindex="-1"></a>      <span class="co"># different comparison to also capture tibbles</span></span>
<span id="cb12-2416"><a href="#cb12-2416" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">class</span>(item_1) <span class="sc">==</span> <span class="st">"data.frame"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-2417"><a href="#cb12-2417" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2418"><a href="#cb12-2418" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert to dataframes so element-wise comparisons work as desired</span></span>
<span id="cb12-2419"><a href="#cb12-2419" aria-hidden="true" tabindex="-1"></a>        tmp_item_1 <span class="ot">=</span> <span class="fu">data.frame</span>(item_1)</span>
<span id="cb12-2420"><a href="#cb12-2420" aria-hidden="true" tabindex="-1"></a>        tmp_item_2 <span class="ot">=</span> <span class="fu">data.frame</span>(item_2)</span>
<span id="cb12-2421"><a href="#cb12-2421" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2422"><a href="#cb12-2422" aria-hidden="true" tabindex="-1"></a>        decimals <span class="ot">=</span> <span class="fu">ceiling</span>(<span class="fu">abs</span>(<span class="fu">log10</span>(tolerance)))</span>
<span id="cb12-2423"><a href="#cb12-2423" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2424"><a href="#cb12-2424" aria-hidden="true" tabindex="-1"></a>        tmp <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(tmp_item_1), <span class="cf">function</span>(i) {</span>
<span id="cb12-2425"><a href="#cb12-2425" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-2426"><a href="#cb12-2426" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">identical</span>(<span class="fu">class</span>(tmp_item_1[, i]), <span class="st">"numeric"</span>)) {</span>
<span id="cb12-2427"><a href="#cb12-2427" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-2428"><a href="#cb12-2428" aria-hidden="true" tabindex="-1"></a>            <span class="co"># compare numerics after rounding</span></span>
<span id="cb12-2429"><a href="#cb12-2429" aria-hidden="true" tabindex="-1"></a>            <span class="fu">round</span>(<span class="fu">as.numeric</span>(tmp_item_1[, i]), decimals) <span class="sc">==</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(tmp_item_2[, i]), decimals)</span>
<span id="cb12-2430"><a href="#cb12-2430" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-2431"><a href="#cb12-2431" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb12-2432"><a href="#cb12-2432" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-2433"><a href="#cb12-2433" aria-hidden="true" tabindex="-1"></a>            <span class="co"># compare factors or characters</span></span>
<span id="cb12-2434"><a href="#cb12-2434" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.character</span>(tmp_item_1[, i]) <span class="sc">==</span> <span class="fu">as.character</span>(tmp_item_2[, i])</span>
<span id="cb12-2435"><a href="#cb12-2435" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-2436"><a href="#cb12-2436" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb12-2437"><a href="#cb12-2437" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-2438"><a href="#cb12-2438" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb12-2439"><a href="#cb12-2439" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2440"><a href="#cb12-2440" aria-hidden="true" tabindex="-1"></a>        <span class="co"># give result names of first item</span></span>
<span id="cb12-2441"><a href="#cb12-2441" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(tmp) <span class="ot">=</span> <span class="fu">colnames</span>(item_1)</span>
<span id="cb12-2442"><a href="#cb12-2442" aria-hidden="true" tabindex="-1"></a>        tmp</span>
<span id="cb12-2443"><a href="#cb12-2443" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2444"><a href="#cb12-2444" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-2445"><a href="#cb12-2445" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-2446"><a href="#cb12-2446" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if other data type, do not do element-wise comparison</span></span>
<span id="cb12-2447"><a href="#cb12-2447" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb12-2448"><a href="#cb12-2448" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2449"><a href="#cb12-2449" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span></span>
<span id="cb12-2450"><a href="#cb12-2450" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-2451"><a href="#cb12-2451" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb12-2452"><a href="#cb12-2452" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-2453"><a href="#cb12-2453" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2454"><a href="#cb12-2454" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the original items being compared to the results for display</span></span>
<span id="cb12-2455"><a href="#cb12-2455" aria-hidden="true" tabindex="-1"></a>  results[[<span class="dv">2</span>]] <span class="ot">=</span> item_1</span>
<span id="cb12-2456"><a href="#cb12-2456" aria-hidden="true" tabindex="-1"></a>  results[[<span class="dv">3</span>]] <span class="ot">=</span> item_2</span>
<span id="cb12-2457"><a href="#cb12-2457" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2458"><a href="#cb12-2458" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return results with conditional elements</span></span>
<span id="cb12-2459"><a href="#cb12-2459" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return comparison and original items</span></span>
<span id="cb12-2460"><a href="#cb12-2460" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (return_items) {</span>
<span id="cb12-2461"><a href="#cb12-2461" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2462"><a href="#cb12-2462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(results)</span>
<span id="cb12-2463"><a href="#cb12-2463" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2464"><a href="#cb12-2464" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-2465"><a href="#cb12-2465" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2466"><a href="#cb12-2466" aria-hidden="true" tabindex="-1"></a>  <span class="co"># just return the comparison by dropping original items</span></span>
<span id="cb12-2467"><a href="#cb12-2467" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb12-2468"><a href="#cb12-2468" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2469"><a href="#cb12-2469" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(results[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>)])</span>
<span id="cb12-2470"><a href="#cb12-2470" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2471"><a href="#cb12-2471" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-2472"><a href="#cb12-2472" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2473"><a href="#cb12-2473" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-2474"><a href="#cb12-2474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2475"><a href="#cb12-2475" aria-hidden="true" tabindex="-1"></a><span class="co"># read and format data</span></span>
<span id="cb12-2476"><a href="#cb12-2476" aria-hidden="true" tabindex="-1"></a>data_life_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"policy-life-analysis.csv"</span>,</span>
<span id="cb12-2477"><a href="#cb12-2477" aria-hidden="true" tabindex="-1"></a>                      <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">"cccccccccccc"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2478"><a href="#cb12-2478" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb12-2479"><a href="#cb12-2479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2480"><a href="#cb12-2480" aria-hidden="true" tabindex="-1"></a><span class="co"># preview data</span></span>
<span id="cb12-2481"><a href="#cb12-2481" aria-hidden="true" tabindex="-1"></a>data_life_raw <span class="sc">%&gt;%</span> head</span>
<span id="cb12-2482"><a href="#cb12-2482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2483"><a href="#cb12-2483" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Clean data and calculate variables ----</span></span>
<span id="cb12-2484"><a href="#cb12-2484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2485"><a href="#cb12-2485" aria-hidden="true" tabindex="-1"></a><span class="co"># **</span><span class="al">NOTE</span><span class="co">: Currently backdated to match ending of reference triangles data**</span></span>
<span id="cb12-2486"><a href="#cb12-2486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2487"><a href="#cb12-2487" aria-hidden="true" tabindex="-1"></a><span class="co"># clean data and calculate variables</span></span>
<span id="cb12-2488"><a href="#cb12-2488" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; convert to dates</span></span>
<span id="cb12-2489"><a href="#cb12-2489" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; calculate new variables</span></span>
<span id="cb12-2490"><a href="#cb12-2490" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; determine active or inactive</span></span>
<span id="cb12-2491"><a href="#cb12-2491" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; calculate time interval between now (or end / cancel date) and when policy started</span></span>
<span id="cb12-2492"><a href="#cb12-2492" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; calculate time difference in different units</span></span>
<span id="cb12-2493"><a href="#cb12-2493" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; make policy period</span></span>
<span id="cb12-2494"><a href="#cb12-2494" aria-hidden="true" tabindex="-1"></a><span class="co">#date_ref &lt;- ymd("2024-05-31")</span></span>
<span id="cb12-2495"><a href="#cb12-2495" aria-hidden="true" tabindex="-1"></a>date_ref <span class="ot">&lt;-</span> <span class="fu">Sys.Date</span>()</span>
<span id="cb12-2496"><a href="#cb12-2496" aria-hidden="true" tabindex="-1"></a>data_life <span class="ot">&lt;-</span> data_life_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2497"><a href="#cb12-2497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"date"</span>), mdy),</span>
<span id="cb12-2498"><a href="#cb12-2498" aria-hidden="true" tabindex="-1"></a>         <span class="at">active_policy =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-2499"><a href="#cb12-2499" aria-hidden="true" tabindex="-1"></a>           original_effective_date <span class="sc">&gt;</span> date_ref <span class="sc">~</span> <span class="st">"Future"</span>,</span>
<span id="cb12-2500"><a href="#cb12-2500" aria-hidden="true" tabindex="-1"></a>           term_expiration_date <span class="sc">&gt;=</span> date_ref <span class="sc">&amp;</span> (<span class="fu">is.na</span>(cancellation_date) <span class="sc">|</span> cancellation_date <span class="sc">&gt;=</span> date_ref) <span class="sc">~</span> <span class="st">"Yes"</span>,</span>
<span id="cb12-2501"><a href="#cb12-2501" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="st">"No"</span></span>
<span id="cb12-2502"><a href="#cb12-2502" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb12-2503"><a href="#cb12-2503" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2504"><a href="#cb12-2504" aria-hidden="true" tabindex="-1"></a>  rowwise <span class="sc">%&gt;%</span> <span class="co"># need rowwise() so can use min() looking across and not down</span></span>
<span id="cb12-2505"><a href="#cb12-2505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_interval =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-2506"><a href="#cb12-2506" aria-hidden="true" tabindex="-1"></a>    active_policy <span class="sc">==</span> <span class="st">"Future"</span> <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb12-2507"><a href="#cb12-2507" aria-hidden="true" tabindex="-1"></a>    active_policy <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="fu">interval</span>(original_effective_date, date_ref),</span>
<span id="cb12-2508"><a href="#cb12-2508" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="fu">interval</span>(original_effective_date, <span class="fu">min</span>(term_expiration_date, cancellation_date, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb12-2509"><a href="#cb12-2509" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2510"><a href="#cb12-2510" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-2511"><a href="#cb12-2511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">life_of_policy_in_days =</span> time_interval <span class="sc">/</span> <span class="fu">days</span>(<span class="dv">1</span>),</span>
<span id="cb12-2512"><a href="#cb12-2512" aria-hidden="true" tabindex="-1"></a>         <span class="at">life_of_policy_in_months =</span> time_interval <span class="sc">/</span> <span class="fu">months</span>(<span class="dv">1</span>),</span>
<span id="cb12-2513"><a href="#cb12-2513" aria-hidden="true" tabindex="-1"></a>         <span class="at">life_of_policy_in_years =</span> time_interval <span class="sc">/</span> <span class="fu">years</span>(<span class="dv">1</span>),</span>
<span id="cb12-2514"><a href="#cb12-2514" aria-hidden="true" tabindex="-1"></a>         <span class="at">policy_period =</span> <span class="fu">paste0</span>(<span class="fu">year</span>(original_effective_date), <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="fu">month</span>(original_effective_date))))</span>
<span id="cb12-2515"><a href="#cb12-2515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2516"><a href="#cb12-2516" aria-hidden="true" tabindex="-1"></a><span class="co"># preview data</span></span>
<span id="cb12-2517"><a href="#cb12-2517" aria-hidden="true" tabindex="-1"></a>data_life <span class="sc">%&gt;%</span> head</span>
<span id="cb12-2518"><a href="#cb12-2518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2519"><a href="#cb12-2519" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Clean data and calculate variables ----</span></span>
<span id="cb12-2520"><a href="#cb12-2520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2521"><a href="#cb12-2521" aria-hidden="true" tabindex="-1"></a><span class="co"># Matches as best as possible :) to the reference survival pivot table (counts, cancels and percentages)</span></span>
<span id="cb12-2522"><a href="#cb12-2522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2523"><a href="#cb12-2523" aria-hidden="true" tabindex="-1"></a><span class="co"># See !!! comments below</span></span>
<span id="cb12-2524"><a href="#cb12-2524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2525"><a href="#cb12-2525" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to calculate indicator variables for if the policy survived past threshold</span></span>
<span id="cb12-2526"><a href="#cb12-2526" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; !!! pivot results take into account nonrenewals by doing the following:</span></span>
<span id="cb12-2527"><a href="#cb12-2527" aria-hidden="true" tabindex="-1"></a><span class="co"># --&gt; records 363 day indicator and a 12 month indicator (which could be different values); this is done for every cutoff period</span></span>
<span id="cb12-2528"><a href="#cb12-2528" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; to replicate this, I have to use &gt; in the indicators comparison, not &gt;= (so need to survive past 12 months to be included in the 12 month indicator)</span></span>
<span id="cb12-2529"><a href="#cb12-2529" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; </span><span class="al">NOTE</span><span class="co"> that still there are probably unaccounted things and/or slightly different policy counts throw percentages off a tiny bit</span></span>
<span id="cb12-2530"><a href="#cb12-2530" aria-hidden="true" tabindex="-1"></a>calc_indicators <span class="ot">&lt;-</span> <span class="cf">function</span>(df, col) {</span>
<span id="cb12-2531"><a href="#cb12-2531" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2532"><a href="#cb12-2532" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup holding dataframe for indicator variables</span></span>
<span id="cb12-2533"><a href="#cb12-2533" aria-hidden="true" tabindex="-1"></a>  indicators <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">12</span>, <span class="at">to =</span> <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">12</span>)) </span>
<span id="cb12-2534"><a href="#cb12-2534" aria-hidden="true" tabindex="-1"></a>  data_survival <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(df), <span class="at">ncol =</span> <span class="fu">length</span>(indicators)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2535"><a href="#cb12-2535" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb12-2536"><a href="#cb12-2536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(df <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">any_of</span>(col)), .)</span>
<span id="cb12-2537"><a href="#cb12-2537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(data_survival)[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">=</span> <span class="fu">paste0</span>(indicators, <span class="st">"_months"</span>)</span>
<span id="cb12-2538"><a href="#cb12-2538" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2539"><a href="#cb12-2539" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop over rows</span></span>
<span id="cb12-2540"><a href="#cb12-2540" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data_survival)) {</span>
<span id="cb12-2541"><a href="#cb12-2541" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2542"><a href="#cb12-2542" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop over columns</span></span>
<span id="cb12-2543"><a href="#cb12-2543" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(indicators)<span class="sc">+</span><span class="dv">1</span>)) {</span>
<span id="cb12-2544"><a href="#cb12-2544" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-2545"><a href="#cb12-2545" aria-hidden="true" tabindex="-1"></a>      <span class="co"># assign indicator based on survival months and the cutoff</span></span>
<span id="cb12-2546"><a href="#cb12-2546" aria-hidden="true" tabindex="-1"></a>      data_survival[i, j] <span class="ot">=</span> <span class="fu">ifelse</span>(data_survival[i,<span class="dv">1</span>] <span class="sc">&gt;</span> (<span class="fu">str_sub</span>(<span class="at">string =</span> <span class="fu">colnames</span>(data_survival[, j]),</span>
<span id="cb12-2547"><a href="#cb12-2547" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="at">start =</span> <span class="dv">1</span>,</span>
<span id="cb12-2548"><a href="#cb12-2548" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="at">end =</span> <span class="sc">-</span><span class="dv">8</span>) <span class="sc">%&gt;%</span> as.numeric),</span>
<span id="cb12-2549"><a href="#cb12-2549" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">1</span>,</span>
<span id="cb12-2550"><a href="#cb12-2550" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">0</span>)</span>
<span id="cb12-2551"><a href="#cb12-2551" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-2552"><a href="#cb12-2552" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-2553"><a href="#cb12-2553" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-2554"><a href="#cb12-2554" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-2555"><a href="#cb12-2555" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb12-2556"><a href="#cb12-2556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">any_of</span>(col)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2557"><a href="#cb12-2557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(data_survival) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2558"><a href="#cb12-2558" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-2559"><a href="#cb12-2559" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-2560"><a href="#cb12-2560" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-2561"><a href="#cb12-2561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2562"><a href="#cb12-2562" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate survival triangle</span></span>
<span id="cb12-2563"><a href="#cb12-2563" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; zeros are included in the survival percentages in the reference table</span></span>
<span id="cb12-2564"><a href="#cb12-2564" aria-hidden="true" tabindex="-1"></a><span class="co"># !!! the purpose of this is to confirm that I am calculating survival days / months correctly</span></span>
<span id="cb12-2565"><a href="#cb12-2565" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; only had the % indicators to match up to, so had to work with this</span></span>
<span id="cb12-2566"><a href="#cb12-2566" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; now am confident everything is being calculated correctly</span></span>
<span id="cb12-2567"><a href="#cb12-2567" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; loss % indicators are just off because of the problem described in the calc_indicators function</span></span>
<span id="cb12-2568"><a href="#cb12-2568" aria-hidden="true" tabindex="-1"></a>data_triangle <span class="ot">&lt;-</span> data_life <span class="sc">%&gt;%</span> </span>
<span id="cb12-2569"><a href="#cb12-2569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calc_indicators</span>(<span class="at">col =</span> <span class="st">"life_of_policy_in_months"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2570"><a href="#cb12-2570" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_check} <span class="sc">%&gt;%</span> </span>
<span id="cb12-2571"><a href="#cb12-2571" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stage where can then calculate counts to compare to reference data, have to comment out filtering to non-zeros</span></span>
<span id="cb12-2572"><a href="#cb12-2572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> policy_period,</span>
<span id="cb12-2573"><a href="#cb12-2573" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d.*"</span>), <span class="sc">~</span> <span class="fu">mean</span>(.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2574"><a href="#cb12-2574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(policy_period)</span>
<span id="cb12-2575"><a href="#cb12-2575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2576"><a href="#cb12-2576" aria-hidden="true" tabindex="-1"></a>data_triangle <span class="sc">%&gt;%</span> head</span>
<span id="cb12-2577"><a href="#cb12-2577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2578"><a href="#cb12-2578" aria-hidden="true" tabindex="-1"></a><span class="co"># !!! if wanted to, could increase this analysis by taking into account renewals and separating out by business class</span></span>
<span id="cb12-2579"><a href="#cb12-2579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2580"><a href="#cb12-2580" aria-hidden="true" tabindex="-1"></a><span class="co"># DATA QUALITY CHECKS</span></span>
<span id="cb12-2581"><a href="#cb12-2581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2582"><a href="#cb12-2582" aria-hidden="true" tabindex="-1"></a><span class="co"># organized smaller dataset to check calculations from above</span></span>
<span id="cb12-2583"><a href="#cb12-2583" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> data_check <span class="sc">%&gt;%</span> </span>
<span id="cb12-2584"><a href="#cb12-2584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(life_of_policy_in_months, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2585"><a href="#cb12-2585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"date"</span>), time_interval, <span class="fu">starts_with</span>(<span class="st">"life"</span>), <span class="fu">ends_with</span>(<span class="st">"months"</span>))</span>
<span id="cb12-2586"><a href="#cb12-2586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2587"><a href="#cb12-2587" aria-hidden="true" tabindex="-1"></a><span class="co"># compare counts and flat cancel rates to reference survival triangles</span></span>
<span id="cb12-2588"><a href="#cb12-2588" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; also compare triangle percentages</span></span>
<span id="cb12-2589"><a href="#cb12-2589" aria-hidden="true" tabindex="-1"></a>data_compare <span class="ot">&lt;-</span> data_life <span class="sc">%&gt;%</span> </span>
<span id="cb12-2590"><a href="#cb12-2590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(life_of_policy_in_days)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2591"><a href="#cb12-2591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">zero_life =</span> <span class="fu">ifelse</span>(life_of_policy_in_days <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2592"><a href="#cb12-2592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(policy_period, zero_life) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2593"><a href="#cb12-2593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2594"><a href="#cb12-2594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2595"><a href="#cb12-2595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> zero_life,</span>
<span id="cb12-2596"><a href="#cb12-2596" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> n,</span>
<span id="cb12-2597"><a href="#cb12-2597" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"zero_life_"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2598"><a href="#cb12-2598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> zero_life_No <span class="sc">+</span> zero_life_Yes,</span>
<span id="cb12-2599"><a href="#cb12-2599" aria-hidden="true" tabindex="-1"></a>         <span class="at">zero_prop =</span> zero_life_Yes <span class="sc">/</span> total) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2600"><a href="#cb12-2600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(zero_life_No, zero_life_Yes)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2601"><a href="#cb12-2601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_triangle)</span>
<span id="cb12-2602"><a href="#cb12-2602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2603"><a href="#cb12-2603" aria-hidden="true" tabindex="-1"></a><span class="co"># confirm results from reference pivot</span></span>
<span id="cb12-2604"><a href="#cb12-2604" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; copy and paste into comparison-check.xlsx</span></span>
<span id="cb12-2605"><a href="#cb12-2605" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; work in this document now</span></span>
<span id="cb12-2606"><a href="#cb12-2606" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(data_compare, <span class="st">"comparison.csv"</span>)</span>
<span id="cb12-2607"><a href="#cb12-2607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2608"><a href="#cb12-2608" aria-hidden="true" tabindex="-1"></a><span class="co"># PASSED CHECK!</span></span>
<span id="cb12-2609"><a href="#cb12-2609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2610"><a href="#cb12-2610" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Average policy life analysis ----</span></span>
<span id="cb12-2611"><a href="#cb12-2611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2612"><a href="#cb12-2612" aria-hidden="true" tabindex="-1"></a><span class="co"># DATA QUALITY </span><span class="al">NOTE</span><span class="co">: Had to change  `,` to `-` for restaurants in the raw data to have them grouped together</span></span>
<span id="cb12-2613"><a href="#cb12-2613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2614"><a href="#cb12-2614" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate average policy life excluding those with life less than or equal to 60 days (i.e. underwriting cancel and/or flat cancels (zero life))</span></span>
<span id="cb12-2615"><a href="#cb12-2615" aria-hidden="true" tabindex="-1"></a>avg_policy_life <span class="ot">&lt;-</span> data_life <span class="sc">%&gt;%</span> </span>
<span id="cb12-2616"><a href="#cb12-2616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(life_of_policy_in_days <span class="sc">&gt;</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2617"><a href="#cb12-2617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">mean</span>(life_of_policy_in_years)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2618"><a href="#cb12-2618" aria-hidden="true" tabindex="-1"></a>  as.numeric</span>
<span id="cb12-2619"><a href="#cb12-2619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2620"><a href="#cb12-2620" aria-hidden="true" tabindex="-1"></a><span class="co"># create comparative boxplots (with means), ordered by number of policies</span></span>
<span id="cb12-2621"><a href="#cb12-2621" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; add overall average line with annotation</span></span>
<span id="cb12-2622"><a href="#cb12-2622" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; add policy count annotations</span></span>
<span id="cb12-2623"><a href="#cb12-2623" aria-hidden="true" tabindex="-1"></a>data_life <span class="sc">%&gt;%</span> </span>
<span id="cb12-2624"><a href="#cb12-2624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(life_of_policy_in_days <span class="sc">&gt;</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2625"><a href="#cb12-2625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.by =</span> hierarchy_1,</span>
<span id="cb12-2626"><a href="#cb12-2626" aria-hidden="true" tabindex="-1"></a>         <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-2627"><a href="#cb12-2627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hierarchy_1 =</span> <span class="fu">fct_reorder</span>(<span class="at">.f =</span> hierarchy_1, <span class="at">.x =</span> n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2628"><a href="#cb12-2628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb12-2629"><a href="#cb12-2629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> life_of_policy_in_years,</span>
<span id="cb12-2630"><a href="#cb12-2630" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> hierarchy_1)) <span class="sc">+</span> </span>
<span id="cb12-2631"><a href="#cb12-2631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="fu">aes</span>(<span class="at">x =</span> life_of_policy_in_years,</span>
<span id="cb12-2632"><a href="#cb12-2632" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> hierarchy_1),</span>
<span id="cb12-2633"><a href="#cb12-2633" aria-hidden="true" tabindex="-1"></a>               <span class="at">fun =</span> <span class="st">"mean"</span>,</span>
<span id="cb12-2634"><a href="#cb12-2634" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">"point"</span>,</span>
<span id="cb12-2635"><a href="#cb12-2635" aria-hidden="true" tabindex="-1"></a>               <span class="at">shape =</span> <span class="dv">4</span>,</span>
<span id="cb12-2636"><a href="#cb12-2636" aria-hidden="true" tabindex="-1"></a>               <span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb12-2637"><a href="#cb12-2637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> avg_policy_life,</span>
<span id="cb12-2638"><a href="#cb12-2638" aria-hidden="true" tabindex="-1"></a>             <span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb12-2639"><a href="#cb12-2639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb12-2640"><a href="#cb12-2640" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> avg_policy_life <span class="sc">+</span> <span class="dv">4</span>,</span>
<span id="cb12-2641"><a href="#cb12-2641" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> <span class="st">"Retail"</span>,</span>
<span id="cb12-2642"><a href="#cb12-2642" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"overall avg = "</span>, <span class="fu">round</span>(avg_policy_life, <span class="dv">2</span>), <span class="st">" years"</span>),</span>
<span id="cb12-2643"><a href="#cb12-2643" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb12-2644"><a href="#cb12-2644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">Inf</span>,</span>
<span id="cb12-2645"><a href="#cb12-2645" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> hierarchy_1,</span>
<span id="cb12-2646"><a href="#cb12-2646" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> <span class="fu">paste0</span>(n, <span class="st">" policies"</span>)),</span>
<span id="cb12-2647"><a href="#cb12-2647" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> data_life <span class="sc">%&gt;%</span> <span class="fu">filter</span>(life_of_policy_in_days <span class="sc">&gt;</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span> <span class="fu">count</span>(hierarchy_1),</span>
<span id="cb12-2648"><a href="#cb12-2648" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">2</span>,</span>
<span id="cb12-2649"><a href="#cb12-2649" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb12-2650"><a href="#cb12-2650" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">"darkorange1"</span>) <span class="sc">+</span> </span>
<span id="cb12-2651"><a href="#cb12-2651" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">Inf</span>,</span>
<span id="cb12-2652"><a href="#cb12-2652" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> hierarchy_1,</span>
<span id="cb12-2653"><a href="#cb12-2653" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> <span class="fu">paste0</span>(n, <span class="st">" active"</span>)),</span>
<span id="cb12-2654"><a href="#cb12-2654" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> data_life <span class="sc">%&gt;%</span> <span class="fu">filter</span>(life_of_policy_in_days <span class="sc">&gt;</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span> <span class="fu">count</span>(hierarchy_1, active_policy) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(active_policy <span class="sc">==</span> <span class="st">"Yes"</span>),</span>
<span id="cb12-2655"><a href="#cb12-2655" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb12-2656"><a href="#cb12-2656" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb12-2657"><a href="#cb12-2657" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span> </span>
<span id="cb12-2658"><a href="#cb12-2658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Policy life analysis"</span>,</span>
<span id="cb12-2659"><a href="#cb12-2659" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Specs: includes expired and active policies; excludes policies with life &lt;= 60 days"</span>,</span>
<span id="cb12-2660"><a href="#cb12-2660" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Life of policy in years"</span>,</span>
<span id="cb12-2661"><a href="#cb12-2661" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Hierarchy 1"</span>) <span class="sc">+</span> </span>
<span id="cb12-2662"><a href="#cb12-2662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(data_life<span class="sc">$</span>life_of_policy_in_years, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fl">3.5</span>)) <span class="sc">+</span></span>
<span id="cb12-2663"><a href="#cb12-2663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb12-2664"><a href="#cb12-2664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2665"><a href="#cb12-2665" aria-hidden="true" tabindex="-1"></a><span class="co"># create table summarizing average life of policy by business class (via proxy of hierarchy 1)</span></span>
<span id="cb12-2666"><a href="#cb12-2666" aria-hidden="true" tabindex="-1"></a>data_life <span class="sc">%&gt;%</span> </span>
<span id="cb12-2667"><a href="#cb12-2667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(life_of_policy_in_days <span class="sc">&gt;</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2668"><a href="#cb12-2668" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_life_non_uw_cancel} <span class="sc">%&gt;%</span> </span>
<span id="cb12-2669"><a href="#cb12-2669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> hierarchy_1,</span>
<span id="cb12-2670"><a href="#cb12-2670" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> <span class="fu">mean</span>(life_of_policy_in_years),</span>
<span id="cb12-2671"><a href="#cb12-2671" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> <span class="fu">sd</span>(life_of_policy_in_years),</span>
<span id="cb12-2672"><a href="#cb12-2672" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2673"><a href="#cb12-2673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb12-2674"><a href="#cb12-2674" aria-hidden="true" tabindex="-1"></a>    data_life_non_uw_cancel <span class="sc">%&gt;%</span> </span>
<span id="cb12-2675"><a href="#cb12-2675" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(life_of_policy_in_years),</span>
<span id="cb12-2676"><a href="#cb12-2676" aria-hidden="true" tabindex="-1"></a>                <span class="at">sd =</span> <span class="fu">sd</span>(life_of_policy_in_years),</span>
<span id="cb12-2677"><a href="#cb12-2677" aria-hidden="true" tabindex="-1"></a>                <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2678"><a href="#cb12-2678" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(<span class="fu">data.frame</span>(<span class="at">hierarchy_1 =</span> <span class="st">"Overall"</span>), .)</span>
<span id="cb12-2679"><a href="#cb12-2679" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2680"><a href="#cb12-2680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2681"><a href="#cb12-2681" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-2682"><a href="#cb12-2682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Policy life analysis**"</span>),</span>
<span id="cb12-2683"><a href="#cb12-2683" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="st">"(in years)"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2684"><a href="#cb12-2684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_footnote</span>(<span class="st">"Specs: includes expired and active policies; excludes policies with life &lt;= 60 days"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2685"><a href="#cb12-2685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">hierarchy_1 =</span> <span class="fu">md</span>(<span class="st">"**Hierarchy 1**"</span>),</span>
<span id="cb12-2686"><a href="#cb12-2686" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean =</span> <span class="fu">md</span>(<span class="st">"**Mean**"</span>),</span>
<span id="cb12-2687"><a href="#cb12-2687" aria-hidden="true" tabindex="-1"></a>             <span class="at">sd =</span> <span class="fu">md</span>(<span class="st">"**Sd**"</span>),</span>
<span id="cb12-2688"><a href="#cb12-2688" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="fu">md</span>(<span class="st">"**n**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2689"><a href="#cb12-2689" aria-hidden="true" tabindex="-1"></a>  gtExtras<span class="sc">::</span><span class="fu">gt_highlight_rows</span>(<span class="at">rows =</span> mean <span class="sc">&lt;</span> avg_policy_life,</span>
<span id="cb12-2690"><a href="#cb12-2690" aria-hidden="true" tabindex="-1"></a>                              <span class="at">fill =</span> <span class="st">"red"</span>,</span>
<span id="cb12-2691"><a href="#cb12-2691" aria-hidden="true" tabindex="-1"></a>                              <span class="at">font_weight =</span> <span class="st">"normal"</span>,</span>
<span id="cb12-2692"><a href="#cb12-2692" aria-hidden="true" tabindex="-1"></a>                              <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2693"><a href="#cb12-2693" aria-hidden="true" tabindex="-1"></a>  gtExtras<span class="sc">::</span><span class="fu">gt_highlight_rows</span>(<span class="at">rows =</span> mean <span class="sc">&gt;</span> avg_policy_life,</span>
<span id="cb12-2694"><a href="#cb12-2694" aria-hidden="true" tabindex="-1"></a>                              <span class="at">fill =</span> <span class="st">"green"</span>,</span>
<span id="cb12-2695"><a href="#cb12-2695" aria-hidden="true" tabindex="-1"></a>                              <span class="at">font_weight =</span> <span class="st">"normal"</span>,</span>
<span id="cb12-2696"><a href="#cb12-2696" aria-hidden="true" tabindex="-1"></a>                              <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2697"><a href="#cb12-2697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(mean, sd),</span>
<span id="cb12-2698"><a href="#cb12-2698" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2699"><a href="#cb12-2699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> n,</span>
<span id="cb12-2700"><a href="#cb12-2700" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">0</span>)</span>
<span id="cb12-2701"><a href="#cb12-2701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2702"><a href="#cb12-2702" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Underwriting (or other) cancel analysis ----</span></span>
<span id="cb12-2703"><a href="#cb12-2703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2704"><a href="#cb12-2704" aria-hidden="true" tabindex="-1"></a><span class="co"># create table summarizing policies underwriting (or other) by business class (via proxy of hierarchy 1)</span></span>
<span id="cb12-2705"><a href="#cb12-2705" aria-hidden="true" tabindex="-1"></a>data_life <span class="sc">%&gt;%</span> </span>
<span id="cb12-2706"><a href="#cb12-2706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(life_of_policy_in_days)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2707"><a href="#cb12-2707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">uw_cancel =</span> <span class="fu">ifelse</span>(life_of_policy_in_days <span class="sc">&lt;=</span> <span class="dv">60</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2708"><a href="#cb12-2708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hierarchy_1, uw_cancel) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2709"><a href="#cb12-2709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2710"><a href="#cb12-2710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2711"><a href="#cb12-2711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> uw_cancel,</span>
<span id="cb12-2712"><a href="#cb12-2712" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> n,</span>
<span id="cb12-2713"><a href="#cb12-2713" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"uw_cancel_"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2714"><a href="#cb12-2714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> uw_cancel_No <span class="sc">+</span> uw_cancel_Yes,</span>
<span id="cb12-2715"><a href="#cb12-2715" aria-hidden="true" tabindex="-1"></a>         <span class="at">uw_cancel_prop =</span> uw_cancel_Yes <span class="sc">/</span> total) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2716"><a href="#cb12-2716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>uw_cancel_No) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2717"><a href="#cb12-2717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(uw_cancel_prop)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2718"><a href="#cb12-2718" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> uw_cancel_wide} <span class="sc">%&gt;%</span> </span>
<span id="cb12-2719"><a href="#cb12-2719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(uw_cancel_wide <span class="sc">%&gt;%</span> </span>
<span id="cb12-2720"><a href="#cb12-2720" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(<span class="at">hierarchy_1 =</span> <span class="st">"Overall"</span>,</span>
<span id="cb12-2721"><a href="#cb12-2721" aria-hidden="true" tabindex="-1"></a>                        <span class="at">uw_cancel_Yes =</span> <span class="fu">sum</span>(uw_cancel_Yes),</span>
<span id="cb12-2722"><a href="#cb12-2722" aria-hidden="true" tabindex="-1"></a>                        <span class="at">total =</span> <span class="fu">sum</span>(total),</span>
<span id="cb12-2723"><a href="#cb12-2723" aria-hidden="true" tabindex="-1"></a>                        <span class="at">uw_cancel_prop =</span> <span class="fu">sum</span>(uw_cancel_Yes) <span class="sc">/</span> <span class="fu">sum</span>(total))</span>
<span id="cb12-2724"><a href="#cb12-2724" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2725"><a href="#cb12-2725" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-2726"><a href="#cb12-2726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Underwriting (or other) cancel analysis**"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-2727"><a href="#cb12-2727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">hierarchy_1 =</span> <span class="fu">md</span>(<span class="st">"**Hierarchy 1**"</span>),</span>
<span id="cb12-2728"><a href="#cb12-2728" aria-hidden="true" tabindex="-1"></a>             <span class="at">uw_cancel_Yes =</span> <span class="fu">md</span>(<span class="st">"**Cancelled policies**"</span>),</span>
<span id="cb12-2729"><a href="#cb12-2729" aria-hidden="true" tabindex="-1"></a>             <span class="at">total =</span> <span class="fu">md</span>(<span class="st">"**Total policies**"</span>),</span>
<span id="cb12-2730"><a href="#cb12-2730" aria-hidden="true" tabindex="-1"></a>             <span class="at">uw_cancel_prop =</span> <span class="fu">md</span>(<span class="st">"**Proportion**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2731"><a href="#cb12-2731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>),</span>
<span id="cb12-2732"><a href="#cb12-2732" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">columns =</span> <span class="fu">everything</span>(),</span>
<span id="cb12-2733"><a href="#cb12-2733" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">rows =</span> hierarchy_1 <span class="sc">==</span> <span class="st">"Overall"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2734"><a href="#cb12-2734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_auto</span>()</span>
<span id="cb12-2735"><a href="#cb12-2735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2736"><a href="#cb12-2736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-2737"><a href="#cb12-2737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2738"><a href="#cb12-2738" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random loss analysis</span></span>
<span id="cb12-2739"><a href="#cb12-2739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2740"><a href="#cb12-2740" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/random-loss-analysis.png)</span></span>
<span id="cb12-2741"><a href="#cb12-2741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2744"><a href="#cb12-2744" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-2745"><a href="#cb12-2745" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages and define functions ----</span></span>
<span id="cb12-2746"><a href="#cb12-2746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2747"><a href="#cb12-2747" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb12-2748"><a href="#cb12-2748" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-2749"><a href="#cb12-2749" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-2750"><a href="#cb12-2750" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb12-2751"><a href="#cb12-2751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2752"><a href="#cb12-2752" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%!in%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">Negate</span>(<span class="st">"%in%"</span>)</span>
<span id="cb12-2753"><a href="#cb12-2753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2754"><a href="#cb12-2754" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Read in data ----</span></span>
<span id="cb12-2755"><a href="#cb12-2755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2756"><a href="#cb12-2756" aria-hidden="true" tabindex="-1"></a><span class="co"># policy and loss data</span></span>
<span id="cb12-2757"><a href="#cb12-2757" aria-hidden="true" tabindex="-1"></a>data_premium_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"random-loss-analysis.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2758"><a href="#cb12-2758" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2759"><a href="#cb12-2759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"year"</span>), as.numeric)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2760"><a href="#cb12-2760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">incurred_loss_and_lae =</span> incurred_loss_lae) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2761"><a href="#cb12-2761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">roof_type =</span> <span class="fu">str_to_title</span>(roof_type))</span>
<span id="cb12-2762"><a href="#cb12-2762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2763"><a href="#cb12-2763" aria-hidden="true" tabindex="-1"></a><span class="co"># claim data</span></span>
<span id="cb12-2764"><a href="#cb12-2764" aria-hidden="true" tabindex="-1"></a>data_claims_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">"claims commercial detail.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2765"><a href="#cb12-2765" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2766"><a href="#cb12-2766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incurred_loss_and_lae =</span> incurred_loss <span class="sc">+</span> incurred_lae)</span>
<span id="cb12-2767"><a href="#cb12-2767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2768"><a href="#cb12-2768" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Roof type analysis ----</span></span>
<span id="cb12-2769"><a href="#cb12-2769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2770"><a href="#cb12-2770" aria-hidden="true" tabindex="-1"></a><span class="do">### Clean premium data</span></span>
<span id="cb12-2771"><a href="#cb12-2771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2772"><a href="#cb12-2772" aria-hidden="true" tabindex="-1"></a><span class="co"># data cleaning</span></span>
<span id="cb12-2773"><a href="#cb12-2773" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: could have also read in roof_types.xlsx (a more organized version of it) and did a left join to get the corrected roof types</span></span>
<span id="cb12-2774"><a href="#cb12-2774" aria-hidden="true" tabindex="-1"></a>data_premium <span class="ot">&lt;-</span> data_premium_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2775"><a href="#cb12-2775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">roof_type =</span> </span>
<span id="cb12-2776"><a href="#cb12-2776" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-2777"><a href="#cb12-2777" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"Unknown"</span>, <span class="st">"Flat"</span>, <span class="st">"Gable"</span>) <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb12-2778"><a href="#cb12-2778" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Comp"</span>, <span class="st">"Comp Toll"</span>, <span class="st">"Composition"</span>,  <span class="st">"Comp Roll"</span>) <span class="sc">~</span> <span class="st">"Asphalt Comp Roll"</span>,</span>
<span id="cb12-2779"><a href="#cb12-2779" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"As"</span>, <span class="st">"Shingle"</span>, <span class="st">"Asphault Shingle"</span>) <span class="sc">~</span> <span class="st">"Asphalt Shingle"</span>,</span>
<span id="cb12-2780"><a href="#cb12-2780" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Tar, Tar And Gravel"</span>, <span class="st">"T &amp; G"</span>, <span class="st">"T&amp;G"</span>, <span class="st">"Tar &amp; Gravel"</span>) <span class="sc">~</span> <span class="st">"Tar and Gravel"</span>,</span>
<span id="cb12-2781"><a href="#cb12-2781" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">==</span> <span class="st">"Membrane"</span> <span class="sc">~</span> <span class="st">"Plastic Membrane"</span>,</span>
<span id="cb12-2782"><a href="#cb12-2782" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Plastic Membrane"</span>, <span class="st">"Thermo Plastic"</span>) <span class="sc">~</span> <span class="st">"Thermo-Plastic Membrane"</span>,</span>
<span id="cb12-2783"><a href="#cb12-2783" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">==</span> <span class="st">"Rubber Membrane"</span> <span class="sc">~</span> <span class="st">"Rubber"</span>,</span>
<span id="cb12-2784"><a href="#cb12-2784" aria-hidden="true" tabindex="-1"></a>             roof_type <span class="sc">==</span> <span class="st">"Tile"</span> <span class="sc">~</span> <span class="st">"Tile, Slate, Stone"</span>,</span>
<span id="cb12-2785"><a href="#cb12-2785" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> roof_type</span>
<span id="cb12-2786"><a href="#cb12-2786" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb12-2787"><a href="#cb12-2787" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2788"><a href="#cb12-2788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(roof_type))</span>
<span id="cb12-2789"><a href="#cb12-2789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2790"><a href="#cb12-2790" aria-hidden="true" tabindex="-1"></a><span class="co"># export slightly modified data (save as premium data in workbook)</span></span>
<span id="cb12-2791"><a href="#cb12-2791" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_premium, <span class="st">"output/data-premium.xlsx"</span>)</span>
<span id="cb12-2792"><a href="#cb12-2792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2793"><a href="#cb12-2793" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Modify claims data ----</span></span>
<span id="cb12-2794"><a href="#cb12-2794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2795"><a href="#cb12-2795" aria-hidden="true" tabindex="-1"></a><span class="co"># find duplicate policy number - roof type combos</span></span>
<span id="cb12-2796"><a href="#cb12-2796" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> data_premium <span class="sc">%&gt;%</span> <span class="fu">count</span>(policy_number, roof_type) <span class="sc">%&gt;%</span> <span class="fu">count</span>(policy_number) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb12-2797"><a href="#cb12-2797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2798"><a href="#cb12-2798" aria-hidden="true" tabindex="-1"></a><span class="co"># add roof type to claim data</span></span>
<span id="cb12-2799"><a href="#cb12-2799" aria-hidden="true" tabindex="-1"></a>data_claims <span class="ot">&lt;-</span> data_claims_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2800"><a href="#cb12-2800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_premium <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(policy_number, roof_type) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(policy_number <span class="sc">%!in%</span> x<span class="sc">$</span>policy_number),</span>
<span id="cb12-2801"><a href="#cb12-2801" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(policy <span class="sc">==</span> policy_number))</span>
<span id="cb12-2802"><a href="#cb12-2802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2803"><a href="#cb12-2803" aria-hidden="true" tabindex="-1"></a><span class="co"># export slightly modified data (save as claim data in workbook)</span></span>
<span id="cb12-2804"><a href="#cb12-2804" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_claims, <span class="st">"output/data-claims.xlsx"</span>)</span>
<span id="cb12-2805"><a href="#cb12-2805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2806"><a href="#cb12-2806" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Summarize ----</span></span>
<span id="cb12-2807"><a href="#cb12-2807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2808"><a href="#cb12-2808" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize premium data by roof type</span></span>
<span id="cb12-2809"><a href="#cb12-2809" aria-hidden="true" tabindex="-1"></a>data_pivot_premium <span class="ot">&lt;-</span> data_premium <span class="sc">%&gt;%</span> </span>
<span id="cb12-2810"><a href="#cb12-2810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(policy_number <span class="sc">!=</span> <span class="st">"XXXXXXXXX"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2811"><a href="#cb12-2811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> roof_type,</span>
<span id="cb12-2812"><a href="#cb12-2812" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(earned_premium), sum),</span>
<span id="cb12-2813"><a href="#cb12-2813" aria-hidden="true" tabindex="-1"></a>            <span class="at">policy_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2814"><a href="#cb12-2814" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(policy_count, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-2815"><a href="#cb12-2815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2816"><a href="#cb12-2816" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize claim data by roof type</span></span>
<span id="cb12-2817"><a href="#cb12-2817" aria-hidden="true" tabindex="-1"></a>data_pivot_claims <span class="ot">&lt;-</span> data_claims <span class="sc">%&gt;%</span> </span>
<span id="cb12-2818"><a href="#cb12-2818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(coverage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"BDA"</span>, <span class="st">"BPA"</span>, <span class="st">"BDH"</span>, <span class="st">"BPH"</span>, <span class="st">"BDW"</span>, <span class="st">"BPW"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2819"><a href="#cb12-2819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> roof_type,</span>
<span id="cb12-2820"><a href="#cb12-2820" aria-hidden="true" tabindex="-1"></a>            <span class="at">claim_count =</span> <span class="fu">n_distinct</span>(claim),</span>
<span id="cb12-2821"><a href="#cb12-2821" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(incurred_loss_and_lae, sum),</span>
<span id="cb12-2822"><a href="#cb12-2822" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2823"><a href="#cb12-2823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(roof_type))</span>
<span id="cb12-2824"><a href="#cb12-2824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2825"><a href="#cb12-2825" aria-hidden="true" tabindex="-1"></a><span class="co"># combine tables</span></span>
<span id="cb12-2826"><a href="#cb12-2826" aria-hidden="true" tabindex="-1"></a>data_pivot <span class="ot">&lt;-</span> data_pivot_premium <span class="sc">%&gt;%</span> </span>
<span id="cb12-2827"><a href="#cb12-2827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_pivot_claims, <span class="at">by =</span> <span class="fu">join_by</span>(roof_type)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2828"><a href="#cb12-2828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">loss_ratio =</span> incurred_loss_and_lae <span class="sc">/</span> earned_premium)</span>
<span id="cb12-2829"><a href="#cb12-2829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2830"><a href="#cb12-2830" aria-hidden="true" tabindex="-1"></a><span class="co"># export slightly modified data (save as claim data in workbook)</span></span>
<span id="cb12-2831"><a href="#cb12-2831" aria-hidden="true" tabindex="-1"></a>openxlsx2<span class="sc">::</span><span class="fu">write_xlsx</span>(data_pivot, <span class="st">"output/data-pivot.xlsx"</span>)</span>
<span id="cb12-2832"><a href="#cb12-2832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2833"><a href="#cb12-2833" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Fancy output ----</span></span>
<span id="cb12-2834"><a href="#cb12-2834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2835"><a href="#cb12-2835" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by roof type</span></span>
<span id="cb12-2836"><a href="#cb12-2836" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note that the policy counts are slightly off between here and tableau because tableau isn't counting duplicate policy numbers (although the loss data is correct)</span></span>
<span id="cb12-2837"><a href="#cb12-2837" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: recreating this with pivot -&gt; everything matches!</span></span>
<span id="cb12-2838"><a href="#cb12-2838" aria-hidden="true" tabindex="-1"></a>data_premium <span class="sc">%&gt;%</span> </span>
<span id="cb12-2839"><a href="#cb12-2839" aria-hidden="true" tabindex="-1"></a>  <span class="co">#filter(policy_number != "XXXXXXXXX") %&gt;% </span></span>
<span id="cb12-2840"><a href="#cb12-2840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> roof_type,</span>
<span id="cb12-2841"><a href="#cb12-2841" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(earned_premium, claim_count, incurred_loss_and_lae), sum),</span>
<span id="cb12-2842"><a href="#cb12-2842" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2843"><a href="#cb12-2843" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(n, <span class="at">.after =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2844"><a href="#cb12-2844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">loss_ratio =</span> incurred_loss_and_lae <span class="sc">/</span> earned_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2845"><a href="#cb12-2845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(loss_ratio)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2846"><a href="#cb12-2846" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-2847"><a href="#cb12-2847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Inception-to-date roof type LRs"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2848"><a href="#cb12-2848" aria-hidden="true" tabindex="-1"></a>             <span class="co">#subtitle = "excluding Medford, OR loss") %&gt;% </span></span>
<span id="cb12-2849"><a href="#cb12-2849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">roof_type =</span> <span class="fu">md</span>(<span class="st">"**Roof type**"</span>),</span>
<span id="cb12-2850"><a href="#cb12-2850" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="fu">md</span>(<span class="st">"**Policy count**"</span>),</span>
<span id="cb12-2851"><a href="#cb12-2851" aria-hidden="true" tabindex="-1"></a>             <span class="at">earned_premium =</span> <span class="fu">md</span>(<span class="st">"**EP**"</span>),</span>
<span id="cb12-2852"><a href="#cb12-2852" aria-hidden="true" tabindex="-1"></a>             <span class="at">claim_count =</span> <span class="fu">md</span>(<span class="st">"**Claim count**"</span>),</span>
<span id="cb12-2853"><a href="#cb12-2853" aria-hidden="true" tabindex="-1"></a>             <span class="at">incurred_loss_and_lae =</span> <span class="fu">md</span>(<span class="st">"**Incurred loss + LAE**"</span>),</span>
<span id="cb12-2854"><a href="#cb12-2854" aria-hidden="true" tabindex="-1"></a>             <span class="at">loss_ratio =</span> <span class="fu">md</span>(<span class="st">"**LR**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2855"><a href="#cb12-2855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(n, earned_premium, incurred_loss_and_lae),</span>
<span id="cb12-2856"><a href="#cb12-2856" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2857"><a href="#cb12-2857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_percent</span>(<span class="at">columns =</span> loss_ratio,</span>
<span id="cb12-2858"><a href="#cb12-2858" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-2859"><a href="#cb12-2859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2860"><a href="#cb12-2860" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Unknowns ---- </span></span>
<span id="cb12-2861"><a href="#cb12-2861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2862"><a href="#cb12-2862" aria-hidden="true" tabindex="-1"></a><span class="co"># policy life data</span></span>
<span id="cb12-2863"><a href="#cb12-2863" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; some odd duplicate policy numbers, just removing them</span></span>
<span id="cb12-2864"><a href="#cb12-2864" aria-hidden="true" tabindex="-1"></a>data_policy_life_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"policy-life-analysis.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-2865"><a href="#cb12-2865" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2866"><a href="#cb12-2866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(policy_number, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-2867"><a href="#cb12-2867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2868"><a href="#cb12-2868" aria-hidden="true" tabindex="-1"></a><span class="co"># look into unknown roof types</span></span>
<span id="cb12-2869"><a href="#cb12-2869" aria-hidden="true" tabindex="-1"></a>data_unknown <span class="ot">&lt;-</span> data_premium_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2870"><a href="#cb12-2870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(roof_type) <span class="sc">|</span> roof_type <span class="sc">==</span> <span class="st">"Unknown"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2871"><a href="#cb12-2871" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">policy_prefix =</span> <span class="fu">str_sub</span>(policy_number, <span class="dv">1</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2872"><a href="#cb12-2872" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_policy_life_raw <span class="sc">%&gt;%</span> <span class="fu">select</span>(policy_number, <span class="fu">contains</span>(<span class="st">"date"</span>)), <span class="at">by =</span> <span class="fu">join_by</span>(policy_number))</span>
<span id="cb12-2873"><a href="#cb12-2873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2874"><a href="#cb12-2874" aria-hidden="true" tabindex="-1"></a><span class="co"># quick output to email screenshot</span></span>
<span id="cb12-2875"><a href="#cb12-2875" aria-hidden="true" tabindex="-1"></a>data_unknown <span class="sc">%&gt;%</span> <span class="fu">count</span>(roof_type, policy_prefix) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">count =</span> n) <span class="sc">%&gt;%</span> <span class="fu">write.csv</span>(<span class="at">file =</span> <span class="st">"data-unknown-summarized.csv"</span>)</span>
<span id="cb12-2876"><a href="#cb12-2876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2877"><a href="#cb12-2877" aria-hidden="true" tabindex="-1"></a><span class="co"># output policy numbers to send to David</span></span>
<span id="cb12-2878"><a href="#cb12-2878" aria-hidden="true" tabindex="-1"></a>data_unknown <span class="sc">%&gt;%</span> <span class="fu">select</span>(policy_number) <span class="sc">%&gt;%</span> <span class="fu">write.csv</span>(<span class="at">file =</span> <span class="st">"output/unknown-roof-policy-numbers.csv"</span>)</span>
<span id="cb12-2879"><a href="#cb12-2879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2880"><a href="#cb12-2880" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-2881"><a href="#cb12-2881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2882"><a href="#cb12-2882" aria-hidden="true" tabindex="-1"></a><span class="fu">### Restuarant audits analysis</span></span>
<span id="cb12-2883"><a href="#cb12-2883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2884"><a href="#cb12-2884" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/restaurant-audit-analysis.png)</span></span>
<span id="cb12-2885"><a href="#cb12-2885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2888"><a href="#cb12-2888" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-2889"><a href="#cb12-2889" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages and define functions ---- </span></span>
<span id="cb12-2890"><a href="#cb12-2890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2891"><a href="#cb12-2891" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb12-2892"><a href="#cb12-2892" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-2893"><a href="#cb12-2893" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-2894"><a href="#cb12-2894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2895"><a href="#cb12-2895" aria-hidden="true" tabindex="-1"></a><span class="co"># define functions</span></span>
<span id="cb12-2896"><a href="#cb12-2896" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%!in%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">Negate</span>(<span class="st">"%in%"</span>)</span>
<span id="cb12-2897"><a href="#cb12-2897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2898"><a href="#cb12-2898" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Read in and clean data ----</span></span>
<span id="cb12-2899"><a href="#cb12-2899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2900"><a href="#cb12-2900" aria-hidden="true" tabindex="-1"></a><span class="co"># read in restaurant audit data</span></span>
<span id="cb12-2901"><a href="#cb12-2901" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; recalculate calculated fields from spreadsheet</span></span>
<span id="cb12-2902"><a href="#cb12-2902" aria-hidden="true" tabindex="-1"></a>data_audits_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"Audit Review Spreadsheet with DTB Analysis 2025 05 16.xlsx"</span>, <span class="at">sheet =</span> <span class="dv">1</span>, <span class="at">skip =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2903"><a href="#cb12-2903" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2904"><a href="#cb12-2904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">date_audit =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2905"><a href="#cb12-2905" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(notes_short <span class="sc">%!in%</span> <span class="fu">c</span>(<span class="st">"Cancelled Pre Audit"</span>, <span class="st">"NR due to LQL sales"</span>, <span class="st">"NR pre audit"</span>, <span class="st">"NR Sales &gt; 6M"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2906"><a href="#cb12-2906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_chg_in_sales =</span> <span class="fu">round</span>(audited_sales <span class="sc">/</span> current_sales <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb12-2907"><a href="#cb12-2907" aria-hidden="true" tabindex="-1"></a>         <span class="at">increase_or_decrease =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-2908"><a href="#cb12-2908" aria-hidden="true" tabindex="-1"></a>           pct_chg_in_sales <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Dec"</span>,</span>
<span id="cb12-2909"><a href="#cb12-2909" aria-hidden="true" tabindex="-1"></a>           pct_chg_in_sales <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"No change"</span>,</span>
<span id="cb12-2910"><a href="#cb12-2910" aria-hidden="true" tabindex="-1"></a>           pct_chg_in_sales <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Inc"</span>,</span>
<span id="cb12-2911"><a href="#cb12-2911" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="cn">NA</span>),</span>
<span id="cb12-2912"><a href="#cb12-2912" aria-hidden="true" tabindex="-1"></a>         <span class="at">audited_alcohol_percent =</span> <span class="fu">round</span>(audited_alcohol_sales <span class="sc">/</span> audited_sales, <span class="dv">4</span>),</span>
<span id="cb12-2913"><a href="#cb12-2913" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_chg_in_premium =</span> <span class="fu">round</span>(revised_premium <span class="sc">/</span> current_premium <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">4</span>))</span>
<span id="cb12-2914"><a href="#cb12-2914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2915"><a href="#cb12-2915" aria-hidden="true" tabindex="-1"></a><span class="co"># read in inforce file</span></span>
<span id="cb12-2916"><a href="#cb12-2916" aria-hidden="true" tabindex="-1"></a>data_inforce <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"InForce_20250602.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2917"><a href="#cb12-2917" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-2918"><a href="#cb12-2918" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="st">"2025-06-02"</span>), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-2919"><a href="#cb12-2919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2920"><a href="#cb12-2920" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Calculate new variables ----</span></span>
<span id="cb12-2921"><a href="#cb12-2921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2922"><a href="#cb12-2922" aria-hidden="true" tabindex="-1"></a><span class="co"># check ranges of variables</span></span>
<span id="cb12-2923"><a href="#cb12-2923" aria-hidden="true" tabindex="-1"></a>data_audits <span class="sc">%&gt;%</span> </span>
<span id="cb12-2924"><a href="#cb12-2924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"pct_chg_in"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2925"><a href="#cb12-2925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(col) <span class="fu">summary</span>(col))</span>
<span id="cb12-2926"><a href="#cb12-2926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2927"><a href="#cb12-2927" aria-hidden="true" tabindex="-1"></a><span class="co"># add retention information to audit data and create bins for variables of interest</span></span>
<span id="cb12-2928"><a href="#cb12-2928" aria-hidden="true" tabindex="-1"></a>data_audits <span class="ot">&lt;-</span> data_audits_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-2929"><a href="#cb12-2929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_inforce <span class="sc">%&gt;%</span> <span class="fu">select</span>(policy_number, policy_effective_date), <span class="at">by =</span> <span class="fu">join_by</span>(policy_number)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2930"><a href="#cb12-2930" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(policy_effective_date, <span class="at">.after =</span> exp_date) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2931"><a href="#cb12-2931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">renewed =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-2932"><a href="#cb12-2932" aria-hidden="true" tabindex="-1"></a>      policy_effective_date <span class="sc">&gt;=</span> exp_date <span class="sc">~</span> <span class="st">"Yes"</span>,</span>
<span id="cb12-2933"><a href="#cb12-2933" aria-hidden="true" tabindex="-1"></a>      policy_effective_date <span class="sc">&lt;</span> exp_date <span class="sc">~</span> <span class="st">"TBD"</span>,</span>
<span id="cb12-2934"><a href="#cb12-2934" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="st">"No"</span></span>
<span id="cb12-2935"><a href="#cb12-2935" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb12-2936"><a href="#cb12-2936" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_chg_in_sales_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-2937"><a href="#cb12-2937" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(audited_sales) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb12-2938"><a href="#cb12-2938" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">~</span> <span class="st">"&lt;-80%"</span>,</span>
<span id="cb12-2939"><a href="#cb12-2939" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">~</span> <span class="st">"[-80%,-60%)"</span>,</span>
<span id="cb12-2940"><a href="#cb12-2940" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.4</span> <span class="sc">~</span> <span class="st">"[-60%,-40%)"</span>,</span>
<span id="cb12-2941"><a href="#cb12-2941" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">~</span> <span class="st">"[-40%,-20%)"</span>,</span>
<span id="cb12-2942"><a href="#cb12-2942" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"[-20%,0%)"</span>,</span>
<span id="cb12-2943"><a href="#cb12-2943" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"0%"</span>,</span>
<span id="cb12-2944"><a href="#cb12-2944" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="fl">0.2</span> <span class="sc">~</span> <span class="st">"(0%,20%)"</span>,</span>
<span id="cb12-2945"><a href="#cb12-2945" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">~</span> <span class="st">"20%"</span>,</span>
<span id="cb12-2946"><a href="#cb12-2946" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="fl">0.4</span> <span class="sc">~</span> <span class="st">"(20%,40%)"</span>,</span>
<span id="cb12-2947"><a href="#cb12-2947" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="fl">0.6</span> <span class="sc">~</span> <span class="st">"[40%,60%)"</span>,</span>
<span id="cb12-2948"><a href="#cb12-2948" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="fl">0.8</span> <span class="sc">~</span> <span class="st">"[60%,80%)"</span>,</span>
<span id="cb12-2949"><a href="#cb12-2949" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="fl">1.0</span> <span class="sc">~</span> <span class="st">"[80%,100%)"</span>,</span>
<span id="cb12-2950"><a href="#cb12-2950" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&lt;</span> <span class="fl">2.0</span> <span class="sc">~</span> <span class="st">"[100%,200%)"</span>,</span>
<span id="cb12-2951"><a href="#cb12-2951" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_sales <span class="sc">&gt;=</span> <span class="fl">2.0</span> <span class="sc">~</span> <span class="st">"&gt;=200%"</span></span>
<span id="cb12-2952"><a href="#cb12-2952" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">ordered</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"&lt;-80%"</span>,<span class="st">"[-80%,-60%)"</span>,<span class="st">"[-60%,-40%)"</span>,<span class="st">"[-40%,-20%)"</span>,<span class="st">"[-20%,0%)"</span>,<span class="st">"0%"</span>,<span class="st">"(0%,20%)"</span>,<span class="st">"20%"</span>,<span class="st">"(20%,40%)"</span>,<span class="st">"[40%,60%)"</span>,<span class="st">"[60%,80%)"</span>,<span class="st">"[80%,100%)"</span>,<span class="st">"[100%,200%)"</span>,<span class="st">"&gt;=200%"</span>)),</span>
<span id="cb12-2953"><a href="#cb12-2953" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_chg_in_premium_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-2954"><a href="#cb12-2954" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(revised_premium) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb12-2955"><a href="#cb12-2955" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.8</span> <span class="sc">~</span> <span class="st">"&lt;-80%"</span>,</span>
<span id="cb12-2956"><a href="#cb12-2956" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.6</span> <span class="sc">~</span> <span class="st">"[-80%,-60%)"</span>,</span>
<span id="cb12-2957"><a href="#cb12-2957" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.4</span> <span class="sc">~</span> <span class="st">"[-60%,-40%)"</span>,</span>
<span id="cb12-2958"><a href="#cb12-2958" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">~</span> <span class="st">"[-40%,-20%)"</span>,</span>
<span id="cb12-2959"><a href="#cb12-2959" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"[-20%,0%)"</span>,</span>
<span id="cb12-2960"><a href="#cb12-2960" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"0%"</span>,</span>
<span id="cb12-2961"><a href="#cb12-2961" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="fl">0.2</span> <span class="sc">~</span> <span class="st">"(0%,20%)"</span>,</span>
<span id="cb12-2962"><a href="#cb12-2962" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="fl">0.4</span> <span class="sc">~</span> <span class="st">"[20%,40%)"</span>,</span>
<span id="cb12-2963"><a href="#cb12-2963" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="fl">0.6</span> <span class="sc">~</span> <span class="st">"[40%,60%)"</span>,</span>
<span id="cb12-2964"><a href="#cb12-2964" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="fl">0.8</span> <span class="sc">~</span> <span class="st">"[60%,80%)"</span>,</span>
<span id="cb12-2965"><a href="#cb12-2965" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="fl">1.0</span> <span class="sc">~</span> <span class="st">"[80%,100%)"</span>,</span>
<span id="cb12-2966"><a href="#cb12-2966" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&lt;</span> <span class="fl">2.0</span> <span class="sc">~</span> <span class="st">"[100%,200%)"</span>,</span>
<span id="cb12-2967"><a href="#cb12-2967" aria-hidden="true" tabindex="-1"></a>      pct_chg_in_premium <span class="sc">&gt;=</span> <span class="fl">2.0</span> <span class="sc">~</span> <span class="st">"&gt;=200%"</span>,</span>
<span id="cb12-2968"><a href="#cb12-2968" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb12-2969"><a href="#cb12-2969" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">ordered</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"&lt;-80%"</span>,<span class="st">"[-80%,-60%)"</span>,<span class="st">"[-60%,-40%)"</span>,<span class="st">"[-40%,-20%)"</span>,<span class="st">"[-20%,0%)"</span>,<span class="st">"0%"</span>,<span class="st">"(0%,20%)"</span>,<span class="st">"[20%,40%)"</span>,<span class="st">"[40%,60%)"</span>,<span class="st">"[60%,80%)"</span>,<span class="st">"[80%,100%)"</span>,<span class="st">"[100%,200%)"</span>,<span class="st">"&gt;=200%"</span>))</span>
<span id="cb12-2970"><a href="#cb12-2970" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2971"><a href="#cb12-2971" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(renewed, <span class="at">.after =</span> policy_number) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2972"><a href="#cb12-2972" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(pct_chg_in_sales_group, <span class="at">.after =</span> pct_chg_in_sales) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2973"><a href="#cb12-2973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(pct_chg_in_premium_group, <span class="at">.after =</span> pct_chg_in_premium) </span>
<span id="cb12-2974"><a href="#cb12-2974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2975"><a href="#cb12-2975" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Analyze ----</span></span>
<span id="cb12-2976"><a href="#cb12-2976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2977"><a href="#cb12-2977" aria-hidden="true" tabindex="-1"></a><span class="co"># create exhibit tables</span></span>
<span id="cb12-2978"><a href="#cb12-2978" aria-hidden="true" tabindex="-1"></a>data_audits <span class="sc">%&gt;%</span> </span>
<span id="cb12-2979"><a href="#cb12-2979" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(pct_chg_in_sales_group, renewed) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2980"><a href="#cb12-2980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> renewed, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2981"><a href="#cb12-2981" aria-hidden="true" tabindex="-1"></a>  rowwise <span class="sc">%&gt;%</span> </span>
<span id="cb12-2982"><a href="#cb12-2982" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">No_percent =</span> No <span class="sc">/</span> (No <span class="sc">+</span> Yes <span class="sc">+</span> TBD),</span>
<span id="cb12-2983"><a href="#cb12-2983" aria-hidden="true" tabindex="-1"></a>         <span class="at">Yes_percent =</span> Yes <span class="sc">/</span> (No <span class="sc">+</span> Yes <span class="sc">+</span> TBD),</span>
<span id="cb12-2984"><a href="#cb12-2984" aria-hidden="true" tabindex="-1"></a>         <span class="at">TBD_percent =</span> TBD <span class="sc">/</span> (No <span class="sc">+</span> Yes <span class="sc">+</span> TBD)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2985"><a href="#cb12-2985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pct_chg_in_sales_group, <span class="fu">starts_with</span>(<span class="st">"No"</span>), <span class="fu">starts_with</span>(<span class="st">"Yes"</span>), <span class="fu">starts_with</span>(<span class="st">"TBD"</span>))</span>
<span id="cb12-2986"><a href="#cb12-2986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2987"><a href="#cb12-2987" aria-hidden="true" tabindex="-1"></a>data_audits <span class="sc">%&gt;%</span> </span>
<span id="cb12-2988"><a href="#cb12-2988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(pct_chg_in_premium_group, renewed) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2989"><a href="#cb12-2989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> renewed, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2990"><a href="#cb12-2990" aria-hidden="true" tabindex="-1"></a>  rowwise <span class="sc">%&gt;%</span> </span>
<span id="cb12-2991"><a href="#cb12-2991" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">No_percent =</span> No <span class="sc">/</span> (No <span class="sc">+</span> Yes <span class="sc">+</span> TBD),</span>
<span id="cb12-2992"><a href="#cb12-2992" aria-hidden="true" tabindex="-1"></a>         <span class="at">Yes_percent =</span> Yes <span class="sc">/</span> (No <span class="sc">+</span> Yes <span class="sc">+</span> TBD),</span>
<span id="cb12-2993"><a href="#cb12-2993" aria-hidden="true" tabindex="-1"></a>         <span class="at">TBD_percent =</span> TBD <span class="sc">/</span> (No <span class="sc">+</span> Yes <span class="sc">+</span> TBD)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2994"><a href="#cb12-2994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pct_chg_in_premium_group, <span class="fu">starts_with</span>(<span class="st">"No"</span>), <span class="fu">starts_with</span>(<span class="st">"Yes"</span>), <span class="fu">starts_with</span>(<span class="st">"TBD"</span>))</span>
<span id="cb12-2995"><a href="#cb12-2995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2996"><a href="#cb12-2996" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-2997"><a href="#cb12-2997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2998"><a href="#cb12-2998" aria-hidden="true" tabindex="-1"></a><span class="fu">### Indications</span></span>
<span id="cb12-2999"><a href="#cb12-2999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3000"><a href="#cb12-3000" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/indication.png)</span></span>
<span id="cb12-3001"><a href="#cb12-3001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3002"><a href="#cb12-3002" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/indication-2.png)</span></span>
<span id="cb12-3003"><a href="#cb12-3003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3006"><a href="#cb12-3006" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-3007"><a href="#cb12-3007" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages and define functions ----</span></span>
<span id="cb12-3008"><a href="#cb12-3008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3009"><a href="#cb12-3009" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb12-3010"><a href="#cb12-3010" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-3011"><a href="#cb12-3011" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-3012"><a href="#cb12-3012" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb12-3013"><a href="#cb12-3013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3014"><a href="#cb12-3014" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%!in%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">Negate</span>(<span class="st">"%in%"</span>)</span>
<span id="cb12-3015"><a href="#cb12-3015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3016"><a href="#cb12-3016" aria-hidden="true" tabindex="-1"></a><span class="co"># function to format long data as triangle</span></span>
<span id="cb12-3017"><a href="#cb12-3017" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span id="cb12-3018"><a href="#cb12-3018" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; n_periods = 28 --&gt; 7 years of data for triangle</span></span>
<span id="cb12-3019"><a href="#cb12-3019" aria-hidden="true" tabindex="-1"></a>format_bases_as_triangle <span class="ot">&lt;-</span> <span class="cf">function</span>(df_agg_age, var, <span class="at">ult_age =</span> <span class="dv">63</span>, <span class="at">n_periods =</span> <span class="dv">28</span>) {</span>
<span id="cb12-3020"><a href="#cb12-3020" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3021"><a href="#cb12-3021" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">=</span> <span class="fu">enquo</span>(var)</span>
<span id="cb12-3022"><a href="#cb12-3022" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb12-3023"><a href="#cb12-3023" aria-hidden="true" tabindex="-1"></a>  df_agg_age <span class="sc">%&lt;&gt;%</span>  </span>
<span id="cb12-3024"><a href="#cb12-3024" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&lt;=</span> ult_age) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3025"><a href="#cb12-3025" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">!!</span>var) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3026"><a href="#cb12-3026" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> age,</span>
<span id="cb12-3027"><a href="#cb12-3027" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> <span class="sc">!!</span>var) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3028"><a href="#cb12-3028" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(loss_year, <span class="st">"-Q"</span>, loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3029"><a href="#cb12-3029" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(accident_quarter, <span class="fu">as.character</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">3</span>, <span class="at">to =</span> ult_age, <span class="at">by =</span> <span class="dv">3</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3030"><a href="#cb12-3030" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_tail</span>(<span class="at">n =</span> n_periods) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3031"><a href="#cb12-3031" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-3032"><a href="#cb12-3032" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3033"><a href="#cb12-3033" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3034"><a href="#cb12-3034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3035"><a href="#cb12-3035" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate development factors</span></span>
<span id="cb12-3036"><a href="#cb12-3036" aria-hidden="true" tabindex="-1"></a>calculate_dev_factors <span class="ot">&lt;-</span> <span class="cf">function</span>(df_agg_age, var) {</span>
<span id="cb12-3037"><a href="#cb12-3037" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3038"><a href="#cb12-3038" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">=</span> <span class="fu">enquo</span>(var)</span>
<span id="cb12-3039"><a href="#cb12-3039" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3040"><a href="#cb12-3040" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reduce input data to only needed columns</span></span>
<span id="cb12-3041"><a href="#cb12-3041" aria-hidden="true" tabindex="-1"></a>  df_agg_age <span class="sc">%&lt;&gt;%</span> <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">!!</span>var)</span>
<span id="cb12-3042"><a href="#cb12-3042" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3043"><a href="#cb12-3043" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup output dataframe</span></span>
<span id="cb12-3044"><a href="#cb12-3044" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb12-3045"><a href="#cb12-3045" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="fu">ncol</span>(df_agg_age) <span class="sc">+</span> <span class="dv">1</span>,                  </span>
<span id="cb12-3046"><a href="#cb12-3046" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> <span class="fu">nrow</span>(df_agg_age <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="co"># taking ratios, so one row less</span></span>
<span id="cb12-3047"><a href="#cb12-3047" aria-hidden="true" tabindex="-1"></a>    data.frame</span>
<span id="cb12-3048"><a href="#cb12-3048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_dev) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"loss_year"</span>,<span class="st">"loss_qtr"</span>, <span class="st">"left"</span>, <span class="st">"right"</span>, <span class="st">"dev_factor"</span>)</span>
<span id="cb12-3049"><a href="#cb12-3049" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3050"><a href="#cb12-3050" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate development factors</span></span>
<span id="cb12-3051"><a href="#cb12-3051" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_agg_age)<span class="sc">-</span><span class="dv">1</span>) {</span>
<span id="cb12-3052"><a href="#cb12-3052" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3053"><a href="#cb12-3053" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set constants</span></span>
<span id="cb12-3054"><a href="#cb12-3054" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">=</span> df_agg_age[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb12-3055"><a href="#cb12-3055" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3056"><a href="#cb12-3056" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set ratio column indicators</span></span>
<span id="cb12-3057"><a href="#cb12-3057" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">3</span>] <span class="ot">=</span> df_agg_age[i<span class="sc">+</span><span class="dv">1</span>,<span class="dv">3</span>]</span>
<span id="cb12-3058"><a href="#cb12-3058" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">4</span>] <span class="ot">=</span> df_agg_age[i,<span class="dv">3</span>]</span>
<span id="cb12-3059"><a href="#cb12-3059" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3060"><a href="#cb12-3060" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate factor</span></span>
<span id="cb12-3061"><a href="#cb12-3061" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">5</span>] <span class="ot">=</span> <span class="fu">ifelse</span>(df_agg_age[i,<span class="dv">4</span>] <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb12-3062"><a href="#cb12-3062" aria-hidden="true" tabindex="-1"></a>                         <span class="cn">NA</span>,</span>
<span id="cb12-3063"><a href="#cb12-3063" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">as.numeric</span>(df_agg_age[i<span class="sc">+</span><span class="dv">1</span>,<span class="dv">4</span>]) <span class="sc">/</span> <span class="fu">as.numeric</span>(df_agg_age[i,<span class="dv">4</span>]))</span>
<span id="cb12-3064"><a href="#cb12-3064" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3065"><a href="#cb12-3065" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-3066"><a href="#cb12-3066" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3067"><a href="#cb12-3067" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove unwanted comparisons and format ratio indicator</span></span>
<span id="cb12-3068"><a href="#cb12-3068" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3069"><a href="#cb12-3069" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(left <span class="sc">&gt;</span> right) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3070"><a href="#cb12-3070" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age_age =</span> <span class="fu">paste0</span>(left, <span class="st">":"</span>, right),</span>
<span id="cb12-3071"><a href="#cb12-3071" aria-hidden="true" tabindex="-1"></a>           <span class="at">.after =</span> <span class="dv">2</span>)</span>
<span id="cb12-3072"><a href="#cb12-3072" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3073"><a href="#cb12-3073" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="sc">%&gt;%</span> return</span>
<span id="cb12-3074"><a href="#cb12-3074" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3075"><a href="#cb12-3075" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3076"><a href="#cb12-3076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3077"><a href="#cb12-3077" aria-hidden="true" tabindex="-1"></a><span class="co"># function to format loss development factors as triangle</span></span>
<span id="cb12-3078"><a href="#cb12-3078" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span id="cb12-3079"><a href="#cb12-3079" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; n_periods = 27 --&gt; 7 years of data for triangle</span></span>
<span id="cb12-3080"><a href="#cb12-3080" aria-hidden="true" tabindex="-1"></a>format_dev_factors_as_triangle <span class="ot">&lt;-</span> <span class="cf">function</span>(df_dev, <span class="at">ult_age =</span> <span class="dv">63</span>, <span class="at">n_periods =</span> <span class="dv">27</span>) {</span>
<span id="cb12-3081"><a href="#cb12-3081" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3082"><a href="#cb12-3082" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="sc">%&gt;%</span> </span>
<span id="cb12-3083"><a href="#cb12-3083" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(left <span class="sc">&lt;=</span> ult_age) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3084"><a href="#cb12-3084" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(left, right)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3085"><a href="#cb12-3085" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> age_age,</span>
<span id="cb12-3086"><a href="#cb12-3086" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> dev_factor) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3087"><a href="#cb12-3087" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(loss_year, <span class="st">"-Q"</span>, loss_qtr),</span>
<span id="cb12-3088"><a href="#cb12-3088" aria-hidden="true" tabindex="-1"></a>           <span class="st">"Ult:{{ult_age}}"</span> <span class="sc">:</span><span class="er">=</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3089"><a href="#cb12-3089" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(accident_quarter, <span class="fu">as.character</span>(<span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">6</span>, <span class="at">to =</span> ult_age, <span class="at">by =</span> <span class="dv">3</span>),<span class="st">":"</span>, <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">3</span>, <span class="at">to =</span> ult_age<span class="dv">-3</span>, <span class="at">by =</span> <span class="dv">3</span>))), <span class="fu">paste0</span>(<span class="st">"Ult:"</span>, ult_age)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3090"><a href="#cb12-3090" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_tail</span>(<span class="at">n =</span> n_periods) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3091"><a href="#cb12-3091" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-3092"><a href="#cb12-3092" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3093"><a href="#cb12-3093" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3094"><a href="#cb12-3094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3095"><a href="#cb12-3095" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate weighted development factors</span></span>
<span id="cb12-3096"><a href="#cb12-3096" aria-hidden="true" tabindex="-1"></a>calculate_weighted_dev_factors <span class="ot">&lt;-</span> <span class="cf">function</span>(df_loss_tri, selects, <span class="at">ult_age =</span> <span class="dv">63</span>) {</span>
<span id="cb12-3097"><a href="#cb12-3097" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3098"><a href="#cb12-3098" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup output dataframe</span></span>
<span id="cb12-3099"><a href="#cb12-3099" aria-hidden="true" tabindex="-1"></a>  df_weights <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb12-3100"><a href="#cb12-3100" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ncol =</span> <span class="fu">ncol</span>(df_loss_tri),                  </span>
<span id="cb12-3101"><a href="#cb12-3101" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3102"><a href="#cb12-3102" aria-hidden="true" tabindex="-1"></a>    data.frame</span>
<span id="cb12-3103"><a href="#cb12-3103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_weights) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">6</span>, <span class="at">to =</span> ult_age, <span class="at">by =</span> <span class="dv">3</span>),<span class="st">":"</span>, <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">3</span>, <span class="at">to =</span> ult_age<span class="dv">-3</span>, <span class="at">by =</span> <span class="dv">3</span>)), <span class="fu">paste0</span>(<span class="st">"Ult:"</span>, ult_age))</span>
<span id="cb12-3104"><a href="#cb12-3104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3105"><a href="#cb12-3105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set constants</span></span>
<span id="cb12-3106"><a href="#cb12-3106" aria-hidden="true" tabindex="-1"></a>  df_weights<span class="sc">$</span>id <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">8</span>, <span class="at">to =</span> <span class="dv">16</span>, <span class="at">by =</span> <span class="dv">4</span>), <span class="st">" pts wtd"</span>)</span>
<span id="cb12-3107"><a href="#cb12-3107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3108"><a href="#cb12-3108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculated weighted development factors</span></span>
<span id="cb12-3109"><a href="#cb12-3109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_weights)) {</span>
<span id="cb12-3110"><a href="#cb12-3110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3111"><a href="#cb12-3111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set number of periods to look back (i.e. weight)</span></span>
<span id="cb12-3112"><a href="#cb12-3112" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">=</span> df_weights[i,<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(., <span class="dv">1</span>, <span class="fu">str_locate</span>(., <span class="st">" pts"</span>)[<span class="dv">1</span>]<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb12-3113"><a href="#cb12-3113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3114"><a href="#cb12-3114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(df_weights)<span class="sc">-</span><span class="dv">1</span>)) {</span>
<span id="cb12-3115"><a href="#cb12-3115" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3116"><a href="#cb12-3116" aria-hidden="true" tabindex="-1"></a>      <span class="co"># figure out number of periods with data in triangle for the larger age</span></span>
<span id="cb12-3117"><a href="#cb12-3117" aria-hidden="true" tabindex="-1"></a>      data_count <span class="ot">=</span> <span class="fu">nrow</span>(df_loss_tri) <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(df_loss_tri[,j<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb12-3118"><a href="#cb12-3118" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3119"><a href="#cb12-3119" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate X-pts weighted ratio</span></span>
<span id="cb12-3120"><a href="#cb12-3120" aria-hidden="true" tabindex="-1"></a>      df_weights[i,j] <span class="ot">=</span> df_loss_tri <span class="sc">%&gt;%</span> </span>
<span id="cb12-3121"><a href="#cb12-3121" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3122"><a href="#cb12-3122" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">between</span>(row_num, data_count <span class="sc">-</span> weight <span class="sc">+</span> <span class="dv">1</span>, data_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3123"><a href="#cb12-3123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="dv">1</span>, j, j<span class="sc">+</span><span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3124"><a href="#cb12-3124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">col_j =</span> <span class="dv">2</span>, <span class="at">col_j_minus_1 =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3125"><a href="#cb12-3125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(<span class="fu">sum</span>(col_j_minus_1) <span class="sc">/</span> <span class="fu">sum</span>(col_j))</span>
<span id="cb12-3126"><a href="#cb12-3126" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3127"><a href="#cb12-3127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-3128"><a href="#cb12-3128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3129"><a href="#cb12-3129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-3130"><a href="#cb12-3130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3131"><a href="#cb12-3131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create dataframe of selects for each age:age</span></span>
<span id="cb12-3132"><a href="#cb12-3132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; need to organize so can correctly calculate in next step</span></span>
<span id="cb12-3133"><a href="#cb12-3133" aria-hidden="true" tabindex="-1"></a>  df_selects <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">age_age =</span> <span class="fu">colnames</span>(df_weights)[<span class="sc">-</span><span class="dv">1</span>], <span class="at">selected =</span> selects) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3134"><a href="#cb12-3134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3135"><a href="#cb12-3135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(row_num))</span>
<span id="cb12-3136"><a href="#cb12-3136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3137"><a href="#cb12-3137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate cumulative selects "backwards"</span></span>
<span id="cb12-3138"><a href="#cb12-3138" aria-hidden="true" tabindex="-1"></a>  selects_cumulative <span class="ot">=</span> df_selects<span class="sc">$</span>selected <span class="sc">%&gt;%</span> cumprod</span>
<span id="cb12-3139"><a href="#cb12-3139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3140"><a href="#cb12-3140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append calculated factors and reorganize</span></span>
<span id="cb12-3141"><a href="#cb12-3141" aria-hidden="true" tabindex="-1"></a>  df_selects <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3142"><a href="#cb12-3142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">selects =</span> <span class="fu">data.frame</span>(<span class="at">cumulative =</span> selects_cumulative)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3143"><a href="#cb12-3143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(row_num) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3144"><a href="#cb12-3144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>row_num) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3145"><a href="#cb12-3145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3146"><a href="#cb12-3146" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span> </span>
<span id="cb12-3147"><a href="#cb12-3147" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb12-3148"><a href="#cb12-3148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>()</span>
<span id="cb12-3149"><a href="#cb12-3149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_selects) <span class="ot">=</span> <span class="fu">colnames</span>(df_weights)</span>
<span id="cb12-3150"><a href="#cb12-3150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3151"><a href="#cb12-3151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine dataframes</span></span>
<span id="cb12-3152"><a href="#cb12-3152" aria-hidden="true" tabindex="-1"></a>  df_weights <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3153"><a href="#cb12-3153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(df_selects)</span>
<span id="cb12-3154"><a href="#cb12-3154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3155"><a href="#cb12-3155" aria-hidden="true" tabindex="-1"></a>  df_weights <span class="sc">%&gt;%</span> return</span>
<span id="cb12-3156"><a href="#cb12-3156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3157"><a href="#cb12-3157" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3158"><a href="#cb12-3158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3159"><a href="#cb12-3159" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate ultimate incurred</span></span>
<span id="cb12-3160"><a href="#cb12-3160" aria-hidden="true" tabindex="-1"></a>calculate_ultimate_incurred <span class="ot">&lt;-</span> <span class="cf">function</span>(df_agg, df_selects, var) {</span>
<span id="cb12-3161"><a href="#cb12-3161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3162"><a href="#cb12-3162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract cumulative select factors</span></span>
<span id="cb12-3163"><a href="#cb12-3163" aria-hidden="true" tabindex="-1"></a>  cumlative_selects <span class="ot">=</span> df_selects <span class="sc">%&gt;%</span> </span>
<span id="cb12-3164"><a href="#cb12-3164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> <span class="st">"cumulative"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3165"><a href="#cb12-3165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3166"><a href="#cb12-3166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb12-3167"><a href="#cb12-3167" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"age_age"</span>,</span>
<span id="cb12-3168"><a href="#cb12-3168" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"cumulative_factor"</span>)</span>
<span id="cb12-3169"><a href="#cb12-3169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3170"><a href="#cb12-3170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorganize summary table for appending cumulative selects</span></span>
<span id="cb12-3171"><a href="#cb12-3171" aria-hidden="true" tabindex="-1"></a>  df_agg <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3172"><a href="#cb12-3172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(state, <span class="fu">desc</span>(loss_year), <span class="fu">desc</span>(loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3173"><a href="#cb12-3173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(state, loss_year, loss_qtr, <span class="fu">any_of</span>(var))</span>
<span id="cb12-3174"><a href="#cb12-3174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3175"><a href="#cb12-3175" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append cumulative selects, organize data, and calculate new column</span></span>
<span id="cb12-3176"><a href="#cb12-3176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; fill rest of values with NA</span></span>
<span id="cb12-3177"><a href="#cb12-3177" aria-hidden="true" tabindex="-1"></a>  df_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3178"><a href="#cb12-3178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3179"><a href="#cb12-3179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3180"><a href="#cb12-3180" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3181"><a href="#cb12-3181" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> \(data) {</span>
<span id="cb12-3182"><a href="#cb12-3182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-3183"><a href="#cb12-3183" aria-hidden="true" tabindex="-1"></a>        data<span class="sc">$</span>factor <span class="ot">&lt;-</span> <span class="fu">c</span>(cumlative_selects<span class="sc">$</span>cumulative_factor, <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(data) <span class="sc">-</span> <span class="fu">nrow</span>(cumlative_selects)))</span>
<span id="cb12-3184"><a href="#cb12-3184" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-3185"><a href="#cb12-3185" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&gt;%</span> return</span>
<span id="cb12-3186"><a href="#cb12-3186" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-3187"><a href="#cb12-3187" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb12-3188"><a href="#cb12-3188" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3189"><a href="#cb12-3189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3190"><a href="#cb12-3190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(state, loss_year, loss_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3191"><a href="#cb12-3191" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(factor)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3192"><a href="#cb12-3192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(loss_year, <span class="st">"-Q"</span>, loss_qtr),</span>
<span id="cb12-3193"><a href="#cb12-3193" aria-hidden="true" tabindex="-1"></a>           <span class="at">ult_incurred =</span> <span class="sc">!!</span><span class="fu">sym</span>(var) <span class="sc">*</span> factor) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3194"><a href="#cb12-3194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(state, accident_quarter, <span class="at">incurred =</span> <span class="fu">any_of</span>(var), factor, ult_incurred) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3195"><a href="#cb12-3195" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-3196"><a href="#cb12-3196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3197"><a href="#cb12-3197" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3198"><a href="#cb12-3198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3199"><a href="#cb12-3199" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by fiscal year</span></span>
<span id="cb12-3200"><a href="#cb12-3200" aria-hidden="true" tabindex="-1"></a>summarize_by_fiscal_year <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb12-3201"><a href="#cb12-3201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3202"><a href="#cb12-3202" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3203"><a href="#cb12-3203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">var1 =</span> <span class="dv">3</span>, <span class="at">factor =</span> <span class="dv">4</span>, <span class="at">var2 =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="co"># standardize names</span></span>
<span id="cb12-3204"><a href="#cb12-3204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3205"><a href="#cb12-3205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3206"><a href="#cb12-3206" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3207"><a href="#cb12-3207" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> \(data) {</span>
<span id="cb12-3208"><a href="#cb12-3208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3209"><a href="#cb12-3209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># drop most recent period, calculate rolling sum by fiscal year, calculate factor, and organize</span></span>
<span id="cb12-3210"><a href="#cb12-3210" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3211"><a href="#cb12-3211" aria-hidden="true" tabindex="-1"></a>          <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3212"><a href="#cb12-3212" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">var1_cumulative =</span> roll<span class="sc">::</span><span class="fu">roll_sum</span>(var1, <span class="at">width =</span> <span class="dv">4</span>),</span>
<span id="cb12-3213"><a href="#cb12-3213" aria-hidden="true" tabindex="-1"></a>                 <span class="at">var2_cumulative =</span> roll<span class="sc">::</span><span class="fu">roll_sum</span>(var2, <span class="at">width =</span> <span class="dv">4</span>),</span>
<span id="cb12-3214"><a href="#cb12-3214" aria-hidden="true" tabindex="-1"></a>                 <span class="at">factor =</span> <span class="fu">ifelse</span>(var1_cumulative <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, var2_cumulative <span class="sc">/</span> var1_cumulative),</span>
<span id="cb12-3215"><a href="#cb12-3215" aria-hidden="true" tabindex="-1"></a>                 <span class="at">quarter =</span> <span class="fu">str_sub</span>(accident_quarter, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb12-3216"><a href="#cb12-3216" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-3217"><a href="#cb12-3217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get most recent quarter to work from</span></span>
<span id="cb12-3218"><a href="#cb12-3218" aria-hidden="true" tabindex="-1"></a>        ref_qtr <span class="ot">=</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb12-3219"><a href="#cb12-3219" aria-hidden="true" tabindex="-1"></a>          <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3220"><a href="#cb12-3220" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(quarter) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3221"><a href="#cb12-3221" aria-hidden="true" tabindex="-1"></a>          as.numeric</span>
<span id="cb12-3222"><a href="#cb12-3222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-3223"><a href="#cb12-3223" aria-hidden="true" tabindex="-1"></a>        <span class="co"># keep only relevant periods</span></span>
<span id="cb12-3224"><a href="#cb12-3224" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&gt;%</span> </span>
<span id="cb12-3225"><a href="#cb12-3225" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(quarter <span class="sc">==</span> ref_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3226"><a href="#cb12-3226" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(<span class="at">fiscal_year_ended =</span> accident_quarter, var1_cumulative, factor, var2_cumulative) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3227"><a href="#cb12-3227" aria-hidden="true" tabindex="-1"></a>          return</span>
<span id="cb12-3228"><a href="#cb12-3228" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3229"><a href="#cb12-3229" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb12-3230"><a href="#cb12-3230" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-3231"><a href="#cb12-3231" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3232"><a href="#cb12-3232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set NAs to Countrywide values</span></span>
<span id="cb12-3233"><a href="#cb12-3233" aria-hidden="true" tabindex="-1"></a>  df_cw <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb12-3234"><a href="#cb12-3234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3235"><a href="#cb12-3235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3236"><a href="#cb12-3236" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fiscal_year_ended, factor)</span>
<span id="cb12-3237"><a href="#cb12-3237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3238"><a href="#cb12-3238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use Countrywide values if NA for state factors and organize data</span></span>
<span id="cb12-3239"><a href="#cb12-3239" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb12-3240"><a href="#cb12-3240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3241"><a href="#cb12-3241" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3242"><a href="#cb12-3242" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> \(data, df_cw) {</span>
<span id="cb12-3243"><a href="#cb12-3243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3244"><a href="#cb12-3244" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&gt;%</span> </span>
<span id="cb12-3245"><a href="#cb12-3245" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(df_cw,</span>
<span id="cb12-3246"><a href="#cb12-3246" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="fu">join_by</span>(fiscal_year_ended),</span>
<span id="cb12-3247"><a href="#cb12-3247" aria-hidden="true" tabindex="-1"></a>                    <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_st"</span>, <span class="st">"_cw"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3248"><a href="#cb12-3248" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">factor =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(factor_st), factor_cw, factor_st)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3249"><a href="#cb12-3249" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(fiscal_year_ended, var1_cumulative, factor, var2_cumulative)</span>
<span id="cb12-3250"><a href="#cb12-3250" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-3251"><a href="#cb12-3251" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb12-3252"><a href="#cb12-3252" aria-hidden="true" tabindex="-1"></a>      df_cw)</span>
<span id="cb12-3253"><a href="#cb12-3253" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3254"><a href="#cb12-3254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3255"><a href="#cb12-3255" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-3256"><a href="#cb12-3256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3257"><a href="#cb12-3257" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3258"><a href="#cb12-3258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3259"><a href="#cb12-3259" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate the final step of the trending (x is a vector of two fits)</span></span>
<span id="cb12-3260"><a href="#cb12-3260" aria-hidden="true" tabindex="-1"></a>calculate_final_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-3261"><a href="#cb12-3261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3262"><a href="#cb12-3262" aria-hidden="true" tabindex="-1"></a>  x[<span class="dv">2</span>] <span class="sc">/</span> x[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-3263"><a href="#cb12-3263" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3264"><a href="#cb12-3264" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3265"><a href="#cb12-3265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3266"><a href="#cb12-3266" aria-hidden="true" tabindex="-1"></a><span class="co"># function calculated weighted fits</span></span>
<span id="cb12-3267"><a href="#cb12-3267" aria-hidden="true" tabindex="-1"></a>calculate_weighted_fits <span class="ot">&lt;-</span> <span class="cf">function</span>(df_calendar, var) {</span>
<span id="cb12-3268"><a href="#cb12-3268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3269"><a href="#cb12-3269" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize needed items</span></span>
<span id="cb12-3270"><a href="#cb12-3270" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">8</span>, <span class="at">to =</span> <span class="dv">24</span>, <span class="at">by =</span> <span class="dv">4</span>)</span>
<span id="cb12-3271"><a href="#cb12-3271" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(pts))</span>
<span id="cb12-3272"><a href="#cb12-3272" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb12-3273"><a href="#cb12-3273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3274"><a href="#cb12-3274" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop through different weights (fits)</span></span>
<span id="cb12-3275"><a href="#cb12-3275" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x <span class="cf">in</span> pts) {</span>
<span id="cb12-3276"><a href="#cb12-3276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3277"><a href="#cb12-3277" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reassign full dataset</span></span>
<span id="cb12-3278"><a href="#cb12-3278" aria-hidden="true" tabindex="-1"></a>    df_temp <span class="ot">=</span> df_calendar</span>
<span id="cb12-3279"><a href="#cb12-3279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3280"><a href="#cb12-3280" aria-hidden="true" tabindex="-1"></a>    <span class="co"># limit dataset and calculate fit</span></span>
<span id="cb12-3281"><a href="#cb12-3281" aria-hidden="true" tabindex="-1"></a>    df_temp <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3282"><a href="#cb12-3282" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">24</span>) <span class="sc">%&gt;%</span> <span class="co"># skip periods where cumulative sum isn't full</span></span>
<span id="cb12-3283"><a href="#cb12-3283" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> <span class="co"># set Xs</span></span>
<span id="cb12-3284"><a href="#cb12-3284" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> x)</span>
<span id="cb12-3285"><a href="#cb12-3285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3286"><a href="#cb12-3286" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">is.na</span>(df_temp <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="fu">any_of</span>(var)))) <span class="sc">==</span> <span class="fu">nrow</span>(df_temp)) { <span class="co"># if no data, stop don't calculate anything</span></span>
<span id="cb12-3287"><a href="#cb12-3287" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3288"><a href="#cb12-3288" aria-hidden="true" tabindex="-1"></a>      fits[j] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb12-3289"><a href="#cb12-3289" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3290"><a href="#cb12-3290" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb12-3291"><a href="#cb12-3291" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3292"><a href="#cb12-3292" aria-hidden="true" tabindex="-1"></a>      fits[j] <span class="ot">=</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb12-3293"><a href="#cb12-3293" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lm</span>(<span class="fu">paste0</span>(var, <span class="st">" ~ i"</span>) <span class="sc">%&gt;%</span> as.formula, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3294"><a href="#cb12-3294" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict</span>(<span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">i =</span> <span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">24</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3295"><a href="#cb12-3295" aria-hidden="true" tabindex="-1"></a>        calculate_final_fit</span>
<span id="cb12-3296"><a href="#cb12-3296" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3297"><a href="#cb12-3297" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-3298"><a href="#cb12-3298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3299"><a href="#cb12-3299" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">=</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-3300"><a href="#cb12-3300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3301"><a href="#cb12-3301" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-3302"><a href="#cb12-3302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3303"><a href="#cb12-3303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorganize</span></span>
<span id="cb12-3304"><a href="#cb12-3304" aria-hidden="true" tabindex="-1"></a>  fits <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-3305"><a href="#cb12-3305" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb12-3306"><a href="#cb12-3306" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span> </span>
<span id="cb12-3307"><a href="#cb12-3307" aria-hidden="true" tabindex="-1"></a>    data.frame</span>
<span id="cb12-3308"><a href="#cb12-3308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(fits) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">8</span>, <span class="at">to =</span> <span class="dv">24</span>, <span class="at">by =</span> <span class="dv">4</span>), <span class="st">" pt"</span>)</span>
<span id="cb12-3309"><a href="#cb12-3309" aria-hidden="true" tabindex="-1"></a>  fits <span class="sc">%&gt;%</span> </span>
<span id="cb12-3310"><a href="#cb12-3310" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), \(x) <span class="fu">ifelse</span>(<span class="fu">is.nan</span>(x), <span class="cn">NA</span>, x))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3311"><a href="#cb12-3311" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-3312"><a href="#cb12-3312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3313"><a href="#cb12-3313" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3314"><a href="#cb12-3314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3315"><a href="#cb12-3315" aria-hidden="true" tabindex="-1"></a><span class="co"># function to output indication summary table</span></span>
<span id="cb12-3316"><a href="#cb12-3316" aria-hidden="true" tabindex="-1"></a>format_as_indication_summary <span class="ot">&lt;-</span> <span class="cf">function</span>(data_ind, sel_state, sel_data_ended, sel_eval_date) {</span>
<span id="cb12-3317"><a href="#cb12-3317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3318"><a href="#cb12-3318" aria-hidden="true" tabindex="-1"></a>  data_ind <span class="sc">%&gt;%</span> </span>
<span id="cb12-3319"><a href="#cb12-3319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> sel_state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3320"><a href="#cb12-3320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fiscal_year_ended,current_level_earned_premium, premium_trend_factors, trended_current_level_earned_premium, incurred_loss, implied_incurred_age_to_ult, ult_incurred_loss, loss_trend_factors, trended_ult_incurred_loss, trended_ult_incurred_partial_loss_ratio, ay_weights) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3321"><a href="#cb12-3321" aria-hidden="true" tabindex="-1"></a>    gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3322"><a href="#cb12-3322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3323"><a href="#cb12-3323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="fu">paste0</span>(<span class="st">"**"</span>, sel_state, <span class="st">" indications**"</span>)),</span>
<span id="cb12-3324"><a href="#cb12-3324" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="fu">paste0</span>(<span class="st">"**Calendar / accident year data ended "</span>, <span class="fu">month</span>(sel_data_ended, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">FALSE</span>), <span class="st">" "</span>, <span class="fu">day</span>(sel_data_ended), <span class="st">", "</span>, <span class="fu">year</span>(sel_data_ended), <span class="st">" as of "</span>, <span class="fu">month</span>(sel_eval_date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">FALSE</span>), <span class="st">" "</span>, <span class="fu">day</span>(sel_eval_date), <span class="st">", "</span>, <span class="fu">year</span>(sel_eval_date), <span class="st">"**"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3325"><a href="#cb12-3325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_label</span>(<span class="at">fiscal_year_ended =</span> <span class="st">"Year ended"</span>,</span>
<span id="cb12-3326"><a href="#cb12-3326" aria-hidden="true" tabindex="-1"></a>               <span class="at">current_level_earned_premium =</span> <span class="st">"Current level earned premium"</span>,</span>
<span id="cb12-3327"><a href="#cb12-3327" aria-hidden="true" tabindex="-1"></a>               <span class="at">premium_trend_factors =</span> <span class="st">"Premium trend factors"</span>,</span>
<span id="cb12-3328"><a href="#cb12-3328" aria-hidden="true" tabindex="-1"></a>               <span class="at">trended_current_level_earned_premium =</span> <span class="st">"Trended current level earned poremium"</span>,</span>
<span id="cb12-3329"><a href="#cb12-3329" aria-hidden="true" tabindex="-1"></a>               <span class="at">incurred_loss =</span> <span class="st">"Non-cat incurred loss + LAE"</span>,</span>
<span id="cb12-3330"><a href="#cb12-3330" aria-hidden="true" tabindex="-1"></a>               <span class="at">implied_incurred_age_to_ult =</span> <span class="st">"Loss development factors"</span>,</span>
<span id="cb12-3331"><a href="#cb12-3331" aria-hidden="true" tabindex="-1"></a>               <span class="at">ult_incurred_loss =</span> <span class="st">"Ultimate non-cat incurred loss + LAE"</span>,</span>
<span id="cb12-3332"><a href="#cb12-3332" aria-hidden="true" tabindex="-1"></a>               <span class="at">loss_trend_factors =</span> <span class="st">"Loss trend factors"</span>,</span>
<span id="cb12-3333"><a href="#cb12-3333" aria-hidden="true" tabindex="-1"></a>               <span class="at">trended_ult_incurred_loss =</span> <span class="st">"Trended ultimate non-cat incurred loss + lae"</span>,</span>
<span id="cb12-3334"><a href="#cb12-3334" aria-hidden="true" tabindex="-1"></a>               <span class="at">trended_ult_incurred_partial_loss_ratio =</span> <span class="st">"Trended ultimate non-cat incurred parial loss + LAE ratio"</span>,</span>
<span id="cb12-3335"><a href="#cb12-3335" aria-hidden="true" tabindex="-1"></a>               <span class="at">ay_weights =</span> <span class="st">"Accident year weights"</span></span>
<span id="cb12-3336"><a href="#cb12-3336" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-3337"><a href="#cb12-3337" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(current_level_earned_premium, trended_current_level_earned_premium, incurred_loss, ult_incurred_loss, trended_ult_incurred_loss),</span>
<span id="cb12-3338"><a href="#cb12-3338" aria-hidden="true" tabindex="-1"></a>               <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3339"><a href="#cb12-3339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(premium_trend_factors, implied_incurred_age_to_ult, loss_trend_factors),</span>
<span id="cb12-3340"><a href="#cb12-3340" aria-hidden="true" tabindex="-1"></a>               <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3341"><a href="#cb12-3341" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">c</span>(trended_ult_incurred_partial_loss_ratio, ay_weights),</span>
<span id="cb12-3342"><a href="#cb12-3342" aria-hidden="true" tabindex="-1"></a>                <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-3343"><a href="#cb12-3343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3344"><a href="#cb12-3344" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3345"><a href="#cb12-3345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3346"><a href="#cb12-3346" aria-hidden="true" tabindex="-1"></a><span class="co"># function to output indication calculations table</span></span>
<span id="cb12-3347"><a href="#cb12-3347" aria-hidden="true" tabindex="-1"></a>format_as_indication_calculations <span class="ot">&lt;-</span> <span class="cf">function</span>(data_ind3_long, sel_state) {</span>
<span id="cb12-3348"><a href="#cb12-3348" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3349"><a href="#cb12-3349" aria-hidden="true" tabindex="-1"></a>  data_ind3_long <span class="sc">%&gt;%</span> </span>
<span id="cb12-3350"><a href="#cb12-3350" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> sel_state,</span>
<span id="cb12-3351"><a href="#cb12-3351" aria-hidden="true" tabindex="-1"></a>           variable <span class="sc">%!in%</span> <span class="fu">c</span>(<span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3352"><a href="#cb12-3352" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3353"><a href="#cb12-3353" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(variable_display, value) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3354"><a href="#cb12-3354" aria-hidden="true" tabindex="-1"></a>    gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3355"><a href="#cb12-3355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_options</span>(<span class="at">column_labels.hidden =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3356"><a href="#cb12-3356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> variable_display, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3357"><a href="#cb12-3357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> value, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3358"><a href="#cb12-3358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> value, <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3359"><a href="#cb12-3359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb12-3360"><a href="#cb12-3360" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb12-3361"><a href="#cb12-3361" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>)</span>
<span id="cb12-3362"><a href="#cb12-3362" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-3363"><a href="#cb12-3363" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_body</span>(</span>
<span id="cb12-3364"><a href="#cb12-3364" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> <span class="fu">c</span>(variable_display, value),</span>
<span id="cb12-3365"><a href="#cb12-3365" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> variable_display <span class="sc">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span id="cb12-3366"><a href="#cb12-3366" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-3367"><a href="#cb12-3367" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3368"><a href="#cb12-3368" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb12-3369"><a href="#cb12-3369" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb12-3370"><a href="#cb12-3370" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"yellow"</span>)</span>
<span id="cb12-3371"><a href="#cb12-3371" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-3372"><a href="#cb12-3372" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_body</span>(</span>
<span id="cb12-3373"><a href="#cb12-3373" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> value,</span>
<span id="cb12-3374"><a href="#cb12-3374" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> variable_display <span class="sc">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span id="cb12-3375"><a href="#cb12-3375" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-3376"><a href="#cb12-3376" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-3377"><a href="#cb12-3377" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3378"><a href="#cb12-3378" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3379"><a href="#cb12-3379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3380"><a href="#cb12-3380" aria-hidden="true" tabindex="-1"></a><span class="co"># function to output supporting table of indication calculations</span></span>
<span id="cb12-3381"><a href="#cb12-3381" aria-hidden="true" tabindex="-1"></a>format_as_indication_calculations_support <span class="ot">&lt;-</span> <span class="cf">function</span>(data_ind3_long, sel_state) {</span>
<span id="cb12-3382"><a href="#cb12-3382" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3383"><a href="#cb12-3383" aria-hidden="true" tabindex="-1"></a>  data_ind3_long <span class="sc">%&gt;%</span> </span>
<span id="cb12-3384"><a href="#cb12-3384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> sel_state,</span>
<span id="cb12-3385"><a href="#cb12-3385" aria-hidden="true" tabindex="-1"></a>           variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3386"><a href="#cb12-3386" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3387"><a href="#cb12-3387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(variable_display, value) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3388"><a href="#cb12-3388" aria-hidden="true" tabindex="-1"></a>    gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3389"><a href="#cb12-3389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_options</span>(<span class="at">column_labels.hidden =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3390"><a href="#cb12-3390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> variable_display, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3391"><a href="#cb12-3391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> value, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3392"><a href="#cb12-3392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> value, <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-3393"><a href="#cb12-3393" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3394"><a href="#cb12-3394" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-3395"><a href="#cb12-3395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3396"><a href="#cb12-3396" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Raw data ----</span></span>
<span id="cb12-3397"><a href="#cb12-3397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3398"><a href="#cb12-3398" aria-hidden="true" tabindex="-1"></a><span class="co"># read in data from access process</span></span>
<span id="cb12-3399"><a href="#cb12-3399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3400"><a href="#cb12-3400" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; premium data</span></span>
<span id="cb12-3401"><a href="#cb12-3401" aria-hidden="true" tabindex="-1"></a>data_premium_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"PremiumData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3402"><a href="#cb12-3402" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3403"><a href="#cb12-3403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">qtr =</span> quarter)</span>
<span id="cb12-3404"><a href="#cb12-3404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3405"><a href="#cb12-3405" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; loss data</span></span>
<span id="cb12-3406"><a href="#cb12-3406" aria-hidden="true" tabindex="-1"></a>data_loss_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"LossData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3407"><a href="#cb12-3407" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3408"><a href="#cb12-3408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"qtr"</span>), as.numeric))</span>
<span id="cb12-3409"><a href="#cb12-3409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3410"><a href="#cb12-3410" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; reported frequency data</span></span>
<span id="cb12-3411"><a href="#cb12-3411" aria-hidden="true" tabindex="-1"></a>data_rept_freq_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"ReptFreqData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3412"><a href="#cb12-3412" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3413"><a href="#cb12-3413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"qtr"</span>), as.numeric))</span>
<span id="cb12-3414"><a href="#cb12-3414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3415"><a href="#cb12-3415" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; closed by closed evaluation data</span></span>
<span id="cb12-3416"><a href="#cb12-3416" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span>  <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"ClsdByClsdEvalDt"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3417"><a href="#cb12-3417" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3418"><a href="#cb12-3418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eval_qtr =</span> <span class="fu">as.numeric</span>(eval_qtr))</span>
<span id="cb12-3419"><a href="#cb12-3419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3420"><a href="#cb12-3420" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; closed by evaluation data</span></span>
<span id="cb12-3421"><a href="#cb12-3421" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"ClsdByEvalDt"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3422"><a href="#cb12-3422" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3423"><a href="#cb12-3423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eval_qtr =</span> <span class="fu">as.numeric</span>(eval_qtr))</span>
<span id="cb12-3424"><a href="#cb12-3424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3425"><a href="#cb12-3425" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; RMS modeled loss</span></span>
<span id="cb12-3426"><a href="#cb12-3426" aria-hidden="true" tabindex="-1"></a>data_rms_modeled_loss <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RMSModLoss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3427"><a href="#cb12-3427" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb12-3428"><a href="#cb12-3428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3429"><a href="#cb12-3429" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; TS modeled loss</span></span>
<span id="cb12-3430"><a href="#cb12-3430" aria-hidden="true" tabindex="-1"></a>data_ts_modeled_loss <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"TSModLoss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3431"><a href="#cb12-3431" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb12-3432"><a href="#cb12-3432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3433"><a href="#cb12-3433" aria-hidden="true" tabindex="-1"></a><span class="co"># single out vectors</span></span>
<span id="cb12-3434"><a href="#cb12-3434" aria-hidden="true" tabindex="-1"></a>vec_states <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_premium_raw<span class="sc">$</span>state) <span class="co"># use premium data to capture all states</span></span>
<span id="cb12-3435"><a href="#cb12-3435" aria-hidden="true" tabindex="-1"></a>vec_loss_years <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>loss_year)</span>
<span id="cb12-3436"><a href="#cb12-3436" aria-hidden="true" tabindex="-1"></a>vec_loss_qtrs <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>loss_qtr)</span>
<span id="cb12-3437"><a href="#cb12-3437" aria-hidden="true" tabindex="-1"></a>vec_eval_years <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>eval_year)</span>
<span id="cb12-3438"><a href="#cb12-3438" aria-hidden="true" tabindex="-1"></a>vec_eval_qtrs <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>eval_qtr)</span>
<span id="cb12-3439"><a href="#cb12-3439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3440"><a href="#cb12-3440" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataset of all possible combos, then add the needed combos for the most recent year</span></span>
<span id="cb12-3441"><a href="#cb12-3441" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; this is so that later in the process, data has rows of zero rather than no row if no losses were in that particular period</span></span>
<span id="cb12-3442"><a href="#cb12-3442" aria-hidden="true" tabindex="-1"></a>data_all_combos <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(vec_states, vec_loss_years, vec_loss_qtrs, vec_eval_years, vec_eval_qtrs) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3443"><a href="#cb12-3443" aria-hidden="true" tabindex="-1"></a>  data.frame</span>
<span id="cb12-3444"><a href="#cb12-3444" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_all_combos) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"loss_year"</span>, <span class="st">"loss_qtr"</span>, <span class="st">"eval_year"</span>, <span class="st">"eval_qtr"</span>)</span>
<span id="cb12-3445"><a href="#cb12-3445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3446"><a href="#cb12-3446" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only valid periods</span></span>
<span id="cb12-3447"><a href="#cb12-3447" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; set current eval quarter</span></span>
<span id="cb12-3448"><a href="#cb12-3448" aria-hidden="true" tabindex="-1"></a>cur_eval_qtr <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb12-3449"><a href="#cb12-3449" aria-hidden="true" tabindex="-1"></a>data_all_combos <span class="sc">%&lt;&gt;%</span></span>
<span id="cb12-3450"><a href="#cb12-3450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loss_year <span class="sc">&lt;=</span> eval_year) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3451"><a href="#cb12-3451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, loss_year, loss_qtr, eval_year, eval_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3452"><a href="#cb12-3452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">keep =</span> </span>
<span id="cb12-3453"><a href="#cb12-3453" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-3454"><a href="#cb12-3454" aria-hidden="true" tabindex="-1"></a>             loss_year <span class="sc">==</span> eval_year <span class="sc">&amp;</span> loss_qtr <span class="sc">&gt;</span> eval_qtr <span class="sc">~</span> <span class="dv">0</span>, <span class="co"># illogical periods</span></span>
<span id="cb12-3455"><a href="#cb12-3455" aria-hidden="true" tabindex="-1"></a>             loss_year <span class="sc">==</span> <span class="fu">max</span>(loss_year) <span class="sc">&amp;</span> loss_qtr <span class="sc">&gt;</span> cur_eval_qtr <span class="sc">~</span> <span class="dv">0</span>, <span class="co"># future periods</span></span>
<span id="cb12-3456"><a href="#cb12-3456" aria-hidden="true" tabindex="-1"></a>             eval_year <span class="sc">==</span> <span class="fu">max</span>(eval_year) <span class="sc">&amp;</span> eval_qtr <span class="sc">&gt;</span> cur_eval_qtr <span class="sc">~</span> <span class="dv">0</span>, <span class="co"># future periods</span></span>
<span id="cb12-3457"><a href="#cb12-3457" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> <span class="dv">1</span></span>
<span id="cb12-3458"><a href="#cb12-3458" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb12-3459"><a href="#cb12-3459" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3460"><a href="#cb12-3460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(keep <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3461"><a href="#cb12-3461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>keep)</span>
<span id="cb12-3462"><a href="#cb12-3462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3463"><a href="#cb12-3463" aria-hidden="true" tabindex="-1"></a><span class="do">### Premium data</span></span>
<span id="cb12-3464"><a href="#cb12-3464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3465"><a href="#cb12-3465" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to premium data</span></span>
<span id="cb12-3466"><a href="#cb12-3466" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span id="cb12-3467"><a href="#cb12-3467" aria-hidden="true" tabindex="-1"></a>data_premium_agg <span class="ot">&lt;-</span> data_premium_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-3468"><a href="#cb12-3468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(state, loss_year, loss_qtr), <span class="at">by =</span> <span class="fu">join_by</span>(state, year <span class="sc">==</span> loss_year, qtr <span class="sc">==</span> loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3469"><a href="#cb12-3469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, year, qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3470"><a href="#cb12-3470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-3471"><a href="#cb12-3471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3472"><a href="#cb12-3472" aria-hidden="true" tabindex="-1"></a><span class="do">### Loss data</span></span>
<span id="cb12-3473"><a href="#cb12-3473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3474"><a href="#cb12-3474" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to loss data</span></span>
<span id="cb12-3475"><a href="#cb12-3475" aria-hidden="true" tabindex="-1"></a>data_loss_raw2 <span class="ot">&lt;-</span> data_loss_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-3476"><a href="#cb12-3476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos, <span class="at">by =</span> <span class="fu">join_by</span>(state, loss_year, loss_qtr, eval_year, eval_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3477"><a href="#cb12-3477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, loss_year, loss_qtr, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3478"><a href="#cb12-3478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-3479"><a href="#cb12-3479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3480"><a href="#cb12-3480" aria-hidden="true" tabindex="-1"></a><span class="co"># create age variable</span></span>
<span id="cb12-3481"><a href="#cb12-3481" aria-hidden="true" tabindex="-1"></a>data_loss <span class="ot">&lt;-</span> data_loss_raw2 <span class="sc">%&gt;%</span> </span>
<span id="cb12-3482"><a href="#cb12-3482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> (eval_year <span class="sc">-</span> loss_year) <span class="sc">*</span> <span class="dv">12</span> <span class="sc">+</span> (eval_qtr <span class="sc">-</span> loss_qtr) <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">3</span>, <span class="co"># evaluating in same quarter as loss counts as 3 months of development</span></span>
<span id="cb12-3483"><a href="#cb12-3483" aria-hidden="true" tabindex="-1"></a>         <span class="at">paid_loss_plus_lae =</span> paid_loss <span class="sc">+</span> paid_lae <span class="sc">+</span> <span class="sc">-</span>subrogation_salvage,</span>
<span id="cb12-3484"><a href="#cb12-3484" aria-hidden="true" tabindex="-1"></a>         <span class="at">incurred_loss =</span> paid_loss_plus_lae <span class="sc">+</span> case_reserve <span class="sc">+</span> expense_reserve,</span>
<span id="cb12-3485"><a href="#cb12-3485" aria-hidden="true" tabindex="-1"></a>         <span class="at">incurred_claim_count =</span> cwp_count <span class="sc">+</span> open_count) </span>
<span id="cb12-3486"><a href="#cb12-3486" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3487"><a href="#cb12-3487" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized loss data by state and overall (cw)</span></span>
<span id="cb12-3488"><a href="#cb12-3488" aria-hidden="true" tabindex="-1"></a>data_loss_agg_age_cw <span class="ot">&lt;-</span> data_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-3489"><a href="#cb12-3489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(state, loss_year, loss_qtr, age),</span>
<span id="cb12-3490"><a href="#cb12-3490" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(paid_loss_plus_lae, incurred_loss, incurred_claim_count), \(x) <span class="fu">sum</span>(x,<span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3491"><a href="#cb12-3491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, loss_year, loss_qtr, age) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3492"><a href="#cb12-3492" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_loss_agg_age_st} <span class="sc">%&gt;%</span> </span>
<span id="cb12-3493"><a href="#cb12-3493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(loss_year, loss_qtr, age),</span>
<span id="cb12-3494"><a href="#cb12-3494" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(paid_loss_plus_lae, incurred_loss, incurred_claim_count), \(x) <span class="fu">sum</span>(x,<span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb12-3495"><a href="#cb12-3495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3496"><a href="#cb12-3496" aria-hidden="true" tabindex="-1"></a><span class="co"># assumption of number of months to ultimate loss</span></span>
<span id="cb12-3497"><a href="#cb12-3497" aria-hidden="true" tabindex="-1"></a>ult_age <span class="ot">&lt;-</span> <span class="dv">63</span></span>
<span id="cb12-3498"><a href="#cb12-3498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3499"><a href="#cb12-3499" aria-hidden="true" tabindex="-1"></a><span class="do">### Reported frequency data</span></span>
<span id="cb12-3500"><a href="#cb12-3500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3501"><a href="#cb12-3501" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to loss data</span></span>
<span id="cb12-3502"><a href="#cb12-3502" aria-hidden="true" tabindex="-1"></a>data_rept_freq_raw2 <span class="ot">&lt;-</span> data_rept_freq_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-3503"><a href="#cb12-3503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos, <span class="at">by =</span> <span class="fu">join_by</span>(state, rept_year <span class="sc">==</span> loss_year, rept_qtr <span class="sc">==</span> loss_qtr, eval_year, eval_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3504"><a href="#cb12-3504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, rept_year, rept_qtr, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3505"><a href="#cb12-3505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-3506"><a href="#cb12-3506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3507"><a href="#cb12-3507" aria-hidden="true" tabindex="-1"></a><span class="do">### Closed by closed evaluation date</span></span>
<span id="cb12-3508"><a href="#cb12-3508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3509"><a href="#cb12-3509" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to premium data</span></span>
<span id="cb12-3510"><a href="#cb12-3510" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span id="cb12-3511"><a href="#cb12-3511" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_agg <span class="ot">&lt;-</span> data_clsd_by_clsd_eval_date_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-3512"><a href="#cb12-3512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(state, loss_year, loss_qtr), <span class="at">by =</span> <span class="fu">join_by</span>(state, eval_year <span class="sc">==</span> loss_year, eval_qtr <span class="sc">==</span> loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3513"><a href="#cb12-3513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3514"><a href="#cb12-3514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-3515"><a href="#cb12-3515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3516"><a href="#cb12-3516" aria-hidden="true" tabindex="-1"></a><span class="do">### Closed by evaluation date</span></span>
<span id="cb12-3517"><a href="#cb12-3517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3518"><a href="#cb12-3518" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to premium data</span></span>
<span id="cb12-3519"><a href="#cb12-3519" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span id="cb12-3520"><a href="#cb12-3520" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_agg <span class="ot">&lt;-</span> data_clsd_by_eval_date_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-3521"><a href="#cb12-3521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(state, loss_year, loss_qtr), <span class="at">by =</span> <span class="fu">join_by</span>(state, eval_year <span class="sc">==</span> loss_year, eval_qtr <span class="sc">==</span> loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3522"><a href="#cb12-3522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3523"><a href="#cb12-3523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-3524"><a href="#cb12-3524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3525"><a href="#cb12-3525" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Premium trend ----</span></span>
<span id="cb12-3526"><a href="#cb12-3526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3527"><a href="#cb12-3527" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized premium data overall (cw) and then combine</span></span>
<span id="cb12-3528"><a href="#cb12-3528" aria-hidden="true" tabindex="-1"></a>data_premium_agg_cw <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3529"><a href="#cb12-3529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3530"><a href="#cb12-3530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3531"><a href="#cb12-3531" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-3532"><a href="#cb12-3532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3533"><a href="#cb12-3533" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-3534"><a href="#cb12-3534" aria-hidden="true" tabindex="-1"></a>data_premium_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_premium_agg_cw)</span>
<span id="cb12-3535"><a href="#cb12-3535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3536"><a href="#cb12-3536" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize all columns by calendar year</span></span>
<span id="cb12-3537"><a href="#cb12-3537" aria-hidden="true" tabindex="-1"></a>data_premium_trend_calendar <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3538"><a href="#cb12-3538" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, year, qtr, on_level_earned_premium, earned_exposure) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3539"><a href="#cb12-3539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">27</span>, <span class="at">by =</span> state) <span class="sc">%&gt;%</span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span id="cb12-3540"><a href="#cb12-3540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3541"><a href="#cb12-3541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3542"><a href="#cb12-3542" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3543"><a href="#cb12-3543" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-3544"><a href="#cb12-3544" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3545"><a href="#cb12-3545" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-3546"><a href="#cb12-3546" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">calendar_quarter_ended =</span> <span class="fu">paste0</span>(year,<span class="st">"-Q"</span>, qtr),</span>
<span id="cb12-3547"><a href="#cb12-3547" aria-hidden="true" tabindex="-1"></a>               <span class="fu">across</span>(<span class="fu">c</span>(on_level_earned_premium, earned_exposure), \(col) roll<span class="sc">::</span><span class="fu">roll_sum</span>(col, <span class="at">width =</span> <span class="dv">4</span>)),</span>
<span id="cb12-3548"><a href="#cb12-3548" aria-hidden="true" tabindex="-1"></a>               <span class="at">average_premium =</span> <span class="fu">ifelse</span>(earned_exposure <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, on_level_earned_premium <span class="sc">/</span> earned_exposure)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3549"><a href="#cb12-3549" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(year, qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3550"><a href="#cb12-3550" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-3551"><a href="#cb12-3551" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3552"><a href="#cb12-3552" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3553"><a href="#cb12-3553" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3554"><a href="#cb12-3554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3555"><a href="#cb12-3555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(calendar_quarter_ended, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-3556"><a href="#cb12-3556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3557"><a href="#cb12-3557" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate weighted fits</span></span>
<span id="cb12-3558"><a href="#cb12-3558" aria-hidden="true" tabindex="-1"></a>data_prem_trend_fits <span class="ot">&lt;-</span> data_premium_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-3559"><a href="#cb12-3559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3560"><a href="#cb12-3560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3561"><a href="#cb12-3561" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3562"><a href="#cb12-3562" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-3563"><a href="#cb12-3563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3564"><a href="#cb12-3564" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"average_premium"</span>)</span>
<span id="cb12-3565"><a href="#cb12-3565" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3566"><a href="#cb12-3566" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3567"><a href="#cb12-3567" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3568"><a href="#cb12-3568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3569"><a href="#cb12-3569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"average_premium"</span>)</span>
<span id="cb12-3570"><a href="#cb12-3570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3571"><a href="#cb12-3571" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate Countrywide selections</span></span>
<span id="cb12-3572"><a href="#cb12-3572" aria-hidden="true" tabindex="-1"></a>data_premium_trend_selected_cw <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3573"><a href="#cb12-3573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3574"><a href="#cb12-3574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3575"><a href="#cb12-3575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">credibility =</span> <span class="fu">sum</span>(earned_exposure) <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="fl">0.035</span>) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">1084</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3576"><a href="#cb12-3576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3577"><a href="#cb12-3577" aria-hidden="true" tabindex="-1"></a>         <span class="at">selected =</span> <span class="fl">0.075</span>,</span>
<span id="cb12-3578"><a href="#cb12-3578" aria-hidden="true" tabindex="-1"></a>         <span class="at">credibility_comp =</span> <span class="fl">0.016</span>,</span>
<span id="cb12-3579"><a href="#cb12-3579" aria-hidden="true" tabindex="-1"></a>         <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility))</span>
<span id="cb12-3580"><a href="#cb12-3580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3581"><a href="#cb12-3581" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate state selections and add back in Countrywide</span></span>
<span id="cb12-3582"><a href="#cb12-3582" aria-hidden="true" tabindex="-1"></a>data_premium_trend_selected <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3583"><a href="#cb12-3583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3584"><a href="#cb12-3584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>,</span>
<span id="cb12-3585"><a href="#cb12-3585" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3586"><a href="#cb12-3586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> state,</span>
<span id="cb12-3587"><a href="#cb12-3587" aria-hidden="true" tabindex="-1"></a>            <span class="at">credibility =</span> <span class="fu">sum</span>(earned_exposure) <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="fl">0.035</span>) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">1084</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3588"><a href="#cb12-3588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selected =</span> <span class="fl">0.05</span>,</span>
<span id="cb12-3589"><a href="#cb12-3589" aria-hidden="true" tabindex="-1"></a>         <span class="at">credibility_comp =</span> data_premium_trend_selected_cw<span class="sc">$</span>z_wtd_selected,</span>
<span id="cb12-3590"><a href="#cb12-3590" aria-hidden="true" tabindex="-1"></a>         <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3591"><a href="#cb12-3591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_premium_trend_selected_cw)</span>
<span id="cb12-3592"><a href="#cb12-3592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3593"><a href="#cb12-3593" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Current level earned premium ----</span></span>
<span id="cb12-3594"><a href="#cb12-3594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3595"><a href="#cb12-3595" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate current level factor</span></span>
<span id="cb12-3596"><a href="#cb12-3596" aria-hidden="true" tabindex="-1"></a>data_premium_current_level <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3597"><a href="#cb12-3597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(year, <span class="st">"-Q"</span>, qtr),</span>
<span id="cb12-3598"><a href="#cb12-3598" aria-hidden="true" tabindex="-1"></a>         <span class="at">current_level_factor =</span> earned_premium <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, on_level_earned_premium <span class="sc">/</span> earned_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3599"><a href="#cb12-3599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, accident_quarter, earned_premium, current_level_factor, on_level_earned_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3600"><a href="#cb12-3600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">21</span>, <span class="at">by =</span> state) <span class="co"># 5 years of data + 1 quarter</span></span>
<span id="cb12-3601"><a href="#cb12-3601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3602"><a href="#cb12-3602" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by fiscal year</span></span>
<span id="cb12-3603"><a href="#cb12-3603" aria-hidden="true" tabindex="-1"></a>data_premium_current_level_fiscal <span class="ot">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span>(<span class="at">df =</span> data_premium_current_level) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3604"><a href="#cb12-3604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">earned_premium =</span> var1_cumulative, <span class="at">current_level_factor =</span> factor, <span class="at">current_level_earned_premium =</span> var2_cumulative)</span>
<span id="cb12-3605"><a href="#cb12-3605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3606"><a href="#cb12-3606" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Paid loss ----</span></span>
<span id="cb12-3607"><a href="#cb12-3607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3608"><a href="#cb12-3608" aria-hidden="true" tabindex="-1"></a><span class="do">### Loss triangle</span></span>
<span id="cb12-3609"><a href="#cb12-3609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3610"><a href="#cb12-3610" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-3611"><a href="#cb12-3611" aria-hidden="true" tabindex="-1"></a>data_paid_loss_triangle <span class="ot">&lt;-</span> <span class="fu">format_bases_as_triangle</span>(<span class="at">df_agg_age =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"paid_loss_plus_lae"</span>)</span>
<span id="cb12-3612"><a href="#cb12-3612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3613"><a href="#cb12-3613" aria-hidden="true" tabindex="-1"></a><span class="co"># output triangle</span></span>
<span id="cb12-3614"><a href="#cb12-3614" aria-hidden="true" tabindex="-1"></a>data_paid_loss_triangle <span class="sc">%&gt;%</span> </span>
<span id="cb12-3615"><a href="#cb12-3615" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3616"><a href="#cb12-3616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3617"><a href="#cb12-3617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Non-catastrophe paid loss + LAE**"</span>),</span>
<span id="cb12-3618"><a href="#cb12-3618" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3619"><a href="#cb12-3619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Evaluation months"</span>,</span>
<span id="cb12-3620"><a href="#cb12-3620" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3621"><a href="#cb12-3621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">accident_quarter =</span> <span class="st">"Accident</span><span class="sc">\n</span><span class="st">Quarter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3622"><a href="#cb12-3622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3623"><a href="#cb12-3623" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3624"><a href="#cb12-3624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3625"><a href="#cb12-3625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3626"><a href="#cb12-3626" aria-hidden="true" tabindex="-1"></a><span class="do">### Development factors</span></span>
<span id="cb12-3627"><a href="#cb12-3627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3628"><a href="#cb12-3628" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate development factors</span></span>
<span id="cb12-3629"><a href="#cb12-3629" aria-hidden="true" tabindex="-1"></a>data_paid_loss_dev <span class="ot">&lt;-</span> <span class="fu">calculate_dev_factors</span>(<span class="at">df_agg_age =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"paid_loss_plus_lae"</span>)</span>
<span id="cb12-3630"><a href="#cb12-3630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3631"><a href="#cb12-3631" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-3632"><a href="#cb12-3632" aria-hidden="true" tabindex="-1"></a>data_paid_loss_dev_triangle <span class="ot">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span>(<span class="at">df_dev =</span> data_paid_loss_dev)</span>
<span id="cb12-3633"><a href="#cb12-3633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3634"><a href="#cb12-3634" aria-hidden="true" tabindex="-1"></a><span class="co"># output triangle</span></span>
<span id="cb12-3635"><a href="#cb12-3635" aria-hidden="true" tabindex="-1"></a>data_paid_loss_dev_triangle <span class="sc">%&gt;%</span> </span>
<span id="cb12-3636"><a href="#cb12-3636" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3637"><a href="#cb12-3637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3638"><a href="#cb12-3638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Development factors**"</span>),</span>
<span id="cb12-3639"><a href="#cb12-3639" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3640"><a href="#cb12-3640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Age : Age"</span>,</span>
<span id="cb12-3641"><a href="#cb12-3641" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3642"><a href="#cb12-3642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">accident_quarter =</span> <span class="st">"Accident</span><span class="sc">\n</span><span class="st">Quarter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3643"><a href="#cb12-3643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3644"><a href="#cb12-3644" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3645"><a href="#cb12-3645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3646"><a href="#cb12-3646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3647"><a href="#cb12-3647" aria-hidden="true" tabindex="-1"></a><span class="do">### Selections</span></span>
<span id="cb12-3648"><a href="#cb12-3648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3649"><a href="#cb12-3649" aria-hidden="true" tabindex="-1"></a><span class="co"># hardcoding selections</span></span>
<span id="cb12-3650"><a href="#cb12-3650" aria-hidden="true" tabindex="-1"></a>selects_paid_loss <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">3.000</span>,<span class="fl">1.230</span>,<span class="fl">1.200</span>,<span class="fl">1.180</span>,<span class="fl">1.030</span>,<span class="fl">1.040</span>,<span class="fl">1.060</span>,<span class="fl">1.025</span>,<span class="fl">1.050</span>,<span class="fl">1.040</span>,<span class="fl">1.025</span>,<span class="fl">1.050</span>,<span class="fl">1.080</span>,<span class="fl">1.050</span>,<span class="fl">1.040</span>,<span class="fl">1.010</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.040</span>)</span>
<span id="cb12-3651"><a href="#cb12-3651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3652"><a href="#cb12-3652" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted development factors</span></span>
<span id="cb12-3653"><a href="#cb12-3653" aria-hidden="true" tabindex="-1"></a>data_paid_loss_selects <span class="ot">&lt;-</span> <span class="fu">calculate_weighted_dev_factors</span>(<span class="at">df_loss_tri =</span> data_paid_loss_triangle, <span class="at">selects =</span> selects_paid_loss)</span>
<span id="cb12-3654"><a href="#cb12-3654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3655"><a href="#cb12-3655" aria-hidden="true" tabindex="-1"></a><span class="co"># output table</span></span>
<span id="cb12-3656"><a href="#cb12-3656" aria-hidden="true" tabindex="-1"></a>data_paid_loss_selects <span class="sc">%&gt;%</span> </span>
<span id="cb12-3657"><a href="#cb12-3657" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3658"><a href="#cb12-3658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3659"><a href="#cb12-3659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**X-weighted development factors**"</span>),</span>
<span id="cb12-3660"><a href="#cb12-3660" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3661"><a href="#cb12-3661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Age : Age"</span>,</span>
<span id="cb12-3662"><a href="#cb12-3662" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3663"><a href="#cb12-3663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">id =</span> <span class="st">"Weight"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3664"><a href="#cb12-3664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3665"><a href="#cb12-3665" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3666"><a href="#cb12-3666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3667"><a href="#cb12-3667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3668"><a href="#cb12-3668" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Incurred loss ----</span></span>
<span id="cb12-3669"><a href="#cb12-3669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3670"><a href="#cb12-3670" aria-hidden="true" tabindex="-1"></a><span class="do">### Loss triangle</span></span>
<span id="cb12-3671"><a href="#cb12-3671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3672"><a href="#cb12-3672" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-3673"><a href="#cb12-3673" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_triangle <span class="ot">&lt;-</span> <span class="fu">format_bases_as_triangle</span>(<span class="at">df_agg_age =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_loss"</span>)</span>
<span id="cb12-3674"><a href="#cb12-3674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3675"><a href="#cb12-3675" aria-hidden="true" tabindex="-1"></a><span class="co"># output triangle</span></span>
<span id="cb12-3676"><a href="#cb12-3676" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_triangle <span class="sc">%&gt;%</span> </span>
<span id="cb12-3677"><a href="#cb12-3677" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3678"><a href="#cb12-3678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3679"><a href="#cb12-3679" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Non-catastrophe incurred loss + LAE**"</span>),</span>
<span id="cb12-3680"><a href="#cb12-3680" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3681"><a href="#cb12-3681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Evaluation months"</span>,</span>
<span id="cb12-3682"><a href="#cb12-3682" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3683"><a href="#cb12-3683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">accident_quarter =</span> <span class="st">"Accident</span><span class="sc">\n</span><span class="st">Quarter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3684"><a href="#cb12-3684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3685"><a href="#cb12-3685" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3686"><a href="#cb12-3686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3687"><a href="#cb12-3687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3688"><a href="#cb12-3688" aria-hidden="true" tabindex="-1"></a><span class="do">### Development factors</span></span>
<span id="cb12-3689"><a href="#cb12-3689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3690"><a href="#cb12-3690" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate development factors</span></span>
<span id="cb12-3691"><a href="#cb12-3691" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_dev <span class="ot">&lt;-</span> <span class="fu">calculate_dev_factors</span>(<span class="at">df_agg =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_loss"</span>)</span>
<span id="cb12-3692"><a href="#cb12-3692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3693"><a href="#cb12-3693" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-3694"><a href="#cb12-3694" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_dev_triangle <span class="ot">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span>(<span class="at">df_dev =</span> data_incurred_loss_dev)</span>
<span id="cb12-3695"><a href="#cb12-3695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3696"><a href="#cb12-3696" aria-hidden="true" tabindex="-1"></a><span class="co"># output triangle</span></span>
<span id="cb12-3697"><a href="#cb12-3697" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_dev_triangle <span class="sc">%&gt;%</span> </span>
<span id="cb12-3698"><a href="#cb12-3698" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3699"><a href="#cb12-3699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3700"><a href="#cb12-3700" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Development factors**"</span>),</span>
<span id="cb12-3701"><a href="#cb12-3701" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3702"><a href="#cb12-3702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Age : Age"</span>,</span>
<span id="cb12-3703"><a href="#cb12-3703" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3704"><a href="#cb12-3704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">accident_quarter =</span> <span class="st">"Accident</span><span class="sc">\n</span><span class="st">Quarter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3705"><a href="#cb12-3705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3706"><a href="#cb12-3706" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3707"><a href="#cb12-3707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3708"><a href="#cb12-3708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3709"><a href="#cb12-3709" aria-hidden="true" tabindex="-1"></a><span class="do">### Selections</span></span>
<span id="cb12-3710"><a href="#cb12-3710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3711"><a href="#cb12-3711" aria-hidden="true" tabindex="-1"></a><span class="co"># hardcoding selections</span></span>
<span id="cb12-3712"><a href="#cb12-3712" aria-hidden="true" tabindex="-1"></a>selects_incurred_loss <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.230</span>,<span class="fl">1.050</span>,<span class="fl">1.020</span>,<span class="fl">1.030</span>,<span class="fl">1.000</span>,<span class="fl">1.020</span>,<span class="fl">1.020</span>,<span class="fl">1.020</span>,<span class="fl">1.050</span>,<span class="fl">1.080</span>,<span class="fl">1.030</span>,<span class="fl">1.080</span>,<span class="fl">1.080</span>,<span class="fl">1.030</span>,<span class="fl">1.020</span>,<span class="fl">1.010</span>,<span class="fl">1.010</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>,<span class="fl">1.000</span>)</span>
<span id="cb12-3713"><a href="#cb12-3713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3714"><a href="#cb12-3714" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted development factors</span></span>
<span id="cb12-3715"><a href="#cb12-3715" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_selects <span class="ot">&lt;-</span> <span class="fu">calculate_weighted_dev_factors</span>(<span class="at">df_loss_tri =</span> data_incurred_loss_triangle ,<span class="at">selects =</span> selects_incurred_loss)</span>
<span id="cb12-3716"><a href="#cb12-3716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3717"><a href="#cb12-3717" aria-hidden="true" tabindex="-1"></a><span class="co"># output table</span></span>
<span id="cb12-3718"><a href="#cb12-3718" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_selects <span class="sc">%&gt;%</span> </span>
<span id="cb12-3719"><a href="#cb12-3719" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3720"><a href="#cb12-3720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3721"><a href="#cb12-3721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**X-weighted development factors**"</span>),</span>
<span id="cb12-3722"><a href="#cb12-3722" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3723"><a href="#cb12-3723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Age : Age"</span>,</span>
<span id="cb12-3724"><a href="#cb12-3724" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3725"><a href="#cb12-3725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">id =</span> <span class="st">"Weight"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3726"><a href="#cb12-3726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3727"><a href="#cb12-3727" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3728"><a href="#cb12-3728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3729"><a href="#cb12-3729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3730"><a href="#cb12-3730" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Incurred claim count ----</span></span>
<span id="cb12-3731"><a href="#cb12-3731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3732"><a href="#cb12-3732" aria-hidden="true" tabindex="-1"></a><span class="do">### Claim count triangle</span></span>
<span id="cb12-3733"><a href="#cb12-3733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3734"><a href="#cb12-3734" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-3735"><a href="#cb12-3735" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_triangle <span class="ot">&lt;-</span> <span class="fu">format_bases_as_triangle</span>(<span class="at">df_agg =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_claim_count"</span>)</span>
<span id="cb12-3736"><a href="#cb12-3736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3737"><a href="#cb12-3737" aria-hidden="true" tabindex="-1"></a><span class="co"># output triangle</span></span>
<span id="cb12-3738"><a href="#cb12-3738" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_triangle <span class="sc">%&gt;%</span> </span>
<span id="cb12-3739"><a href="#cb12-3739" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3740"><a href="#cb12-3740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3741"><a href="#cb12-3741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Non-catastrophe incurred claim count**"</span>),</span>
<span id="cb12-3742"><a href="#cb12-3742" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3743"><a href="#cb12-3743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Evaluation months"</span>,</span>
<span id="cb12-3744"><a href="#cb12-3744" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3745"><a href="#cb12-3745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">accident_quarter =</span> <span class="st">"Accident</span><span class="sc">\n</span><span class="st">Quarter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3746"><a href="#cb12-3746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3747"><a href="#cb12-3747" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3748"><a href="#cb12-3748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3749"><a href="#cb12-3749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3750"><a href="#cb12-3750" aria-hidden="true" tabindex="-1"></a><span class="do">### Development factors</span></span>
<span id="cb12-3751"><a href="#cb12-3751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3752"><a href="#cb12-3752" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate development factors</span></span>
<span id="cb12-3753"><a href="#cb12-3753" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_dev <span class="ot">&lt;-</span> <span class="fu">calculate_dev_factors</span>(<span class="at">df_agg =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_claim_count"</span>)</span>
<span id="cb12-3754"><a href="#cb12-3754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3755"><a href="#cb12-3755" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-3756"><a href="#cb12-3756" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_dev_triangle <span class="ot">&lt;-</span>  <span class="fu">format_dev_factors_as_triangle</span>(<span class="at">df_dev =</span> data_incurred_claim_count_dev)</span>
<span id="cb12-3757"><a href="#cb12-3757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3758"><a href="#cb12-3758" aria-hidden="true" tabindex="-1"></a><span class="co"># output triangle</span></span>
<span id="cb12-3759"><a href="#cb12-3759" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_dev_triangle <span class="sc">%&gt;%</span> </span>
<span id="cb12-3760"><a href="#cb12-3760" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3761"><a href="#cb12-3761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3762"><a href="#cb12-3762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Development factors**"</span>),</span>
<span id="cb12-3763"><a href="#cb12-3763" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3764"><a href="#cb12-3764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Age : Age"</span>,</span>
<span id="cb12-3765"><a href="#cb12-3765" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3766"><a href="#cb12-3766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">accident_quarter =</span> <span class="st">"Accident</span><span class="sc">\n</span><span class="st">Quarter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3767"><a href="#cb12-3767" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3768"><a href="#cb12-3768" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3769"><a href="#cb12-3769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3770"><a href="#cb12-3770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3771"><a href="#cb12-3771" aria-hidden="true" tabindex="-1"></a><span class="do">### Selections</span></span>
<span id="cb12-3772"><a href="#cb12-3772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3773"><a href="#cb12-3773" aria-hidden="true" tabindex="-1"></a><span class="co"># hardcoding selections</span></span>
<span id="cb12-3774"><a href="#cb12-3774" aria-hidden="true" tabindex="-1"></a>selects_incurred_claim_count <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.015</span>,<span class="fl">1.000</span>,<span class="fl">0.990</span>,<span class="fl">1.000</span>,<span class="fl">0.990</span>,<span class="fu">rep</span>(<span class="fl">1.000</span>, <span class="dv">16</span>))</span>
<span id="cb12-3775"><a href="#cb12-3775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3776"><a href="#cb12-3776" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted development factors</span></span>
<span id="cb12-3777"><a href="#cb12-3777" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_selects <span class="ot">&lt;-</span> <span class="fu">calculate_weighted_dev_factors</span>(<span class="at">df_loss_tri =</span> data_incurred_claim_count_triangle, <span class="at">selects =</span> selects_incurred_claim_count)</span>
<span id="cb12-3778"><a href="#cb12-3778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3779"><a href="#cb12-3779" aria-hidden="true" tabindex="-1"></a><span class="co"># output table</span></span>
<span id="cb12-3780"><a href="#cb12-3780" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_selects <span class="sc">%&gt;%</span> </span>
<span id="cb12-3781"><a href="#cb12-3781" aria-hidden="true" tabindex="-1"></a>  gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-3782"><a href="#cb12-3782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-3783"><a href="#cb12-3783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**X-weighted development factors**"</span>),</span>
<span id="cb12-3784"><a href="#cb12-3784" aria-hidden="true" tabindex="-1"></a>             <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="st">"**2024-Q2 indication evaluated as of 2024-Q3**"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3785"><a href="#cb12-3785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"Age : Age"</span>,</span>
<span id="cb12-3786"><a href="#cb12-3786" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3787"><a href="#cb12-3787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">id =</span> <span class="st">"Weight"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3788"><a href="#cb12-3788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-3789"><a href="#cb12-3789" aria-hidden="true" tabindex="-1"></a>             <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3790"><a href="#cb12-3790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>(<span class="at">missing_text =</span> <span class="st">""</span>)</span>
<span id="cb12-3791"><a href="#cb12-3791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3792"><a href="#cb12-3792" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Ultimate ----</span></span>
<span id="cb12-3793"><a href="#cb12-3793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3794"><a href="#cb12-3794" aria-hidden="true" tabindex="-1"></a><span class="do">### Summarize data</span></span>
<span id="cb12-3795"><a href="#cb12-3795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3796"><a href="#cb12-3796" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized loss data (accident quarter) by state, then overall (cw), and then combine</span></span>
<span id="cb12-3797"><a href="#cb12-3797" aria-hidden="true" tabindex="-1"></a>data_loss_agg <span class="ot">&lt;-</span> data_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-3798"><a href="#cb12-3798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eval_year <span class="sc">==</span> <span class="fu">max</span>(eval_year)) <span class="sc">%&gt;%</span> <span class="co"># only use rows in most recent evaluation period</span></span>
<span id="cb12-3799"><a href="#cb12-3799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eval_qtr <span class="sc">==</span> <span class="fu">max</span>(eval_qtr)) <span class="sc">%&gt;%</span> <span class="co"># -&gt; this makes it accident quarter</span></span>
<span id="cb12-3800"><a href="#cb12-3800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, loss_year, loss_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3801"><a href="#cb12-3801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"incurred"</span>), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3802"><a href="#cb12-3802" aria-hidden="true" tabindex="-1"></a>  ungroup</span>
<span id="cb12-3803"><a href="#cb12-3803" aria-hidden="true" tabindex="-1"></a>data_loss_agg_cw <span class="ot">&lt;-</span> data_loss_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3804"><a href="#cb12-3804" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(loss_year, loss_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3805"><a href="#cb12-3805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"incurred"</span>), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3806"><a href="#cb12-3806" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-3807"><a href="#cb12-3807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3808"><a href="#cb12-3808" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-3809"><a href="#cb12-3809" aria-hidden="true" tabindex="-1"></a>data_loss_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_loss_agg_cw)</span>
<span id="cb12-3810"><a href="#cb12-3810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3811"><a href="#cb12-3811" aria-hidden="true" tabindex="-1"></a><span class="do">### Loss</span></span>
<span id="cb12-3812"><a href="#cb12-3812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3813"><a href="#cb12-3813" aria-hidden="true" tabindex="-1"></a><span class="co"># append age to ultimate factors and calculate ultimate losses </span></span>
<span id="cb12-3814"><a href="#cb12-3814" aria-hidden="true" tabindex="-1"></a>data_ult_loss <span class="ot">&lt;-</span> <span class="fu">calculate_ultimate_incurred</span>(<span class="at">df_agg =</span> data_loss_agg, <span class="at">df_selects =</span> data_incurred_loss_selects, <span class="at">var =</span> <span class="st">"incurred_loss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3815"><a href="#cb12-3815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">incurred_loss =</span> incurred, <span class="at">incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_loss =</span> ult_incurred)</span>
<span id="cb12-3816"><a href="#cb12-3816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3817"><a href="#cb12-3817" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by fiscal year</span></span>
<span id="cb12-3818"><a href="#cb12-3818" aria-hidden="true" tabindex="-1"></a>data_ult_loss_fiscal <span class="ot">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span>(<span class="at">df =</span> data_ult_loss) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3819"><a href="#cb12-3819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">incurred_loss =</span> var1_cumulative, <span class="at">implied_incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_loss =</span> var2_cumulative)</span>
<span id="cb12-3820"><a href="#cb12-3820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3821"><a href="#cb12-3821" aria-hidden="true" tabindex="-1"></a><span class="do">### Claim count</span></span>
<span id="cb12-3822"><a href="#cb12-3822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3823"><a href="#cb12-3823" aria-hidden="true" tabindex="-1"></a><span class="co"># append age to ultimate factors and calculate ultimate claim count</span></span>
<span id="cb12-3824"><a href="#cb12-3824" aria-hidden="true" tabindex="-1"></a>data_ult_claim_count <span class="ot">&lt;-</span> <span class="fu">calculate_ultimate_incurred</span>(<span class="at">df_agg =</span> data_loss_agg, <span class="at">df_selects =</span> data_incurred_claim_count_selects, <span class="at">var =</span> <span class="st">"incurred_claim_count"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3825"><a href="#cb12-3825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">incurred_claim_count =</span> incurred, <span class="at">implied_incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_claim_count =</span> ult_incurred)</span>
<span id="cb12-3826"><a href="#cb12-3826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3827"><a href="#cb12-3827" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by fiscal year</span></span>
<span id="cb12-3828"><a href="#cb12-3828" aria-hidden="true" tabindex="-1"></a>data_ult_claim_count_fiscal <span class="ot">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span>(<span class="at">df =</span> data_ult_claim_count) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3829"><a href="#cb12-3829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">incurred_claim_count =</span> var1_cumulative, <span class="at">implied_incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_claim_count =</span> var2_cumulative)</span>
<span id="cb12-3830"><a href="#cb12-3830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3831"><a href="#cb12-3831" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Frequency trend ----</span></span>
<span id="cb12-3832"><a href="#cb12-3832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3833"><a href="#cb12-3833" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized loss data (calendar quarter) by state, then overall (cw), and then combine</span></span>
<span id="cb12-3834"><a href="#cb12-3834" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; data is already only using the most recent evaluation period</span></span>
<span id="cb12-3835"><a href="#cb12-3835" aria-hidden="true" tabindex="-1"></a>data_rept_freq_agg <span class="ot">&lt;-</span> data_rept_freq_raw2 <span class="sc">%&gt;%</span> </span>
<span id="cb12-3836"><a href="#cb12-3836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, rept_year, rept_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3837"><a href="#cb12-3837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">reported_count =</span> <span class="fu">sum</span>(reported_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3838"><a href="#cb12-3838" aria-hidden="true" tabindex="-1"></a>  ungroup</span>
<span id="cb12-3839"><a href="#cb12-3839" aria-hidden="true" tabindex="-1"></a>data_rept_freq_agg_cw <span class="ot">&lt;-</span> data_rept_freq_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3840"><a href="#cb12-3840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rept_year, rept_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3841"><a href="#cb12-3841" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">reported_count =</span> <span class="fu">sum</span>(reported_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3842"><a href="#cb12-3842" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-3843"><a href="#cb12-3843" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3844"><a href="#cb12-3844" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-3845"><a href="#cb12-3845" aria-hidden="true" tabindex="-1"></a>data_rept_freq_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_rept_freq_agg_cw)</span>
<span id="cb12-3846"><a href="#cb12-3846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3847"><a href="#cb12-3847" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized closed by closed evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span id="cb12-3848"><a href="#cb12-3848" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_agg_cw <span class="ot">&lt;-</span> data_clsd_by_clsd_eval_date_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3849"><a href="#cb12-3849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eval_year, eval_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3850"><a href="#cb12-3850" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3851"><a href="#cb12-3851" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-3852"><a href="#cb12-3852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3853"><a href="#cb12-3853" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-3854"><a href="#cb12-3854" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_clsd_by_clsd_eval_date_agg_cw)</span>
<span id="cb12-3855"><a href="#cb12-3855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3856"><a href="#cb12-3856" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize all columns by calendar year</span></span>
<span id="cb12-3857"><a href="#cb12-3857" aria-hidden="true" tabindex="-1"></a>data_freq_trend_calendar <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3858"><a href="#cb12-3858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, year, qtr, earned_exposure) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3859"><a href="#cb12-3859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_rept_freq_agg <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, rept_year, rept_qtr, reported_count), <span class="at">by =</span> <span class="fu">join_by</span>(state, year <span class="sc">==</span> rept_year, qtr <span class="sc">==</span> rept_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3860"><a href="#cb12-3860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_clsd_by_clsd_eval_date_agg <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, eval_year, eval_qtr, closed_w_pay_count), <span class="at">by =</span> <span class="fu">join_by</span>(state, year <span class="sc">==</span> eval_year, qtr <span class="sc">==</span> eval_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3861"><a href="#cb12-3861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">27</span>, <span class="at">by =</span> state) <span class="sc">%&gt;%</span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span id="cb12-3862"><a href="#cb12-3862" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_freq_trend_agg} <span class="sc">%&gt;%</span> </span>
<span id="cb12-3863"><a href="#cb12-3863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3864"><a href="#cb12-3864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3865"><a href="#cb12-3865" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3866"><a href="#cb12-3866" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-3867"><a href="#cb12-3867" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3868"><a href="#cb12-3868" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-3869"><a href="#cb12-3869" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">calendar_quarter_ended =</span> <span class="fu">paste0</span>(year, <span class="st">"-Q"</span>, qtr),</span>
<span id="cb12-3870"><a href="#cb12-3870" aria-hidden="true" tabindex="-1"></a>               <span class="fu">across</span>(<span class="fu">c</span>(earned_exposure, reported_count, closed_w_pay_count), \(col) roll<span class="sc">::</span><span class="fu">roll_sum</span>(col, <span class="at">width =</span> <span class="dv">4</span>)),</span>
<span id="cb12-3871"><a href="#cb12-3871" aria-hidden="true" tabindex="-1"></a>               <span class="at">reported_freq =</span> <span class="fu">ifelse</span>(earned_exposure <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, reported_count <span class="sc">/</span> earned_exposure),</span>
<span id="cb12-3872"><a href="#cb12-3872" aria-hidden="true" tabindex="-1"></a>               <span class="at">closed_w_pay_freq =</span> <span class="fu">ifelse</span>(earned_exposure <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, closed_w_pay_count <span class="sc">/</span> earned_exposure)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3873"><a href="#cb12-3873" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(calendar_quarter_ended, earned_exposure, reported_count, reported_freq, closed_w_pay_count, closed_w_pay_freq) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3874"><a href="#cb12-3874" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-3875"><a href="#cb12-3875" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3876"><a href="#cb12-3876" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3877"><a href="#cb12-3877" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3878"><a href="#cb12-3878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3879"><a href="#cb12-3879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(calendar_quarter_ended, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-3880"><a href="#cb12-3880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3881"><a href="#cb12-3881" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span id="cb12-3882"><a href="#cb12-3882" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; reported frequency</span></span>
<span id="cb12-3883"><a href="#cb12-3883" aria-hidden="true" tabindex="-1"></a>data_freq_trend_fits_a <span class="ot">&lt;-</span> data_freq_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-3884"><a href="#cb12-3884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3885"><a href="#cb12-3885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3886"><a href="#cb12-3886" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3887"><a href="#cb12-3887" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-3888"><a href="#cb12-3888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3889"><a href="#cb12-3889" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"reported_freq"</span>)</span>
<span id="cb12-3890"><a href="#cb12-3890" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3891"><a href="#cb12-3891" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3892"><a href="#cb12-3892" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3893"><a href="#cb12-3893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3894"><a href="#cb12-3894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"reported_freq"</span>)</span>
<span id="cb12-3895"><a href="#cb12-3895" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; closed with pay frequency</span></span>
<span id="cb12-3896"><a href="#cb12-3896" aria-hidden="true" tabindex="-1"></a>data_freq_trend_fits_b <span class="ot">&lt;-</span> data_freq_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-3897"><a href="#cb12-3897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3898"><a href="#cb12-3898" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3899"><a href="#cb12-3899" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3900"><a href="#cb12-3900" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-3901"><a href="#cb12-3901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3902"><a href="#cb12-3902" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"closed_w_pay_freq"</span>)</span>
<span id="cb12-3903"><a href="#cb12-3903" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3904"><a href="#cb12-3904" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3905"><a href="#cb12-3905" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3906"><a href="#cb12-3906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3907"><a href="#cb12-3907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"closed_w_pay_freq"</span>)</span>
<span id="cb12-3908"><a href="#cb12-3908" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine</span></span>
<span id="cb12-3909"><a href="#cb12-3909" aria-hidden="true" tabindex="-1"></a>data_freq_trend_fits <span class="ot">&lt;-</span> data_freq_trend_fits_a <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(data_freq_trend_fits_b, <span class="at">by =</span> <span class="fu">join_by</span>(state, pt))</span>
<span id="cb12-3910"><a href="#cb12-3910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3911"><a href="#cb12-3911" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate Countrywide selections</span></span>
<span id="cb12-3912"><a href="#cb12-3912" aria-hidden="true" tabindex="-1"></a>data_freq_trend_selected_cw <span class="ot">&lt;-</span> data_freq_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3913"><a href="#cb12-3913" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3914"><a href="#cb12-3914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3915"><a href="#cb12-3915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3916"><a href="#cb12-3916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3917"><a href="#cb12-3917" aria-hidden="true" tabindex="-1"></a>         <span class="at">selected =</span> <span class="fl">0.04</span>,</span>
<span id="cb12-3918"><a href="#cb12-3918" aria-hidden="true" tabindex="-1"></a>         <span class="at">credibility_comp =</span> <span class="dv">0</span>,</span>
<span id="cb12-3919"><a href="#cb12-3919" aria-hidden="true" tabindex="-1"></a>         <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility))</span>
<span id="cb12-3920"><a href="#cb12-3920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3921"><a href="#cb12-3921" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate state selections and add back in Countrywide</span></span>
<span id="cb12-3922"><a href="#cb12-3922" aria-hidden="true" tabindex="-1"></a>data_freq_trend_selected <span class="ot">&lt;-</span> data_freq_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3923"><a href="#cb12-3923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3924"><a href="#cb12-3924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>,</span>
<span id="cb12-3925"><a href="#cb12-3925" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3926"><a href="#cb12-3926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> state,</span>
<span id="cb12-3927"><a href="#cb12-3927" aria-hidden="true" tabindex="-1"></a>            <span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3928"><a href="#cb12-3928" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selected =</span> <span class="fl">0.04</span>,</span>
<span id="cb12-3929"><a href="#cb12-3929" aria-hidden="true" tabindex="-1"></a>         <span class="at">credibility_comp =</span> data_freq_trend_selected_cw<span class="sc">$</span>z_wtd_selected,</span>
<span id="cb12-3930"><a href="#cb12-3930" aria-hidden="true" tabindex="-1"></a>         <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3931"><a href="#cb12-3931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_freq_trend_selected_cw)</span>
<span id="cb12-3932"><a href="#cb12-3932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3933"><a href="#cb12-3933" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Severity trend ----</span></span>
<span id="cb12-3934"><a href="#cb12-3934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3935"><a href="#cb12-3935" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized closed by evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span id="cb12-3936"><a href="#cb12-3936" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_agg_cw <span class="ot">&lt;-</span> data_clsd_by_eval_date_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3937"><a href="#cb12-3937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eval_year, eval_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3938"><a href="#cb12-3938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3939"><a href="#cb12-3939" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-3940"><a href="#cb12-3940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-3941"><a href="#cb12-3941" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-3942"><a href="#cb12-3942" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_clsd_by_eval_date_agg_cw)</span>
<span id="cb12-3943"><a href="#cb12-3943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3944"><a href="#cb12-3944" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize all columns by calendar year</span></span>
<span id="cb12-3945"><a href="#cb12-3945" aria-hidden="true" tabindex="-1"></a>data_sev_trend_calendar <span class="ot">&lt;-</span> data_clsd_by_clsd_eval_date_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-3946"><a href="#cb12-3946" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, eval_year, eval_qtr, closed_w_pay_count, total_paid_loss_lae_net_of_s_s) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3947"><a href="#cb12-3947" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_clsd_by_eval_date_agg <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, eval_year, eval_qtr, total_paid_loss_lae_net_of_s_s, post_closure_total_paid_loss_lae_net_of_s_s), <span class="at">by =</span> <span class="fu">join_by</span>(state, eval_year, eval_qtr), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_clsdbyclsd"</span>, <span class="st">"_clsd"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3948"><a href="#cb12-3948" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">paid_loss =</span> total_paid_loss_lae_net_of_s_s_clsd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3949"><a href="#cb12-3949" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">paid_on_closed_loss =</span> total_paid_loss_lae_net_of_s_s_clsdbyclsd <span class="sc">+</span> post_closure_total_paid_loss_lae_net_of_s_s) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3950"><a href="#cb12-3950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(post_closure_total_paid_loss_lae_net_of_s_s, total_paid_loss_lae_net_of_s_s_clsdbyclsd)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3951"><a href="#cb12-3951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">27</span>, <span class="at">by =</span> state) <span class="sc">%&gt;%</span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span id="cb12-3952"><a href="#cb12-3952" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_sev_trend_agg} <span class="sc">%&gt;%</span> </span>
<span id="cb12-3953"><a href="#cb12-3953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3954"><a href="#cb12-3954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3955"><a href="#cb12-3955" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3956"><a href="#cb12-3956" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-3957"><a href="#cb12-3957" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3958"><a href="#cb12-3958" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-3959"><a href="#cb12-3959" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">calendar_quarter_ended =</span> <span class="fu">paste0</span>(eval_year, <span class="st">"-Q"</span>, eval_qtr),</span>
<span id="cb12-3960"><a href="#cb12-3960" aria-hidden="true" tabindex="-1"></a>               <span class="fu">across</span>(<span class="fu">c</span>(closed_w_pay_count, paid_loss, paid_on_closed_loss), \(col) roll<span class="sc">::</span><span class="fu">roll_sum</span>(col, <span class="at">width =</span> <span class="dv">4</span>)),</span>
<span id="cb12-3961"><a href="#cb12-3961" aria-hidden="true" tabindex="-1"></a>               <span class="at">paid_sev =</span> <span class="fu">ifelse</span>(closed_w_pay_count <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, paid_loss <span class="sc">/</span> closed_w_pay_count),</span>
<span id="cb12-3962"><a href="#cb12-3962" aria-hidden="true" tabindex="-1"></a>               <span class="at">paid_on_closed_sev =</span> <span class="fu">ifelse</span>(closed_w_pay_count <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, paid_on_closed_loss <span class="sc">/</span> closed_w_pay_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3963"><a href="#cb12-3963" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(calendar_quarter_ended, closed_w_pay_count, paid_loss, paid_sev, paid_on_closed_loss, paid_on_closed_sev) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3964"><a href="#cb12-3964" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-3965"><a href="#cb12-3965" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3966"><a href="#cb12-3966" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3967"><a href="#cb12-3967" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3968"><a href="#cb12-3968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3969"><a href="#cb12-3969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(calendar_quarter_ended, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-3970"><a href="#cb12-3970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3971"><a href="#cb12-3971" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span id="cb12-3972"><a href="#cb12-3972" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; paid severity</span></span>
<span id="cb12-3973"><a href="#cb12-3973" aria-hidden="true" tabindex="-1"></a>data_sev_trend_fits_a <span class="ot">&lt;-</span> data_sev_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-3974"><a href="#cb12-3974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3975"><a href="#cb12-3975" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3976"><a href="#cb12-3976" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3977"><a href="#cb12-3977" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-3978"><a href="#cb12-3978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3979"><a href="#cb12-3979" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"paid_sev"</span>)</span>
<span id="cb12-3980"><a href="#cb12-3980" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3981"><a href="#cb12-3981" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3982"><a href="#cb12-3982" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3983"><a href="#cb12-3983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3984"><a href="#cb12-3984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"paid_sev"</span>)</span>
<span id="cb12-3985"><a href="#cb12-3985" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; paid on closed severity</span></span>
<span id="cb12-3986"><a href="#cb12-3986" aria-hidden="true" tabindex="-1"></a>data_sev_trend_fits_b <span class="ot">&lt;-</span> data_sev_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-3987"><a href="#cb12-3987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3988"><a href="#cb12-3988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-3989"><a href="#cb12-3989" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-3990"><a href="#cb12-3990" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-3991"><a href="#cb12-3991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3992"><a href="#cb12-3992" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"paid_on_closed_sev"</span>)</span>
<span id="cb12-3993"><a href="#cb12-3993" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-3994"><a href="#cb12-3994" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-3995"><a href="#cb12-3995" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3996"><a href="#cb12-3996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3997"><a href="#cb12-3997" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"paid_on_closed_sev"</span>)</span>
<span id="cb12-3998"><a href="#cb12-3998" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine</span></span>
<span id="cb12-3999"><a href="#cb12-3999" aria-hidden="true" tabindex="-1"></a>data_sev_trend_fits <span class="ot">&lt;-</span> data_sev_trend_fits_a <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(data_sev_trend_fits_b, <span class="at">by =</span> <span class="fu">join_by</span>(state, pt))</span>
<span id="cb12-4000"><a href="#cb12-4000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4001"><a href="#cb12-4001" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate Countrywide selections</span></span>
<span id="cb12-4002"><a href="#cb12-4002" aria-hidden="true" tabindex="-1"></a>data_sev_trend_selected_cw <span class="ot">&lt;-</span> data_sev_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4003"><a href="#cb12-4003" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4004"><a href="#cb12-4004" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4005"><a href="#cb12-4005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4006"><a href="#cb12-4006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4007"><a href="#cb12-4007" aria-hidden="true" tabindex="-1"></a>         <span class="at">selected =</span> <span class="fl">0.14</span>,</span>
<span id="cb12-4008"><a href="#cb12-4008" aria-hidden="true" tabindex="-1"></a>         <span class="at">credibility_comp =</span> <span class="fl">0.02</span>,</span>
<span id="cb12-4009"><a href="#cb12-4009" aria-hidden="true" tabindex="-1"></a>         <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility))</span>
<span id="cb12-4010"><a href="#cb12-4010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4011"><a href="#cb12-4011" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate state selections and add back in Countrywide</span></span>
<span id="cb12-4012"><a href="#cb12-4012" aria-hidden="true" tabindex="-1"></a>data_sev_trend_selected <span class="ot">&lt;-</span> data_sev_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4013"><a href="#cb12-4013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4014"><a href="#cb12-4014" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>,</span>
<span id="cb12-4015"><a href="#cb12-4015" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4016"><a href="#cb12-4016" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> state,</span>
<span id="cb12-4017"><a href="#cb12-4017" aria-hidden="true" tabindex="-1"></a>            <span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4018"><a href="#cb12-4018" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selected =</span> <span class="fl">0.14</span>,</span>
<span id="cb12-4019"><a href="#cb12-4019" aria-hidden="true" tabindex="-1"></a>         <span class="at">credibility_comp =</span> data_sev_trend_selected_cw<span class="sc">$</span>z_wtd_selected,</span>
<span id="cb12-4020"><a href="#cb12-4020" aria-hidden="true" tabindex="-1"></a>         <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4021"><a href="#cb12-4021" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(data_sev_trend_selected_cw)</span>
<span id="cb12-4022"><a href="#cb12-4022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4023"><a href="#cb12-4023" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Indication ----</span></span>
<span id="cb12-4024"><a href="#cb12-4024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4025"><a href="#cb12-4025" aria-hidden="true" tabindex="-1"></a><span class="do">### Calculations</span></span>
<span id="cb12-4026"><a href="#cb12-4026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4027"><a href="#cb12-4027" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize needed items</span></span>
<span id="cb12-4028"><a href="#cb12-4028" aria-hidden="true" tabindex="-1"></a>selection_state <span class="ot">&lt;-</span> <span class="st">"California"</span></span>
<span id="cb12-4029"><a href="#cb12-4029" aria-hidden="true" tabindex="-1"></a>selection_data_ended <span class="ot">&lt;-</span> <span class="st">"2024-06-30"</span></span>
<span id="cb12-4030"><a href="#cb12-4030" aria-hidden="true" tabindex="-1"></a>selection_effective_date <span class="ot">&lt;-</span> <span class="st">"2025-02-04"</span></span>
<span id="cb12-4031"><a href="#cb12-4031" aria-hidden="true" tabindex="-1"></a>selection_lcm <span class="ot">&lt;-</span> <span class="fl">1.669</span></span>
<span id="cb12-4032"><a href="#cb12-4032" aria-hidden="true" tabindex="-1"></a>selection_underlying_plr <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> selection_lcm</span>
<span id="cb12-4033"><a href="#cb12-4033" aria-hidden="true" tabindex="-1"></a>selection_ay_weights <span class="ot">&lt;-</span> data_ult_loss_fiscal <span class="sc">%&gt;%</span> </span>
<span id="cb12-4034"><a href="#cb12-4034" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4035"><a href="#cb12-4035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(state, fiscal_year_ended) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4036"><a href="#cb12-4036" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">data.frame</span>(<span class="at">ay_weights =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.15</span>,<span class="fl">0.40</span>,<span class="fl">0.45</span>), <span class="fu">nrow</span>(.) <span class="sc">/</span> <span class="dv">5</span>)))</span>
<span id="cb12-4037"><a href="#cb12-4037" aria-hidden="true" tabindex="-1"></a>selection_ay_weights_cw <span class="ot">&lt;-</span> data_ult_loss_fiscal <span class="sc">%&gt;%</span> </span>
<span id="cb12-4038"><a href="#cb12-4038" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(fiscal_year_ended) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4039"><a href="#cb12-4039" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">data.frame</span>(<span class="at">ay_weights =</span> <span class="fu">c</span>(<span class="fl">0.10</span>,<span class="fl">0.15</span>,<span class="fl">0.20</span>,<span class="fl">0.25</span>,<span class="fl">0.30</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4040"><a href="#cb12-4040" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>)</span>
<span id="cb12-4041"><a href="#cb12-4041" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; shiny quark, can't use assign pipe</span></span>
<span id="cb12-4042"><a href="#cb12-4042" aria-hidden="true" tabindex="-1"></a>selection_ay_weights2 <span class="ot">&lt;-</span> selection_ay_weights <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(selection_ay_weights_cw)</span>
<span id="cb12-4043"><a href="#cb12-4043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4044"><a href="#cb12-4044" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate indication table</span></span>
<span id="cb12-4045"><a href="#cb12-4045" aria-hidden="true" tabindex="-1"></a>data_indication <span class="ot">&lt;-</span> data_premium_current_level_fiscal <span class="sc">%&gt;%</span> </span>
<span id="cb12-4046"><a href="#cb12-4046" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, fiscal_year_ended, current_level_earned_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4047"><a href="#cb12-4047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trend_time_premium =</span> </span>
<span id="cb12-4048"><a href="#cb12-4048" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-4049"><a href="#cb12-4049" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">12</span>,</span>
<span id="cb12-4050"><a href="#cb12-4050" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">24</span>,</span>
<span id="cb12-4051"><a href="#cb12-4051" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">36</span>,</span>
<span id="cb12-4052"><a href="#cb12-4052" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">48</span>,</span>
<span id="cb12-4053"><a href="#cb12-4053" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">60</span></span>
<span id="cb12-4054"><a href="#cb12-4054" aria-hidden="true" tabindex="-1"></a>           )) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4055"><a href="#cb12-4055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_premium_trend_selected <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, <span class="at">prem_trend_z_wtd_selected =</span> z_wtd_selected), <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4056"><a href="#cb12-4056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">premium_trend_factors =</span> prem_trend_z_wtd_selected <span class="sc">%&gt;%</span> </span>
<span id="cb12-4057"><a href="#cb12-4057" aria-hidden="true" tabindex="-1"></a>           <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4058"><a href="#cb12-4058" aria-hidden="true" tabindex="-1"></a>           <span class="co"># raise_to_power(interval(ymd(selection_data_ended) %m-% years(5),</span></span>
<span id="cb12-4059"><a href="#cb12-4059" aria-hidden="true" tabindex="-1"></a>           <span class="co">#                         ymd(selection_effective_date) %m+% months(6)) %&gt;% </span></span>
<span id="cb12-4060"><a href="#cb12-4060" aria-hidden="true" tabindex="-1"></a>           <span class="co">#                  divide_by(years(1))) %&gt;% # more accurate way</span></span>
<span id="cb12-4061"><a href="#cb12-4061" aria-hidden="true" tabindex="-1"></a>           <span class="fu">raise_to_power</span>(<span class="fu">subtract</span>(<span class="fu">ymd</span>(selection_effective_date) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">6</span>),</span>
<span id="cb12-4062"><a href="#cb12-4062" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">ymd</span>(selection_data_ended) <span class="sc">%m-%</span> <span class="fu">months</span>(trend_time_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4063"><a href="#cb12-4063" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">divide_by</span>(<span class="dv">365</span>) <span class="sc">%&gt;%</span> as.numeric), <span class="co"># equivalent to excel</span></span>
<span id="cb12-4064"><a href="#cb12-4064" aria-hidden="true" tabindex="-1"></a>         <span class="at">trended_current_level_earned_premium =</span> current_level_earned_premium <span class="sc">*</span> premium_trend_factors</span>
<span id="cb12-4065"><a href="#cb12-4065" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4066"><a href="#cb12-4066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ult_loss_fiscal <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, fiscal_year_ended, incurred_loss, implied_incurred_age_to_ult, ult_incurred_loss), <span class="fu">join_by</span>(state, fiscal_year_ended)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4067"><a href="#cb12-4067" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_freq_trend_selected <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, <span class="at">freq_trend_z_wtd_selected =</span> z_wtd_selected), <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4068"><a href="#cb12-4068" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_sev_trend_selected <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, <span class="at">sev_trend_z_wtd_selected =</span> z_wtd_selected), <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4069"><a href="#cb12-4069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trend_time_loss =</span> </span>
<span id="cb12-4070"><a href="#cb12-4070" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-4071"><a href="#cb12-4071" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">6</span>,</span>
<span id="cb12-4072"><a href="#cb12-4072" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">18</span>,</span>
<span id="cb12-4073"><a href="#cb12-4073" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">30</span>,</span>
<span id="cb12-4074"><a href="#cb12-4074" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">42</span>,</span>
<span id="cb12-4075"><a href="#cb12-4075" aria-hidden="true" tabindex="-1"></a>             <span class="fu">year</span>(<span class="fu">ymd</span>(selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">54</span></span>
<span id="cb12-4076"><a href="#cb12-4076" aria-hidden="true" tabindex="-1"></a>           ),</span>
<span id="cb12-4077"><a href="#cb12-4077" aria-hidden="true" tabindex="-1"></a>         <span class="at">loss_trend_factors =</span> freq_trend_z_wtd_selected <span class="sc">%&gt;%</span> </span>
<span id="cb12-4078"><a href="#cb12-4078" aria-hidden="true" tabindex="-1"></a>           <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4079"><a href="#cb12-4079" aria-hidden="true" tabindex="-1"></a>           <span class="fu">multiply_by</span>(sev_trend_z_wtd_selected </span>
<span id="cb12-4080"><a href="#cb12-4080" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="dv">1</span>))<span class="sc">%&gt;%</span> </span>
<span id="cb12-4081"><a href="#cb12-4081" aria-hidden="true" tabindex="-1"></a>           <span class="fu">raise_to_power</span>(<span class="fu">subtract</span>(<span class="fu">ymd</span>(selection_effective_date) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">12</span>),</span>
<span id="cb12-4082"><a href="#cb12-4082" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">ymd</span>(selection_data_ended) <span class="sc">%m-%</span> <span class="fu">months</span>(trend_time_loss)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4083"><a href="#cb12-4083" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">divide_by</span>(<span class="dv">365</span>) <span class="sc">%&gt;%</span> as.numeric),</span>
<span id="cb12-4084"><a href="#cb12-4084" aria-hidden="true" tabindex="-1"></a>         <span class="at">trended_ult_incurred_loss =</span> ult_incurred_loss <span class="sc">*</span> loss_trend_factors,</span>
<span id="cb12-4085"><a href="#cb12-4085" aria-hidden="true" tabindex="-1"></a>         <span class="at">trended_ult_incurred_partial_loss_ratio =</span> <span class="fu">ifelse</span>(trended_current_level_earned_premium <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, trended_ult_incurred_loss <span class="sc">/</span> trended_current_level_earned_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4086"><a href="#cb12-4086" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(selection_ay_weights2, <span class="at">by =</span> <span class="fu">join_by</span>(state, fiscal_year_ended))</span>
<span id="cb12-4087"><a href="#cb12-4087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4088"><a href="#cb12-4088" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate catastrophe ratios</span></span>
<span id="cb12-4089"><a href="#cb12-4089" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; statewide</span></span>
<span id="cb12-4090"><a href="#cb12-4090" aria-hidden="true" tabindex="-1"></a>data_cat <span class="ot">&lt;-</span> data_rms_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-4091"><a href="#cb12-4091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">modeled_hurricane_ratio =</span> rms_hurricane_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-4092"><a href="#cb12-4092" aria-hidden="true" tabindex="-1"></a>         <span class="at">.keep =</span> <span class="st">"unused"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4093"><a href="#cb12-4093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ts_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-4094"><a href="#cb12-4094" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">modeled_fire_following_earthquake_ratio =</span> touchstone_eq_fire_following_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-4095"><a href="#cb12-4095" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modeled_severe_convective_storm_ratio =</span> touchstone_severe_convective_storm_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-4096"><a href="#cb12-4096" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modeled_wildfire_ratio =</span> touchstone_wildfire_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-4097"><a href="#cb12-4097" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.keep =</span> <span class="st">"unused"</span>),</span>
<span id="cb12-4098"><a href="#cb12-4098" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(state))</span>
<span id="cb12-4099"><a href="#cb12-4099" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; Countrywide</span></span>
<span id="cb12-4100"><a href="#cb12-4100" aria-hidden="true" tabindex="-1"></a>data_cat_cw <span class="ot">&lt;-</span> data_rms_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-4101"><a href="#cb12-4101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">modeled_hurricane_ratio =</span> <span class="fu">sum</span>(rms_hurricane_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4102"><a href="#cb12-4102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4103"><a href="#cb12-4103" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4104"><a href="#cb12-4104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ts_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-4105"><a href="#cb12-4105" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(<span class="at">modeled_fire_following_earthquake_ratio =</span> <span class="fu">sum</span>(touchstone_eq_fire_following_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium),</span>
<span id="cb12-4106"><a href="#cb12-4106" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modeled_severe_convective_storm_ratio =</span> <span class="fu">sum</span>(touchstone_severe_convective_storm_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium),</span>
<span id="cb12-4107"><a href="#cb12-4107" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modeled_wildfire_ratio =</span> <span class="fu">sum</span>(touchstone_wildfire_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4108"><a href="#cb12-4108" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4109"><a href="#cb12-4109" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.before =</span> <span class="dv">1</span>),</span>
<span id="cb12-4110"><a href="#cb12-4110" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(state))</span>
<span id="cb12-4111"><a href="#cb12-4111" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine</span></span>
<span id="cb12-4112"><a href="#cb12-4112" aria-hidden="true" tabindex="-1"></a>data_cat <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_cat_cw) </span>
<span id="cb12-4113"><a href="#cb12-4113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4114"><a href="#cb12-4114" aria-hidden="true" tabindex="-1"></a><span class="co"># final indication calculations</span></span>
<span id="cb12-4115"><a href="#cb12-4115" aria-hidden="true" tabindex="-1"></a>data_indication2 <span class="ot">&lt;-</span> data_indication <span class="sc">%&gt;%</span> </span>
<span id="cb12-4116"><a href="#cb12-4116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4117"><a href="#cb12-4117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4118"><a href="#cb12-4118" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4119"><a href="#cb12-4119" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-4120"><a href="#cb12-4120" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb12-4121"><a href="#cb12-4121" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4122"><a href="#cb12-4122" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">trended_ult_incurred_partial_loss_ratio =</span> <span class="fu">replace_na</span>(trended_ult_incurred_partial_loss_ratio, <span class="dv">0</span>)) <span class="sc">%$%</span></span>
<span id="cb12-4123"><a href="#cb12-4123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">crossprod</span>(trended_ult_incurred_partial_loss_ratio, ay_weights) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4124"><a href="#cb12-4124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">ay_weighted_trended_ult_incurred_partial_loss_ratio =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4125"><a href="#cb12-4125" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-4126"><a href="#cb12-4126" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb12-4127"><a href="#cb12-4127" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4128"><a href="#cb12-4128" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4129"><a href="#cb12-4129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4130"><a href="#cb12-4130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ult_claim_count_fiscal <span class="sc">%&gt;%</span> </span>
<span id="cb12-4131"><a href="#cb12-4131" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(<span class="at">.by =</span> state, <span class="at">ult_incurred_claim_count =</span> <span class="fu">sum</span>(ult_incurred_claim_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4132"><a href="#cb12-4132" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4133"><a href="#cb12-4133" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">credibility =</span> ult_incurred_claim_count <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">1084</span>) <span class="sc">%&gt;%</span> sqrt <span class="sc">%&gt;%</span> <span class="fu">min</span>(., <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4134"><a href="#cb12-4134" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(state, credibility),</span>
<span id="cb12-4135"><a href="#cb12-4135" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4136"><a href="#cb12-4136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_cat, <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4137"><a href="#cb12-4137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4138"><a href="#cb12-4138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_modeled_peril_partial_loss_ratio =</span> <span class="fu">sum</span>(modeled_hurricane_ratio, modeled_fire_following_earthquake_ratio, modeled_severe_convective_storm_ratio, modeled_wildfire_ratio) <span class="sc">*</span> <span class="fl">1.15</span>,</span>
<span id="cb12-4139"><a href="#cb12-4139" aria-hidden="true" tabindex="-1"></a>  <span class="at">trended_underlying_plr_less_modeled_perils =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-4140"><a href="#cb12-4140" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> selection_underlying_plr <span class="sc">%&gt;%</span> </span>
<span id="cb12-4141"><a href="#cb12-4141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">subtract</span>(total_modeled_peril_partial_loss_ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4142"><a href="#cb12-4142" aria-hidden="true" tabindex="-1"></a>      <span class="fu">multiply_by</span>(data_freq_trend_selected_cw<span class="sc">$</span>selected <span class="sc">%&gt;%</span> </span>
<span id="cb12-4143"><a href="#cb12-4143" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">add</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4144"><a href="#cb12-4144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">multiply_by</span>(data_sev_trend_selected_cw<span class="sc">$</span>selected <span class="sc">%&gt;%</span> </span>
<span id="cb12-4145"><a href="#cb12-4145" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">add</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4146"><a href="#cb12-4146" aria-hidden="true" tabindex="-1"></a>      <span class="fu">divide_by</span>(data_premium_trend_selected_cw<span class="sc">$</span>selected <span class="sc">%&gt;%</span> </span>
<span id="cb12-4147"><a href="#cb12-4147" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">add</span>(<span class="dv">1</span>)),</span>
<span id="cb12-4148"><a href="#cb12-4148" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="cn">NA</span>),</span>
<span id="cb12-4149"><a href="#cb12-4149" aria-hidden="true" tabindex="-1"></a>    <span class="at">credibility_weighted_trended_ult_incurred_loss_ratio =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-4150"><a href="#cb12-4150" aria-hidden="true" tabindex="-1"></a>      state <span class="sc">==</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="sc">%&gt;%</span> </span>
<span id="cb12-4151"><a href="#cb12-4151" aria-hidden="true" tabindex="-1"></a>        <span class="fu">multiply_by</span>(credibility) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4152"><a href="#cb12-4152" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add</span>(trended_underlying_plr_less_modeled_perils <span class="sc">%&gt;%</span> </span>
<span id="cb12-4153"><a href="#cb12-4153" aria-hidden="true" tabindex="-1"></a>              <span class="fu">multiply_by</span>(<span class="dv">1</span> <span class="sc">%&gt;%</span> </span>
<span id="cb12-4154"><a href="#cb12-4154" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">subtract</span>(credibility))),</span>
<span id="cb12-4155"><a href="#cb12-4155" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="cn">NA</span>)</span>
<span id="cb12-4156"><a href="#cb12-4156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-4157"><a href="#cb12-4157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4158"><a href="#cb12-4158" aria-hidden="true" tabindex="-1"></a><span class="co"># set constant</span></span>
<span id="cb12-4159"><a href="#cb12-4159" aria-hidden="true" tabindex="-1"></a>credibility_weighted_trended_ult_incurred_loss_ratio_cw <span class="ot">&lt;-</span> data_indication2 <span class="sc">%&gt;%</span> </span>
<span id="cb12-4160"><a href="#cb12-4160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4161"><a href="#cb12-4161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(credibility_weighted_trended_ult_incurred_loss_ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4162"><a href="#cb12-4162" aria-hidden="true" tabindex="-1"></a>  as.numeric</span>
<span id="cb12-4163"><a href="#cb12-4163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4164"><a href="#cb12-4164" aria-hidden="true" tabindex="-1"></a><span class="co"># continue final indication calculations</span></span>
<span id="cb12-4165"><a href="#cb12-4165" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; shiny quark again</span></span>
<span id="cb12-4166"><a href="#cb12-4166" aria-hidden="true" tabindex="-1"></a>data_indication3 <span class="ot">&lt;-</span> data_indication2 <span class="sc">%&gt;%</span> </span>
<span id="cb12-4167"><a href="#cb12-4167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cw_ay_weighted_trended_ult_incurred_partial_loss_ratio =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-4168"><a href="#cb12-4168" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">!=</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> credibility_weighted_trended_ult_incurred_loss_ratio_cw,</span>
<span id="cb12-4169"><a href="#cb12-4169" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="cn">NA</span>),</span>
<span id="cb12-4170"><a href="#cb12-4170" aria-hidden="true" tabindex="-1"></a>    <span class="at">credibility_weighted_trended_ult_incurred_loss_ratio =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-4171"><a href="#cb12-4171" aria-hidden="true" tabindex="-1"></a>      state <span class="sc">!=</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="sc">%&gt;%</span> </span>
<span id="cb12-4172"><a href="#cb12-4172" aria-hidden="true" tabindex="-1"></a>        <span class="fu">multiply_by</span>(credibility) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4173"><a href="#cb12-4173" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add</span>(cw_ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="sc">%&gt;%</span> </span>
<span id="cb12-4174"><a href="#cb12-4174" aria-hidden="true" tabindex="-1"></a>              <span class="fu">multiply_by</span>(<span class="dv">1</span> <span class="sc">%&gt;%</span> </span>
<span id="cb12-4175"><a href="#cb12-4175" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">subtract</span>(credibility))),</span>
<span id="cb12-4176"><a href="#cb12-4176" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> credibility_weighted_trended_ult_incurred_loss_ratio</span>
<span id="cb12-4177"><a href="#cb12-4177" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb12-4178"><a href="#cb12-4178" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin_for_reinsurance =</span> <span class="dv">0</span>,</span>
<span id="cb12-4179"><a href="#cb12-4179" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_prospective_loss_ratio =</span> credibility_weighted_trended_ult_incurred_loss_ratio <span class="sc">+</span> total_modeled_peril_partial_loss_ratio <span class="sc">+</span> margin_for_reinsurance,</span>
<span id="cb12-4180"><a href="#cb12-4180" aria-hidden="true" tabindex="-1"></a>    <span class="at">permissable_loss_ratio =</span> <span class="fl">0.601</span>,</span>
<span id="cb12-4181"><a href="#cb12-4181" aria-hidden="true" tabindex="-1"></a>    <span class="at">indicated_rate_level_needed =</span> total_prospective_loss_ratio <span class="sc">/</span> permissable_loss_ratio <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb12-4182"><a href="#cb12-4182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4183"><a href="#cb12-4183" aria-hidden="true" tabindex="-1"></a><span class="do">### Display</span></span>
<span id="cb12-4184"><a href="#cb12-4184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4185"><a href="#cb12-4185" aria-hidden="true" tabindex="-1"></a>selection_eval_date <span class="ot">&lt;-</span> <span class="fu">ymd</span>(selection_data_ended) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">3</span>)</span>
<span id="cb12-4186"><a href="#cb12-4186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4187"><a href="#cb12-4187" aria-hidden="true" tabindex="-1"></a><span class="co"># output summary table</span></span>
<span id="cb12-4188"><a href="#cb12-4188" aria-hidden="true" tabindex="-1"></a><span class="fu">format_as_indication_summary</span>(<span class="at">data_ind =</span> data_indication, <span class="at">sel_state =</span> <span class="st">"Countrywide"</span>, <span class="at">sel_data_ended =</span> selection_data_ended, <span class="at">sel_eval_date =</span> selection_eval_date)</span>
<span id="cb12-4189"><a href="#cb12-4189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4190"><a href="#cb12-4190" aria-hidden="true" tabindex="-1"></a><span class="co"># organize, convert to long data, and reformat variable names for displaying</span></span>
<span id="cb12-4191"><a href="#cb12-4191" aria-hidden="true" tabindex="-1"></a>data_indication3_long <span class="ot">&lt;-</span> data_indication3 <span class="sc">%&gt;%</span> </span>
<span id="cb12-4192"><a href="#cb12-4192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, ay_weighted_trended_ult_incurred_partial_loss_ratio, credibility, trended_underlying_plr_less_modeled_perils, cw_ay_weighted_trended_ult_incurred_partial_loss_ratio, credibility_weighted_trended_ult_incurred_loss_ratio, <span class="fu">starts_with</span>(<span class="st">"modeled"</span>), total_modeled_peril_partial_loss_ratio, margin_for_reinsurance, total_prospective_loss_ratio, permissable_loss_ratio, indicated_rate_level_needed) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4193"><a href="#cb12-4193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-4194"><a href="#cb12-4194" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb12-4195"><a href="#cb12-4195" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4196"><a href="#cb12-4196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">variable_display =</span> </span>
<span id="cb12-4197"><a href="#cb12-4197" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-4198"><a href="#cb12-4198" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Accident year weighted trended ultimate incurred partial loss ratio:"</span>,</span>
<span id="cb12-4199"><a href="#cb12-4199" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"credibility"</span> <span class="sc">~</span> <span class="st">"Credibility (ultimate claims using 1,084 standard):"</span>,</span>
<span id="cb12-4200"><a href="#cb12-4200" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"trended_underlying_plr_less_modeled_perils"</span> <span class="sc">~</span> <span class="st">"Trended, underlying permissible loss ratio less modeled perils:"</span>,</span>
<span id="cb12-4201"><a href="#cb12-4201" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"cw_ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Countrywide accident year weighted trended ultimate ncurred partial loss + LAE ratio:"</span>,</span>
<span id="cb12-4202"><a href="#cb12-4202" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"credibility_weighted_trended_ult_incurred_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Credibility weighted trended ultimate incurred loss + LAE ratio:"</span>,</span>
<span id="cb12-4203"><a href="#cb12-4203" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"modeled_hurricane_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled hurricane ratio:"</span>,</span>
<span id="cb12-4204"><a href="#cb12-4204" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"modeled_fire_following_earthquake_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled fire following earthquake ratio:"</span>, </span>
<span id="cb12-4205"><a href="#cb12-4205" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"modeled_severe_convective_storm_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled severe convective storm ratio:"</span>,</span>
<span id="cb12-4206"><a href="#cb12-4206" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"modeled_wildfire_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled wildfire ratio:"</span>,</span>
<span id="cb12-4207"><a href="#cb12-4207" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"total_modeled_peril_partial_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Total modeled peril partial loss + LAE ratio (modeled ratios x 1.15 LAE factor):"</span>,</span>
<span id="cb12-4208"><a href="#cb12-4208" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"margin_for_reinsurance"</span> <span class="sc">~</span> <span class="st">"Margin for reinsurance:"</span>,</span>
<span id="cb12-4209"><a href="#cb12-4209" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"total_prospective_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Total prospective loss + LAE ratio:"</span>,</span>
<span id="cb12-4210"><a href="#cb12-4210" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"permissable_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Permissable loss + LAE ratio:"</span>,</span>
<span id="cb12-4211"><a href="#cb12-4211" aria-hidden="true" tabindex="-1"></a>             variable <span class="sc">==</span> <span class="st">"indicated_rate_level_needed"</span> <span class="sc">~</span> <span class="st">"Indicated rate level needed:"</span></span>
<span id="cb12-4212"><a href="#cb12-4212" aria-hidden="true" tabindex="-1"></a>           ),</span>
<span id="cb12-4213"><a href="#cb12-4213" aria-hidden="true" tabindex="-1"></a>         <span class="at">.after =</span> variable</span>
<span id="cb12-4214"><a href="#cb12-4214" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-4215"><a href="#cb12-4215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4216"><a href="#cb12-4216" aria-hidden="true" tabindex="-1"></a><span class="co"># output indication calculations table</span></span>
<span id="cb12-4217"><a href="#cb12-4217" aria-hidden="true" tabindex="-1"></a><span class="fu">format_as_indication_calculations</span>(<span class="at">data_ind3_long =</span> data_indication3_long, <span class="at">sel_state =</span> <span class="st">"Countrywide"</span>)</span>
<span id="cb12-4218"><a href="#cb12-4218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4219"><a href="#cb12-4219" aria-hidden="true" tabindex="-1"></a><span class="co"># output indication calculations supporting table</span></span>
<span id="cb12-4220"><a href="#cb12-4220" aria-hidden="true" tabindex="-1"></a><span class="fu">format_as_indication_calculations_support</span>(<span class="at">data_ind3_long =</span> data_indication3_long, <span class="at">sel_state =</span> <span class="st">"Countrywide"</span>)</span>
<span id="cb12-4221"><a href="#cb12-4221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4222"><a href="#cb12-4222" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Data checks ----</span></span>
<span id="cb12-4223"><a href="#cb12-4223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4224"><a href="#cb12-4224" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; paid loss triangle</span></span>
<span id="cb12-4225"><a href="#cb12-4225" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">summarize</span>(data_paid_loss_triangle, <span class="fu">across</span>(<span class="fu">where</span>(is.numeric), \(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb12-4226"><a href="#cb12-4226" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(y, <span class="st">"test.csv"</span>)</span>
<span id="cb12-4227"><a href="#cb12-4227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4228"><a href="#cb12-4228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-4229"><a href="#cb12-4229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4230"><a href="#cb12-4230" aria-hidden="true" tabindex="-1"></a><span class="fu">### Indications - app</span></span>
<span id="cb12-4231"><a href="#cb12-4231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4232"><a href="#cb12-4232" aria-hidden="true" tabindex="-1"></a><span class="al">![](files/indication-app.png)</span></span>
<span id="cb12-4233"><a href="#cb12-4233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4236"><a href="#cb12-4236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-4237"><a href="#cb12-4237" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Load packages ----</span></span>
<span id="cb12-4238"><a href="#cb12-4238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4239"><a href="#cb12-4239" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb12-4240"><a href="#cb12-4240" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb12-4241"><a href="#cb12-4241" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridlayout)</span>
<span id="cb12-4242"><a href="#cb12-4242" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bslib)</span>
<span id="cb12-4243"><a href="#cb12-4243" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb12-4244"><a href="#cb12-4244" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-4245"><a href="#cb12-4245" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb12-4246"><a href="#cb12-4246" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb12-4247"><a href="#cb12-4247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4248"><a href="#cb12-4248" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Functions ----</span></span>
<span id="cb12-4249"><a href="#cb12-4249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4250"><a href="#cb12-4250" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%!in%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">Negate</span>(<span class="st">"%in%"</span>)</span>
<span id="cb12-4251"><a href="#cb12-4251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4252"><a href="#cb12-4252" aria-hidden="true" tabindex="-1"></a><span class="co"># function to format long data as triangle</span></span>
<span id="cb12-4253"><a href="#cb12-4253" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span id="cb12-4254"><a href="#cb12-4254" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; n_periods = 28 --&gt; 7 years of data for triangle</span></span>
<span id="cb12-4255"><a href="#cb12-4255" aria-hidden="true" tabindex="-1"></a>format_bases_as_triangle <span class="ot">&lt;-</span> <span class="cf">function</span>(df_agg_age, var, <span class="at">ult_age =</span> <span class="dv">63</span>, <span class="at">n_periods =</span> <span class="dv">28</span>) {</span>
<span id="cb12-4256"><a href="#cb12-4256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4257"><a href="#cb12-4257" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">=</span> <span class="fu">enquo</span>(var)</span>
<span id="cb12-4258"><a href="#cb12-4258" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4259"><a href="#cb12-4259" aria-hidden="true" tabindex="-1"></a>  df_agg_age <span class="sc">%&lt;&gt;%</span>  </span>
<span id="cb12-4260"><a href="#cb12-4260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&lt;=</span> ult_age) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4261"><a href="#cb12-4261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">!!</span>var) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4262"><a href="#cb12-4262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> age,</span>
<span id="cb12-4263"><a href="#cb12-4263" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> <span class="sc">!!</span>var) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4264"><a href="#cb12-4264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(loss_year, <span class="st">"-Q"</span>, loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4265"><a href="#cb12-4265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(accident_quarter, <span class="fu">as.character</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">3</span>, <span class="at">to =</span> ult_age, <span class="at">by =</span> <span class="dv">3</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4266"><a href="#cb12-4266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_tail</span>(<span class="at">n =</span> n_periods) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4267"><a href="#cb12-4267" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-4268"><a href="#cb12-4268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4269"><a href="#cb12-4269" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4270"><a href="#cb12-4270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4271"><a href="#cb12-4271" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to calculate development factors</span></span>
<span id="cb12-4272"><a href="#cb12-4272" aria-hidden="true" tabindex="-1"></a>calculate_dev_factors <span class="ot">&lt;-</span> <span class="cf">function</span>(df_agg_age, var) {</span>
<span id="cb12-4273"><a href="#cb12-4273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4274"><a href="#cb12-4274" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">=</span> <span class="fu">enquo</span>(var)</span>
<span id="cb12-4275"><a href="#cb12-4275" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4276"><a href="#cb12-4276" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reduce input data to only needed columns</span></span>
<span id="cb12-4277"><a href="#cb12-4277" aria-hidden="true" tabindex="-1"></a>  df_agg_age <span class="sc">%&lt;&gt;%</span> <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">!!</span>var)</span>
<span id="cb12-4278"><a href="#cb12-4278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4279"><a href="#cb12-4279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup output dataframe</span></span>
<span id="cb12-4280"><a href="#cb12-4280" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb12-4281"><a href="#cb12-4281" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="fu">ncol</span>(df_agg_age) <span class="sc">+</span> <span class="dv">1</span>,                  </span>
<span id="cb12-4282"><a href="#cb12-4282" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> <span class="fu">nrow</span>(df_agg_age <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="co"># taking ratios, so one row less</span></span>
<span id="cb12-4283"><a href="#cb12-4283" aria-hidden="true" tabindex="-1"></a>    data.frame</span>
<span id="cb12-4284"><a href="#cb12-4284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_dev) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"loss_year"</span>,<span class="st">"loss_qtr"</span>, <span class="st">"left"</span>, <span class="st">"right"</span>, <span class="st">"dev_factor"</span>)</span>
<span id="cb12-4285"><a href="#cb12-4285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4286"><a href="#cb12-4286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate development factors</span></span>
<span id="cb12-4287"><a href="#cb12-4287" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_agg_age)<span class="sc">-</span><span class="dv">1</span>) {</span>
<span id="cb12-4288"><a href="#cb12-4288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4289"><a href="#cb12-4289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set constants</span></span>
<span id="cb12-4290"><a href="#cb12-4290" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">=</span> df_agg_age[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb12-4291"><a href="#cb12-4291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4292"><a href="#cb12-4292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set ratio column indicators</span></span>
<span id="cb12-4293"><a href="#cb12-4293" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">3</span>] <span class="ot">=</span> df_agg_age[i<span class="sc">+</span><span class="dv">1</span>,<span class="dv">3</span>]</span>
<span id="cb12-4294"><a href="#cb12-4294" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">4</span>] <span class="ot">=</span> df_agg_age[i,<span class="dv">3</span>]</span>
<span id="cb12-4295"><a href="#cb12-4295" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4296"><a href="#cb12-4296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate factor</span></span>
<span id="cb12-4297"><a href="#cb12-4297" aria-hidden="true" tabindex="-1"></a>    df_dev[i,<span class="dv">5</span>] <span class="ot">=</span> <span class="fu">ifelse</span>(df_agg_age[i,<span class="dv">4</span>] <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb12-4298"><a href="#cb12-4298" aria-hidden="true" tabindex="-1"></a>                         <span class="cn">NA</span>,</span>
<span id="cb12-4299"><a href="#cb12-4299" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">as.numeric</span>(df_agg_age[i<span class="sc">+</span><span class="dv">1</span>,<span class="dv">4</span>]) <span class="sc">/</span> <span class="fu">as.numeric</span>(df_agg_age[i,<span class="dv">4</span>]))</span>
<span id="cb12-4300"><a href="#cb12-4300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4301"><a href="#cb12-4301" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-4302"><a href="#cb12-4302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4303"><a href="#cb12-4303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove unwanted comparisons and format ratio indicator</span></span>
<span id="cb12-4304"><a href="#cb12-4304" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4305"><a href="#cb12-4305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(left <span class="sc">&gt;</span> right) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4306"><a href="#cb12-4306" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age_age =</span> <span class="fu">paste0</span>(left, <span class="st">":"</span>, right),</span>
<span id="cb12-4307"><a href="#cb12-4307" aria-hidden="true" tabindex="-1"></a>           <span class="at">.after =</span> <span class="dv">2</span>)</span>
<span id="cb12-4308"><a href="#cb12-4308" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4309"><a href="#cb12-4309" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="sc">%&gt;%</span> return</span>
<span id="cb12-4310"><a href="#cb12-4310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4311"><a href="#cb12-4311" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4312"><a href="#cb12-4312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4313"><a href="#cb12-4313" aria-hidden="true" tabindex="-1"></a><span class="co"># format loss development factors as triangle</span></span>
<span id="cb12-4314"><a href="#cb12-4314" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; assuming age to ultimate is 63 quarters</span></span>
<span id="cb12-4315"><a href="#cb12-4315" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; n_periods = 27 --&gt; 7 years of data for triangle</span></span>
<span id="cb12-4316"><a href="#cb12-4316" aria-hidden="true" tabindex="-1"></a>format_dev_factors_as_triangle <span class="ot">&lt;-</span> <span class="cf">function</span>(df_dev, <span class="at">ult_age =</span> <span class="dv">63</span>, <span class="at">n_periods =</span> <span class="dv">27</span>) {</span>
<span id="cb12-4317"><a href="#cb12-4317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4318"><a href="#cb12-4318" aria-hidden="true" tabindex="-1"></a>  df_dev <span class="sc">%&gt;%</span> </span>
<span id="cb12-4319"><a href="#cb12-4319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(left <span class="sc">&lt;=</span> ult_age) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4320"><a href="#cb12-4320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(left, right)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4321"><a href="#cb12-4321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> age_age,</span>
<span id="cb12-4322"><a href="#cb12-4322" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> dev_factor) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4323"><a href="#cb12-4323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(loss_year, <span class="st">"-Q"</span>, loss_qtr),</span>
<span id="cb12-4324"><a href="#cb12-4324" aria-hidden="true" tabindex="-1"></a>           <span class="st">"Ult:{{ult_age}}"</span> <span class="sc">:</span><span class="er">=</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4325"><a href="#cb12-4325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(accident_quarter, <span class="fu">as.character</span>(<span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">6</span>, <span class="at">to =</span> ult_age, <span class="at">by =</span> <span class="dv">3</span>),<span class="st">":"</span>, <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">3</span>, <span class="at">to =</span> ult_age<span class="dv">-3</span>, <span class="at">by =</span> <span class="dv">3</span>))), <span class="fu">paste0</span>(<span class="st">"Ult:"</span>, ult_age)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4326"><a href="#cb12-4326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_tail</span>(<span class="at">n =</span> n_periods) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4327"><a href="#cb12-4327" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-4328"><a href="#cb12-4328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4329"><a href="#cb12-4329" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4330"><a href="#cb12-4330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4331"><a href="#cb12-4331" aria-hidden="true" tabindex="-1"></a><span class="co"># define function to calculate weighted development factors</span></span>
<span id="cb12-4332"><a href="#cb12-4332" aria-hidden="true" tabindex="-1"></a>calculate_weighted_dev_factors <span class="ot">&lt;-</span> <span class="cf">function</span>(df_loss_tri, selects, <span class="at">ult_age =</span> <span class="dv">63</span>) {</span>
<span id="cb12-4333"><a href="#cb12-4333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4334"><a href="#cb12-4334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup output dataframe</span></span>
<span id="cb12-4335"><a href="#cb12-4335" aria-hidden="true" tabindex="-1"></a>  df_weights <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb12-4336"><a href="#cb12-4336" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ncol =</span> <span class="fu">ncol</span>(df_loss_tri),                  </span>
<span id="cb12-4337"><a href="#cb12-4337" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-4338"><a href="#cb12-4338" aria-hidden="true" tabindex="-1"></a>    data.frame</span>
<span id="cb12-4339"><a href="#cb12-4339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_weights) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">6</span>, <span class="at">to =</span> ult_age, <span class="at">by =</span> <span class="dv">3</span>),<span class="st">":"</span>, <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">3</span>, <span class="at">to =</span> ult_age<span class="dv">-3</span>, <span class="at">by =</span> <span class="dv">3</span>)), <span class="fu">paste0</span>(<span class="st">"Ult:"</span>, ult_age))</span>
<span id="cb12-4340"><a href="#cb12-4340" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4341"><a href="#cb12-4341" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set constants</span></span>
<span id="cb12-4342"><a href="#cb12-4342" aria-hidden="true" tabindex="-1"></a>  df_weights<span class="sc">$</span>id <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">8</span>, <span class="at">to =</span> <span class="dv">16</span>, <span class="at">by =</span> <span class="dv">4</span>), <span class="st">" pts wtd"</span>)</span>
<span id="cb12-4343"><a href="#cb12-4343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4344"><a href="#cb12-4344" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculated weighted development factors</span></span>
<span id="cb12-4345"><a href="#cb12-4345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_weights)) {</span>
<span id="cb12-4346"><a href="#cb12-4346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4347"><a href="#cb12-4347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set number of periods to look back (i.e. weight)</span></span>
<span id="cb12-4348"><a href="#cb12-4348" aria-hidden="true" tabindex="-1"></a>    weight <span class="ot">=</span> df_weights[i,<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(., <span class="dv">1</span>, <span class="fu">str_locate</span>(., <span class="st">" pts"</span>)[<span class="dv">1</span>]<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb12-4349"><a href="#cb12-4349" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4350"><a href="#cb12-4350" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(df_weights)<span class="sc">-</span><span class="dv">1</span>)) {</span>
<span id="cb12-4351"><a href="#cb12-4351" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4352"><a href="#cb12-4352" aria-hidden="true" tabindex="-1"></a>      <span class="co"># figure out number of periods with data in triangle for the larger age</span></span>
<span id="cb12-4353"><a href="#cb12-4353" aria-hidden="true" tabindex="-1"></a>      data_count <span class="ot">=</span> <span class="fu">nrow</span>(df_loss_tri) <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(df_loss_tri[,j<span class="sc">+</span><span class="dv">1</span>]))</span>
<span id="cb12-4354"><a href="#cb12-4354" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4355"><a href="#cb12-4355" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate X-pts weighted ratio</span></span>
<span id="cb12-4356"><a href="#cb12-4356" aria-hidden="true" tabindex="-1"></a>      df_weights[i,j] <span class="ot">=</span> df_loss_tri <span class="sc">%&gt;%</span> </span>
<span id="cb12-4357"><a href="#cb12-4357" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4358"><a href="#cb12-4358" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">between</span>(row_num, data_count <span class="sc">-</span> weight <span class="sc">+</span> <span class="dv">1</span>, data_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4359"><a href="#cb12-4359" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="dv">1</span>, j, j<span class="sc">+</span><span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4360"><a href="#cb12-4360" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">col_j =</span> <span class="dv">2</span>, <span class="at">col_j_minus_1 =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4361"><a href="#cb12-4361" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(<span class="fu">sum</span>(col_j_minus_1) <span class="sc">/</span> <span class="fu">sum</span>(col_j))</span>
<span id="cb12-4362"><a href="#cb12-4362" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4363"><a href="#cb12-4363" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-4364"><a href="#cb12-4364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4365"><a href="#cb12-4365" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-4366"><a href="#cb12-4366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4367"><a href="#cb12-4367" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create dataframe of selects for each age:age</span></span>
<span id="cb12-4368"><a href="#cb12-4368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; need to organize so can correctly calculate in next step</span></span>
<span id="cb12-4369"><a href="#cb12-4369" aria-hidden="true" tabindex="-1"></a>  df_selects <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">age_age =</span> <span class="fu">colnames</span>(df_weights)[<span class="sc">-</span><span class="dv">1</span>], <span class="at">selected =</span> selects) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4370"><a href="#cb12-4370" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4371"><a href="#cb12-4371" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(row_num))</span>
<span id="cb12-4372"><a href="#cb12-4372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4373"><a href="#cb12-4373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate cumulative selects "backwards"</span></span>
<span id="cb12-4374"><a href="#cb12-4374" aria-hidden="true" tabindex="-1"></a>  selects_cumulative <span class="ot">=</span> df_selects<span class="sc">$</span>selected <span class="sc">%&gt;%</span> cumprod</span>
<span id="cb12-4375"><a href="#cb12-4375" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4376"><a href="#cb12-4376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append calculated factors and reorganize</span></span>
<span id="cb12-4377"><a href="#cb12-4377" aria-hidden="true" tabindex="-1"></a>  df_selects <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4378"><a href="#cb12-4378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">selects =</span> <span class="fu">data.frame</span>(<span class="at">cumulative =</span> selects_cumulative)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4379"><a href="#cb12-4379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(row_num) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4380"><a href="#cb12-4380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>row_num) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4381"><a href="#cb12-4381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4382"><a href="#cb12-4382" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span> </span>
<span id="cb12-4383"><a href="#cb12-4383" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb12-4384"><a href="#cb12-4384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>()</span>
<span id="cb12-4385"><a href="#cb12-4385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_selects) <span class="ot">=</span> <span class="fu">colnames</span>(df_weights)</span>
<span id="cb12-4386"><a href="#cb12-4386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4387"><a href="#cb12-4387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine dataframes</span></span>
<span id="cb12-4388"><a href="#cb12-4388" aria-hidden="true" tabindex="-1"></a>  df_weights <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4389"><a href="#cb12-4389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(df_selects)</span>
<span id="cb12-4390"><a href="#cb12-4390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4391"><a href="#cb12-4391" aria-hidden="true" tabindex="-1"></a>  df_weights <span class="sc">%&gt;%</span> return</span>
<span id="cb12-4392"><a href="#cb12-4392" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4393"><a href="#cb12-4393" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4394"><a href="#cb12-4394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4395"><a href="#cb12-4395" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate ultimate incurred</span></span>
<span id="cb12-4396"><a href="#cb12-4396" aria-hidden="true" tabindex="-1"></a>calculate_ultimate_incurred <span class="ot">&lt;-</span> <span class="cf">function</span>(df_agg, df_selects, var) {</span>
<span id="cb12-4397"><a href="#cb12-4397" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4398"><a href="#cb12-4398" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract cumulative select factors</span></span>
<span id="cb12-4399"><a href="#cb12-4399" aria-hidden="true" tabindex="-1"></a>  cumlative_selects <span class="ot">=</span> df_selects <span class="sc">%&gt;%</span> </span>
<span id="cb12-4400"><a href="#cb12-4400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> <span class="st">"cumulative"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4401"><a href="#cb12-4401" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4402"><a href="#cb12-4402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb12-4403"><a href="#cb12-4403" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"age_age"</span>,</span>
<span id="cb12-4404"><a href="#cb12-4404" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"cumulative_factor"</span>)</span>
<span id="cb12-4405"><a href="#cb12-4405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4406"><a href="#cb12-4406" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorganize summary table for appending cumulative selects</span></span>
<span id="cb12-4407"><a href="#cb12-4407" aria-hidden="true" tabindex="-1"></a>  df_agg <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4408"><a href="#cb12-4408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(state, <span class="fu">desc</span>(loss_year), <span class="fu">desc</span>(loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4409"><a href="#cb12-4409" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(state, loss_year, loss_qtr, <span class="fu">any_of</span>(var))</span>
<span id="cb12-4410"><a href="#cb12-4410" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4411"><a href="#cb12-4411" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append cumulative selects, organize data, and calculate new column</span></span>
<span id="cb12-4412"><a href="#cb12-4412" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; fill rest of values with NA</span></span>
<span id="cb12-4413"><a href="#cb12-4413" aria-hidden="true" tabindex="-1"></a>  df_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4414"><a href="#cb12-4414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4415"><a href="#cb12-4415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4416"><a href="#cb12-4416" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4417"><a href="#cb12-4417" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> \(data) {</span>
<span id="cb12-4418"><a href="#cb12-4418" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4419"><a href="#cb12-4419" aria-hidden="true" tabindex="-1"></a>        data<span class="sc">$</span>factor <span class="ot">&lt;-</span> <span class="fu">c</span>(cumlative_selects<span class="sc">$</span>cumulative_factor, <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(data) <span class="sc">-</span> <span class="fu">nrow</span>(cumlative_selects)))</span>
<span id="cb12-4420"><a href="#cb12-4420" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4421"><a href="#cb12-4421" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&gt;%</span> return</span>
<span id="cb12-4422"><a href="#cb12-4422" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4423"><a href="#cb12-4423" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb12-4424"><a href="#cb12-4424" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4425"><a href="#cb12-4425" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4426"><a href="#cb12-4426" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(state, loss_year, loss_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4427"><a href="#cb12-4427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(factor)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4428"><a href="#cb12-4428" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(loss_year, <span class="st">"-Q"</span>, loss_qtr),</span>
<span id="cb12-4429"><a href="#cb12-4429" aria-hidden="true" tabindex="-1"></a>           <span class="at">ult_incurred =</span> <span class="sc">!!</span><span class="fu">sym</span>(var) <span class="sc">*</span> factor) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4430"><a href="#cb12-4430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(state, accident_quarter, <span class="at">incurred =</span> <span class="fu">any_of</span>(var), factor, ult_incurred) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4431"><a href="#cb12-4431" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-4432"><a href="#cb12-4432" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4433"><a href="#cb12-4433" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4434"><a href="#cb12-4434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4435"><a href="#cb12-4435" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by fiscal year</span></span>
<span id="cb12-4436"><a href="#cb12-4436" aria-hidden="true" tabindex="-1"></a>summarize_by_fiscal_year <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb12-4437"><a href="#cb12-4437" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4438"><a href="#cb12-4438" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4439"><a href="#cb12-4439" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">var1 =</span> <span class="dv">3</span>, <span class="at">factor =</span> <span class="dv">4</span>, <span class="at">var2 =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="co"># standardize names</span></span>
<span id="cb12-4440"><a href="#cb12-4440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4441"><a href="#cb12-4441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4442"><a href="#cb12-4442" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4443"><a href="#cb12-4443" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> \(data) {</span>
<span id="cb12-4444"><a href="#cb12-4444" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4445"><a href="#cb12-4445" aria-hidden="true" tabindex="-1"></a>        <span class="co"># drop most recent period, calculate rolling sum by fiscal year, calculate factor, and organize</span></span>
<span id="cb12-4446"><a href="#cb12-4446" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4447"><a href="#cb12-4447" aria-hidden="true" tabindex="-1"></a>          <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4448"><a href="#cb12-4448" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">var1_cumulative =</span> roll<span class="sc">::</span><span class="fu">roll_sum</span>(var1, <span class="at">width =</span> <span class="dv">4</span>),</span>
<span id="cb12-4449"><a href="#cb12-4449" aria-hidden="true" tabindex="-1"></a>                 <span class="at">var2_cumulative =</span> roll<span class="sc">::</span><span class="fu">roll_sum</span>(var2, <span class="at">width =</span> <span class="dv">4</span>),</span>
<span id="cb12-4450"><a href="#cb12-4450" aria-hidden="true" tabindex="-1"></a>                 <span class="at">factor =</span> <span class="fu">ifelse</span>(var1_cumulative <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, var2_cumulative <span class="sc">/</span> var1_cumulative),</span>
<span id="cb12-4451"><a href="#cb12-4451" aria-hidden="true" tabindex="-1"></a>                 <span class="at">quarter =</span> <span class="fu">str_sub</span>(accident_quarter, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb12-4452"><a href="#cb12-4452" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4453"><a href="#cb12-4453" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get most recent quarter to work from</span></span>
<span id="cb12-4454"><a href="#cb12-4454" aria-hidden="true" tabindex="-1"></a>        ref_qtr <span class="ot">=</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4455"><a href="#cb12-4455" aria-hidden="true" tabindex="-1"></a>          <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4456"><a href="#cb12-4456" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(quarter) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4457"><a href="#cb12-4457" aria-hidden="true" tabindex="-1"></a>          as.numeric</span>
<span id="cb12-4458"><a href="#cb12-4458" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4459"><a href="#cb12-4459" aria-hidden="true" tabindex="-1"></a>        <span class="co"># keep only relevant periods</span></span>
<span id="cb12-4460"><a href="#cb12-4460" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4461"><a href="#cb12-4461" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(quarter <span class="sc">==</span> ref_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4462"><a href="#cb12-4462" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(<span class="at">fiscal_year_ended =</span> accident_quarter, var1_cumulative, factor, var2_cumulative) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4463"><a href="#cb12-4463" aria-hidden="true" tabindex="-1"></a>          return</span>
<span id="cb12-4464"><a href="#cb12-4464" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4465"><a href="#cb12-4465" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb12-4466"><a href="#cb12-4466" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-4467"><a href="#cb12-4467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4468"><a href="#cb12-4468" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set NAs to Countrywide values</span></span>
<span id="cb12-4469"><a href="#cb12-4469" aria-hidden="true" tabindex="-1"></a>  df_cw <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb12-4470"><a href="#cb12-4470" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4471"><a href="#cb12-4471" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4472"><a href="#cb12-4472" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fiscal_year_ended, factor)</span>
<span id="cb12-4473"><a href="#cb12-4473" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4474"><a href="#cb12-4474" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use Countrywide values if NA for state factors and organize data</span></span>
<span id="cb12-4475"><a href="#cb12-4475" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb12-4476"><a href="#cb12-4476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4477"><a href="#cb12-4477" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4478"><a href="#cb12-4478" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> \(data, df_cw) {</span>
<span id="cb12-4479"><a href="#cb12-4479" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4480"><a href="#cb12-4480" aria-hidden="true" tabindex="-1"></a>        data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4481"><a href="#cb12-4481" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(df_cw,</span>
<span id="cb12-4482"><a href="#cb12-4482" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="fu">join_by</span>(fiscal_year_ended),</span>
<span id="cb12-4483"><a href="#cb12-4483" aria-hidden="true" tabindex="-1"></a>                    <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_st"</span>, <span class="st">"_cw"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4484"><a href="#cb12-4484" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">factor =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(factor_st), factor_cw, factor_st)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4485"><a href="#cb12-4485" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(fiscal_year_ended, var1_cumulative, factor, var2_cumulative)</span>
<span id="cb12-4486"><a href="#cb12-4486" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-4487"><a href="#cb12-4487" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb12-4488"><a href="#cb12-4488" aria-hidden="true" tabindex="-1"></a>      df_cw)</span>
<span id="cb12-4489"><a href="#cb12-4489" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4490"><a href="#cb12-4490" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4491"><a href="#cb12-4491" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-4492"><a href="#cb12-4492" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4493"><a href="#cb12-4493" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4494"><a href="#cb12-4494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4495"><a href="#cb12-4495" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate the final step of the trending (x is a vector of two fits)</span></span>
<span id="cb12-4496"><a href="#cb12-4496" aria-hidden="true" tabindex="-1"></a>calculate_final_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-4497"><a href="#cb12-4497" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4498"><a href="#cb12-4498" aria-hidden="true" tabindex="-1"></a>  x[<span class="dv">2</span>] <span class="sc">/</span> x[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-4499"><a href="#cb12-4499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4500"><a href="#cb12-4500" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4501"><a href="#cb12-4501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4502"><a href="#cb12-4502" aria-hidden="true" tabindex="-1"></a><span class="co"># function calculated weighted fits</span></span>
<span id="cb12-4503"><a href="#cb12-4503" aria-hidden="true" tabindex="-1"></a>calculate_weighted_fits <span class="ot">&lt;-</span> <span class="cf">function</span>(df_calendar, var) {</span>
<span id="cb12-4504"><a href="#cb12-4504" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4505"><a href="#cb12-4505" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize needed items</span></span>
<span id="cb12-4506"><a href="#cb12-4506" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">8</span>, <span class="at">to =</span> <span class="dv">24</span>, <span class="at">by =</span> <span class="dv">4</span>)</span>
<span id="cb12-4507"><a href="#cb12-4507" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(pts))</span>
<span id="cb12-4508"><a href="#cb12-4508" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb12-4509"><a href="#cb12-4509" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4510"><a href="#cb12-4510" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop through different weights (fits)</span></span>
<span id="cb12-4511"><a href="#cb12-4511" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x <span class="cf">in</span> pts) {</span>
<span id="cb12-4512"><a href="#cb12-4512" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4513"><a href="#cb12-4513" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reassign full dataset</span></span>
<span id="cb12-4514"><a href="#cb12-4514" aria-hidden="true" tabindex="-1"></a>    df_temp <span class="ot">=</span> df_calendar</span>
<span id="cb12-4515"><a href="#cb12-4515" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4516"><a href="#cb12-4516" aria-hidden="true" tabindex="-1"></a>    <span class="co"># limit dataset and calculate fit</span></span>
<span id="cb12-4517"><a href="#cb12-4517" aria-hidden="true" tabindex="-1"></a>    df_temp <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4518"><a href="#cb12-4518" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">24</span>) <span class="sc">%&gt;%</span> <span class="co"># skip periods where cumulative sum isn't full</span></span>
<span id="cb12-4519"><a href="#cb12-4519" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> <span class="co"># set Xs</span></span>
<span id="cb12-4520"><a href="#cb12-4520" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> x)</span>
<span id="cb12-4521"><a href="#cb12-4521" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4522"><a href="#cb12-4522" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">is.na</span>(df_temp <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="fu">any_of</span>(var)))) <span class="sc">==</span> <span class="fu">nrow</span>(df_temp)) { <span class="co"># if no data, stop don't calculate anything</span></span>
<span id="cb12-4523"><a href="#cb12-4523" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4524"><a href="#cb12-4524" aria-hidden="true" tabindex="-1"></a>      fits[j] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb12-4525"><a href="#cb12-4525" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4526"><a href="#cb12-4526" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb12-4527"><a href="#cb12-4527" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4528"><a href="#cb12-4528" aria-hidden="true" tabindex="-1"></a>      fits[j] <span class="ot">=</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb12-4529"><a href="#cb12-4529" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lm</span>(<span class="fu">paste0</span>(var, <span class="st">" ~ i"</span>) <span class="sc">%&gt;%</span> as.formula, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4530"><a href="#cb12-4530" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict</span>(<span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">i =</span> <span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">24</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4531"><a href="#cb12-4531" aria-hidden="true" tabindex="-1"></a>        calculate_final_fit</span>
<span id="cb12-4532"><a href="#cb12-4532" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4533"><a href="#cb12-4533" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-4534"><a href="#cb12-4534" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4535"><a href="#cb12-4535" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">=</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-4536"><a href="#cb12-4536" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4537"><a href="#cb12-4537" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-4538"><a href="#cb12-4538" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4539"><a href="#cb12-4539" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorganize</span></span>
<span id="cb12-4540"><a href="#cb12-4540" aria-hidden="true" tabindex="-1"></a>  fits <span class="sc">%&lt;&gt;%</span> </span>
<span id="cb12-4541"><a href="#cb12-4541" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb12-4542"><a href="#cb12-4542" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span> </span>
<span id="cb12-4543"><a href="#cb12-4543" aria-hidden="true" tabindex="-1"></a>    data.frame</span>
<span id="cb12-4544"><a href="#cb12-4544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(fits) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">8</span>, <span class="at">to =</span> <span class="dv">24</span>, <span class="at">by =</span> <span class="dv">4</span>), <span class="st">" pt"</span>)</span>
<span id="cb12-4545"><a href="#cb12-4545" aria-hidden="true" tabindex="-1"></a>  fits <span class="sc">%&gt;%</span> </span>
<span id="cb12-4546"><a href="#cb12-4546" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), \(x) <span class="fu">ifelse</span>(<span class="fu">is.nan</span>(x), <span class="cn">NA</span>, x))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4547"><a href="#cb12-4547" aria-hidden="true" tabindex="-1"></a>    return</span>
<span id="cb12-4548"><a href="#cb12-4548" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4549"><a href="#cb12-4549" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4550"><a href="#cb12-4550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4551"><a href="#cb12-4551" aria-hidden="true" tabindex="-1"></a><span class="co"># function to output indication summary table</span></span>
<span id="cb12-4552"><a href="#cb12-4552" aria-hidden="true" tabindex="-1"></a>format_as_indication_summary <span class="ot">&lt;-</span> <span class="cf">function</span>(data_ind, sel_state, sel_data_ended, sel_eval_date) {</span>
<span id="cb12-4553"><a href="#cb12-4553" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4554"><a href="#cb12-4554" aria-hidden="true" tabindex="-1"></a>  data_ind <span class="sc">%&gt;%</span> </span>
<span id="cb12-4555"><a href="#cb12-4555" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> sel_state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4556"><a href="#cb12-4556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fiscal_year_ended,current_level_earned_premium, premium_trend_factors, trended_current_level_earned_premium, incurred_loss, implied_incurred_age_to_ult, ult_incurred_loss, loss_trend_factors, trended_ult_incurred_loss, trended_ult_incurred_partial_loss_ratio, ay_weights) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4557"><a href="#cb12-4557" aria-hidden="true" tabindex="-1"></a>    gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-4558"><a href="#cb12-4558" aria-hidden="true" tabindex="-1"></a>    <span class="fu">opt_stylize</span>(<span class="at">style =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4559"><a href="#cb12-4559" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="fu">paste0</span>(<span class="st">"**"</span>, sel_state, <span class="st">" indications**"</span>)),</span>
<span id="cb12-4560"><a href="#cb12-4560" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="fu">md</span>(<span class="fu">paste0</span>(<span class="st">"**Calendar / accident year data ended "</span>, <span class="fu">month</span>(sel_data_ended, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">FALSE</span>), <span class="st">" "</span>, <span class="fu">day</span>(sel_data_ended), <span class="st">", "</span>, <span class="fu">year</span>(sel_data_ended), <span class="st">" as of "</span>, <span class="fu">month</span>(sel_eval_date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">FALSE</span>), <span class="st">" "</span>, <span class="fu">day</span>(sel_eval_date), <span class="st">", "</span>, <span class="fu">year</span>(sel_eval_date), <span class="st">"**"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4561"><a href="#cb12-4561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_label</span>(<span class="at">fiscal_year_ended =</span> <span class="st">"Year ended"</span>,</span>
<span id="cb12-4562"><a href="#cb12-4562" aria-hidden="true" tabindex="-1"></a>               <span class="at">current_level_earned_premium =</span> <span class="st">"Current level earned premium"</span>,</span>
<span id="cb12-4563"><a href="#cb12-4563" aria-hidden="true" tabindex="-1"></a>               <span class="at">premium_trend_factors =</span> <span class="st">"Premium trend factors"</span>,</span>
<span id="cb12-4564"><a href="#cb12-4564" aria-hidden="true" tabindex="-1"></a>               <span class="at">trended_current_level_earned_premium =</span> <span class="st">"Trended current level earned poremium"</span>,</span>
<span id="cb12-4565"><a href="#cb12-4565" aria-hidden="true" tabindex="-1"></a>               <span class="at">incurred_loss =</span> <span class="st">"Non-cat incurred loss + LAE"</span>,</span>
<span id="cb12-4566"><a href="#cb12-4566" aria-hidden="true" tabindex="-1"></a>               <span class="at">implied_incurred_age_to_ult =</span> <span class="st">"Loss development factors"</span>,</span>
<span id="cb12-4567"><a href="#cb12-4567" aria-hidden="true" tabindex="-1"></a>               <span class="at">ult_incurred_loss =</span> <span class="st">"Ultimate non-cat incurred loss + LAE"</span>,</span>
<span id="cb12-4568"><a href="#cb12-4568" aria-hidden="true" tabindex="-1"></a>               <span class="at">loss_trend_factors =</span> <span class="st">"Loss trend factors"</span>,</span>
<span id="cb12-4569"><a href="#cb12-4569" aria-hidden="true" tabindex="-1"></a>               <span class="at">trended_ult_incurred_loss =</span> <span class="st">"Trended ultimate non-cat incurred loss + lae"</span>,</span>
<span id="cb12-4570"><a href="#cb12-4570" aria-hidden="true" tabindex="-1"></a>               <span class="at">trended_ult_incurred_partial_loss_ratio =</span> <span class="st">"Trended ultimate non-cat incurred parial loss + LAE ratio"</span>,</span>
<span id="cb12-4571"><a href="#cb12-4571" aria-hidden="true" tabindex="-1"></a>               <span class="at">ay_weights =</span> <span class="st">"Accident year weights"</span></span>
<span id="cb12-4572"><a href="#cb12-4572" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-4573"><a href="#cb12-4573" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(current_level_earned_premium, trended_current_level_earned_premium, incurred_loss, ult_incurred_loss, trended_ult_incurred_loss),</span>
<span id="cb12-4574"><a href="#cb12-4574" aria-hidden="true" tabindex="-1"></a>               <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4575"><a href="#cb12-4575" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(premium_trend_factors, implied_incurred_age_to_ult, loss_trend_factors),</span>
<span id="cb12-4576"><a href="#cb12-4576" aria-hidden="true" tabindex="-1"></a>               <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4577"><a href="#cb12-4577" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="fu">c</span>(trended_ult_incurred_partial_loss_ratio, ay_weights),</span>
<span id="cb12-4578"><a href="#cb12-4578" aria-hidden="true" tabindex="-1"></a>                <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-4579"><a href="#cb12-4579" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4580"><a href="#cb12-4580" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4581"><a href="#cb12-4581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4582"><a href="#cb12-4582" aria-hidden="true" tabindex="-1"></a><span class="co"># function to output indication calculations table</span></span>
<span id="cb12-4583"><a href="#cb12-4583" aria-hidden="true" tabindex="-1"></a>format_as_indication_calculations <span class="ot">&lt;-</span> <span class="cf">function</span>(data_ind3_long, sel_state) {</span>
<span id="cb12-4584"><a href="#cb12-4584" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4585"><a href="#cb12-4585" aria-hidden="true" tabindex="-1"></a>  data_ind3_long <span class="sc">%&gt;%</span> </span>
<span id="cb12-4586"><a href="#cb12-4586" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> sel_state,</span>
<span id="cb12-4587"><a href="#cb12-4587" aria-hidden="true" tabindex="-1"></a>           variable <span class="sc">%!in%</span> <span class="fu">c</span>(<span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4588"><a href="#cb12-4588" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4589"><a href="#cb12-4589" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(variable_display, value) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4590"><a href="#cb12-4590" aria-hidden="true" tabindex="-1"></a>    gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-4591"><a href="#cb12-4591" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_options</span>(<span class="at">column_labels.hidden =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4592"><a href="#cb12-4592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> variable_display, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4593"><a href="#cb12-4593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> value, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4594"><a href="#cb12-4594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> value, <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4595"><a href="#cb12-4595" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb12-4596"><a href="#cb12-4596" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb12-4597"><a href="#cb12-4597" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>)</span>
<span id="cb12-4598"><a href="#cb12-4598" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-4599"><a href="#cb12-4599" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_body</span>(</span>
<span id="cb12-4600"><a href="#cb12-4600" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> <span class="fu">c</span>(variable_display, value),</span>
<span id="cb12-4601"><a href="#cb12-4601" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> variable_display <span class="sc">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span id="cb12-4602"><a href="#cb12-4602" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-4603"><a href="#cb12-4603" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4604"><a href="#cb12-4604" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_style</span>(</span>
<span id="cb12-4605"><a href="#cb12-4605" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">list</span>(</span>
<span id="cb12-4606"><a href="#cb12-4606" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cell_fill</span>(<span class="at">color =</span> <span class="st">"orange"</span>)</span>
<span id="cb12-4607"><a href="#cb12-4607" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-4608"><a href="#cb12-4608" aria-hidden="true" tabindex="-1"></a>      <span class="at">locations =</span> <span class="fu">cells_body</span>(</span>
<span id="cb12-4609"><a href="#cb12-4609" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> value,</span>
<span id="cb12-4610"><a href="#cb12-4610" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> variable_display <span class="sc">==</span> <span class="st">"Indicated rate level needed:"</span></span>
<span id="cb12-4611"><a href="#cb12-4611" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-4612"><a href="#cb12-4612" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-4613"><a href="#cb12-4613" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4614"><a href="#cb12-4614" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4615"><a href="#cb12-4615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4616"><a href="#cb12-4616" aria-hidden="true" tabindex="-1"></a><span class="co"># function to output supporting table of indication calculations</span></span>
<span id="cb12-4617"><a href="#cb12-4617" aria-hidden="true" tabindex="-1"></a>format_as_indication_calculations_support <span class="ot">&lt;-</span> <span class="cf">function</span>(data_ind3_long, sel_state) {</span>
<span id="cb12-4618"><a href="#cb12-4618" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4619"><a href="#cb12-4619" aria-hidden="true" tabindex="-1"></a>  data_ind3_long <span class="sc">%&gt;%</span> </span>
<span id="cb12-4620"><a href="#cb12-4620" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> sel_state,</span>
<span id="cb12-4621"><a href="#cb12-4621" aria-hidden="true" tabindex="-1"></a>           variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"modeled_hurricane_ratio"</span>, <span class="st">"modeled_fire_following_earthquake_ratio"</span>, <span class="st">"modeled_severe_convective_storm_ratio"</span>, <span class="st">"modeled_wildfire_ratio"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4622"><a href="#cb12-4622" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4623"><a href="#cb12-4623" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(variable_display, value) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4624"><a href="#cb12-4624" aria-hidden="true" tabindex="-1"></a>    gt <span class="sc">%&gt;%</span> </span>
<span id="cb12-4625"><a href="#cb12-4625" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_options</span>(<span class="at">column_labels.hidden =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4626"><a href="#cb12-4626" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> variable_display, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4627"><a href="#cb12-4627" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_align</span>(<span class="at">columns =</span> value, <span class="at">align =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4628"><a href="#cb12-4628" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> value, <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb12-4629"><a href="#cb12-4629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4630"><a href="#cb12-4630" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-4631"><a href="#cb12-4631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4632"><a href="#cb12-4632" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Read in and create data ----</span></span>
<span id="cb12-4633"><a href="#cb12-4633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4634"><a href="#cb12-4634" aria-hidden="true" tabindex="-1"></a><span class="co"># read in data from access process</span></span>
<span id="cb12-4635"><a href="#cb12-4635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4636"><a href="#cb12-4636" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; premium data</span></span>
<span id="cb12-4637"><a href="#cb12-4637" aria-hidden="true" tabindex="-1"></a>data_premium_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"PremiumData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4638"><a href="#cb12-4638" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4639"><a href="#cb12-4639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">qtr =</span> quarter)</span>
<span id="cb12-4640"><a href="#cb12-4640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4641"><a href="#cb12-4641" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; loss data</span></span>
<span id="cb12-4642"><a href="#cb12-4642" aria-hidden="true" tabindex="-1"></a>data_loss_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"LossData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4643"><a href="#cb12-4643" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4644"><a href="#cb12-4644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"qtr"</span>), as.numeric))</span>
<span id="cb12-4645"><a href="#cb12-4645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4646"><a href="#cb12-4646" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; reported frequency data</span></span>
<span id="cb12-4647"><a href="#cb12-4647" aria-hidden="true" tabindex="-1"></a>data_rept_freq_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"ReptFreqData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4648"><a href="#cb12-4648" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4649"><a href="#cb12-4649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"qtr"</span>), as.numeric))</span>
<span id="cb12-4650"><a href="#cb12-4650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4651"><a href="#cb12-4651" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; closed by closed evaluation data</span></span>
<span id="cb12-4652"><a href="#cb12-4652" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span>  <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"ClsdByClsdEvalDt"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4653"><a href="#cb12-4653" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4654"><a href="#cb12-4654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eval_qtr =</span> <span class="fu">as.numeric</span>(eval_qtr))</span>
<span id="cb12-4655"><a href="#cb12-4655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4656"><a href="#cb12-4656" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; closed by evaluation data</span></span>
<span id="cb12-4657"><a href="#cb12-4657" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_raw <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"ClsdByEvalDt"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4658"><a href="#cb12-4658" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4659"><a href="#cb12-4659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eval_qtr =</span> <span class="fu">as.numeric</span>(eval_qtr))</span>
<span id="cb12-4660"><a href="#cb12-4660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4661"><a href="#cb12-4661" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; RMS modeled loss</span></span>
<span id="cb12-4662"><a href="#cb12-4662" aria-hidden="true" tabindex="-1"></a>data_rms_modeled_loss <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RMSModLoss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4663"><a href="#cb12-4663" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb12-4664"><a href="#cb12-4664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4665"><a href="#cb12-4665" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; TS modeled loss</span></span>
<span id="cb12-4666"><a href="#cb12-4666" aria-hidden="true" tabindex="-1"></a>data_ts_modeled_loss <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"indication-data-2024-q2-eval-2024-q3.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"TSModLoss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4667"><a href="#cb12-4667" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb12-4668"><a href="#cb12-4668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4669"><a href="#cb12-4669" aria-hidden="true" tabindex="-1"></a><span class="co"># single out vectors</span></span>
<span id="cb12-4670"><a href="#cb12-4670" aria-hidden="true" tabindex="-1"></a>vec_states <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_premium_raw<span class="sc">$</span>state) <span class="co"># use premium data to capture all states</span></span>
<span id="cb12-4671"><a href="#cb12-4671" aria-hidden="true" tabindex="-1"></a>vec_loss_years <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>loss_year)</span>
<span id="cb12-4672"><a href="#cb12-4672" aria-hidden="true" tabindex="-1"></a>vec_loss_qtrs <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>loss_qtr)</span>
<span id="cb12-4673"><a href="#cb12-4673" aria-hidden="true" tabindex="-1"></a>vec_eval_years <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>eval_year)</span>
<span id="cb12-4674"><a href="#cb12-4674" aria-hidden="true" tabindex="-1"></a>vec_eval_qtrs <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_loss_raw<span class="sc">$</span>eval_qtr)</span>
<span id="cb12-4675"><a href="#cb12-4675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4676"><a href="#cb12-4676" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataset of all possible combos, then add the needed combos for the most recent year</span></span>
<span id="cb12-4677"><a href="#cb12-4677" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; this is so that later in the process, data has rows of zero rather than no row if no losses were in that particular period</span></span>
<span id="cb12-4678"><a href="#cb12-4678" aria-hidden="true" tabindex="-1"></a>data_all_combos <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(vec_states, vec_loss_years, vec_loss_qtrs, vec_eval_years, vec_eval_qtrs) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4679"><a href="#cb12-4679" aria-hidden="true" tabindex="-1"></a>  data.frame</span>
<span id="cb12-4680"><a href="#cb12-4680" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_all_combos) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"loss_year"</span>, <span class="st">"loss_qtr"</span>, <span class="st">"eval_year"</span>, <span class="st">"eval_qtr"</span>)</span>
<span id="cb12-4681"><a href="#cb12-4681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4682"><a href="#cb12-4682" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only valid periods</span></span>
<span id="cb12-4683"><a href="#cb12-4683" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; set current eval quarter</span></span>
<span id="cb12-4684"><a href="#cb12-4684" aria-hidden="true" tabindex="-1"></a>cur_eval_qtr <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb12-4685"><a href="#cb12-4685" aria-hidden="true" tabindex="-1"></a>data_all_combos <span class="sc">%&lt;&gt;%</span></span>
<span id="cb12-4686"><a href="#cb12-4686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loss_year <span class="sc">&lt;=</span> eval_year) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4687"><a href="#cb12-4687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, loss_year, loss_qtr, eval_year, eval_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4688"><a href="#cb12-4688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">keep =</span> </span>
<span id="cb12-4689"><a href="#cb12-4689" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb12-4690"><a href="#cb12-4690" aria-hidden="true" tabindex="-1"></a>             loss_year <span class="sc">==</span> eval_year <span class="sc">&amp;</span> loss_qtr <span class="sc">&gt;</span> eval_qtr <span class="sc">~</span> <span class="dv">0</span>, <span class="co"># illogical periods</span></span>
<span id="cb12-4691"><a href="#cb12-4691" aria-hidden="true" tabindex="-1"></a>             loss_year <span class="sc">==</span> <span class="fu">max</span>(loss_year) <span class="sc">&amp;</span> loss_qtr <span class="sc">&gt;</span> cur_eval_qtr <span class="sc">~</span> <span class="dv">0</span>, <span class="co"># future periods</span></span>
<span id="cb12-4692"><a href="#cb12-4692" aria-hidden="true" tabindex="-1"></a>             eval_year <span class="sc">==</span> <span class="fu">max</span>(eval_year) <span class="sc">&amp;</span> eval_qtr <span class="sc">&gt;</span> cur_eval_qtr <span class="sc">~</span> <span class="dv">0</span>, <span class="co"># future periods</span></span>
<span id="cb12-4693"><a href="#cb12-4693" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> <span class="dv">1</span></span>
<span id="cb12-4694"><a href="#cb12-4694" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb12-4695"><a href="#cb12-4695" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4696"><a href="#cb12-4696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(keep <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4697"><a href="#cb12-4697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>keep)</span>
<span id="cb12-4698"><a href="#cb12-4698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4699"><a href="#cb12-4699" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Modify data ----</span></span>
<span id="cb12-4700"><a href="#cb12-4700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4701"><a href="#cb12-4701" aria-hidden="true" tabindex="-1"></a><span class="co"># premium data</span></span>
<span id="cb12-4702"><a href="#cb12-4702" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to premium data</span></span>
<span id="cb12-4703"><a href="#cb12-4703" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span id="cb12-4704"><a href="#cb12-4704" aria-hidden="true" tabindex="-1"></a>data_premium_agg <span class="ot">&lt;-</span> data_premium_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-4705"><a href="#cb12-4705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(state, loss_year, loss_qtr), <span class="at">by =</span> <span class="fu">join_by</span>(state, year <span class="sc">==</span> loss_year, qtr <span class="sc">==</span> loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4706"><a href="#cb12-4706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, year, qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4707"><a href="#cb12-4707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-4708"><a href="#cb12-4708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4709"><a href="#cb12-4709" aria-hidden="true" tabindex="-1"></a><span class="co"># loss data</span></span>
<span id="cb12-4710"><a href="#cb12-4710" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to loss data</span></span>
<span id="cb12-4711"><a href="#cb12-4711" aria-hidden="true" tabindex="-1"></a>data_loss_raw2 <span class="ot">&lt;-</span> data_loss_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-4712"><a href="#cb12-4712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos, <span class="at">by =</span> <span class="fu">join_by</span>(state, loss_year, loss_qtr, eval_year, eval_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4713"><a href="#cb12-4713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, loss_year, loss_qtr, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4714"><a href="#cb12-4714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-4715"><a href="#cb12-4715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4716"><a href="#cb12-4716" aria-hidden="true" tabindex="-1"></a><span class="co"># create age variable</span></span>
<span id="cb12-4717"><a href="#cb12-4717" aria-hidden="true" tabindex="-1"></a>data_loss <span class="ot">&lt;-</span> data_loss_raw2 <span class="sc">%&gt;%</span> </span>
<span id="cb12-4718"><a href="#cb12-4718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> (eval_year <span class="sc">-</span> loss_year) <span class="sc">*</span> <span class="dv">12</span> <span class="sc">+</span> (eval_qtr <span class="sc">-</span> loss_qtr) <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">3</span>, <span class="co"># evaluating in same quarter as loss counts as 3 months of development</span></span>
<span id="cb12-4719"><a href="#cb12-4719" aria-hidden="true" tabindex="-1"></a>         <span class="at">paid_loss_plus_lae =</span> paid_loss <span class="sc">+</span> paid_lae <span class="sc">+</span> <span class="sc">-</span>subrogation_salvage,</span>
<span id="cb12-4720"><a href="#cb12-4720" aria-hidden="true" tabindex="-1"></a>         <span class="at">incurred_loss =</span> paid_loss_plus_lae <span class="sc">+</span> case_reserve <span class="sc">+</span> expense_reserve,</span>
<span id="cb12-4721"><a href="#cb12-4721" aria-hidden="true" tabindex="-1"></a>         <span class="at">incurred_claim_count =</span> cwp_count <span class="sc">+</span> open_count) </span>
<span id="cb12-4722"><a href="#cb12-4722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4723"><a href="#cb12-4723" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized loss data by state and overall (cw)</span></span>
<span id="cb12-4724"><a href="#cb12-4724" aria-hidden="true" tabindex="-1"></a>data_loss_agg_age_cw <span class="ot">&lt;-</span> data_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-4725"><a href="#cb12-4725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(state, loss_year, loss_qtr, age),</span>
<span id="cb12-4726"><a href="#cb12-4726" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(paid_loss_plus_lae, incurred_loss, incurred_claim_count), \(x) <span class="fu">sum</span>(x,<span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4727"><a href="#cb12-4727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, loss_year, loss_qtr, age) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4728"><a href="#cb12-4728" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_loss_agg_age_st} <span class="sc">%&gt;%</span> </span>
<span id="cb12-4729"><a href="#cb12-4729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> <span class="fu">c</span>(loss_year, loss_qtr, age),</span>
<span id="cb12-4730"><a href="#cb12-4730" aria-hidden="true" tabindex="-1"></a>            <span class="fu">across</span>(<span class="fu">c</span>(paid_loss_plus_lae, incurred_loss, incurred_claim_count), \(x) <span class="fu">sum</span>(x,<span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb12-4731"><a href="#cb12-4731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4732"><a href="#cb12-4732" aria-hidden="true" tabindex="-1"></a><span class="co"># assumption of number of months to ultimate loss</span></span>
<span id="cb12-4733"><a href="#cb12-4733" aria-hidden="true" tabindex="-1"></a>ult_age <span class="ot">&lt;-</span> <span class="dv">63</span></span>
<span id="cb12-4734"><a href="#cb12-4734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4735"><a href="#cb12-4735" aria-hidden="true" tabindex="-1"></a><span class="co"># reported frequency data</span></span>
<span id="cb12-4736"><a href="#cb12-4736" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to loss data</span></span>
<span id="cb12-4737"><a href="#cb12-4737" aria-hidden="true" tabindex="-1"></a>data_rept_freq_raw2 <span class="ot">&lt;-</span> data_rept_freq_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-4738"><a href="#cb12-4738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos, <span class="at">by =</span> <span class="fu">join_by</span>(state, rept_year <span class="sc">==</span> loss_year, rept_qtr <span class="sc">==</span> loss_qtr, eval_year, eval_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4739"><a href="#cb12-4739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, rept_year, rept_qtr, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4740"><a href="#cb12-4740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-4741"><a href="#cb12-4741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4742"><a href="#cb12-4742" aria-hidden="true" tabindex="-1"></a><span class="co"># closed by closed evaluation date data</span></span>
<span id="cb12-4743"><a href="#cb12-4743" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to premium data</span></span>
<span id="cb12-4744"><a href="#cb12-4744" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span id="cb12-4745"><a href="#cb12-4745" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_agg <span class="ot">&lt;-</span> data_clsd_by_clsd_eval_date_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-4746"><a href="#cb12-4746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(state, loss_year, loss_qtr), <span class="at">by =</span> <span class="fu">join_by</span>(state, eval_year <span class="sc">==</span> loss_year, eval_qtr <span class="sc">==</span> loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4747"><a href="#cb12-4747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4748"><a href="#cb12-4748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-4749"><a href="#cb12-4749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4750"><a href="#cb12-4750" aria-hidden="true" tabindex="-1"></a><span class="co"># closed by evaluation date data</span></span>
<span id="cb12-4751"><a href="#cb12-4751" aria-hidden="true" tabindex="-1"></a><span class="co"># add placeholder rows to premium data</span></span>
<span id="cb12-4752"><a href="#cb12-4752" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; note raw data is already aggregated</span></span>
<span id="cb12-4753"><a href="#cb12-4753" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_agg <span class="ot">&lt;-</span> data_clsd_by_eval_date_raw <span class="sc">%&gt;%</span> </span>
<span id="cb12-4754"><a href="#cb12-4754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(data_all_combos <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(state, loss_year, loss_qtr), <span class="at">by =</span> <span class="fu">join_by</span>(state, eval_year <span class="sc">==</span> loss_year, eval_qtr <span class="sc">==</span> loss_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4755"><a href="#cb12-4755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(state, eval_year, eval_qtr) <span class="sc">%&gt;%</span>  </span>
<span id="cb12-4756"><a href="#cb12-4756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>)</span>
<span id="cb12-4757"><a href="#cb12-4757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4758"><a href="#cb12-4758" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Premium trend ----</span></span>
<span id="cb12-4759"><a href="#cb12-4759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4760"><a href="#cb12-4760" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized premium data overall (cw) and then combine</span></span>
<span id="cb12-4761"><a href="#cb12-4761" aria-hidden="true" tabindex="-1"></a>data_premium_agg_cw <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4762"><a href="#cb12-4762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4763"><a href="#cb12-4763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4764"><a href="#cb12-4764" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-4765"><a href="#cb12-4765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4766"><a href="#cb12-4766" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-4767"><a href="#cb12-4767" aria-hidden="true" tabindex="-1"></a>data_premium_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_premium_agg_cw)</span>
<span id="cb12-4768"><a href="#cb12-4768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4769"><a href="#cb12-4769" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize all columns by calendar year</span></span>
<span id="cb12-4770"><a href="#cb12-4770" aria-hidden="true" tabindex="-1"></a>data_premium_trend_calendar <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4771"><a href="#cb12-4771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, year, qtr, on_level_earned_premium, earned_exposure) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4772"><a href="#cb12-4772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">27</span>, <span class="at">by =</span> state) <span class="sc">%&gt;%</span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span id="cb12-4773"><a href="#cb12-4773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4774"><a href="#cb12-4774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4775"><a href="#cb12-4775" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4776"><a href="#cb12-4776" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-4777"><a href="#cb12-4777" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4778"><a href="#cb12-4778" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4779"><a href="#cb12-4779" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">calendar_quarter_ended =</span> <span class="fu">paste0</span>(year,<span class="st">"-Q"</span>, qtr),</span>
<span id="cb12-4780"><a href="#cb12-4780" aria-hidden="true" tabindex="-1"></a>               <span class="fu">across</span>(<span class="fu">c</span>(on_level_earned_premium, earned_exposure), \(col) roll<span class="sc">::</span><span class="fu">roll_sum</span>(col, <span class="at">width =</span> <span class="dv">4</span>)),</span>
<span id="cb12-4781"><a href="#cb12-4781" aria-hidden="true" tabindex="-1"></a>               <span class="at">average_premium =</span> <span class="fu">ifelse</span>(earned_exposure <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, on_level_earned_premium <span class="sc">/</span> earned_exposure)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4782"><a href="#cb12-4782" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(year, qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4783"><a href="#cb12-4783" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-4784"><a href="#cb12-4784" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4785"><a href="#cb12-4785" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4786"><a href="#cb12-4786" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4787"><a href="#cb12-4787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4788"><a href="#cb12-4788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(calendar_quarter_ended, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-4789"><a href="#cb12-4789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4790"><a href="#cb12-4790" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate weighted fits</span></span>
<span id="cb12-4791"><a href="#cb12-4791" aria-hidden="true" tabindex="-1"></a>data_prem_trend_fits <span class="ot">&lt;-</span> data_premium_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-4792"><a href="#cb12-4792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4793"><a href="#cb12-4793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4794"><a href="#cb12-4794" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4795"><a href="#cb12-4795" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-4796"><a href="#cb12-4796" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4797"><a href="#cb12-4797" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"average_premium"</span>)</span>
<span id="cb12-4798"><a href="#cb12-4798" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4799"><a href="#cb12-4799" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4800"><a href="#cb12-4800" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4801"><a href="#cb12-4801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4802"><a href="#cb12-4802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"average_premium"</span>)</span>
<span id="cb12-4803"><a href="#cb12-4803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4804"><a href="#cb12-4804" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Current level earned premium ----</span></span>
<span id="cb12-4805"><a href="#cb12-4805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4806"><a href="#cb12-4806" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate current level factor</span></span>
<span id="cb12-4807"><a href="#cb12-4807" aria-hidden="true" tabindex="-1"></a>data_premium_current_level <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4808"><a href="#cb12-4808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">accident_quarter =</span> <span class="fu">paste0</span>(year, <span class="st">"-Q"</span>, qtr),</span>
<span id="cb12-4809"><a href="#cb12-4809" aria-hidden="true" tabindex="-1"></a>         <span class="at">current_level_factor =</span> earned_premium <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, on_level_earned_premium <span class="sc">/</span> earned_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4810"><a href="#cb12-4810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, accident_quarter, earned_premium, current_level_factor, on_level_earned_premium) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4811"><a href="#cb12-4811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">21</span>, <span class="at">by =</span> state) <span class="co"># 5 years of data + 1 quarter</span></span>
<span id="cb12-4812"><a href="#cb12-4812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4813"><a href="#cb12-4813" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data by fiscal year</span></span>
<span id="cb12-4814"><a href="#cb12-4814" aria-hidden="true" tabindex="-1"></a>data_premium_current_level_fiscal <span class="ot">&lt;-</span> <span class="fu">summarize_by_fiscal_year</span>(<span class="at">df =</span> data_premium_current_level) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4815"><a href="#cb12-4815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">earned_premium =</span> var1_cumulative, <span class="at">current_level_factor =</span> factor, <span class="at">current_level_earned_premium =</span> var2_cumulative)</span>
<span id="cb12-4816"><a href="#cb12-4816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4817"><a href="#cb12-4817" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Paid loss ----</span></span>
<span id="cb12-4818"><a href="#cb12-4818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4819"><a href="#cb12-4819" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-4820"><a href="#cb12-4820" aria-hidden="true" tabindex="-1"></a>data_paid_loss_triangle <span class="ot">&lt;-</span> <span class="fu">format_bases_as_triangle</span>(<span class="at">df_agg_age =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"paid_loss_plus_lae"</span>)</span>
<span id="cb12-4821"><a href="#cb12-4821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4822"><a href="#cb12-4822" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate development factors</span></span>
<span id="cb12-4823"><a href="#cb12-4823" aria-hidden="true" tabindex="-1"></a>data_paid_loss_dev <span class="ot">&lt;-</span> <span class="fu">calculate_dev_factors</span>(<span class="at">df_agg_age =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"paid_loss_plus_lae"</span>)</span>
<span id="cb12-4824"><a href="#cb12-4824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4825"><a href="#cb12-4825" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-4826"><a href="#cb12-4826" aria-hidden="true" tabindex="-1"></a>data_paid_loss_dev_triangle <span class="ot">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span>(<span class="at">df_dev =</span> data_paid_loss_dev)</span>
<span id="cb12-4827"><a href="#cb12-4827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4828"><a href="#cb12-4828" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Incurred loss ----</span></span>
<span id="cb12-4829"><a href="#cb12-4829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4830"><a href="#cb12-4830" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-4831"><a href="#cb12-4831" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_triangle <span class="ot">&lt;-</span> <span class="fu">format_bases_as_triangle</span>(<span class="at">df_agg_age =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_loss"</span>)</span>
<span id="cb12-4832"><a href="#cb12-4832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4833"><a href="#cb12-4833" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate development factors</span></span>
<span id="cb12-4834"><a href="#cb12-4834" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_dev <span class="ot">&lt;-</span> <span class="fu">calculate_dev_factors</span>(<span class="at">df_agg =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_loss"</span>)</span>
<span id="cb12-4835"><a href="#cb12-4835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4836"><a href="#cb12-4836" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-4837"><a href="#cb12-4837" aria-hidden="true" tabindex="-1"></a>data_incurred_loss_dev_triangle <span class="ot">&lt;-</span> <span class="fu">format_dev_factors_as_triangle</span>(<span class="at">df_dev =</span> data_incurred_loss_dev)</span>
<span id="cb12-4838"><a href="#cb12-4838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4839"><a href="#cb12-4839" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Incurred claim count ----</span></span>
<span id="cb12-4840"><a href="#cb12-4840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4841"><a href="#cb12-4841" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-4842"><a href="#cb12-4842" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_triangle <span class="ot">&lt;-</span> <span class="fu">format_bases_as_triangle</span>(<span class="at">df_agg =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_claim_count"</span>)</span>
<span id="cb12-4843"><a href="#cb12-4843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4844"><a href="#cb12-4844" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate development factors</span></span>
<span id="cb12-4845"><a href="#cb12-4845" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_dev <span class="ot">&lt;-</span> <span class="fu">calculate_dev_factors</span>(<span class="at">df_agg =</span> data_loss_agg_age_cw, <span class="at">var =</span> <span class="st">"incurred_claim_count"</span>)</span>
<span id="cb12-4846"><a href="#cb12-4846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4847"><a href="#cb12-4847" aria-hidden="true" tabindex="-1"></a><span class="co"># format as triangle</span></span>
<span id="cb12-4848"><a href="#cb12-4848" aria-hidden="true" tabindex="-1"></a>data_incurred_claim_count_dev_triangle <span class="ot">&lt;-</span>  <span class="fu">format_dev_factors_as_triangle</span>(<span class="at">df_dev =</span> data_incurred_claim_count_dev)</span>
<span id="cb12-4849"><a href="#cb12-4849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4850"><a href="#cb12-4850" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Ultimate ----</span></span>
<span id="cb12-4851"><a href="#cb12-4851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4852"><a href="#cb12-4852" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize data</span></span>
<span id="cb12-4853"><a href="#cb12-4853" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; create summarized loss data (accident quarter) by state, then overall (cw), and then combine</span></span>
<span id="cb12-4854"><a href="#cb12-4854" aria-hidden="true" tabindex="-1"></a>data_loss_agg <span class="ot">&lt;-</span> data_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-4855"><a href="#cb12-4855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eval_year <span class="sc">==</span> <span class="fu">max</span>(eval_year)) <span class="sc">%&gt;%</span> <span class="co"># only use rows in most recent evaluation period</span></span>
<span id="cb12-4856"><a href="#cb12-4856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eval_qtr <span class="sc">==</span> <span class="fu">max</span>(eval_qtr)) <span class="sc">%&gt;%</span> <span class="co"># -&gt; this makes it accident quarter</span></span>
<span id="cb12-4857"><a href="#cb12-4857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, loss_year, loss_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4858"><a href="#cb12-4858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"incurred"</span>), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4859"><a href="#cb12-4859" aria-hidden="true" tabindex="-1"></a>  ungroup</span>
<span id="cb12-4860"><a href="#cb12-4860" aria-hidden="true" tabindex="-1"></a>data_loss_agg_cw <span class="ot">&lt;-</span> data_loss_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4861"><a href="#cb12-4861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(loss_year, loss_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4862"><a href="#cb12-4862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"incurred"</span>), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4863"><a href="#cb12-4863" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-4864"><a href="#cb12-4864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4865"><a href="#cb12-4865" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-4866"><a href="#cb12-4866" aria-hidden="true" tabindex="-1"></a>data_loss_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_loss_agg_cw)</span>
<span id="cb12-4867"><a href="#cb12-4867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4868"><a href="#cb12-4868" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Frequency trend ----</span></span>
<span id="cb12-4869"><a href="#cb12-4869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4870"><a href="#cb12-4870" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized loss data (calendar quarter) by state, then overall (cw), and then combine</span></span>
<span id="cb12-4871"><a href="#cb12-4871" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; data is already only using the most recent evaluation period</span></span>
<span id="cb12-4872"><a href="#cb12-4872" aria-hidden="true" tabindex="-1"></a>data_rept_freq_agg <span class="ot">&lt;-</span> data_rept_freq_raw2 <span class="sc">%&gt;%</span> </span>
<span id="cb12-4873"><a href="#cb12-4873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, rept_year, rept_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4874"><a href="#cb12-4874" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">reported_count =</span> <span class="fu">sum</span>(reported_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4875"><a href="#cb12-4875" aria-hidden="true" tabindex="-1"></a>  ungroup</span>
<span id="cb12-4876"><a href="#cb12-4876" aria-hidden="true" tabindex="-1"></a>data_rept_freq_agg_cw <span class="ot">&lt;-</span> data_rept_freq_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4877"><a href="#cb12-4877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rept_year, rept_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4878"><a href="#cb12-4878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">reported_count =</span> <span class="fu">sum</span>(reported_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4879"><a href="#cb12-4879" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-4880"><a href="#cb12-4880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4881"><a href="#cb12-4881" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-4882"><a href="#cb12-4882" aria-hidden="true" tabindex="-1"></a>data_rept_freq_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_rept_freq_agg_cw)</span>
<span id="cb12-4883"><a href="#cb12-4883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4884"><a href="#cb12-4884" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized closed by closed evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span id="cb12-4885"><a href="#cb12-4885" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_agg_cw <span class="ot">&lt;-</span> data_clsd_by_clsd_eval_date_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4886"><a href="#cb12-4886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eval_year, eval_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4887"><a href="#cb12-4887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4888"><a href="#cb12-4888" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-4889"><a href="#cb12-4889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4890"><a href="#cb12-4890" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-4891"><a href="#cb12-4891" aria-hidden="true" tabindex="-1"></a>data_clsd_by_clsd_eval_date_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_clsd_by_clsd_eval_date_agg_cw)</span>
<span id="cb12-4892"><a href="#cb12-4892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4893"><a href="#cb12-4893" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize all columns by calendar year</span></span>
<span id="cb12-4894"><a href="#cb12-4894" aria-hidden="true" tabindex="-1"></a>data_freq_trend_calendar <span class="ot">&lt;-</span> data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4895"><a href="#cb12-4895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, year, qtr, earned_exposure) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4896"><a href="#cb12-4896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_rept_freq_agg <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, rept_year, rept_qtr, reported_count), <span class="at">by =</span> <span class="fu">join_by</span>(state, year <span class="sc">==</span> rept_year, qtr <span class="sc">==</span> rept_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4897"><a href="#cb12-4897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_clsd_by_clsd_eval_date_agg <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, eval_year, eval_qtr, closed_w_pay_count), <span class="at">by =</span> <span class="fu">join_by</span>(state, year <span class="sc">==</span> eval_year, qtr <span class="sc">==</span> eval_qtr)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4898"><a href="#cb12-4898" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">27</span>, <span class="at">by =</span> state) <span class="sc">%&gt;%</span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span id="cb12-4899"><a href="#cb12-4899" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_freq_trend_agg} <span class="sc">%&gt;%</span> </span>
<span id="cb12-4900"><a href="#cb12-4900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4901"><a href="#cb12-4901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4902"><a href="#cb12-4902" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4903"><a href="#cb12-4903" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-4904"><a href="#cb12-4904" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4905"><a href="#cb12-4905" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4906"><a href="#cb12-4906" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">calendar_quarter_ended =</span> <span class="fu">paste0</span>(year, <span class="st">"-Q"</span>, qtr),</span>
<span id="cb12-4907"><a href="#cb12-4907" aria-hidden="true" tabindex="-1"></a>               <span class="fu">across</span>(<span class="fu">c</span>(earned_exposure, reported_count, closed_w_pay_count), \(col) roll<span class="sc">::</span><span class="fu">roll_sum</span>(col, <span class="at">width =</span> <span class="dv">4</span>)),</span>
<span id="cb12-4908"><a href="#cb12-4908" aria-hidden="true" tabindex="-1"></a>               <span class="at">reported_freq =</span> <span class="fu">ifelse</span>(earned_exposure <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, reported_count <span class="sc">/</span> earned_exposure),</span>
<span id="cb12-4909"><a href="#cb12-4909" aria-hidden="true" tabindex="-1"></a>               <span class="at">closed_w_pay_freq =</span> <span class="fu">ifelse</span>(earned_exposure <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, closed_w_pay_count <span class="sc">/</span> earned_exposure)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4910"><a href="#cb12-4910" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(calendar_quarter_ended, earned_exposure, reported_count, reported_freq, closed_w_pay_count, closed_w_pay_freq) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4911"><a href="#cb12-4911" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-4912"><a href="#cb12-4912" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4913"><a href="#cb12-4913" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4914"><a href="#cb12-4914" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4915"><a href="#cb12-4915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4916"><a href="#cb12-4916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(calendar_quarter_ended, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-4917"><a href="#cb12-4917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4918"><a href="#cb12-4918" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span id="cb12-4919"><a href="#cb12-4919" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; reported frequency</span></span>
<span id="cb12-4920"><a href="#cb12-4920" aria-hidden="true" tabindex="-1"></a>data_freq_trend_fits_a <span class="ot">&lt;-</span> data_freq_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-4921"><a href="#cb12-4921" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4922"><a href="#cb12-4922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4923"><a href="#cb12-4923" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4924"><a href="#cb12-4924" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-4925"><a href="#cb12-4925" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4926"><a href="#cb12-4926" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"reported_freq"</span>)</span>
<span id="cb12-4927"><a href="#cb12-4927" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4928"><a href="#cb12-4928" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4929"><a href="#cb12-4929" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4930"><a href="#cb12-4930" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4931"><a href="#cb12-4931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"reported_freq"</span>)</span>
<span id="cb12-4932"><a href="#cb12-4932" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; closed with pay frequency</span></span>
<span id="cb12-4933"><a href="#cb12-4933" aria-hidden="true" tabindex="-1"></a>data_freq_trend_fits_b <span class="ot">&lt;-</span> data_freq_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-4934"><a href="#cb12-4934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4935"><a href="#cb12-4935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4936"><a href="#cb12-4936" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4937"><a href="#cb12-4937" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-4938"><a href="#cb12-4938" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4939"><a href="#cb12-4939" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"closed_w_pay_freq"</span>)</span>
<span id="cb12-4940"><a href="#cb12-4940" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4941"><a href="#cb12-4941" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4942"><a href="#cb12-4942" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4943"><a href="#cb12-4943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4944"><a href="#cb12-4944" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"closed_w_pay_freq"</span>)</span>
<span id="cb12-4945"><a href="#cb12-4945" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine</span></span>
<span id="cb12-4946"><a href="#cb12-4946" aria-hidden="true" tabindex="-1"></a>data_freq_trend_fits <span class="ot">&lt;-</span> data_freq_trend_fits_a <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(data_freq_trend_fits_b, <span class="at">by =</span> <span class="fu">join_by</span>(state, pt))</span>
<span id="cb12-4947"><a href="#cb12-4947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4948"><a href="#cb12-4948" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Severity trend ----</span></span>
<span id="cb12-4949"><a href="#cb12-4949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4950"><a href="#cb12-4950" aria-hidden="true" tabindex="-1"></a><span class="co"># create summarized closed by evaluation data (calendar quarter) overall (cw) and then combine</span></span>
<span id="cb12-4951"><a href="#cb12-4951" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_agg_cw <span class="ot">&lt;-</span> data_clsd_by_eval_date_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4952"><a href="#cb12-4952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eval_year, eval_qtr) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4953"><a href="#cb12-4953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4954"><a href="#cb12-4954" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb12-4955"><a href="#cb12-4955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-4956"><a href="#cb12-4956" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb12-4957"><a href="#cb12-4957" aria-hidden="true" tabindex="-1"></a>data_clsd_by_eval_date_agg <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_clsd_by_eval_date_agg_cw)</span>
<span id="cb12-4958"><a href="#cb12-4958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4959"><a href="#cb12-4959" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize all columns by calendar year</span></span>
<span id="cb12-4960"><a href="#cb12-4960" aria-hidden="true" tabindex="-1"></a>data_sev_trend_calendar <span class="ot">&lt;-</span> data_clsd_by_clsd_eval_date_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-4961"><a href="#cb12-4961" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, eval_year, eval_qtr, closed_w_pay_count, total_paid_loss_lae_net_of_s_s) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4962"><a href="#cb12-4962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_clsd_by_eval_date_agg <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, eval_year, eval_qtr, total_paid_loss_lae_net_of_s_s, post_closure_total_paid_loss_lae_net_of_s_s), <span class="at">by =</span> <span class="fu">join_by</span>(state, eval_year, eval_qtr), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_clsdbyclsd"</span>, <span class="st">"_clsd"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4963"><a href="#cb12-4963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">paid_loss =</span> total_paid_loss_lae_net_of_s_s_clsd) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4964"><a href="#cb12-4964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">paid_on_closed_loss =</span> total_paid_loss_lae_net_of_s_s_clsdbyclsd <span class="sc">+</span> post_closure_total_paid_loss_lae_net_of_s_s) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4965"><a href="#cb12-4965" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(post_closure_total_paid_loss_lae_net_of_s_s, total_paid_loss_lae_net_of_s_s_clsdbyclsd)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4966"><a href="#cb12-4966" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">27</span>, <span class="at">by =</span> state) <span class="sc">%&gt;%</span> <span class="co"># 6 years of data + 3 quarters</span></span>
<span id="cb12-4967"><a href="#cb12-4967" aria-hidden="true" tabindex="-1"></a>  {. <span class="ot">-&gt;&gt;</span> data_sev_trend_agg} <span class="sc">%&gt;%</span> </span>
<span id="cb12-4968"><a href="#cb12-4968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4969"><a href="#cb12-4969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4970"><a href="#cb12-4970" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4971"><a href="#cb12-4971" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data) {</span>
<span id="cb12-4972"><a href="#cb12-4972" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4973"><a href="#cb12-4973" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb12-4974"><a href="#cb12-4974" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">calendar_quarter_ended =</span> <span class="fu">paste0</span>(eval_year, <span class="st">"-Q"</span>, eval_qtr),</span>
<span id="cb12-4975"><a href="#cb12-4975" aria-hidden="true" tabindex="-1"></a>               <span class="fu">across</span>(<span class="fu">c</span>(closed_w_pay_count, paid_loss, paid_on_closed_loss), \(col) roll<span class="sc">::</span><span class="fu">roll_sum</span>(col, <span class="at">width =</span> <span class="dv">4</span>)),</span>
<span id="cb12-4976"><a href="#cb12-4976" aria-hidden="true" tabindex="-1"></a>               <span class="at">paid_sev =</span> <span class="fu">ifelse</span>(closed_w_pay_count <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, paid_loss <span class="sc">/</span> closed_w_pay_count),</span>
<span id="cb12-4977"><a href="#cb12-4977" aria-hidden="true" tabindex="-1"></a>               <span class="at">paid_on_closed_sev =</span> <span class="fu">ifelse</span>(closed_w_pay_count <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, paid_on_closed_loss <span class="sc">/</span> closed_w_pay_count)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4978"><a href="#cb12-4978" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(calendar_quarter_ended, closed_w_pay_count, paid_loss, paid_sev, paid_on_closed_loss, paid_on_closed_sev) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4979"><a href="#cb12-4979" aria-hidden="true" tabindex="-1"></a>        return</span>
<span id="cb12-4980"><a href="#cb12-4980" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4981"><a href="#cb12-4981" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4982"><a href="#cb12-4982" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4983"><a href="#cb12-4983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4984"><a href="#cb12-4984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(calendar_quarter_ended, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb12-4985"><a href="#cb12-4985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4986"><a href="#cb12-4986" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate weighted fits one variable at a time, then combine</span></span>
<span id="cb12-4987"><a href="#cb12-4987" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; paid severity</span></span>
<span id="cb12-4988"><a href="#cb12-4988" aria-hidden="true" tabindex="-1"></a>data_sev_trend_fits_a <span class="ot">&lt;-</span> data_sev_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-4989"><a href="#cb12-4989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4990"><a href="#cb12-4990" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-4991"><a href="#cb12-4991" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-4992"><a href="#cb12-4992" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-4993"><a href="#cb12-4993" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4994"><a href="#cb12-4994" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"paid_sev"</span>)</span>
<span id="cb12-4995"><a href="#cb12-4995" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-4996"><a href="#cb12-4996" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-4997"><a href="#cb12-4997" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4998"><a href="#cb12-4998" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4999"><a href="#cb12-4999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"paid_sev"</span>)</span>
<span id="cb12-5000"><a href="#cb12-5000" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; paid on closed severity</span></span>
<span id="cb12-5001"><a href="#cb12-5001" aria-hidden="true" tabindex="-1"></a>data_sev_trend_fits_b <span class="ot">&lt;-</span> data_sev_trend_calendar <span class="sc">%&gt;%</span> </span>
<span id="cb12-5002"><a href="#cb12-5002" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5003"><a href="#cb12-5003" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-5004"><a href="#cb12-5004" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-5005"><a href="#cb12-5005" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> \(data){</span>
<span id="cb12-5006"><a href="#cb12-5006" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-5007"><a href="#cb12-5007" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculate_weighted_fits</span>(<span class="at">df_calendar =</span> data, <span class="at">var =</span> <span class="st">"paid_on_closed_sev"</span>)</span>
<span id="cb12-5008"><a href="#cb12-5008" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-5009"><a href="#cb12-5009" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-5010"><a href="#cb12-5010" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5011"><a href="#cb12-5011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5012"><a href="#cb12-5012" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">names_to =</span> <span class="st">"pt"</span>, <span class="at">values_to =</span> <span class="st">"paid_on_closed_sev"</span>)</span>
<span id="cb12-5013"><a href="#cb12-5013" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine</span></span>
<span id="cb12-5014"><a href="#cb12-5014" aria-hidden="true" tabindex="-1"></a>data_sev_trend_fits <span class="ot">&lt;-</span> data_sev_trend_fits_a <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(data_sev_trend_fits_b, <span class="at">by =</span> <span class="fu">join_by</span>(state, pt))</span>
<span id="cb12-5015"><a href="#cb12-5015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5016"><a href="#cb12-5016" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Indication ----</span></span>
<span id="cb12-5017"><a href="#cb12-5017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5018"><a href="#cb12-5018" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate catastrophe ratios</span></span>
<span id="cb12-5019"><a href="#cb12-5019" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; statewide</span></span>
<span id="cb12-5020"><a href="#cb12-5020" aria-hidden="true" tabindex="-1"></a>data_cat <span class="ot">&lt;-</span> data_rms_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-5021"><a href="#cb12-5021" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">modeled_hurricane_ratio =</span> rms_hurricane_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-5022"><a href="#cb12-5022" aria-hidden="true" tabindex="-1"></a>         <span class="at">.keep =</span> <span class="st">"unused"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5023"><a href="#cb12-5023" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ts_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-5024"><a href="#cb12-5024" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">modeled_fire_following_earthquake_ratio =</span> touchstone_eq_fire_following_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-5025"><a href="#cb12-5025" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modeled_severe_convective_storm_ratio =</span> touchstone_severe_convective_storm_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-5026"><a href="#cb12-5026" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modeled_wildfire_ratio =</span> touchstone_wildfire_gross_aal <span class="sc">/</span> in_force_premium,</span>
<span id="cb12-5027"><a href="#cb12-5027" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.keep =</span> <span class="st">"unused"</span>),</span>
<span id="cb12-5028"><a href="#cb12-5028" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(state))</span>
<span id="cb12-5029"><a href="#cb12-5029" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; Countrywide</span></span>
<span id="cb12-5030"><a href="#cb12-5030" aria-hidden="true" tabindex="-1"></a>data_cat_cw <span class="ot">&lt;-</span> data_rms_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-5031"><a href="#cb12-5031" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">modeled_hurricane_ratio =</span> <span class="fu">sum</span>(rms_hurricane_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5032"><a href="#cb12-5032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-5033"><a href="#cb12-5033" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5034"><a href="#cb12-5034" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(data_ts_modeled_loss <span class="sc">%&gt;%</span> </span>
<span id="cb12-5035"><a href="#cb12-5035" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(<span class="at">modeled_fire_following_earthquake_ratio =</span> <span class="fu">sum</span>(touchstone_eq_fire_following_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium),</span>
<span id="cb12-5036"><a href="#cb12-5036" aria-hidden="true" tabindex="-1"></a>                        <span class="at">modeled_severe_convective_storm_ratio =</span> <span class="fu">sum</span>(touchstone_severe_convective_storm_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium),</span>
<span id="cb12-5037"><a href="#cb12-5037" aria-hidden="true" tabindex="-1"></a>                        <span class="at">modeled_wildfire_ratio =</span> <span class="fu">sum</span>(touchstone_wildfire_gross_aal) <span class="sc">/</span> <span class="fu">sum</span>(in_force_premium)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5038"><a href="#cb12-5038" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-5039"><a href="#cb12-5039" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.before =</span> <span class="dv">1</span>),</span>
<span id="cb12-5040"><a href="#cb12-5040" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(state))</span>
<span id="cb12-5041"><a href="#cb12-5041" aria-hidden="true" tabindex="-1"></a><span class="co"># -&gt; combine</span></span>
<span id="cb12-5042"><a href="#cb12-5042" aria-hidden="true" tabindex="-1"></a>data_cat <span class="sc">%&lt;&gt;%</span> <span class="fu">bind_rows</span>(data_cat_cw) </span>
<span id="cb12-5043"><a href="#cb12-5043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5044"><a href="#cb12-5044" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Define UI ----</span></span>
<span id="cb12-5045"><a href="#cb12-5045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5046"><a href="#cb12-5046" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">grid_page</span>(</span>
<span id="cb12-5047"><a href="#cb12-5047" aria-hidden="true" tabindex="-1"></a>  <span class="at">layout =</span> <span class="fu">c</span>(</span>
<span id="cb12-5048"><a href="#cb12-5048" aria-hidden="true" tabindex="-1"></a>    <span class="st">"header  results"</span>,</span>
<span id="cb12-5049"><a href="#cb12-5049" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sidebar results  "</span></span>
<span id="cb12-5050"><a href="#cb12-5050" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-5051"><a href="#cb12-5051" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5052"><a href="#cb12-5052" aria-hidden="true" tabindex="-1"></a>    <span class="st">"100px"</span>,</span>
<span id="cb12-5053"><a href="#cb12-5053" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1fr"</span></span>
<span id="cb12-5054"><a href="#cb12-5054" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-5055"><a href="#cb12-5055" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5056"><a href="#cb12-5056" aria-hidden="true" tabindex="-1"></a>    <span class="st">"400px"</span>,</span>
<span id="cb12-5057"><a href="#cb12-5057" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1fr"</span></span>
<span id="cb12-5058"><a href="#cb12-5058" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-5059"><a href="#cb12-5059" aria-hidden="true" tabindex="-1"></a>  <span class="at">gap_size =</span> <span class="st">"1rem"</span>,</span>
<span id="cb12-5060"><a href="#cb12-5060" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grid_card_text</span>(</span>
<span id="cb12-5061"><a href="#cb12-5061" aria-hidden="true" tabindex="-1"></a>    <span class="at">area =</span> <span class="st">"header"</span>,</span>
<span id="cb12-5062"><a href="#cb12-5062" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> <span class="st">"Quarterly indications"</span>,</span>
<span id="cb12-5063"><a href="#cb12-5063" aria-hidden="true" tabindex="-1"></a>    <span class="at">alignment =</span> <span class="st">"start"</span>,</span>
<span id="cb12-5064"><a href="#cb12-5064" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_title =</span> <span class="cn">FALSE</span></span>
<span id="cb12-5065"><a href="#cb12-5065" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-5066"><a href="#cb12-5066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grid_card</span>(</span>
<span id="cb12-5067"><a href="#cb12-5067" aria-hidden="true" tabindex="-1"></a>    <span class="at">area =</span> <span class="st">"sidebar"</span>,</span>
<span id="cb12-5068"><a href="#cb12-5068" aria-hidden="true" tabindex="-1"></a>    <span class="fu">card_body</span>(</span>
<span id="cb12-5069"><a href="#cb12-5069" aria-hidden="true" tabindex="-1"></a>      <span class="fu">uiOutput</span>(<span class="at">outputId =</span> <span class="st">"indicated_rates"</span>),</span>
<span id="cb12-5070"><a href="#cb12-5070" aria-hidden="true" tabindex="-1"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb12-5071"><a href="#cb12-5071" aria-hidden="true" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"selection_state"</span>,</span>
<span id="cb12-5072"><a href="#cb12-5072" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Select state"</span>,</span>
<span id="cb12-5073"><a href="#cb12-5073" aria-hidden="true" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">unique</span>(data_premium_raw<span class="sc">$</span>state),</span>
<span id="cb12-5074"><a href="#cb12-5074" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected =</span> <span class="st">"California"</span></span>
<span id="cb12-5075"><a href="#cb12-5075" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-5076"><a href="#cb12-5076" aria-hidden="true" tabindex="-1"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb12-5077"><a href="#cb12-5077" aria-hidden="true" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"selection_Countrywide"</span>,</span>
<span id="cb12-5078"><a href="#cb12-5078" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Select Countrywide"</span>,</span>
<span id="cb12-5079"><a href="#cb12-5079" aria-hidden="true" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">list</span>(</span>
<span id="cb12-5080"><a href="#cb12-5080" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Countrywide"</span> <span class="ot">=</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-5081"><a href="#cb12-5081" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Countrywide excluding California"</span> <span class="ot">=</span> <span class="st">"Countrywide x california"</span></span>
<span id="cb12-5082"><a href="#cb12-5082" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5083"><a href="#cb12-5083" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected =</span> <span class="st">"Countrywide"</span></span>
<span id="cb12-5084"><a href="#cb12-5084" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-5085"><a href="#cb12-5085" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dateInput</span>(<span class="at">inputId =</span> <span class="st">"selection_data_ended"</span>,</span>
<span id="cb12-5086"><a href="#cb12-5086" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> <span class="st">"Data ended"</span>,</span>
<span id="cb12-5087"><a href="#cb12-5087" aria-hidden="true" tabindex="-1"></a>                            <span class="at">value =</span> <span class="st">"2024-06-30"</span>,</span>
<span id="cb12-5088"><a href="#cb12-5088" aria-hidden="true" tabindex="-1"></a>                            <span class="at">format =</span> <span class="st">"mm/dd/yyyy"</span>),</span>
<span id="cb12-5089"><a href="#cb12-5089" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dateInput</span>(<span class="at">inputId =</span> <span class="st">"selection_effective_date"</span>,</span>
<span id="cb12-5090"><a href="#cb12-5090" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> <span class="st">"Proposed effective date"</span>,</span>
<span id="cb12-5091"><a href="#cb12-5091" aria-hidden="true" tabindex="-1"></a>                            <span class="at">format =</span> <span class="st">"mm/dd/yyyy"</span>),</span>
<span id="cb12-5092"><a href="#cb12-5092" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grid_container</span>(</span>
<span id="cb12-5093"><a href="#cb12-5093" aria-hidden="true" tabindex="-1"></a>        <span class="at">layout =</span> <span class="fu">c</span>(</span>
<span id="cb12-5094"><a href="#cb12-5094" aria-hidden="true" tabindex="-1"></a>          <span class="st">"selection_lcm selection_underlying_plr"</span></span>
<span id="cb12-5095"><a href="#cb12-5095" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5096"><a href="#cb12-5096" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5097"><a href="#cb12-5097" aria-hidden="true" tabindex="-1"></a>          <span class="st">"110px"</span></span>
<span id="cb12-5098"><a href="#cb12-5098" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5099"><a href="#cb12-5099" aria-hidden="true" tabindex="-1"></a>        <span class="at">col_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5100"><a href="#cb12-5100" aria-hidden="true" tabindex="-1"></a>          <span class="st">"1fr"</span>,</span>
<span id="cb12-5101"><a href="#cb12-5101" aria-hidden="true" tabindex="-1"></a>          <span class="st">"1fr"</span></span>
<span id="cb12-5102"><a href="#cb12-5102" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5103"><a href="#cb12-5103" aria-hidden="true" tabindex="-1"></a>        <span class="at">gap_size =</span> <span class="st">"10px"</span>,</span>
<span id="cb12-5104"><a href="#cb12-5104" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5105"><a href="#cb12-5105" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"selection_lcm"</span>,</span>
<span id="cb12-5106"><a href="#cb12-5106" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5107"><a href="#cb12-5107" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5108"><a href="#cb12-5108" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"selection_lcm"</span>,</span>
<span id="cb12-5109"><a href="#cb12-5109" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"Select LCM"</span>,</span>
<span id="cb12-5110"><a href="#cb12-5110" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">1.669</span>,</span>
<span id="cb12-5111"><a href="#cb12-5111" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5112"><a href="#cb12-5112" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.01</span></span>
<span id="cb12-5113"><a href="#cb12-5113" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5114"><a href="#cb12-5114" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5115"><a href="#cb12-5115" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5116"><a href="#cb12-5116" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5117"><a href="#cb12-5117" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"selection_underlying_plr"</span>,</span>
<span id="cb12-5118"><a href="#cb12-5118" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5119"><a href="#cb12-5119" aria-hidden="true" tabindex="-1"></a>            <span class="fu">textOutput</span>(<span class="at">outputId =</span> <span class="st">"selection_underlying_plr"</span>)</span>
<span id="cb12-5120"><a href="#cb12-5120" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5121"><a href="#cb12-5121" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-5122"><a href="#cb12-5122" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-5123"><a href="#cb12-5123" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grid_container</span>(</span>
<span id="cb12-5124"><a href="#cb12-5124" aria-hidden="true" tabindex="-1"></a>        <span class="at">layout =</span> <span class="fu">c</span>(</span>
<span id="cb12-5125"><a href="#cb12-5125" aria-hidden="true" tabindex="-1"></a>          <span class="st">"premium_trend_cw premium_trend_sw"</span>,</span>
<span id="cb12-5126"><a href="#cb12-5126" aria-hidden="true" tabindex="-1"></a>          <span class="st">"freq_trend_cw    freq_trend_sw   "</span>,</span>
<span id="cb12-5127"><a href="#cb12-5127" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sev_trend_cw     sev_trend_sw    "</span></span>
<span id="cb12-5128"><a href="#cb12-5128" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5129"><a href="#cb12-5129" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5130"><a href="#cb12-5130" aria-hidden="true" tabindex="-1"></a>          <span class="st">"110px"</span>,</span>
<span id="cb12-5131"><a href="#cb12-5131" aria-hidden="true" tabindex="-1"></a>          <span class="st">"110px"</span>,</span>
<span id="cb12-5132"><a href="#cb12-5132" aria-hidden="true" tabindex="-1"></a>          <span class="st">"110px"</span></span>
<span id="cb12-5133"><a href="#cb12-5133" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5134"><a href="#cb12-5134" aria-hidden="true" tabindex="-1"></a>        <span class="at">col_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5135"><a href="#cb12-5135" aria-hidden="true" tabindex="-1"></a>          <span class="st">"1.15fr"</span>,</span>
<span id="cb12-5136"><a href="#cb12-5136" aria-hidden="true" tabindex="-1"></a>          <span class="st">"0.85fr"</span></span>
<span id="cb12-5137"><a href="#cb12-5137" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5138"><a href="#cb12-5138" aria-hidden="true" tabindex="-1"></a>        <span class="at">gap_size =</span> <span class="st">"10px"</span>,</span>
<span id="cb12-5139"><a href="#cb12-5139" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5140"><a href="#cb12-5140" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"premium_trend_cw"</span>,</span>
<span id="cb12-5141"><a href="#cb12-5141" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5142"><a href="#cb12-5142" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5143"><a href="#cb12-5143" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"premium_trend_cw"</span>,</span>
<span id="cb12-5144"><a href="#cb12-5144" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"Premium trend: CW"</span>,</span>
<span id="cb12-5145"><a href="#cb12-5145" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">0.075</span>,</span>
<span id="cb12-5146"><a href="#cb12-5146" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5147"><a href="#cb12-5147" aria-hidden="true" tabindex="-1"></a>              <span class="at">max =</span> <span class="dv">2</span>,</span>
<span id="cb12-5148"><a href="#cb12-5148" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.005</span></span>
<span id="cb12-5149"><a href="#cb12-5149" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5150"><a href="#cb12-5150" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5151"><a href="#cb12-5151" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5152"><a href="#cb12-5152" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5153"><a href="#cb12-5153" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"freq_trend_cw"</span>,</span>
<span id="cb12-5154"><a href="#cb12-5154" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5155"><a href="#cb12-5155" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5156"><a href="#cb12-5156" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"freq_trend_cw"</span>,</span>
<span id="cb12-5157"><a href="#cb12-5157" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"Frequency trend: CW"</span>,</span>
<span id="cb12-5158"><a href="#cb12-5158" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">0.04</span>,</span>
<span id="cb12-5159"><a href="#cb12-5159" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5160"><a href="#cb12-5160" aria-hidden="true" tabindex="-1"></a>              <span class="at">max =</span> <span class="dv">2</span>,</span>
<span id="cb12-5161"><a href="#cb12-5161" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.005</span></span>
<span id="cb12-5162"><a href="#cb12-5162" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5163"><a href="#cb12-5163" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5164"><a href="#cb12-5164" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5165"><a href="#cb12-5165" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5166"><a href="#cb12-5166" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"sev_trend_cw"</span>,</span>
<span id="cb12-5167"><a href="#cb12-5167" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5168"><a href="#cb12-5168" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5169"><a href="#cb12-5169" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"sev_trend_cw"</span>,</span>
<span id="cb12-5170"><a href="#cb12-5170" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"Severity trend: CW"</span>,</span>
<span id="cb12-5171"><a href="#cb12-5171" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">0.14</span>,</span>
<span id="cb12-5172"><a href="#cb12-5172" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5173"><a href="#cb12-5173" aria-hidden="true" tabindex="-1"></a>              <span class="at">max =</span> <span class="dv">2</span>,</span>
<span id="cb12-5174"><a href="#cb12-5174" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.005</span></span>
<span id="cb12-5175"><a href="#cb12-5175" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5176"><a href="#cb12-5176" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5177"><a href="#cb12-5177" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5178"><a href="#cb12-5178" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5179"><a href="#cb12-5179" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"premium_trend_sw"</span>,</span>
<span id="cb12-5180"><a href="#cb12-5180" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5181"><a href="#cb12-5181" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5182"><a href="#cb12-5182" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"premium_trend_sw"</span>,</span>
<span id="cb12-5183"><a href="#cb12-5183" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"SW"</span>,</span>
<span id="cb12-5184"><a href="#cb12-5184" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">0.05</span>,</span>
<span id="cb12-5185"><a href="#cb12-5185" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5186"><a href="#cb12-5186" aria-hidden="true" tabindex="-1"></a>              <span class="at">max =</span> <span class="dv">2</span>,</span>
<span id="cb12-5187"><a href="#cb12-5187" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.005</span></span>
<span id="cb12-5188"><a href="#cb12-5188" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5189"><a href="#cb12-5189" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5190"><a href="#cb12-5190" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5191"><a href="#cb12-5191" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5192"><a href="#cb12-5192" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"freq_trend_sw"</span>,</span>
<span id="cb12-5193"><a href="#cb12-5193" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5194"><a href="#cb12-5194" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5195"><a href="#cb12-5195" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"freq_trend_sw"</span>,</span>
<span id="cb12-5196"><a href="#cb12-5196" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"SW"</span>,</span>
<span id="cb12-5197"><a href="#cb12-5197" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">0.04</span>,</span>
<span id="cb12-5198"><a href="#cb12-5198" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5199"><a href="#cb12-5199" aria-hidden="true" tabindex="-1"></a>              <span class="at">max =</span> <span class="dv">2</span>,</span>
<span id="cb12-5200"><a href="#cb12-5200" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.005</span></span>
<span id="cb12-5201"><a href="#cb12-5201" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5202"><a href="#cb12-5202" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5203"><a href="#cb12-5203" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5204"><a href="#cb12-5204" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5205"><a href="#cb12-5205" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"sev_trend_sw"</span>,</span>
<span id="cb12-5206"><a href="#cb12-5206" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5207"><a href="#cb12-5207" aria-hidden="true" tabindex="-1"></a>            <span class="fu">numericInput</span>(</span>
<span id="cb12-5208"><a href="#cb12-5208" aria-hidden="true" tabindex="-1"></a>              <span class="at">inputId =</span> <span class="st">"sev_trend_sw"</span>,</span>
<span id="cb12-5209"><a href="#cb12-5209" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="st">"SW"</span>,</span>
<span id="cb12-5210"><a href="#cb12-5210" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> <span class="fl">0.14</span>,</span>
<span id="cb12-5211"><a href="#cb12-5211" aria-hidden="true" tabindex="-1"></a>              <span class="at">min =</span> <span class="dv">0</span>,</span>
<span id="cb12-5212"><a href="#cb12-5212" aria-hidden="true" tabindex="-1"></a>              <span class="at">max =</span> <span class="dv">2</span>,</span>
<span id="cb12-5213"><a href="#cb12-5213" aria-hidden="true" tabindex="-1"></a>              <span class="at">step =</span> <span class="fl">0.005</span></span>
<span id="cb12-5214"><a href="#cb12-5214" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5215"><a href="#cb12-5215" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5216"><a href="#cb12-5216" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-5217"><a href="#cb12-5217" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-5218"><a href="#cb12-5218" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(</span>
<span id="cb12-5219"><a href="#cb12-5219" aria-hidden="true" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"other_inputs"</span>,</span>
<span id="cb12-5220"><a href="#cb12-5220" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Reload other inputs"</span>,</span>
<span id="cb12-5221"><a href="#cb12-5221" aria-hidden="true" tabindex="-1"></a>        <span class="at">width =</span> <span class="st">"100%"</span></span>
<span id="cb12-5222"><a href="#cb12-5222" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-5223"><a href="#cb12-5223" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-5224"><a href="#cb12-5224" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-5225"><a href="#cb12-5225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">card_body</span>(</span>
<span id="cb12-5226"><a href="#cb12-5226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tabsetPanel</span>(</span>
<span id="cb12-5227"><a href="#cb12-5227" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nav_panel</span>(</span>
<span id="cb12-5228"><a href="#cb12-5228" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"CW indication"</span>,</span>
<span id="cb12-5229"><a href="#cb12-5229" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5230"><a href="#cb12-5230" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"indication_cw"</span>,</span>
<span id="cb12-5231"><a href="#cb12-5231" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5232"><a href="#cb12-5232" aria-hidden="true" tabindex="-1"></a>            <span class="fu">grid_container</span>(</span>
<span id="cb12-5233"><a href="#cb12-5233" aria-hidden="true" tabindex="-1"></a>              <span class="at">layout =</span> <span class="fu">c</span>(</span>
<span id="cb12-5234"><a href="#cb12-5234" aria-hidden="true" tabindex="-1"></a>                <span class="st">"indication_summary_cw              indication_summary_cw     "</span>,</span>
<span id="cb12-5235"><a href="#cb12-5235" aria-hidden="true" tabindex="-1"></a>                <span class="st">"indication_calculations_support_cw indication_calculations_cw"</span></span>
<span id="cb12-5236"><a href="#cb12-5236" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5237"><a href="#cb12-5237" aria-hidden="true" tabindex="-1"></a>              <span class="at">gap_size =</span> <span class="st">"10px"</span>,</span>
<span id="cb12-5238"><a href="#cb12-5238" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5239"><a href="#cb12-5239" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span>,</span>
<span id="cb12-5240"><a href="#cb12-5240" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span></span>
<span id="cb12-5241"><a href="#cb12-5241" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5242"><a href="#cb12-5242" aria-hidden="true" tabindex="-1"></a>              <span class="at">row_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5243"><a href="#cb12-5243" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span>,</span>
<span id="cb12-5244"><a href="#cb12-5244" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span></span>
<span id="cb12-5245"><a href="#cb12-5245" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5246"><a href="#cb12-5246" aria-hidden="true" tabindex="-1"></a>              <span class="fu">grid_card</span>(</span>
<span id="cb12-5247"><a href="#cb12-5247" aria-hidden="true" tabindex="-1"></a>                <span class="at">area =</span> <span class="st">"indication_summary_cw"</span>,</span>
<span id="cb12-5248"><a href="#cb12-5248" aria-hidden="true" tabindex="-1"></a>                <span class="fu">card_body</span>(</span>
<span id="cb12-5249"><a href="#cb12-5249" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">gt_output</span>(</span>
<span id="cb12-5250"><a href="#cb12-5250" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">outputId =</span> <span class="st">"indication_summary_cw"</span></span>
<span id="cb12-5251"><a href="#cb12-5251" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb12-5252"><a href="#cb12-5252" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-5253"><a href="#cb12-5253" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5254"><a href="#cb12-5254" aria-hidden="true" tabindex="-1"></a>              <span class="fu">grid_card</span>(</span>
<span id="cb12-5255"><a href="#cb12-5255" aria-hidden="true" tabindex="-1"></a>                <span class="at">area =</span> <span class="st">"indication_calculations_cw"</span>,</span>
<span id="cb12-5256"><a href="#cb12-5256" aria-hidden="true" tabindex="-1"></a>                <span class="fu">card_body</span>(</span>
<span id="cb12-5257"><a href="#cb12-5257" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">gt_output</span>(</span>
<span id="cb12-5258"><a href="#cb12-5258" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">outputId =</span> <span class="st">"indication_calculations_cw"</span></span>
<span id="cb12-5259"><a href="#cb12-5259" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb12-5260"><a href="#cb12-5260" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-5261"><a href="#cb12-5261" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5262"><a href="#cb12-5262" aria-hidden="true" tabindex="-1"></a>              <span class="fu">grid_card</span>(</span>
<span id="cb12-5263"><a href="#cb12-5263" aria-hidden="true" tabindex="-1"></a>                <span class="at">area =</span> <span class="st">"indication_calculations_support_cw"</span>,</span>
<span id="cb12-5264"><a href="#cb12-5264" aria-hidden="true" tabindex="-1"></a>                <span class="fu">card_body</span>(</span>
<span id="cb12-5265"><a href="#cb12-5265" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">gt_output</span>(</span>
<span id="cb12-5266"><a href="#cb12-5266" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">outputId =</span> <span class="st">"indication_calculations_support_cw"</span></span>
<span id="cb12-5267"><a href="#cb12-5267" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb12-5268"><a href="#cb12-5268" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-5269"><a href="#cb12-5269" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb12-5270"><a href="#cb12-5270" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5271"><a href="#cb12-5271" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5272"><a href="#cb12-5272" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-5273"><a href="#cb12-5273" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-5274"><a href="#cb12-5274" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nav_panel</span>(</span>
<span id="cb12-5275"><a href="#cb12-5275" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SW indication"</span>,</span>
<span id="cb12-5276"><a href="#cb12-5276" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_card</span>(</span>
<span id="cb12-5277"><a href="#cb12-5277" aria-hidden="true" tabindex="-1"></a>          <span class="at">area =</span> <span class="st">"indication_sw"</span>,</span>
<span id="cb12-5278"><a href="#cb12-5278" aria-hidden="true" tabindex="-1"></a>          <span class="fu">card_body</span>(</span>
<span id="cb12-5279"><a href="#cb12-5279" aria-hidden="true" tabindex="-1"></a>            <span class="fu">grid_container</span>(</span>
<span id="cb12-5280"><a href="#cb12-5280" aria-hidden="true" tabindex="-1"></a>              <span class="at">layout =</span> <span class="fu">c</span>(</span>
<span id="cb12-5281"><a href="#cb12-5281" aria-hidden="true" tabindex="-1"></a>                <span class="st">"indication_summary_sw              indication_summary_sw     "</span>,</span>
<span id="cb12-5282"><a href="#cb12-5282" aria-hidden="true" tabindex="-1"></a>                <span class="st">"indication_calculations_support_sw indication_calculations_sw"</span></span>
<span id="cb12-5283"><a href="#cb12-5283" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5284"><a href="#cb12-5284" aria-hidden="true" tabindex="-1"></a>              <span class="at">row_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5285"><a href="#cb12-5285" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span>,</span>
<span id="cb12-5286"><a href="#cb12-5286" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span></span>
<span id="cb12-5287"><a href="#cb12-5287" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5288"><a href="#cb12-5288" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_sizes =</span> <span class="fu">c</span>(</span>
<span id="cb12-5289"><a href="#cb12-5289" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span>,</span>
<span id="cb12-5290"><a href="#cb12-5290" aria-hidden="true" tabindex="-1"></a>                <span class="st">"1fr"</span></span>
<span id="cb12-5291"><a href="#cb12-5291" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5292"><a href="#cb12-5292" aria-hidden="true" tabindex="-1"></a>              <span class="at">gap_size =</span> <span class="st">"10px"</span>,</span>
<span id="cb12-5293"><a href="#cb12-5293" aria-hidden="true" tabindex="-1"></a>              <span class="fu">grid_card</span>(</span>
<span id="cb12-5294"><a href="#cb12-5294" aria-hidden="true" tabindex="-1"></a>                <span class="at">area =</span> <span class="st">"indication_summary_sw"</span>,</span>
<span id="cb12-5295"><a href="#cb12-5295" aria-hidden="true" tabindex="-1"></a>                <span class="fu">card_body</span>(</span>
<span id="cb12-5296"><a href="#cb12-5296" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">gt_output</span>(</span>
<span id="cb12-5297"><a href="#cb12-5297" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">outputId =</span> <span class="st">"indication_summary_sw"</span></span>
<span id="cb12-5298"><a href="#cb12-5298" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb12-5299"><a href="#cb12-5299" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-5300"><a href="#cb12-5300" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5301"><a href="#cb12-5301" aria-hidden="true" tabindex="-1"></a>              <span class="fu">grid_card</span>(</span>
<span id="cb12-5302"><a href="#cb12-5302" aria-hidden="true" tabindex="-1"></a>                <span class="at">area =</span> <span class="st">"indication_calculations_sw"</span>,</span>
<span id="cb12-5303"><a href="#cb12-5303" aria-hidden="true" tabindex="-1"></a>                <span class="fu">card_body</span>(</span>
<span id="cb12-5304"><a href="#cb12-5304" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">gt_output</span>(</span>
<span id="cb12-5305"><a href="#cb12-5305" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">outputId =</span> <span class="st">"indication_calculations_sw"</span></span>
<span id="cb12-5306"><a href="#cb12-5306" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb12-5307"><a href="#cb12-5307" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-5308"><a href="#cb12-5308" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb12-5309"><a href="#cb12-5309" aria-hidden="true" tabindex="-1"></a>              <span class="fu">grid_card</span>(</span>
<span id="cb12-5310"><a href="#cb12-5310" aria-hidden="true" tabindex="-1"></a>                <span class="at">area =</span> <span class="st">"indication_calculations_support_sw"</span>,</span>
<span id="cb12-5311"><a href="#cb12-5311" aria-hidden="true" tabindex="-1"></a>                <span class="fu">card_body</span>(</span>
<span id="cb12-5312"><a href="#cb12-5312" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">gt_output</span>(</span>
<span id="cb12-5313"><a href="#cb12-5313" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">outputId =</span> <span class="st">"indication_calculations_support_sw"</span></span>
<span id="cb12-5314"><a href="#cb12-5314" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb12-5315"><a href="#cb12-5315" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-5316"><a href="#cb12-5316" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb12-5317"><a href="#cb12-5317" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-5318"><a href="#cb12-5318" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-5319"><a href="#cb12-5319" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-5320"><a href="#cb12-5320" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-5321"><a href="#cb12-5321" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-5322"><a href="#cb12-5322" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5323"><a href="#cb12-5323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-5324"><a href="#cb12-5324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5325"><a href="#cb12-5325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5326"><a href="#cb12-5326" aria-hidden="true" tabindex="-1"></a><span class="do">### ---- Define server ----</span></span>
<span id="cb12-5327"><a href="#cb12-5327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5328"><a href="#cb12-5328" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output) {</span>
<span id="cb12-5329"><a href="#cb12-5329" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5330"><a href="#cb12-5330" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Recalculate things based on selections / inputs</span></span>
<span id="cb12-5331"><a href="#cb12-5331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5332"><a href="#cb12-5332" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate selected underlying PLR</span></span>
<span id="cb12-5333"><a href="#cb12-5333" aria-hidden="true" tabindex="-1"></a>  selection_underlying_plr <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5334"><a href="#cb12-5334" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5335"><a href="#cb12-5335" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>selection_lcm</span>
<span id="cb12-5336"><a href="#cb12-5336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5337"><a href="#cb12-5337" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5338"><a href="#cb12-5338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bindEvent</span>(input<span class="sc">$</span>selection_lcm)</span>
<span id="cb12-5339"><a href="#cb12-5339" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5340"><a href="#cb12-5340" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate evaluation date</span></span>
<span id="cb12-5341"><a href="#cb12-5341" aria-hidden="true" tabindex="-1"></a>  selection_eval_date <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5342"><a href="#cb12-5342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5343"><a href="#cb12-5343" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">3</span>)</span>
<span id="cb12-5344"><a href="#cb12-5344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5345"><a href="#cb12-5345" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5346"><a href="#cb12-5346" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bindEvent</span>(input<span class="sc">$</span>selection_data_ended)</span>
<span id="cb12-5347"><a href="#cb12-5347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5348"><a href="#cb12-5348" aria-hidden="true" tabindex="-1"></a>  <span class="co"># display underlying PLR</span></span>
<span id="cb12-5349"><a href="#cb12-5349" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>selection_underlying_plr <span class="ot">&lt;-</span> <span class="fu">renderText</span>({</span>
<span id="cb12-5350"><a href="#cb12-5350" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5351"><a href="#cb12-5351" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"Underlying PLR: "</span>, <span class="fu">round</span>(<span class="fu">selection_underlying_plr</span>() <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb12-5352"><a href="#cb12-5352" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5353"><a href="#cb12-5353" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5354"><a href="#cb12-5354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5355"><a href="#cb12-5355" aria-hidden="true" tabindex="-1"></a>  <span class="co"># input selections / input data after clicking action button</span></span>
<span id="cb12-5356"><a href="#cb12-5356" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; loss development factors</span></span>
<span id="cb12-5357"><a href="#cb12-5357" aria-hidden="true" tabindex="-1"></a>  data_other_inputs <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5358"><a href="#cb12-5358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5359"><a href="#cb12-5359" aria-hidden="true" tabindex="-1"></a>    readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="at">path =</span> <span class="st">"app-inputs.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"long"</span>)</span>
<span id="cb12-5360"><a href="#cb12-5360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5361"><a href="#cb12-5361" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5362"><a href="#cb12-5362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bindEvent</span>(input<span class="sc">$</span>other_inputs,</span>
<span id="cb12-5363"><a href="#cb12-5363" aria-hidden="true" tabindex="-1"></a>              <span class="at">ignoreNULL =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-5364"><a href="#cb12-5364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5365"><a href="#cb12-5365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># value box</span></span>
<span id="cb12-5366"><a href="#cb12-5366" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indicated_rates <span class="ot">&lt;-</span> <span class="fu">renderUI</span>(</span>
<span id="cb12-5367"><a href="#cb12-5367" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-5368"><a href="#cb12-5368" aria-hidden="true" tabindex="-1"></a>      <span class="fu">HTML</span>(<span class="fu">paste0</span>(<span class="st">"&lt;h3 style = 'color: orange'&gt;Countrywide = "</span>, <span class="fu">data_indication3</span>() <span class="sc">%&gt;%</span> <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(indicated_rate_level_needed) <span class="sc">%&gt;%</span> as.numeric <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="dv">100</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">1</span>), <span class="st">"%&lt;/h3&gt;"</span>,</span>
<span id="cb12-5369"><a href="#cb12-5369" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"&lt;h3 style = 'color: orange'&gt;"</span>, input<span class="sc">$</span>selection_state, <span class="st">" = "</span>, <span class="fu">data_indication3</span>() <span class="sc">%&gt;%</span> <span class="fu">filter</span>(state <span class="sc">==</span> input<span class="sc">$</span>selection_state) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(indicated_rate_level_needed) <span class="sc">%&gt;%</span> as.numeric <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="dv">100</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">1</span>), <span class="st">"%&lt;/h3&gt;"</span>))</span>
<span id="cb12-5370"><a href="#cb12-5370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5371"><a href="#cb12-5371" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5372"><a href="#cb12-5372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5373"><a href="#cb12-5373" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Recalculate datasets now based on inputs</span></span>
<span id="cb12-5374"><a href="#cb12-5374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5375"><a href="#cb12-5375" aria-hidden="true" tabindex="-1"></a>  <span class="co"># premium trend</span></span>
<span id="cb12-5376"><a href="#cb12-5376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate Countrywide selections</span></span>
<span id="cb12-5377"><a href="#cb12-5377" aria-hidden="true" tabindex="-1"></a>  data_premium_trend_selected_cw <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5378"><a href="#cb12-5378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5379"><a href="#cb12-5379" aria-hidden="true" tabindex="-1"></a>    data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-5380"><a href="#cb12-5380" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5381"><a href="#cb12-5381" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5382"><a href="#cb12-5382" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">credibility =</span> <span class="fu">sum</span>(earned_exposure) <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="fl">0.035</span>) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">1084</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5383"><a href="#cb12-5383" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-5384"><a href="#cb12-5384" aria-hidden="true" tabindex="-1"></a>             <span class="at">selected =</span> input<span class="sc">$</span>premium_trend_cw,</span>
<span id="cb12-5385"><a href="#cb12-5385" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_comp =</span> <span class="fl">0.016</span>,</span>
<span id="cb12-5386"><a href="#cb12-5386" aria-hidden="true" tabindex="-1"></a>             <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility))</span>
<span id="cb12-5387"><a href="#cb12-5387" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5388"><a href="#cb12-5388" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5389"><a href="#cb12-5389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5390"><a href="#cb12-5390" aria-hidden="true" tabindex="-1"></a>  <span class="co"># premium trend</span></span>
<span id="cb12-5391"><a href="#cb12-5391" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate state selections and add back in Countrywide</span></span>
<span id="cb12-5392"><a href="#cb12-5392" aria-hidden="true" tabindex="-1"></a>  data_premium_trend_selected <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5393"><a href="#cb12-5393" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5394"><a href="#cb12-5394" aria-hidden="true" tabindex="-1"></a>    data_premium_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-5395"><a href="#cb12-5395" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5396"><a href="#cb12-5396" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>,</span>
<span id="cb12-5397"><a href="#cb12-5397" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5398"><a href="#cb12-5398" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">.by =</span> state,</span>
<span id="cb12-5399"><a href="#cb12-5399" aria-hidden="true" tabindex="-1"></a>                <span class="at">credibility =</span> <span class="fu">sum</span>(earned_exposure) <span class="sc">%&gt;%</span> <span class="fu">multiply_by</span>(<span class="fl">0.035</span>) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">1084</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5400"><a href="#cb12-5400" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">selected =</span> input<span class="sc">$</span>premium_trend_sw,</span>
<span id="cb12-5401"><a href="#cb12-5401" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_comp =</span> <span class="fu">data_premium_trend_selected_cw</span>()<span class="sc">$</span>z_wtd_selected,</span>
<span id="cb12-5402"><a href="#cb12-5402" aria-hidden="true" tabindex="-1"></a>             <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5403"><a href="#cb12-5403" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(<span class="fu">data_premium_trend_selected_cw</span>())</span>
<span id="cb12-5404"><a href="#cb12-5404" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5405"><a href="#cb12-5405" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5406"><a href="#cb12-5406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5407"><a href="#cb12-5407" aria-hidden="true" tabindex="-1"></a>  <span class="co"># paid loss</span></span>
<span id="cb12-5408"><a href="#cb12-5408" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; weighted development factors</span></span>
<span id="cb12-5409"><a href="#cb12-5409" aria-hidden="true" tabindex="-1"></a>  data_paid_loss_selects <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5410"><a href="#cb12-5410" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5411"><a href="#cb12-5411" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_weighted_dev_factors</span>(<span class="at">df_loss_tri =</span> data_paid_loss_triangle, <span class="at">selects =</span> <span class="fu">data_other_inputs</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-5412"><a href="#cb12-5412" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">filter</span>(table <span class="sc">==</span> <span class="st">"loss development factors"</span>, key2 <span class="sc">==</span> <span class="st">"Paid loss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5413"><a href="#cb12-5413" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">pull</span>(value))</span>
<span id="cb12-5414"><a href="#cb12-5414" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5415"><a href="#cb12-5415" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5416"><a href="#cb12-5416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5417"><a href="#cb12-5417" aria-hidden="true" tabindex="-1"></a>  <span class="co"># incurred loss</span></span>
<span id="cb12-5418"><a href="#cb12-5418" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; weighted development factors</span></span>
<span id="cb12-5419"><a href="#cb12-5419" aria-hidden="true" tabindex="-1"></a>  data_incurred_loss_selects <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5420"><a href="#cb12-5420" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5421"><a href="#cb12-5421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_weighted_dev_factors</span>(<span class="at">df_loss_tri =</span> data_incurred_loss_triangle, <span class="at">selects =</span> <span class="fu">data_other_inputs</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-5422"><a href="#cb12-5422" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">filter</span>(table <span class="sc">==</span> <span class="st">"loss development factors"</span>, key2 <span class="sc">==</span> <span class="st">"Incurred loss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5423"><a href="#cb12-5423" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">pull</span>(value))</span>
<span id="cb12-5424"><a href="#cb12-5424" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5425"><a href="#cb12-5425" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5426"><a href="#cb12-5426" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5427"><a href="#cb12-5427" aria-hidden="true" tabindex="-1"></a>  <span class="co"># incurred claim count</span></span>
<span id="cb12-5428"><a href="#cb12-5428" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; weighted development factors</span></span>
<span id="cb12-5429"><a href="#cb12-5429" aria-hidden="true" tabindex="-1"></a>  data_incurred_claim_count_selects <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5430"><a href="#cb12-5430" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5431"><a href="#cb12-5431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_weighted_dev_factors</span>(<span class="at">df_loss_tri =</span> data_incurred_claim_count_triangle, <span class="at">selects =</span> <span class="fu">data_other_inputs</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-5432"><a href="#cb12-5432" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">filter</span>(table <span class="sc">==</span> <span class="st">"loss development factors"</span>, key2 <span class="sc">==</span> <span class="st">"Incurred claim count"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5433"><a href="#cb12-5433" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">pull</span>(value))</span>
<span id="cb12-5434"><a href="#cb12-5434" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5435"><a href="#cb12-5435" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5436"><a href="#cb12-5436" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5437"><a href="#cb12-5437" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ultimate loss</span></span>
<span id="cb12-5438"><a href="#cb12-5438" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; append age to ultimate factors and calculate ultimate losses </span></span>
<span id="cb12-5439"><a href="#cb12-5439" aria-hidden="true" tabindex="-1"></a>  data_ult_loss <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5440"><a href="#cb12-5440" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5441"><a href="#cb12-5441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_ultimate_incurred</span>(<span class="at">df_agg =</span> data_loss_agg, <span class="at">df_selects =</span> <span class="fu">data_incurred_loss_selects</span>(), <span class="at">var =</span> <span class="st">"incurred_loss"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5442"><a href="#cb12-5442" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">incurred_loss =</span> incurred, <span class="at">incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_loss =</span> ult_incurred)</span>
<span id="cb12-5443"><a href="#cb12-5443" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5444"><a href="#cb12-5444" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5445"><a href="#cb12-5445" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5446"><a href="#cb12-5446" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; summarize data by fiscal year</span></span>
<span id="cb12-5447"><a href="#cb12-5447" aria-hidden="true" tabindex="-1"></a>  data_ult_loss_fiscal <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5448"><a href="#cb12-5448" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5449"><a href="#cb12-5449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize_by_fiscal_year</span>(<span class="at">df =</span> <span class="fu">data_ult_loss</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5450"><a href="#cb12-5450" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">incurred_loss =</span> var1_cumulative, <span class="at">implied_incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_loss =</span> var2_cumulative)</span>
<span id="cb12-5451"><a href="#cb12-5451" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5452"><a href="#cb12-5452" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5453"><a href="#cb12-5453" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5454"><a href="#cb12-5454" aria-hidden="true" tabindex="-1"></a>  <span class="co"># claim count</span></span>
<span id="cb12-5455"><a href="#cb12-5455" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; append age to ultimate factors and calculate ultimate claim count</span></span>
<span id="cb12-5456"><a href="#cb12-5456" aria-hidden="true" tabindex="-1"></a>  data_ult_claim_count <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5457"><a href="#cb12-5457" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5458"><a href="#cb12-5458" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_ultimate_incurred</span>(<span class="at">df_agg =</span> data_loss_agg, <span class="at">df_selects =</span> <span class="fu">data_incurred_claim_count_selects</span>(), <span class="at">var =</span> <span class="st">"incurred_claim_count"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5459"><a href="#cb12-5459" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">incurred_claim_count =</span> incurred, <span class="at">implied_incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_claim_count =</span> ult_incurred)</span>
<span id="cb12-5460"><a href="#cb12-5460" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5461"><a href="#cb12-5461" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5462"><a href="#cb12-5462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5463"><a href="#cb12-5463" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; summarize data by fiscal year</span></span>
<span id="cb12-5464"><a href="#cb12-5464" aria-hidden="true" tabindex="-1"></a>  data_ult_claim_count_fiscal <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5465"><a href="#cb12-5465" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5466"><a href="#cb12-5466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize_by_fiscal_year</span>(<span class="at">df =</span> <span class="fu">data_ult_claim_count</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5467"><a href="#cb12-5467" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">incurred_claim_count =</span> var1_cumulative, <span class="at">implied_incurred_age_to_ult =</span> factor, <span class="at">ult_incurred_claim_count =</span> var2_cumulative)</span>
<span id="cb12-5468"><a href="#cb12-5468" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5469"><a href="#cb12-5469" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5470"><a href="#cb12-5470" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5471"><a href="#cb12-5471" aria-hidden="true" tabindex="-1"></a>  <span class="co"># frequency trend</span></span>
<span id="cb12-5472"><a href="#cb12-5472" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate Countrywide selections</span></span>
<span id="cb12-5473"><a href="#cb12-5473" aria-hidden="true" tabindex="-1"></a>  data_freq_trend_selected_cw <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5474"><a href="#cb12-5474" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5475"><a href="#cb12-5475" aria-hidden="true" tabindex="-1"></a>    data_freq_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-5476"><a href="#cb12-5476" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5477"><a href="#cb12-5477" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5478"><a href="#cb12-5478" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5479"><a href="#cb12-5479" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-5480"><a href="#cb12-5480" aria-hidden="true" tabindex="-1"></a>             <span class="at">selected =</span> input<span class="sc">$</span>freq_trend_cw,</span>
<span id="cb12-5481"><a href="#cb12-5481" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_comp =</span> <span class="dv">0</span>,</span>
<span id="cb12-5482"><a href="#cb12-5482" aria-hidden="true" tabindex="-1"></a>             <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility))</span>
<span id="cb12-5483"><a href="#cb12-5483" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5484"><a href="#cb12-5484" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5485"><a href="#cb12-5485" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5486"><a href="#cb12-5486" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate state selections and add back in Countrywide</span></span>
<span id="cb12-5487"><a href="#cb12-5487" aria-hidden="true" tabindex="-1"></a>  data_freq_trend_selected <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5488"><a href="#cb12-5488" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5489"><a href="#cb12-5489" aria-hidden="true" tabindex="-1"></a>    data_freq_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-5490"><a href="#cb12-5490" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5491"><a href="#cb12-5491" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>,</span>
<span id="cb12-5492"><a href="#cb12-5492" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5493"><a href="#cb12-5493" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">.by =</span> state,</span>
<span id="cb12-5494"><a href="#cb12-5494" aria-hidden="true" tabindex="-1"></a>                <span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5495"><a href="#cb12-5495" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">selected =</span> input<span class="sc">$</span>freq_trend_sw,</span>
<span id="cb12-5496"><a href="#cb12-5496" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_comp =</span> <span class="fu">data_freq_trend_selected_cw</span>()<span class="sc">$</span>z_wtd_selected,</span>
<span id="cb12-5497"><a href="#cb12-5497" aria-hidden="true" tabindex="-1"></a>             <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5498"><a href="#cb12-5498" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(<span class="fu">data_freq_trend_selected_cw</span>())</span>
<span id="cb12-5499"><a href="#cb12-5499" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5500"><a href="#cb12-5500" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5501"><a href="#cb12-5501" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5502"><a href="#cb12-5502" aria-hidden="true" tabindex="-1"></a>  <span class="co"># severity trend</span></span>
<span id="cb12-5503"><a href="#cb12-5503" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate Countrywide selections</span></span>
<span id="cb12-5504"><a href="#cb12-5504" aria-hidden="true" tabindex="-1"></a>  data_sev_trend_selected_cw <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5505"><a href="#cb12-5505" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5506"><a href="#cb12-5506" aria-hidden="true" tabindex="-1"></a>    data_sev_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-5507"><a href="#cb12-5507" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5508"><a href="#cb12-5508" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5509"><a href="#cb12-5509" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5510"><a href="#cb12-5510" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>,</span>
<span id="cb12-5511"><a href="#cb12-5511" aria-hidden="true" tabindex="-1"></a>             <span class="at">selected =</span> input<span class="sc">$</span>sev_trend_cw,</span>
<span id="cb12-5512"><a href="#cb12-5512" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_comp =</span> <span class="fl">0.02</span>,</span>
<span id="cb12-5513"><a href="#cb12-5513" aria-hidden="true" tabindex="-1"></a>             <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility))</span>
<span id="cb12-5514"><a href="#cb12-5514" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5515"><a href="#cb12-5515" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5516"><a href="#cb12-5516" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5517"><a href="#cb12-5517" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate state selections and add back in Countrywide</span></span>
<span id="cb12-5518"><a href="#cb12-5518" aria-hidden="true" tabindex="-1"></a>  data_sev_trend_selected <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5519"><a href="#cb12-5519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5520"><a href="#cb12-5520" aria-hidden="true" tabindex="-1"></a>    data_sev_trend_agg <span class="sc">%&gt;%</span> </span>
<span id="cb12-5521"><a href="#cb12-5521" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5522"><a href="#cb12-5522" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">4</span>,</span>
<span id="cb12-5523"><a href="#cb12-5523" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> state) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5524"><a href="#cb12-5524" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">.by =</span> state,</span>
<span id="cb12-5525"><a href="#cb12-5525" aria-hidden="true" tabindex="-1"></a>                <span class="at">credibility =</span> <span class="fu">sum</span>(closed_w_pay_count) <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">3000</span>) <span class="sc">%&gt;%</span> sqrt) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5526"><a href="#cb12-5526" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">selected =</span> input<span class="sc">$</span>sev_trend_sw,</span>
<span id="cb12-5527"><a href="#cb12-5527" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_comp =</span> <span class="fu">data_sev_trend_selected_cw</span>()<span class="sc">$</span>z_wtd_selected,</span>
<span id="cb12-5528"><a href="#cb12-5528" aria-hidden="true" tabindex="-1"></a>             <span class="at">z_wtd_selected =</span> selected <span class="sc">*</span> credibility <span class="sc">+</span> credibility_comp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> credibility)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5529"><a href="#cb12-5529" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(<span class="fu">data_sev_trend_selected_cw</span>())</span>
<span id="cb12-5530"><a href="#cb12-5530" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5531"><a href="#cb12-5531" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5532"><a href="#cb12-5532" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5533"><a href="#cb12-5533" aria-hidden="true" tabindex="-1"></a>  <span class="co"># input selections / input data after clicking action button (again...)</span></span>
<span id="cb12-5534"><a href="#cb12-5534" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; accident year weights</span></span>
<span id="cb12-5535"><a href="#cb12-5535" aria-hidden="true" tabindex="-1"></a>  selection_ay_weights <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5536"><a href="#cb12-5536" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5537"><a href="#cb12-5537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_ult_loss_fiscal</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5538"><a href="#cb12-5538" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5539"><a href="#cb12-5539" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(state, fiscal_year_ended) <span class="sc">%&gt;%</span></span>
<span id="cb12-5540"><a href="#cb12-5540" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(<span class="fu">data.frame</span>(<span class="at">ay_weights =</span> <span class="fu">rep</span>(<span class="fu">data_other_inputs</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5541"><a href="#cb12-5541" aria-hidden="true" tabindex="-1"></a>                                              <span class="fu">filter</span>(table <span class="sc">==</span> <span class="st">"accident year weights"</span>, key1 <span class="sc">==</span> <span class="st">"Statewide"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5542"><a href="#cb12-5542" aria-hidden="true" tabindex="-1"></a>                                              <span class="fu">pull</span>(value), <span class="fu">nrow</span>(.) <span class="sc">/</span> <span class="dv">5</span>)))</span>
<span id="cb12-5543"><a href="#cb12-5543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5544"><a href="#cb12-5544" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5545"><a href="#cb12-5545" aria-hidden="true" tabindex="-1"></a>  selection_ay_weights_cw <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5546"><a href="#cb12-5546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5547"><a href="#cb12-5547" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_ult_loss_fiscal</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5548"><a href="#cb12-5548" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(fiscal_year_ended) <span class="sc">%&gt;%</span></span>
<span id="cb12-5549"><a href="#cb12-5549" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(<span class="fu">data.frame</span>(<span class="at">ay_weights =</span> <span class="fu">data_other_inputs</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5550"><a href="#cb12-5550" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">filter</span>(table <span class="sc">==</span> <span class="st">"accident year weights"</span>, key1 <span class="sc">==</span> <span class="st">"Complement"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5551"><a href="#cb12-5551" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">pull</span>(value))) <span class="sc">%&gt;%</span></span>
<span id="cb12-5552"><a href="#cb12-5552" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"Countrywide"</span>)</span>
<span id="cb12-5553"><a href="#cb12-5553" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5554"><a href="#cb12-5554" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5555"><a href="#cb12-5555" aria-hidden="true" tabindex="-1"></a>  selection_ay_weights2 <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5556"><a href="#cb12-5556" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5557"><a href="#cb12-5557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">selection_ay_weights</span>() <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(<span class="fu">selection_ay_weights_cw</span>())</span>
<span id="cb12-5558"><a href="#cb12-5558" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5559"><a href="#cb12-5559" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5560"><a href="#cb12-5560" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5561"><a href="#cb12-5561" aria-hidden="true" tabindex="-1"></a>  <span class="co"># indication</span></span>
<span id="cb12-5562"><a href="#cb12-5562" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; calculate indication table</span></span>
<span id="cb12-5563"><a href="#cb12-5563" aria-hidden="true" tabindex="-1"></a>  data_indication <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5564"><a href="#cb12-5564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5565"><a href="#cb12-5565" aria-hidden="true" tabindex="-1"></a>    data_premium_current_level_fiscal <span class="sc">%&gt;%</span></span>
<span id="cb12-5566"><a href="#cb12-5566" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(state, fiscal_year_ended, current_level_earned_premium) <span class="sc">%&gt;%</span></span>
<span id="cb12-5567"><a href="#cb12-5567" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">trend_time_premium =</span></span>
<span id="cb12-5568"><a href="#cb12-5568" aria-hidden="true" tabindex="-1"></a>               <span class="fu">case_when</span>(</span>
<span id="cb12-5569"><a href="#cb12-5569" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">12</span>,</span>
<span id="cb12-5570"><a href="#cb12-5570" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">24</span>,</span>
<span id="cb12-5571"><a href="#cb12-5571" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">36</span>,</span>
<span id="cb12-5572"><a href="#cb12-5572" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">48</span>,</span>
<span id="cb12-5573"><a href="#cb12-5573" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">60</span></span>
<span id="cb12-5574"><a href="#cb12-5574" aria-hidden="true" tabindex="-1"></a>               )) <span class="sc">%&gt;%</span></span>
<span id="cb12-5575"><a href="#cb12-5575" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">data_premium_trend_selected</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, <span class="at">prem_trend_z_wtd_selected =</span> z_wtd_selected), <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5576"><a href="#cb12-5576" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">premium_trend_factors =</span> prem_trend_z_wtd_selected <span class="sc">%&gt;%</span></span>
<span id="cb12-5577"><a href="#cb12-5577" aria-hidden="true" tabindex="-1"></a>               <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5578"><a href="#cb12-5578" aria-hidden="true" tabindex="-1"></a>               <span class="co"># raise_to_power(interval(ymd(selection_data_ended) %m-% years(5),</span></span>
<span id="cb12-5579"><a href="#cb12-5579" aria-hidden="true" tabindex="-1"></a>               <span class="co">#                         ymd(selection_effective_date) %m+% months(6)) %&gt;%</span></span>
<span id="cb12-5580"><a href="#cb12-5580" aria-hidden="true" tabindex="-1"></a>               <span class="co">#                  divide_by(years(1))) %&gt;% # more accurate way</span></span>
<span id="cb12-5581"><a href="#cb12-5581" aria-hidden="true" tabindex="-1"></a>               <span class="fu">raise_to_power</span>(<span class="fu">subtract</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_effective_date) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">6</span>),</span>
<span id="cb12-5582"><a href="#cb12-5582" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended) <span class="sc">%m-%</span> <span class="fu">months</span>(trend_time_premium)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5583"><a href="#cb12-5583" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">divide_by</span>(<span class="dv">365</span>) <span class="sc">%&gt;%</span> as.numeric), <span class="co"># equivalent to excel</span></span>
<span id="cb12-5584"><a href="#cb12-5584" aria-hidden="true" tabindex="-1"></a>             <span class="at">trended_current_level_earned_premium =</span> current_level_earned_premium <span class="sc">*</span> premium_trend_factors</span>
<span id="cb12-5585"><a href="#cb12-5585" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb12-5586"><a href="#cb12-5586" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">data_ult_loss_fiscal</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, fiscal_year_ended, incurred_loss, implied_incurred_age_to_ult, ult_incurred_loss), <span class="fu">join_by</span>(state, fiscal_year_ended)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5587"><a href="#cb12-5587" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">data_freq_trend_selected</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, <span class="at">freq_trend_z_wtd_selected =</span> z_wtd_selected), <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5588"><a href="#cb12-5588" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">data_sev_trend_selected</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(state, <span class="at">sev_trend_z_wtd_selected =</span> z_wtd_selected), <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5589"><a href="#cb12-5589" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">trend_time_loss =</span></span>
<span id="cb12-5590"><a href="#cb12-5590" aria-hidden="true" tabindex="-1"></a>               <span class="fu">case_when</span>(</span>
<span id="cb12-5591"><a href="#cb12-5591" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">6</span>,</span>
<span id="cb12-5592"><a href="#cb12-5592" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">18</span>,</span>
<span id="cb12-5593"><a href="#cb12-5593" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">30</span>,</span>
<span id="cb12-5594"><a href="#cb12-5594" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">42</span>,</span>
<span id="cb12-5595"><a href="#cb12-5595" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">year</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended)) <span class="sc">-</span> <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(fiscal_year_ended, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">4</span>)) <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">54</span></span>
<span id="cb12-5596"><a href="#cb12-5596" aria-hidden="true" tabindex="-1"></a>               ),</span>
<span id="cb12-5597"><a href="#cb12-5597" aria-hidden="true" tabindex="-1"></a>             <span class="at">loss_trend_factors =</span> freq_trend_z_wtd_selected <span class="sc">%&gt;%</span></span>
<span id="cb12-5598"><a href="#cb12-5598" aria-hidden="true" tabindex="-1"></a>               <span class="fu">add</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5599"><a href="#cb12-5599" aria-hidden="true" tabindex="-1"></a>               <span class="fu">multiply_by</span>(sev_trend_z_wtd_selected</span>
<span id="cb12-5600"><a href="#cb12-5600" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">%&gt;%</span> <span class="fu">add</span>(<span class="dv">1</span>))<span class="sc">%&gt;%</span></span>
<span id="cb12-5601"><a href="#cb12-5601" aria-hidden="true" tabindex="-1"></a>               <span class="fu">raise_to_power</span>(<span class="fu">subtract</span>(<span class="fu">ymd</span>(input<span class="sc">$</span>selection_effective_date) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">12</span>),</span>
<span id="cb12-5602"><a href="#cb12-5602" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ymd</span>(input<span class="sc">$</span>selection_data_ended) <span class="sc">%m-%</span> <span class="fu">months</span>(trend_time_loss)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5603"><a href="#cb12-5603" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">divide_by</span>(<span class="dv">365</span>) <span class="sc">%&gt;%</span> as.numeric),</span>
<span id="cb12-5604"><a href="#cb12-5604" aria-hidden="true" tabindex="-1"></a>             <span class="at">trended_ult_incurred_loss =</span> ult_incurred_loss <span class="sc">*</span> loss_trend_factors,</span>
<span id="cb12-5605"><a href="#cb12-5605" aria-hidden="true" tabindex="-1"></a>             <span class="at">trended_ult_incurred_partial_loss_ratio =</span> <span class="fu">ifelse</span>(trended_current_level_earned_premium <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, trended_ult_incurred_loss <span class="sc">/</span> trended_current_level_earned_premium)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5606"><a href="#cb12-5606" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">selection_ay_weights2</span>(), <span class="at">by =</span> <span class="fu">join_by</span>(state, fiscal_year_ended))</span>
<span id="cb12-5607"><a href="#cb12-5607" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5608"><a href="#cb12-5608" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5609"><a href="#cb12-5609" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5610"><a href="#cb12-5610" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; final indication calculations</span></span>
<span id="cb12-5611"><a href="#cb12-5611" aria-hidden="true" tabindex="-1"></a>  data_indication2 <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5612"><a href="#cb12-5612" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5613"><a href="#cb12-5613" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_indication</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5614"><a href="#cb12-5614" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nest_by</span>(state) <span class="sc">%&gt;%</span></span>
<span id="cb12-5615"><a href="#cb12-5615" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(</span>
<span id="cb12-5616"><a href="#cb12-5616" aria-hidden="true" tabindex="-1"></a>        <span class="at">.x =</span> <span class="fu">list</span>(data),</span>
<span id="cb12-5617"><a href="#cb12-5617" aria-hidden="true" tabindex="-1"></a>        <span class="at">.f =</span> \(data) {</span>
<span id="cb12-5618"><a href="#cb12-5618" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-5619"><a href="#cb12-5619" aria-hidden="true" tabindex="-1"></a>          data <span class="sc">%&gt;%</span></span>
<span id="cb12-5620"><a href="#cb12-5620" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">trended_ult_incurred_partial_loss_ratio =</span> <span class="fu">replace_na</span>(trended_ult_incurred_partial_loss_ratio, <span class="dv">0</span>)) <span class="sc">%$%</span></span>
<span id="cb12-5621"><a href="#cb12-5621" aria-hidden="true" tabindex="-1"></a>            <span class="fu">crossprod</span>(trended_ult_incurred_partial_loss_ratio, ay_weights) <span class="sc">%&gt;%</span></span>
<span id="cb12-5622"><a href="#cb12-5622" aria-hidden="true" tabindex="-1"></a>            <span class="fu">data.frame</span>(<span class="at">ay_weighted_trended_ult_incurred_partial_loss_ratio =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb12-5623"><a href="#cb12-5623" aria-hidden="true" tabindex="-1"></a>            return</span>
<span id="cb12-5624"><a href="#cb12-5624" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-5625"><a href="#cb12-5625" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb12-5626"><a href="#cb12-5626" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb12-5627"><a href="#cb12-5627" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reframe</span>(data) <span class="sc">%&gt;%</span></span>
<span id="cb12-5628"><a href="#cb12-5628" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">data_ult_claim_count_fiscal</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5629"><a href="#cb12-5629" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">summarize</span>(<span class="at">.by =</span> state, <span class="at">ult_incurred_claim_count =</span> <span class="fu">sum</span>(ult_incurred_claim_count)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5630"><a href="#cb12-5630" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5631"><a href="#cb12-5631" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">credibility =</span> ult_incurred_claim_count <span class="sc">%&gt;%</span> <span class="fu">divide_by</span>(<span class="dv">1084</span>) <span class="sc">%&gt;%</span> sqrt <span class="sc">%&gt;%</span> <span class="fu">min</span>(., <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5632"><a href="#cb12-5632" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">select</span>(state, credibility),</span>
<span id="cb12-5633"><a href="#cb12-5633" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5634"><a href="#cb12-5634" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(data_cat, <span class="at">by =</span> <span class="fu">join_by</span>(state)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5635"><a href="#cb12-5635" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5636"><a href="#cb12-5636" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">total_modeled_peril_partial_loss_ratio =</span> <span class="fu">sum</span>(modeled_hurricane_ratio, modeled_fire_following_earthquake_ratio, modeled_severe_convective_storm_ratio, modeled_wildfire_ratio) <span class="sc">*</span> <span class="fl">1.15</span>,</span>
<span id="cb12-5637"><a href="#cb12-5637" aria-hidden="true" tabindex="-1"></a>             <span class="at">trended_underlying_plr_less_modeled_perils =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-5638"><a href="#cb12-5638" aria-hidden="true" tabindex="-1"></a>               state <span class="sc">==</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> <span class="fu">selection_underlying_plr</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5639"><a href="#cb12-5639" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">subtract</span>(total_modeled_peril_partial_loss_ratio) <span class="sc">%&gt;%</span></span>
<span id="cb12-5640"><a href="#cb12-5640" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">multiply_by</span>(<span class="fu">data_freq_trend_selected_cw</span>()<span class="sc">$</span>selected <span class="sc">%&gt;%</span></span>
<span id="cb12-5641"><a href="#cb12-5641" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">add</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5642"><a href="#cb12-5642" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">multiply_by</span>(<span class="fu">data_sev_trend_selected_cw</span>()<span class="sc">$</span>selected <span class="sc">%&gt;%</span></span>
<span id="cb12-5643"><a href="#cb12-5643" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">add</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5644"><a href="#cb12-5644" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">divide_by</span>(<span class="fu">data_premium_trend_selected_cw</span>()<span class="sc">$</span>selected <span class="sc">%&gt;%</span></span>
<span id="cb12-5645"><a href="#cb12-5645" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">add</span>(<span class="dv">1</span>)),</span>
<span id="cb12-5646"><a href="#cb12-5646" aria-hidden="true" tabindex="-1"></a>               <span class="at">.default =</span> <span class="cn">NA</span>),</span>
<span id="cb12-5647"><a href="#cb12-5647" aria-hidden="true" tabindex="-1"></a>             <span class="at">credibility_weighted_trended_ult_incurred_loss_ratio =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-5648"><a href="#cb12-5648" aria-hidden="true" tabindex="-1"></a>               state <span class="sc">==</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="sc">%&gt;%</span></span>
<span id="cb12-5649"><a href="#cb12-5649" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">multiply_by</span>(credibility) <span class="sc">%&gt;%</span></span>
<span id="cb12-5650"><a href="#cb12-5650" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">add</span>(trended_underlying_plr_less_modeled_perils <span class="sc">%&gt;%</span></span>
<span id="cb12-5651"><a href="#cb12-5651" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">multiply_by</span>(<span class="dv">1</span> <span class="sc">%&gt;%</span></span>
<span id="cb12-5652"><a href="#cb12-5652" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">subtract</span>(credibility))),</span>
<span id="cb12-5653"><a href="#cb12-5653" aria-hidden="true" tabindex="-1"></a>               <span class="at">.default =</span> <span class="cn">NA</span>)</span>
<span id="cb12-5654"><a href="#cb12-5654" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-5655"><a href="#cb12-5655" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5656"><a href="#cb12-5656" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5657"><a href="#cb12-5657" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5658"><a href="#cb12-5658" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; set constant</span></span>
<span id="cb12-5659"><a href="#cb12-5659" aria-hidden="true" tabindex="-1"></a>  credibility_weighted_trended_ult_incurred_loss_ratio_cw <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5660"><a href="#cb12-5660" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5661"><a href="#cb12-5661" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_indication2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5662"><a href="#cb12-5662" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Countrywide"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5663"><a href="#cb12-5663" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(credibility_weighted_trended_ult_incurred_loss_ratio) <span class="sc">%&gt;%</span></span>
<span id="cb12-5664"><a href="#cb12-5664" aria-hidden="true" tabindex="-1"></a>      as.numeric</span>
<span id="cb12-5665"><a href="#cb12-5665" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5666"><a href="#cb12-5666" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5667"><a href="#cb12-5667" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5668"><a href="#cb12-5668" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; continue final indication calculations</span></span>
<span id="cb12-5669"><a href="#cb12-5669" aria-hidden="true" tabindex="-1"></a>  data_indication3 <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5670"><a href="#cb12-5670" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5671"><a href="#cb12-5671" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_indication2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5672"><a href="#cb12-5672" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">cw_ay_weighted_trended_ult_incurred_partial_loss_ratio =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-5673"><a href="#cb12-5673" aria-hidden="true" tabindex="-1"></a>        state <span class="sc">!=</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> <span class="fu">credibility_weighted_trended_ult_incurred_loss_ratio_cw</span>(),</span>
<span id="cb12-5674"><a href="#cb12-5674" aria-hidden="true" tabindex="-1"></a>        <span class="at">.default =</span> <span class="cn">NA</span>),</span>
<span id="cb12-5675"><a href="#cb12-5675" aria-hidden="true" tabindex="-1"></a>        <span class="at">credibility_weighted_trended_ult_incurred_loss_ratio =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-5676"><a href="#cb12-5676" aria-hidden="true" tabindex="-1"></a>          state <span class="sc">!=</span> <span class="st">"Countrywide"</span> <span class="sc">~</span> ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="sc">%&gt;%</span></span>
<span id="cb12-5677"><a href="#cb12-5677" aria-hidden="true" tabindex="-1"></a>            <span class="fu">multiply_by</span>(credibility) <span class="sc">%&gt;%</span></span>
<span id="cb12-5678"><a href="#cb12-5678" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add</span>(cw_ay_weighted_trended_ult_incurred_partial_loss_ratio <span class="sc">%&gt;%</span></span>
<span id="cb12-5679"><a href="#cb12-5679" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">multiply_by</span>(<span class="dv">1</span> <span class="sc">%&gt;%</span></span>
<span id="cb12-5680"><a href="#cb12-5680" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">subtract</span>(credibility))),</span>
<span id="cb12-5681"><a href="#cb12-5681" aria-hidden="true" tabindex="-1"></a>          <span class="at">.default =</span> credibility_weighted_trended_ult_incurred_loss_ratio</span>
<span id="cb12-5682"><a href="#cb12-5682" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-5683"><a href="#cb12-5683" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin_for_reinsurance =</span> <span class="dv">0</span>,</span>
<span id="cb12-5684"><a href="#cb12-5684" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_prospective_loss_ratio =</span> credibility_weighted_trended_ult_incurred_loss_ratio <span class="sc">+</span> total_modeled_peril_partial_loss_ratio <span class="sc">+</span> margin_for_reinsurance,</span>
<span id="cb12-5685"><a href="#cb12-5685" aria-hidden="true" tabindex="-1"></a>        <span class="at">permissable_loss_ratio =</span> <span class="fl">0.601</span>,</span>
<span id="cb12-5686"><a href="#cb12-5686" aria-hidden="true" tabindex="-1"></a>        <span class="at">indicated_rate_level_needed =</span> total_prospective_loss_ratio <span class="sc">/</span> permissable_loss_ratio <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb12-5687"><a href="#cb12-5687" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5688"><a href="#cb12-5688" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5689"><a href="#cb12-5689" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5690"><a href="#cb12-5690" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -&gt; organize, convert to long data, and reformat variable names for displaying</span></span>
<span id="cb12-5691"><a href="#cb12-5691" aria-hidden="true" tabindex="-1"></a>  data_indication3_long <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb12-5692"><a href="#cb12-5692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5693"><a href="#cb12-5693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_indication3</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-5694"><a href="#cb12-5694" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(state, ay_weighted_trended_ult_incurred_partial_loss_ratio, credibility, trended_underlying_plr_less_modeled_perils, cw_ay_weighted_trended_ult_incurred_partial_loss_ratio, credibility_weighted_trended_ult_incurred_loss_ratio, <span class="fu">starts_with</span>(<span class="st">"modeled"</span>), total_modeled_peril_partial_loss_ratio, margin_for_reinsurance, total_prospective_loss_ratio, permissable_loss_ratio, indicated_rate_level_needed) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5695"><a href="#cb12-5695" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb12-5696"><a href="#cb12-5696" aria-hidden="true" tabindex="-1"></a>                   <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb12-5697"><a href="#cb12-5697" aria-hidden="true" tabindex="-1"></a>                   <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5698"><a href="#cb12-5698" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">variable_display =</span> </span>
<span id="cb12-5699"><a href="#cb12-5699" aria-hidden="true" tabindex="-1"></a>               <span class="fu">case_when</span>(</span>
<span id="cb12-5700"><a href="#cb12-5700" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Accident year weighted trended ultimate incurred partial loss ratio:"</span>,</span>
<span id="cb12-5701"><a href="#cb12-5701" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"credibility"</span> <span class="sc">~</span> <span class="st">"Credibility (ultimate claims using 1,084 standard):"</span>,</span>
<span id="cb12-5702"><a href="#cb12-5702" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"trended_underlying_plr_less_modeled_perils"</span> <span class="sc">~</span> <span class="st">"Trended, underlying permissible loss ratio less modeled perils:"</span>,</span>
<span id="cb12-5703"><a href="#cb12-5703" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"cw_ay_weighted_trended_ult_incurred_partial_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Countrywide accident year weighted trended ultimate ncurred partial loss + LAE ratio:"</span>,</span>
<span id="cb12-5704"><a href="#cb12-5704" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"credibility_weighted_trended_ult_incurred_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Credibility weighted trended ultimate incurred loss + LAE ratio:"</span>,</span>
<span id="cb12-5705"><a href="#cb12-5705" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"modeled_hurricane_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled hurricane ratio:"</span>,</span>
<span id="cb12-5706"><a href="#cb12-5706" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"modeled_fire_following_earthquake_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled fire following earthquake ratio:"</span>, </span>
<span id="cb12-5707"><a href="#cb12-5707" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"modeled_severe_convective_storm_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled severe convective storm ratio:"</span>,</span>
<span id="cb12-5708"><a href="#cb12-5708" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"modeled_wildfire_ratio"</span> <span class="sc">~</span> <span class="st">"Modeled wildfire ratio:"</span>,</span>
<span id="cb12-5709"><a href="#cb12-5709" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"total_modeled_peril_partial_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Total modeled peril partial loss + LAE ratio (modeled ratios x 1.15 LAE factor):"</span>,</span>
<span id="cb12-5710"><a href="#cb12-5710" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"margin_for_reinsurance"</span> <span class="sc">~</span> <span class="st">"Margin for reinsurance:"</span>,</span>
<span id="cb12-5711"><a href="#cb12-5711" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"total_prospective_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Total prospective loss + LAE ratio:"</span>,</span>
<span id="cb12-5712"><a href="#cb12-5712" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"permissable_loss_ratio"</span> <span class="sc">~</span> <span class="st">"Permissable loss + LAE ratio:"</span>,</span>
<span id="cb12-5713"><a href="#cb12-5713" aria-hidden="true" tabindex="-1"></a>                 variable <span class="sc">==</span> <span class="st">"indicated_rate_level_needed"</span> <span class="sc">~</span> <span class="st">"Indicated rate level needed:"</span></span>
<span id="cb12-5714"><a href="#cb12-5714" aria-hidden="true" tabindex="-1"></a>               ),</span>
<span id="cb12-5715"><a href="#cb12-5715" aria-hidden="true" tabindex="-1"></a>             <span class="at">.after =</span> variable</span>
<span id="cb12-5716"><a href="#cb12-5716" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-5717"><a href="#cb12-5717" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5718"><a href="#cb12-5718" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-5719"><a href="#cb12-5719" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5720"><a href="#cb12-5720" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Display results</span></span>
<span id="cb12-5721"><a href="#cb12-5721" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5722"><a href="#cb12-5722" aria-hidden="true" tabindex="-1"></a>  <span class="co"># countrywide indication summary table</span></span>
<span id="cb12-5723"><a href="#cb12-5723" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indication_summary_cw <span class="ot">&lt;-</span> <span class="fu">render_gt</span>(</span>
<span id="cb12-5724"><a href="#cb12-5724" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5725"><a href="#cb12-5725" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format_as_indication_summary</span>(<span class="at">data_ind =</span> <span class="fu">data_indication</span>(), <span class="at">sel_state =</span> <span class="st">"Countrywide"</span>, <span class="at">sel_data_ended =</span> input<span class="sc">$</span>selection_data_ended, <span class="at">sel_eval_date =</span> <span class="fu">selection_eval_date</span>())</span>
<span id="cb12-5726"><a href="#cb12-5726" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5727"><a href="#cb12-5727" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5728"><a href="#cb12-5728" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5729"><a href="#cb12-5729" aria-hidden="true" tabindex="-1"></a>  <span class="co"># countrywide indication calculations table</span></span>
<span id="cb12-5730"><a href="#cb12-5730" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indication_calculations_cw <span class="ot">&lt;-</span> <span class="fu">render_gt</span>(</span>
<span id="cb12-5731"><a href="#cb12-5731" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5732"><a href="#cb12-5732" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format_as_indication_calculations</span>(<span class="at">data_ind3_long =</span> <span class="fu">data_indication3_long</span>(), <span class="at">sel_state =</span> <span class="st">"Countrywide"</span>)</span>
<span id="cb12-5733"><a href="#cb12-5733" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5734"><a href="#cb12-5734" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5735"><a href="#cb12-5735" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5736"><a href="#cb12-5736" aria-hidden="true" tabindex="-1"></a>  <span class="co"># countrywide indication calculations supporting table</span></span>
<span id="cb12-5737"><a href="#cb12-5737" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indication_calculations_support_cw <span class="ot">&lt;-</span> <span class="fu">render_gt</span>(</span>
<span id="cb12-5738"><a href="#cb12-5738" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5739"><a href="#cb12-5739" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format_as_indication_calculations_support</span>(<span class="at">data_ind3_long =</span> <span class="fu">data_indication3_long</span>(), <span class="at">sel_state =</span> <span class="st">"Countrywide"</span>)</span>
<span id="cb12-5740"><a href="#cb12-5740" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5741"><a href="#cb12-5741" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5742"><a href="#cb12-5742" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5743"><a href="#cb12-5743" aria-hidden="true" tabindex="-1"></a>  <span class="co"># statewide indication summary table</span></span>
<span id="cb12-5744"><a href="#cb12-5744" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indication_summary_sw <span class="ot">&lt;-</span> <span class="fu">render_gt</span>(</span>
<span id="cb12-5745"><a href="#cb12-5745" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5746"><a href="#cb12-5746" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format_as_indication_summary</span>(<span class="at">data_ind =</span> <span class="fu">data_indication</span>(), <span class="at">sel_state =</span> input<span class="sc">$</span>selection_state, <span class="at">sel_data_ended =</span> input<span class="sc">$</span>selection_data_ended, <span class="at">sel_eval_date =</span> <span class="fu">selection_eval_date</span>())</span>
<span id="cb12-5747"><a href="#cb12-5747" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5748"><a href="#cb12-5748" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5749"><a href="#cb12-5749" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5750"><a href="#cb12-5750" aria-hidden="true" tabindex="-1"></a>  <span class="co"># statewide indication calculations table</span></span>
<span id="cb12-5751"><a href="#cb12-5751" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indication_calculations_sw <span class="ot">&lt;-</span> <span class="fu">render_gt</span>(</span>
<span id="cb12-5752"><a href="#cb12-5752" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5753"><a href="#cb12-5753" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format_as_indication_calculations</span>(<span class="at">data_ind3_long =</span> <span class="fu">data_indication3_long</span>(), <span class="at">sel_state =</span> input<span class="sc">$</span>selection_state)</span>
<span id="cb12-5754"><a href="#cb12-5754" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5755"><a href="#cb12-5755" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5756"><a href="#cb12-5756" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5757"><a href="#cb12-5757" aria-hidden="true" tabindex="-1"></a>  <span class="co"># statewide indication calculations supporting table</span></span>
<span id="cb12-5758"><a href="#cb12-5758" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>indication_calculations_support_sw <span class="ot">&lt;-</span> <span class="fu">render_gt</span>(</span>
<span id="cb12-5759"><a href="#cb12-5759" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5760"><a href="#cb12-5760" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format_as_indication_calculations_support</span>(<span class="at">data_ind3_long =</span> <span class="fu">data_indication3_long</span>(), <span class="at">sel_state =</span> input<span class="sc">$</span>selection_state)</span>
<span id="cb12-5761"><a href="#cb12-5761" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5762"><a href="#cb12-5762" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-5763"><a href="#cb12-5763" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5764"><a href="#cb12-5764" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-5765"><a href="#cb12-5765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5766"><a href="#cb12-5766" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span>
<span id="cb12-5767"><a href="#cb12-5767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5768"><a href="#cb12-5768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>